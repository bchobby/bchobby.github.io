<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flink sql join 快速入门 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Flink sql join 快速入门" />
<meta property="og:description" content="目录 Flink stream join基于窗口joinTumbling window join（滚动窗口join）Sliding Window Join（滑动窗口join）Session Window Join（会话窗口join） Interval Join Flink sql query join流式joinRegular Joins（双流join）Interval Joins（区间join）Temporal Joins（时态join）JOIN LookupJOIN 版本表Event Time Temporal Join（版本表）Processing Time Temporal Join（不建议使用） JOIN LATERAL 窗口Join窗口函数TUMBLE（滚动窗口）HOP（滑动窗口）CUMULATE（累积窗口） 窗口Join语法 总结 Flink stream join 基于窗口join Flink 中 Window 可以将无限流切分成有限流，是处理有限流的核心组件，现在Flink 中 Window 可以是时间驱动的（Time Window），也可以是数据驱动的（Count Window）
窗口连接将共享一个公key并位于同一窗口中的两个流的元素连接起来。这些窗口可以通过使用窗口赋值器来定义，并根据两个流中的元素进行计算。
然后，来自两边的元素被传递给用户定义的JoinFunction或FlatJoinFusion，用户可以在其中发出符合连接条件的结果。
stream.join(otherStream) .where(&lt;KeySelector&gt;) .equalTo(&lt;KeySelector&gt;) .window(&lt;WindowAssigner&gt;) .apply(&lt;JoinFunction&gt;) Tumbling window join（滚动窗口join） 滚动窗口有固定的尺寸，窗口间的元素无重复。当执行滚动窗口连接时，具有公key和公共滚动窗口的所有元素将作为成对组合进行连接（inner join）
因为这就像一个内部连接，所以一个流中的元素在其滚动窗口中没有来自另一个流的元素时，不会发出。
如图所示，我们定义了一个大小为2毫秒的翻转窗口，其结果为[0,1]，[2,3]形式的窗口
DataStream&lt;Integer&gt; orangeStream = ... DataStream&lt;Integer&gt; greenStream = ... orangeStream.join(greenStream) .where(&lt;KeySelector&gt;) ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/113bca26be1522bc88d50a8076a1d694/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-15T19:53:21+08:00" />
<meta property="article:modified_time" content="2022-11-15T19:53:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flink sql join 快速入门</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#Flink_stream_join_2" rel="nofollow">Flink stream join</a></li><li><ul><li><a href="#join_4" rel="nofollow">基于窗口join</a></li><li><ul><li><a href="#Tumbling_window__joinjoin_27" rel="nofollow">Tumbling window join（滚动窗口join）</a></li><li><a href="#Sliding_Window_Joinjoin_54" rel="nofollow">Sliding Window Join（滑动窗口join）</a></li><li><a href="#Session_Window_Joinjoin_84" rel="nofollow">Session Window Join（会话窗口join）</a></li></ul> 
   </li><li><a href="#Interval_Join_112" rel="nofollow">Interval Join</a></li></ul> 
  </li><li><a href="#Flink_sql_query_join_149" rel="nofollow">Flink sql query join</a></li><li><ul><li><a href="#join_152" rel="nofollow">流式join</a></li><li><ul><li><a href="#Regular_Joinsjoin_154" rel="nofollow">Regular Joins（双流join）</a></li><li><a href="#Interval_Joinsjoin_270" rel="nofollow">Interval Joins（区间join）</a></li><li><a href="#Temporal_Joinsjoin_344" rel="nofollow">Temporal Joins（时态join）</a></li><li><ul><li><a href="#JOIN_Lookup_386" rel="nofollow">JOIN Lookup</a></li><li><a href="#JOIN__442" rel="nofollow">JOIN 版本表</a></li><li><a href="#Event_Time_Temporal_Join_510" rel="nofollow">Event Time Temporal Join（版本表）</a></li><li><a href="#Processing_Time_Temporal_Join_617" rel="nofollow">Processing Time Temporal Join（不建议使用）</a></li></ul> 
    </li><li><a href="#JOIN_LATERAL_635" rel="nofollow">JOIN LATERAL</a></li></ul> 
   </li><li><a href="#Join_687" rel="nofollow">窗口Join</a></li><li><ul><li><a href="#_689" rel="nofollow">窗口函数</a></li><li><ul><li><a href="#TUMBLE_700" rel="nofollow">TUMBLE（滚动窗口）</a></li><li><a href="#HOP_727" rel="nofollow">HOP（滑动窗口）</a></li><li><a href="#CUMULATE_756" rel="nofollow">CUMULATE（累积窗口）</a></li></ul> 
    </li><li><a href="#Join_784" rel="nofollow">窗口Join语法</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_917" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="Flink_stream_join_2"></a>Flink stream join</h2> 
<h3><a id="join_4"></a>基于窗口join</h3> 
<p>Flink 中 Window 可以将无限流切分成有限流，是处理有限流的核心组件，现在Flink 中 Window 可以是时间驱动的（Time Window），也可以是数据驱动的（Count Window）</p> 
<p><img src="https://images2.imgbox.com/1d/f1/qM5n7Nyv_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>窗口连接将共享一个公key并位于同一窗口中的两个流的元素连接起来。这些窗口可以通过使用窗口赋值器来定义，并根据两个流中的元素进行计算。</p> 
 <p>然后，来自两边的元素被传递给用户定义的JoinFunction或FlatJoinFusion，用户可以在其中发出符合连接条件的结果。</p> 
</blockquote> 
<pre><code class="prism language-java">stream<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>otherStream<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WindowAssigner</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JoinFunction</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="Tumbling_window__joinjoin_27"></a>Tumbling window join（滚动窗口join）</h4> 
<blockquote> 
 <p><strong>滚动窗口有固定的尺寸，窗口间的元素无重复</strong>。当执行滚动窗口连接时，具有公key和公共滚动窗口的所有元素将作为成对组合进行连接（inner join）</p> 
 <p>因为这就像一个内部连接，所以一个流中的元素在其滚动窗口中没有来自另一个流的元素时，不会发出。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/33/07/XplG8OyD_o.png" alt="在这里插入图片描述"></p> 
<p><em>如图所示，我们定义了一个大小为2毫秒的翻转窗口，其结果为[0,1]，[2,3]形式的窗口</em></p> 
<pre><code class="prism language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> orangeStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> greenStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

orangeStream<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>greenStream<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">TumblingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>apply <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JoinFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> first<span class="token punctuation">,</span> <span class="token class-name">Integer</span> second<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> first <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> second<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="Sliding_Window_Joinjoin_54"></a>Sliding Window Join（滑动窗口join）</h4> 
<blockquote> 
 <p>滑动**窗口有固定尺寸，数据可能会重复（当滑动尺寸小于窗口尺寸，数据会重复）。**当执行滑动窗口连接时，具有公共key和公共滑动窗口的所有元素将作为成对组合进行连接，并传递给JoinFunction或FlatJoinFusion。</p> 
</blockquote> 
<p><em>在本例中，我们使用大小为两毫秒的滑动窗口，并将其滑动一毫秒，从而产生滑动窗口[1，0]，[0,1]，[1,2]，[2,3]…。x轴下方的连接元素是传递给每个滑动窗口的JoinFunction的元素</em></p> 
<p><img src="https://images2.imgbox.com/83/0d/TjZASP0y_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java">
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> orangeStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> greenStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

orangeStream<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>greenStream<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">SlidingEventTimeWindows</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">/* size */</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">/* slide */</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>apply <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JoinFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> first<span class="token punctuation">,</span> <span class="token class-name">Integer</span> second<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> first <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> second<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="Session_Window_Joinjoin_84"></a>Session Window Join（会话窗口join）</h4> 
<blockquote> 
 <p>**会话窗口不重叠并且没有固定的开始和结束时间，会话在固定时间内没有接受到数据时，会关闭当前会话，并开启新的会话。**当执行会话窗口连接时，具有相同key的所有元素（当“组合”时满足会话条件）将以成对组合的方式连接，并传递给JoinFunction或FlatJoinFusion</p> 
</blockquote> 
<p><em>本例我们定义了一个会话窗口连接，其中每个会话被至少1ms的间隔分隔。</em></p> 
<p><img src="https://images2.imgbox.com/e2/0d/2n1IwYio_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> orangeStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> greenStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

orangeStream<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>greenStream<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token class-name">EventTimeSessionWindows</span><span class="token punctuation">.</span><span class="token function">withGap</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>apply <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JoinFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> first<span class="token punctuation">,</span> <span class="token class-name">Integer</span> second<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> first <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> second<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="Interval_Join_112"></a>Interval Join</h3> 
<blockquote> 
 <p>间隔连接使用一个公共key连接两个流的元素（A和B），其中流B的元素具有与流A中元素的时间戳相对的时间间隔中的时间戳，也就是： <code>b.timestamp ∈ [a.timestamp + lowerBound; a.timestamp + upperBound]</code> 。那么A和B有相同的key，就可以进行内部join</p> 
 <p><strong>间隔联接当前仅支持事件时间。</strong></p> 
</blockquote> 
<p><em>在上面的示例中，我们连接了两个流“橙色”和“绿色”，下限为-2毫秒，上限为+1毫秒。</em></p> 
<p><em>orangeElem.ts + lowerBound &lt;= greenElem.ts &lt;= orangeElem.ts + upperBound</em></p> 
<pre><code class="prism language-java"><span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> orangeStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> greenStream <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

orangeStream
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">intervalJoin</span><span class="token punctuation">(</span>greenStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeySelector</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>process <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessJoinFunction</span><span class="token operator">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> left<span class="token punctuation">,</span> <span class="token class-name">Integer</span> right<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>first <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> second<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<hr> 
<h2><a id="Flink_sql_query_join_149"></a>Flink sql query join</h2> 
<h3><a id="join_152"></a>流式join</h3> 
<h4><a id="Regular_Joinsjoin_154"></a>Regular Joins（双流join）</h4> 
<blockquote> 
 <p>双流join是最通用的联接类型（支持 Batch\Streaming），其中任何新记录或联接两侧的更改都是可见的，并影响整体的Join结果。</p> 
 <p>对于流式查询，双流join的语法是最灵活的，允许任何类型的更新（插入、更新、删除）输入表。然而，此操作具有重要的操作含义：它需要将连接输入的两侧<strong>永远保持在Flink状态</strong>。因此，根据所有输入表和中间联接结果的不同输入行的数量，计算查询结果所需的状态可能会无限增长。可以为查询<strong>配置提供适当的状态生存时间（TTL），以防止状态大小过大</strong>。同时，这可能会影响查询结果的正确性。</p> 
 <p>因为资源问题 Regular Join 通常是不可持续的，一般只用做有界数据流的 Join。</p> 
</blockquote> 
<p><strong>数据一直根据输入流一直更新，“逐步逼近”最终的精确值，下游可能看到不断变化的结果，为了执行结果更新，下游需要定义主键。同时，状态可能会无限增长</strong></p> 
<p><strong>特性：</strong></p> 
<ul><li>支持INNER、LEFT、RIGHT、FULL OUT JOIN</li><li>语义语法和传统sql join一致</li><li>左右流都会触发更新</li><li>状态持续增长、一般结合 state TTl配合使用</li></ul> 
<p><strong>语法：</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Orders
<span class="token punctuation">[</span><span class="token keyword">INNER</span><span class="token operator">|</span><span class="token keyword">RIGHT</span><span class="token operator">|</span><span class="token keyword">LEFT</span><span class="token operator">|</span><span class="token keyword">FULL</span> <span class="token keyword">OUTER</span><span class="token punctuation">]</span> <span class="token keyword">JOIN</span> Product
<span class="token keyword">ON</span> Orders<span class="token punctuation">.</span>productId <span class="token operator">=</span> Product<span class="token punctuation">.</span>id
</code></pre> 
<p><img src="https://images2.imgbox.com/65/8f/xTBL7V43_o.png" alt="在这里插入图片描述"></p> 
<ul><li> <p>流表 join 流表</p> 
  <blockquote> 
   <p>如果其中一个流表触发更新操作，同样触发join生成最新的结果</p> 
  </blockquote> <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span>
  user_id STRING<span class="token punctuation">,</span>
  name STRING<span class="token punctuation">,</span>
  age <span class="token keyword">INT</span><span class="token punctuation">,</span>
  gmt_time <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
 <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'users'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'localhost:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'orders2ConsumerGroup'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'latest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> address <span class="token punctuation">(</span>
  user_id STRING<span class="token punctuation">,</span>
  address STRING<span class="token punctuation">,</span>
  update_time <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'address'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'localhost:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'orders2ConsumerGroup'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'latest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> u<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>u<span class="token punctuation">.</span>name<span class="token punctuation">,</span>u<span class="token punctuation">.</span>age<span class="token punctuation">,</span>a<span class="token punctuation">.</span>address 
<span class="token keyword">FROM</span> users <span class="token keyword">AS</span> u <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> address   <span class="token keyword">AS</span> a
<span class="token keyword">ON</span> u<span class="token punctuation">.</span>user_id <span class="token operator">=</span> a<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>

<span class="token comment">--users</span>
<span class="token comment">-- {"user_id":"u1","name":"li","age":20,"gmt_time":"2022-11-01 10:00:00"}</span>
<span class="token comment">-- {"user_id":"u2","name":"li","age":20,"gmt_time":"2022-11-01 10:00:10"}</span>

<span class="token comment">--address</span>
<span class="token comment">-- {"user_id":"u1","address":"shanghai","update_time":"2022-11-01 10:00:05"}</span>
<span class="token comment">-- {"user_id":"u2","address":"beijing","update_time":"2022-11-01 10:00:15"}</span>
<span class="token comment">-- {"user_id":"u2","address":"anhui","update_time":"2022-11-01 10:00:16"}</span>


<span class="token comment">--  user_id                           name         age                      address</span>
<span class="token comment">--      u1                             li          20                       shanghai</span>
 <span class="token comment">--     u2                             li          20                        beijing</span>
 <span class="token comment">--     u2                             li          20                          anhui</span>
</code></pre> </li><li> <p>维表 join 维表</p> <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_time<span class="token punctuation">`</span></span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
   <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'jdbc'</span><span class="token punctuation">,</span>
   <span class="token string">'url'</span> <span class="token operator">=</span> <span class="token string">'jdbc:mysql://localhost:3306/flink'</span><span class="token punctuation">,</span>
   <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
   <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
   <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'123456'</span>
<span class="token punctuation">)</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> address <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>address<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_time<span class="token punctuation">`</span></span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
   <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'jdbc'</span><span class="token punctuation">,</span>
   <span class="token string">'url'</span> <span class="token operator">=</span> <span class="token string">'jdbc:mysql://localhost:3306/flink'</span><span class="token punctuation">,</span>
   <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'user_address'</span><span class="token punctuation">,</span>
   <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
   <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'123456'</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> users<span class="token punctuation">.</span>name<span class="token punctuation">,</span> users<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> users<span class="token punctuation">.</span>age<span class="token punctuation">,</span> address<span class="token punctuation">.</span>address 
<span class="token keyword">from</span> users<span class="token punctuation">,</span>address  
<span class="token keyword">where</span> users<span class="token punctuation">.</span>user_id <span class="token operator">=</span> address<span class="token punctuation">.</span>user_id
</code></pre> </li></ul> 
<h4><a id="Interval_Joinsjoin_270"></a>Interval Joins（区间join）</h4> 
<blockquote> 
 <p>**是双流join的优化，**基于处理时间或事件时间，在一定时间区间内数据，相同的key进行join（支持 Batch\Streaming）。Interval Join 可以让一条流去 Join 另一条流中前后一段时间内的数据。对于stream查询，时间区间oin只支持有时间属性的 <code>append-only</code>表。由于时间属性是准单调递增的，Flink可以从其状态中删除旧值，而不会影响结果的正确性。</p> 
</blockquote> 
<p><strong>特征：由于给定了关联的区间，因此只需要保留很少的状态，内存压力较小。但是缺点是如果关联的数据晚到或者早到，导致落不到 JOIN 区间内，就可能导致结果不准确。只支持普通 Append 数据流，不支持含 Retract 的动态表。支持事件时间和处理时间</strong></p> 
<ul><li>支持INNER、LEFT、RIGHT、FULL OUT JOIN</li><li>语义语法和传统sql join一致</li><li>左右流都会触发更新</li><li>state根据时间区间保留，自动清理</li><li>输出流保留时间属性</li></ul> 
<p><img src="https://images2.imgbox.com/46/4c/dRTI8tPN_o.png" alt="在这里插入图片描述"></p> 
<p><code>如：如果订单在收到订单10小时后发货，则此查询将把所有订单与其相应的发货联系起来</code></p> 
<pre><code class="prism language-sql"><span class="token comment"># 两表有时间戳字段，并且作为 watermark。或者使用PROCTIME() 函数来生成一个处理时间戳</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> Orders o<span class="token punctuation">,</span> Shipments s
<span class="token keyword">WHERE</span> o<span class="token punctuation">.</span>id <span class="token operator">=</span> s<span class="token punctuation">.</span>order_id
<span class="token operator">AND</span> o<span class="token punctuation">.</span>order_time <span class="token operator">BETWEEN</span> s<span class="token punctuation">.</span>ship_time <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> <span class="token keyword">HOUR</span> <span class="token operator">AND</span> s<span class="token punctuation">.</span>ship_time
</code></pre> 
<p><img src="https://images2.imgbox.com/2b/5b/PvqQbmu2_o.png" alt=""></p> 
<p>有效的join连接条件</p> 
<ul><li><code>ltime = rtime</code></li><li><code>ltime &gt;= rtime AND ltime &lt; rtime + INTERVAL '10' MINUTE</code></li><li><code>ltime BETWEEN rtime - INTERVAL '10' SECOND AND rtime + INTERVAL '5' SECOND</code></li></ul> 
<p>流表和流表</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> currency_rates <span class="token punctuation">(</span>
    currency STRING<span class="token punctuation">,</span>
    conversion_rate <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    update_time  <span class="token keyword">timestamp</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    WATERMARK <span class="token keyword">FOR</span> update_time <span class="token keyword">AS</span> update_time
<span class="token punctuation">)</span> <span class="token keyword">WITH</span>  <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'currency_rates'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'localhost:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'currencyRatesGroup'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'latest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orders <span class="token punctuation">(</span>
    order_id    STRING<span class="token punctuation">,</span>
    price       <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    currency    STRING<span class="token punctuation">,</span>
    order_time  <span class="token keyword">timestamp</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    WATERMARK <span class="token keyword">FOR</span> order_time <span class="token keyword">AS</span> order_time<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'order'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'localhost:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'orders2ConsumerGroup'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'latest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> o<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>o<span class="token punctuation">.</span>price<span class="token punctuation">,</span>o<span class="token punctuation">.</span>order_time<span class="token punctuation">,</span>c<span class="token punctuation">.</span>currency 
<span class="token keyword">FROM</span> orders  o<span class="token punctuation">,</span>currency_rates c  
<span class="token keyword">where</span> o<span class="token punctuation">.</span>currency<span class="token operator">=</span>c<span class="token punctuation">.</span>currency <span class="token operator">and</span> o<span class="token punctuation">.</span>order_time  <span class="token operator">BETWEEN</span> c<span class="token punctuation">.</span>update_time <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">HOUR</span> <span class="token operator">AND</span> c<span class="token punctuation">.</span>update_time<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="Temporal_Joinsjoin_344"></a>Temporal Joins（时态join）</h4> 
<blockquote> 
 <p>时态表是一个随时间演变的表，在Flink中也称为动态表。时态表中的行与一个或多个时态周期相关联，并且所有Flink表都是时态的（动态的）。时态表包含一个或多个版本化的表快照，它可以是跟踪更改的更改历史表（例如数据库更改日志，包含所有快照），也可以是具体化更改的维表（例如包含最新快照的数据库表）。</p> 
</blockquote> 
<p><strong>时态表可以分为 <code>版本表</code> 和 <code>普通表</code>。</strong></p> 
<ul><li> <p><strong>版本表</strong>（流表）: 如果时态表中的记录可以追踪和并访问它的历史版本，这种表我们称之为版本表，来自数据库的 changelog （如mysql binlog）可以定义成版本表，<strong>版本表内的数据始终不会自动清理，只能通过upsert触发</strong>。</p> </li><li> <p><strong>普通表</strong>（维表）: 如果时态表中的记录仅仅可以追踪并和它的最新版本，这种表我们称之为普通表，来自数据库 或 HBase 、redis的表可以定义成普通表。</p> </li></ul> 
<p><strong>特征：</strong></p> 
<ul><li>只支持INNER JOIN、LEFT JOIN</li><li><strong>只有左流触发更新</strong></li><li>输出流保留时间属性</li></ul> 
<p><strong>时态join类型</strong></p> 
<ul><li>JOIN Lookup</li><li>JOIN 版本表</li><li><s>JOIN hive分区表</s></li></ul> 
<p><strong>语法</strong></p> 
<blockquote> 
 <p><em><strong>使用<code>FOR SYSTEM_TIME AS OF table1.proctime</code>表示当左边表的记录与右边的维表join时，只匹配当前处理时间维表所对应的的快照数据（即关联维表当前最新的状态）</strong></em></p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token punctuation">[</span>column_list<span class="token punctuation">]</span>
<span class="token keyword">FROM</span> table1 <span class="token punctuation">[</span><span class="token keyword">AS</span> <span class="token operator">&lt;</span>alias1<span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token keyword">LEFT</span><span class="token punctuation">]</span> <span class="token keyword">JOIN</span> table2 <span class="token keyword">FOR</span> SYSTEM_TIME <span class="token keyword">AS</span> <span class="token keyword">OF</span> table1<span class="token punctuation">.</span>{ proctime <span class="token operator">|</span> rowtime } <span class="token punctuation">[</span><span class="token keyword">AS</span> <span class="token operator">&lt;</span>alias2<span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token keyword">ON</span> table1<span class="token punctuation">.</span><span class="token keyword">column</span><span class="token operator">-</span>name1 <span class="token operator">=</span> table2<span class="token punctuation">.</span><span class="token keyword">column</span><span class="token operator">-</span>name1
</code></pre> 
<p><em>扩展：Temporary table（临时表）和Temporal table（时态表）是两个不同概念。Temporary table是临时的表对象，属于当前Session，随着Session的结束而消失，该表不属于Catalog和DB</em></p> 
<h5><a id="JOIN_Lookup_386"></a>JOIN Lookup</h5> 
<p><strong>特性：</strong></p> 
<blockquote> 
 <p>Lookup join是针对于由作业流表触发，关联右侧维表来补全数据的场景 。默认情况下，在流表有数据变更，都会触发维表查询（可以通过设置维表是否缓存，来减轻查询压力），由于不保存状态，因此对内存占用较小</p> 
</blockquote> 
<ul><li>左侧为流表、右侧为<strong>维表</strong></li><li>流表需要指定<strong>处理时间</strong></li><li>具备lookup能力的外部系统</li><li>自己实现LookupTableSource接口connector</li></ul> 
<p><strong>举例</strong></p> 
<p>kafka作为流表+jdbc、hbase、redis</p> 
<pre><code class="prism language-sql"><span class="token comment">--维表  </span>
<span class="token keyword">CREATE</span> <span class="token keyword">TEMPORARY</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_time<span class="token punctuation">`</span></span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
   <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'jdbc'</span><span class="token punctuation">,</span>
   <span class="token string">'url'</span> <span class="token operator">=</span> <span class="token string">'jdbc:mysql://localhost:3306/flink'</span><span class="token punctuation">,</span>
   <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
   <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
   <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'123456'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--流表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orders <span class="token punctuation">(</span>
    order_id    STRING<span class="token punctuation">,</span>
    price       <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    user_id    STRING<span class="token punctuation">,</span>
    order_time  <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    proctime <span class="token keyword">AS</span> PROCTIME<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'order'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'localhost:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'testGroup'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'latest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">----使用FOR SYSTEM_TIME AS OF table1.proc_time表示当左边表的记录与右边的维表join时，只匹配当前处理时间维表所对应的的快照数据（即关联维表当前最新的状态）</span>
<span class="token keyword">select</span> orders<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>orders<span class="token punctuation">.</span>price<span class="token punctuation">,</span>orders<span class="token punctuation">.</span>order_time<span class="token punctuation">,</span>c<span class="token punctuation">.</span>name  
<span class="token keyword">FROM</span> orders 
 <span class="token keyword">LEFT</span>  <span class="token keyword">JOIN</span> users <span class="token keyword">FOR</span> SYSTEM_TIME <span class="token keyword">AS</span> <span class="token keyword">OF</span> orders<span class="token punctuation">.</span>proctime  <span class="token keyword">AS</span> c 
<span class="token keyword">ON</span> orders<span class="token punctuation">.</span>user_id <span class="token operator">=</span> c<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b5/e7/leB30L44_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="JOIN__442"></a>JOIN 版本表</h5> 
<p>可以追溯数据历史版本的表，如：数据库changelog，数据源有：mysql-binlog、kafka-upsert、oracle-cdc等。需要具备<code>事件时间</code>和<code>主键</code>两个属性。</p> 
<ul><li> <p>**版本表：**本身具备upsert特性的表，直接作为版本表的数据源使用</p> <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> currency_rates <span class="token punctuation">(</span>
    currency STRING<span class="token punctuation">,</span>
    conversion_rate <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    update_time <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    WATERMARK <span class="token keyword">FOR</span> update_time <span class="token keyword">AS</span> update_time<span class="token punctuation">,</span>  <span class="token comment">--事件时间</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>currency<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED <span class="token comment">-- 主键</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
    <span class="token string">'value.format'</span> <span class="token operator">=</span> <span class="token string">'debezium-json'</span><span class="token punctuation">,</span> <span class="token comment">--changelog数据源：{"before":{},"after":{},"op":"u"}</span>
   <span class="token comment">/* ... */</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> 
     order_id<span class="token punctuation">,</span>
     price<span class="token punctuation">,</span>
     currency<span class="token punctuation">,</span>
     conversion_rate<span class="token punctuation">,</span>
     order_time
<span class="token keyword">FROM</span> orders
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> currency_rates <span class="token keyword">FOR</span> SYSTEM_TIME <span class="token keyword">AS</span> <span class="token keyword">OF</span> orders<span class="token punctuation">.</span>order_time
<span class="token keyword">ON</span> orders<span class="token punctuation">.</span>currency <span class="token operator">=</span> currency_rates<span class="token punctuation">.</span>currency<span class="token punctuation">;</span>
</code></pre> </li><li> <p><strong>版本视图</strong>：本身不是版本表，通过视图、函数转换为版本视图</p> <pre><code class="prism language-sql"><span class="token comment">-- kafka json格式的数据为append-only数据源</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> ratesHistory <span class="token punctuation">(</span>
    currency STRING<span class="token punctuation">,</span>
    conversion_rate <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    update_time  <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    WATERMARK <span class="token keyword">FOR</span> update_time <span class="token keyword">AS</span> update_time  <span class="token comment">--事件时间</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
    <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
   <span class="token comment">/* ... */</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 转化为版本视图</span>

<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> versionedRates <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> currency<span class="token punctuation">,</span>conversion_rate<span class="token punctuation">,</span>update_time <span class="token comment">-- 事件时间：update_time</span>
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> currency <span class="token comment">-- 主键：currency</span>
                              <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> update_time <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rowNum 
  <span class="token keyword">FROM</span> ratesHistory<span class="token punctuation">)</span>
<span class="token keyword">where</span> rowNum<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> 
     order_id<span class="token punctuation">,</span>
     price<span class="token punctuation">,</span>
     currency<span class="token punctuation">,</span>
     conversion_rate<span class="token punctuation">,</span>
     order_time
<span class="token keyword">FROM</span> orders
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> versionedRates <span class="token keyword">FOR</span> SYSTEM_TIME <span class="token keyword">AS</span> <span class="token keyword">OF</span> orders<span class="token punctuation">.</span>order_time
<span class="token keyword">ON</span> orders<span class="token punctuation">.</span>currency <span class="token operator">=</span> currency_rates<span class="token punctuation">.</span>currency<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h5><a id="Event_Time_Temporal_Join_510"></a>Event Time Temporal Join（版本表）</h5> 
<blockquote> 
 <p>事件时间临时join 允许针对版本化表进行联接。这意味着可以通过更改元数据来丰富表，并在某个时间点检索其值。临时join取一个任意表（左输入），并将每一行与版本化表（右输入）中相应行的相关版本相关联。没有时间窗口</p> 
</blockquote> 
<p><strong>特性：</strong></p> 
<blockquote> 
 <p>与双流join不同，尽管构建端发生了更改，但之前的临时表结果不会受到影响。与间隔join相比，时态表join没有定义oin记录的时间窗口。左侧表的记录总是在时间属性指定的时间与右侧表的版本连接。因此，构建端的行可能任意陈旧</p> 
</blockquote> 
<ul><li>左侧为流表、右侧为<strong>版本表</strong></li><li>两侧表都需要指定<strong>事件时间</strong></li><li>版本表的数据会持续增加</li></ul> 
<p><strong>满足场景：</strong></p> 
<ol><li> <p>左输入表为<strong>流表</strong>，右输入表为<strong>版本表</strong>（ Changelog 动态表，即 Upsert、Retract 数据流，而非 Append 数据流）</p> </li><li> <p>两侧表都需要设置watermark，版本表需要设置主键，主键必须包含在 JOIN 等值条件中</p> </li><li> <p>版本表发生变更，不会触发查询结果输出，会根据主键更新临时表</p> </li></ol> 
<p>**举例 **</p> 
<p>用户在下订单时，需要根据订单时间的汇率，计算订单金额，其中下单是以不同的货币技术，我们需要将他输出到特定货币（CNY）</p> 
<p><img src="https://images2.imgbox.com/34/ec/mezynOMt_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment"># 订单表（普通表）</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orders <span class="token punctuation">(</span>
    order_id    STRING<span class="token punctuation">,</span>
    price       <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    currency    STRING<span class="token punctuation">,</span>
    order_time   <span class="token keyword">timestamp</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    WATERMARK <span class="token keyword">FOR</span> order_time <span class="token keyword">AS</span> order_time
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'order'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'localhost:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'orders2ConsumerGroup'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'latest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">-- 汇率表 （版本表）</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> currency_rates <span class="token punctuation">(</span>
    currency STRING<span class="token punctuation">,</span>
    conversion_rate <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    update_time <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    WATERMARK <span class="token keyword">FOR</span> update_time <span class="token keyword">AS</span> update_time<span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>currency<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
<span class="token punctuation">)</span> <span class="token keyword">WITH</span>  <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'currency_rates'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'localhost:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'currencyRatesGroup'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'latest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'debezium-json'</span><span class="token punctuation">,</span>
  <span class="token string">'debezium-json.schema-include'</span> <span class="token operator">=</span> <span class="token string">'true'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> o<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>o<span class="token punctuation">.</span>price<span class="token punctuation">,</span>o<span class="token punctuation">.</span>order_time<span class="token punctuation">,</span>c<span class="token punctuation">.</span>currency  
<span class="token keyword">FROM</span> orders <span class="token keyword">AS</span> o 
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> currency_rates <span class="token keyword">FOR</span> SYSTEM_TIME <span class="token keyword">AS</span> <span class="token keyword">OF</span> o<span class="token punctuation">.</span>order_time  <span class="token keyword">AS</span> c 
<span class="token keyword">ON</span> o<span class="token punctuation">.</span>currency <span class="token operator">=</span> c<span class="token punctuation">.</span>currency<span class="token punctuation">;</span>

<span class="token comment">-- 汇率表(版本视图)</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> ratesHistory <span class="token punctuation">(</span>
    currency STRING<span class="token punctuation">,</span>
    conversion_rate <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    update_time <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    WATERMARK <span class="token keyword">FOR</span> update_time <span class="token keyword">AS</span> update_time
<span class="token punctuation">)</span> <span class="token keyword">WITH</span>  <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'currency_rates'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'localhost:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'currencyRatesGroup'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'latest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> versionedRates <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> currency<span class="token punctuation">,</span>conversion_rate<span class="token punctuation">,</span>update_time 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token punctuation">,</span>ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> currency
                              <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> update_time <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rowNum 
  <span class="token keyword">FROM</span> ratesHistory<span class="token punctuation">)</span>
<span class="token keyword">where</span> rowNum<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> o<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>o<span class="token punctuation">.</span>price<span class="token punctuation">,</span>o<span class="token punctuation">.</span>order_time<span class="token punctuation">,</span>c<span class="token punctuation">.</span>currency  
<span class="token keyword">FROM</span> orders <span class="token keyword">AS</span> o 
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> versionedRates <span class="token keyword">FOR</span> SYSTEM_TIME <span class="token keyword">AS</span> <span class="token keyword">OF</span> o<span class="token punctuation">.</span>order_time  <span class="token keyword">AS</span> c 
<span class="token keyword">ON</span> o<span class="token punctuation">.</span>currency <span class="token operator">=</span> c<span class="token punctuation">.</span>currency<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f5/95/obvchkTK_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="Processing_Time_Temporal_Join_617"></a>Processing Time Temporal Join（不建议使用）</h5> 
<p><strong>由于基于处理时间的时态表 JOIN 存在 Bug（参见 <a href="https://issues.apache.org/jira/browse/FLINK-19830" rel="nofollow">FLINK-19830</a>），因此在最新的 Flink 版本中已被禁用</strong></p> 
<blockquote> 
 <p><code>处理时间临时表join</code>使用处理时间属性将行与外部版本化表中key的最新版本相关联。和<code>事件时间临时join </code>的区别是：右侧版本话表没有版本时间作为事件时间用来设置watermark，因此需要使用处理时间作为版本时间。这种join的强大之处在于，当在Flink中将表具体化为动态表不可行时，它允许Flink直接与外部系统协作。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
  o_amount<span class="token punctuation">,</span> r_rate
<span class="token keyword">FROM</span>
  Orders<span class="token punctuation">,</span>
  LATERAL <span class="token keyword">TABLE</span> <span class="token punctuation">(</span>Rates<span class="token punctuation">(</span>o_proctime<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">WHERE</span>
  r_currency <span class="token operator">=</span> o_currency
</code></pre> 
<h4><a id="JOIN_LATERAL_635"></a>JOIN LATERAL</h4> 
<blockquote> 
 <p>JOIN LATERAL 是单流驱动的join，根据左表逐条数据动态和右表进行JOIN。相对于其他flink Jon，JOIN LATERAL 的右边不是一个物理表，而是一个视图（view）或者Table-valued Funciton。LATERAL和 CROSS APPLY的语义相同</p> 
</blockquote> 
<p>单流驱动的join</p> 
<pre><code class="prism language-sql"><span class="token comment"># LATERAL</span>
<span class="token keyword">SELECT</span> 
	e<span class="token punctuation">.</span>NAME<span class="token punctuation">,</span> e<span class="token punctuation">.</span>DEPTNO<span class="token punctuation">,</span> d<span class="token punctuation">.</span>NAME 
<span class="token keyword">FROM</span> EMPS e<span class="token punctuation">,</span> LATERAL <span class="token punctuation">(</span> 
  <span class="token keyword">SELECT</span>  <span class="token operator">*</span> 
  FORM DEPTS d 
  <span class="token keyword">WHERE</span> e<span class="token punctuation">.</span>DEPTNO<span class="token operator">=</span>d<span class="token punctuation">.</span>DEPTNO 
<span class="token punctuation">)</span> <span class="token keyword">as</span> d<span class="token punctuation">;</span> 

<span class="token comment"># inner join</span>
<span class="token keyword">SELECT</span> users<span class="token punctuation">,</span> tag
<span class="token keyword">FROM</span> Orders<span class="token punctuation">,</span> LATERAL <span class="token keyword">TABLE</span><span class="token punctuation">(</span>unnest_udtf<span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">)</span> t <span class="token keyword">AS</span> tag<span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> order_id<span class="token punctuation">,</span> res
<span class="token keyword">FROM</span> Orders<span class="token punctuation">,</span>
LATERAL <span class="token keyword">TABLE</span><span class="token punctuation">(</span>table_func<span class="token punctuation">(</span>order_id<span class="token punctuation">)</span><span class="token punctuation">)</span> t<span class="token punctuation">(</span>res<span class="token punctuation">)</span>

<span class="token keyword">SELECT</span> order_id<span class="token punctuation">,</span> res
<span class="token keyword">FROM</span> Orders
<span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> LATERAL <span class="token keyword">TABLE</span><span class="token punctuation">(</span>table_func<span class="token punctuation">(</span>order_id<span class="token punctuation">)</span><span class="token punctuation">)</span> t<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token keyword">ON</span> <span class="token boolean">TRUE</span>


<span class="token comment"># CROSS APPLAY</span>
<span class="token keyword">SELECT</span> 
	c<span class="token punctuation">.</span>customerid<span class="token punctuation">,</span> c<span class="token punctuation">.</span>city<span class="token punctuation">,</span> o<span class="token punctuation">.</span>orderid 
<span class="token keyword">FROM</span> Customers c<span class="token punctuation">,</span> <span class="token keyword">CROSS</span> APPLAY<span class="token punctuation">(</span> 
  <span class="token keyword">SELECT</span> 
  	o<span class="token punctuation">.</span>orderid<span class="token punctuation">,</span> o<span class="token punctuation">.</span>customerid 
  <span class="token keyword">FROM</span> Orders o 
  <span class="token keyword">WHERE</span> o<span class="token punctuation">.</span>customerid <span class="token operator">=</span> c<span class="token punctuation">.</span>customerid 
<span class="token punctuation">)</span> <span class="token keyword">as</span> o 
<span class="token comment"># LATERAL</span>
<span class="token keyword">SELECT</span> 
	e<span class="token punctuation">.</span>NAME<span class="token punctuation">,</span> e<span class="token punctuation">.</span>DEPTNO<span class="token punctuation">,</span> d<span class="token punctuation">.</span>NAME 
<span class="token keyword">FROM</span> EMPS e<span class="token punctuation">,</span> LATERAL <span class="token punctuation">(</span> 
  <span class="token keyword">SELECT</span>  <span class="token operator">*</span> 
  FORM DEPTS d 
  <span class="token keyword">WHERE</span> e<span class="token punctuation">.</span>DEPTNO<span class="token operator">=</span>d<span class="token punctuation">.</span>DEPTNO 
<span class="token punctuation">)</span> <span class="token keyword">as</span> d<span class="token punctuation">;</span> 

</code></pre> 
<h3><a id="Join_687"></a>窗口Join</h3> 
<h4><a id="_689"></a>窗口函数</h4> 
<blockquote> 
 <p><strong>Windowing table-valued functions (Windowing TVFs) Apache Flink提供了几个窗口表值函数（TVF），用于将表的元素划分为多个窗口，包括：</strong></p> 
 <ul><li>Tumble Windows</li><li>Hop Windows</li><li>Cumulate Windows</li><li>Session Windows (will be supported soon)</li></ul> 
 <p><strong>。基于SQL的窗口函数</strong></p> 
</blockquote> 
<h5><a id="TUMBLE_700"></a>TUMBLE（滚动窗口）</h5> 
<blockquote> 
 <p><strong>滚动窗口有固定的尺寸，窗口间的元素无重复</strong></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/1c/33/0qYKdA0P_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql">TUMBLE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> <span class="token keyword">data</span><span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>timecol<span class="token punctuation">)</span><span class="token punctuation">,</span> size <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token keyword">offset</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><code>data</code>: 包含时间属性列的表</li><li><code>timecol</code>: 是一个列描述符，指示数据的哪个时间属性列应映射到滚动窗口</li><li><code>size</code>: 是指定滚动窗口宽度的持续时间。</li><li><code>offset</code>: 是一个可选参数，用于指定窗口将要开始的偏移量。</li></ul> 
<p><em>例：每10分钟将10分钟内的金额汇总计算</em></p> 
<pre><code class="prism language-sql"><span class="token comment"># 其中 watermark(`bidtime` - INTERVAL '1' SECOND 	)</span>
 <span class="token keyword">SELECT</span> window_start<span class="token punctuation">,</span> window_end<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>
    TUMBLE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> Bid<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>bidtime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> MINUTES<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> window_start<span class="token punctuation">,</span> window_end<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="HOP_727"></a>HOP（滑动窗口）</h5> 
<blockquote> 
 <p>HOP函数将元素分配给固定长度的窗口。与TUMBLE窗口函数类似，窗口的大小由窗口大小参数配置。另一个窗口滑动参数控制跳转窗口的启动频率</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/64/27/rTYLC2pq_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql">HOP<span class="token punctuation">(</span><span class="token keyword">TABLE</span> <span class="token keyword">data</span><span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>timecol<span class="token punctuation">)</span><span class="token punctuation">,</span> slide<span class="token punctuation">,</span> size <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token keyword">offset</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><code>data</code>: 包含时间属性列的表</li><li><code>timecol</code>: 是一个列描述符，指示数据的哪个时间属性列应该映射到滑动窗口</li><li><code>slide</code>: 每个滑动窗口创建的间隔时间</li><li><code>size</code>: 是指定滑动窗口宽度的持续时间</li><li><code>offset</code>: 是一个可选参数，用于指定窗口将要开始的偏移量。</li></ul> 
<p><em>例：将10分钟内的金额汇总计算，并且每5分钟触发一次计算</em></p> 
<pre><code class="prism language-sql"><span class="token comment"># 其中 watermark(`bidtime` - INTERVAL '1' SECOND 	)</span>
<span class="token keyword">SELECT</span> window_start<span class="token punctuation">,</span> window_end<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>
    HOP<span class="token punctuation">(</span><span class="token keyword">TABLE</span> Bid<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>bidtime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> MINUTES<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> MINUTES<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> window_start<span class="token punctuation">,</span> window_end<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="CUMULATE_756"></a>CUMULATE（累积窗口）</h5> 
<blockquote> 
 <p>CUMULATE函数有固定的窗口大小和步长，同一个窗口会按照步长逐步累计时间的形式，触发窗口计算操作，其他在同一窗口触发计算的多个滚动窗口有相同的window_start，window_end会累加步长的时间长度。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/cc/d7/53hjZMtz_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql">CUMULATE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> <span class="token keyword">data</span><span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>timecol<span class="token punctuation">)</span><span class="token punctuation">,</span> step<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
</code></pre> 
<ul><li><code>data</code>: 包含时间属性列的表</li><li><code>timecol</code>: 是一个列描述符，指示数据的哪个时间属性列应映射到滚动窗口。</li><li><code>step</code>: 是指定连续累积窗口结束之间增加的窗口大小的持续时间（步长）</li><li><code>size</code>: 是指定累积窗口的最大宽度的持续时间。大小必须是步长的整数倍。</li><li><code>offset</code>: 是一个可选参数，用于指定窗口将要开始的偏移量。</li></ul> 
<p><em>例：每2分钟计算总金额，并在累积10分钟后，计算总金额</em></p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> window_start<span class="token punctuation">,</span> window_end<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>
    CUMULATE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> Bid<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>bidtime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'2'</span> MINUTES<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> MINUTES<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> window_start<span class="token punctuation">,</span> window_end<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="Join_784"></a>窗口Join语法</h4> 
<blockquote> 
 <p>窗口join将时间维度添加到join条件本身中。这样做时，窗口join将两个流的元素连接在一起，这两个流共享一个公共键并位于同一窗口中。窗口join的语义与DataStream窗口联接相同</p> 
</blockquote> 
<p><strong>特性：对于流式查询，与连续表上的其他join不同，窗口join不发出中间结果，而只在窗口结束时发出最终结果，后续延迟数据可能会丢失，实时性和准确性方面都相对较差。此外，窗口join在不再需要时清除所有中间状态</strong></p> 
<p><strong>窗口触发join的条件：</strong></p> 
<ul><li>两个流的水位线均已经推进到<code>window_end</code></li></ul> 
<p><strong>支持的join类型：</strong></p> 
<p>​ <strong>INNER/LEFT/RIGHT/FULL OUTER/ANTI/SEMI JOIN</strong></p> 
<p>语法：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">FROM</span> L <span class="token punctuation">[</span><span class="token keyword">LEFT</span><span class="token operator">|</span><span class="token keyword">RIGHT</span><span class="token operator">|</span><span class="token keyword">FULL</span> <span class="token keyword">OUTER</span><span class="token punctuation">]</span> <span class="token keyword">JOIN</span> R <span class="token comment">-- L and R are relations applied windowing TVF</span>
<span class="token keyword">ON</span> L<span class="token punctuation">.</span>window_start <span class="token operator">=</span> R<span class="token punctuation">.</span>window_start <span class="token operator">AND</span> L<span class="token punctuation">.</span>window_end <span class="token operator">=</span> R<span class="token punctuation">.</span>window_end <span class="token operator">AND</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<ul><li> <p><strong>INNER/LEFT/RIGHT/FULL OUTER JOIN</strong></p> <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> L<span class="token punctuation">.</span>num <span class="token keyword">as</span> L_Num<span class="token punctuation">,</span> L<span class="token punctuation">.</span>id <span class="token keyword">as</span> L_Id<span class="token punctuation">,</span> R<span class="token punctuation">.</span>num <span class="token keyword">as</span> R_Num<span class="token punctuation">,</span> R<span class="token punctuation">.</span>id <span class="token keyword">as</span> R_Id<span class="token punctuation">,</span> L<span class="token punctuation">.</span>window_start<span class="token punctuation">,</span> L<span class="token punctuation">.</span>window_end
           <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
               <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>TUMBLE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> LeftTable<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>row_time<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> MINUTES<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">)</span> L
           <span class="token keyword">FULL</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
               <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>TUMBLE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> RightTable<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>row_time<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> MINUTES<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">)</span> R
           <span class="token keyword">ON</span> L<span class="token punctuation">.</span>num <span class="token operator">=</span> R<span class="token punctuation">.</span>num <span class="token operator">AND</span> L<span class="token punctuation">.</span>window_start <span class="token operator">=</span> R<span class="token punctuation">.</span>window_start <span class="token operator">AND</span> L<span class="token punctuation">.</span>window_end <span class="token operator">=</span> R<span class="token punctuation">.</span>window_end<span class="token punctuation">;</span>
</code></pre> <p>例：</p> <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span>
  user_id STRING<span class="token punctuation">,</span>
  name STRING<span class="token punctuation">,</span>
  age <span class="token keyword">INT</span><span class="token punctuation">,</span>
  gmt_time <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  WATERMARK <span class="token keyword">FOR</span> gmt_time <span class="token keyword">AS</span> gmt_time
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
 <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'users'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'localhost:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'orders2ConsumerGroup'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'latest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> address <span class="token punctuation">(</span>
  user_id STRING<span class="token punctuation">,</span>
  address STRING<span class="token punctuation">,</span>
  update_time <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  WATERMARK <span class="token keyword">FOR</span> update_time <span class="token keyword">AS</span> update_time
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'address'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'localhost:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'orders2ConsumerGroup'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'latest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span>a<span class="token punctuation">.</span>address <span class="token punctuation">,</span>u<span class="token punctuation">.</span>window_start<span class="token punctuation">,</span>u<span class="token punctuation">.</span>window_end
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>TUMBLE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> users<span class="token punctuation">,</span>DESCRIPTOR<span class="token punctuation">(</span>gmt_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">AS</span> u <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>TUMBLE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> address<span class="token punctuation">,</span>DESCRIPTOR<span class="token punctuation">(</span>update_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span>   
<span class="token punctuation">)</span><span class="token keyword">AS</span> a
<span class="token keyword">ON</span> u<span class="token punctuation">.</span>user_id <span class="token operator">=</span> a<span class="token punctuation">.</span>user_id <span class="token operator">AND</span> u<span class="token punctuation">.</span>window_start <span class="token operator">=</span>a<span class="token punctuation">.</span>window_start <span class="token operator">AND</span> u<span class="token punctuation">.</span>window_end <span class="token operator">=</span> a<span class="token punctuation">.</span>window_end<span class="token punctuation">;</span>


<span class="token comment">--users</span>
<span class="token comment">-- {"user_id":"u1","name":"li","age":20,"gmt_time":"2022-11-01 10:00:00"}</span>
<span class="token comment">-- {"user_id":"u2","name":"li","age":20,"gmt_time":"2022-11-01 10:00:10"}</span>
<span class="token comment">-- {"user_id":"u2","name":"li","age":20,"gmt_time":"2022-11-01 10:00:20"}</span>

<span class="token comment">--address</span>
<span class="token comment">-- {"user_id":"u1","address":"shanghai","update_time":"2022-11-01 10:00:05"}</span>
<span class="token comment">-- {"user_id":"u2","address":"beijing","update_time":"2022-11-01 10:00:15"}</span>
<span class="token comment">-- {"user_id":"u2","address":"anhui","update_time":"2022-11-01 10:00:20"}</span>



   user_id                        address            window_start              window_end
       u1                       shanghai <span class="token number">2022</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span>:<span class="token number">00</span>:<span class="token number">00.000</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span>:<span class="token number">00</span>:<span class="token number">10.000</span>
       u2                        beijing <span class="token number">2022</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span>:<span class="token number">00</span>:<span class="token number">10.000</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span>:<span class="token number">00</span>:<span class="token number">20.000</span>
       u2                          anhui <span class="token number">2022</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span>:<span class="token number">00</span>:<span class="token number">10.000</span> <span class="token number">2022</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span>:<span class="token number">00</span>:<span class="token number">20.000</span>

</code></pre> </li><li> <p><strong>SEMI JOIN</strong></p> <p>如果在公共窗口的右侧至少有一个匹配行，左窗口返回一行。</p> <pre><code class="prism language-sql"> <span class="token keyword">SELECT</span> <span class="token operator">*</span>
           <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
               <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>TUMBLE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> LeftTable<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>row_time<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> MINUTES<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">)</span> L <span class="token keyword">WHERE</span> L<span class="token punctuation">.</span>num <span class="token operator">IN</span> <span class="token punctuation">(</span>
             <span class="token keyword">SELECT</span> num <span class="token keyword">FROM</span> <span class="token punctuation">(</span>   
               <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>TUMBLE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> RightTable<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>row_time<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> MINUTES<span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token punctuation">)</span> R <span class="token keyword">WHERE</span> L<span class="token punctuation">.</span>window_start <span class="token operator">=</span> R<span class="token punctuation">.</span>window_start <span class="token operator">AND</span> L<span class="token punctuation">.</span>window_end <span class="token operator">=</span> R<span class="token punctuation">.</span>window_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><strong>ANTI JOIN</strong></p> <p>返回左侧窗口没有右侧窗口没有匹配的数据</p> <pre><code class="prism language-sql"> <span class="token keyword">SELECT</span> <span class="token operator">*</span>
           <span class="token keyword">FROM</span> <span class="token punctuation">(</span>
               <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>TUMBLE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> LeftTable<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>row_time<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> MINUTES<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">)</span> L <span class="token keyword">WHERE</span> L<span class="token punctuation">.</span>num <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
             <span class="token keyword">SELECT</span> num <span class="token keyword">FROM</span> <span class="token punctuation">(</span>   
               <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>TUMBLE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> RightTable<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>row_time<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> MINUTES<span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token punctuation">)</span> R <span class="token keyword">WHERE</span> L<span class="token punctuation">.</span>window_start <span class="token operator">=</span> R<span class="token punctuation">.</span>window_start <span class="token operator">AND</span> L<span class="token punctuation">.</span>window_end <span class="token operator">=</span> R<span class="token punctuation">.</span>window_end<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h2><a id="_917"></a>总结</h2> 
<table><thead><tr><th align="left">JOIN 类型</th><th>触发join</th><th>场景</th><th align="left">实时性</th><th align="left">准确度</th><th>内存占用</th><th>waterrmark</th><th align="left">时间属性</th></tr></thead><tbody><tr><td align="left">双流join</td><td>双流</td><td>每一个数据流有变更都会触发join，并且状态会保存</td><td align="left">高</td><td align="left">先低后高（逐步更新）</td><td>高（需要设置状态生存时间）</td><td>否</td><td align="left">事件时间、处理时间</td></tr><tr><td align="left">时间区间 JOIN</td><td>双流</td><td>拥有相同key且 事件时间处于 lowerBoundTime 和 upperBoundTime之间的元素进行join</td><td align="left">中</td><td align="left">中（取决于区间大小）</td><td>中（取决于区间大小）</td><td>是（都需要）</td><td align="left">事件时间、处理时间</td></tr><tr><td align="left">时态表 JOIN（版本表）</td><td>单流</td><td>单流和版本表的join，具有历史版本状态管理功能。流表：事件时间，版本表：事件时间和主键</td><td align="left">中</td><td align="left">高（取决于具体实现）</td><td>高（取决于版本表大小 ）</td><td>是（都需要）</td><td align="left">事件时间</td></tr><tr><td align="left">时态表 JOIN（Join Lookup ）</td><td>单流</td><td>单流和维表的join，join要求一个表具有处理时间属性（流表），另一个表由查找源连接器支持（维表，实现了LookupableTableSource）</td><td align="left">高</td><td align="left">高（取决于是否缓存、异步等）</td><td>低（取决于是否缓存、异步等）</td><td>是（流表）</td><td align="left">处理时间</td></tr><tr><td align="left">JOIN LATERAL</td><td>单流</td><td>单流和UDTF的join。JOIN LATERAL 的右边不是一个物理表，而是一个视图（view）或者Table-valued Funciton。不具备状态管理功能</td><td align="left">高</td><td align="left">高（取决于是否缓存、异步等）</td><td>低（取决于是否缓存、异步等）</td><td>否</td><td align="left"></td></tr><tr><td align="left">窗口 JOIN</td><td>双流</td><td>相同key且位于相同时间窗口的元素进行 join</td><td align="left">低</td><td align="left">低（取决于窗口大小和类型）</td><td>中（取决于窗口大小）</td><td>是（都需要）watermark取双流中较慢的为准</td><td align="left">事件时间、处理时间</td></tr></tbody></table>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5d32d349607796ee35981ee002c5558c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">判断101-200之间有多少素数</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/76c6568da63576c92bc448dc135af6d9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">IC验证——UVM学习——验证平台中的组件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>