<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>The Flask Mega-Tutorial 之 Chapter 10: Email Support - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="The Flask Mega-Tutorial 之 Chapter 10: Email Support" />
<meta property="og:description" content="小引 很多网站都有给用户发 email 的设置，很常规的一个目的是解决 authentication 相关的问题。本节将添加 email support，基于此添加 password reset feature。当 user 忘掉 password 时，可以选择 reset，app 据此会给 user 发送一封带有 crafted link 的 email，user 点击链接，转到 reset 页面，进行 reset。 Introduction to Flask-Mail 1、引入两个 extension，分别是 Flask-Mail 和 pyjwt。
Flask-Mail， 用于发送邮件pyjwt， JSON Web Tokens 的一个package，用于生成 secure token，此 token 将被添加到邮件中的 password reset link 中 (venv) $ pip install flask-mail (venv) $ pip install pyjwt
2、配置 Flask-Mail
和其他 Flask extensions 一样，需要在 flask application instance 后，创建对应的 instance： app/__init__." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/247e86508a804327944ca86fbf03dbf4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-06-17T12:52:20+08:00" />
<meta property="article:modified_time" content="2018-06-17T12:52:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">The Flask Mega-Tutorial 之 Chapter 10: Email Support</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3 id="小引">小引</h3> 
<ul><li>很多网站都有给用户发 email 的设置，很常规的一个目的是解决 authentication 相关的问题。</li><li>本节将添加 email support，基于此添加 password reset feature。</li><li>当 user 忘掉 password 时，可以选择 reset，app 据此会给 user 发送一封带有 crafted link 的 email，user 点击链接，转到 reset 页面，进行 reset。</li></ul> 
<hr> 
<h3 id="introduction-to-flask-mail">Introduction to Flask-Mail</h3> 
<p>1、引入两个 extension，分别是 <strong>Flask-Mail</strong> 和 <strong>pyjwt</strong>。</p> 
<ul><li><strong>Flask-Mail</strong>， 用于发送邮件</li><li><strong>pyjwt</strong>， JSON Web Tokens 的一个package，用于生成 secure token，此 token 将被添加到邮件中的 password reset link 中</li></ul> 
<p><code>(venv) $ pip install flask-mail</code> <br> <code>(venv) $ pip install pyjwt</code></p> 
<p><br></p> 
<p>2、配置 Flask-Mail</p> 
<p>和其他 Flask extensions 一样，需要在 flask application instance 后，创建对应的 instance： <br> <code>app/__init__.py</code>: <em>Flask-Mail instance.</em></p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-comment"># ...</span>
<span class="hljs-keyword">from</span> flask_mail <span class="hljs-keyword">import</span> Mail

app = Flask(__name__)
<span class="hljs-comment"># ...</span>
mail = Mail(app)</code></pre> 
<p><br></p> 
<p>3、发送邮件的两种方式</p> 
<ul><li>Emulated Email Server （常用于testing 验证）</li></ul> 
<p>在第一个 terminal 运行 flask run，在第二个 terminal 运行如下命令：</p> 
<p><code>(venv) $ python -m smtpd -n -c DebuggingServer localhost:8025</code></p> 
<p><br>注：运行之前，须完成 environment variable 的设置</p> 
<pre class="prettyprint"><code class=" hljs bash">(venv) $ <span class="hljs-keyword">export</span> MAIL_SERVER=localhost
(venv) $ <span class="hljs-keyword">export</span> MAIL_PORT=<span class="hljs-number">8025</span></code></pre> 
<p><br></p> 
<ul><li>Real Email Server</li></ul> 
<p>config.py 中已在chapter 7 Error Handling 完成设置环境变量： <br> <code>MAIL_SERVER</code>， <code>MAIL_PORT</code>， <code>MAIL_USE_TLS</code>， <code>MAIL_USERNAME</code>，<code>MAIL_PASSWORD</code></p> 
<p>Gmail 账户的设置命令如下：</p> 
<pre class="prettyprint"><code class=" hljs bash">(venv) $ <span class="hljs-keyword">export</span> MAIL_SERVER=smtp.googlemail.com
(venv) $ <span class="hljs-keyword">export</span> MAIL_PORT=<span class="hljs-number">587</span>
(venv) $ <span class="hljs-keyword">export</span> MAIL_USE_TLS=<span class="hljs-number">1</span>
(venv) $ <span class="hljs-keyword">export</span> MAIL_USERNAME=&lt;your-gmail-username&gt;
(venv) $ <span class="hljs-keyword">export</span> MAIL_PASSWORD=&lt;your-gmail-password&gt;</code></pre> 
<p>注：Gmail 会阻止第三方应用通过它的服务器发送邮件，需要 explicitly allow “less secure apps” access to your Gmail account. <a href="https://support.google.com/accounts/answer/6010255?hl=en" rel="nofollow">设置见此</a></p> 
<hr> 
<h3 id="flask-mail-usage">Flask-Mail Usage</h3> 
<p>启动 <code>flask shell</code>，运行以下命令：</p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-prompt">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> flask_mail <span class="hljs-keyword">import</span> Message
<span class="hljs-prompt">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> mail
<span class="hljs-prompt">&gt;&gt;&gt; </span>msg = Message(<span class="hljs-string">'test subject'</span>, sender=app.config[<span class="hljs-string">'ADMINS'</span>][<span class="hljs-number">0</span>], recipients=[<span class="hljs-string">'your-email'</span>])
<span class="hljs-prompt">&gt;&gt;&gt; </span>msg.body = <span class="hljs-string">'text body'</span>
<span class="hljs-prompt">&gt;&gt;&gt; </span>msg.html = <span class="hljs-string">'&lt;h1&gt;HTML body&lt;/h1&gt;'</span>
<span class="hljs-prompt">&gt;&gt;&gt; </span>mail.send(msg)</code></pre> 
<ul><li>自 flask_mail 引入 Message，用于封装邮件信息</li><li>自 app 引入 mail（即 <code>mail = Mail(app)</code>）</li><li>Message(subject, sender, recipients)中，注意 sender 为 app.config[‘ADMINS’] 邮件列表的第一项</li><li>Message(subject, sender, recipients)中，注意 recipients 为 list</li><li>信息类似属性方式，绑定到 msg上</li></ul> 
<p><br></p> 
<hr> 
<h3 id="a-simple-email-framework">A Simple Email Framework</h3> 
<p>封装用于发送邮件的 helper function</p> 
<p><code>app / email.py</code>: <em>email sending wrapper function.</em></p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-keyword">from</span> flask_mail <span class="hljs-keyword">import</span> Message
<span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> mail

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_email</span><span class="hljs-params">(subject, sender, recipients, text_body, html_body)</span>:</span>
    msg = Message(subject, sender=sender, recipients=recipients)
    msg.body = text_body
    msg.html = html_body
    mail.send(msg)</code></pre> 
<p>Flask-Mail 另有 features，如 Cc and Bcc lists <a href="https://pythonhosted.org/Flask-Mail/" rel="nofollow">见此</a> <br> <br></p> 
<hr> 
<h3 id="requesting-a-password-reset">Requesting a Password Reset</h3> 
<p>1、请求密码重置，将链接入口设置在登录页 login.html 底部</p> 
<p><code>app / templates / login.html</code>: <em>password reset link in login </em></p> 
<pre class="prettyprint"><code class=" hljs handlebars"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>New User? <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"</span></span></span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">url</span>_<span class="hljs-variable">for</span>('<span class="hljs-variable">register</span>') }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-value">"</span>&gt;</span>Click to Register!<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>
        Forgot Your Password?
        <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"</span></span></span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">url</span>_<span class="hljs-variable">for</span>('<span class="hljs-variable">reset</span>_<span class="hljs-variable">password</span>_<span class="hljs-variable">request</span>') }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-value">"</span>&gt;</span>Click to Reset It<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
{% endblock %}</span></code></pre> 
<p>login 页面出现密码重置链接（如下） <br> <img src="https://images2.imgbox.com/02/d6/7wkNmCFl_o.png" alt="这里写图片描述" title=""></p> 
<p><br></p> 
<p>2、点击上述 login 页面的密码重置链接，user 会收到 new web form 用于填写自己的 email，以便 as a way to initiate the password reset process</p> 
<p><code>app / forms.py</code>: <em>reset password request form.</em></p> 
<pre class="prettyprint"><code class=" hljs haskell"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">ResetPasswordRequestForm</span><span class="hljs-container">(<span class="hljs-type">FlaskForm</span>)</span>:
    email = <span class="hljs-type">StringField</span><span class="hljs-container">('<span class="hljs-type">Email</span>', <span class="hljs-title">validators</span>=[<span class="hljs-type">DataRequired</span>()</span>, <span class="hljs-type">Email</span><span class="hljs-container">()</span>])
    submit = <span class="hljs-type">SubmitField</span><span class="hljs-container">('<span class="hljs-type">Request</span> <span class="hljs-type">Password</span> <span class="hljs-type">Reset</span>')</span></span></code></pre> 
<p><br></p> 
<p>3、 Reset password request 模板</p> 
<pre class="prettyprint"><code class=" hljs django"><span class="xml"></span><span class="hljs-template_tag">{% <span class="hljs-keyword">extends</span> "base.html" %}</span><span class="xml">

</span><span class="hljs-template_tag">{% <span class="hljs-keyword">block</span> content %}</span><span class="xml">
    <span class="hljs-tag">&lt;<span class="hljs-title">h1</span>&gt;</span>Reset Password<span class="hljs-tag">&lt;/<span class="hljs-title">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">action</span>=<span class="hljs-value">""</span> <span class="hljs-attribute">method</span>=<span class="hljs-value">"post"</span>&gt;</span>
        </span><span class="hljs-variable">{<!-- -->{ form.hidden_tag() }}</span><span class="xml">
        <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>
            </span><span class="hljs-variable">{<!-- -->{ form.email.label }}</span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span>
            </span><span class="hljs-variable">{<!-- -->{ form.email(size=64) }}</span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span>
            </span><span class="hljs-template_tag">{% <span class="hljs-keyword">for</span> error <span class="hljs-keyword">in</span> form.email.errors %}</span><span class="xml">
            <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">"color: red;"</span>&gt;</span>[</span><span class="hljs-variable">{<!-- -->{ error }}</span><span class="xml">]<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
            </span><span class="hljs-template_tag">{% <span class="hljs-keyword">endfor</span> %}</span><span class="xml">
        <span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span></span><span class="hljs-variable">{<!-- -->{ form.submit() }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
</span><span class="hljs-template_tag">{% <span class="hljs-keyword">endblock</span> %}</span><span class="xml"></span></code></pre> 
<p><img src="https://images2.imgbox.com/b7/ba/XlifJKVW_o.png" alt="这里写图片描述" title=""></p> 
<p><br></p> 
<p>4、创建路由 reset_password_request</p> 
<p><code>app/routes.py</code>: <em>reset password request view function.</em></p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-keyword">from</span> app.forms <span class="hljs-keyword">import</span> ResetPasswordRequestForm
<span class="hljs-keyword">from</span> app.email <span class="hljs-keyword">import</span> send_password_reset_email

<span class="hljs-decorator">@app.route('/reset_password_request', methods=['GET', 'POST'])</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reset_password_request</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">if</span> current_user.is_authenticated:
        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">'index'</span>))
    form = ResetPasswordRequestForm()
    <span class="hljs-keyword">if</span> form.validate_on_submit():
        user = User.query.filter_by(email=form.email.data).first()
        <span class="hljs-keyword">if</span> user:
            send_password_reset_email(user)
        flash(<span class="hljs-string">'Check your email for the instructions to reset your password'</span>)
        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">'login'</span>))
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'reset_password_request.html'</span>,
                           title=<span class="hljs-string">'Reset Password'</span>, form=form)</code></pre> 
<p></p> 
<ul><li><br> 
 </li><li>如为 logged user，则定向至 index 页</li><li>如server 收到初次 GET 请求（或提交表单未通过验证）， 则向 browser 发送空的 ‘reset_password_request.html’</li><li>提交的表单验证通过，根据填写的 email 查询 db 中的 user。如果有对应的 user，则通过 send_password_reset_email() 向其发送 email；如没有，则不发送。</li><li>无论提交的表单中的 email 在 db 中存在与否，都会 flash信息 ，后重定向至 登录页 login。 <br></li></ul> 
<p></p> 
<blockquote> 
 <p>This is so that clients cannot use this form to figure out if a given user is a member or not. <br> <br></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/85/15/Pdni96qG_o.png" alt="这里写图片描述" title=""></p> 
<hr> 
<h3 id="password-reset-tokens">Password Reset Tokens</h3> 
<ul><li>在使用 send_password_reset_email() 之前，我们需要找到生成 password reset link （即邮件中用于重置密码的 link） 的方法。当 user 点击此 link 后，可跳转到 password reset 页面，进行重置。</li><li><p>为保证这个 password reset link 的有效性，我们要在发送邮件时，加上 token。</p> 
  <blockquote> 
   <p>The tricky part of this plan is to make sure that only valid reset links can be used to reset an account’s password. </p> 
  </blockquote></li><li><p>这类 password reset links 会携带 token，必须 token 被验证后方能获得重置密码的权限。token 被验证，则证明 user 有 reset password request 时提交的 email 的账号权限，然后才能点击带有 token 的reset password link。</p> 
  <blockquote> 
   <p>The links are going to be provisioned with a token, and this token will be validated before allowing the password change, as proof that the user that requested the email has access to the email address on the account. </p> 
  </blockquote></li><li><p>常用的一种 token 是 JSON Web Token。用 JWT 的妙处是 self-contained，即可以完成自我验证，</p> 
  <blockquote> 
   <p>You can send a token to a user in an email, and when the user clicks the link that feeds the token back into the application, it can be verified on its own.</p> 
  </blockquote></li></ul> 
<p>JWT 的用法如下：</p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-prompt">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> jwt
<span class="hljs-prompt">&gt;&gt;&gt; </span>token = jwt.encode({<!-- --><span class="hljs-string">'a'</span>: <span class="hljs-string">'b'</span>}, <span class="hljs-string">'my-secret'</span>, algorithm=<span class="hljs-string">'HS256'</span>)
<span class="hljs-prompt">&gt;&gt;&gt; </span>token
<span class="hljs-string">b'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhIjoiYiJ9.dvOo58OBDHiuSHD4uW88nfJikhYAXc_sfUHq1mDi4G0'</span>
<span class="hljs-prompt">&gt;&gt;&gt; </span>jwt.decode(token, <span class="hljs-string">'my-secret'</span>, algorithms=[<span class="hljs-string">'HS256'</span>])
{<!-- --><span class="hljs-string">'a'</span>: <span class="hljs-string">'b'</span>}</code></pre> 
<ul><li>生成 <code>token = jwt.encode(payload_dict, secret_key, algorithm)</code>，生成的是 <strong>bytes sequence</strong></li><li>解码 <code>jwt.decode(token, secret_key, algorithms_dict)</code> <br> <br></li></ul> 
<p>1、 为 <strong>User</strong> 类添加 <strong>token</strong> 生成及验证 methods</p> 
<p><code>app / models.py</code>: <em>reset password token methods.</em></p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> jwt
<span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> app

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span><span class="hljs-params">(UserMixin, db.Model)</span>:</span>
    <span class="hljs-comment"># ...</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_reset_password_token</span><span class="hljs-params">(self, expires_in=<span class="hljs-number">600</span>)</span>:</span>
        <span class="hljs-keyword">return</span> jwt.encode(
            {<!-- --><span class="hljs-string">'reset_password'</span>: self.id, <span class="hljs-string">'exp'</span>: time() + expires_in},
            app.config[<span class="hljs-string">'SECRET_KEY'</span>], algorithm=<span class="hljs-string">'HS256'</span>).decode(<span class="hljs-string">'utf-8'</span>)

    <span class="hljs-decorator">@staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">verify_reset_password_token</span><span class="hljs-params">(token)</span>:</span>
        <span class="hljs-keyword">try</span>:
            id = jwt.decode(token, app.config[<span class="hljs-string">'SECRET_KEY'</span>],
                            algorithms=[<span class="hljs-string">'HS256'</span>])[<span class="hljs-string">'reset_password'</span>]
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">return</span> User.query.get(id)</code></pre> 
<ul><li><code>get_reset_password_token()</code> 的 <strong>payload_dict</strong> 中，利用 <strong>time()</strong> 设置 <strong>expiration</strong> 参数； 另一个元素为 <code>‘reset_password’: self.id</code>。</li><li><strong>secret_key</strong>，采用 <strong>app.config[‘SECRET_KEY’]</strong></li><li><code>jwt.encode()</code> 为 <strong>bytes sequence</strong>，用 <code>decode('utf-8')</code> 变成 <strong>string。</strong></li><li><code>verify_reset_password_token()</code> 为 <strong>static method</strong>，第一个参数不为 <strong>cls</strong> 或 <strong>self</strong>，像普通函数一样传参。</li><li><code>verify_reset_password_token()</code> 通过 <strong>jwt.decode()</strong> 获取 token 的 payload_dict，然后调取其中的 <strong>[‘reset_password’]</strong> 元素，即 <strong>self.id</strong>。</li><li>如果 id 不存在，则返回 None；如存在，则调取对应的 user。</li></ul> 
<p><br></p> 
<hr> 
<h3 id="sending-a-password-reset-email">Sending a Password Reset Email</h3> 
<p>token 的生成方法已构建，现在基于 <strong>send_mail()</strong> 封装发送 password reset email 的函数 <strong>send_password_reset_email()</strong> 。</p> 
<p><br> 1、构建路由 <strong>send_password_reset_email()</strong></p> 
<p><code>app / email.py</code>: <em>send_password_reset_email function.</em></p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> render_template
<span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> app

<span class="hljs-comment"># ...</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_password_reset_email</span><span class="hljs-params">(user)</span>:</span>
    token = user.get_reset_password_token()
    send_email(<span class="hljs-string">'[Microblog] Reset Your Password'</span>,
               sender=app.config[<span class="hljs-string">'ADMINS'</span>][<span class="hljs-number">0</span>],
               recipients=[user.email],
               text_body=render_template(<span class="hljs-string">'email/reset_password.txt'</span>,
                                         user=user, token=token),
               html_body=render_template(<span class="hljs-string">'email/reset_password.html'</span>,
                                         user=user, token=token))</code></pre> 
<ul><li>添加 <strong>token</strong> 的生成（利用 user 中的方法 <code>get_reset_password_token()</code>）</li><li>注意 <code>recipients_dict</code> 中 为 <strong>user.email</strong>， 即 <code>reset_password_request()</code> 中 根据 <strong>form</strong> 提交的 email 查到的 user （如有）的 email </li></ul> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-decorator">@app.route('/reset_password_request', methods=['GET', 'POST'])</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reset_password_request</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment">#...</span>
    form = ResetPasswordRequestForm()
    <span class="hljs-keyword">if</span> form.validate_on_submit():
        user = User.query.filter_by(email=form.email.data).first()
        <span class="hljs-keyword">if</span> user:
            send_password_reset_email(user)
    <span class="hljs-comment"># ...</span></code></pre> 
<ul><li><strong>text_body</strong> 和 <strong>html_body</strong>， 均采用了 <code>render_template</code>，注意 template 的位置为<code>app/template/email/</code>，并传入参数 <strong>user</strong> 和 <strong>token</strong>。</li></ul> 
<p><br></p> 
<p>2、构建模板 <strong>reset_password.txt</strong> 和 <strong>reset_password.html</strong></p> 
<p>2.1 <code>app / templates / email / reset_password.txt</code>: <em>text for password reset email.</em></p> 
<pre class="prettyprint"><code class=" hljs handlebars"><span class="xml">Dear </span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">user.username</span> }}</span><span class="xml">,

To reset your password click on the following link:

</span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">url</span>_<span class="hljs-variable">for</span>('<span class="hljs-variable">reset</span>_<span class="hljs-variable">password</span>', <span class="hljs-variable">token</span>=<span class="hljs-variable">token</span>, _<span class="hljs-variable">external</span>=<span class="hljs-variable">True</span>) }}</span><span class="xml">

If you have not requested a password reset simply ignore this message.

Sincerely,

The Microblog Team</span></code></pre> 
<p>注： when <code>_external=True</code> is passed as argument, complete URLs are generated.</p> 
<p><code>url_for('user', username='susan')</code> 生成 <code>/user/susan</code></p> 
<p><code>url_for('user', username='susan', _external=True)</code> 生成 <code>http://localhost:5000/user/susan</code> <br> <br></p> 
<p>2.2 <code>app / templates / email / reset_password.html</code>: <em>HTML for password reset email.</em></p> 
<pre class="prettyprint"><code class=" hljs handlebars"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>Dear </span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">user.username</span> }}</span><span class="xml">,<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>
    To reset your password
    <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"</span></span></span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">url</span>_<span class="hljs-variable">for</span>('<span class="hljs-variable">reset</span>_<span class="hljs-variable">password</span>', <span class="hljs-variable">token</span>=<span class="hljs-variable">token</span>, _<span class="hljs-variable">external</span>=<span class="hljs-variable">True</span>) }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-value">"</span>&gt;</span>
        click here
    <span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>.
<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>Alternatively, you can paste the following link in your browser's address bar:<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span></span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">url</span>_<span class="hljs-variable">for</span>('<span class="hljs-variable">reset</span>_<span class="hljs-variable">password</span>', <span class="hljs-variable">token</span>=<span class="hljs-variable">token</span>, _<span class="hljs-variable">external</span>=<span class="hljs-variable">True</span>) }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>If you have not requested a password reset simply ignore this message.<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>Sincerely,<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>The Microblog Team<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span></span></code></pre> 
<p><br></p> 
<p><img src="https://images2.imgbox.com/9b/80/kKQa9PZX_o.png" alt="这里写图片描述" title=""></p> 
<hr> 
<h3 id="resetting-a-user-password">Resetting a User Password</h3> 
<p>收到邮件后，点击重置链接，跳转至 reset_password 页面，进行 重置。</p> 
<p>1、<code>app / routes.py</code>: <em>password reset view function.</em></p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-keyword">from</span> app.forms <span class="hljs-keyword">import</span> ResetPasswordForm

<span class="hljs-decorator">@app.route('/reset_password/&lt;token&gt;', methods=['GET', 'POST'])</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reset_password</span><span class="hljs-params">(token)</span>:</span>
    <span class="hljs-keyword">if</span> current_user.is_authenticated:
        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">'index'</span>))
    user = User.verify_reset_password_token(token)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:
        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">'index'</span>))
    form = ResetPasswordForm()
    <span class="hljs-keyword">if</span> form.validate_on_submit():
        user.set_password(form.password.data)
        db.session.commit()
        flash(<span class="hljs-string">'Your password has been reset.'</span>)
        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">'login'</span>))
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'reset_password.html'</span>, form=form)</code></pre> 
<ul><li>利用 <strong>User</strong> 的 <strong>staticmethod</strong> <code>verify_reset_password_token()</code> 验证 token。</li><li>如 token 为 False，证明 links 非真（或expires失效），user 为 None，则直接定向至 index；如 True，则 user 存在（即为发送 request 时提交的 email 对应的 user）。</li><li>初次 <strong>GET</strong> 请求，或表单填写有误，则向 browser 发送 空白 form。</li><li>利用表单，重置 password，写入 db，最终定向至 login 页面，用于 user 用新密码登录。 <br> <br></li></ul> 
<p>点击链接，返回密码重置页面 <br> <img src="https://images2.imgbox.com/11/d2/4MrRiAIc_o.png" alt="这里写图片描述" title=""></p> 
<p><br> 密码重置成功，返回 login 页面（如下）， <br> <img src="https://images2.imgbox.com/b9/7b/jfOJJbnx_o.png" alt="这里写图片描述" title=""></p> 
<p><br> 用重置密码登录 <br> <img src="https://images2.imgbox.com/92/0c/M7zBqC2l_o.png" alt="这里写图片描述" title=""> <br> <br></p> 
<p>2、表单构建 <strong>ResetPasswordForm</strong></p> 
<p><code>app / forms.py</code>: <em>password reset form.</em></p> 
<pre class="prettyprint"><code class=" hljs haskell"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">ResetPasswordForm</span><span class="hljs-container">(<span class="hljs-type">FlaskForm</span>)</span>:
    password = <span class="hljs-type">PasswordField</span><span class="hljs-container">('<span class="hljs-type">Password</span>', <span class="hljs-title">validators</span>=[<span class="hljs-type">DataRequired</span>()</span>])
    password2 = <span class="hljs-type">PasswordField</span><span class="hljs-container">(
        '<span class="hljs-type">Repeat</span> <span class="hljs-type">Password</span>', <span class="hljs-title">validators</span>=[<span class="hljs-type">DataRequired</span>()</span>, <span class="hljs-type">EqualTo</span><span class="hljs-container">('<span class="hljs-title">password'</span>)</span>])
    submit = <span class="hljs-type">SubmitField</span><span class="hljs-container">('<span class="hljs-type">Request</span> <span class="hljs-type">Password</span> <span class="hljs-type">Reset</span>')</span>
</span></code></pre> 
<p><br></p> 
<p>3、模板构建 <strong>reset_password.html</strong> （注：与 app/templates/email 中的 模板同名）</p> 
<p><code>app / templates / reset_password.html</code>: <em>password reset form template.</em></p> 
<pre class="prettyprint"><code class=" hljs django"><span class="xml"></span><span class="hljs-template_tag">{% <span class="hljs-keyword">extends</span> "base.html" %}</span><span class="xml">

</span><span class="hljs-template_tag">{% <span class="hljs-keyword">block</span> content %}</span><span class="xml">
    <span class="hljs-tag">&lt;<span class="hljs-title">h1</span>&gt;</span>Reset Your Password<span class="hljs-tag">&lt;/<span class="hljs-title">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">action</span>=<span class="hljs-value">""</span> <span class="hljs-attribute">method</span>=<span class="hljs-value">"post"</span>&gt;</span>
        </span><span class="hljs-variable">{<!-- -->{ form.hidden_tag() }}</span><span class="xml">
        <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>
            </span><span class="hljs-variable">{<!-- -->{ form.password.label }}</span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span>
            </span><span class="hljs-variable">{<!-- -->{ form.password(size=32) }}</span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span>
            </span><span class="hljs-template_tag">{% <span class="hljs-keyword">for</span> error <span class="hljs-keyword">in</span> form.password.errors %}</span><span class="xml">
            <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">"color: red;"</span>&gt;</span>[</span><span class="hljs-variable">{<!-- -->{ error }}</span><span class="xml">]<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
            </span><span class="hljs-template_tag">{% <span class="hljs-keyword">endfor</span> %}</span><span class="xml">
        <span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>
            </span><span class="hljs-variable">{<!-- -->{ form.password2.label }}</span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span>
            </span><span class="hljs-variable">{<!-- -->{ form.password2(size=32) }}</span><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span>
            </span><span class="hljs-template_tag">{% <span class="hljs-keyword">for</span> error <span class="hljs-keyword">in</span> form.password2.errors %}</span><span class="xml">
            <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">"color: red;"</span>&gt;</span>[</span><span class="hljs-variable">{<!-- -->{ error }}</span><span class="xml">]<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
            </span><span class="hljs-template_tag">{% <span class="hljs-keyword">endfor</span> %}</span><span class="xml">
        <span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span></span><span class="hljs-variable">{<!-- -->{ form.submit() }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
</span><span class="hljs-template_tag">{% <span class="hljs-keyword">endblock</span> %}</span><span class="xml"></span></code></pre> 
<p><br></p> 
<hr> 
<h3 id="asynchronous-emails">Asynchronous Emails</h3> 
<p>send_email() 为同步函数，导致封装后的 send_password_reset_email() 也为同步。 <br> 为提高处理速度，采用并发处理，并发可以用 multiprocessing 或者 threading。 <br> 考虑到 multiprocessing 的 more resource intensive，采用 threading。</p> 
<p>app/email.py: Send emails asynchronously.</p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-keyword">from</span> threading <span class="hljs-keyword">import</span> Thread
<span class="hljs-comment"># ...</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_async_email</span><span class="hljs-params">(app, msg)</span>:</span>
    <span class="hljs-keyword">with</span> app.app_context():
        mail.send(msg)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_email</span><span class="hljs-params">(subject, sender, recipients, text_body, html_body)</span>:</span>
    msg = Message(subject, sender=sender, recipients=recipients)
    msg.body = text_body
    msg.html = html_body
    Thread(target=send_async_email, args=(app, msg)).start()</code></pre> 
<ul><li><code>send_async_email()</code> 利用 app.app_context()，生成 <strong>application context</strong> （另一类为 <strong>request contenxt</strong>）。</li><li>application context 可以利用 Flask 的变量 current_app 使得 application instance 变得 accessible。 </li><li><code>send_email()</code> 最后创建了 一个 Thread，其中 target 即是 <code>send_async_email</code>，传入的 args 即为 target func 需要的 (app, msg)，最后启动线程 <code>Thread().start()</code>。</li></ul> 
<p><br></p> 
<p>1、当我们调用 <code>send_password_reset_email()</code> 时，会调用封装其中的 send_email()，进而启动一个Thread，最终调用的 send_async_email 就会在这个 background thread 中运行。</p> 
<p>2、注意，<strong>Thread</strong> 中传递的参数不止 <strong><code>msg</code></strong>，还有 <strong><code>app</code></strong>。</p> 
<p>3、在 Flask 中涉及 threads 时，必须记住，Flask 用 contexts 来避免在跨函数传参。 <br> 有两类 contexts，即 application context 和 request context。 <br> 通常情况下，这些 contexts 由 framework 自动管理；但是，当 application 启动 自定义 threads 时，这类threads 所需的 contexts 必须手动创建。</p> 
<blockquote> 
 <p>When working with threads there is an important design aspect of Flask that needs to be kept in mind. Flask uses contexts to avoid having to pass arguments across functions. I’m not going to go into a lot of detail on this, but know that there are two types of contexts, the application context and the request context. In most cases, these contexts are automatically managed by the framework, but when the application starts custom threads, contexts for those threads may need to be manually created.</p> 
</blockquote> 
<p>4、很多 extensions 需要 application instance，因为它们的配置多放在 app.config 中。Flask-Mail 正属于此种情形，send_email() 中的 mail.send() 必须 access 到 app.config 中的 mail server，方能发送邮件，所以必须知道 application instance。</p> 
<p>5、通过 <code>with app.app_context()</code>，可创建 <strong>application context</strong>； 这个 application context 即可使 application instance 变得 accessible（通过 <strong>Flask</strong> 的变量 <strong>current_app</strong>）。这样，<code>send_async_email()</code> 中的 <code>mail.send()</code> 即可access 到 <strong>application instance</strong>，进而拿到 <strong>app.config</strong> 中的 <strong>mail server</strong> 信息。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c304f1675813906aaae9e25120279c71/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Qt中PushButton的pressed,released,clicked三种响应的区别</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/58c6773b4d95cad9eb14992df3fa07c7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">NumPy数组（9）-- 将NumPy数组转换为Python列表</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>