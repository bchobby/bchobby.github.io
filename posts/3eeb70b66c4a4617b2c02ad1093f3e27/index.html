<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>注册中心 Eureka 源码解析 —— 应用实例注册发现 （二）之续租 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="注册中心 Eureka 源码解析 —— 应用实例注册发现 （二）之续租" />
<meta property="og:description" content="点击上方“芋道源码”，选择“置顶公众号”
技术文章第一时间送达！
源码精品专栏
中文详细注释的开源项目
Java 并发源码合集
RocketMQ 源码合集
Sharding-JDBC 源码解析合集
Spring MVC 和 Security 源码合集
MyCAT 源码解析合集
本文主要基于 Eureka 1.8.X 版本
1. 概述
2. Eureka-Client 发起续租
2.1 初始化定时任务
2.2 HeartbeatThread
2.3 TimedSupervisorTask
3. Eureka-Server 接收续租
3.1 接收续租请求
3.2 续租应用实例信息
666. 彩蛋
1. 概述 本文主要分享 Eureka-Client 向 Eureka-Server 续租应用实例的过程。
FROM 《深度剖析服务发现组件Netflix Eureka》 二次编辑 蓝框部分，为本文重点。
非蓝框部分，Eureka-Server 集群间复制注册的应用实例信息，不在本文内容范畴。
推荐 Spring Cloud 书籍：
请支持正版。下载盗版，等于主动编写低级 BUG 。
程序猿DD —— 《Spring Cloud微服务实战》
周立 —— 《Spring Cloud与Docker微服务架构实战》" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/3eeb70b66c4a4617b2c02ad1093f3e27/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-04-27T00:00:00+08:00" />
<meta property="article:modified_time" content="2018-04-27T00:00:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">注册中心 Eureka 源码解析 —— 应用实例注册发现 （二）之续租</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="rich_media_content"> 
 <p style="clear:both;min-height:1em;font-size:16px;text-align:center;"><span style="color:rgb(127,127,127);font-size:14px;line-height:1.75em;">点击上方“</span><span style="font-size:14px;line-height:1.75em;"><span style="color:#00b0f0;">芋道源码</span></span><span style="color:rgb(127,127,127);font-size:14px;line-height:1.75em;">”，选择“置顶公众号”</span></p> 
 <p style="clear:both;min-height:1em;color:rgb(62,62,62);font-size:16px;text-align:center;"><span style="color:rgb(127,127,127);font-size:14px;">技术文章第一时间送达！</span></p> 
 <span style="margin:0px;padding:.3em .5em;max-width:100%;font-size:13px;color:rgb(255,255,255);background-color:rgb(95,156,239);"></span> 
 <p style="margin:0px;padding:0px;max-width:100%;clear:both;min-height:1em;">源码精品专栏</p>  
 <ul class="list-paddingleft-2" style="list-style-type:circle;margin-left:0px;margin-right:0px;"><li><p style="margin:0px;padding:0px;max-width:100%;clear:both;min-height:1em;"><strong style="margin:0px;padding:0px;max-width:100%;">中文详细注释的开源项目</strong><br style="margin:0px;padding:0px;max-width:100%;"></p></li><li><p style="margin:0px;padding:0px;max-width:100%;clear:both;min-height:1em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:16px;"><strong style="margin:0px;padding:0px;max-width:100%;"><span style="margin:0px;padding:0px;max-width:100%;text-decoration:underline;"><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247484341&amp;idx=1&amp;sn=91d6fc7e8841a0f6046e1c2f4693a537&amp;chksm=fa497c04cd3ef512f9249a5deb305a28b68d3ba44467f13fa8c6068711540b2f3e0a6f622ae3&amp;scene=21#wechat_redirect" rel="nofollow" style="margin:0px;padding:0px;color:rgb(96,127,166);text-decoration:none;max-width:100%;">Java 并发源码合集</a></span></strong></span></p></li><li><p style="margin:0px;padding:0px;max-width:100%;clear:both;min-height:1em;"><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247484334&amp;idx=1&amp;sn=761e2659f474f06e7db935eae26e2b03&amp;chksm=fa497c1fcd3ef509a02890b8e9f6bddb02e714f9c7e70cfbc37cd5bd75be64855225497fd3de&amp;scene=21#wechat_redirect" rel="nofollow" style="margin:0px;padding:0px;color:rgb(96,127,166);text-decoration:underline;max-width:100%;font-size:16px;"><strong style="margin:0px;padding:0px;max-width:100%;">RocketMQ 源码合集</strong></a></p></li><li><p style="margin:0px;padding:0px;max-width:100%;clear:both;min-height:1em;"><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247484360&amp;idx=1&amp;sn=0dae84944d2c388fdc1bbed868ac5b99&amp;chksm=fa497c79cd3ef56f8487dda6d53e3772e0aa9812ee66376993c3445bc94920c01a03dd4a4b8f&amp;scene=21#wechat_redirect" rel="nofollow" style="margin:0px;padding:0px;color:rgb(96,127,166);text-decoration:underline;max-width:100%;font-size:16px;"><strong style="margin:0px;padding:0px;max-width:100%;">Sharding-JDBC 源码解析合集</strong></a></p></li><li><p style="margin:0px;padding:0px;max-width:100%;clear:both;min-height:1em;"><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247484380&amp;idx=1&amp;sn=b4e0da1a314d77dcd170a25ed1ebb4c5&amp;chksm=fa497c6dcd3ef57bcfb69a52c594bcb72e35d9bbe89fa87601b2a6c9f266d656b1ad2a5d4da4&amp;scene=21#wechat_redirect" rel="nofollow" style="margin:0px;padding:0px;color:rgb(96,127,166);text-decoration:underline;max-width:100%;font-size:16px;"><strong style="margin:0px;padding:0px;max-width:100%;">Spring MVC 和 Security 源码合集</strong></a><br style="margin:0px;padding:0px;max-width:100%;"></p></li><li><p style="margin:0px;padding:0px;max-width:100%;clear:both;min-height:1em;"><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247484377&amp;idx=3&amp;sn=1323ac1a4099fac49c96686e58d1960d&amp;chksm=fa497c68cd3ef57e5c3b683f9ead89f06ea5d01947672bfff8341cff2ab0c39c03274723c49a&amp;scene=21#wechat_redirect" rel="nofollow" style="margin:0px;padding:0px;color:rgb(96,127,166);text-decoration:underline;max-width:100%;font-size:16px;"><strong style="margin:0px;padding:0px;max-width:100%;">MyCAT 源码解析合集</strong></a></p></li></ul> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">本文主要基于 Eureka 1.8.X 版本</strong></p> 
 <ul class="list-paddingleft-2"><li><p>1. 概述</p></li><li><p>2. Eureka-Client 发起续租</p></li><li><p>2.1 初始化定时任务</p></li><li><p>2.2 HeartbeatThread</p></li><li><p>2.3 TimedSupervisorTask</p></li><li><p>3. Eureka-Server 接收续租</p></li><li><p>3.1 接收续租请求</p></li><li><p>3.2 续租应用实例信息</p></li><li><p>666. 彩蛋</p></li></ul> 
 <hr style="margin:20px;border-top:3px solid rgb(165,165,165);border-right:none;border-left:none;border-bottom-style:solid;border-bottom-color:rgb(207,207,207);height:8px;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"> 
 <h2 style="margin-top:1.6em;margin-bottom:1.6em;font-weight:bold;font-size:1.6em;color:rgb(62,62,62);line-height:inherit;border-top:2px solid rgb(3,155,229);letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><span style="margin-right:2px;margin-left:5px;padding-top:3px;padding-right:10px;padding-left:10px;font-size:inherit;color:rgb(255,255,255);line-height:inherit;font-weight:normal;background:rgb(3,155,229);border-bottom:2px solid rgb(0,96,100);border-right:3px solid rgb(0,96,100);">1. 概述</span></h2> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);">本文主要分享 <strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">Eureka-Client 向 Eureka-Server 续租应用实例的过程</strong>。</p> 
 <blockquote style="margin-top:1em;margin-bottom:1em;padding:15px 15px 15px;border-left-width:5px;border-left-color:rgb(239,112,96);font-size:.9em;line-height:inherit;background:rgb(239,235,233);letter-spacing:2px;white-space:normal;word-spacing:2px;"> 
  <p style="font-size:inherit;color:inherit;line-height:inherit;">FROM 《深度剖析服务发现组件Netflix Eureka》 二次编辑 <br style="font-size:inherit;color:inherit;line-height:inherit;"></p> 
  <img class="img_loading" style="margin-right:auto;margin-left:auto;border:2px solid rgb(238,238,238);font-size:inherit;color:inherit;line-height:inherit;width:634px;height:264.3640256959315px;" title="" src="https://images2.imgbox.com/1c/fa/PIEWyEWW_o.png" alt="640?wx_fmt=jpeg"> 
 </blockquote> 
 <ul class="list-paddingleft-2"><li><p><strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">蓝框</strong>部分，为本文重点。</p></li><li><p>非<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">蓝框</strong>部分，Eureka-Server 集群间复制注册的应用实例信息，不在本文内容范畴。</p></li></ul> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">推荐 Spring Cloud 书籍</strong>：</p> 
 <ul class="list-paddingleft-2"><li><p>请支持正版。下载盗版，<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">等于主动编写低级 BUG</strong> 。</p></li><li><p>程序猿DD —— 《Spring Cloud微服务实战》</p></li><li><p>周立 —— 《Spring Cloud与Docker微服务架构实战》</p></li></ul> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">推荐 Spring Cloud 视频</strong>：</p> 
 <ul class="list-paddingleft-2"><li><p>Java 微服务实践 - Spring Boot</p></li><li><p>Java 微服务实践 - Spring Cloud</p></li><li><p>Java 微服务实践 - Spring Boot / Spring Cloud</p></li></ul> 
 <h2 style="margin-top:1.6em;margin-bottom:1.6em;font-weight:bold;font-size:1.6em;color:rgb(62,62,62);line-height:inherit;border-top:2px solid rgb(3,155,229);letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><span style="margin-right:2px;margin-left:5px;padding-top:3px;padding-right:10px;padding-left:10px;font-size:inherit;color:rgb(255,255,255);line-height:inherit;font-weight:normal;background:rgb(3,155,229);border-bottom:2px solid rgb(0,96,100);border-right:3px solid rgb(0,96,100);">2. Eureka-Client 发起续租</span></h2> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);">Eureka-Client 向 Eureka-Server 发起注册应用实例成功后获得租约 ( Lease )。<br style="font-size:inherit;color:inherit;line-height:inherit;">Eureka-Client <strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">固定间隔</strong>向 Eureka-Server 发起<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">续租</strong>( renew )，避免租约过期。</p> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);">默认情况下，租约有效期为 90 秒，续租频率为 30 秒。两者比例为 1 : 3 ，保证在网络异常等情况下，有三次重试的机会。</p> 
 <h3 style="margin-top:1.6em;margin-bottom:1.6em;font-weight:bold;font-size:1.4em;color:rgb(62,62,62);line-height:inherit;border-bottom:2px solid rgb(0,172,193);letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><span style="margin-right:2px;padding-top:3px;padding-right:10px;padding-left:10px;font-size:inherit;color:rgb(255,255,255);line-height:inherit;font-weight:normal;background:rgb(0,172,193);">2.1 初始化定时任务</span></h3> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);">Eureka-Client 在初始化过程中，创建<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">心跳</strong>线程，<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">固定间隔</strong>向 Eureka-Server 发起<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">续租</strong>( renew )。实现代码如下：</p> 
 <pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;word-spacing:2px;background-color:rgb(255,255,255);"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// DiscoveryClient.java</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">DiscoveryClient(ApplicationInfoManager applicationInfoManager, EurekaClientConfig config, AbstractDiscoveryClientOptionalArgs args,<br style="font-size:inherit;color:inherit;line-height:inherit;">               Provider&lt;BackupRegistry&gt; backupRegistryProvider) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// ... 省略无关代码</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    scheduler = Executors.newScheduledThreadPool(<span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">2</span>,<br style="font-size:inherit;color:inherit;line-height:inherit;">               <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">new</span> ThreadFactoryBuilder()<br style="font-size:inherit;color:inherit;line-height:inherit;">                       .setNameFormat(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"DiscoveryClient-%d"</span>)<br style="font-size:inherit;color:inherit;line-height:inherit;">                       .setDaemon(<span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">true</span>)<br style="font-size:inherit;color:inherit;line-height:inherit;">                       .build());<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">    heartbeatExecutor = <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">new</span> ThreadPoolExecutor(<br style="font-size:inherit;color:inherit;line-height:inherit;">              <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">1</span>, clientConfig.getHeartbeatExecutorThreadPoolSize(), <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">0</span>, TimeUnit.SECONDS,<br style="font-size:inherit;color:inherit;line-height:inherit;">              <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">new</span> SynchronousQueue&lt;Runnable&gt;(),<br style="font-size:inherit;color:inherit;line-height:inherit;">              <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">new</span> ThreadFactoryBuilder()<br style="font-size:inherit;color:inherit;line-height:inherit;">                      .setNameFormat(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"DiscoveryClient-HeartbeatExecutor-%d"</span>)<br style="font-size:inherit;color:inherit;line-height:inherit;">                      .setDaemon(<span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">true</span>)<br style="font-size:inherit;color:inherit;line-height:inherit;">                      .build()<br style="font-size:inherit;color:inherit;line-height:inherit;">    );  <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// use direct handoff</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// ... 省略无关代码</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 【3.2.14】初始化定时任务</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    initScheduledTasks();<br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-function" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">void</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">initScheduledTasks</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">()</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 向 Eureka-Server 心跳（续租）执行器</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (clientConfig.shouldRegisterWithEureka()) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">        <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">int</span> renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs(); <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 续租频率</span><br style="font-size:inherit;color:inherit;line-height:inherit;">        <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">int</span> expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound(); <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">//</span><br style="font-size:inherit;color:inherit;line-height:inherit;">        logger.info(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"Starting heartbeat executor: "</span> + <span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"renew interval is: "</span> + renewalIntervalInSecs);<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">        <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// Heartbeat timer</span><br style="font-size:inherit;color:inherit;line-height:inherit;">        scheduler.schedule(<br style="font-size:inherit;color:inherit;line-height:inherit;">               <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">new</span> TimedSupervisorTask(<br style="font-size:inherit;color:inherit;line-height:inherit;">                       <span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"heartbeat"</span>,<br style="font-size:inherit;color:inherit;line-height:inherit;">                       scheduler,<br style="font-size:inherit;color:inherit;line-height:inherit;">                       heartbeatExecutor,<br style="font-size:inherit;color:inherit;line-height:inherit;">                       renewalIntervalInSecs,<br style="font-size:inherit;color:inherit;line-height:inherit;">                       TimeUnit.SECONDS,<br style="font-size:inherit;color:inherit;line-height:inherit;">                       expBackOffBound,<br style="font-size:inherit;color:inherit;line-height:inherit;">                       <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">new</span> HeartbeatThread()<br style="font-size:inherit;color:inherit;line-height:inherit;">               ),<br style="font-size:inherit;color:inherit;line-height:inherit;">               renewalIntervalInSecs, TimeUnit.SECONDS);<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">          <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// ... 省略无关代码</span><br style="font-size:inherit;color:inherit;line-height:inherit;">     }<br style="font-size:inherit;color:inherit;line-height:inherit;">     <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// ... 省略无关代码</span><br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"></code></pre> 
 <ul class="list-paddingleft-2"><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">scheduler</code>，定时任务服务，用于定时触发心跳( 续租 )。细心如你，会发现任务提交的方式是 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">ScheduledExecutorService#schedule(...)</code> 方法，<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">只延迟执行一次心跳，说好的固定频率执行心跳呢</strong>！！！答案在 「2.3 TimedSupervisorTask」 揭晓。</p></li><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">heartbeatExecutor</code>，心跳任务执行线程池。为什么有 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">scheduler</code> 的情况下，还有 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">heartbeatExecutor</code> ？？？答案也在 「2.3 TimedSupervisorTask」 揭晓。</p></li><li><p>HeartbeatThread，心跳线程，在「2.2 TimedSupervisorTask」 详细解析。</p></li></ul> 
 <h3 style="margin-top:1.6em;margin-bottom:1.6em;font-weight:bold;font-size:1.4em;color:rgb(62,62,62);line-height:inherit;border-bottom:2px solid rgb(0,172,193);letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><span style="margin-right:2px;padding-top:3px;padding-right:10px;padding-left:10px;font-size:inherit;color:rgb(255,255,255);line-height:inherit;font-weight:normal;background:rgb(0,172,193);">2.2 HeartbeatThread</span></h3> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">com.netflix.discovery.DiscoveryClient.HeartbeatThread</code>，心跳线程，<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">实现</strong>执行 Eureka-Client 向 Eureka-Server 发起<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">续租</strong>( renew )请求。实现代码如下：</p> 
 <pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;word-spacing:2px;background-color:rgb(255,255,255);"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// DiscoveryClient.java</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;">* 最后成功向 Eureka-Server 心跳时间戳<br style="font-size:inherit;color:inherit;line-height:inherit;">*/</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">volatile</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">long</span> lastSuccessfulHeartbeatTimestamp = -<span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">1</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-class" style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">class</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">HeartbeatThread</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">implements</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">Runnable</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">   <span class="hljs-function" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">void</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">run</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">()</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">       <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (renew()) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">           lastSuccessfulHeartbeatTimestamp = System.currentTimeMillis();<br style="font-size:inherit;color:inherit;line-height:inherit;">       }<br style="font-size:inherit;color:inherit;line-height:inherit;">   }<br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"></code></pre> 
 <ul class="list-paddingleft-2"><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">调用 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">#renew</code> 方法，执行续租逻辑。实现代码如下：</p><pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:inherit;color:inherit;line-height:inherit;"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// DiscoveryClient.java</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-function" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">boolean</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">renew</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">()</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">   EurekaHttpResponse&lt;InstanceInfo&gt; httpResponse;<br style="font-size:inherit;color:inherit;line-height:inherit;">   <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">try</span> {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">       httpResponse = eurekaTransport.registrationClient.sendHeartBeat(instanceInfo.getAppName(), instanceInfo.getId(), instanceInfo, <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>);<br style="font-size:inherit;color:inherit;line-height:inherit;">       logger.debug(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"{} - Heartbeat status: {}"</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());<br style="font-size:inherit;color:inherit;line-height:inherit;">       <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (httpResponse.getStatusCode() == <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">404</span>) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">           REREGISTER_COUNTER.increment();<br style="font-size:inherit;color:inherit;line-height:inherit;">           logger.info(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"{} - Re-registering apps/{}"</span>, PREFIX + appPathIdentifier, instanceInfo.getAppName());<br style="font-size:inherit;color:inherit;line-height:inherit;">           <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">long</span> timestamp = instanceInfo.setIsDirtyWithTime();<br style="font-size:inherit;color:inherit;line-height:inherit;">           <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 发起注册</span><br style="font-size:inherit;color:inherit;line-height:inherit;">           <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">boolean</span> success = register();<br style="font-size:inherit;color:inherit;line-height:inherit;">           <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (success) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">               instanceInfo.unsetIsDirty(timestamp);<br style="font-size:inherit;color:inherit;line-height:inherit;">           }<br style="font-size:inherit;color:inherit;line-height:inherit;">           <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> success;<br style="font-size:inherit;color:inherit;line-height:inherit;">       }<br style="font-size:inherit;color:inherit;line-height:inherit;">       <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> httpResponse.getStatusCode() == <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">200</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;">   } <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">catch</span> (Throwable e) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">       logger.error(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"{} - was unable to send heartbeat!"</span>, PREFIX + appPathIdentifier, e);<br style="font-size:inherit;color:inherit;line-height:inherit;">       <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">false</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;">   }<br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"></code></pre> 
   <ul style="list-style-type:square;" class="list-paddingleft-2"><li><p>PUT 请求 Eureka-Server 的 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">apps/${APP_NAME}/${INSTANCE_INFO_ID}</code> 接口，参数为 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">status</code>、<code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">lastDirtyTimestamp</code>、<code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">overriddenstatus</code>，实现续租。</p></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">调用 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">AbstractJerseyEurekaHttpClient#sendHeartBeat(...)</code> 方法，发起<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">续租请求</strong>，实现代码如下：</p><pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:inherit;color:inherit;line-height:inherit;"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// AbstractJerseyEurekaHttpClient.java</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-meta" style="font-size:inherit;color:rgb(91,218,237);line-height:inherit;">@Override</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-function" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> EurekaHttpResponse&lt;InstanceInfo&gt; <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">sendHeartBeat</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">(String appName, String id, InstanceInfo info, InstanceStatus overriddenStatus)</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">   String urlPath = <span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"apps/"</span> + appName + <span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">'/'</span> + id;<br style="font-size:inherit;color:inherit;line-height:inherit;">   ClientResponse response = <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;">   <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">try</span> {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">       WebResource webResource = jerseyClient.resource(serviceUrl)<br style="font-size:inherit;color:inherit;line-height:inherit;">               .path(urlPath)<br style="font-size:inherit;color:inherit;line-height:inherit;">               .queryParam(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"status"</span>, info.getStatus().toString())<br style="font-size:inherit;color:inherit;line-height:inherit;">               .queryParam(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"lastDirtyTimestamp"</span>, info.getLastDirtyTimestamp().toString());<br style="font-size:inherit;color:inherit;line-height:inherit;">       <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (overriddenStatus != <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">           webResource = webResource.queryParam(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"overriddenstatus"</span>, overriddenStatus.name());<br style="font-size:inherit;color:inherit;line-height:inherit;">       }<br style="font-size:inherit;color:inherit;line-height:inherit;">       Builder requestBuilder = webResource.getRequestBuilder();<br style="font-size:inherit;color:inherit;line-height:inherit;">       addExtraHeaders(requestBuilder);<br style="font-size:inherit;color:inherit;line-height:inherit;">       response = requestBuilder.put(ClientResponse.class);<br style="font-size:inherit;color:inherit;line-height:inherit;">       EurekaHttpResponseBuilder&lt;InstanceInfo&gt; eurekaResponseBuilder = anEurekaHttpResponse(response.getStatus(), InstanceInfo.class).headers(headersOf(response));<br style="font-size:inherit;color:inherit;line-height:inherit;">       <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (response.hasEntity()) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">           eurekaResponseBuilder.entity(response.getEntity(InstanceInfo.class));<br style="font-size:inherit;color:inherit;line-height:inherit;">       }<br style="font-size:inherit;color:inherit;line-height:inherit;">       <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> eurekaResponseBuilder.build();<br style="font-size:inherit;color:inherit;line-height:inherit;">   } <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">finally</span> {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">       <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (logger.isDebugEnabled()) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">           logger.debug(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"Jersey HTTP PUT {}/{}; statusCode={}"</span>, serviceUrl, urlPath, response == <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span> ? <span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"N/A"</span> : response.getStatus());<br style="font-size:inherit;color:inherit;line-height:inherit;">       }<br style="font-size:inherit;color:inherit;line-height:inherit;">       <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (response != <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">           response.close();<br style="font-size:inherit;color:inherit;line-height:inherit;">       }<br style="font-size:inherit;color:inherit;line-height:inherit;">   }<br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"></code></pre></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">调用 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">AbstractJerseyEurekaHttpClient#register(...)</code> 方法，当 Eureka-Server <strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">不存在租约</strong>时，重新发起注册，在《Eureka 源码解析 —— 应用实例注册发现 （一）之注册》有详细解析。</p></li></ul></li></ul> 
 <h3 style="margin-top:1.6em;margin-bottom:1.6em;font-weight:bold;font-size:1.4em;color:rgb(62,62,62);line-height:inherit;border-bottom:2px solid rgb(0,172,193);letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><span style="margin-right:2px;padding-top:3px;padding-right:10px;padding-left:10px;font-size:inherit;color:rgb(255,255,255);line-height:inherit;font-weight:normal;background:rgb(0,172,193);">2.3 TimedSupervisorTask</span></h3> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">com.netflix.discovery.TimedSupervisorTask</code>，监管<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">定时任务</strong>的任务。</p> 
 <blockquote style="margin-top:1em;margin-bottom:1em;padding:15px 15px 15px;border-left-width:5px;border-left-color:rgb(239,112,96);font-size:.9em;line-height:inherit;background:rgb(239,235,233);letter-spacing:2px;white-space:normal;word-spacing:2px;"> 
  <p style="font-size:inherit;color:inherit;line-height:inherit;">A supervisor task that schedules subtasks while enforce a timeout.</p> 
 </blockquote> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);">创建 TimedSupervisorTask 代码如下：</p> 
 <pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;word-spacing:2px;background-color:rgb(255,255,255);"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;"><span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">public</span> <span class="hljs-class" style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">class</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">TimedSupervisorTask</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">extends</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">TimerTask</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> Counter timeoutCounter;<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> Counter rejectedCounter;<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> Counter throwableCounter;<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> LongGauge threadPoolLevelGauge;<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;">     * 定时任务服务<br style="font-size:inherit;color:inherit;line-height:inherit;">     */</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> ScheduledExecutorService scheduler;<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;">     * 执行子任务线程池<br style="font-size:inherit;color:inherit;line-height:inherit;">     */</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> ThreadPoolExecutor executor;<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;">     * 子任务执行超时时间<br style="font-size:inherit;color:inherit;line-height:inherit;">     */</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">long</span> timeoutMillis;<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;">     * 子任务<br style="font-size:inherit;color:inherit;line-height:inherit;">     */</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> Runnable task;<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;">     * 当前任子务执行频率<br style="font-size:inherit;color:inherit;line-height:inherit;">     */</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> AtomicLong delay;<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;">     * 最大子任务执行频率<br style="font-size:inherit;color:inherit;line-height:inherit;">     *<br style="font-size:inherit;color:inherit;line-height:inherit;">     * 子任务执行超时情况下使用<br style="font-size:inherit;color:inherit;line-height:inherit;">     */</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">long</span> maxDelay;<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-function" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">TimedSupervisorTask</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">(String name, ScheduledExecutorService scheduler, ThreadPoolExecutor executor,<br style="font-size:inherit;color:inherit;line-height:inherit;">                               <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">int</span> timeout, TimeUnit timeUnit, <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">int</span> expBackOffBound, Runnable task)</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">        <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">this</span>.scheduler = scheduler;<br style="font-size:inherit;color:inherit;line-height:inherit;">        <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">this</span>.executor = executor;<br style="font-size:inherit;color:inherit;line-height:inherit;">        <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">this</span>.timeoutMillis = timeUnit.toMillis(timeout);<br style="font-size:inherit;color:inherit;line-height:inherit;">        <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">this</span>.task = task;<br style="font-size:inherit;color:inherit;line-height:inherit;">        <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">this</span>.delay = <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">new</span> AtomicLong(timeoutMillis);<br style="font-size:inherit;color:inherit;line-height:inherit;">        <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">this</span>.maxDelay = timeoutMillis * expBackOffBound;<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">        <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// Initialize the counters and register.</span><br style="font-size:inherit;color:inherit;line-height:inherit;">        timeoutCounter = Monitors.newCounter(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"timeouts"</span>);<br style="font-size:inherit;color:inherit;line-height:inherit;">        rejectedCounter = Monitors.newCounter(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"rejectedExecutions"</span>);<br style="font-size:inherit;color:inherit;line-height:inherit;">        throwableCounter = Monitors.newCounter(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"throwables"</span>);<br style="font-size:inherit;color:inherit;line-height:inherit;">        threadPoolLevelGauge = <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">new</span> LongGauge(MonitorConfig.builder(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"threadPoolUsed"</span>).build());<br style="font-size:inherit;color:inherit;line-height:inherit;">        Monitors.registerObject(name, <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">this</span>);<br style="font-size:inherit;color:inherit;line-height:inherit;">    }<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"></code></pre> 
 <ul class="list-paddingleft-2"><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">scheduler</code> ，定时任务服务，用于定时【<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">发起</strong>】子任务。</p></li><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">executor</code> ，执行子任务线程池，用于【<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">提交</strong>】子任务执行。</p></li><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">task</code> ，子任务。</p></li><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">timeoutMillis</code> ，子任务执行超时时间，单位：毫秒。</p></li><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">delay</code> ，当前子任务执行频率，单位：毫秒。值等于 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">timeout</code> 参数。</p></li><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">maxDelay</code> ，<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">最大</strong>子任务执行频率，单位：毫秒。值等于 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">timeout * expBackOffBound</code> 参数。</p></li></ul> 
 <img class="img_loading" style="margin-right:auto;margin-left:auto;border:2px solid rgb(238,238,238);font-size:inherit;color:inherit;line-height:inherit;width:670px;height:259.8258642765685px;" title="" src="https://images2.imgbox.com/18/22/ms8Qqcgv_o.png" alt="640?wx_fmt=jpeg"> 
 <ul class="list-paddingleft-2"><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">scheduler</code> 初始化延迟执行 TimedSupervisorTask 。</p></li><li><p>TimedSupervisorTask 执行时，提交 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">task</code> 到 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">executor</code> 执行任务。</p> 
   <ul style="list-style-type:square;" class="list-paddingleft-2"><li><p>当 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">task</code> 执行正常，TimedSupervisorTask <strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">再次</strong>提交<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">自己</strong>到<code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">scheduler</code> 延迟 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">timeoutMillis</code> 执行。</p></li><li><p>当 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">task</code> 执行超时，重新计算延迟时间( 不允许超过 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">maxDelay</code> )，<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">再次</strong>提交<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">自己</strong>到<code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">scheduler</code> 延迟执行。</p></li></ul></li></ul> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);">实现代码如下：</p> 
 <pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;word-spacing:2px;background-color:rgb(255,255,255);"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// TimedSupervisorTask.java</span><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">1</span>: <span class="hljs-meta" style="font-size:inherit;color:rgb(91,218,237);line-height:inherit;">@Override</span><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">2</span>: <span class="hljs-function" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">void</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">run</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">()</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">3</span>:     Future&lt;?&gt; future = <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">4</span>:     <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">try</span> {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">5</span>:         <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 提交 任务</span><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">6</span>:         future = executor.submit(task);<br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">7</span>:         <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">//</span><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">8</span>:         threadPoolLevelGauge.set((<span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">long</span>) executor.getActiveCount());<br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">9</span>:         <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 等待任务 执行完成 或 超时</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">10</span>:         future.get(timeoutMillis, TimeUnit.MILLISECONDS);  <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// block until done or timeout</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">11</span>:         <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 设置 下一次任务执行频率</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">12</span>:         delay.set(timeoutMillis);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">13</span>:         <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">//</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">14</span>:         threadPoolLevelGauge.set((<span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">long</span>) executor.getActiveCount());<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">15</span>:     } <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">catch</span> (TimeoutException e) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">16</span>:         logger.error(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"task supervisor timed out"</span>, e);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">17</span>:         timeoutCounter.increment(); <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">//</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">18</span>: <br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">19</span>:         <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 设置 下一次任务执行频率</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">20</span>:         <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">long</span> currentDelay = delay.get();<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">21</span>:         <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">long</span> newDelay = Math.min(maxDelay, currentDelay * <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">2</span>);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">22</span>:         delay.compareAndSet(currentDelay, newDelay);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">23</span>: <br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">24</span>:     } <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">catch</span> (RejectedExecutionException e) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">25</span>:         <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (executor.isShutdown() || scheduler.isShutdown()) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">26</span>:             logger.warn(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"task supervisor shutting down, reject the task"</span>, e);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">27</span>:         } <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">else</span> {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">28</span>:             logger.error(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"task supervisor rejected the task"</span>, e);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">29</span>:         }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">30</span>: <br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">31</span>:         rejectedCounter.increment(); <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">//</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">32</span>:     } <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">catch</span> (Throwable e) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">33</span>:         <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (executor.isShutdown() || scheduler.isShutdown()) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">34</span>:             logger.warn(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"task supervisor shutting down, can't accept the task"</span>);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">35</span>:         } <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">else</span> {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">36</span>:             logger.error(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"task supervisor threw an exception"</span>, e);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">37</span>:         }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">38</span>: <br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">39</span>:         throwableCounter.increment(); <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">//</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">40</span>:     } <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">finally</span> {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">41</span>:         <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 取消 未完成的任务</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">42</span>:         <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (future != <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">43</span>:             future.cancel(<span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">true</span>);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">44</span>:         }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">45</span>: <br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">46</span>:         <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 调度 下次任务</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">47</span>:         <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (!scheduler.isShutdown()) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">48</span>:             scheduler.schedule(<span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">this</span>, delay.get(), TimeUnit.MILLISECONDS);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">49</span>:         }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">50</span>:     }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">51</span>: }<br style="font-size:inherit;color:inherit;line-height:inherit;"></code></pre> 
 <ul class="list-paddingleft-2"><li><p>第 5 至 6 行 ：提交子任务 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">task</code> 到执行子任务线程池 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">executor</code> 。</p></li><li><p>第 9 至 10 行 ：等待子任务 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">task</code> 执行完成或执行超时。</p></li><li><p>第 11 至 12 行 ：子任务 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">task</code> 执行完成，设置下一次执行延迟 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">delay</code> 。</p></li><li><p>第 19 至 22 行 ：子任务 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">task</code> 执行超时，重新计算下一次执行延迟 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">delay</code> 。计算公式为 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">Math.min(maxDelay, currentDelay * 2)</code> 。如果多次超时，超时时间不断乘以 2 ，不允许超过最大延迟时间( <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">maxDelay</code> )。</p></li><li><p>第 41 至 44 行 ：<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">强制</strong>取消未完成的子任务。</p></li><li><p><span style="font-size:inherit;color:inherit;line-height:inherit;">第 46 至 49 行 ：调度下一次 TimedSupervisorTask 。</span></p></li></ul> 
 <h2 style="margin-top:1.6em;margin-bottom:1.6em;font-weight:bold;font-size:1.6em;color:rgb(62,62,62);line-height:inherit;border-top:2px solid rgb(3,155,229);letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><span style="margin-right:2px;margin-left:5px;padding-top:3px;padding-right:10px;padding-left:10px;font-size:inherit;color:rgb(255,255,255);line-height:inherit;font-weight:normal;background:rgb(3,155,229);border-bottom:2px solid rgb(0,96,100);border-right:3px solid rgb(0,96,100);">3. Eureka-Server 接收续租</span></h2> 
 <h3 style="margin-top:1.6em;margin-bottom:1.6em;font-weight:bold;font-size:1.4em;color:rgb(62,62,62);line-height:inherit;border-bottom:2px solid rgb(0,172,193);letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><span style="margin-right:2px;padding-top:3px;padding-right:10px;padding-left:10px;font-size:inherit;color:rgb(255,255,255);line-height:inherit;font-weight:normal;background:rgb(0,172,193);">3.1 接收续租请求</span></h3> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">com.netflix.eureka.resources.InstanceResource</code>，处理<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">单个</strong>应用实例信息的请求操作的 Resource ( Controller )。</p> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);">续租应用实例信息的请求，映射 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">InstanceResource#renewLease()</code> 方法，实现代码如下：</p> 
 <pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;word-spacing:2px;background-color:rgb(255,255,255);"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">1</span>: <span class="hljs-meta" style="font-size:inherit;color:rgb(91,218,237);line-height:inherit;">@PUT</span><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">2</span>: <span class="hljs-function" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> Response <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">renewLease</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">(<br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">3</span>:         @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication,<br style="font-size:inherit;color:inherit;line-height:inherit;">  4:         @<span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">QueryParam</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"overriddenstatus"</span>)</span> String overriddenStatus,<br style="font-size:inherit;color:inherit;line-height:inherit;">  5:         @<span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">QueryParam</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"status"</span>)</span> String status,<br style="font-size:inherit;color:inherit;line-height:inherit;">  6:         @<span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">QueryParam</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"lastDirtyTimestamp"</span>)</span> String lastDirtyTimestamp) </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">7</span>:     <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">boolean</span> isFromReplicaNode = <span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"true"</span>.equals(isReplication);<br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">8</span>:     <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 续租</span><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">9</span>:     <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">boolean</span> isSuccess = registry.renew(app.getName(), id, isFromReplicaNode);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">10</span>: <br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">11</span>:     <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 续租失败</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">12</span>:     <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// Not found in the registry, immediately ask for a register</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">13</span>:     <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (!isSuccess) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">14</span>:         logger.warn(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"Not Found (Renew): {} - {}"</span>, app.getName(), id);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">15</span>:         <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> Response.status(Status.NOT_FOUND).build();<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">16</span>:     }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">17</span>: <br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">18</span>:     <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 比较 InstanceInfo 的 lastDirtyTimestamp 属性</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">19</span>:     <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// Check if we need to sync based on dirty time stamp, the client</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">20</span>:     <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// instance might have changed some value</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">21</span>:     Response response = <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">22</span>:     <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (lastDirtyTimestamp != <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span> &amp;&amp; serverConfig.shouldSyncWhenTimestampDiffers()) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">23</span>:         response = <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">this</span>.validateDirtyTimestamp(Long.valueOf(lastDirtyTimestamp), isFromReplicaNode);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">24</span>:         <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// Store the overridden status since the validation found out the node that replicates wins</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">25</span>:         <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (response.getStatus() == Response.Status.NOT_FOUND.getStatusCode()<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">26</span>:                 &amp;&amp; (overriddenStatus != <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>)<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">27</span>:                 &amp;&amp; !(InstanceStatus.UNKNOWN.name().equals(overriddenStatus))<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">28</span>:                 &amp;&amp; isFromReplicaNode) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">29</span>:             registry.storeOverriddenStatusIfRequired(app.getAppName(), id, InstanceStatus.valueOf(overriddenStatus));<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">30</span>:         }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">31</span>:     } <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">else</span> { <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 成功</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">32</span>:         response = Response.ok().build();<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">33</span>:     }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">34</span>:     logger.debug(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"Found (Renew): {} - {}; reply status={}"</span> + app.getName(), id, response.getStatus());<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">35</span>:     <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> response;<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">36</span>: }<br style="font-size:inherit;color:inherit;line-height:inherit;"></code></pre> 
 <ul class="list-paddingleft-2"><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 8 至 9 行 ：调用 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">PeerAwareInstanceRegistryImpl#renew(...)</code> 方法，续租。实现代码如下：</p><pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:inherit;color:inherit;line-height:inherit;"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// PeerAwareInstanceRegistryImpl.java</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-function" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">boolean</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">renew</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">(<span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> String appName, <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> String id, <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">boolean</span> isReplication)</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">   <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (<span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">super</span>.renew(appName, id, isReplication)) { <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 续租</span><br style="font-size:inherit;color:inherit;line-height:inherit;">       <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// Eureka-Server 复制</span><br style="font-size:inherit;color:inherit;line-height:inherit;">       replicateToPeers(Action.Heartbeat, appName, id, <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>, <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>, isReplication);<br style="font-size:inherit;color:inherit;line-height:inherit;">       <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">true</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;">   }<br style="font-size:inherit;color:inherit;line-height:inherit;">   <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">false</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"></code></pre> 
   <ul style="list-style-type:square;" class="list-paddingleft-2"><li><p>调用父类 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">AbstractInstanceRegistry#renew(...)</code> 方法，注册应用实例信息。</p></li></ul></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 11 至 16 行 ：续租失败，返回 404 响应。当 Eureka-Client 收到 404 响应后，会重新发起 InstanceInfo 的注册。</p></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 18 至 30 行 ：比较请求的 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">lastDirtyTimestamp</code> 和 Server 的 InstanceInfo 的 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">lastDirtyTimestamp</code> 属性差异，需要配置 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">eureka.syncWhenTimestampDiffers = true</code> ( 默认开启 )。</p> 
   <ul style="list-style-type:square;" class="list-paddingleft-2"><li><p>第 7 至 11 行 ：请求的 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">lastDirtyTimestamp</code> 较大，<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">意味着请求方( 可能是 Eureka-Client ，也可能是 Eureka-Server 集群内的其他 Server )存在 InstanceInfo 和 Eureka-Server 的 InstanceInfo 的数据不一致，返回 404 响应。请求方收到 404 响应后重新发起注册</strong>。</p></li><li><p>第 16 至 21 行 ：《Eureka 源码解析 —— Eureka-Server 集群同步》 有详细解析。</p></li><li><p>第 22 至 24 行 ：Server 的 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">lastDirtyTimestamp</code> 较大，并且请求方为 Eureka-Client，续租成功，返回 200 成功响应。</p></li><li><p>第 29 行 ：<code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">lastDirtyTimestamp</code> 一致，返回 200 成功响应。</p></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 23 行 ：调用 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">#validateDirtyTimestamp(...)</code> 方法，比较 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">lastDirtyTimestamp</code> 的差异。实现代码如下：</p><pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:inherit;color:inherit;line-height:inherit;"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// InstanceResource.java</span><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">1</span>: <span class="hljs-function" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">private</span> Response <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">validateDirtyTimestamp</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">(Long lastDirtyTimestamp, <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">boolean</span> isReplication)</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">2</span>:     <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 获取 InstanceInfo</span><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">3</span>:     InstanceInfo appInfo = registry.getInstanceByAppAndId(app.getName(), id, <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">false</span>);<br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">4</span>:     <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (appInfo != <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">5</span>:         <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> ((lastDirtyTimestamp != <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>) &amp;&amp; (!lastDirtyTimestamp.equals(appInfo.getLastDirtyTimestamp()))) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">6</span>:             Object[] args = {id, appInfo.getLastDirtyTimestamp(), lastDirtyTimestamp, isReplication};<br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">7</span>:             <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 请求 的 较大</span><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">8</span>:             <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (lastDirtyTimestamp &gt; appInfo.getLastDirtyTimestamp()) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">9</span>:                 logger.debug(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"Time to sync, since the last dirty timestamp differs -"</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">10</span>:                                 + <span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">" ReplicationInstance id : {},Registry : {} Incoming: {} Replication: {}"</span>, args);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">11</span>:                 <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> Response.status(Status.NOT_FOUND).build();<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">12</span>:             <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// Server 的 较大</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">13</span>:             } <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">else</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (appInfo.getLastDirtyTimestamp() &gt; lastDirtyTimestamp) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">14</span>:                 <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// In the case of replication, send the current instance info in the registry for the</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">15</span>:                 <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// replicating node to sync itself with this one.</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">16</span>:                 <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (isReplication) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">17</span>:                     logger.debug(<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">18</span>:                             <span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"Time to sync, since the last dirty timestamp differs -"</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">19</span>:                                     + <span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">" ReplicationInstance id : {},Registry : {} Incoming: {} Replication: {}"</span>,<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">20</span>:                             args);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">21</span>:                     <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> Response.status(Status.CONFLICT).entity(appInfo).build();<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">22</span>:                 } <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">else</span> {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">23</span>:                     <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> Response.ok().build();<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">24</span>:                 }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">25</span>:             }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">26</span>:         }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">27</span>: <br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">28</span>:     }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">29</span>:     <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> Response.ok().build();<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">30</span>: }   <br style="font-size:inherit;color:inherit;line-height:inherit;"></code></pre></li></ul></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 24 至 30 行 ：《Eureka 源码解析 —— Eureka-Server 集群同步》 有详细解析。</p></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 31 至 33 行 ：续租成功，返回 200 成功响应。</p></li></ul> 
 <h3 style="margin-top:1.6em;margin-bottom:1.6em;font-weight:bold;font-size:1.4em;color:rgb(62,62,62);line-height:inherit;border-bottom:2px solid rgb(0,172,193);letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><span style="margin-right:2px;padding-top:3px;padding-right:10px;padding-left:10px;font-size:inherit;color:rgb(255,255,255);line-height:inherit;font-weight:normal;background:rgb(0,172,193);">3.2 续租应用实例信息</span></h3> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);">调用 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">AbstractInstanceRegistry#renew(...)</code> 方法，续租应用实例信息，实现代码如下：</p> 
 <pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;word-spacing:2px;background-color:rgb(255,255,255);"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">1</span>: <span class="hljs-function" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">boolean</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">renew</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">(String appName, String id, <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">boolean</span> isReplication)</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">2</span>:     <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 增加 续租次数 到 监控</span><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">3</span>:     RENEW.increment(isReplication);<br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">4</span>:     <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 获得 租约</span><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">5</span>:     Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(appName);<br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">6</span>:     Lease&lt;InstanceInfo&gt; leaseToRenew = <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">7</span>:     <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (gMap != <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">8</span>:         leaseToRenew = gMap.get(id);<br style="font-size:inherit;color:inherit;line-height:inherit;">  <span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">9</span>:     }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">10</span>:     <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 租约不存在</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">11</span>:     <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (leaseToRenew == <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">12</span>:         RENEW_NOT_FOUND.increment(isReplication);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">13</span>:         logger.warn(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"DS: Registry: lease doesn't exist, registering resource: {} - {}"</span>, appName, id);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">14</span>:         <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">false</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">15</span>:     } <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">else</span> {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">16</span>:         InstanceInfo instanceInfo = leaseToRenew.getHolder();<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">17</span>:         <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (instanceInfo != <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">null</span>) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">18</span>:             <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// touchASGCache(instanceInfo.getASGName());</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">19</span>:             <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// override status</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">20</span>:             InstanceStatus overriddenInstanceStatus = <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">this</span>.getOverriddenInstanceStatus(<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">21</span>:                     instanceInfo, leaseToRenew, isReplication);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">22</span>:             <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (overriddenInstanceStatus == InstanceStatus.UNKNOWN) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">23</span>:                 logger.info(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"Instance status UNKNOWN possibly due to deleted override for instance {}"</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">24</span>:                         + <span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"; re-register required"</span>, instanceInfo.getId());<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">25</span>:                 RENEW_NOT_FOUND.increment(isReplication);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">26</span>:                 <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">false</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">27</span>:             }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">28</span>:             <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">if</span> (!instanceInfo.getStatus().equals(overriddenInstanceStatus)) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">29</span>:                 Object[] args = {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">30</span>:                         instanceInfo.getStatus().name(),<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">31</span>:                         instanceInfo.getOverriddenStatus().name(),<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">32</span>:                         instanceInfo.getId()<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">33</span>:                 };<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">34</span>:                 logger.info(<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">35</span>:                         <span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"The instance status {} is different from overridden instance status {} for instance {}. "</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">36</span>:                                 + <span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"Hence setting the status to overridden status"</span>, args);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">37</span>:                 instanceInfo.setStatusWithoutDirty(overriddenInstanceStatus);<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">38</span>:             }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">39</span>:         }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">40</span>:         <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 新增 续租每分钟次数</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">41</span>:         renewsLastMin.increment();<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">42</span>:         <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// 设置 租约最后更新时间（续租）</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">43</span>:         leaseToRenew.renew();<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">44</span>:         <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">return</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">true</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">45</span>:     }<br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">46</span>: }<br style="font-size:inherit;color:inherit;line-height:inherit;"></code></pre> 
 <ul class="list-paddingleft-2"><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 2 至 3 行 ：增加续租次数到监控。配合 Netflix Servo 实现监控信息采集。</p></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 4 至 9 行 ：获得租约( Lease )。</p></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 10 至 14 行 ：租约不存在，返回续租失败( <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">false</code> )。</p></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 19 至 21 行 ：获得应用实例的<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">最终状态</strong>。在《应用实例注册发现 （八）之覆盖状态》详细解析。</p></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 22 至 27 行 ：应用实例的<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">最终状态</strong>为 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">UNKNOWN</code>，无法续约，返回 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">false</code> 。在《应用实例注册发现 （八）之覆盖状态》详细解析。</p></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 28 至 37 行 ：应用实例的状态与<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">最终状态</strong>不相等，使用<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">最终状态</strong>覆盖应用实例的状态。在《应用实例注册发现 （八）之覆盖状态》详细解析。</p></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 40 至 41 行 ：新增续租每分钟次数( <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">renewsLastMin</code> )。<code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">com.netflix.eureka.util.MeasuredRate</code>，速度测量类，实现代码如下：</p><pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:inherit;color:inherit;line-height:inherit;"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// AbstractInstanceRegistry.java</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;"> * 续租每分钟次数<br style="font-size:inherit;color:inherit;line-height:inherit;"> */</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> MeasuredRate renewsLastMin;<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// MeasuredRate.java</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">public</span> <span class="hljs-class" style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">class</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">MeasuredRate</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;">     * 上一个间隔次数<br style="font-size:inherit;color:inherit;line-height:inherit;">     */</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> AtomicLong lastBucket = <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">new</span> AtomicLong(<span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">0</span>);<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;">     * 当前间隔次数<br style="font-size:inherit;color:inherit;line-height:inherit;">     */</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> AtomicLong currentBucket = <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">new</span> AtomicLong(<span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">0</span>);<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;">     * 间隔<br style="font-size:inherit;color:inherit;line-height:inherit;">     */</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">long</span> sampleInterval;<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;">     * 定时器<br style="font-size:inherit;color:inherit;line-height:inherit;">     */</span><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">final</span> Timer timer;</code></pre><pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:inherit;color:inherit;line-height:inherit;"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;"><code style="margin-right:2px;margin-left:2px;padding:2px 4px;color:rgb(248,35,117);line-height:18px;font-family:Consolas, Inconsolata, Courier, monospace;letter-spacing:0px;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">private</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">volatile</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">boolean</span> isActive;<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-function" style="font-size:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">MeasuredRate</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">(<span class="hljs-keyword" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;">long</span> sampleInterval)</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">this</span>.sampleInterval = sampleInterval;<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">this</span>.timer = <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">new</span> Timer(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"Eureka-MeasureRateTimer"</span>, <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">true</span>);<br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">this</span>.isActive = <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">false</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-function" style="font-size:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">synchronized</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">void</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">start</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">()</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">if</span> (!isActive) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">        timer.schedule(<span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">new</span> TimerTask() {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">            <span class="hljs-meta" style="font-size:inherit;color:rgb(91,218,237);line-height:inherit;">@Override</span><br style="font-size:inherit;color:inherit;line-height:inherit;">            <span class="hljs-function" style="font-size:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">void</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">run</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">()</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">                <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">try</span> {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">                    <span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">// Zero out the current bucket.</span><br style="font-size:inherit;color:inherit;line-height:inherit;">                    lastBucket.set(currentBucket.getAndSet(<span class="hljs-number" style="font-size:inherit;color:rgb(174,135,250);line-height:inherit;">0</span>));<br style="font-size:inherit;color:inherit;line-height:inherit;">                } <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">catch</span> (Throwable e) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">                    logger.error(<span class="hljs-string" style="font-size:inherit;color:rgb(238,220,112);line-height:inherit;">"Cannot reset the Measured Rate"</span>, e);<br style="font-size:inherit;color:inherit;line-height:inherit;">                }<br style="font-size:inherit;color:inherit;line-height:inherit;">            }<br style="font-size:inherit;color:inherit;line-height:inherit;">        }, sampleInterval, sampleInterval);<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;">        isActive = <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">true</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;">    }<br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-function" style="font-size:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">synchronized</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">void</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">stop</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">()</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">if</span> (isActive) {<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">        timer.cancel();<br style="font-size:inherit;color:inherit;line-height:inherit;">        isActive = <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">false</span>;<br style="font-size:inherit;color:inherit;line-height:inherit;">    }<br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;"> * Returns the count in the last sample interval.<br style="font-size:inherit;color:inherit;line-height:inherit;"> */</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-function" style="font-size:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">long</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">getCount</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">()</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">    <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">return</span> lastBucket.get();<br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-comment" style="font-size:inherit;color:rgb(128,128,128);line-height:inherit;">/**<br style="font-size:inherit;color:inherit;line-height:inherit;"> * Increments the count in the current sample interval.<br style="font-size:inherit;color:inherit;line-height:inherit;"> */</span><br style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-function" style="font-size:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">void</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">increment</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">()</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">    currentBucket.incrementAndGet();<br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"></code></code></pre><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;">}  <br style="font-size:inherit;color:inherit;line-height:inherit;"></code> 
   <ul style="list-style-type:square;" class="list-paddingleft-2"><li><p>配合 Netflix Servo 实现监控信息采集<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">续租每分钟次数</strong>。</p></li><li><p>Eureka-Server 运维界面的显示<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">续租每分钟次数</strong>。</p></li><li><p>自我保护机制，在 《Eureka 源码解析 —— 应用实例注册发现 （四）之自我保护机制》 详细解析。</p></li><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">timer</code> ，定时器，负责每个 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">sampleInterval</code> 间隔重置<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">当前次数</strong>( <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">currentBucket</code> )，并将<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">原当前次数</strong>设置到<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">上一个次数</strong>( <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">lastBucket</code> )。</p></li><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">#increment()</code> 方法，返回<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">当前次数</strong>( <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">currentBucket</code> )。</p></li><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">#getCount()</code> 方法，返回<strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">上一个次数</strong>( <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">lastBucket</code> )。</p></li><li><p><code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">renewsLastMin</code> 有如下用途：</p></li></ul></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 42 至 43 行 ：调用 <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">Lease#renew()</code> 方法，设置租约最后更新时间( 续租 )，实现代码如下：</p><pre style="margin-top:0px;margin-bottom:0px;padding:0px;font-size:inherit;color:inherit;line-height:inherit;"><code class="Java language-Java hljs" style="margin-right:2px;margin-left:2px;padding:.5em;font-size:14px;color:rgb(169,183,198);line-height:18px;background:rgb(40,43,46);font-family:Consolas, Inconsolata, Courier, monospace;word-spacing:0px;letter-spacing:0px;"><span class="hljs-function" style="font-size:inherit;color:rgb(248,35,117);line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">public</span> <span class="hljs-keyword" style="font-size:inherit;line-height:inherit;">void</span> <span class="hljs-title" style="font-size:inherit;color:rgb(165,218,45);line-height:inherit;">renew</span><span class="hljs-params" style="font-size:inherit;color:rgb(255,152,35);line-height:inherit;">()</span> </span>{<!-- --><br style="font-size:inherit;color:inherit;line-height:inherit;">    lastUpdateTimestamp = System.currentTimeMillis() + duration;<br style="font-size:inherit;color:inherit;line-height:inherit;">}<br style="font-size:inherit;color:inherit;line-height:inherit;"></code></pre> 
   <ul style="list-style-type:square;" class="list-paddingleft-2"><li><p><span style="font-size:inherit;color:inherit;line-height:inherit;">x</span></p></li></ul></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;">第 44 行 ：返回续租成功( <code style="margin-right:2px;margin-left:2px;padding:2px 4px;font-size:inherit;color:rgb(248,35,117);line-height:inherit;background:rgb(248,248,248);">true</code> )。</p></li><li><p style="margin-top:1.7em;margin-bottom:1.7em;font-size:inherit;color:inherit;line-height:inherit;"><strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">整个过程修改的租约的过期时间，即使并发请求，也不会对数据的一致性产生不一致的影响，因此像注册操作一样加锁</strong>。</p></li></ul> 
 <h2 style="margin-top:1.6em;margin-bottom:1.6em;font-weight:bold;font-size:1.6em;color:rgb(62,62,62);line-height:inherit;border-top:2px solid rgb(3,155,229);letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);"><span style="margin-right:2px;margin-left:5px;padding-top:3px;padding-right:10px;padding-left:10px;font-size:inherit;color:rgb(255,255,255);line-height:inherit;font-weight:normal;background:rgb(3,155,229);border-bottom:2px solid rgb(0,96,100);border-right:3px solid rgb(0,96,100);">666. 彩蛋</span></h2> 
 <img class="img_loading" style="margin-right:auto;margin-left:auto;border:2px solid rgb(238,238,238);font-size:inherit;color:inherit;line-height:inherit;width:670px;height:378.4984802431611px;" title="知识星球" src="https://images2.imgbox.com/fb/f9/94n7wo1A_o.png" alt="640?wx_fmt=jpeg">知识星球 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);">效率比想象的低一些，加油继续更新下一篇。</p> 
 <p style="margin-top:1.7em;margin-bottom:1.7em;font-size:15px;color:rgb(62,62,62);line-height:inherit;letter-spacing:2px;white-space:normal;word-spacing:2px;background-color:rgb(255,255,255);">胖友，分享我的公众号( <strong style="color:rgb(233,105,0);font-size:inherit;line-height:inherit;">芋道源码</strong> ) 给你的胖友可好？</p> 
 <p style="margin:0px;text-align:left;color:rgb(0,0,0);letter-spacing:0px;font-size:14px;line-height:1.6;"><br></p> 
</div>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/74c97ca99ea7a5df11ced3959ca8b5df/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">RDD中的一些常用的算子操作</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5e89bde415616832fdc289d2dd28286e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">到底什么是非线性规划？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>