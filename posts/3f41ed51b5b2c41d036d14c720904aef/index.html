<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nginx 如何配置来获取用户真实IP - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nginx 如何配置来获取用户真实IP" />
<meta property="og:description" content="##1.背景知识 1.1. 前提知识点： 还有nginx中的几个变量：
remote_addr 代表客户端的IP，但它的值不是由客户端提供的，而是服务端根据客户端的ip指定的，当你的浏览器访问某个网站时，假设中间没有任何代理，那么网站的web服务器（Nginx，Apache等）就会把remote_addr设为你的机器IP，如果你用了某个代理，那么你的浏览器会先访问这个代理，然后再由这个代理转发到网站，这样web服务器就会把remote_addr设为这台代理机器的IP,除非代理将你的IP附在请求header中一起转交给web服务器。
X-Forwarded-For（简称XFF）
X-Forwarded-For 是一个 HTTP 扩展头部。HTTP/1.1（RFC 2616）协议并没有对它的定义，它最开始是由 Squid 这个缓存代理软件引入，用来表示 HTTP 请求端真实 IP。如今它已经成为事实上的标准，被各大 HTTP 代理、负载均衡等转发服务广泛使用，并被写入 RFC 7239（Forwarded HTTP Extension）标准之中。
XFF的格式为：
X-Forwarded-For: client, proxy1, proxy2 XFF 的内容由「英文逗号 &#43; 空格」隔开的多个部分组成，最开始的是离服务端最远的设备 IP，然后是每一级代理设备的 IP。（注意：如果未经严格处理，可以被伪造）
如果一个 HTTP 请求到达服务器之前，经过了三个代理 Proxy1、Proxy2、Proxy3，IP 分别为 IP1、IP2、IP3，用户真实 IP 为 IP0，那么按照 XFF 标准，服务端最终会收到以下信息：
X-Forwarded-For: IP0, IP1, IP2 Proxy3 直连服务器，它会给 XFF 追加 IP2，表示它是在帮 Proxy2 转发请求。列表中并没有 IP3，IP3 可以在服务端通过 Remote Address 字段获得。我们知道 HTTP 连接基于 TCP 连接，HTTP 协议中没有 IP 的概念，Remote Address 来自 TCP 连接，表示与服务端建立 TCP 连接的设备 IP，在这个例子里就是 IP3。Remote Address 无法伪造，因为建立 TCP 连接需要三次握手，如果伪造了源 IP，无法建立 TCP 连接，更不会有后面的 HTTP 请求。但是在正常情况下，web服务器获取Remote Address只会获取到上一级的IP，本例里则是proxy3 的 IP3，这里先埋个伏笔。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/3f41ed51b5b2c41d036d14c720904aef/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-05-31T14:34:46+08:00" />
<meta property="article:modified_time" content="2017-05-31T14:34:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nginx 如何配置来获取用户真实IP</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3 style="margin:10px 0px; padding:0px; line-height:1.5; font-size:21px; font-family:verdana,Arial,Helvetica,sans-serif"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">##1.背景知识</span></h3> 
<h4 style="margin:10px 0px; padding:0px; font-size:16px; line-height:1.5; font-family:verdana,Arial,Helvetica,sans-serif"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">1.1. 前提知识点：</span></h4> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="font-family:'Microsoft YaHei'; font-size:13px; line-height:1.8">还有nginx中的几个变量：</span></p> 
<ul style="margin:0px 0px 0px 30px; padding:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"><li style="margin:0px; padding:0px; list-style:disc"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">remote_addr</span> <p style="margin:10px auto; padding-top:0px; padding-bottom:0px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">代表客户端的IP，但它的值不是由客户端提供的，而是服务端根据客户端的ip指定的，当你的浏览器访问某个网站时，假设中间没有任何代理，那么网站的web服务器（Nginx，Apache等）就会把remote_addr设为你的机器IP，如果你用了某个代理，那么你的浏览器会先访问这个代理，然后再由这个代理转发到网站，这样web服务器就会把remote_addr设为这台代理机器的IP,除非代理将你的IP附在请求header中一起转交给web服务器。</span></p> </li><li style="margin:0px; padding:0px; list-style:disc"> <p style="margin:10px auto; padding-top:0px; padding-bottom:0px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">X-Forwarded-For（简称XFF）</span></p> <p style="margin:10px auto; padding-top:0px; padding-bottom:0px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">X-Forwarded-For 是一个 HTTP 扩展头部。HTTP/1.1（RFC 2616）协议并没有对它的定义，它最开始是由 Squid 这个缓存代理软件引入，用来表示 HTTP 请求端真实 IP。如今它已经成为事实上的标准，被各大 HTTP 代理、负载均衡等转发服务广泛使用，并被写入 <a target="_blank" href="http://tools.ietf.org/html/rfc7239" rel="nofollow noopener noreferrer" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom-width:1px; border-bottom-style:dotted; border-bottom-color:rgb(51,51,51)">RFC 7239</a>（Forwarded HTTP Extension）标准之中。</span></p> <p style="margin:10px auto; padding-top:0px; padding-bottom:0px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">XFF的格式为：</span></p> <pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">X-Forwarded-For: client, proxy1, proxy2
</code></span></pre> <p style="margin:10px auto; padding-top:0px; padding-bottom:0px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">XFF 的内容由「英文逗号 + 空格」隔开的多个部分组成，最开始的是离服务端最远的设备 IP，然后是每一级代理设备的 IP。（<span style="margin:0px; padding:0px">注意：如果未经严格处理，可以被伪造</span>）</span></p> <p style="margin:10px auto; padding-top:0px; padding-bottom:0px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">如果一个 HTTP 请求到达服务器之前，经过了三个代理 Proxy1、Proxy2、Proxy3，IP 分别为 IP1、IP2、IP3，用户真实 IP 为 IP0，那么按照 XFF 标准，服务端最终会收到以下信息：</span></p> <pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">X-Forwarded-For: IP0, IP1, IP2
</code></span></pre> <p style="margin:10px auto; padding-top:0px; padding-bottom:0px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">Proxy3 直连服务器，它会给 XFF 追加 IP2，表示它是在帮 Proxy2 转发请求。列表中并没有 IP3，IP3 可以在服务端通过 Remote Address 字段获得。我们知道 HTTP 连接基于 TCP 连接，HTTP 协议中没有 IP 的概念，Remote Address 来自 TCP 连接，表示与服务端建立 TCP 连接的设备 IP，在这个例子里就是 IP3。Remote Address 无法伪造，因为建立 TCP 连接需要三次握手，如果伪造了源 IP，无法建立 TCP 连接，更不会有后面的 HTTP 请求。但是在正常情况下，web服务器获取Remote Address只会获取到上一级的IP，本例里则是proxy3 的 IP3，<span style="margin:0px; padding:0px">这里先埋个伏笔</span>。</span></p> </li><li style="margin:0px; padding:0px; list-style:disc"> <p style="margin:10px auto; padding-top:0px; padding-bottom:0px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">X-Real-IP</span></p> <p style="margin:10px auto; padding-top:0px; padding-bottom:0px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">这又是一个自定义头部字段，通常被 HTTP 代理用来表示与它产生 TCP 连接的设备 IP，这个设备可能是其他代理，也可能是真正的请求端，这个要看经过代理的层级次数或是是否始终将真实IP一路传下来。（<span style="margin:0px; padding:0px">注意：如果未经严格处理，可以被伪造</span>）</span></p> </li></ul> 
<h4 style="margin:10px 0px; padding:0px; font-size:16px; line-height:1.5; font-family:verdana,Arial,Helvetica,sans-serif"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">1.2.前提与铁律</span></h4> 
<blockquote style="margin:10px 0px; padding:5px 10px; border:2px solid rgb(239,239,239); color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> 
 <p style="margin:10px auto; padding-top:0px; padding-bottom:0px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">铁律：当多层代理或使用CDN时，如果代理服务器不把用户的真实IP传递下去，那么业务服务器将永远不可能获取到用户的真实IP。</span></p> 
</blockquote> 
<h4 style="margin:10px 0px; padding:0px; font-size:16px; line-height:1.5; font-family:verdana,Arial,Helvetica,sans-serif"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">1.3.用户真实IP的来源和现实情况</span></h4> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">首先说用户真实的IP也会存在很多人共用一个IP的情况。用户的请求到达业务服务器会经过以下几种情形：</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">####1.3.1.宽带供应商提供独立IP</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">比如家里电信宽带上网，电信给分配了公网ip，那么一个请求经过的ip路径如下：</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">192.168.0.101(用户电脑ip)–&gt;192.168.0.1/116.1.2.3(路由器的局域网ip及路由器得到的电信公网ip)–&gt;119.147.19.234(业务的前端负载均衡服务器)–&gt;192.168.126.127(业务处理服务器)。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">这种情况下，119.147.19.234会把得到的116.1.2.3附加到头信息中传给192.168.126.127,因此这种情况下，我们取得的用户ip则为:116.1.2.3。如果119.147.19.234没有把116.1.2.3附加到头信息中传给业务服务器，业务服务器就只能取上上一级的110.147.19.234.</span></p> 
<h5 style="margin:10px 0px; padding:0px; font-size:14px; font-family:verdana,Arial,Helvetica,sans-serif; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">1.3.2.宽带供应商不能提供独立IP</span></h5> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">宽带提供商没有足够的公网ip，分配的是个内网ip，比如长宽等小的isp。请求路径则可能为：</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">192.168.0.123(用户电脑ip)–&gt;192.168.0.1/10.0.1.2(路由器的局域网ip及路由器得到的运营商内网ip)–&gt;211.162.78.1（网络运营商长城宽带的公网ip）–&gt;119.147.19.234(业务的前端负载均衡服务器)–&gt;192.168.126.127(业务处理服务器)。</span><br style="margin:0px; padding:0px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">这种情况下得到的用户ip，就是211.162.78.1。 这种情况下，就可能出现一个ip对应有数十上百个用户的情况了（受运营商提供的代理规模决定，比如可能同时有几千或上万的宽带用户都是从211.162.78.1这个ip对外请求）。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">####1.3.3.手机2g上网</span><br style="margin:0px; padding:0px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">网络提供商没法直接提供ip给单个用户终端，以中国移动cmwap上网为例，因此请求路径可能为：</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">手机（手机上没法查看到ip）–&gt; 10.0.0.172(cmwap代理服务器ip)–&gt;10.0.1.2(移动运营商内网ip)–&gt;202.96.75.1（移动运营商的公网ip）–&gt;119.147.19.234(业务的前端负载均衡服务器)–&gt;192.168.126.127(业务处理服务器)。</span><br style="margin:0px; padding:0px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">这种情况下得到的用户ip，就是202.96.75.1。2008年的时候整个广东联通就三个手机上网的公网ip，因此这种情况下，同一ip出现数十万用户也是正常的。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">####1.3.4.大厂，有几万或数十万员工，但是出口上网ip就一个</span><br style="margin:0px; padding:0px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">这种也会出现来自同一ip的超多用户，比如腾讯、百度等某一个办公区，可能达到几万人，但出口IP可能就那么几个。</span></p> 
<h4 style="margin:10px 0px; padding:0px; font-size:16px; line-height:1.5; font-family:verdana,Arial,Helvetica,sans-serif"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">2.如何获取用户真实IP</span></h4> 
<h5 style="margin:10px 0px; padding:0px; font-size:14px; font-family:verdana,Arial,Helvetica,sans-serif; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">2.1. 当业务服务器直接暴露在公网上，并且未使用CDN和反向代理服务器时：</span></h5> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">可以直接使用remote_addr。如 PHP 可以直接使用</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code class="php" style="margin:0px; padding:0px">$_SERVER['REMOTE_ADDR']
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">这时候，HTTP_X_FORWARDED_FOR 和 HTTP_X_REAL_IP 都是可以被伪造的，但REMOTE_ADDR是客户端和服务器的握手IP，即client的出口IP，伪造不了。</span><br style="margin:0px; padding:0px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">比如用下面这条命令来请求一个php文件，并且输出$_SERVER信息</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code class="sh" style="margin:0px; padding:0px">curl http://10.200.21.32/test.php -H 'X-Forwarded-For: unkonw, &lt;alert&gt;aa,11.22.33.44,11&lt;/alert&gt;" 1.1.1.1' -H 'X-Real-IP: 2.2.2.2, &lt;a&gt;'
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">结果是(只取部分信息，10.100.11.25是我电脑的IP，服务器是内网服务器，所以不会有公网IP）</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">[HTTP_X_FORWARDED_FOR] =&gt; unkonw, &lt;alert&gt;aa,11.22.33.44,11&lt;/alert&gt;" 1.1.1.1
[REMOTE_ADDR] =&gt; 10.100.11.25
[HTTP_X_REAL_IP] =&gt; 2.2.2.2, &lt;a&gt;
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">可以看到，HTTP_X_FORWARDED_FOR 和 HTTP_X_REAL_IP <span style="margin:0px; padding:0px">是万万不可直接拿来用的</span>。使用<code style="margin:0px; padding:0px">$remote_addr</code>是明智的选择。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">比如我们伪造一下来源IP发给著名的 ip138.com</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code class="sh" style="margin:0px; padding:0px">curl http://1212.ip138.com/ic.asp -H 'X-Forwarded-For: unkonw, &lt;alert&gt;aa,11.22.33.44,11&lt;/alert&gt;" 1.1.1.1'
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">它原样输出了我们伪造的XFF。</span></p> 
<h5 style="margin:10px 0px; padding:0px; font-size:14px; font-family:verdana,Arial,Helvetica,sans-serif; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">2.2.在代理服务器或CDN之后的业务服务器</span></h5> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">前提：上面的每一层代理或CDN，都将原始请求的 remote_addr 一路传递下去。我们先来看其中一种方案。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">如果web服务器上层也是使用nginx做代理或负载均衡，则需要在代理层的nginx配置中明确XFF参数，累加传递上一个请求方的IP到header请求中。以下是代理层的nginx配置参数。</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px"><span style="background-color:rgb(255,255,255)"> </span><span style="background-color:rgb(153,255,153)">   proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-NginX-Proxy true;</span><span style="background-color:rgb(255,255,255)">
</span></code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">如果web服务器前面使用了HAProxy，则需要增加以下配置来将用户的真实IP转发到web服务器。</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">    option forwardfor
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">如果想在业务服务器获取完整的链路信息，还是通过XFF获取，需要在nginx的配置中加一条配置，加上此配置可以让我们获取整个链路信息:</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">fastcgi_param  HTTP_X_FORWARDED_FOR $http_x_forwarded_for;
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">实测此参数最好加在被 include 的<code style="margin:0px; padding:0px">fastcgi.conf</code>中，就是有一堆<code style="margin:0px; padding:0px">fastcgi_param</code>配置的那个文件否则就写入<code style="margin:0px; padding:0px">location</code>段。这个配置可能会影响你的nginx日志，这个后续会详细说明。如果不配置此项，则我们在WEB SERVER 上直接获取到的XFF信息则是上一个代理层的IP。当然，也不影响获取用户真实IP。不过如果你是在调试配置的情况下，就不方便查看整个链路了。</span></p> 
<h6 style="margin:10px 0px; padding:0px; font-size:12px; font-family:verdana,Arial,Helvetica,sans-serif"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">2.2.1 在只有一层代理的情况下</span></h6> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">我们按上面的配置发起一个伪造请求, 10.100.11.25 是我电脑的IP，链路为：</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">10.100.11.25(client)-&gt;10.200.21.33(Proxy)-&gt;10.200.21.32(Web Server)
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">curl 请求：</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code class="sh" style="margin:0px; padding:0px">curl http://10.200.21.33:88/test.php -H 'X-Forwarded-For: unkonw, &lt;8.8.8.8&gt; 1.1.1.1' -H 'X-Real-IP: 2.2.2.2'
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">结果如下：</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">[HTTP_X_FORWARDED_FOR] =&gt; unkonw, &lt;8.8.8.8&gt; 1.1.1.1, 10.100.11.25
[REMOTE_ADDR] =&gt; 10.200.21.33
[HTTP_X_REAL_IP] =&gt; 10.100.11.25
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">我们可以看到，XFF被附加上了我的IP，但前面的一系列伪造内容，可以轻易骗过很多规则，而<code style="margin:0px; padding:0px">HTTP_X_REAL_IP</code> 则传递了我电脑的IP。因为在上面的配置中，<code style="margin:0px; padding:0px">X-Real-IP</code> 已经被设置为握手 IP。 但多层代理之后，以上面的规则，显然 <code style="margin:0px; padding:0px">HTTP_X_REAL_IP</code> 也不会是真实的用户IP了。而 <code style="margin:0px; padding:0px">HTTP_X_FORWARDED_FOR</code> 则在原有信息（我们伪造的信息）之后附上了握手 IP 一起传递过来了。</span></p> 
<h6 style="margin:10px 0px; padding:0px; font-size:12px; font-family:verdana,Arial,Helvetica,sans-serif"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">2.2.2 在两层或更多代理的情况下</span></h6> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">我们这里只测试两层，实际链路为：</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">10.100.11.25(client)-&gt;10.200.21.34(Proxy)-&gt;10.200.21.33(Proxy)-&gt;10.200.21.32(Web Server)
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">Curl 命令：</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code class="sh" style="margin:0px; padding:0px">curl http://10.200.21.34:88/test.php -H 'X-Forwarded-For: unkonw, &lt;8.8.8.8&gt; 1.1.1.1' -H 'X-Real-IP: 2.2.2.2'
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">两层代理的情况下结果为：</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">[HTTP_X_FORWARDED_FOR] =&gt; unkonw, &lt;8.8.8.8&gt; 1.1.1.1, 10.100.11.25, 10.200.21.34
[REMOTE_ADDR] =&gt; 10.200.21.33
[HTTP_X_REAL_IP] =&gt; 10.200.21.34
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">根据上面的情况，怎么挑出真正的用户IP呢？设想三种方案：</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51)"> <span style="font-family:Microsoft YaHei"><span style="font-size:13px; line-height:23.4px"><br style="margin:0px; padding:0px"> </span></span><span style="font-family:'Microsoft YaHei'; font-size:13px; line-height:1.8; margin:0px; padding:0px"><strong>1.  </strong> 第一层代理将用户的真实 IP <strong>放在 X-Real-IP 中传递下去</strong>，后面的每一层都使用 X-Real-IP 继续往下传递。配置为：</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">  proxy_set_header X-Real-IP $remote_addr;     # 针对首层代理，拿到真实IP
  proxy_set_header X-Real-IP $http_x_real_ip;  # 针对非首层代理，一直传下去
</code></span></pre> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">
</code></span></pre> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px"><strong>2.</strong> <span style="color:rgb(51,51,51); font-family:'Microsoft YaHei'; font-size:13px; line-height:23.4px">从首层开始，<strong>将用户的真实IP 放在 X-Forwarded-For 中</strong>，<span style="color:rgb(51,51,51); font-family:'Microsoft YaHei'; font-size:13px; line-height:23.4px">后面的每一层都使用 </span></span></code></span><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px"><span style="font-family:'Microsoft YaHei'; line-height:23.4px">X-Forwarded-For</span></code></span><span style="font-family:'Microsoft YaHei'; font-size:13px; line-height:23.4px">继续往下传递。<span style="color:rgb(51,51,51); font-family:'Microsoft YaHei'; font-size:13px; line-height:23.4px">配置为：</span></span></pre> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="font-family:'Microsoft YaHei'; font-size:13px; line-height:1.8">    从首层开始，将用户的真实IP 放在 X-Forwarded-For 中，而不是累加各层服务器的 IP，但这样也不够合理，因为丢掉了整个链路信息。配置为：</span></pre> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">   proxy_set_header X-Forwarded-For $remote_addr; # 针对首层代理</code></span><span style="font-family:'Microsoft YaHei'; font-size:13px; line-height:1.8"> </span></pre> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="font-family:'Microsoft YaHei'; font-size:13px; line-height:1.8">
</span></pre> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px"></code></span><pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">  针对非首层代理，则可以用逐步累加的方法。</code></span><span style="font-family:'Microsoft YaHei'; font-size:13px; line-height:1.8">配置为：</span></pre>   proxy_set_header X-Forwarded-For $http_x_forwarded_for; # 针对非首层代理</pre> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="font-family:'Microsoft YaHei'; font-size:13px; line-height:1.8">
</span></pre> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="font-family:'Microsoft YaHei'; font-size:13px; line-height:1.8">     从 X-Forwarded-For 中获取的用户真实IP，排除掉所有代理IP，取最后一个符合IP规则的，注意不是第一个，因为第一个可能是被伪造的（除非首层代理使用了握手会话 IP 做为值向下传递）。</span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">一般CDN都会将用户的真实 IP 在XFF中传递下去。我们可以做几个简单的测试就能知道我们该怎么做。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">注意：nginx配置的这两个变量：</span><br style="margin:0px; padding:0px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">* <code style="margin:0px; padding:0px">$proxy_add_x_forwarded_for</code> 会累加代理层的IP向后传递</span><br style="margin:0px; padding:0px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">* <code style="margin:0px; padding:0px">$http_x_forwarded_for</code> 仅仅是上层传过来的值</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><br> </span></p> 
<h5 style="margin:10px 0px; padding:0px; font-size:14px; font-family:verdana,Arial,Helvetica,sans-serif; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">3.配合nginx realip模块获取用户真实IP</span></h5> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">我们应该秉承一个原则：</span></p> 
<blockquote style="margin:10px 0px; padding:5px 10px; border:2px solid rgb(239,239,239); color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> 
 <p style="margin:10px auto; padding-top:0px; padding-bottom:0px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">能通过配置让事情变的更简单和通用的事儿，就不要用程序去解决。即环境对程序透明。这当然少不了系统运维人员的辛苦。</span></p> 
</blockquote> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">如果能在配置中理清，就不必用复杂的程序去解决，因为Server上可能有各种应用都要来获取用户IP，如果规则不统一，结果会不一致。</span><br style="margin:0px; padding:0px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">程序不知道链路到底经过了几层才转到web server上，所以让程序去做兼容并不是个好主意。索性就让程序把所有的代理都当成透明的好了。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">终于说到重点了。上面介绍的三种方法中，如果不能保证前面的代理层使用我们指定的规则，这时候怎么办呢？</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">只能使用第三种方法( 即：<span style="line-height:1.8">配合 nginx realip 模块获取用户真实IP</span>)。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">我们将各层代理的IP排除在外，就取到了真实的用户IP。这个可以使用nginx的一个模块  <a target="_blank" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html" rel="nofollow noopener noreferrer" style="margin:0px; padding:0px; text-decoration:none; color:rgb(0,0,0); border-bottom-width:1px; border-bottom-style:dotted; border-bottom-color:rgb(51,51,51)">realip_module</a> 来实现。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">原理是从XFF中抛弃指定的代理层 IP，那么最后一个符合规则的就是用户 IP。也可以配合第一起方法一起使用。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">但无论如何，首层代理的规则最重要，直接影响后面的代理层和web service的接收结果。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">nginx realip_module 模块需要在编译nginx的时候加上参数<code style="margin:0px; padding:0px">--with-http_realip_module</code>。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">然后在nginx配置中增加以下配置（可以在http,server或location段中增加）</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">    # set user real ip to remote addr
    set_real_ip_from   10.200.21.0/24;
    set_real_ip_from   10.100.23.0/24;
    real_ip_header     X-Forwarded-For;
    real_ip_recursive on;
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">set_real_ip_from</code> 后面是可信 IP 规则，可以有多条。如果启用CDN，知道CDN的溯源IP，也要加进来，除排掉可信的，就是用户的真实IP，会写入 <code style="margin:0px; padding:0px">remote addr</code>这个变量中。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">比如在PHP中可以使用<code style="margin:0px; padding:0px">$_SERVER['REMOTE_ADDR']</code> 来获取。而WEB SERVER 不使用任何反向代理时，也是取这个值，这就达到了我们之前所说的原则。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">real_ip_recursive</code> 是递归的去除所配置中的可信IP。如果只有一层代理，也可以不写这个参数。</span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">然后我在外网请求一下，结果是这样的</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">[HTTP_X_FORWARDED_FOR] =&gt; unkonw, &lt;8.8.8.8&gt; 1.1.1.1, 112.193.23.51, 10.200.21.50
[REMOTE_ADDR] =&gt; 112.193.23.51
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">112.193.23.51 是 client 的 IP， 10.200.21.50 是WEB SERVER 前面的负载均衡。 真实IP拿到了。</span></p> 
<h5 style="margin:10px 0px; padding:0px; font-size:14px; font-family:verdana,Arial,Helvetica,sans-serif; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">再说下nginx日志</span></h5> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">如果nginx日志中记录了XFF，那么可能会有一些是我们不想记录的，比如我们现在使用的默认的nginx日志格式为：</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">这时候由于XFF里包含太多信息，甚至可能是一些伪造的未经过滤的文本，在使用和分析日志的时候会出现麻烦，所以我们干脆不记录它。nginx 的日志格式<code style="margin:0px; padding:0px">log_format</code>还有一个默认值<code style="margin:0px; padding:0px">“combined”</code>. 默认格式为：</span></p> 
<pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; color:rgb(51,51,51); font-size:14px; line-height:25.2px; background-color:rgb(255,255,255)"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'"><code style="margin:0px; padding:0px">log_format combined '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';
</code></span></pre> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">我们使用这个格式就好了。</span></p> 
<h4 style="margin:10px 0px; padding:0px; font-size:16px; line-height:1.5; font-family:verdana,Arial,Helvetica,sans-serif"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">总结</span></h4> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">我们建议使用以下规则：</span><br style="margin:0px; padding:0px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">* <span style="margin:0px; padding:0px">首层代理将握手 IP 附在 X-Forwarded-For 上一直向后传递（或者将 X-Forwarded-For 设置为握手 IP 向后传递），后面的每一层累加握手 IP 往后传递。</span></span><br style="margin:0px; padding:0px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">* <span style="margin:0px; padding:0px">首层代理将握手 IP 设置为 HTTP 请求头的 X-Real-IP 中向后传递。后面的每一层原样传递下去（有则原样传递，无则设置为握手 IP ）。</span></span></p> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">握手IP：即请求方的 remote_addr.</span></p> 
<blockquote style="margin:10px 0px; padding:5px 10px; border:2px solid rgb(239,239,239); color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> 
 <p style="margin:10px auto; padding-top:0px; padding-bottom:0px"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">运维很重要，首个代理层的处理方式很重要。</span></p> 
</blockquote> 
<p style="margin:10px auto; padding-top:0px; padding-bottom:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">在只有运维最清楚网络环境的时候，尽量通过配置对应用透明。减少应用层的复杂判断。如果环境很复杂，比如使用了CDN，则有可能需要多方协调。</span></p> 
<h4 style="margin:10px 0px; padding:0px; font-size:16px; line-height:1.5; font-family:verdana,Arial,Helvetica,sans-serif"> <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">参考资料</span></h4> 
<div> 
 <span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">           http://tomcat.apache.org/tomcat-7.0-doc/config/valve.html<br> </span> 
</div> 
<ul style="margin:0px 0px 0px 30px; padding:0px; color:rgb(51,51,51); font-family:verdana,Arial,Helvetica,sans-serif; font-size:14px; line-height:25.2px"><li><ul style="margin:0px 0px 0px 30px; padding:0px"><li style="margin:0px; padding:0px; list-style:disc"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">http://nginx.org/en/docs/http/ngx_http_realip_module.html</span></li><li style="margin:0px; padding:0px; list-style:disc"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">https://www.zhihu.com/question/23810075</span></li><li style="margin:0px; padding:0px; list-style:disc"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">http://www.cnblogs.com/zhengyun_ustc/archive/2012/09/19/getremoteaddr.html</span></li><li style="margin:0px; padding:0px; list-style:disc"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">http://zhensheng.im/2013/08/31/1952/MIAO_LE_GE_MI</span></li><li style="margin:0px; padding:0px; list-style:disc"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">http://stackoverflow.com/questions/25929599</span></li><li style="margin:0px; padding:0px; list-style:disc"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">http://www.ttlsa.com/nginx/nginx-get-user-real-ip/</span></li><li style="margin:0px; padding:0px; list-style:disc"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">https://imququ.com/post/x-forwarded-for-header-in-http.html</span></li><li style="margin:0px; padding:0px; list-style:disc"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">http://freeloda.blog.51cto.com/2033581/1288553</span></li><li style="margin:0px; padding:0px; list-style:disc"><span style="margin:0px; padding:0px; line-height:1.8; font-size:13px; font-family:'Microsoft YaHei'">http://nginx.org/en/docs/http/ngx_http_log_module.html</span></li></ul> 
</li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2739daec2af4371ab34f1ba281ba236c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Exception in thread &#34;main&#34; java.lang.IncompatibleClassChangeError: Found interface com.mysql.jdbc.Co</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/917cff5ef0ccbb7c9ea3af83254e9221/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">js中substring方法的详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>