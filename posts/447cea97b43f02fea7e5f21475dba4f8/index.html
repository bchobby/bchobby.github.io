<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 9 (P)非SDK API限制调用开发指南 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 9 (P)非SDK API限制调用开发指南" />
<meta property="og:description" content="Android 9 (P)非SDK API限制调用开发指南 Android 9 (P)开发适配指南系列博客目录：
Adnroid 9 (P) recovery升级Map of &#39;@/cache/recovery/block.map’failed问题分析指南
Android 9 (P)版本解决VNDK library: XXX’s ABI has EXTENDING CHANGES
Android 9 (P)非SDK API限制调用开发指南
Android 9 (P)适配以太网功能开发指南
Android 9 (P)在user模式下无法使用fastboot烧录怎么破
Android 9 (P)静默安装/卸载App适配终极指南
引言 有过Android开发经验的童鞋应该知道，每一次Android大版本的升级，往往会有大量的APP出现兼容性问题，导致这个情况的主要原因是由于APP的热修复以及依赖Android internal API(内部API)，也就是非SDK API。这些API是指标记@hide的类、方法以及字段，它们不属于官方Android SDK的字段与函数(当然这其中也包括一些废旧SDK的使用,这个不是本篇讨论的重点)。
非SDK接口指不在官方Android SDK涵盖范围内的 Java 字段和方法。此类接口是 SDK 的内部实现细节，可能随时会被修改，且不对开发者另行通知。 Google希望未来Android大版本升级，APP都能正常运行，而很多APP对内部API的调用通过反射或JNI间接调用的方法来调用，破坏兼容性。 为此Google从Android P开始限制对内部API的使用，继续使用则抛出如下异常。
Google在Android P版本上对隐藏的Java API进行了一定的限制，后续版本会逐步的完善限制。App侧通过反射等方式调用的Java API将会有很多限制，对于Android应用想再搞一些插件化之类的黑科技便是带着脚手铐跳舞，即便能跳但舞姿已不太优雅了。这也是为了Android 生态在未来更好的发展。真是为难了谷歌妈咪为了Android的和谐发展所做的努力。
Android 7.0对Native的NDK的调用限制是手铐，而Android 9.0对Java层SDK的调用限制就是脚铐。脚铐手铐同时上，为了Android碎片化的整理真是操作了心啊。
注意：本文是以Android 9源码为基础来说明Android P对非SDK API调用开发指南。
libcore/ojluni/src/main/java/java/lang/Class.java art/runtime/native/java_lang_Class.cc art/runtime/hidden_api.h art/runtime/runtime.h art/libdexfile/dex/hidden_api_access_flags.h art/runtime/hidden_api.cc art/runtime/art_method-inl.h frameworks/base/core/java/android/content/pm/ApplicationInfo." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/447cea97b43f02fea7e5f21475dba4f8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-03T21:34:50+08:00" />
<meta property="article:modified_time" content="2020-07-03T21:34:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 9 (P)非SDK API限制调用开发指南</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="font_faceCourier_New_emspemsp_emspAndroid_9_PSDK_API_0"></a><font face="Courier New">     Android 9 (P)非SDK API限制调用开发指南</font></h2> 
<br> 
<p><font size="4" face="Courier New">Android 9 (P)开发适配指南系列博客目录：</font></p> 
<blockquote> 
 <p><a href="https://editor.csdn.net/md/?articleId=106101317" rel="nofollow"><font size="3" face="Courier New">Adnroid 9 (P) recovery升级Map of '@/cache/recovery/block.map’failed问题分析指南</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/105834911"><font size="3" face="Courier New">Android 9 (P)版本解决VNDK library: XXX’s ABI has EXTENDING CHANGES</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/105784784"><font size="3" face="Courier New">Android 9 (P)非SDK API限制调用开发指南</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/105725133"><font size="3" face="Courier New">Android 9 (P)适配以太网功能开发指南</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/105585704"><font size="3" face="Courier New">Android 9 (P)在user模式下无法使用fastboot烧录怎么破</font></a><br> <a href="https://blog.csdn.net/tkwxty/article/details/104947245"><font size="3" face="Courier New">Android 9 (P)静默安装/卸载App适配终极指南</font></a></p> 
</blockquote> 
<hr> 
<br> 
<h3><a id="font_faceCourier_New_18"></a><font face="Courier New">引言</font></h3> 
<p><font face="Courier New">   有过Android开发经验的童鞋应该知道，每一次Android大版本的升级，往往会有大量的APP出现兼容性问题，导致这个情况的主要原因是由于APP的热修复以及依赖Android internal API(内部API)，也就是非SDK API。这些API是指标记@hide的类、方法以及字段，它们不属于官方Android SDK的字段与函数(当然这其中也包括一些废旧SDK的使用,这个不是本篇讨论的重点)。</font></p> 
<ul><li><font face="Courier New"> 非SDK接口指不在官方Android SDK涵盖范围内的 Java 字段和方法。此类接口是 SDK 的内部实现细节，可能随时会被修改，且不对开发者另行通知。</font></li></ul> 
<p><font face="Courier New">Google希望未来Android大版本升级，APP都能正常运行，而很多APP对内部API的调用通过反射或JNI间接调用的方法来调用，破坏兼容性。 为此Google从Android P开始限制对内部API的使用，继续使用则抛出如下异常。<br> <img src="https://images2.imgbox.com/54/c3/oiDrGWq3_o.png" alt="在这里插入图片描述"><br> <font face="Courier New">Google在Android P版本上对隐藏的Java API进行了一定的限制，后续版本会逐步的完善限制。App侧通过反射等方式调用的Java API将会有很多限制，对于Android应用想再搞一些插件化之类的黑科技便是带着脚手铐跳舞，即便能跳但舞姿已不太优雅了。这也是为了Android 生态在未来更好的发展。真是为难了谷歌妈咪为了Android的和谐发展所做的努力。</font></font></p> 
<p><font face="Courier New">Android 7.0对Native的NDK的调用限制是手铐，而Android 9.0对Java层SDK的调用限制就是脚铐。脚铐手铐同时上，为了Android碎片化的整理真是操作了心啊。</font></p> 
<p><font face="Courier New"><strong>注意</strong>：本文是以Android 9源码为基础来说明Android P对非SDK API调用开发指南。</font></p> 
<pre><code class="prism language-bash">libcore/ojluni/src/main/java/java/lang/Class.java
art/runtime/native/java_lang_Class.cc
art/runtime/hidden_api.h
art/runtime/runtime.h
art/libdexfile/dex/hidden_api_access_flags.h
art/runtime/hidden_api.cc
art/runtime/art_method-inl.h
frameworks/base/core/java/android/content/pm/ApplicationInfo.java
libcore/libart/src/main/java/dalvik/system/VMRuntime.java
</code></pre> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_New_49"></a><font face="Courier New">一.实例演示</font></h3> 
<p><font face="Courier New">说一千道一万，首先让我们来一个实例演示一番，这样给大伙有一个直观的感受不是。</font></p> 
<br> 
<h4><a id="font_faceCourier_New11__55"></a><font face="Courier New">1.1 实例代码</font></h4> 
<p><font face="Courier New">这里我们以VMRuntime类来说明，其中有一个本地方法如下：</font></p> 
<pre><code class="prism language-java"><span class="token comment">//VMRuntime.java</span>
    <span class="token comment">/** 
     * Sets the list of exemptions from hidden API access enforcement.
     *
     * @param signaturePrefixes
     *         A list of signature prefixes. Each item in the list is a prefix match on the type
     *         signature of a blacklisted API. All matching APIs are treated as if they were on
     *         the whitelist: access permitted, and no logging..
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">setHiddenApiExemptions</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> signaturePrefixes<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p><font face="Courier New">通过反射调用该方法：</font></p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">useHideFun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"HIDE"</span><span class="token punctuation">,</span> <span class="token string">"START"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> VMRuntimeClass <span class="token operator">=</span> null<span class="token punctuation">;</span>
            VMRuntimeClass <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"dalvik.system.VMRuntime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> test <span class="token operator">=</span> null<span class="token punctuation">;</span>
            Method setHiddenApiExemptionsMethod <span class="token operator">=</span> VMRuntimeClass
                    <span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"setHiddenApiExemptions"</span><span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            setHiddenApiExemptionsMethod<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">"HIDE"</span><span class="token punctuation">,</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// TODO Auto-generated catch block</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// TODO Auto-generated catch block</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre> 
<br> 
<h4><a id="font_faceCourier_New12__101"></a><font face="Courier New">1.2 运行实例</font></h4> 
<p><font face="Courier New">我们运行一把，其中明显实体不能访问hiden method，这就是Android P对非SDK API的调用的限制。<br> <img src="https://images2.imgbox.com/51/ee/4bIQg3Jf_o.png" alt="在这里插入图片描述"></font></p> 
<pre><code class="prism language-bash">04-27 14:27:03.468  5933  5933 W om.example.tes: Accessing hidden method Ldalvik/system/VMRuntime<span class="token punctuation">;</span>-<span class="token operator">&gt;</span>setHiddenApiExemptions<span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span><span class="token punctuation">)</span>V <span class="token punctuation">(</span>blacklist, reflection<span class="token punctuation">)</span>
04-27 14:27:03.468   683   683 I ConfigStore: android::hardware::configstore::V1_0::ISurfaceFlingerConfigs::hasHDRDisplay retrieved: 0
04-27 14:27:03.469   683   683 I ConfigStore: android::hardware::configstore::V1_0::ISurfaceFlingerConfigs::hasHDRDisplay retrieved: 0
04-27 14:27:03.469  5933  5933 W System.err: java.lang.NoSuchMethodException: setHiddenApiExemptions <span class="token punctuation">[</span>class <span class="token punctuation">[</span>Ljava.lang.String<span class="token punctuation">;</span><span class="token punctuation">]</span>
04-27 14:27:03.469   683   683 I ConfigStore: android::hardware::configstore::V1_0::ISurfaceFlingerConfigs::hasHDRDisplay retrieved: 0
04-27 14:27:03.469  5933  5933 W System.err:    at java.lang.Class.getMethod<span class="token punctuation">(</span>Class.java:2068<span class="token punctuation">)</span>
04-27 14:27:03.470  5933  5933 W System.err:    at java.lang.Class.getDeclaredMethod<span class="token punctuation">(</span>Class.java:2047<span class="token punctuation">)</span>
04-27 14:27:03.470  5933  5933 W System.err:    at com.example.test.MainActivity.getProperty<span class="token punctuation">(</span>MainActivity.java:68<span class="token punctuation">)</span>
04-27 14:27:03.470  5933  5933 W System.err:    at com.example.test.MainActivity.onCreate<span class="token punctuation">(</span>MainActivity.java:27<span class="token punctuation">)</span>
04-27 14:27:03.471  5933  5933 W System.err:    at android.app.Activity.performCreate<span class="token punctuation">(</span>Activity.java:7144<span class="token punctuation">)</span>
04-27 14:27:03.471  5933  5933 W System.err:    at android.app.Activity.performCreate<span class="token punctuation">(</span>Activity.java:7135<span class="token punctuation">)</span>
04-27 14:27:03.471  5933  5933 W System.err:    at android.app.Instrumentation.callActivityOnCreate<span class="token punctuation">(</span>Instrumentation.java:1272<span class="token punctuation">)</span>
04-27 14:27:03.472  5933  5933 W System.err:    at android.app.ActivityThread.performLaunchActivity<span class="token punctuation">(</span>ActivityThread.java:2932<span class="token punctuation">)</span>
04-27 14:27:03.472  5933  5933 W System.err:    at android.app.ActivityThread.handleLaunchActivity<span class="token punctuation">(</span>ActivityThread.java:3087<span class="token punctuation">)</span>
04-27 14:27:03.473  5933  5933 W System.err:    at android.app.servertransaction.LaunchActivityItem.execute<span class="token punctuation">(</span>LaunchActivityItem.java:78<span class="token punctuation">)</span>
04-27 14:27:03.473  5933  5933 W System.err:    at android.app.servertransaction.TransactionExecutor.executeCallbacks<span class="token punctuation">(</span>TransactionExecutor.java:108<span class="token punctuation">)</span>
04-27 14:27:03.475  5933  5933 W System.err:    at android.app.servertransaction.TransactionExecutor.execute<span class="token punctuation">(</span>TransactionExecutor.java:68<span class="token punctuation">)</span>
04-27 14:27:03.475  5933  5933 W System.err:    at android.app.ActivityThread<span class="token variable">$H</span>.handleMessage<span class="token punctuation">(</span>ActivityThread.java:1817<span class="token punctuation">)</span>
04-27 14:27:03.476  5933  5933 W System.err:    at android.os.Handler.dispatchMessage<span class="token punctuation">(</span>Handler.java:106<span class="token punctuation">)</span>
04-27 14:27:03.476  5933  5933 W System.err:    at android.os.Looper.loop<span class="token punctuation">(</span>Looper.java:193<span class="token punctuation">)</span>
04-27 14:27:03.476  5933  5933 W System.err:    at android.app.ActivityThread.main<span class="token punctuation">(</span>ActivityThread.java:6746<span class="token punctuation">)</span>
04-27 14:27:03.476  5933  5933 W System.err:    at java.lang.reflect.Method.invoke<span class="token punctuation">(</span>Native Method<span class="token punctuation">)</span>
04-27 14:27:03.477  5933  5933 W System.err:    at com.android.internal.os.RuntimeInit<span class="token variable">$MethodAndArgsCaller</span>.run<span class="token punctuation">(</span>RuntimeInit.java:493<span class="token punctuation">)</span>
04-27 14:27:03.477  5933  5933 W System.err:    at com.android.internal.os.ZygoteInit.main<span class="token punctuation">(</span>ZygoteInit.java:858<span class="token punctuation">)</span>
</code></pre> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_New_139"></a><font face="Courier New">二.源码分析</font></h3> 
<p><font face="Courier New">在正式开发分析前，先奉上源码分析流程图，这样有一个整体的轮廓认识。<br> <img src="https://images2.imgbox.com/80/bd/izj0Z6fh_o.png" alt="在这里插入图片描述"></font></p> 
<br> 
<h4><a id="font_faceCourier_New21_getDeclaredMethod_145"></a><font face="Courier New">2.1 getDeclaredMethod</font></h4> 
<p><font face="Courier New">通过前面的实例我们可以看到，我们是在调用getDeclaredMethod的过程中失败了，所以我们先大胆的猜测一定是Android P在getDeclaredMethod的调用过程中做了限制，然后导致反射失败了。让我们大胆验证，小心求证。先从Class.java开始分析。</font></p> 
<pre><code class="prism language-java"><span class="token comment">//Class.java</span>
    <span class="token annotation punctuation">@CallerSensitive</span>
    <span class="token keyword">public</span> Method <span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> parameterTypes<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> NoSuchMethodException<span class="token punctuation">,</span> SecurityException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">getMethod</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parameterTypes<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//见2.2</span>
    <span class="token punctuation">}</span>
</code></pre> 
<br> 
<h4><a id="font_faceCourier_New22_getMethod_160"></a><font face="Courier New">2.2 getMethod</font></h4> 
<pre><code class="prism language-java"><span class="token comment">//Class.java</span>
    <span class="token keyword">private</span> Method <span class="token function">getMethod</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterTypes<span class="token punctuation">,</span> <span class="token keyword">boolean</span> recursivePublicMethods<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NoSuchMethodException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//判断方法名是否为空</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"name == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parameterTypes <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//判断参数是否为空</span>
            parameterTypes <span class="token operator">=</span> EmptyArray<span class="token punctuation">.</span>CLASS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> c <span class="token operator">:</span> parameterTypes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">(</span><span class="token string">"parameter type is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//一切条件满足且是非public方法，则执行getDeclaredMethodInternal方法，具体见2.3</span>
        Method result <span class="token operator">=</span> recursivePublicMethods <span class="token operator">?</span> <span class="token function">getPublicMethodRecursive</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parameterTypes<span class="token punctuation">)</span>
                                               <span class="token operator">:</span> <span class="token function">getDeclaredMethodInternal</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parameterTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Fail if we didn't find the method or it was expected to be public.</span>
        <span class="token comment">//如果没有找到，则抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null <span class="token operator">||</span>
            <span class="token punctuation">(</span>recursivePublicMethods <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Modifier<span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getAccessFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>parameterTypes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<br> 
<h4><a id="font_faceCourier_New23_getDeclaredMethodInternal_194"></a><font face="Courier New">2.3 getDeclaredMethodInternal</font></h4> 
<pre><code class="prism language-java"><span class="token comment">//Class.java</span>
    <span class="token comment">/**
     * Returns the method if it is defined by this class; {@code null} otherwise. This may return a
     * non-public member.
     *      
     * @param name the method name
     * @param args the method's parameter types
     */</span>     
    <span class="token annotation punctuation">@FastNative</span> 
    <span class="token keyword">private</span> <span class="token keyword">native</span> Method <span class="token function">getDeclaredMethodInternal</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p><font face="Courier New">这是一个Java本地方法，最终通过JNI调用到art/runtime/native/java_lang_Class.cc里面，如下：</font></p> 
<pre><code class="prism language-c"><span class="token comment">//native/java_lang_Class.cc</span>
<span class="token keyword">static</span> jobject <span class="token function">Class_getDeclaredMethodInternal</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject javaThis<span class="token punctuation">,</span>
                                               jstring name<span class="token punctuation">,</span> jobjectArray args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  ScopedFastNativeObjectAccess <span class="token function">soa</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
  StackHandleScope<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token function">hs</span><span class="token punctuation">(</span>soa<span class="token punctuation">.</span><span class="token function">Self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">DCHECK_EQ</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetClassLinker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetImagePointerSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kRuntimePointerSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">DCHECK</span><span class="token punctuation">(</span><span class="token operator">!</span>Runtime<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">IsActiveTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Handle<span class="token operator">&lt;</span>mirror<span class="token punctuation">:</span><span class="token punctuation">:</span>Method<span class="token operator">&gt;</span> result <span class="token operator">=</span> hs<span class="token punctuation">.</span><span class="token function">NewHandle</span><span class="token punctuation">(</span>
      mirror<span class="token punctuation">:</span><span class="token punctuation">:</span>Class<span class="token punctuation">:</span><span class="token punctuation">:</span>GetDeclaredMethodInternal<span class="token operator">&lt;</span>kRuntimePointerSize<span class="token punctuation">,</span> false<span class="token operator">&gt;</span><span class="token punctuation">(</span>
          soa<span class="token punctuation">.</span><span class="token function">Self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">DecodeClass</span><span class="token punctuation">(</span>soa<span class="token punctuation">,</span> javaThis<span class="token punctuation">)</span><span class="token punctuation">,</span>
          soa<span class="token punctuation">.</span>Decode<span class="token operator">&lt;</span>mirror<span class="token punctuation">:</span><span class="token punctuation">:</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
          soa<span class="token punctuation">.</span>Decode<span class="token operator">&lt;</span>mirror<span class="token punctuation">:</span><span class="token punctuation">:</span>ObjectArray<span class="token operator">&lt;</span>mirror<span class="token punctuation">:</span><span class="token punctuation">:</span>Class<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">检测该方法是否允许访问</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> nullptr <span class="token operator">||</span> <span class="token function">ShouldBlockAccessToMember</span><span class="token punctuation">(</span>result<span class="token operator">-&gt;</span><span class="token function">GetArtMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> soa<span class="token punctuation">.</span><span class="token function">Self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> soa<span class="token punctuation">.</span>AddLocalReference<span class="token operator">&lt;</span>jobject<span class="token operator">&gt;</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><font face="Courier New">这个地方是关键，我们来看一下Android 9和Android 8相比做了哪些修改。下图中左边是Android 9，右边是Android 8：<br> <img src="https://images2.imgbox.com/28/63/lYonkRfJ_o.png" alt="在这里插入图片描述"><br> <font face="Courier New">是不是一下就看出来了，Android 的代码在反射时候会增加一个ShouldBlockAccessToMember()判断，如果返回true,那么你在getDeclaredMethod()时候就会得到null。如果你的Rom不想限制客户的API反射调用的话，就可以屏蔽这个地方即可。</font></font></p> 
<br> 
<h4><a id="font_faceCourier_New24_ShouldBlockAccessToMember_241"></a><font face="Courier New">2.4 ShouldBlockAccessToMember</font></h4> 
<pre><code class="prism language-c">template<span class="token operator">&lt;</span>typename T<span class="token operator">&gt;</span>
ALWAYS_INLINE <span class="token keyword">static</span> bool <span class="token function">ShouldBlockAccessToMember</span><span class="token punctuation">(</span>T<span class="token operator">*</span> member<span class="token punctuation">,</span> Thread<span class="token operator">*</span> self<span class="token punctuation">)</span>
    <span class="token function">REQUIRES_SHARED</span><span class="token punctuation">(</span>Locks<span class="token punctuation">:</span><span class="token punctuation">:</span>mutator_lock_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
  hiddenapi<span class="token punctuation">:</span><span class="token punctuation">:</span>Action action <span class="token operator">=</span> hiddenapi<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">GetMemberAction</span><span class="token punctuation">(</span> <span class="token comment">// 获取的action的类型是重点</span>
      member<span class="token punctuation">,</span> self<span class="token punctuation">,</span> IsCallerTrusted<span class="token punctuation">,</span> hiddenapi<span class="token punctuation">:</span><span class="token punctuation">:</span>kReflection<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// kReflection : 反射方式调用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">!=</span> hiddenapi<span class="token punctuation">:</span><span class="token punctuation">:</span>kAllow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    hiddenapi<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">NotifyHiddenApiListener</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当不是kAllow时,则需要警告或者弹窗,则通过此方法通知</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> action <span class="token operator">==</span> hiddenapi<span class="token punctuation">:</span><span class="token punctuation">:</span>kDeny<span class="token punctuation">;</span> <span class="token comment">// 返回true则被限制,也就是当action是kAllow/kAllowButWarn/kAllowButWarnAndToast返回false,都是允许accessmember的</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><font face="Courier New">让我们来重点分析一下这个函数，这个地方就是反射接口限制判断的地方，此处的入参参数AccessMethod access_method等于hiddenapi::kReflection，除此之外还有其他几种模式，如下:</font></p> 
<h5><a id="font_faceCourier_New_241_AccessMethod_262"></a><font face="Courier New"> 2.4.1 AccessMethod</font></h5> 
<blockquote> 
 <p><font face="Courier New">hidden_api.h</font></p> 
</blockquote> 
<pre><code class="prism language-cpp"><span class="token comment">// Hidden API enforcement policy</span>
<span class="token comment">// This must be kept in sync with ApplicationInfo.ApiEnforcementPolicy in</span>
<span class="token comment">// frameworks/base/core/java/android/content/pm/ApplicationInfo.java</span>
<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">EnforcementPolicy</span> <span class="token punctuation">{<!-- --></span>
  kNoChecks             <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  kJustWarn             <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// keep checks enabled, but allow everything (enables logging)</span>
  kDarkGreyAndBlackList <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token comment">// ban dark grey &amp; blacklist</span>
  kBlacklistOnly        <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token comment">// ban blacklist violations only</span>
  kMax <span class="token operator">=</span> kBlacklistOnly<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">enum</span> Action <span class="token punctuation">{<!-- --></span>
  kAllow<span class="token punctuation">,</span>    <span class="token comment">//允许</span>
  kAllowButWarn<span class="token punctuation">,</span>   <span class="token comment">//允许 + 警告</span>
  kAllowButWarnAndToast<span class="token punctuation">,</span>  <span class="token comment">//允许+警告+弹窗</span>
  kDeny		<span class="token comment">//阻止</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">enum</span> AccessMethod <span class="token punctuation">{<!-- --></span>
  kNone<span class="token punctuation">,</span>  			<span class="token comment">//测试模式，不会出现在实际场景访问权限</span>
  kReflection<span class="token punctuation">,</span>		<span class="token comment">//Java发射调用</span>
  kJNI<span class="token punctuation">,</span>				<span class="token comment">//JNI调用过程</span>
  kLinking<span class="token punctuation">,</span>			<span class="token comment">//动态链接过程</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="font_faceCourier_New_241__294"></a><font face="Courier New"> 2.4.1 各种限制场景分析</font></h5> 
<p><font face="Courier New"> 通过前面的篇章我们知道ShouldBlockAccessToMember是限制内部API访问的最核心代码，让我们对其限制的几种模式一一分析：</font></p> 
<ul><li> <p><font face="Courier New"> kReflection反射过程<br> <font face="Courier New">Class_newInstance：对象实例化<br> <font face="Courier New">Class_getDeclaredConstructorInternal：构造方法<br> <font face="Courier New">Class_getDeclaredMethodInternal：获取方法<br> <font face="Courier New">Class_getDeclaredField：获取字段<br> <font face="Courier New">Class_getPublicFieldRecursive：获取字段</font></font></font></font></font></font></p> </li><li> <p><font face="Courier New"> kJNI的JNI调用过程<br> <font face="Courier New">FindMethodID：查找方法<br> <font face="Courier New">FindFieldID：查找字段</font></font></font></p> </li><li> <p><font face="Courier New"> kJNI的JNI调用过程<br> <font face="Courier New">UnstartedClassNewInstance<br> <font face="Courier New">UnstartedClassGetDeclaredConstructor<br> <font face="Courier New">UnstartedClassGetDeclaredMethod<br> <font face="Courier New">UnstartedClassGetDeclaredField</font></font></font></font></font></p> </li></ul> 
<br> 
<h4><a id="font_faceCourier_New25_GetMemberAction_316"></a><font face="Courier New">2.5 GetMemberAction</font></h4> 
<blockquote> 
 <p><font face="Courier New">hidden_api.h</font></p> 
</blockquote> 
<pre><code class="prism language-c">template<span class="token operator">&lt;</span>typename T<span class="token operator">&gt;</span>
<span class="token comment">这里的Action就是允许,警告,弹窗,阻止其中的一种</span>
<span class="token keyword">inline</span> Action <span class="token function">GetMemberAction</span><span class="token punctuation">(</span>T<span class="token operator">*</span> member<span class="token punctuation">,</span>
                              Thread<span class="token operator">*</span> self<span class="token punctuation">,</span>
                              std<span class="token punctuation">:</span><span class="token punctuation">:</span>function<span class="token operator">&lt;</span><span class="token function">bool</span><span class="token punctuation">(</span>Thread<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> fn_caller_is_trusted<span class="token punctuation">,</span>
                              AccessMethod access_method<span class="token punctuation">)</span>
    <span class="token function">REQUIRES_SHARED</span><span class="token punctuation">(</span>Locks<span class="token punctuation">:</span><span class="token punctuation">:</span>mutator_lock_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//获取hidenn API的可访问标识</span>
  <span class="token comment">// HiddenApiAccessFlags 定义在 hidden_api_access_flags.h 白名单 浅灰名单 深灰名单 黑名单</span>
  HiddenApiAccessFlags<span class="token punctuation">:</span><span class="token punctuation">:</span>ApiList api_list <span class="token operator">=</span> member<span class="token operator">-&gt;</span><span class="token function">GetHiddenApiAccessFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//获取相应的访问行为【小节2.6】</span>
  Action action <span class="token operator">=</span> <span class="token function">GetActionFromAccessFlags</span><span class="token punctuation">(</span>member<span class="token operator">-&gt;</span><span class="token function">GetHiddenApiAccessFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> kAllow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//允许则直接返回</span>
    <span class="token keyword">return</span> action<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

   <span class="token comment">//检测是否平台调用，通过函数指针调用到IsCallerTrusted函数【小节2.7】</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fn_caller_is_trusted</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> kAllow<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//对于hidden接口，且非平台调用【小节2.8】</span>
  <span class="token keyword">return</span> detail<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">GetMemberActionImpl</span><span class="token punctuation">(</span>member<span class="token punctuation">,</span> api_list<span class="token punctuation">,</span> action<span class="token punctuation">,</span> access_method<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">此方法里有三处要分析，分别是：</font></p> 
<ul><li><font face="Courier New">当Action=kAllow，则直接返回；否则执行如下：</font></li><li><font face="Courier New">通过fn_caller_is_trusted看当前是否是系统调用的，如果是系统调用则返回，否则执行如下：</font></li><li><font face="Courier New">通过GetMemberActionImpl()做进一步判断</font></li></ul> 
<p><font face="Courier New">在分析上面三个方法之前先来看看HiddenApiAccessFlags 的定义如下：</font></p> 
<blockquote> 
 <p>. <font face="Courier New"> art/libdexfile/dex/hidden_api_access_flags.h</font></p> 
</blockquote> 
<pre><code class="prism language-c">class HiddenApiAccessFlags <span class="token punctuation">{<!-- --></span>
 public<span class="token punctuation">:</span>
  <span class="token keyword">enum</span> ApiList <span class="token punctuation">{<!-- --></span>
    kWhitelist <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">//白名单</span>
    kLightGreylist<span class="token punctuation">,</span> <span class="token comment">// 浅灰名单</span>
    kDarkGreylist<span class="token punctuation">,</span>  <span class="token comment">// 深灰名单</span>
    kBlacklist<span class="token punctuation">,</span>     <span class="token comment">// 黑名单</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre> 
<p><font face="Courier New">这几个名单的定义如下：</font></p> 
<ul><li> <p><font face="Courier New">白名单：SDK 本身</font></p> </li><li> <p><font face="Courier New">浅灰名单：仍允许调用的非 SDK 方法和字段</font></p> </li><li> <p><font face="Courier New">深灰名单</font></p> <p><font face="Courier New"> – 若应用的 target SDK 低于 Android P (即 targetSdkVersion &lt;28)：允许调用深灰名单中的接</font></p> <p><font face="Courier New"> – 若应用的 target SDK 为 Android P 或更高 (即 targetSdkVersion &gt;= 28)：深灰名单与黑名单的限制相同</font></p> </li><li> <p><font face="Courier New">黑名单：不论 target SDK 版本为多少，所有应用均不允许调用黑名单接口。对开发者来说，相当于系统里不存在这些接口。比如，当应用试图调用此类接口时，系统会抛出 NoSuchMethodError / NoSuchFieldException 异常，并且在应用获取特定类的字段和方法列表时，不在返回列表中包含此类接口。</font></p> </li></ul> 
<br> 
<h4><a id="font_faceCourier_New26_GetActionFromAccessFlags_383"></a><font face="Courier New">2.6 GetActionFromAccessFlags</font></h4> 
<p><font face="Courier New">先看GetActionFromAccessFlags(member-&gt;GetHiddenApiAccessFlags()),要先分析member-&gt;GetHiddenApiAccessFlags.</font></p> 
<blockquote> 
 <p>art_method-inl.h</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">inline</span> HiddenApiAccessFlags<span class="token punctuation">:</span><span class="token punctuation">:</span>ApiList ArtMethod<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">GetHiddenApiAccessFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">REQUIRES_SHARED</span><span class="token punctuation">(</span>Locks<span class="token punctuation">:</span><span class="token punctuation">:</span>mutator_lock_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">UNLIKELY</span><span class="token punctuation">(</span><span class="token function">IsIntrinsic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>static_cast<span class="token operator">&lt;</span>Intrinsics<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">GetIntrinsic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kSystemArrayCopyChar<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kStringGetCharsNoCheck<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kReferenceGetReferent<span class="token punctuation">:</span>
        <span class="token comment">// These intrinsics are on the light greylist and will fail a DCHECK in</span>
        <span class="token comment">// SetIntrinsic() if their flags change on the respective dex methods.</span>
        <span class="token comment">// Note that the DCHECK currently won't fail if the dex methods are</span>
        <span class="token comment">// whitelisted, e.g. in the core image (b/77733081). As a result, we</span>
        <span class="token comment">// might print warnings but we won't change the semantics.</span>
        <span class="token keyword">return</span> HiddenApiAccessFlags<span class="token punctuation">:</span><span class="token punctuation">:</span>kLightGreylist<span class="token punctuation">;</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleFullFence<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleAcquireFence<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleReleaseFence<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleLoadLoadFence<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleStoreStoreFence<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleCompareAndExchange<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleCompareAndExchangeAcquire<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleCompareAndExchangeRelease<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleCompareAndSet<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGet<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAcquire<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndAdd<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndAddAcquire<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndAddRelease<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndBitwiseAnd<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndBitwiseAndAcquire<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndBitwiseAndRelease<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndBitwiseOr<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndBitwiseOrAcquire<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndBitwiseOrRelease<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndBitwiseXor<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndBitwiseXorAcquire<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndBitwiseXorRelease<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndSet<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndSetAcquire<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetAndSetRelease<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetOpaque<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleGetVolatile<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleSet<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleSetOpaque<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleSetRelease<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleSetVolatile<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleWeakCompareAndSet<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleWeakCompareAndSetAcquire<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleWeakCompareAndSetPlain<span class="token punctuation">:</span>
      <span class="token keyword">case</span> Intrinsics<span class="token punctuation">:</span><span class="token punctuation">:</span>kVarHandleWeakCompareAndSetRelease<span class="token punctuation">:</span>
        <span class="token comment">// These intrinsics are on the blacklist and will fail a DCHECK in</span>
        <span class="token comment">// SetIntrinsic() if their flags change on the respective dex methods.</span>
        <span class="token comment">// Note that the DCHECK currently won't fail if the dex methods are</span>
        <span class="token comment">// whitelisted, e.g. in the core image (b/77733081). Given that they are</span>
        <span class="token comment">// exclusively VarHandle intrinsics, they should not be used outside</span>
        <span class="token comment">// tests that do not enable hidden API checks.</span>
        <span class="token keyword">return</span> HiddenApiAccessFlags<span class="token punctuation">:</span><span class="token punctuation">:</span>kBlacklist<span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token comment">// Remaining intrinsics are public API. We DCHECK that in SetIntrinsic().</span>
        <span class="token keyword">return</span> HiddenApiAccessFlags<span class="token punctuation">:</span><span class="token punctuation">:</span>kWhitelist<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> HiddenApiAccessFlags<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">DecodeFromRuntime</span><span class="token punctuation">(</span><span class="token function">GetAccessFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">GetHiddenApiAccessFlags()获取相应的flag,接着看GetActionFromAccessFlags:</font></p> 
<blockquote> 
 <p><font face="Courier New">hidden_api.h</font></p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">inline</span> Action <span class="token function">GetActionFromAccessFlags</span><span class="token punctuation">(</span>HiddenApiAccessFlags<span class="token punctuation">:</span><span class="token punctuation">:</span>ApiList api_list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>api_list <span class="token operator">==</span> HiddenApiAccessFlags<span class="token punctuation">:</span><span class="token punctuation">:</span>kWhitelist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> kAllow<span class="token punctuation">;</span>   <span class="token comment">//位于白名单，则允许访问</span>
  <span class="token punctuation">}</span>

  EnforcementPolicy policy <span class="token operator">=</span> Runtime<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetHiddenApiEnforcementPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>policy <span class="token operator">==</span> EnforcementPolicy<span class="token punctuation">:</span><span class="token punctuation">:</span>kNoChecks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> kAllow<span class="token punctuation">;</span>  <span class="token comment">//非强制执行策略，则允许访问</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>policy <span class="token operator">==</span> EnforcementPolicy<span class="token punctuation">:</span><span class="token punctuation">:</span>kJustWarn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> kAllowButWarn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">//执行到这，policy&gt;=kDarkGreyAndBlackList</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>static_cast<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>policy<span class="token punctuation">)</span> <span class="token operator">&gt;</span> static_cast<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>api_list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> api_list <span class="token operator">==</span> HiddenApiAccessFlags<span class="token punctuation">:</span><span class="token punctuation">:</span>kDarkGreylist
        <span class="token operator">?</span> kAllowButWarnAndToast <span class="token punctuation">:</span> kAllowButWarn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> kDeny<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">以上逻辑用图来展示EnforcementPolicy和HiddenApiAccessFlags在不同取值的情况下，所对应的Action值。 <strong>纵轴代表强制策略级别</strong>，<strong>横轴代表隐藏API的标识</strong>，表中数据代表Action，如下所示：</font></p> 
<table><thead><tr><th align="left">纵轴/横轴</th><th align="left">kWhitelist</th><th align="left">kLightGreylist</th><th align="left">kDarkGreylist</th><th align="left">kBlacklist</th></tr></thead><tbody><tr><td align="left">kNoChecks</td><td align="left">kAllow</td><td align="left">kAllow</td><td align="left">kAllow</td><td align="left">kAllow</td></tr><tr><td align="left">kJustWarn</td><td align="left">kAllow</td><td align="left">kAllowButWarn</td><td align="left">kAllowButWarn</td><td align="left">kAllowButWarn</td></tr><tr><td align="left">kDarkGreyAndBlackList</td><td align="left">kAllow</td><td align="left">kAllowButWarn</td><td align="left">kDeny</td><td align="left">kDeny</td></tr><tr><td align="left">kBlacklistOnly</td><td align="left">kAllow</td><td align="left">kAllowButWarn</td><td align="left">kAllowButWarnAndToast</td><td align="left">kDeny</td></tr></tbody></table> 
<p><font face="Courier New">策略图解如下：</font></p> 
<ul><li><font face="Courier New">当HiddenApiAccessFlags等于kWhitelist，则Action=kAllow，否则如下</font></li><li><font face="Courier New">当EnforcementPolicy等于kNoChecks，则Action=kAllow，否则如下</font></li><li><font face="Courier New">当EnforcementPolicy等于kJustWarn，则Action=kAllowButWarn，否则如下</font></li><li><font face="Courier New">当HiddenApiAccessFlags等于kLightGreylist，则Action=kAllowButWarn，否则如下</font></li><li><font face="Courier New">当HiddenApiAccessFlags等于kDarkGreylist，且等于EnforcementPolicy=kBlacklistOnly，则- kAllowButWarnAndToast，否则如下</font></li><li><font face="Courier New">否则Action=kDeny</font></li></ul> 
<h5><a id="font_faceCourier_New_261_EnforcementPolicy_503"></a><font face="Courier New"> 2.6.1 EnforcementPolicy</font></h5> 
<p><font face="Courier New"> EnforcementPolicy的级别如下：</font></p> 
<pre><code class="prism language-c"><span class="token comment">// Hidden API enforcement policy</span>
<span class="token comment">// This must be kept in sync with ApplicationInfo.ApiEnforcementPolicy in</span>
<span class="token comment">// frameworks/base/core/java/android/content/pm/ApplicationInfo.java</span>
<span class="token keyword">enum</span> class EnforcementPolicy <span class="token punctuation">{<!-- --></span>
  kNoChecks             <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  kJustWarn             <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment">// keep checks enabled, but allow everything (enables logging)</span>
  kDarkGreyAndBlackList <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token comment">// ban dark grey &amp; blacklist</span>
  kBlacklistOnly        <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token comment">// ban blacklist violations only</span>
  kMax <span class="token operator">=</span> kBlacklistOnly<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li><font face="Courier New">kNoChecks：允许调用所有API，不做任何检测</font></li><li><font face="Courier New">kJustWarn：允许调用所有API，但是对于私有API的调用会打印警告log</font></li><li><font face="Courier New">kDarkGreyAndBlackList：会阻止调用dark grey或black list中的API</font></li><li><font face="Courier New">kBlacklistOnly：会阻止调用black list中的API</font></li></ul> 
<p><font face="Courier New">可通过SetHiddenApiEnforcementPolicy()来修改Runtime中的成员变量hidden_api_policy_,如下所示：</font></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">SetHiddenApiEnforcementPolicy</span><span class="token punctuation">(</span>hiddenapi<span class="token punctuation">:</span><span class="token punctuation">:</span>EnforcementPolicy policy<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  hidden_api_policy_ <span class="token operator">=</span> policy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

hiddenapi<span class="token punctuation">:</span><span class="token punctuation">:</span>EnforcementPolicy <span class="token function">GetHiddenApiEnforcementPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> hidden_api_policy_<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<br> 
<h4><a id="font_faceCourier_New27_IsCallerTrusted_538"></a><font face="Courier New">2.7 IsCallerTrusted</font></h4> 
<p><font face="Courier New">fn_caller_is_trusted 其实是通过函数指针调用到IsCallerTrusted函数</font></p> 
<blockquote> 
 <p><font face="Courier New"> java_lang_Class.cc</font></p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">static</span> bool <span class="token function">IsCallerTrusted</span><span class="token punctuation">(</span>Thread<span class="token operator">*</span> self<span class="token punctuation">)</span> <span class="token function">REQUIRES_SHARED</span><span class="token punctuation">(</span>Locks<span class="token punctuation">:</span><span class="token punctuation">:</span>mutator_lock_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    FirstExternalCallerVisitor <span class="token function">visitor</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span>
    visitor<span class="token punctuation">.</span><span class="token function">WalkStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//【见小节2.7.1】</span>
    <span class="token keyword">return</span> visitor<span class="token punctuation">.</span>caller <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span>
           hiddenapi<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">IsCallerTrusted</span><span class="token punctuation">(</span>visitor<span class="token punctuation">.</span>caller<span class="token operator">-&gt;</span><span class="token function">GetDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="font_faceCourier_New271_IsCallerTrusted_554"></a><font face="Courier New">2.7.1 IsCallerTrusted</font></h5> 
<p><font face="Courier New">hiddenapi::IsCallerTrusted ,是调用到了如下位置:</font></p> 
<blockquote> 
 <p><font face="Courier New">hidden_api.h</font></p> 
</blockquote> 
<pre><code class="prism language-c">ALWAYS_INLINE
<span class="token keyword">inline</span> bool <span class="token function">IsCallerTrusted</span><span class="token punctuation">(</span>ObjPtr<span class="token operator">&lt;</span>mirror<span class="token punctuation">:</span><span class="token punctuation">:</span>Class<span class="token operator">&gt;</span> caller<span class="token punctuation">,</span>
                            ObjPtr<span class="token operator">&lt;</span>mirror<span class="token punctuation">:</span><span class="token punctuation">:</span>ClassLoader<span class="token operator">&gt;</span> caller_class_loader<span class="token punctuation">,</span>
                            ObjPtr<span class="token operator">&lt;</span>mirror<span class="token punctuation">:</span><span class="token punctuation">:</span>DexCache<span class="token operator">&gt;</span> caller_dex_cache<span class="token punctuation">)</span>
    <span class="token function">REQUIRES_SHARED</span><span class="token punctuation">(</span>Locks<span class="token punctuation">:</span><span class="token punctuation">:</span>mutator_lock_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>caller_class_loader<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>  <span class="token comment">// Boot classloader，则返回true</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>caller_dex_cache<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> DexFile<span class="token operator">*</span> caller_dex_file <span class="token operator">=</span> caller_dex_cache<span class="token operator">-&gt;</span><span class="token function">GetDexFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>caller_dex_file <span class="token operator">!=</span> nullptr <span class="token operator">&amp;&amp;</span> caller_dex_file<span class="token operator">-&gt;</span><span class="token function">IsPlatformDexFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> true<span class="token punctuation">;</span>  <span class="token comment">// caller是平台dex文件，则返回true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>caller<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      caller<span class="token operator">-&gt;</span><span class="token function">ShouldSkipHiddenApiChecks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      Runtime<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">IsJavaDebuggable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> true<span class="token punctuation">;</span>  <span class="token comment">//处于debuggable调试模式且caller已被标记可信任，则返回true</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> false<span class="token punctuation">;</span><span class="token comment">//除了以上三种情况都是false</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">caller被认为是可信任的场景如下：</font></p> 
<ul><li><font face="Courier New">当类加载器是Boot classloader，则返回true</font></li><li><font face="Courier New">当caller是平台dex文件，则返回true</font></li><li><font face="Courier New">处于debuggable调试模式且caller已被标记可信任，则返回true</font></li></ul> 
<br> 
<h4><a id="font_faceCourier_New_28_GetMemberActionImpl_594"></a><font face="Courier New"> 2.8 GetMemberActionImpl</font></h4> 
<blockquote> 
 <p><font face="Courier New"> hidden_api.cc</font></p> 
</blockquote> 
<pre><code class="prism language-c">template<span class="token operator">&lt;</span>typename T<span class="token operator">&gt;</span>
Action <span class="token function">GetMemberActionImpl</span><span class="token punctuation">(</span>T<span class="token operator">*</span> member<span class="token punctuation">,</span>
                           HiddenApiAccessFlags<span class="token punctuation">:</span><span class="token punctuation">:</span>ApiList api_list<span class="token punctuation">,</span>
                           Action action<span class="token punctuation">,</span>
                           AccessMethod access_method<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//获取签名</span>
  MemberSignature <span class="token function">member_signature</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Runtime<span class="token operator">*</span> runtime <span class="token operator">=</span> Runtime<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> bool shouldWarn <span class="token operator">=</span> kLogAllAccesses <span class="token operator">||</span> runtime<span class="token operator">-&gt;</span><span class="token function">IsJavaDebuggable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldWarn <span class="token operator">||</span> action <span class="token operator">==</span> kDeny<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//判断是否为可豁免接口【小节2.8.1】</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>member_signature<span class="token punctuation">.</span><span class="token function">IsExempted</span><span class="token punctuation">(</span>runtime<span class="token operator">-&gt;</span><span class="token function">GetHiddenApiExemptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      action <span class="token operator">=</span> kAllow<span class="token punctuation">;</span>
      <span class="token function">MaybeWhitelistMember</span><span class="token punctuation">(</span>runtime<span class="token punctuation">,</span> member<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> kAllow<span class="token punctuation">;</span>    
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>access_method <span class="token operator">!=</span> kNone<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//打印包含有关此类成员访问信息的日志消息【小节2.8.2】</span>
      member_signature<span class="token punctuation">.</span><span class="token function">WarnAboutAccess</span><span class="token punctuation">(</span>access_method<span class="token punctuation">,</span> api_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">==</span> kDeny<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> action<span class="token punctuation">;</span> <span class="token comment">//拒绝调用</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>access_method <span class="token operator">!=</span> kNone<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 根据运行时标志的不同，我们可以将成员移动到白名单中，并在下次访问成员时跳过警告。</span>
    <span class="token function">MaybeWhitelistMember</span><span class="token punctuation">(</span>runtime<span class="token punctuation">,</span> member<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//如果此操作需要UI警告，设置适当的标志</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldWarn <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>action <span class="token operator">==</span> kAllowButWarnAndToast <span class="token operator">||</span> runtime<span class="token operator">-&gt;</span><span class="token function">ShouldAlwaysSetHiddenApiWarningFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      runtime<span class="token operator">-&gt;</span><span class="token function">SetPendingHiddenApiWarning</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> action<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="font_faceCourier_New281_GetHiddenApiExemptions_643"></a><font face="Courier New">2.8.1 GetHiddenApiExemptions</font></h5> 
<blockquote> 
 <p><font face="Courier New"> runtime.h</font></p> 
</blockquote> 
<pre><code class="prism language-c">class Runtime <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// SetHiddenApiEnforcementPolicy()可修改该值</span>
    hiddenapi<span class="token punctuation">:</span><span class="token punctuation">:</span>EnforcementPolicy hidden_api_policy_<span class="token punctuation">;</span>

    <span class="token comment">//SetHiddenApiExemptions()可修改该值</span>
    std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>string<span class="token operator">&gt;</span> hidden_api_exemptions_<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font face="Courier New">GetHiddenApiExemptions()是获取Runtime里面的成员变量hidden_api_exemptions_</font></p> 
<h5><a id="font_faceCourier_New282_WarnAboutAccess_662"></a><font face="Courier New">2.8.2 WarnAboutAccess</font></h5> 
<blockquote> 
 <p><font face="Courier New"> hidden_api.cc</font></p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">void</span> MemberSignature<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">WarnAboutAccess</span><span class="token punctuation">(</span>AccessMethod access_method<span class="token punctuation">,</span>
                                      HiddenApiAccessFlags<span class="token punctuation">:</span><span class="token punctuation">:</span>ApiList list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Accessing hidden "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>type_ <span class="token operator">==</span> kField <span class="token operator">?</span> <span class="token string">"field "</span> <span class="token punctuation">:</span> <span class="token string">"method "</span><span class="token punctuation">)</span>
               <span class="token operator">&lt;&lt;</span> Dumpable<span class="token operator">&lt;</span>MemberSignature<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">*</span>this<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" ("</span> <span class="token operator">&lt;&lt;</span> list <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> access_method <span class="token operator">&lt;&lt;</span> <span class="token string">")"</span><span class="token punctuation">;</span>
</code></pre> 
<p><font face="Courier New">打印包含有关此类成员访问信息的日志消息</font></p> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_NewAndroid_PSDK_API_682"></a><font face="Courier New">三.放开Android P非SDK API的限制</font></h3> 
<p><font face="Courier New">这个主要可以从三个方面下手,如下：</font></p> 
<pre><code class="prism language-bash"><span class="token function">diff</span> --git a/art/runtime/native/java_lang_Class.cc b/art/runtime/native/java_lang_Class.cc
index c07c32a<span class="token punctuation">..</span>b56c1a6 100644
--- a/art/runtime/native/java_lang_Class.cc
+++ b/art/runtime/native/java_lang_Class.cc
@@ -115,6 +115,13 @@ ALWAYS_INLINE static bool ShouldEnforceHiddenApi<span class="token punctuation">(</span>Thread* self<span class="token punctuation">)</span>
 template<span class="token operator">&lt;</span>typename T<span class="token operator">&gt;</span>
 ALWAYS_INLINE static bool ShouldBlockAccessToMember<span class="token punctuation">(</span>T* member, Thread* self<span class="token punctuation">)</span>
     REQUIRES_SHARED<span class="token punctuation">(</span>Locks::mutator_lock_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
+<span class="token comment">#ifdef XXX_HIDEAPI_RULE</span>
+         //std::string message<span class="token punctuation">(</span><span class="token string">"Use XXX_API_RULE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
+      //LOG<span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> message<span class="token punctuation">;</span>
+      //std::cerr <span class="token operator">&lt;&lt;</span> message <span class="token operator">&lt;&lt;</span> std::endl<span class="token punctuation">;</span>
+       
+       <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
+<span class="token comment">#else</span>
   hiddenapi::Action action <span class="token operator">=</span> hiddenapi::GetMemberAction<span class="token punctuation">(</span>
       member, self, IsCallerTrusted, hiddenapi::kReflection<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">!=</span> hiddenapi::kAllow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
@@ -122,6 +129,7 @@ ALWAYS_INLINE static bool ShouldBlockAccessToMember<span class="token punctuation">(</span>T* member, Thread* self<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
 
   <span class="token keyword">return</span> action <span class="token operator">==</span> hiddenapi::kDeny<span class="token punctuation">;</span>
+<span class="token comment">#endif</span>
 <span class="token punctuation">}</span>


--- a/frameworks/base/core/java/android/content/pm/ApplicationInfo.java
+++ b/frameworks/base/core/java/android/content/pm/ApplicationInfo.java
@@ -49,13 +49,18 @@ <span class="token function">import</span> java.util.Arrays<span class="token punctuation">;</span>
 <span class="token function">import</span> java.util.Comparator<span class="token punctuation">;</span>
 <span class="token function">import</span> java.util.Objects<span class="token punctuation">;</span>
 <span class="token function">import</span> java.util.UUID<span class="token punctuation">;</span>
-
+import java.util.ArrayList<span class="token punctuation">;</span>
+import java.util.Arrays<span class="token punctuation">;</span>
+import java.util.List<span class="token punctuation">;</span>
+import android.util.Log<span class="token punctuation">;</span>
 /**
  * Information you can retrieve about a particular application.  This
  * corresponds to information collected from the AndroidManifest.xml's
  * <span class="token operator">&amp;</span>lt<span class="token punctuation">;</span>application<span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> tag.
  */
 public class ApplicationInfo extends PackageItemInfo implements Parcelable <span class="token punctuation">{<!-- --></span>
+    public static final List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>specialApp <span class="token operator">=</span> new ArrayList<span class="token punctuation">(</span>Arrays.asList<span class="token punctuation">(</span><span class="token string">"com.xxx.xxxscans"</span>,<span class="token string">"com.xxx.market.android.app"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
+
     
     /**
      * Default task affinity of all activities <span class="token keyword">in</span> this application. See 
@@ -1701,13 +1706,20 @@ public class ApplicationInfo extends PackageItemInfo implements Parcelable <span class="token punctuation">{<!-- --></span>
             dataDir <span class="token operator">=</span> credentialProtectedDataDir<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
+       private boolean isSpecialXXXApp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
+               boolean result <span class="token operator">=</span> specialApp.contains<span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
+               if<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
+                       Log.e<span class="token punctuation">(</span><span class="token string">"ApplicationInfo"</span>,<span class="token string">"SpecialXXXApp : "</span> + packageName + <span class="token string">" can use HiddenApis"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
+
+               <span class="token keyword">return</span> result<span class="token punctuation">;</span>
+       <span class="token punctuation">}</span>


     private boolean isPackageWhitelistedForHiddenApis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">return</span> SystemConfig.getInstance<span class="token punctuation">(</span><span class="token punctuation">)</span>.getHiddenApiWhitelistedApps<span class="token punctuation">(</span><span class="token punctuation">)</span>.contains<span class="token punctuation">(</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
     private boolean isAllowedToUseHiddenApis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
-        <span class="token keyword">return</span> isSignedWithPlatformKey<span class="token punctuation">(</span><span class="token punctuation">)</span>
+        <span class="token keyword">return</span> isSpecialXXXApp<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> isSignedWithPlatformKey<span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token operator">||</span> <span class="token punctuation">(</span>isPackageWhitelistedForHiddenApis<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>isSystemApp<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> isUpdatedSystemApp<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

</code></pre> 
<p><font face="Courier New">还有一个就是屏蔽黑名单中限制的API，其中涉及到的各种黑白名单在源码中的目录如下:</font></p> 
<pre><code class="prism language-bash">out/target/common/obj/PACKAGING/hiddenapi-light-greylist.txt
out/target/common/obj/PACKAGING/hiddenapi-dark-greylist.txt
out/target/common/obj/PACKAGING/hiddenapi-blacklist.txt

frameworks/base/config/hiddenapi-force-blacklist.txt
frameworks/base/config/hiddenapi-light-greylist.txt
frameworks/base/config/hiddenapi-private-dex.txt
frameworks/base/config/hiddenapi-public-dex.txt
frameworks/base/config/hiddenapi-removed-dex.txt
frameworks/base/config/hiddenapi-vendor-list.txt


out/target/product/product_name/system/etc/sysconfig/hiddenapi-package-whitelist.xml
frameworks/base/data/etc/hiddenapi-package-whitelist.xml
</code></pre> 
<p><font face="Courier New">同时在测试阶段也可以通过adb打开或者关闭限制<br> <font face="Courier New">可以通过使用 adb，在开发设备上允许访问非 SDK API。</font></font></p> 
<p><font face="Courier New">若您想在 adb logcat 中显示 API 访问信息，您可通过以下命令更改 API 执行策略：</font></p> 
<ul><li> <p><font face="Courier New">adb shell settings put global hidden_api_policy_pre_p_apps 1</font></p> </li><li> <p><font face="Courier New">adb shell settings put global hidden_api_policy_p_apps 1</font></p> </li></ul> 
<p><font face="Courier New">更改回默认设置：</font></p> 
<ul><li> <p><font face="Courier New">adb shell settings delete global hidden_api_policy_pre_p_apps</font></p> </li><li> <p><font face="Courier New">adb shell settings delete global hidden_api_policy_p_apps</font></p> </li></ul> 
<p>以上命令不需要设备获得 Root 权限。</p> 
<p>命令最后的数字分别表示：</p> 
<p><img src="https://images2.imgbox.com/30/f3/rZSbakCh_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_New__806"></a><font face="Courier New">四. 总结</font></h3> 
<br> 
<h4><a id="font_faceCourier_New31__810"></a><font face="Courier New">3.1 限制原理总结</font></h4> 
<p><font face="Courier New">（1）从前面的内部API限制过程，可知主要控制逻辑在方法ShouldBlockAccessToMember，调用该方法的核心路径如下：</font></p> 
<ul><li><font face="Courier New">kReflection反射过程：<br> Class_newInstance：对象实例化<br> Class_getDeclaredConstructorInternal：构造方法<br> Class_getDeclaredMethodInternal：获取方法<br> Class_getDeclaredField：获取字段<br> Class_getPublicFieldRecursive：获取字段</font></li><li><font face="Courier New">kJNI的JNI调用过程：<br> FindMethodID：查找方法<br> FindFieldID：查找字段</font></li><li><font face="Courier New">kLinking动态链接：<br> UnstartedClassNewInstance<br> UnstartedClassGetDeclaredConstructor<br> UnstartedClassGetDeclaredMethod<br> UnstartedClassGetDeclaredField</font></li></ul> 
<p><font face="Courier New">（2）ShouldBlockAccessToMember过程是否运行主要有如下情况：</font></p> 
<p><font face="Courier New">当EnforcementPolicy强制不限制的情况<br> 当类加载器是Boot classloader的情况<br> 当caller是平台dex文件的情况<br> 当处于debuggable调试模式且caller已被标记可信任的情况<br> 当GetHiddenApiExemptions为豁免情况</font></p> 
<p><font face="Courier New">（3）掌握了ShouldBlockAccessToMember原理，也就可以有的放矢了，突破限制方案，比如：</font></p> 
<p>-<font face="Courier New">修改ART的EnforcementPolicy，也就是Runtime中的成员变量hidden_api_policy_，可以基于地址偏移找到相-应的成员，这就不就细说<br> -<font face="Courier New">修改隐藏API豁免变量，也就是Runtime中的成员变量hidden_api_exemptions_<br> -<font face="Courier New">修改classLoader为BootClassLoader</font></font></font></p> 
<br> 
<h4><a id="font_faceCourier_New32__845"></a><font face="Courier New">3.2 黑白名单</font></h4> 
<p><font face="Courier New">关于在Android P的几个预览版本一直在不断调整，目前主要是黑名单、浅灰名单、vendor名单这3个名单，对应文件名：hiddenapi-force-blacklist.txt，hiddenapi-light-greylist.txt，hiddenapi-vendor-list.txt。这些文件在编译阶段生成为hiddenapi，记录在access_flags_字段值。整个过程是在hiddenapi.cc过程的CategorizeAllClasses()中完成的。<br> <img src="https://images2.imgbox.com/40/92/6zRR7vas_o.png" alt="在这里插入图片描述"></font></p> 
<p><font face="Courier New">目前主要使用的是黑名单和浅灰名单，深灰名单暂没有使用：</font></p> 
<ul><li><font face="Courier New">黑名单内容：setHiddenApiExemptions</font></li><li><font face="Courier New">浅灰名单内容：Activity, Service，ContentProvider，ActivityManager, ActivityThread，Application，ContextImpl，Intent等</font></li></ul> 
<br> 
<h4><a id="font_faceCourier_New33_SDK_858"></a><font face="Courier New">3.3 非SDK接口说明</font></h4> 
<ul><li><font face="Courier New">非SDK接口限制适用于所有应用，但是会豁免使用平台密钥签署的应用，并且针对系统app的白名单</font></li><li><font face="Courier New">如果你的应用有必须使用非SDK接口的充分理由，可以向Google提交功能请求，并提供用例详情;</font></li><li><font face="Courier New">如果你的应用使用很多第三方库，而又难以排除是否正在使用非SDK接口，可以尝试使用AOSP提供的静态分析工具veridex;</font></li><li><font face="Courier New">应用运行时检测到非SDK接口的使用，会打印一条Accessing hidden field|method … 形式的logcat警告。当然对于设置android:debuggable=true的可调试应用会显示toast消息，并打印logcat日志。</font></li><li><font face="Courier New">黑名单/灰名单编码在平台dex文件的字段和函数访问标志位中，无法从系统镜像中找到单独包含这些名单的文件。</font></li><li><font face="Courier New">黑名单/灰名单在采用相同Android版本是一致的。手机厂商可以向黑名单添加自己的API，但无法从AOSP黑名单或灰名单中移除，Google兼容性定义文件(CDD)来保障这一工作，并在测试过程通过CTS来确保Android运行时强制执行名单。</font></li><li><font face="Courier New">目前，Google对Android暂时没有限制访问dex2oat二进制文件的计划，但是dex文件格式无法保证会稳定，可能随时会修改或删除dex2oat以及dex衍生文件。<br> Android 7.0针对Native lib引入了namespace来限制平台lib对外的可见性，普通APP在Android N上不能直接调用系统私有库，Android系统允许调用的公用库定义在public.libraries.android.txt。 这个feature只针对target SDK为24及以上的APP。</font></li></ul> 
<p><font face="Courier New">Android 7.0限制对C/C++代码的NDK，Android 9.0限制对Java的SDK。这一以来APP想利用内部API搞黑科技的难度以及不稳定性都会有所增加。</font></p> 
<p><font face="Courier New">最后说一点，目前网络有一些开发者发表了关于非SDK接口限制的绕过技术，但基本没有APP是通过这些漏洞方式来突破隐藏API的访问，说明大家有所顾忌，这对生态来说是好事。另外关于绕过技术对于Google和手机厂商都已注意到，要简单封杀容易但可能会带来调试与复杂度的提升，所以Google正在积极寻找平衡接口限制与运行时易于调试之间的平衡，相信很快Google会有更完善的解决方案。</font></p> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_New_879"></a><font face="Courier New">结语</font></h3> 
<p><font face="Courier New">各位乡亲们，Android P非SDK API限制调用开发指南，整的我腰酸背痛啊。Android版本升级之时就是我等受苦之时啊。看gityuan的博客然后加上自己的理解和总结整的我好累啊。</font></p> 
<hr> 
<br> 
<br> 
<h3><a id="font_faceCourier_New_889"></a><font face="Courier New">写在最后</font></h3> 
<p><font face="Courier New">   好了如上就是<a href="https://editor.csdn.net/md/?articleId=105784784" rel="nofollow">Android P非SDK API限制调用开发指南</a>所有，如有问题或者有任何疑问请及时沟通或者交流，也可点个赞或者吐槽一番也是可以的。so goodbye。这篇主要都是gityuan的博客，所以各位不要吐槽我了。</font></p> 
<p><font face="Courier New"> 参考博客：</font></p> 
<p><font face="Courier New"> <a href="http://gityuan.com/2019/01/26/hidden_api/" rel="nofollow">理解Android P内部API的限制调用机制</a><br> <font face="Courier New"><a href="https://developer.android.google.cn/distribute/best-practices/develop/restrictions-non-sdk-interfaces" rel="nofollow">Android官方文档针对非 SDK 接口的限制</a><br> <font face="Courier New"><a href="https://mlog.club/article/26491" rel="nofollow">适配 Android P之非SDK接口限制的排查方法</a></font></font></font></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fd27e67bb342d52624cb150c812dfb72/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">95-110-026-源码-Env-RemoteStreamEnvironment</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/63768b5825baa3b44167159cec91977b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">梳理L1、L2与Smooth L1</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>