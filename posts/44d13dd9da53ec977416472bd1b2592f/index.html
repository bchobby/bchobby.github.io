<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>springBoot整合springSecurity(认证) - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="springBoot整合springSecurity(认证)" />
<meta property="og:description" content="springSecurity(安全) 1.什么是springSecurity? Spring Security是 Spring 家族中的一个安全管理框架。相比与另外一个安全框架Shiro，它提供了更丰富的功能，社区资源也比Shiro丰富；
Spring Security是一个功能强大且高度可定制的身份验证和访问控制框架。它是用于保护基于Spring的应用程序的实际标准；
Spring Security是一个框架，致力于为Java应用程序提供身份验证和授权。与所有Spring项目一样，Spring Security的真正强大之处在于可以轻松扩展以满足自定义要求。
在 Java 生态中，目前有 Spring Security 和 Apache Shiro 两个安全框架，可以完成认证和授权的功能。
我们先来学习下 Spring Security 。其官方对自己介绍如下：
Spring Security is a powerful and highly customizable authentication and access-control framework. It is the de-facto standard for securing Spring-based applications.
Spring Security是一个功能强大且高度可定制的身份验证和访问控制框架。它是保护基于Spring的应用程序的事实标准。
Spring Security is a framework that focuses on providing both authentication and authorization to Java applications. Like all Spring projects, the real power of Spring Security is found in how easily it can be extended to meet custom requirementsSpring" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/44d13dd9da53ec977416472bd1b2592f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-15T23:41:17+08:00" />
<meta property="article:modified_time" content="2022-10-15T23:41:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">springBoot整合springSecurity(认证)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>springSecurity(安全)</h2> 
<h2>1.什么是springSecurity?</h2> 
<p><strong>Spring Security是 Spring 家族中的一个安全管理框架。相比与另外一个安全框架Shiro，它提供了更丰富的功能，社区资源也比Shiro丰富；</strong></p> 
<p><strong>Spring Security是一个功能强大且高度可定制的身份验证和访问控制框架。它是用于保护基于Spring的应用程序的实际标准；</strong></p> 
<p><strong>Spring Security是一个框架，致力于为Java应用程序提供身份验证和授权。与所有Spring项目一样，Spring Security的真正强大之处在于可以轻松扩展以满足自定义要求。</strong></p> 
<p><strong>在 Java 生态中，目前有 Spring Security 和 Apache Shiro 两个安全框架，可以完成认证和授权的功能。</strong></p> 
<p><strong>我们先来学习下 Spring Security 。其官方对自己介绍如下：</strong></p> 
<p><strong>Spring Security is a powerful and highly customizable authentication and access-control framework. It is the de-facto standard for securing Spring-based applications.</strong></p> 
<p><strong>Spring Security是一个功能强大且高度可定制的身份验证和访问控制框架。它是保护基于Spring的应用程序的事实标准。</strong></p> 
<p><strong>Spring Security is a framework that focuses on providing both authentication and authorization to Java applications. Like all Spring projects, the real power of Spring Security is found in how easily it can be extended to meet custom requirementsSpring</strong></p> 
<p></p> 
<p><strong>Security是一个专注于为Java应用程序提供身份验证和授权的框架。与所有Spring项目一样，Spring Security的真正威力在于它可以多么容易地扩展以满足定制需求</strong></p> 
<p><strong>一般Web应用的需要进行认证和授权。</strong></p> 
<p><strong>认证（Authentication）：验证当前访问系统的是不是本系统的用户，并且要确认具体是哪个用户</strong></p> 
<p><strong>授权（Authorization）：经过认证后判断当前用户是否有权限进行某个操作</strong></p> 
<p><strong>而认证和授权就是SpringSecurity作为安全框架的核心功能。</strong></p> 
<p></p> 
<h2>2.认证</h2> 
<h3>2.1导入springSecurity依赖</h3> 
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre> 
<p><strong>然后运行项目</strong></p> 
<p>输入localhost:自己的端口号会出来这个页面</p> 
<p><img alt="img" src="https://images2.imgbox.com/b8/6d/aTWsdHto_o.png"><img alt="" height="1" src="https://images2.imgbox.com/af/62/lVtPOUeX_o.png" width="1"><img alt="" height="1" src="https://images2.imgbox.com/93/6b/cBRCTHpj_o.png" width="1"></p> 
<p><strong>此时所有的接口都已经被保护了</strong></p> 
<h3>2.2那账号密码是什么呢</h3> 
<p><strong>我们查看一下控制台</strong></p> 
<p><img alt="img" src="https://images2.imgbox.com/7e/08/Gkx8muVO_o.png"><img alt="" height="1" src="https://images2.imgbox.com/1f/3d/DvTHSry2_o.png" width="1"></p> 
<p>有一串uuid这就是密码，账号为user</p> 
<p>输入进去就可以登录成功了</p> 
<p><img alt="img" src="https://images2.imgbox.com/49/a6/vKMMyKlp_o.png"><img alt="" height="1" src="https://images2.imgbox.com/3a/69/R2N6vPLC_o.png" width="1"></p> 
<h3>2.3表单登录</h3> 
<h4>2.3.1登录的html文件</h4> 
<p>在resources里面的static目录创建一个html文件</p> 
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;登陆&lt;/title&gt;
    &lt;link
            href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
            rel="stylesheet" id="bootstrap-css"&gt;
    &lt;script
            src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" &gt;
    &lt;/script&gt;
​
    &lt;script
            src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"&gt;
    &lt;/script&gt;
​
&lt;/head&gt;
&lt;style&gt;
    #login .container #login-row #login-column #login-box{
        border: 1px solid #9c9c9c ;
        background-color: #EAEAEA;
    }
&lt;/style&gt;
&lt;body&gt;
&lt;form id="login-form" class="form" action="/doLogin" method="post"&gt;
    &lt;h3&gt;登录&lt;/h3&gt;
    &lt;label for="username" class="text-into" &gt;用户名&lt;/label&gt;&lt;br&gt;
    &lt;input type="text" name="uname" id="username" class="form-control" &gt;&lt;br&gt;
    &lt;label for="password" class="text-info"&gt;密码&lt;/label&gt;&lt;br&gt;
    &lt;input type="password" name="passwd" id="password" class="form-control"&gt;&lt;br&gt;
    &lt;input type="submit" name="submit" class="btn btn-info btn-md" value="登录"&gt;
&lt;/form&gt;
​
​
&lt;/body&gt;
&lt;/html&gt;</code></pre> 
<h4>2.3.2配置一下security的配置</h4> 
<p>创建一个SecurityConfig配置类</p> 
<p>继承WebSecurityConfigurerAdapter</p> 
<pre><code class="language-java">@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
​
    @Autowired
    private UserDetailsServiceImpl userDetailsService;
​
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        //authorizeRequests开启权限配置
        http.authorizeRequests()
                //anyRequest().authenticated()所有请求都要认证
                .anyRequest().authenticated()
                //and()和http.同意
                .and()
                //formLogin开启表单登陆的配置
                .formLogin()
                //loginPage登录的页面地址
                .loginPage("/mylogin.html")
                //loginProcessingUrl登录接口
                .loginProcessingUrl("/doLogin")
//                //defaultSuccessUrl登录成功跳转的页面,如果直接到Login页面登陆成功跳转的地址
                .defaultSuccessUrl("/index")
                //登陆失败跳转的路径，并且携带错误信息
                .failureForwardUrl("/mylogin.html")
                //登录的用户名
                .usernameParameter("uname")
                //登录的密码
                .passwordParameter("passwd")
                //表示跟登录相关的接口不拦截
                .permitAll()
                .and()
                //关闭csrf跨域攻击
                .csrf().disable();
    }
}</code></pre> 
<h4>2.3.3设置登录的账号密码</h4> 
<p><strong>在application.yml文件当中配置</strong></p> 
<pre><code class="language-java">spring:
  #security
  security:
    user:
      name: admin
      password: 123456</code></pre> 
<p>登录成功之后会跳转到/index接口</p> 
<p>登录失败之后会再次跳转到/mylogin.html的登录页面</p> 
<h4>2.3.4前后分离之下的登录</h4> 
<p><strong>有时候页面跳转并不能满足我们的需求，特别是现在流行的前后分离开发当中，用户登录成功后就不需要跳转了，</strong></p> 
<p><strong>只需要返回给前端一个JSON数据即可，告诉前端登录成功还是登录失败，全端接收到消息之后自行处理。</strong></p> 
<p><strong>像这样的需求，我们可以通过自定义的AuthenticationHandler</strong></p> 
<p>2.3.4.1登录成功处理器</p> 
<pre><code class="language-java">@Configuration
public class MyAuthenticationSuccessHandler implements AuthenticationSuccessHandler {
    //自定义配置登录成功的处理器
    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        response.setContentType("application/json;charset=utf-8");
        Map&lt;String,Object&gt; successMap=new HashMap&lt;&gt;();
        successMap.put("msg","登录成功");
        successMap.put("code",200);
        ObjectMapper objectMapper=new ObjectMapper();
        String successLogin=objectMapper.writeValueAsString(successMap);
        response.getWriter().write(successLogin);
    }
}</code></pre> 
<p>2.3.4.2登录失败处理器</p> 
<pre><code class="language-java">@Configuration
public class MyAuthenticationFailureHandler implements AuthenticationFailureHandler {
    //自定义配置登录失败返回的信息
    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {
        response.setContentType("application/json;charset=utf-8");
        Map&lt;String,Object&gt; successMap=new HashMap&lt;&gt;();
        successMap.put("msg","登录失败"+exception.getMessage());
        successMap.put("code", Constants.CODE_500);
        ObjectMapper objectMapper=new ObjectMapper();
        String successLogin=objectMapper.writeValueAsString(successMap);
        response.getWriter().write(successLogin);
    }
    
}</code></pre> 
<p>2.3.4.3重新配置一下</p> 
<p><strong>修改一下刚才的SpringSecurity配置</strong></p> 
<pre><code class="language-java">@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
​
    @Autowired
    private UserDetailsServiceImpl userDetailsService;
​
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        //authorizeRequests开启权限配置
        http.authorizeRequests()
                //anyRequest().authenticated()所有请求都要认证
                .anyRequest().authenticated()
                //and()和http.同意
                .and()
                //formLogin开启表单登陆的配置
                .formLogin()
                //loginPage登录的页面地址
                .loginPage("/mylogin.html")
                //loginProcessingUrl登录接口
                .loginProcessingUrl("/doLogin")
                 //自定义登录成功的处理器
                .successHandler(new MyAuthenticationSuccessHandler())
                //自定义登陆失败的处理器
                .failureHandler(new MyAuthenticationFailureHandler())
                //登录的用户名
                .usernameParameter("uname")
                //登录的密码
                .passwordParameter("passwd")
                //表示跟登录相关的接口不拦截
                .permitAll()
                .and()
                //关闭csrf跨域攻击
                .csrf().disable();
    }
}</code></pre> 
<p><strong>再次重启</strong></p> 
<p>2.3.4.4登录成功返回的信息</p> 
<p><img alt="img" src="https://images2.imgbox.com/3a/75/5XFLedwn_o.png"><img alt="" height="1" src="https://images2.imgbox.com/94/a8/SUgNOwrO_o.png" width="1"></p> 
<p>2.3.4.5登录失败返回的信息</p> 
<p><img alt="img" src="https://images2.imgbox.com/93/21/4OEtC6S1_o.png"><img alt="" height="1" src="https://images2.imgbox.com/36/97/NkoDT65Y_o.png" width="1"></p> 
<h3>2.4退出登录</h3> 
<h4>2.4.1默认的退出登录</h4> 
<p><strong>添加退出登录的security配置</strong></p> 
<pre><code class="language-java">@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
@Override
protected void configure(HttpSecurity http) throws Exception {
    //authorizeRequests开启权限配置
    http.authorizeRequests()
            //anyRequest().authenticated()所有请求都要认证
            .anyRequest().authenticated()
            //and()和http.同意
            .and()
            //formLogin开启表单登陆的配置
            .formLogin()
            //loginPage登录的页面地址
            .loginPage("/mylogin.html")
            //loginProcessingUrl登录接口
            .loginProcessingUrl("/doLogin")
             //自定义登录成功的处理器
            .successHandler(new MyAuthenticationSuccessHandler())
            //自定义登陆失败的处理器
            .failureHandler(new MyAuthenticationFailureHandler())
            //登录的用户名
            .usernameParameter("uname")
            //登录的密码
            .passwordParameter("passwd")
            //表示跟登录相关的接口不拦截
            .permitAll()
            .and()
            //logout开启注销配置
            .logout()
            //logoutUrl注销登录的请求路径
            .logoutUrl("/logout")
            .invalidateHttpSession(true)
            //clearAuthentication表示清除认证信息,默认为true
            .clearAuthentication(true)
            //logoutSuccessUrl退出成功之后的页面
            .logoutSuccessUrl("/mylogin.html")
            //关闭csrf跨域攻击
            .csrf().disable();
  }
}</code></pre> 
<p><strong>security的默认的退出路径为logout，退出成功返回的页面为/mylogin.html</strong></p> 
<h4>2.4.2退出登录的处理器</h4> 
<p><strong>退出登录也可以和登录成功登录失败一样，返回json数据</strong></p> 
<pre><code class="language-java">@Configuration
public class MyLogoutSuccessHandler implements LogoutSuccessHandler {
    @Override
    public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        response.setContentType("application/json;charset=utf-8");
        Map&lt;String,Object&gt; successMap=new HashMap&lt;&gt;();
        successMap.put("msg","退出成功");
        successMap.put("code",200);
        ObjectMapper objectMapper=new ObjectMapper();
        String successLogin=objectMapper.writeValueAsString(successMap);
        response.getWriter().write(successLogin);
    }
}</code></pre> 
<p><strong>同时也要配置一下</strong></p> 
<pre><code class="language-java">@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
​
​
@Autowired
private UserDetailsServiceImpl userDetailsService;
​
@Override
protected void configure(HttpSecurity http) throws Exception {
    //authorizeRequests开启权限配置
    http.authorizeRequests()
            //anyRequest().authenticated()所有请求都要认证
            .anyRequest().authenticated()
            //and()和http.同意
            .and()
            //formLogin开启表单登陆的配置
            .formLogin()
            //loginPage登录的页面地址
            .loginPage("/mylogin.html")
            //loginProcessingUrl登录接口
            .loginProcessingUrl("/doLogin")
             //自定义登录成功的处理器
            .successHandler(new MyAuthenticationSuccessHandler())
            //自定义登陆失败的处理器
            .failureHandler(new MyAuthenticationFailureHandler())
            //登录的用户名
            .usernameParameter("uname")
            //登录的密码
            .passwordParameter("passwd")
            //表示跟登录相关的接口不拦截
            .permitAll()
            .and()
            //logout开启注销配置
            .logout()
            //logoutUrl注销登录的请求路径
            .logoutUrl("/logout")
            //配置退出登录处理器
            .logoutSuccessHandler(new MyLogoutSuccessHandler())
            .invalidateHttpSession(true)
            //clearAuthentication表示清除认证信息,默认为true
            .clearAuthentication(true)
            //关闭csrf跨域攻击
            .csrf().disable();
  }
}</code></pre> 
<h3>2.5登录用户数据获取</h3> 
<p></p> 
<h4>2.5.1从SecurityContextHolder中获取</h4> 
<p>登录成功之后直接可以通过security中获取对象信息，security已经给我们封装好了</p> 
<pre><code class="language-java">@GetMapping("/getUser")
    public Object getUserInfo(){
        //获取用户信息
        return SecurityContextHolder.getContext().getAuthentication().getPrincipal();
    }</code></pre> 
<p>我们用账号admin登录</p> 
<p><img alt="img" src="https://images2.imgbox.com/51/a1/qS29dJN0_o.png"><img alt="" height="1" src="https://images2.imgbox.com/24/0d/amxt6Kgs_o.png" width="1"></p> 
<p><strong>这样就能获取到用户信息了</strong></p> 
<p>是Authentication里面有五个接口</p> 
<pre><code class="language-java">//获取用户权限
Collection&lt;? extends GrantedAuthority&gt; getAuthorities();
​
//获取用户凭证，一般是密码，但是为了安全返回的是null
Object getCredentials();
​
//用来获取用户详细信息
Object getDetails();
​
//获取当前用户信息，可以是一个用户名，也可以是一个用户对象
Object getPrincipal();
​
//当前用户是否认证成功
boolean isAuthenticated();</code></pre> 
<h4>2.5.2从当前请求对象中获取</h4> 
<pre><code class="language-java">@RequestMapping("/authentication")
public AjaxResult authentication(Authentication authentication){
    return authentication;
}
​
@RequestMapping("/principal")
public AjaxResult principal(Principal principal){
    return principal;
}</code></pre> 
<p></p> 
<p><strong>第一个方法返回的用户信息</strong></p> 
<p><img alt="img" src="https://images2.imgbox.com/8c/77/TeksIIL8_o.png"><img alt="" height="1" src="https://images2.imgbox.com/70/65/c98uwB3S_o.png" width="1"></p> 
<p><strong>第二个方法获取的用户信息</strong></p> 
<p><img alt="" height="990" src="https://images2.imgbox.com/fd/d2/4553DyhA_o.png" width="1200"></p> 
<p></p> 
<p></p> 
<p><strong>返回的其实差不多，因为authentication是继承principal的</strong></p> 
<p></p> 
<h3>2.6自定义认证用户信息</h3> 
<h4>2.6.1基于内存</h4> 
<p>前面的案例都是基于内存的，只是我们没有将InMemoryUserDetailsManager</p> 
<p>在刚才的security配置类里面，重写springSecurity认证方式的方法</p> 
<p><img alt="img" src="https://images2.imgbox.com/0a/66/WRH590GV_o.png"><img alt="" height="1" src="https://images2.imgbox.com/cb/05/sHJ8FpH5_o.png" width="1"></p> 
<p></p> 
<pre><code class="language-java">@Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        //基于内存的用户
        InMemoryUserDetailsManager manager=new InMemoryUserDetailsManager();
        //创建用户,设置用户名,密码,角色
        manager.createUser(User.withUsername("admin").password("{noop}123").roles("admin").build());
        manager.createUser(User.withUsername("user").password("{noop}123").roles("user").build());
        //存储到authentication里面
        auth.userDetailsService(manager);
    }</code></pre> 
<h4><strong>{noop}前缀表示密码不加密</strong></h4> 
<p><strong>重写这个认证方式，就只能用设置的账号登录了，在实际项目中是不可能的这样配置的，都是用数据库的进行认证的</strong></p> 
<p>2.6.1基于Mybatis认证</p> 
<p><strong>(我用的是MyBatis-plus意义一样，可自行选择)*</strong>***</p> 
<p>（1）导入mybatis和MySQL-connector的依赖</p> 
<pre><code class="language-java">&lt;dependency&gt;
    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
    &lt;version&gt;3.5.2&lt;/version&gt;
&lt;/dependency&gt;
​
&lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;</code></pre> 
<p>（2）配置数据库和myBatis</p> 
<pre><code class="language-java">spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8&amp;characterEncoding=utf-8
    username: root
    password: 123888
    driver-class-name: com.mysql.cj.jdbc.Driver</code></pre> 
<p></p> 
<pre><code class="language-java">mybatis:
  mapper-locations: classpath:mapper/*Mapper.xml
  # ???????
  typeAliasesPackage: com.frank.pojo
  configuration:
#    #????SQL??
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl</code></pre> 
<p>2.6.2创建数据库表</p> 
<p><strong>用户表</strong></p> 
<pre><code class="language-sql">/*
 Navicat Premium Data Transfer
​
 Source Server         : localhost_3306
 Source Server Type    : MySQL
 Source Server Version : 80028
 Source Host           : localhost:3306
 Source Schema         : test
​
 Target Server Type    : MySQL
 Target Server Version : 80028
 File Encoding         : 65001
​
 Date: 14/10/2022 01:10:29
*/
​
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;
​
-- ----------------------------
-- Table structure for user_info
-- ----------------------------
DROP TABLE IF EXISTS `user_info`;
CREATE TABLE `user_info`  (
  `id` int(0) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `username` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '用户名',
  `password` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '密码',
  `create_time` datetime(0) NULL DEFAULT CURRENT_TIMESTAMP(0) COMMENT '创建时间',
  `update_time` datetime(0) NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP(0) COMMENT '修改时间',
  `deleted` int(0) NULL DEFAULT 0 COMMENT '逻辑删除',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 5 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;
​
-- ----------------------------
-- Records of user_info
-- ----------------------------
INSERT INTO `user_info` VALUES (1, 'user', '{noop}123456', '2022-10-02 10:33:46', '2022-10-12 00:40:19', 0);
INSERT INTO `user_info` VALUES (2, 'admin', '{noop}123456', '2022-10-02 10:33:46', '2022-10-12 00:40:21', 0);
INSERT INTO `user_info` VALUES (3, 'caixvkun', '{noop}123456', '2022-10-02 10:33:46', '2022-10-12 00:40:22', 0);
INSERT INTO `user_info` VALUES (4, 'wujinxiang', '{noop}123456', '2022-10-02 14:09:49', '2022-10-12 00:40:24', 0);
​
SET FOREIGN_KEY_CHECKS = 1;</code></pre> 
<pre>​</pre> 
<p></p> 
<p><strong>角色表</strong></p> 
<pre><code class="language-sql">/*
 Navicat Premium Data Transfer
​
 Source Server         : localhost_3306
 Source Server Type    : MySQL
 Source Server Version : 80028
 Source Host           : localhost:3306
 Source Schema         : test
​
 Target Server Type    : MySQL
 Target Server Version : 80028
 File Encoding         : 65001
​
 Date: 14/10/2022 01:10:40
*/
​
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;
​
-- ----------------------------
-- Table structure for role
-- ----------------------------
DROP TABLE IF EXISTS `role`;
CREATE TABLE `role`  (
  `id` int(0) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `name` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '角色',
  `nameZh` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT '名称',
  `create_time` datetime(0) NULL DEFAULT CURRENT_TIMESTAMP(0) COMMENT '创建时间',
  `update_time` datetime(0) NULL DEFAULT NULL COMMENT '修改时间',
  `deleted` int(0) NULL DEFAULT 0 COMMENT '删除标志',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 4 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;
​
-- ----------------------------
-- Records of role
-- ----------------------------
INSERT INTO `role` VALUES (1, 'ROLE_dba', '数据库管理员', '2022-10-02 10:32:06', NULL, 0);
INSERT INTO `role` VALUES (2, 'ROLE_admin', '系统管理员', '2022-10-02 10:32:06', NULL, 0);
INSERT INTO `role` VALUES (3, 'ROLE_user', '用户', '2022-10-02 10:32:06', NULL, 0);
​
SET FOREIGN_KEY_CHECKS = 1;
​</code></pre> 
<p>（用户关系表和角色表）</p> 
<pre><code class="language-sql"> Navicat Premium Data Transfer
​
 Source Server         : localhost_3306
 Source Server Type    : MySQL
 Source Server Version : 80028
 Source Host           : localhost:3306
 Source Schema         : test
​
 Target Server Type    : MySQL
 Target Server Version : 80028
 File Encoding         : 65001
​
 Date: 14/10/2022 01:10:48
*/
​
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;
​
-- ----------------------------
-- Table structure for user_role
-- ----------------------------
DROP TABLE IF EXISTS `user_role`;
CREATE TABLE `user_role`  (
  `id` int(0) NOT NULL AUTO_INCREMENT COMMENT 'id',
  `uid` int(0) NULL DEFAULT NULL COMMENT '用户id',
  `rid` int(0) NULL DEFAULT NULL COMMENT '角色id',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 6 CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;
​
-- ----------------------------
-- Records of user_role
-- ----------------------------
INSERT INTO `user_role` VALUES (1, 2, 1);
INSERT INTO `user_role` VALUES (2, 2, 2);
INSERT INTO `user_role` VALUES (3, 1, 2);
INSERT INTO `user_role` VALUES (4, 3, 3);
INSERT INTO `user_role` VALUES (5, 4, 3);
​
SET FOREIGN_KEY_CHECKS = 1;</code></pre> 
<p></p> 
<p>2.6.3创建用户实体类</p> 
<p><strong>并且用户实体类继承UserDetails</strong></p> 
<pre><code class="language-java">@Data
public class UserInfo implements UserDetails {
​
    private Long id;
    private String username;
    private String password;
    @TableField(exist = false)
    private Boolean enabled;
    @TableField(exist = false)
    private Boolean accountNonExpired;
    @TableField(exist = false)
    private Boolean accountNonLocked;
    @TableField(exist = false)
    private Boolean credentialsNonExpired;
    @TableField(exist = false)
    private List&lt;Role&gt; roleList;
    @TableLogic//逻辑删除的注解
    private Integer deleted;
​
    //获取用户的权限
    @Override
    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {
        List&lt;SimpleGrantedAuthority&gt; authorities=new ArrayList&lt;&gt;();
        for (Role role : roleList) {
            authorities.add(new SimpleGrantedAuthority(role.getName()));
        }
        return authorities;
    }
​
    @Override
    public boolean isAccountNonExpired() {
        return accountNonExpired=true;
    }
​
    @Override
    public boolean isAccountNonLocked() {
        return accountNonLocked=true;
    }
​
    @Override
    public boolean isCredentialsNonExpired() {
        return credentialsNonExpired=true;
    }
​
    @Override
    public boolean isEnabled() {
        return enabled=true;
    }
​
    @Override
    public String getUsername() {
        return username;
    }
​
    public String getPassword() {
        return password;
    }
}</code></pre> 
<p></p> 
<p><strong>role权限的实体类</strong></p> 
<pre><code class="language-java">package com.frank.pojo;
​
import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableLogic;
import lombok.Data;
​
import java.io.Serializable;
​
@Data
public class Role implements Serializable {
​
    @TableId(type = IdType.AUTO)
    private Long id;
    private String name;
    private String nameZh;
    @TableLogic
    private Integer deleted;
​
}
</code></pre> 
<h4>2.6.4重写UserDetailsService</h4> 
<pre><code class="language-java">@Service
public class UserDetailsServiceImpl implements UserDetailsService {
​
    @Autowired
    private UserMapper userMapper;
​
    //自定义认证逻辑
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        QueryWrapper&lt;UserInfo&gt; queryWrapper=new QueryWrapper&lt;&gt;();
        //根据username查询用户是否存在
        queryWrapper.eq("username",username);
        UserInfo userInfo = userMapper.selectOne(queryWrapper);
        //判断用户是否存在,不存在就返回异常
        if (userInfo==null){
            throw new ServiceException(Constants.CODE_500,"用户不存在");
        }else {
            List&lt;Role&gt; roles = userMapper.queryByIdRole(userInfo.getId());
            //用户存在，获取用户的角色，把角色存到用户校色里面
            userInfo.setRoleList(roles);
        }
        return userInfo;
    }
}</code></pre> 
<p></p> 
<p></p> 
<p><strong>userMapper.queryByIdRole(userInfo.getId());</strong></p> 
<pre><code class="language-java">@Mapper
public interface UserMapper extends BaseMapper&lt;UserInfo&gt; {
    //根据用户id获取用户的权限
    List&lt;Role&gt; queryByIdRole(Long id);
}</code></pre> 
<p>UserMapper.xml</p> 
<pre><code class="language-java">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;
&lt;mapper namespace="com.frank.mapper.UserMapper"&gt;


    &lt;select id="queryByIdRole" resultType="com.frank.pojo.Role"&gt;
        select r.id, r.name, r.nameZh
        from role r
                 INNER JOIN user_role ur
                            ON ur.rid = r.id
                 INNER JOIN `user_info` u
                            ON ur.uid = u.id
        where u.id = #{id} and r.deleted=0
    &lt;/select&gt;


&lt;/mapper&gt;</code></pre> 
<p>2.6.5 修改security的认证配置</p> 
<pre><code class="language-javascript"> //上面省略

	//注入UserDetailsServiceImpl的bean
  	@Autowired
    private UserDetailsServiceImpl userDetailsService;
    
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService);
    }</code></pre> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a790f2f0313d76971f2292240d6746c9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Verdi使用方法（1）— 打开user guide和加载波形</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/07d1b0b04dbf33fbca292a562bd4890d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">编译原理第二章课后习题，文法的二义性判断、语法树以及最左最右推导</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>