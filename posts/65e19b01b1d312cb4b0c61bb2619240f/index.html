<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>第三天：Flink的State、CheckPoint、Window窗口 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="第三天：Flink的State、CheckPoint、Window窗口" />
<meta property="og:description" content="5. Flink State管理跟恢复 Flink 是一个默认就有状态的分析引擎，前面的 WordCount 案例可以做到单词的数量的累加，其实是因为在内存中保证了每个单词的出现的次数，这些数据其实就是状态数据。但是如果一个 Task 在处理过程中挂掉了，那么它在内存中的状态都会丢失，所有的数据都需要重新计算。从容错和消息处理的语义（At -least-once 和 Exactly-once）上来说，Flink 引入了 State 和CheckPoint。
State 一般指一个具体的 Task/Operator 的状态(Task Slot/ 转换算子)，State 数据默认保存在 Java 的堆内存中。CheckPoint（可以理解为CheckPoint是把State数据持久化存储了）则表示了一个 Flink Job 在一个特定时刻的一份全局状态快照，即包含了所有Task/Operator 的状态。
1. 常用 State Flink 有两种常见的 State 类型，分别是:
Keyed State(键控状态)Operator State(算子状态) 1. Keyed State（键控状态） Keyed State：顾名思义就是基于 KeyedStream上的状态，这个状态是跟特定的 Key 绑定的。KeyedStream 流上的每一个 Key，都对应一个 State。Flink 针对 Keyed State 提供了 以下可以保存 State 的数据结构：
ValueState&lt;T&gt;:
保存一个可以更新和检索的值（如上所述，每个值都对应到当前的输入数据的 key，因此算子接收到的每个 key 都可能对应一个值）。 这个值可以通过 update(T) 进行更新，通过 T value() 进行检索。ListState&lt;T&gt;:
保存一个元素的列表。可以往这个列表中追加数据，并在当前的列表上 进行检索。可以通过 add(T) 或者 addAll(List) 进行添加元素，通过 Iterable get()获得整个列表。还可以通过 update(List) 覆盖当前的列表。ReducingState&lt;T&gt;:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/65e19b01b1d312cb4b0c61bb2619240f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-22T23:03:22+08:00" />
<meta property="article:modified_time" content="2020-07-22T23:03:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">第三天：Flink的State、CheckPoint、Window窗口</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="5_Flink_State_0"></a>5. Flink State管理跟恢复</h2> 
<p>Flink 是一个<strong>默认就有状态的分析引擎</strong>，前面的 <a href="https://sowhat.blog.csdn.net/article/details/107296787" rel="nofollow">WordCount</a> 案例可以做到单词的数量的累加，其实是因为在内存中保证了每个单词的出现的次数，这些数据其实就是状态数据。但是如果一个 Task 在处理过程中挂掉了，那么它在内存中的状态都会丢失，所有的数据都需要重新计算。从容错和消息处理的语义（At -least-once 和 Exactly-once）上来说，Flink 引入了 <code>State</code> 和<code>CheckPoint</code>。</p> 
<ul><li><code>State</code> 一般指一个具体的 Task/Operator 的状态(Task Slot/ 转换算子)，State 数据默认保存在 Java 的<code>堆</code>内存中。</li><li>CheckPoint（可以理解为<code>CheckPoint是把State数据持久化存储了</code>）则表示了一个 Flink Job 在一个特定时刻的一份全局<strong>状态快照</strong>，即包含了所有<code>Task/Operator</code> 的状态。<br> <img src="https://images2.imgbox.com/c8/f8/VFnUxRCm_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="1__State_7"></a>1. 常用 State</h4> 
<p>Flink 有两种常见的 State 类型，分别是:</p> 
<ul><li><code>Keyed State</code>(键控状态)</li><li><code>Operator State</code>(算子状态)</li></ul> 
<h6><a id="1_Keyed_State_12"></a>1. Keyed State（键控状态）</h6> 
<p>Keyed State：顾名思义就是基于 <code>KeyedStream</code>上的状态，这个状态是跟特定的 Key 绑定的。KeyedStream 流上的每一个 Key，都对应一个 State。Flink 针对 Keyed State 提供了 以下可以保存 State 的数据结构：</p> 
<ol><li><code>ValueState&lt;T&gt;</code>:<br> 保存一个可以更新和检索的值（如上所述，每个值都对应到当前的输入数据的 key，因此算子接收到的每个 key 都可能对应一个值）。 这个值可以通过 update(T) 进行更新，通过 T value() 进行检索。</li><li><code>ListState&lt;T&gt;</code>:<br> 保存一个元素的列表。可以往这个列表中追加数据，并在当前的列表上 进行检索。可以通过 add(T) 或者 addAll(List) 进行添加元素，通过 Iterable <code>get()</code>获得整个列表。还可以通过 <code>update</code>(List) 覆盖当前的列表。</li><li><code>ReducingState&lt;T&gt;</code>:<br> 保存一个单值，表示添加到状态的所有值的聚合。接口与 ListState 类似，但使用 add(T) 增加元素，会使用提供的 ReduceFunction 进行聚合。</li><li><code>AggregatingState&lt;IN, OUT&gt;</code>:<br> 保留一个单值，表示添加到状态的所有值的聚合。和 ReducingState 相反的是, 聚合类型可能与 添加到状态的元素的类型不同。 接口与 ListState 类似，但使用 add(IN) 添加的元素会用指定的 AggregateFunction 进行聚 合。</li><li><code>FoldingState&lt;T, ACC&gt;</code>:<br> 保留一个单值，表示添加到状态的所有值的聚合。 与 ReducingState 相反，聚合类型可能与添加到状态的元素类型不同。接口与 ListState 类似，但使用 add（T）添加的元素会用指定的 FoldFunction 折叠成聚合值。</li><li><code>MapState&lt;UK, UV&gt;</code>:<br> 维护了一个映射列表。 你可以添加键值对到状态中，也可以获得 反映当前所有映射的迭代器。使用 put(UK，UV) 或者 putAll(Map&lt;UK，UV&gt;) 添加映射。 使用 get(UK) 检索特定 key。 使用 entries()，keys() 和 values() 分别检索映射、 键和值的可迭代视图。</li></ol> 
<h6><a id="2_Operator_State_26"></a>2. Operator State（算子状态）</h6> 
<p>Operator State 与 Key 无关，而是与<code>Operator</code>绑定，整个 Operator 只对应一个 State。 比如：Flink 中的 Kafka Connector 就使用了 Operator State，它会在每个 Connector 实例 中，保存该实例消费 Topic 的所有(partition, offset)映射。<img src="https://images2.imgbox.com/ca/f4/GulaIm3v_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="3_Keyed_State__28"></a>3. Keyed State 案例</h6> 
<p><a href="https://sowhat.blog.csdn.net/article/details/107323074" rel="nofollow">demo1</a>：监控每一个手机号码，如果这个号码在5秒内，所有呼叫它的日志都是失败的，<br> <code>demo2 需求</code>：计算每个手机的呼叫间隔时间，单位是毫秒。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>sowhat<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>state

<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span><span class="token punctuation">{<!-- --></span>URL<span class="token punctuation">,</span> URLDecoder<span class="token punctuation">}</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>sowhat<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>BatchWordCount<span class="token punctuation">.</span>getClass
<span class="token keyword">import</span> com<span class="token punctuation">.</span>sowhat<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>source<span class="token punctuation">.</span>StationLog
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>RichFlatMapFunction
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token punctuation">{<!-- --></span>ValueState<span class="token punctuation">,</span> ValueStateDescriptor<span class="token punctuation">}</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span>Configuration
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>StreamExecutionEnvironment
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Collector

<span class="token comment">/**
  * 基站日志
  * @param sid      基站的id
  * @param callOut  主叫号码
  * @param callInt  被叫号码
  * @param callType 呼叫类型
  * @param callTime 呼叫时间 (毫秒)
  * @param duration 通话时长 （秒）
  */</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">StationLog</span><span class="token punctuation">(</span>sid<span class="token operator">:</span> String<span class="token punctuation">,</span> var callOut<span class="token operator">:</span> String<span class="token punctuation">,</span> var callInt<span class="token operator">:</span> String<span class="token punctuation">,</span> callType<span class="token operator">:</span> String<span class="token punctuation">,</span> callTime<span class="token operator">:</span> Long<span class="token punctuation">,</span> duration<span class="token operator">:</span> Long<span class="token punctuation">)</span>

<span class="token comment">/**
  * 第一种方法的实现
  * 统计每个手机的呼叫时间间隔，单位是毫秒
  */</span>
object TestKeyedState1 <span class="token punctuation">{<!-- --></span>

  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>_

    <span class="token comment">//读取数据源</span>
    val filePath<span class="token operator">:</span> URL <span class="token operator">=</span> getClass<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/station.log"</span><span class="token punctuation">)</span> <span class="token comment">//使用相对路径来得到完整的文件路径</span>
    val packagePath<span class="token operator">:</span> String <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"%20"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//解决路径中含有空格的情况</span>
    val str<span class="token operator">:</span>String <span class="token operator">=</span> URLDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>packagePath<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//解决路径包含中文的情况</span>
    val stream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>StationLog<span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        val arr<span class="token operator">:</span>Array<span class="token punctuation">[</span>String<span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
        <span class="token keyword">new</span> <span class="token class-name">StationLog</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">.</span>toLong<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    stream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>callOut<span class="token punctuation">)</span> <span class="token comment">//分组</span>
      <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CallIntervalFunction</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    streamEnv<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//输出的是一个二元组（手机号码，时间间隔）</span>
  <span class="token keyword">class</span> <span class="token class-name">CallIntervalFunction</span> <span class="token keyword">extends</span> <span class="token class-name">RichFlatMapFunction</span><span class="token punctuation">[</span>StationLog<span class="token punctuation">,</span> <span class="token punctuation">(</span>String<span class="token punctuation">,</span> Long<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//定义一个状态，用于保存前一次呼叫的时间</span>
    <span class="token keyword">private</span> var preCallTimeState<span class="token operator">:</span> ValueState<span class="token punctuation">[</span>Long<span class="token punctuation">]</span> <span class="token operator">=</span> _

    override def <span class="token function">open</span><span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      preCallTimeState <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">[</span>Long<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"pre"</span><span class="token punctuation">,</span> classOf<span class="token punctuation">[</span>Long<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    override def <span class="token function">flatMap</span><span class="token punctuation">(</span>value<span class="token operator">:</span> StationLog<span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> Long<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//从状态中取得前一次呼叫的时间</span>
      val preCallTime<span class="token operator">:</span>Long <span class="token operator">=</span> preCallTimeState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>preCallTime <span class="token operator">==</span> null <span class="token operator">||</span> preCallTime <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//状态中没有，肯定是第一次呼叫</span>
        preCallTimeState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>callTime<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//状态中有数据,则要计算时间间隔</span>
        val interval<span class="token operator">:</span>Long <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>callTime <span class="token operator">-</span> preCallTime<span class="token punctuation">)</span>
        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>callOut<span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果：</p> 
<pre><code>4&gt; (18600003532,7000)
2&gt; (18600003713,0)
1&gt; (18600003502,9000)
1&gt; (18600003502,0)
1&gt; (18600003502,9000)
1&gt; (18600007699,0)
1&gt; (18600000005,150000)
</code></pre> 
<p>stationlog.txt文件信息如下：</p> 
<pre><code>station_1,18600000005,18900007729,fail,1577080453123,0
station_1,18600000005,18900007729,success,1577080603123,349
station_8,18600007461,18900006987,barring,1577080453123,0
station_5,18600009356,18900006066,busy,1577080455129,0
station_4,18600001941,18900003949,busy,1577080455129,0
...自己造数据即可
</code></pre> 
<p>还有第二种简单的方法：调用<code>flatMapWithState</code> 算子</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>sowhat<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>state

<span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span><span class="token punctuation">{<!-- --></span>URL<span class="token punctuation">,</span> URLDecoder<span class="token punctuation">}</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>sowhat<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>source<span class="token punctuation">.</span>StationLog
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>StreamExecutionEnvironment

<span class="token comment">/**
  * 第二种方法的实现
  * 统计每个手机的呼叫时间间隔，单位是毫秒
  */</span>
object TestKeyedState2 <span class="token punctuation">{<!-- --></span>

  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>_

    <span class="token comment">//读取数据源</span>
    val filePath<span class="token operator">:</span> URL <span class="token operator">=</span> getClass<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/station.log"</span><span class="token punctuation">)</span> <span class="token comment">//使用相对路径来得到完整的文件路径</span>
    val packagePath<span class="token operator">:</span> String <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"%20"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//解决路径中含有空格的情况</span>
    val str<span class="token operator">:</span> String <span class="token operator">=</span> URLDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>packagePath<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//解决路径包含中文的情况</span>

    val stream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>StationLog<span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        var arr <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
        <span class="token keyword">new</span> <span class="token class-name">StationLog</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">.</span>toLong<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

    stream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>callOut<span class="token punctuation">)</span> <span class="token comment">//分组</span>
      <span class="token comment">//有两种情况1、状态中有上一次的通话时间，2、没有。采用scala中的模式匹配</span>
      <span class="token punctuation">.</span>mapWithState<span class="token punctuation">[</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> Long<span class="token punctuation">)</span><span class="token punctuation">,</span> StationLog<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> <span class="token punctuation">(</span>in<span class="token operator">:</span> StationLog<span class="token punctuation">,</span> None<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>callOut<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//状态中没有值 是第一次呼叫</span>
      <span class="token keyword">case</span> <span class="token punctuation">(</span>in<span class="token operator">:</span> StationLog<span class="token punctuation">,</span> pre<span class="token operator">:</span> Some<span class="token punctuation">[</span>StationLog<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//状态中有值，是第二次呼叫</span>
        var interval<span class="token operator">:</span>Long <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>callTime <span class="token operator">-</span> pre<span class="token punctuation">.</span>get<span class="token punctuation">.</span>callTime<span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>callOut<span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    streamEnv<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2_CheckPoint_164"></a>2. CheckPoint</h4> 
<p>当程序出现问题需要恢复<code>State</code> 数据的时候，只有程序提供支持才可以实现<code>State</code> 的容错。<code>State</code> 的容错需要依靠 <code>CheckPoint</code>机制，这样才可以保证 <code>Exactly-once</code> 这种语义，但是注意，<strong>它只能保证 Flink 系统内的 Exactly-once</strong>，比如 Flink 内置支持的算子。针对 Source 和 Sink 组件，如果想要保证 Exactly-once 的话，则<strong>这些组件本身应支持这种语义</strong>。</p> 
<h6><a id="1__CheckPoint__166"></a>1. CheckPoint 原理</h6> 
<p>Flink 中基于<code>异步</code>轻量级的分布式快照技术提供了 <code>Checkpoints</code>容错机制，分布式快照可以将同一时间点 <code>Task/Operator</code> 的状态数据全局统一快照处理，包括前面提到的 <code>Keyed State</code>和 <code>Operator State</code>。Flink 会在输入的数据集上间隔性地生成 <code>checkpoint barrier</code>， 通过<code>栅栏</code>（barrier）将间隔时间段内的数据划分到相应的 checkpoint 中。如下图:<br> <img src="https://images2.imgbox.com/6a/fe/JY8KRnYB_o.png" alt="在这里插入图片描述"><br> 比如序列偶数求和跟奇数求和：<br> <img src="https://images2.imgbox.com/e9/ba/MrTlOZVc_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="2_CheckPoint__171"></a>2. CheckPoint 参数和设置</h6> 
<p>默认情况下 Flink <code>不开启</code>检查点的，用户需要在程序中通过调用方法配置和开启检查点，另外还可以调整其他相关参数：</p> 
<ol><li> <p>Checkpoint 开启和时间间隔指定： 开启检查点并且指定检查点时间间隔为 1000ms，根据实际情况自行选择，如果状态比较大，则建议适当增加该值。<code>streamEnv.enableCheckpointing(1000)</code></p> </li><li> <p><code>exactly-ance</code> 和 <code>at-least-once</code> 语义选择：<br> 选择 exactly-once 语义保证<strong>整个应用内端到端的数据一致性</strong>，这种情况比较适合于数据要求比较高，不允许出现丢数据或者数据重复，与此同时，Flink 的性能也<strong>相对较弱</strong>，而 at-least-once 语义更适合于时廷和吞吐量要求非常高但对数据的一致性要求不高的场景。 如下通过<code>setCheckpointingMode()</code>方法来设 定语义模式， <strong>默认情况 使用的是 exactly-once 模式</strong>。</p> </li></ol> 
<pre><code class="prism language-java"> streamEnv<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span><span class="token function">setCheckpointingMode</span><span class="token punctuation">(</span>CheckpointingMode<span class="token punctuation">.</span>EXACT LY_ONCE<span class="token punctuation">)</span>；
 <span class="token comment">//或者 </span>
 streamEnv<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span><span class="token function">setCheckpointingMode</span><span class="token punctuation">(</span>CheckpointingMode<span class="token punctuation">.</span>AT_LE AST_ONCE<span class="token punctuation">)</span>
</code></pre> 
<ol start="3"><li>Checkpoint 超时时间：<br> 超时时间指定了每次 Checkpoint 执行过程中的上限时间范围，一旦 Checkpoint 执行时 间超过该阈值，Flink 将会中断 Checkpoint 过程，并按照超时处理。该指标可以通过 <code>setCheckpointTimeout</code> 方法设定，默认为 <code>10</code>分钟。<code>streamEnv.getCheckpointConfig.setCheckpointTimeout(50000)</code></li><li>检查点之间最小时间间隔：<br> 该参数主要目的是<strong>设定两个 Checkpoint 之间的最小时间间隔</strong>，防止出现例如状态数据过大而导致 Checkpoint 执行时间过长，从而导致 Checkpoint 积压过多，最终 Flink 应用密集地触发 Checkpoint 操作，会占用了大量计算资源而影响到整个应用的性能。</li></ol> 
<pre><code class="prism language-java">streamEnv<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span><span class="token function">setMinPauseBetweenCheckpoints</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">)</span>
</code></pre> 
<ol start="5"><li>最大并行执行的检查点数量：<br> 通过 <code>setMaxConcurrentCheckpoints()</code>方法设定能够最大同时执行的 Checkpoint 数量。 在默认情况下只有一个检查点可以运行，根据用户指定的数量可以同时触发多个 Checkpoint，进而提升 Checkpoint 整体的效率。</li></ol> 
<pre><code class="prism language-java">streamEnv<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span><span class="token function">setMaxConcurrentCheckpoints</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<ol start="6"><li>是否删除 Checkpoint 中保存的数据：<br> 设置为 <code>RETAIN_ON_CANCELLATION</code>：表示一旦 Flink 处理程序被 cancel 后，会保留 CheckPoint 数据，以便根据实际需要恢复到指定的 CheckPoint。 设置为 <code>DELETE_ON_CANCELLATION</code>：表示一旦 Flink 处理程序被 cancel 后，会删除 CheckPoint 数据，只有 Job 执行失败的时候才会保存 CheckPoint。</li></ol> 
<pre><code class="prism language-java"><span class="token comment">//删除 </span>
streamEnv<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span><span class="token function">enableExternalizedCheckpoints</span><span class="token punctuation">(</span>ExternalizedCheckp ointCleanup<span class="token punctuation">.</span>DELETE_ON_CANCELLATION<span class="token punctuation">)</span> 
<span class="token comment">//保留</span>
streamEnv<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span><span class="token function">enableExternalizedCheckpoints</span><span class="token punctuation">(</span>ExternalizedCheckp ointCleanup<span class="token punctuation">.</span>RETAIN_ON_CANCELLATION<span class="token punctuation">)</span>
</code></pre> 
<ol start="7"><li>TolerableCheckpointFailureNumber：<br> 设置可以容忍的检查的失败数，超过这个数量则系统自动关闭和停止任务。</li></ol> 
<pre><code class="prism language-java"> streamEnv<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span><span class="token function">setTolerableCheckpointFailureNumber</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<h6><a id="3__StateBackend_208"></a>3. 保存机制 StateBackend(状态后端)</h6> 
<p>默认情况下，State 会保存在 TaskManager 的<code>内存</code>中，<code>CheckPoint</code>会存储在 <code>JobManager</code>的内存中。<code>State</code>和 <code>CheckPoint</code>的存储位置取决于<code>StateBackend</code>的配置。Flink 一共提供 了 3 种 <code>StateBackend</code>。包括基于内存的 <code>MemoryStateBackend</code>、基于文件系统的<code>FsStateBackend</code>，以及基于 <code>RockDB</code> 作为存储介质的 <code>RocksDBState-Backend</code>。</p> 
<h6><a id="1_MemoryStateBackend_210"></a>1. MemoryStateBackend</h6> 
<p>基于内存的状态管理具有非常<code>快速</code>和<code>高效</code>的特点，但也具有非常多的限制，最主要的就 是内存的容量限制，一旦存储的状态数据过多就会导致系统内存溢出等问题，从而影响整个 应用的正常运行。同时如果机器出现问题，整个主机内存中的状态数据都会丢失，进而无法 恢复任务中的状态数据。因此从数据安全的角度建议用户<code>尽可能地避免</code>在生产环境中使用 MemoryStateBackend。<br> <img src="https://images2.imgbox.com/00/88/tDuxi4jt_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token comment">// 设定存储空间为10G</span>
streamEnv<span class="token punctuation">.</span><span class="token function">setStateBackend</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MemoryStateBackend</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h6><a id="2_FsStateBackend_217"></a>2. FsStateBackend</h6> 
<p>和 <code>MemoryStateBackend</code>有所不同，FsStateBackend 是<code>基于文件系统</code>的一种状态管理器， 这里的文件系统可以是本地文件系统，也可以是 HDFS 分布式文件系统。FsStateBackend 更适合任务状态非常大的情况，例如应用中含有时间范围非常长的窗口计算，或 Key/value State 状态数据量非常大的场景。<br> TaskManager仍然使用内存保存数据，但是进行CheckPoint的时候是<strong>将数据保存到FS中</strong>。<br> <img src="https://images2.imgbox.com/f7/8f/pvyfgKky_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"> streamEnv<span class="token punctuation">.</span><span class="token function">setStateBackend</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FsStateBackend</span><span class="token punctuation">(</span><span class="token string">"hdfs://hadoop101:9000/checkpoint/cp1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h6><a id="3_RocksDBStateBackend_224"></a>3. RocksDBStateBackend</h6> 
<p>RocksDBStateBackend 是 Flink 中内置的第三方状态管理器，和前面的状态管理器不同，RocksDBStateBackend 需要单独引入相关的依赖包到工程中。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-statebackend-rocksdb_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>RocksDBStateBackend 采用<code>异步</code>的方式进行状态数据的 <code>Snapshot</code>，任务中的状态数据首先被写入本地 RockDB 中，这样在 RockDB 仅会存储正在进行计算的热数据，而需要进行 CheckPoint 的时候，会把本地的数据直接复制到远端的 FileSystem 中。</p> 
<p>与 FsStateBackend 相比，RocksDBStateBackend 在性能上要比 FsStateBackend 高一些，主要是因为借助于 RocksDB 在本地存储了最新热数据，然后通过异步的方式再同步到文件系 统中，但 <code>RocksDBStateBackend</code>和 <code>MemoryStateBackend</code>相比性能就会较弱一些。RocksDB 克服了 State 受内存限制的缺点，同时又能够持久化到远端文件系统中，推荐在生产中使用。</p> 
<pre><code class="prism language-java"> streamEnv<span class="token punctuation">.</span><span class="token function">setStateBackend</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RocksDBStateBackend</span> <span class="token punctuation">(</span><span class="token string">"hdfs://hadoop101:9000/checkpoint/cp2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9b/d0/UDRYPad8_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="4__StateBackend_240"></a>4. 全局配置 StateBackend</h6> 
<p>以上的代码都是<code>单 job</code> 配置状态后端，也可以全局配置状态后端，需要修改 flink-conf.yaml 配置文件:</p> 
<pre><code class="prism language-java">state<span class="token punctuation">.</span>backend<span class="token operator">:</span> filesystem
filesystem 表示使用 FsStateBackend<span class="token punctuation">,</span> 
jobmanager 表示使用 MemoryStateBackend 
rocksdb 表示使用 RocksDBStateBackend。
<span class="token operator">--</span><span class="token operator">-</span>
flink<span class="token operator">-</span>conf<span class="token punctuation">.</span>yaml 配置文件中
state<span class="token punctuation">.</span>checkpoints<span class="token punctuation">.</span>dir<span class="token operator">:</span> hdfs<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>hadoop101<span class="token operator">:</span><span class="token number">9000</span><span class="token operator">/</span>checkpoints
</code></pre> 
<p>默认情况下，如果设置了 CheckPoint 选项，则 Flink 只保留最近成功生成的 1 个 CheckPoint，而当 Flink 程序失败时，可以通过最近的 CheckPoint 来进行恢复。但是，如果希望保留多个CheckPoint，并能够根据实际需要选择其中一个进行恢复，就会更加灵活。 添加如下配置，指定最多可以保存的 CheckPoint 的个数。</p> 
<pre><code class="prism language-java">state<span class="token punctuation">.</span>checkpoints<span class="token punctuation">.</span>num<span class="token operator">-</span>retained<span class="token operator">:</span> <span class="token number">2</span>
</code></pre> 
<h6><a id="4_Checkpoint_255"></a>4. Checkpoint案例</h6> 
<p><code>案例</code>:设置 HDFS 文件系统的状态后端，取消 Job 之后再次恢复 Job。<br> 使用WordCount案例来测试一下HDFS的状态后端，先运行一段时间Job，然后cancel，在重新启动，看看状态是否是连续的</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>sowhat<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>state

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>state<span class="token punctuation">.</span>filesystem<span class="token punctuation">.</span>FsStateBackend
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>CheckpointingMode
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>CheckpointConfig<span class="token punctuation">.</span>ExternalizedCheckpointCleanup
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>StreamExecutionEnvironment

object TestCheckPointByHDFS <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//使用WordCount案例来测试一下HDFS的状态后端，先运行一段时间Job，然后cancel，在重新启动，看看状态是否是连续的</span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1、初始化Flink流计算的环境</span>
    val streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token comment">//开启CheckPoint并且设置一些参数</span>
    streamEnv<span class="token punctuation">.</span><span class="token function">enableCheckpointing</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span> <span class="token comment">//每隔5秒开启一次CheckPoint</span>
    streamEnv<span class="token punctuation">.</span><span class="token function">setStateBackend</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FsStateBackend</span><span class="token punctuation">(</span><span class="token string">"hdfs://hadoop101:9000/checkpoint/cp1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//存放检查点数据</span>

    streamEnv<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span><span class="token function">setCheckpointingMode</span><span class="token punctuation">(</span>CheckpointingMode<span class="token punctuation">.</span>EXACTLY_ONCE<span class="token punctuation">)</span>
    streamEnv<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span><span class="token function">setCheckpointTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
    streamEnv<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span><span class="token function">setMaxConcurrentCheckpoints</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    streamEnv<span class="token punctuation">.</span>getCheckpointConfig<span class="token punctuation">.</span><span class="token function">enableExternalizedCheckpoints</span><span class="token punctuation">(</span>ExternalizedCheckpointCleanup<span class="token punctuation">.</span>RETAIN_ON_CANCELLATION<span class="token punctuation">)</span> <span class="token comment">//终止job保留检查的数据</span>
    <span class="token comment">//修改并行度</span>
    streamEnv<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">//默认所有算子的并行度为1</span>
    <span class="token comment">//2、导入隐式转换</span>
    <span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>_
    <span class="token comment">//3、读取数据,读取sock流中的数据</span>
    val stream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>String<span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"hadoop101"</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span> <span class="token comment">//DataStream ==&gt; spark 中Dstream</span>
    <span class="token comment">//4、转换和处理数据</span>
    val result<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> Int<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//分组算子  : 0 或者 1 代表下标。前面的DataStream[二元组] , 0代表单词 ，1代表单词出现的次数</span>
      <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">//聚会累加算子</span>

    <span class="token comment">//5、打印结果</span>
    result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"结果"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">//6、启动流计算程序</span>
    streamEnv<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"wordcount"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>打包上传到WebUI:<br> <img src="https://images2.imgbox.com/42/ae/Sau3EPmS_o.png" alt="在这里插入图片描述"></p> 
<p>在<code>nc -lk 8888</code> 输入若干单词。然后查找 WebUI 的输出。然后通过WebUI将任务取消。最后尝试将任务重启。</p> 
<pre><code class="prism language-java"><span class="token punctuation">.</span>/flink run <span class="token operator">-</span>d <span class="token operator">-</span>s hdfs<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>hadoop101<span class="token operator">:</span><span class="token number">9000</span><span class="token operator">/</span>checkpoint<span class="token operator">/</span>cp1<span class="token operator">/</span>精确到跟meta数据同级目录 <span class="token operator">-</span>c com<span class="token punctuation">.</span>sowhat<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>state<span class="token punctuation">.</span>CheckpointOnFsBackend <span class="token operator">/</span>home<span class="token operator">/</span>Flink<span class="token operator">-</span>Demo<span class="token operator">-</span><span class="token number">1.0</span><span class="token operator">-</span>SNAPSHOT<span class="token punctuation">.</span>jar
</code></pre> 
<p>也可以通过WebUI 重启，指定 MainClass跟 CheckPoint即可。此处关键在于CheckPoint路径要写对！</p> 
<h6><a id="5_SavePoint_307"></a>5. SavePoint</h6> 
<p><strong>Savepoints 是检查点的一种特殊实现</strong>，底层实现其实也是使用 Checkpoints 的机制。 Savepoints 是用户以<code>手工命令</code>的方式触发 Checkpoint,并将结果持久化到指定的存储路径 中，其主要目的是帮助用户在升级和维护集群过程中保存系统中的状态数据，避免因为停机运维或者升级应用等正常终止应用的操作而导致系统无法恢复到原有的计算状态的情况，从而无法实现从端到端的 Excatly-Once 语义保证。</p> 
<p><strong>配置 Savepoints 的存储路径</strong><br> 在 flink-conf.yaml 中配置 SavePoint 存储的位置，设置后，如果要创建指定 Job 的 SavePoint，可以不用在手动执行命令时指定 SavePoint 的位置。</p> 
<pre><code class="prism language-java">state<span class="token punctuation">.</span>savepoints<span class="token punctuation">.</span>dir<span class="token operator">:</span> hdfs<span class="token operator">:</span><span class="token operator">/</span>hadoop101<span class="token operator">:</span><span class="token number">9000</span><span class="token operator">/</span>savepoints
</code></pre> 
<p><strong>在代码中设置算子 ID</strong><br> 为了能够在作业的不同版本之间以及 Flink 的不同版本之间顺利升级，<strong>强烈推荐程序员 通过手动给算子赋予 ID</strong>，这些 ID 将用于确定每一个算子的状态范围。如果不手动给各算子 指定 ID，则会由 Flink 自动给每个算子生成一个 ID。而这些自动生成的 ID 依赖于程序的结 构，并且对代码的更改是很敏感的。因此，强烈建议用户手动设置 ID。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>sowhat<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>state

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>StreamExecutionEnvironment
object TestSavePoints <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1、初始化Flink流计算的环境</span>
    val streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token comment">//修改并行度</span>
    streamEnv<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">//默认所有算子的并行度为1</span>
    <span class="token comment">//2、导入隐式转换</span>
    <span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>_
    <span class="token comment">//3、读取数据,读取sock流中的数据</span>
    val stream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>String<span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"hadoop101"</span><span class="token punctuation">,</span><span class="token number">8888</span><span class="token punctuation">)</span> <span class="token comment">//DataStream ==&gt; spark 中Dstream</span>
    <span class="token punctuation">.</span><span class="token function">uid</span><span class="token punctuation">(</span><span class="token string">"socket001"</span><span class="token punctuation">)</span>
    <span class="token comment">//4、转换和处理数据</span>
    val result<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> Int<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uid</span><span class="token punctuation">(</span><span class="token string">"flatmap001"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uid</span><span class="token punctuation">(</span><span class="token string">"map001"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//分组算子  : 0 或者 1 代表下标。前面的DataStream[二元组] , 0代表单词 ，1代表单词出现的次数</span>
      <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uid</span><span class="token punctuation">(</span><span class="token string">"sum001"</span><span class="token punctuation">)</span>

    <span class="token comment">//5、打印结果</span>
    result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"结果"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">//6、启动流计算程序</span>
    streamEnv<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"wordcount"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>触发 SavePoint</p> 
<pre><code class="prism language-java"><span class="token comment">//先启动Job</span>
<span class="token punctuation">[</span>root<span class="token annotation punctuation">@hadoop101</span> bin<span class="token punctuation">]</span># <span class="token punctuation">.</span>/flink run <span class="token operator">-</span>c com<span class="token punctuation">.</span>bjsxt<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>state<span class="token punctuation">.</span>TestSavepoints <span class="token operator">-</span>d <span class="token operator">/</span>home<span class="token operator">/</span>Flink<span class="token operator">-</span>Demo<span class="token operator">-</span><span class="token number">1.0</span><span class="token operator">-</span>SNAPSHOT<span class="token punctuation">.</span>jar
<span class="token punctuation">[</span>root<span class="token annotation punctuation">@hadoop101</span> bin<span class="token punctuation">]</span># <span class="token punctuation">.</span>/flink list 获取 job 对应ID
<span class="token comment">//再取消Job </span>
<span class="token punctuation">[</span>root<span class="token annotation punctuation">@hadoop101</span> bin<span class="token punctuation">]</span># <span class="token punctuation">.</span>/flink savepoint <span class="token number">6</span>ecb8cfda5a5200016ca6b01260b94ce 
<span class="token comment">// 触发SavePoint</span>
<span class="token punctuation">[</span>root<span class="token annotation punctuation">@hadoop101</span> bin<span class="token punctuation">]</span># <span class="token punctuation">.</span>/flink cancel <span class="token number">6</span>ecb8cfda5a5200016ca6b01260b94ce
</code></pre> 
<p><strong>从 SavePoint 启动 Job</strong><br> 大致方法跟上面的CheckPoint启动Job类似。</p> 
<h6><a id="6__358"></a>6. 总结</h6> 
<p>若干个常用的状态算子大致如何存储的要了解。<br> CheckPoint的原理主要是<strong>图示</strong>，理解如何保证精准一致性的。<br> CheckPoint一般有基于内存的，基于HDFS的跟基于DB的，整体来说基于DB的把数据存储早DB中跟HDFS中是最好的。<br> SavePoint是手动触发的CheckPoint，一般方便线上迁移的功能等，并且尽量给每一个算子自定义一个UID，</p> 
<h2><a id="6_Window__363"></a>6. Window 窗口</h2> 
<p><code>无界数据变为若干个有界数据</code>。Windows 计算是流式计算中非常常用的数据计算方式之一，通过按照固定时间或长度将数据流切分成不同的窗口，然后对数据进行相应的聚合运算，从而得到一定时间范围内的统计结果。例如统计最近 5 分钟内某基站的呼叫数，此时基站的数据在不断地产生，但是通过 5 分钟的窗口将数据限定在固定时间范围内，就可以对该范围内的有界数据执行聚合处理， 得出最近 5 分钟的基站的呼叫数量。</p> 
<h4><a id="1_Window_365"></a>1. Window分类</h4> 
<h6><a id="1_Global_Window__Keyed_Window_366"></a>1. Global Window 和 Keyed Window</h6> 
<p>在运用窗口计算时，Flink根据上游数据集<strong>是否为KeyedStream类型</strong>，对应的Windows 也 会有所不同。</p> 
<ul><li>Keyed Window: 上游数据集如果是 KeyedStream 类型，则调用 DataStream API 的<code>window()</code>方法，数据会根据 Key 在不同的 Task 实例中并行分别计算，最后得出针对每个 Key 统计的结果。</li><li>Global Window:如果是 Non-Keyed 类型，则调用 <code>WindowsAll()</code>方法，所有的<strong>数据都会在窗口算子中由到一个 Task 中计算</strong>，并得到全局统计结果。</li></ul> 
<pre><code class="prism language-java"><span class="token comment">//读取文件数据</span>
val data <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span><span class="token function">readTextFile</span><span class="token punctuation">(</span>getClass<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/station.log"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getPath<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
var arr <span class="token operator">=</span>line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span> <span class="token keyword">new</span>
<span class="token class-name">StationLog</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">.</span>toLong<span class="token punctuation">,</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">.</span>to Long<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//Global Window </span>
data<span class="token punctuation">.</span><span class="token function">windowAll</span><span class="token punctuation">(</span>自定义的WindowAssigner<span class="token punctuation">)</span>
<span class="token comment">//Keyed Window</span>
data<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>sid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span>自定义的WindowAssigner<span class="token punctuation">)</span>
</code></pre> 
<h6><a id="2_Time_Window__Count_Window_382"></a>2. Time Window 和 Count Window</h6> 
<p>基于业务数据的方面考虑，Flink 又支持两种类型的窗口，一种是基于时间的窗口叫<code>Time Window</code>。还有一种基于输入数据数量的窗口叫 <code>Count Window</code></p> 
<h6><a id="3_Time_Window_384"></a>3. Time Window(时间窗口)</h6> 
<p>根据不同的业务场景，Time Window 也可以分为三种类型，分别是<code>滚动窗口</code>(Tumbling Window)、<code>滑动窗口</code>(Sliding Window)和<code>会话窗口</code>(Session Window)</p> 
<ol><li>滚动窗口(Tumbling Window)<br> 滚动窗口是根据固定时间进行切分，且窗口和窗口之间的元素<code>互不重叠</code>。这种类型的窗 口的最大特点是比较简单。只需要指定一个窗口长度(window size)。<br> <img src="https://images2.imgbox.com/7b/1b/ntZTKjoF_o.png" alt="在这里插入图片描述"></li></ol> 
<pre><code class="prism language-java"><span class="token comment">//每隔5秒统计每个基站的日志数量 </span>
data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>stationLog<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>stationLog<span class="token punctuation">.</span>sid<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token comment">//.window(TumblingEventTimeWindows.of(Time.seconds(5))) 跟上面同样功能</span>
<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">//聚合</span>
</code></pre> 
<p>其中时间间隔可以是 Time.milliseconds(x)、Time.seconds(x)或 Time.minutes(x)。</p> 
<ol start="2"><li>滑动窗口(Sliding Window)<br> 滑动窗口也是一种比较常见的窗口类型，其特点是在滚动窗口基础之上增加了窗口滑动时间(Slide Time)，且允许窗口数据发生重叠。当 Windows size 固定之后，窗口并不像 滚动窗口按照 Windows Size 向前移动，而是根据设定的 Slide Time 向前滑动。窗口之间的 数据重叠大小根据 Windows size 和 Slide time 决定，当 Slide time 小于 Windows size 便会发生窗口重叠，Slide size 大于 Windows size 就会出现窗口不连续，数据可能不能在 任何一个窗口内计算，Slide size 和 Windows size 相等时，Sliding Windows 其实就是 Tumbling Windows。<br> <img src="https://images2.imgbox.com/56/3e/mtqEbLy9_o.png" alt="在这里插入图片描述"></li></ol> 
<pre><code class="prism language-java"><span class="token comment">//每隔3秒计算最近5秒内，每个基站的日志数量 </span>
data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>stationLog<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>stationLog<span class="token punctuation">.</span>sid<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//.window(SlidingEventTimeWindows.of(Time.seconds(5),Time.seconds(3)))</span>
<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<ol start="3"><li>会话窗口(Session Window)<br> 会话窗口(Session Windows)主要是将某段时间内活跃度较高的数据聚合成一个窗口 进行计算，窗口的触发的条件是 <code>Session Gap</code>，是指<code>在规定的时间内如果没有数据活跃接入</code>， 则认为窗口结束，然后触发窗口计算结果。需要注意的是如果数据一直不间断地进入窗口， 也会导致窗口始终不触发的情况。与滑动窗口、滚动窗口不同的是，Session Windows 不需 要有固定 windows size 和 slide time，只需要定义 session gap，来规定不活跃数据的时 间上限即可。<br> <img src="https://images2.imgbox.com/ce/4b/9gD2HbMC_o.png" alt="在这里插入图片描述"></li></ol> 
<pre><code class="prism language-java"><span class="token comment">//3秒内如果没有数据进入，则计算每个基站的日志数量</span>
 data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>stationLog<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>stationLog<span class="token punctuation">.</span>sid<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span>EventTimeSessionWindows<span class="token punctuation">.</span><span class="token function">withGap</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<h6><a id="4_Count_Window_417"></a>4. Count Window(数量窗口)</h6> 
<p>Count Window 也有滚动窗口、滑动窗口等。由于使用比较少TODO，比如五条数据算一批次这样的统计。</p> 
<h4><a id="2_WindowAPI_419"></a>2. Window的API</h4> 
<p>在以后的实际案例中 <code>Keyed Window</code>使用最多，所以我们需要掌握 Keyed Window 的算子， 在每个窗口算子中包含了 Windows Assigner、Windows Trigger(窗口触发器)、Evictor (数据剔除器)、Lateness(时延设定)、Output Tag(输出标签)以及 Windows Funciton 等组成部分，其中 Windows Assigner 和 Windows Funciton 是所有窗口算子<code>必须指定</code>的属性， 其余的属性都是根据实际情况选择指定。</p> 
<pre><code class="prism language-java">stream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token comment">// 是Keyed类型数据集</span>
<span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token comment">//指定窗口分配器类型</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">//指定触发器类型(可选)</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token function">evictor</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">//指定evictor或者不指定(可选) </span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token function">allowedLateness</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">//指定是否延迟处理数据(可选) </span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token function">sideOutputLateData</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">//指定Output Lag(可选) </span>
<span class="token punctuation">.</span>reduce<span class="token operator">/</span>aggregate<span class="token operator">/</span>fold<span class="token operator">/</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//指定窗口计算函数</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">//根据Tag输出数据(可选)</span>
</code></pre> 
<ul><li>Windows Assigner: 指定窗口的类型，定义如何将数据流分配到一个或多个窗口。</li><li>Windows Trigger: 指定窗口触发的时机，定义窗口满足什么样的条件触发计算。</li><li>Evictor: 用于数据剔除。</li><li>allowedLateness: 标记是否处理迟到数据，当迟到数据到达窗口中是否触发计算。</li><li>Output Tag: 标记输出标签，然后在通过 getSideOutput 将窗口中的数据根据标签输出。</li><li>Windows Funciton: 定义窗口上数据处理的逻辑，例如对数据进行 sum 操作。</li></ul> 
<h4><a id="3__438"></a>3. 窗口聚合函数</h4> 
<p>如果定义了 Window Assigner 之后，下一步就可以定义窗口内数据的计算逻辑，这也就是 Window Function 的定义。Flink 中提供了四种类型的 Window Function，分别为 <code>ReduceFunction</code>、<code>AggregateFunction</code> 以及 <code>ProcessWindowFunction</code>,<code>（sum 和 max)</code>等。 前三种类型的 Window Fucntion 按照计算原理的不同可以分为两大类：</p> 
<ul><li>一类是<strong>增量</strong>聚合函数：对应有 <code>ReduceFunction</code>、<code>AggregateFunction</code>；</li><li>另一类是全量窗口函数，对应有 <code>ProcessWindowFunction</code>（还有 <code>WindowFunction</code>）。</li></ul> 
<p>增量聚合函数计算性能较高，占用存储空间少，主要因为<strong>基于中间状态的计算结果</strong>，窗口中只维护中间结果状态值，不需要缓存原始数据。而全量窗口函数使用的代价相对较高， 性能比较弱，主要因为此时算子需要对所有属于该窗口的接入数据进行缓存，然后等到窗口触发的时候，对所有的原始数据进行汇总计算。</p> 
<h6><a id="1_ReduceFunction_445"></a>1. ReduceFunction</h6> 
<p>Reduce要求输入跟输出类型要一样！这点切记。<br> <code>需求</code>：每隔5秒统计每个基站的日志数量</p> 
<pre><code class="prism language-java">object TestReduceFunctionByWindow <span class="token punctuation">{<!-- --></span>

  <span class="token comment">//每隔5秒统计每个基站的日志数量</span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>_

    <span class="token comment">//读取数据源</span>
    val stream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>StationLog<span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"hadoop101"</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        val arr <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
        <span class="token keyword">new</span> <span class="token class-name">StationLog</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">.</span>toLong<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//开窗</span>
    stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>log <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>sid<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//开窗</span>
      <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> t2<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>t1<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> t1<span class="token punctuation">.</span>_2 <span class="token operator">+</span> t2<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    streamEnv<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2_AggregateFunction_474"></a>2. AggregateFunction</h6> 
<p>和 ReduceFunction 相似，AggregateFunction 也是基于<strong>中间</strong>状态计算结果的增量计算 函数，但 AggregateFunction 在窗口计算上更加通用。AggregateFunction 接口相对 ReduceFunction 更加灵活，输入跟输出类型不要求完全一致，实现复杂度也相对较高。AggregateFunction 接口中定义了三个 需要复写的方法，其中 add()定义数据的添加逻辑，getResult 定义了根据 accumulator 计 算结果的逻辑，merge 方法定义合并 accumulator 的逻辑。初始化，<a href="https://blog.csdn.net/chilimei8516/article/details/100796930">分区内如何处理</a>，分区间如何处理，最终如何输出。</p> 
<p><code>需求</code>：每隔3秒计算最近5秒内，每个基站的日志数量</p> 
<pre><code class="prism language-java">object TestAggregatFunctionByWindow <span class="token punctuation">{<!-- --></span>

  <span class="token comment">//每隔3秒计算最近5秒内，每个基站的日志数量</span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>_

    <span class="token comment">//读取数据源</span>
    val stream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>StationLog<span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"hadoop101"</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        val arr <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
        <span class="token keyword">new</span> <span class="token class-name">StationLog</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">.</span>toLong<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//开窗</span>
    val value<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> Long<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>log <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>sid<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span>SlidingProcessingTimeWindows<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//开窗，滑动窗口</span>
      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyAggregateFunction</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyWindowFunction</span><span class="token punctuation">)</span>  <span class="token comment">// 到底是数字对应哪个基站</span>
      <span class="token comment">// aggregate(增量函数，全量函数)</span>
    value<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   
    streamEnv<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
    * 里面的add方法，是来一条数据执行一次，getResult在窗口结束的时候执行一次
    * in,累加器acc,out
    * https://blog.csdn.net/chilimei8516/article/details/100796930
    */</span>
  <span class="token keyword">class</span> <span class="token class-name">MyAggregateFunction</span> <span class="token keyword">extends</span> <span class="token class-name">AggregateFunction</span><span class="token punctuation">[</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> Int<span class="token punctuation">)</span><span class="token punctuation">,</span> Long<span class="token punctuation">,</span> Long<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
    override def <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">//初始化一个累加器 acc，开始的时候为0</span>
    <span class="token comment">// 分区内操作</span>
    override def <span class="token function">add</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token punctuation">(</span>String<span class="token punctuation">,</span> Int<span class="token punctuation">)</span><span class="token punctuation">,</span> accumulator<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token operator">=</span> accumulator <span class="token operator">+</span> value<span class="token punctuation">.</span>_2
    <span class="token comment">// 结果返回</span>
    override def <span class="token function">getResult</span><span class="token punctuation">(</span>accumulator<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token operator">=</span> accumulator
    <span class="token comment">// 分区间操作</span>
    override def <span class="token function">merge</span><span class="token punctuation">(</span>a<span class="token operator">:</span> Long<span class="token punctuation">,</span> b<span class="token operator">:</span> Long<span class="token punctuation">)</span><span class="token operator">:</span> Long <span class="token operator">=</span> a <span class="token operator">+</span> b
  <span class="token punctuation">}</span>
  
  <span class="token comment">// WindowFunction 输入数据来自于AggregateFunction ，</span>
  <span class="token comment">// 在窗口结束的时候先执行AggregateFunction对象的getResult，然后再执行apply</span>
  <span class="token comment">// in,out,key,window   </span>
  <span class="token keyword">class</span> <span class="token class-name">MyWindowFunction</span> <span class="token keyword">extends</span> <span class="token class-name">WindowFunction</span><span class="token punctuation">[</span>Long<span class="token punctuation">,</span> <span class="token punctuation">(</span>String<span class="token punctuation">,</span> Long<span class="token punctuation">)</span><span class="token punctuation">,</span> String<span class="token punctuation">,</span> TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
    override def <span class="token function">apply</span><span class="token punctuation">(</span>key<span class="token operator">:</span> String<span class="token punctuation">,</span> window<span class="token operator">:</span> TimeWindow<span class="token punctuation">,</span> input<span class="token operator">:</span> Iterable<span class="token punctuation">[</span>Long<span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> Long<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> input<span class="token punctuation">.</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//next得到第一个值，迭代器中只有一个值</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="3_ProcessWindowFunction_528"></a>3. ProcessWindowFunction</h6> 
<p>前面提到的<code>ReduceFunction</code>和 <code>AggregateFunction</code> 都是基于中间状态实现增量计算的 窗口函数，虽然已经满足绝大多数场景，但在某些情况下，统计更复杂的指标可能需要依赖于窗口中<strong>所有</strong>的数据元素，或需要操作窗口中的状态数据和窗口元数据，这时就需要使用到 <code>ProcessWindowsFunction</code>，<code>ProcessWindowsFunction</code>能够更加灵活地支持基于窗口全部数据元素的结果计算 ， 例如对整个窗口 数 据排序取TopN， 这样的需要就必须使用<code>ProcessWindowFunction</code>。</p> 
<p><code>需求</code>：每隔5秒统计每个基站的日志数量</p> 
<pre><code class="prism language-java">object TestProcessWindowFunctionByWindow <span class="token punctuation">{<!-- --></span>

  <span class="token comment">//每隔5秒统计每个基站的日志数量</span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>_
    streamEnv<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">//读取数据源</span>
    val stream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>StationLog<span class="token punctuation">]</span> <span class="token operator">=</span> streamEnv<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"hadoop101"</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        var arr <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
        <span class="token keyword">new</span> <span class="token class-name">StationLog</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>trim<span class="token punctuation">.</span>toLong<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//开窗</span>
    stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>log <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>sid<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span> <span class="token comment">// .timeWindow(Time.seconds(5))//开窗</span>
      <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span>TumblingProcessingTimeWindows<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessWindowFunction</span><span class="token punctuation">[</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> Int<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>String<span class="token punctuation">,</span> Long<span class="token punctuation">)</span><span class="token punctuation">,</span> String<span class="token punctuation">,</span> TimeWindow<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> 
      <span class="token comment">//一个窗口结束的时候调用一次(一个分组执行一次)    in,out,key,windows</span>
        override def <span class="token function">process</span><span class="token punctuation">(</span>key<span class="token operator">:</span> String<span class="token punctuation">,</span> context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> Int<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> Long<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------------"</span><span class="token punctuation">)</span>
          <span class="token comment">//注意：整个窗口的数据保存到Iterable，里面有很多行数据。Iterable的size就是日志的总条数</span>
          out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> elements<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    streamEnv<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>需求</code>：窗口函数读数据然后将数据写入到neo4j，感觉其实应该用 <a href="https://sowhat.blog.csdn.net/article/details/107323074" rel="nofollow">自定的Sink</a> 更合适一些。</p> 
<pre><code class="prism language-java">object DealDataFromKafka <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val environment<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    environment<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    val properties<span class="token operator">:</span> Properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"IP1:9092,IP2:9092"</span><span class="token punctuation">)</span>
    properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token string">"timer"</span><span class="token punctuation">)</span>
    <span class="token comment">// 从最新数据开始读</span>
    properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"auto.offset.reset"</span><span class="token punctuation">,</span> <span class="token string">"latest"</span><span class="token punctuation">)</span>
    <span class="token comment">//val dataStream: DataStream[String] = environment.addSource(new FlinkKafkaConsumer011[String]("sowhat", new SimpleStringSchema(), properties))</span>
    val dataStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>String<span class="token punctuation">]</span> <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"IP"</span><span class="token punctuation">,</span> <span class="token number">8889</span><span class="token punctuation">)</span>

    val winData<span class="token operator">:</span> AllWindowedStream<span class="token punctuation">[</span>String<span class="token punctuation">,</span> TimeWindow<span class="token punctuation">]</span> <span class="token operator">=</span> dataStream<span class="token punctuation">.</span><span class="token function">timeWindowAll</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    var pre<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span>
    var tmp<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span>
    val timeWithHashCode<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span>Int<span class="token punctuation">,</span> String<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> winData<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessAllWindowFunction</span><span class="token punctuation">[</span>String<span class="token punctuation">,</span> <span class="token punctuation">(</span>Int<span class="token punctuation">,</span> String<span class="token punctuation">)</span><span class="token punctuation">,</span> TimeWindow<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      override def <span class="token function">process</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> elements<span class="token operator">:</span> Iterable<span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span>Int<span class="token punctuation">,</span> String<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        val driver<span class="token operator">:</span> Driver <span class="token operator">=</span> GraphDatabase<span class="token punctuation">.</span><span class="token function">driver</span><span class="token punctuation">(</span><span class="token string">"bolt://IP:9314"</span><span class="token punctuation">,</span> AuthTokens<span class="token punctuation">.</span><span class="token function">basic</span><span class="token punctuation">(</span><span class="token string">"neo4j"</span><span class="token punctuation">,</span> <span class="token string">"neo4j0fcredithc"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        val session<span class="token operator">:</span> Session <span class="token operator">=</span> driver<span class="token punctuation">.</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        elements<span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
          tmp <span class="token operator">+=</span> <span class="token number">1</span>
          var now<span class="token operator">:</span> Int <span class="token operator">=</span> value<span class="token punctuation">.</span>hashCode
          now <span class="token operator">=</span> tmp
          session<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>s<span class="token string">"CREATE (a:Test {id:${now}, time:'${value}'})"</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>pre <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            session<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>s<span class="token string">"MATCH (begin:Test{id:${pre}}) ,(end:Test{id:${now}})   MERGE (begin)-[like:Time_Link]-&gt;(end)"</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> s<span class="token string">" MATCH (begin:Test{id:${pre}}) ,(end:Test{id:${now}})   MERGE (begin)-[like:Time_Link]-&gt;(end)"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          pre <span class="token operator">=</span> now
        <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
        <span class="token comment">//        session.close()</span>
        <span class="token comment">//        driver.close()</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    timeWithHashCode<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"HashCode With time:"</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"getData"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="End_607"></a>End</h2> 
<p>窗口的分类从不同的维度来说，</p> 
<ol><li>上游是否为KeyedStream，不同数据集调用不同方法。</li><li>根据上游数据是时间窗口(滚动窗口、滑动窗口、会话窗口)还是数据量窗口。</li><li>窗口若干API调用方法，窗口的聚合函数(reduceFunction、AggregateFunction、ProcessWindowFunction、WindowFunction)。</li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/717b2c47b2f2053d4aeb89b477132502/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vscode中配置eslint在react项目中使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/75581fa15bd2e68e8254021cf2bbc0e8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">从零开始NLP-task2</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>