<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【数据库与事务系列】多数据源切换 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【数据库与事务系列】多数据源切换" />
<meta property="og:description" content="分库分表 不光是管理多个数据源，是对sql的优化、改写、归并等一系列操作的解决方案。关注的是sql语句。以shardingSphere为例，虽然也支持跟sql无关的hint策略提供路由功能，但是在sql改写以及归并过程中，依旧对sql有限制。
多数据源切换 如果只是简单的切换多个数据源，而对sql的逻辑没有任何限制，就不要选择分库分表了。直接选用多数据源切换多方案更简单。spring-jdbc模块提供了AbstractRoutingDataSource抽象类，其内部可以包含多个DataSource，只需要实现其抽象方法，在运行时就可以动态访问指定的数据库。但是需要自己实现一些aop的切换能力，这个mybaitis-plus都帮我们做好了。
业界主要有两种实现方案：
AOP &#43; ThreadLocal ，如：Mybatis-plus的多数据源(dynamic-datasource)；语义解析，如：客户端侧：ShardingSphere-Jdbc，服务端侧：ShardingSphere-Proxy，阿里云、腾讯云proxy。 一、动态数据源切换 （AbstractRoutingDataSource实现） 我们来查看AbstractRoutingDataSource源码，来更好的理解多数据源配置。
首先查看该类的属性，根据名称我们能看出他们的作用。
private Map&lt;Object, Object&gt; targetDataSources; private Object defaultTargetDataSource; private boolean lenientFallback = true; private DataSourceLookup dataSourceLookup = new JndiDataSourceLookup(); private Map&lt;Object, DataSource&gt; resolvedDataSources; private DataSource resolvedDefaultDataSource; targetDataSources是目标数据源集合defaultTargetDataSource是默认数据源resolvedDataSources是解析后的数据源集合resolvedDefaultDataSource是解析后的默认数据源 对数据源赋值的代码如下：
public void setTargetDataSources(Map&lt;Object, Object&gt; targetDataSources) { this.targetDataSources = targetDataSources; } public void setDefaultTargetDataSource(Object defaultTargetDataSource) { this.defaultTargetDataSource = defaultTargetDataSource; } 因为方法是set开头，我们便能把这两个方法配置在spring中，继续向下看。
public void afterPropertiesSet() { if (this.targetDataSources == null) { throw new IllegalArgumentException(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/7482c1f128e05de689b80d2f7bd68de4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-03T00:19:31+08:00" />
<meta property="article:modified_time" content="2022-12-03T00:19:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【数据库与事务系列】多数据源切换</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>分库分表</h2> 
<p>不光是管理多个数据源，是对sql的优化、改写、归并等一系列操作的解决方案。关注的是sql语句。以shardingSphere为例，虽然也支持跟sql无关的hint策略提供路由功能，但是在sql改写以及归并过程中，依旧对sql有限制。</p> 
<h2><a id="_2"></a>多数据源切换</h2> 
<p>如果只是简单的切换多个数据源，而对sql的逻辑没有任何限制，就不要选择分库分表了。直接选用多数据源切换多方案更简单。spring-jdbc模块提供了AbstractRoutingDataSource抽象类，其内部可以包含多个DataSource，只需要实现其抽象方法，在运行时就可以动态访问指定的数据库。但是需要自己实现一些aop的切换能力，这个mybaitis-plus都帮我们做好了。<br> <img src="https://images2.imgbox.com/ad/21/q3xqFXIe_o.png" alt="请添加图片描述"><br> 业界主要有两种实现方案：</p> 
<ul><li>AOP + ThreadLocal ，如：Mybatis-plus的多数据源(dynamic-datasource)；</li><li>语义解析，如：客户端侧：ShardingSphere-Jdbc，服务端侧：ShardingSphere-Proxy，阿里云、腾讯云proxy。</li></ul> 
<h3><a id="_8"></a>一、动态数据源切换</h3> 
<h4><a id="AbstractRoutingDataSource_9"></a>（AbstractRoutingDataSource实现）</h4> 
<p>我们来查看AbstractRoutingDataSource源码，来更好的理解多数据源配置。<br> 首先查看该类的属性，根据名称我们能看出他们的作用。</p> 
<pre><code class="prism language-c">private Map<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> targetDataSources<span class="token punctuation">;</span>
private Object defaultTargetDataSource<span class="token punctuation">;</span>
private boolean lenientFallback <span class="token operator">=</span> true<span class="token punctuation">;</span>
private DataSourceLookup dataSourceLookup <span class="token operator">=</span> new <span class="token function">JndiDataSourceLookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
private Map<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> DataSource<span class="token operator">&gt;</span> resolvedDataSources<span class="token punctuation">;</span>
private DataSource resolvedDefaultDataSource<span class="token punctuation">;</span>
</code></pre> 
<ul><li>targetDataSources是目标数据源集合</li><li>defaultTargetDataSource是默认数据源</li><li>resolvedDataSources是解析后的数据源集合</li><li>resolvedDefaultDataSource是解析后的默认数据源</li></ul> 
<p>对数据源赋值的代码如下：</p> 
<pre><code class="prism language-c">public <span class="token keyword">void</span> <span class="token function">setTargetDataSources</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> targetDataSources<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    this<span class="token punctuation">.</span>targetDataSources <span class="token operator">=</span> targetDataSources<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

public <span class="token keyword">void</span> <span class="token function">setDefaultTargetDataSource</span><span class="token punctuation">(</span>Object defaultTargetDataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    this<span class="token punctuation">.</span>defaultTargetDataSource <span class="token operator">=</span> defaultTargetDataSource<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>因为方法是set开头，我们便能把这两个方法配置在spring中，继续向下看。</p> 
<pre><code class="prism language-c">public <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>this<span class="token punctuation">.</span>targetDataSources <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        throw new <span class="token function">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Property 'targetDataSources' is required"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        this<span class="token punctuation">.</span>resolvedDataSources <span class="token operator">=</span> new <span class="token function">HashMap</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span>targetDataSources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Iterator var1 <span class="token operator">=</span> this<span class="token punctuation">.</span>targetDataSources<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span>var1<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Entry<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> entry <span class="token operator">=</span> <span class="token punctuation">(</span>Entry<span class="token punctuation">)</span>var1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Object lookupKey <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">resolveSpecifiedLookupKey</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            DataSource dataSource <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">resolveSpecifiedDataSource</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            this<span class="token punctuation">.</span>resolvedDataSources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lookupKey<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>this<span class="token punctuation">.</span>defaultTargetDataSource <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            this<span class="token punctuation">.</span>resolvedDefaultDataSource <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">resolveSpecifiedDataSource</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span>defaultTargetDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个afterPropertiesSet方法是遍历我们的targetDataSources数据源集合，并添加resolvedDataSources的map数据，map的key和value是根据resolveSpecifiedLookupKey方法和resolveSpecifiedDataSource方法得到。接着找到resolveSpecifiedLookupKey和resolveSpecifiedDataSource。</p> 
<pre><code class="prism language-c">protected Object <span class="token function">resolveSpecifiedLookupKey</span><span class="token punctuation">(</span>Object lookupKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> lookupKey<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

protected DataSource <span class="token function">resolveSpecifiedDataSource</span><span class="token punctuation">(</span>Object dataSource<span class="token punctuation">)</span> throws IllegalArgumentException <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataSource instanceof DataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>DataSource<span class="token punctuation">)</span>dataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dataSource instanceof String<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> this<span class="token punctuation">.</span>dataSourceLookup<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        throw new <span class="token function">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Illegal data source value - only [javax.sql.DataSource] and String supported: "</span> <span class="token operator">+</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>resolveSpecifiedLookupKey方法返回的实际就是targetDataSources的key，而resolveSpecifiedDataSource返回的是targetDataSources的value转成的DataSource。afterPropertiesSet方法的作用实际就是将原targetDataSources转成resolvedDataSources。</p> 
<p>继续向下看，我们能看到数据库的连接方法。</p> 
<pre><code class="prism language-c">public Connection <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> throws SQLException <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> this<span class="token punctuation">.</span><span class="token function">determineTargetDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

public Connection <span class="token function">getConnection</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span> String password<span class="token punctuation">)</span> throws SQLException <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> this<span class="token punctuation">.</span><span class="token function">determineTargetDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们接着去看determineTargeDataSource方法，估计这个方法是返回指定数据源的。</p> 
<pre><code class="prism language-c">protected DataSource <span class="token function">determineTargetDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span>resolvedDataSources<span class="token punctuation">,</span> <span class="token string">"DataSource router not initialized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Object lookupKey <span class="token operator">=</span> this<span class="token punctuation">.</span><span class="token function">determineCurrentLookupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    DataSource dataSource <span class="token operator">=</span> <span class="token punctuation">(</span>DataSource<span class="token punctuation">)</span>this<span class="token punctuation">.</span>resolvedDataSources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>lookupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataSource <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>this<span class="token punctuation">.</span>lenientFallback <span class="token operator">||</span> lookupKey <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        dataSource <span class="token operator">=</span> this<span class="token punctuation">.</span>resolvedDefaultDataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataSource <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        throw new <span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Cannot determine target DataSource for lookup key ["</span> <span class="token operator">+</span> lookupKey <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>果然，这个方法是返回数据源的，我们来仔细读这个方法，从第3行开始”Object lookupKey = this.determineCurrentLookupKey();”，这个determineCurrentLookupKey返回了一个key，第四句是根据这个key去resolvedDataSources中拿到对应DataSource，接下来的代码是DataSource不存在便返回默认的数据源。determineCurrentLookupKey方法就是返回key的逻辑处理部分，联系spring中的配置，它返回的就是”cms”、”epg”中的一个。</p> 
<h5><a id="_111"></a>实战</h5> 
<p>新建一个springboot项目，pom.xml文件中引入如下依赖</p> 
<pre><code class="prism language-c"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>jdbc<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>web<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>mybatis<span class="token operator">-</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.2</span><span class="token number">.2</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>mysql<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>scope<span class="token operator">&gt;</span>runtime<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>alibaba<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>druid<span class="token operator">-</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1.2</span><span class="token number">.9</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>aop<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

</code></pre> 
<h5><a id="2_applicationyml_144"></a>2. application.yml文件</h5> 
<pre><code class="prism language-c">server<span class="token operator">:</span>
  port<span class="token operator">:</span> <span class="token number">8090</span>
spring<span class="token operator">:</span>
  application<span class="token operator">:</span>
    name<span class="token operator">:</span> springboot<span class="token operator">-</span>dynamic<span class="token operator">-</span>aop
  datasource<span class="token operator">:</span>
    type<span class="token operator">:</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>DruidDataSource
    master<span class="token operator">:</span>
      jdbc<span class="token operator">-</span>url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token comment">//localhost:3306/dynamic-master?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span>
      username<span class="token operator">:</span> root
      password<span class="token operator">:</span> <span class="token number">123456</span>
      driver<span class="token operator">-</span>class<span class="token operator">-</span>name<span class="token operator">:</span> com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>Driver
    slave<span class="token operator">:</span>
      jdbc<span class="token operator">-</span>url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token comment">//localhost:3306/dynamic-slave?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span>
      username<span class="token operator">:</span> root
      password<span class="token operator">:</span> <span class="token number">123456</span>
      driver<span class="token operator">-</span>class<span class="token operator">-</span>name<span class="token operator">:</span> com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>Driver
mybatis<span class="token operator">:</span>
  mapper<span class="token operator">-</span>locations<span class="token operator">:</span> classpath<span class="token operator">:</span>mapper<span class="token comment">/*.xml
  configuration:
    use-actual-param-name: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
</span></code></pre> 
<h4><a id="3__169"></a>3. 数据源配置类</h4> 
<pre><code class="prism language-c">@Configuration
public class DataSourceConfig <span class="token punctuation">{<!-- --></span>

    @Bean
    @<span class="token function">ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource.master"</span><span class="token punctuation">)</span>
    public DataSource <span class="token function">masterDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> DataSourceBuilder<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Bean
    @<span class="token function">ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource.slave"</span><span class="token punctuation">)</span>
    public DataSource <span class="token function">slaveDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> DataSourceBuilder<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Bean
    public DataSourceTransactionManager <span class="token function">masterDataSourceTransactionManager</span><span class="token punctuation">(</span>DynamicDataSource dynamicDataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        DataSourceTransactionManager dataSourceTransactionManager <span class="token operator">=</span> new <span class="token function">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSourceTransactionManager<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dynamicDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dataSourceTransactionManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Bean
    public DataSourceTransactionManager <span class="token function">slaveDataSourceTransactionManager</span><span class="token punctuation">(</span>DynamicDataSource dynamicDataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        DataSourceTransactionManager dataSourceTransactionManager <span class="token operator">=</span> new <span class="token function">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSourceTransactionManager<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dynamicDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dataSourceTransactionManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="4__202"></a>4. 动态数据源类</h4> 
<p>新建一个类继承AbstractRoutingDataSource，实现其抽象类</p> 
<pre><code class="prism language-c">@Primary
@Component
public class DynamicDataSource extends AbstractRoutingDataSource <span class="token punctuation">{<!-- --></span>

    public <span class="token keyword">static</span> final ThreadLocal<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> name <span class="token operator">=</span> new ThreadLocal<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    @Autowired
    DataSource masterDataSource<span class="token punctuation">;</span>
    @Autowired
    DataSource slaveDataSource<span class="token punctuation">;</span>

    @Override
    protected Object <span class="token function">determineCurrentLookupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Map<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> targetDataSources <span class="token operator">=</span> new HashMap<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        targetDataSources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"master"</span><span class="token punctuation">,</span> masterDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        targetDataSources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"slave"</span><span class="token punctuation">,</span> slaveDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置目标数据源</span>
        super<span class="token punctuation">.</span><span class="token function">setTargetDataSources</span><span class="token punctuation">(</span>targetDataSources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置默认数据源</span>
        super<span class="token punctuation">.</span><span class="token function">setDefaultTargetDataSource</span><span class="token punctuation">(</span>masterDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        super<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="5__236"></a>5. 实现多数据源切换</h4> 
<p>一般情况下，读写分离的数据源使用MyBatis插件实现动态切换数据源，不同业务来源的数据源使用AOP结合自定义注解实现动态切换数据源，或者定义多个mybatis sqlsessionFactory来实现</p> 
<h5><a id="51_MyBatis_239"></a>5.1. MyBatis插件实现动态切换</h5> 
<p>新建一个插件类，实现Interceptor接口</p> 
<pre><code class="prism language-c">@<span class="token function">Intercepts</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        @<span class="token function">Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> Executor<span class="token punctuation">.</span>class<span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"update"</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>MappedStatement<span class="token punctuation">.</span>class<span class="token punctuation">,</span> Object<span class="token punctuation">.</span>class<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        @<span class="token function">Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> Executor<span class="token punctuation">.</span>class<span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>MappedStatement<span class="token punctuation">.</span>class<span class="token punctuation">,</span> Object<span class="token punctuation">.</span>class<span class="token punctuation">,</span> RowBounds<span class="token punctuation">.</span>class<span class="token punctuation">,</span> ResultHandler<span class="token punctuation">.</span>class<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
public class DynamicDataSourcePlugin implements Interceptor <span class="token punctuation">{<!-- --></span>
    @Override
    public Object <span class="token function">intercept</span><span class="token punctuation">(</span>Invocation invocation<span class="token punctuation">)</span> throws Throwable <span class="token punctuation">{<!-- --></span>
        Object<span class="token punctuation">[</span><span class="token punctuation">]</span> objects <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MappedStatement mappedStatement <span class="token operator">=</span> <span class="token punctuation">(</span>MappedStatement<span class="token punctuation">)</span> objects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedStatement<span class="token punctuation">.</span><span class="token function">getSqlCommandType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>SqlCommandType<span class="token punctuation">.</span>SELECT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            DynamicDataSource<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"slave"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            DynamicDataSource<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"master"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public Object <span class="token function">plugin</span><span class="token punctuation">(</span>Object target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target instanceof Executor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> Plugin<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> target<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span>Properties properties<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>再将DynamicDataSourcePlugin类加入DataSourceConfig配置类</p> 
<pre><code class="prism language-c">@Bean
public Interceptor <span class="token function">interceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> new <span class="token function">DynamicDataSourcePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="52_AOP_285"></a>5.2. AOP结合自定义注解实现</h5> 
<p>新建一个自定义注解DS</p> 
<pre><code class="prism language-c">@<span class="token function">Target</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>ElementType<span class="token punctuation">.</span>TYPE<span class="token punctuation">,</span> ElementType<span class="token punctuation">.</span>METHOD<span class="token punctuation">}</span><span class="token punctuation">)</span>
@<span class="token function">Retention</span><span class="token punctuation">(</span>RetentionPolicy<span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
@Documented
public @interface DS <span class="token punctuation">{<!-- --></span>

    String <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>新建切面类</p> 
<pre><code class="prism language-c">@Aspect
@Component
public class DynamicDataSourceAspect implements Ordered <span class="token punctuation">{<!-- --></span>

    @<span class="token function">Before</span><span class="token punctuation">(</span><span class="token string">"@within(ds)"</span><span class="token punctuation">)</span>
    public <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span>JoinPoint joinPoint<span class="token punctuation">,</span> DS ds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        DynamicDataSource<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ds<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="53_springmybatis__316"></a>5.3 spring即成多个mybatis 工厂实现</h4> 
<p><img src="https://images2.imgbox.com/fa/dd/vXcVb9kt_o.png" alt="请添加图片描述"><br> SpringBoot配置文件 配置多个数据库 分别为 his/pt/lis</p> 
<pre><code class="prism language-c">
spring<span class="token operator">:</span>
  datasource<span class="token operator">:</span>
    his<span class="token operator">:</span>
      driver<span class="token operator">-</span>class<span class="token operator">-</span>name<span class="token operator">:</span> com<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>sqlserver<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>SQLServerDriver
      jdbc<span class="token operator">-</span>url<span class="token operator">:</span> jdbc<span class="token operator">:</span>sqlserver<span class="token operator">:</span><span class="token comment">//192.168.200.200\HIS;DatabaseName=his_fy</span>
      username<span class="token operator">:</span> sa
      password<span class="token operator">:</span> <span class="token number">123456</span>
      #初始化连接池的连接数量 大小 最小 最大
      initial<span class="token operator">-</span>size<span class="token operator">:</span> <span class="token number">5</span>
      min<span class="token operator">-</span>idle<span class="token operator">:</span> <span class="token number">5</span>
      max<span class="token operator">-</span>active<span class="token operator">:</span> <span class="token number">20</span>
      #配置获取连接等待超时的时间
      max<span class="token operator">-</span>wait<span class="token operator">:</span> <span class="token number">60000</span>
      #配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒
      time<span class="token operator">-</span>between<span class="token operator">-</span>eviction<span class="token operator">-</span>runs<span class="token operator">-</span>millis<span class="token operator">:</span> <span class="token number">60000</span>
      # 配置一个连接在池中最小生存的时间，单位是毫秒
      min<span class="token operator">-</span>evictable<span class="token operator">-</span>idle<span class="token operator">-</span>time<span class="token operator">-</span>millis<span class="token operator">:</span> <span class="token number">30000</span>
      # 配置一个连接在池中最大生存的时间，单位是毫秒
      max<span class="token operator">-</span>evictable<span class="token operator">-</span>idle<span class="token operator">-</span>time<span class="token operator">-</span>millis<span class="token operator">:</span> <span class="token number">300000</span>

    pt<span class="token operator">:</span>
      driver<span class="token operator">-</span>class<span class="token operator">-</span>name<span class="token operator">:</span> com<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>sqlserver<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>SQLServerDriver
      jdbc<span class="token operator">-</span>url<span class="token operator">:</span> jdbc<span class="token operator">:</span>sqlserver<span class="token operator">:</span><span class="token comment">//192.168.200.200\HIS;DatabaseName=his_pt_data</span>
      username<span class="token operator">:</span> sa
      password<span class="token operator">:</span> <span class="token number">123456</span>
      #初始化连接池的连接数量 大小 最小 最大
      initial<span class="token operator">-</span>size<span class="token operator">:</span> <span class="token number">5</span>
      min<span class="token operator">-</span>idle<span class="token operator">:</span> <span class="token number">5</span>
      max<span class="token operator">-</span>active<span class="token operator">:</span> <span class="token number">20</span>
      #配置获取连接等待超时的时间
      max<span class="token operator">-</span>wait<span class="token operator">:</span> <span class="token number">60000</span>
      #配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒
      time<span class="token operator">-</span>between<span class="token operator">-</span>eviction<span class="token operator">-</span>runs<span class="token operator">-</span>millis<span class="token operator">:</span> <span class="token number">60000</span>
      # 配置一个连接在池中最小生存的时间，单位是毫秒
      min<span class="token operator">-</span>evictable<span class="token operator">-</span>idle<span class="token operator">-</span>time<span class="token operator">-</span>millis<span class="token operator">:</span> <span class="token number">30000</span>
      # 配置一个连接在池中最大生存的时间，单位是毫秒
      max<span class="token operator">-</span>evictable<span class="token operator">-</span>idle<span class="token operator">-</span>time<span class="token operator">-</span>millis<span class="token operator">:</span> <span class="token number">300000</span>

    lis<span class="token operator">:</span>
      driver<span class="token operator">-</span>class<span class="token operator">-</span>name<span class="token operator">:</span> com<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>sqlserver<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>SQLServerDriver
      jdbc<span class="token operator">-</span>url<span class="token operator">:</span> jdbc<span class="token operator">:</span>sqlserver<span class="token operator">:</span><span class="token comment">//192.168.200.200\HIS;DatabaseName=LIS</span>
      username<span class="token operator">:</span> sa
      password<span class="token operator">:</span> <span class="token number">123456</span>
      #初始化连接池的连接数量 大小 最小 最大
      initial<span class="token operator">-</span>size<span class="token operator">:</span> <span class="token number">5</span>
      min<span class="token operator">-</span>idle<span class="token operator">:</span> <span class="token number">5</span>
      max<span class="token operator">-</span>active<span class="token operator">:</span> <span class="token number">20</span>
      #配置获取连接等待超时的时间
      max<span class="token operator">-</span>wait<span class="token operator">:</span> <span class="token number">60000</span>
      #配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒
      time<span class="token operator">-</span>between<span class="token operator">-</span>eviction<span class="token operator">-</span>runs<span class="token operator">-</span>millis<span class="token operator">:</span> <span class="token number">60000</span>
      # 配置一个连接在池中最小生存的时间，单位是毫秒
      min<span class="token operator">-</span>evictable<span class="token operator">-</span>idle<span class="token operator">-</span>time<span class="token operator">-</span>millis<span class="token operator">:</span> <span class="token number">30000</span>
      # 配置一个连接在池中最大生存的时间，单位是毫秒
      max<span class="token operator">-</span>evictable<span class="token operator">-</span>idle<span class="token operator">-</span>time<span class="token operator">-</span>millis<span class="token operator">:</span> <span class="token number">300000</span>

</code></pre> 
<h5><a id="1__380"></a>1. 引入核心依赖</h5> 
<p>创建his对应的配置文件</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * 多数据源配置类 此类配置读取his_fy数据库
 * @author zhaogx
 * @date 2022/5/18 14:28
 */</span>
@Configuration
@<span class="token function">MapperScan</span><span class="token punctuation">(</span>
        basePackages <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"com.thwy.mapper.his"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        sqlSessionFactoryRef <span class="token operator">=</span> <span class="token string">"hisSqlSessionFactory"</span>
<span class="token punctuation">)</span>
public class HisDataSourceConfig <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * @ConfigurationProperties(prefix = "spring.datasource.his") 读取配置文件中的数据源信息
     * @return 返回一个数据源 名字为 hisDataSource
     */</span>
    @<span class="token function">Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"hisDataSource"</span><span class="token punctuation">)</span>
    @<span class="token function">ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource.his"</span><span class="token punctuation">)</span>
    public DataSource <span class="token function">hisDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> DataSourceBuilder<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置SqlSessionFactory
     * @Qualifier("hisDataSource") 类型相同时指定注入哪一个名称的bean
     * @param hisDataSource hisDataSource方法中创建的指定数据源
     * @return
     * @throws Exception
     */</span>
    @<span class="token function">Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"hisSqlSessionFactory"</span><span class="token punctuation">)</span>
    public SqlSessionFactory <span class="token function">hisSqlSessionFactory</span><span class="token punctuation">(</span>@<span class="token function">Qualifier</span><span class="token punctuation">(</span><span class="token string">"hisDataSource"</span><span class="token punctuation">)</span> DataSource hisDataSource<span class="token punctuation">)</span> throws Exception<span class="token punctuation">{<!-- --></span>
        SqlSessionFactoryBean sqlSessionFactoryBean <span class="token operator">=</span> new <span class="token function">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置数据源</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>hisDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置mybtais配置 驼峰命名配置</span>
        org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>Configuration config <span class="token operator">=</span> new org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setMapUnderscoreToCamelCase</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置mapper.xml所在目录</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setMapperLocations</span><span class="token punctuation">(</span>
                new <span class="token function">PathMatchingResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token string">"classpath:mapper/his/*.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置SqlSessionTemplate 可省略此步骤
     * @param hisSqlSessionFactory
     * @return
     */</span>
    public SqlSessionTemplate <span class="token function">hisSqlSessionTemplate</span><span class="token punctuation">(</span>@<span class="token function">Qualifier</span><span class="token punctuation">(</span><span class="token string">"hisSqlSessionFactory"</span><span class="token punctuation">)</span> SqlSessionFactory hisSqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> new <span class="token function">SqlSessionTemplate</span><span class="token punctuation">(</span>hisSqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>创建pt对应的配置文件</p> 
<pre><code class="prism language-c">@Configuration
@<span class="token function">MapperScan</span><span class="token punctuation">(</span>
        basePackages <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"com.thwy.mapper.pt"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        sqlSessionFactoryRef <span class="token operator">=</span> <span class="token string">"ptSqlSessionFactory"</span>
<span class="token punctuation">)</span>
public class PTDataSourceConfig <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * @ConfigurationProperties(prefix = "spring.datasource.pt") 读取配置文件中的数据源信息
     * @return 返回一个数据源 名字为 ptDataSource
     */</span>
    @<span class="token function">Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"ptDataSource"</span><span class="token punctuation">)</span>
    @<span class="token function">ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource.pt"</span><span class="token punctuation">)</span>
    public DataSource <span class="token function">ptDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> DataSourceBuilder<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置SqlSessionFactory
     * @Qualifier("ptDataSource") 类型相同时指定注入哪一个名称的bean
     * @param ptDataSource ptDataSource方法中创建的指定数据源
     * @return
     * @throws Exception
     */</span>
    @<span class="token function">Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"ptSqlSessionFactory"</span><span class="token punctuation">)</span>
    public SqlSessionFactory <span class="token function">ptSqlSessionFactory</span><span class="token punctuation">(</span>@<span class="token function">Qualifier</span><span class="token punctuation">(</span><span class="token string">"ptDataSource"</span><span class="token punctuation">)</span> DataSource ptDataSource<span class="token punctuation">)</span> throws Exception<span class="token punctuation">{<!-- --></span>
        SqlSessionFactoryBean sqlSessionFactoryBean <span class="token operator">=</span> new <span class="token function">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置数据源</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>ptDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置mybtais配置 驼峰命名配置</span>
        org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>Configuration config <span class="token operator">=</span> new org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setMapUnderscoreToCamelCase</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置mapper.xml所在目录</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setMapperLocations</span><span class="token punctuation">(</span>
                new <span class="token function">PathMatchingResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token string">"classpath:mapper/pt/*.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 配置SqlSessionTemplate 可省略此步骤
     * @param ptSqlSessionFactory
     * @return
     */</span>
    public SqlSessionTemplate <span class="token function">ptSqlSessionTemplate</span><span class="token punctuation">(</span>@<span class="token function">Qualifier</span><span class="token punctuation">(</span><span class="token string">"ptSqlSessionFactory"</span><span class="token punctuation">)</span> SqlSessionFactory ptSqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> new <span class="token function">SqlSessionTemplate</span><span class="token punctuation">(</span>ptSqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建lis对应的配置文件</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * 多数据源配置类 此类配置读取LIS数据库
 * @author zhaogx
 * @date 2022/5/18 14:28
 */</span>
@Configuration
@<span class="token function">MapperScan</span><span class="token punctuation">(</span>
        basePackages <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"com.thwy.mapper.lis"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        sqlSessionFactoryRef <span class="token operator">=</span> <span class="token string">"lisSqlSessionFactory"</span>
<span class="token punctuation">)</span>
public class LisDataSourceConfig <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * @ConfigurationProperties(prefix = "spring.datasource.lis") 读取配置文件中的数据源信息
     * @return 返回一个数据源 名字为 lisDataSource
     */</span>
    @<span class="token function">Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"lisDataSource"</span><span class="token punctuation">)</span>
    @<span class="token function">ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource.lis"</span><span class="token punctuation">)</span>
    public DataSource <span class="token function">lisDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> DataSourceBuilder<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置SqlSessionFactory
     * @Qualifier("lisDataSource") 类型相同时指定注入哪一个名称的bean
     * @param lisDataSource lisDataSource方法中创建的指定数据源
     * @return
     * @throws Exception
     */</span>
    @<span class="token function">Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"lisSqlSessionFactory"</span><span class="token punctuation">)</span>
    public SqlSessionFactory <span class="token function">lisSqlSessionFactory</span><span class="token punctuation">(</span>@<span class="token function">Qualifier</span><span class="token punctuation">(</span><span class="token string">"lisDataSource"</span><span class="token punctuation">)</span> DataSource lisDataSource<span class="token punctuation">)</span> throws Exception<span class="token punctuation">{<!-- --></span>
        SqlSessionFactoryBean sqlSessionFactoryBean <span class="token operator">=</span> new <span class="token function">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置数据源</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>lisDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置mybtais配置 驼峰命名配置</span>
        org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span>Configuration config <span class="token operator">=</span> new org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setMapUnderscoreToCamelCase</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置mapper.xml所在目录</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setMapperLocations</span><span class="token punctuation">(</span>
                new <span class="token function">PathMatchingResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token string">"classpath:mapper/lis/*.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置SqlSessionTemplate 可省略此步骤
     * @param lisSqlSessionFactory
     * @return
     */</span>
    public SqlSessionTemplate <span class="token function">lisSqlSessionTemplate</span><span class="token punctuation">(</span>@<span class="token function">Qualifier</span><span class="token punctuation">(</span><span class="token string">"lisSqlSessionFactory"</span><span class="token punctuation">)</span> SqlSessionFactory lisSqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> new <span class="token function">SqlSessionTemplate</span><span class="token punctuation">(</span>lisSqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_547"></a>实现</h5> 
<p>在配置文件中我们配置了 mapper的包扫描与xml文件的存放路径<br> 此时当我们执行指定包下的mapper中的方法时，就会走与之对应的数据库<br> <img src="https://images2.imgbox.com/2f/95/qmngQO7Z_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/01/e3/YpMMk4BI_o.png" alt="在这里插入图片描述"><br> 自己整合实现多数据源多有麻烦，baomidou提供的dynamic-datasource-spring-boot-starter已实现了上述功能，只需要引入该依赖即可，可以参阅SpringBoot整合dynamic-datasource实现动态切换多数据源</p> 
<h4><a id="SpringBootdynamicdatasource_554"></a>SpringBoot整合dynamic-datasource实现动态切换多数据源</h4> 
<pre><code class="prism language-c"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>web<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>baomidou<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>mybatis<span class="token operator">-</span>plus<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">3.5</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>mysql<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>mysql<span class="token operator">-</span>connector<span class="token operator">-</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>scope<span class="token operator">&gt;</span>runtime<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>baomidou<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>dynamic<span class="token operator">-</span>datasource<span class="token operator">-</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">3.5</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>alibaba<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>druid<span class="token operator">-</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1.2</span><span class="token number">.9</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

</code></pre> 
<h4><a id="2_applicationyml_582"></a>2. application.yml配置</h4> 
<pre><code class="prism language-c">server<span class="token operator">:</span>
  port<span class="token operator">:</span> <span class="token number">8226</span>
spring<span class="token operator">:</span>
  application<span class="token operator">:</span>
    name<span class="token operator">:</span> springboot<span class="token operator">-</span>dynamic<span class="token operator">-</span>mybatis<span class="token operator">-</span>plus
  datasource<span class="token operator">:</span>
    type<span class="token operator">:</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>DruidDataSource
    dynamic<span class="token operator">:</span>
      primary<span class="token operator">:</span> master
      strict<span class="token operator">:</span> true #严格匹配数据源
      datasource<span class="token operator">:</span>
        master<span class="token operator">:</span>
          url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token comment">//localhost:3306/dynamic-master?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span>
          username<span class="token operator">:</span> root
          password<span class="token operator">:</span> LIU81<span class="token operator">&amp;</span>yj
          driver<span class="token operator">-</span>class<span class="token operator">-</span>name<span class="token operator">:</span> com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>Driver
        slave<span class="token operator">:</span>
          url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token comment">//localhost:3306/dynamic-slave?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span>
          username<span class="token operator">:</span> root
          password<span class="token operator">:</span> LIU81<span class="token operator">&amp;</span>yj
          driver<span class="token operator">-</span>class<span class="token operator">-</span>name<span class="token operator">:</span> com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>Driver
      druid<span class="token operator">:</span>
        initial<span class="token operator">-</span>size<span class="token operator">:</span> <span class="token number">5</span> #初始连接数
        min<span class="token operator">-</span>idle<span class="token operator">:</span> <span class="token number">10</span> #最小连接池
        max<span class="token operator">-</span>active<span class="token operator">:</span> <span class="token number">20</span> #最大连接池
        max<span class="token operator">-</span>wait<span class="token operator">:</span> <span class="token number">60000</span> #连接等待超时时间
        time<span class="token operator">-</span>between<span class="token operator">-</span>eviction<span class="token operator">-</span>runs<span class="token operator">-</span>millis<span class="token operator">:</span> <span class="token number">60000</span> #检测间隔时间，毫秒
        min<span class="token operator">-</span>evictable<span class="token operator">-</span>idle<span class="token operator">-</span>time<span class="token operator">-</span>millis<span class="token operator">:</span> <span class="token number">300000</span> #连接池最小生存时间，毫秒
        max<span class="token operator">-</span>evictable<span class="token operator">-</span>idle<span class="token operator">-</span>time<span class="token operator">-</span>millis<span class="token operator">:</span> <span class="token number">900000</span> #连接池最大生存时间，毫秒
        validation<span class="token operator">-</span>query<span class="token operator">:</span> SELECT <span class="token number">1</span> FROM DUAL #连接检测

mybatis<span class="token operator">-</span>plus<span class="token operator">:</span>
  mapper<span class="token operator">-</span>locations<span class="token operator">:</span> classpath<span class="token operator">*</span><span class="token operator">:</span><span class="token operator">/</span>mapper<span class="token comment">/**/</span><span class="token operator">*</span><span class="token punctuation">.</span>xml
  configuration<span class="token operator">:</span>
    log<span class="token operator">-</span>impl<span class="token operator">:</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>logging<span class="token punctuation">.</span><span class="token constant">stdout</span><span class="token punctuation">.</span>StdOutImpl

</code></pre> 
<h5><a id="3__622"></a>3. 引入注解动态切换数据源</h5> 
<pre><code class="prism language-c">@Service
@<span class="token function">DS</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"master"</span><span class="token punctuation">)</span>
public class CustomerServiceImpl extends ServiceImpl<span class="token operator">&lt;</span>CustomerMapper<span class="token punctuation">,</span> Customer<span class="token operator">&gt;</span> implements CustomerService <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

</code></pre> 
<p>若需要使用到事务，只需要在最外层加注解@DSTransactional即可<br> 当然了mybatisPlus在很多位置给我们留了拓展，比如如何加载数据源、对接其它连接池、自定义负责均衡策略、自定义路由查找：<br> <img src="https://images2.imgbox.com/4b/1a/gJmoxoBE_o.png" alt="请添加图片描述"><br> 其主要类图如下：感兴趣的可以去读读源码<br> <img src="https://images2.imgbox.com/15/8a/TnEDl7CN_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_637"></a>多数据源带来的问题</h4> 
<p>引入多数据源后，解决了多数据源访问的问题，同时也带来另外2个问题：</p> 
<ul><li>事务问题：对多数据源写操作时，如何保证数据的一致性，完整性？</li><li>多层嵌套切换问题(AOP方案)：如：serviceA—&gt;ServiceB—&gt;ServiceC，如何保证每层都使用自己的数据源？<br> 特殊情况下还是可以，比如这样的<br> <img src="https://images2.imgbox.com/5d/75/09aqinOu_o.png" alt="请添加图片描述"></li></ul> 
<h5><a id="spring_644"></a>二、一个方法开启两个事务，实现spring编程或者声明式事务</h5> 
<h6><a id="1_645"></a>1、为每个数据源定义一个事务管理器</h6> 
<pre><code class="prism language-c"><span class="token comment">//数据源1</span>
@Bean
public DataSource <span class="token function">dataSource1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>DataSource dataSource <span class="token operator">=</span> new org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">DataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/ds1?characterEncoding=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"root123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setInitialSize</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">//事务管理器1，对应数据源1</span>
@Bean
public PlatformTransactionManager <span class="token function">transactionManager1</span><span class="token punctuation">(</span>@<span class="token function">Qualifier</span><span class="token punctuation">(</span><span class="token string">"dataSource1"</span><span class="token punctuation">)</span>DataSource dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> new <span class="token function">DataSourceTransactionManager</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">//数据源2</span>
@Bean
public DataSource <span class="token function">dataSource2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>DataSource dataSource <span class="token operator">=</span> new org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">DataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/ds2?characterEncoding=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"root123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setInitialSize</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">//事务管理器2，对应数据源2</span>
@Bean
public PlatformTransactionManager <span class="token function">transactionManager2</span><span class="token punctuation">(</span>@<span class="token function">Qualifier</span><span class="token punctuation">(</span><span class="token string">"dataSource2"</span><span class="token punctuation">)</span>DataSource dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> new <span class="token function">DataSourceTransactionManager</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2_bean__683"></a>2、指定事务的管理器 bean 名称</h6> 
<p>使用@Transaction 中时，需通过@Transaction 注解的 value 或 transactionManager 属性指定事务管理器 bean 名称，如：</p> 
<pre><code class="prism language-c">@<span class="token function">Transactional</span><span class="token punctuation">(</span>transactionManager <span class="token operator">=</span> <span class="token string">"transactionManager1"</span><span class="token punctuation">,</span> propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
public <span class="token keyword">void</span> <span class="token function">required</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    this<span class="token punctuation">.</span>jdbcTemplate1<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">"insert into user1(name) VALUES (?)"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>多数据源事务的使用就这么简单，下面我们来看案例，案例才是精华。</p> 
<h6><a id="_694"></a>事务管理器运行过程</h6> 
<p>这里先给大家解释一下 REQUIRED 传播行为下，事务管理器的大致的运行过程，方便理解后面的案例代码。</p> 
<pre><code class="prism language-c">Service1中：
@<span class="token function">Transactional</span><span class="token punctuation">(</span>transactionManager <span class="token operator">=</span> <span class="token string">"transactionManager1"</span><span class="token punctuation">,</span> propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
public <span class="token keyword">void</span> <span class="token function">m1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    this<span class="token punctuation">.</span>jdbcTemplate1<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">"insert into user1(name) VALUES ('张三')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 service2<span class="token punctuation">.</span><span class="token function">m2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
Service2中：
@<span class="token function">Transactional</span><span class="token punctuation">(</span>transactionManager <span class="token operator">=</span> <span class="token string">"transactionManager1"</span><span class="token punctuation">,</span> propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>REQUIRED<span class="token punctuation">)</span>
public <span class="token keyword">void</span> <span class="token function">m2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    this<span class="token punctuation">.</span>jdbcTemplate1<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">"insert into user1(name) VALUES ('李四')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>spring 事务中有个 resources 的 ThreadLocal，static 修饰的，用来存放共享的资源，稍后过程中会用到。<br> private static final ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources = new NamedThreadLocal&lt;&gt;(“Transactional resources”);<br> 下面看 m1 方法简化版的事务过程：</p> 
<pre><code class="prism language-c"><span class="token number">1</span>、TransactionInterceptor拦截m1方法
<span class="token number">2</span>、获取m1方法的事务配置信息：事务管理器bean名称：transactionManager1，事务传播行为：REQUIRED
<span class="token number">3</span>、从spring容器中找到事务管理器transactionManager1，然后问一下transactionManager1，当前上下文中有没有事务，显然现在是没有的
<span class="token number">4</span>、创建一个新的事务
    <span class="token comment">//获取事务管理器对应的数据源，即dataSource1</span>
    DataSource dataSource1 <span class="token operator">=</span> transactionManager1<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//即从dataSource1中获取一个连接</span>
    Connection conn <span class="token operator">=</span> transactionManager1<span class="token punctuation">.</span>dataSource1<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//开启事务手动提交</span>
    conn<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将dataSource1-&gt;conn放入map中</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>dataSource1<span class="token punctuation">,</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//将map丢到上面的resources ThreadLocal中</span>
    resources<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5</span>、下面来带m1放的第一行代码：this<span class="token punctuation">.</span>jdbcTemplate1<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">"insert into user1(name) VALUES ('张三')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6</span>、jdbctemplate内部需要获取数据连接，获取连接的过程
    <span class="token comment">//从resources这个ThreadLocal中获取到map</span>
    Map map <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通过jdbcTemplate1.datasource从map看一下没有可用的连接</span>
    Connection conn <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>jdbcTemplate1<span class="token punctuation">.</span>datasource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果从map没有找到连接，那么重新从jdbcTemplate1.datasource中获取一个</span>
    <span class="token comment">//大家应该可以看出来，jdbcTemplate1和transactionManager1指定的是同一个dataSource，索引这个地方conn是不为null的</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>conn<span class="token operator">==</span>null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     conn <span class="token operator">=</span> jdbcTemplate1<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token number">7</span>、通过上面第<span class="token number">6</span>步获取的conn执行db操作，插入张三
<span class="token number">8</span>、下面来到m1方法的第<span class="token number">2</span>行代码：service2<span class="token punctuation">.</span><span class="token function">m2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">9</span>、m2方法上面也有@Transactional<span class="token punctuation">,</span>TransactionInterceptor拦截m2方法
<span class="token number">10</span>、获取m2方法的事务配置信息：事务管理器bean名称：transactionManager1，事务传播行为：REQUIRED
<span class="token number">11</span>、从spring容器中找到事务管理器transactionManager1，然后问一下transactionManager1，当前上下文中有没有事务，显然是是有的，m1开启的事务正在执行中，所以m2方法就直接加入这个事务了
<span class="token number">12</span>、下面来带m2放的第一行代码：this<span class="token punctuation">.</span>jdbcTemplate1<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">"insert into user1(name) VALUES ('李四')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span>、jdbctemplate内部需要获取数据连接，获取连接的过程
    <span class="token comment">//从resources这个ThreadLocal中获取到map</span>
    Map map <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通过jdbcTemplate1.datasource从map看一下没有可用的连接</span>
    Connection conn <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>jdbcTemplate1<span class="token punctuation">.</span>datasource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果从map没有找到连接，那么重新从jdbcTemplate1.datasource中获取一个</span>
    <span class="token comment">//大家应该可以看出来，jdbcTemplate1和transactionManager1指定的是同一个dataSource，索引这个地方conn是不为null的</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>conn<span class="token operator">==</span>null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        conn <span class="token operator">=</span> jdbcTemplate1<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token number">14</span>、通过第<span class="token number">13</span>步获取的conn执行db操作，插入李四
<span class="token number">15</span>、最终TransactionInterceptor发现<span class="token number">2</span>个方法都执行完毕了，没有异常，执行事务提交操作，如下
    <span class="token comment">//获取事务管理器对应的数据源，即dataSource1</span>
    DataSource dataSource1 <span class="token operator">=</span> transactionManager1<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//从resources这个ThreadLocal中获取到map</span>
    Map map <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通过map拿到事务管理器开启的连接</span>
    Connection conn <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dataSource1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通过conn提交事务</span>
    conn<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//管理连接</span>
    conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">16</span>、清理ThreadLocal中的连接：通过map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>dataSource1<span class="token punctuation">)</span>将连接从resource ThreadLocal中移除
<span class="token number">17</span>、清理事务
</code></pre> 
<p>从上面代码中可以看出：整个过程中有 2 个地方需要用到数据库连接 Connection 对象，第 1 个地方是：spring 事务拦截器启动事务的时候会从 datasource 中获取一个连接，通过这个连接开启事务手动提交，第 2 个地方是：最终执行 sql 操作的时候，也需要用到一个连接。那么必须确保这两个连接必须是同一个连接的时候，执行 sql 的操作才会受 spring 事务控制，那么如何确保这 2 个是同一个连接呢？从代码中可以看出必须让事务管理器中的 datasource 和 JdbcTemplate 中的 datasource 必须是同一个，那么最终 2 个连接就是同一个对象。</p> 
<p><strong>什么是事务挂起操作？</strong></p> 
<p>这里以事务传播行为 REQUIRED_NEW 为例说明一下，REQUIRED_NEW 表示不管当前事务管理器中是否有事务，都会重新开启一个事务，如果当前事务管理器中有事务，会把当前事务挂起。</p> 
<p>所谓挂起，你可以这么理解：对当前存在事务的现场生成一个快照，然后将事务现场清理干净，然后重新开启一个新事务，新事务执行完毕之后，将事务现场清理干净，然后再根据前面的快照恢复旧事务。</p> 
<p>下面我们再回到本文的内容，多数据源事务管理。<br> 事务管理器如何判断当前是否有事务？<br> 简化版的过程如下：</p> 
<pre><code class="prism language-c">Map map<span class="token operator">=</span>resource的ThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
DataSource datasource <span class="token operator">=</span> transactionManager<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Connection conn <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>datasource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//如果conn不为空，就表示当前有事务</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>conn<span class="token operator">!=</span>null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从这段代码可以看出：判断是否存在事务，主要和 datasource 有关，和事务管理器无关，即使是不同的事务管理器，只要事务管理器的 datasource 是一样的，那么就可以发现当前存在的事务。</p> 
<h3><a id="JTAmybatis_796"></a>多数据源事务管理（使用JTA+多mybatis工厂）</h3> 
<h5><a id="11__797"></a>1.1 环境说明</h5> 
<h5><a id="111__798"></a>1.1.1 组件说明</h5> 
<p>DataSource: Alibaba Druid<br> Database: MySQL 5.7<br> SpringBoot: 2.2.2.RELEASE<br> ORM: MyBatis<br> JTA: Atomikos</p> 
<h5><a id="112__804"></a>1.1.2 项目关键依赖</h5> 
<pre><code class="prism language-c">    <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>mybatis<span class="token operator">-</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.1</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>atomikos transaction management<span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>jta<span class="token operator">-</span>atomikos<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>alibaba<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>druid<span class="token operator">-</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1.1</span><span class="token number">.21</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<h5><a id="113__823"></a>1.1.3 多数据源事务管理（）</h5> 
<ul><li>数据源使用两个数据库的不同表</li><li>都是用Druid做连接池，然后用Atomikos管理</li></ul> 
<h6><a id="114_JTA_827"></a>1.1.4 JTA的工具</h6> 
<ul><li>SpringBoot可以用的官方说了两个一个是Atomikos，另一个是Bitronix，除此之外还可以在支持JTA的web server中用。（Tomcat不支持）<br> SpringBoot文档中的说明：当检测到JTA环境时，将使用Spring的0</li><li>JtaTransactionManager来管理事务。JMS、DataSource、JPA已升级为支持XA事务。可以用标准的Spring用法（例如@Transactional）来参与分布式事务。如果您在JTA环境中，并且仍要使用本地事务，则可以将spring.jta.enabled属性设置为false以禁用JTA自动配置。</li></ul> 
<h4><a id="12__832"></a>1.2 实例业务说明</h4> 
<p>简单逻辑，两张表，分别在两个不同的库中，然后一个service方法操作两个库的数据。</p> 
<h4><a id="13__834"></a>1.3 多数据源配置</h4> 
<p>第一张表：是账户表<br> 第二章表：是订单表</p> 
<pre><code class="prism language-c">spring<span class="token operator">:</span>
  application<span class="token operator">:</span>
    name<span class="token operator">:</span> two<span class="token operator">-</span>data<span class="token operator">-</span>source
  datasource<span class="token operator">:</span>
    account<span class="token operator">:</span>
      url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token comment">//127.0.0.1:3306/transaction_account?useSSL=false&amp;characterEncoding=UTF-8</span>
      username<span class="token operator">:</span> root
      password<span class="token operator">:</span> xxxxx
    order<span class="token operator">:</span>
      url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token comment">//127.0.0.1:3306/transaction_order?useSSL=false&amp;characterEncoding=UTF-8</span>
      username<span class="token operator">:</span> root
      password<span class="token operator">:</span> xxxxx
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">logging</span><span class="token expression"><span class="token operator">:</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">level</span><span class="token expression"><span class="token operator">:</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>    <span class="token directive keyword">root</span><span class="token expression"><span class="token operator">:</span> DEBUG</span></span>
</code></pre> 
<h5><a id="132_Bean_854"></a>1.3.2 Bean注册</h5> 
<p>主要包括以下步骤</p> 
<p>1、分别注册对应DataSource、SqlSessionFactory、SqlSessionTemplate的Bean<br> 2、然后指定表的Mapper的位置，并且把Mybatis中原有的sqlSessionTemplate设置成你注册的。</p> 
<p>需要注意的点：<br> DataSource不能直接使用Druid提供的DruidDataSource, 需要使用atomikos来包装一下Druid提供的DruidXADataSource，来支持XA规范<br> 如果你不想用Druid，可以考虑使用MysqlXADataSource（我没试过）<br> 注册的Bean的对应关系要正确</p> 
<ul><li>order库的类似 此处略（本质上和上面的mybatis多数据源一样，需要指定不同的sqlfactory）</li></ul> 
<pre><code class="prism language-c">```c
@Configuration
@<span class="token function">MapperScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"io.ilss.transaction.twodatasource.dao.account"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> sqlSessionTemplateRef <span class="token operator">=</span> <span class="token string">"accountSqlSessionTemplate"</span><span class="token punctuation">)</span>
public class AccountConfiguration <span class="token punctuation">{<!-- --></span>

    @<span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"${spring.datasource.account.url}"</span><span class="token punctuation">)</span>
    private String url<span class="token punctuation">;</span>
    @<span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"${spring.datasource.account.username}"</span><span class="token punctuation">)</span>
    private String username<span class="token punctuation">;</span>
    @<span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"${spring.datasource.account.password}"</span><span class="token punctuation">)</span>
    private String password<span class="token punctuation">;</span>



    @<span class="token function">Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"accountDataSource"</span><span class="token punctuation">)</span>
    public DataSource <span class="token function">accountDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AtomikosDataSourceBean atomikosDataSourceBean <span class="token operator">=</span> new <span class="token function">AtomikosDataSourceBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DruidXADataSource druidXADataSource <span class="token operator">=</span> new <span class="token function">DruidXADataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidXADataSource<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidXADataSource<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidXADataSource<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        druidXADataSource<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"druidDataSource-account"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        atomikosDataSourceBean<span class="token punctuation">.</span><span class="token function">setXaDataSource</span><span class="token punctuation">(</span>druidXADataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        atomikosDataSourceBean<span class="token punctuation">.</span><span class="token function">setUniqueResourceName</span><span class="token punctuation">(</span><span class="token string">"accountResource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> atomikosDataSourceBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @<span class="token function">Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"accountSqlSessionFactory"</span><span class="token punctuation">)</span>
    public SqlSessionFactory <span class="token function">accountSqlSessionFactory</span><span class="token punctuation">(</span>DataSource accountDataSource<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
        SqlSessionFactoryBean factoryBean <span class="token operator">=</span> new <span class="token function">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>accountDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setMapperLocations</span><span class="token punctuation">(</span>new <span class="token function">PathMatchingResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token string">"classpath*:mappers/account/*.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factoryBean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @<span class="token function">Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"accountSqlSessionTemplate"</span><span class="token punctuation">)</span>
    @Primary
    public SqlSessionTemplate <span class="token function">accountSqlSessionTemplate</span><span class="token punctuation">(</span>@<span class="token function">Qualifier</span><span class="token punctuation">(</span><span class="token string">"accountSqlSessionFactory"</span><span class="token punctuation">)</span> SqlSessionFactory sqlSessionFactory<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> new <span class="token function">SqlSessionTemplate</span><span class="token punctuation">(</span>sqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>配置正确后会有如下日志信息</p> 
<pre><code class="prism language-c">c<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>AbstractDataSourceBean   <span class="token operator">:</span> AtomikosDataSoureBean <span class="token char">'orderResource'</span><span class="token operator">:</span> poolSize equals <span class="token keyword">default</span> <span class="token operator">-</span> this may cause performance problems<span class="token operator">!</span>
com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>DruidDataSource   <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>dataSource<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>druidDataSource<span class="token operator">-</span>order<span class="token punctuation">}</span> inited
c<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>AbstractDataSourceBean   <span class="token operator">:</span> AtomikosDataSoureBean <span class="token char">'accountResource'</span><span class="token operator">:</span> poolSize equals <span class="token keyword">default</span> <span class="token operator">-</span> this may cause performance problems<span class="token operator">!</span>
com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>DruidDataSource   <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>dataSource<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span>druidDataSource<span class="token operator">-</span>account<span class="token punctuation">}</span> inited
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> Loaded jar<span class="token operator">:</span>file<span class="token operator">:</span><span class="token operator">/</span>Users<span class="token operator">/</span>feng<span class="token operator">/</span><span class="token punctuation">.</span>m2<span class="token operator">/</span>repository<span class="token operator">/</span>com<span class="token operator">/</span>atomikos<span class="token operator">/</span>transactions<span class="token operator">/</span><span class="token number">4.0</span><span class="token number">.6</span><span class="token operator">/</span>transactions<span class="token operator">-</span><span class="token number">4.0</span><span class="token number">.6</span><span class="token punctuation">.</span>jar<span class="token operator">!</span><span class="token operator">/</span>transactions<span class="token operator">-</span>defaults<span class="token punctuation">.</span>properties
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> Thanks <span class="token keyword">for</span> using Atomikos<span class="token operator">!</span> Evaluate http<span class="token operator">:</span><span class="token comment">//www.atomikos.com/Main/ExtremeTransactions for advanced features and professional support...略</span>
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>default_max_wait_time_on_shutdown <span class="token operator">=</span> <span class="token number">9223372036854775807</span>
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>allow_subtransactions <span class="token operator">=</span> true
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>recovery_delay <span class="token operator">=</span> <span class="token number">10000</span>
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>automatic_resource_registration <span class="token operator">=</span> true
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>oltp_max_retries <span class="token operator">=</span> <span class="token number">5</span>
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>client_demarcation <span class="token operator">=</span> false
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>threaded_2pc <span class="token operator">=</span> false
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>serial_jta_transactions <span class="token operator">=</span> true
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>log_base_dir <span class="token operator">=</span> <span class="token operator">/</span>Users<span class="token operator">/</span>feng<span class="token operator">/</span>Projects<span class="token operator">/</span>java<span class="token operator">/</span>transaction<span class="token operator">-</span>example<span class="token operator">/</span>transaction<span class="token operator">-</span>logs
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>rmi_export_class <span class="token operator">=</span> none
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>max_actives <span class="token operator">=</span> <span class="token number">50</span>
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>checkpoint_interval <span class="token operator">=</span> <span class="token number">500</span>
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>enable_logging <span class="token operator">=</span> true
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>log_base_name <span class="token operator">=</span> tmlog
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>max_timeout <span class="token operator">=</span> <span class="token number">300000</span>
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>trust_client_tm <span class="token operator">=</span> false
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> java<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>initial <span class="token operator">=</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span>RegistryContextFactory
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>tm_unique_name <span class="token operator">=</span> <span class="token number">10.11</span><span class="token number">.11</span><span class="token number">.11</span><span class="token punctuation">.</span>tm
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>forget_orphaned_log_entries_delay <span class="token operator">=</span> <span class="token number">86400000</span>
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>oltp_retry_interval <span class="token operator">=</span> <span class="token number">10000</span>
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> java<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>url <span class="token operator">=</span> rmi<span class="token operator">:</span><span class="token comment">//localhost:1099</span>
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>force_shutdown_on_vm_exit <span class="token operator">=</span> false
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> USING<span class="token operator">:</span> com<span class="token punctuation">.</span>atomikos<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>default_jta_timeout <span class="token operator">=</span> <span class="token number">10000</span>
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>icatch<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>imp<span class="token punctuation">.</span>AssemblerImp     <span class="token operator">:</span> Using <span class="token keyword">default</span> <span class="token punctuation">(</span>local<span class="token punctuation">)</span> logging and recovery<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>d<span class="token punctuation">.</span>xa<span class="token punctuation">.</span>XATransactionalResource         <span class="token operator">:</span> orderResource<span class="token operator">:</span> refreshed XAResource
c<span class="token punctuation">.</span>a<span class="token punctuation">.</span>d<span class="token punctuation">.</span>xa<span class="token punctuation">.</span>XATransactionalResource         <span class="token operator">:</span> accountResource<span class="token operator">:</span> refreshed XAResource
</code></pre> 
<p>首先初始化两个Atomikos包裹的Druid的数据源，<br> 然后设置atomikos的参数，都是默认的<br> 最后XAResource刷新<br> 至此，配置完毕，可能有人好奇，JTA的代码一个都没有，因为SpringBoot使用JTA的时候引入的starter做了</p> 
<h5><a id="14__951"></a>1.4 事务实例</h5> 
<p>简单模拟订单生成支付过程，从账户中扣除一比钱，然后新增一比订单。<br> 编程的方式和Spring事务的方式一毛一样，没什么不同。</p> 
<h6><a id="141__954"></a>1.4.1 实现代码</h6> 
<pre><code class="prism language-c">@Slf4j
@Service
public class OrderServiceImpl implements OrderService <span class="token punctuation">{<!-- --></span>

    @Autowired
    private OrderInfoDAO orderInfoDAO<span class="token punctuation">;</span>

    @Autowired
    private AccountDAO accountDAO<span class="token punctuation">;</span>

    @Autowired
    PlatformTransactionManager transactionManager<span class="token punctuation">;</span>

    @Override
    @Transactional
    public String <span class="token function">createOrder</span><span class="token punctuation">(</span>OrderInfoDO orderInfoDO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AccountDO accountDO <span class="token operator">=</span> accountDAO<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>orderInfoDO<span class="token punctuation">.</span><span class="token function">getAccountId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> accountDO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"createOrder user is not present, accountId: {}"</span><span class="token punctuation">,</span> orderInfoDO<span class="token punctuation">.</span><span class="token function">getAccountId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"用户不存在！"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 用户费用扣除</span>
        accountDO<span class="token punctuation">.</span><span class="token function">setBalance</span><span class="token punctuation">(</span>accountDO<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>orderInfoDO<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        accountDAO<span class="token punctuation">.</span><span class="token function">updateByPrimaryKey</span><span class="token punctuation">(</span>accountDO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfoDAO<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>orderInfoDO<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token string">"成功"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    public String <span class="token function">createOrderCode</span><span class="token punctuation">(</span>OrderInfoDO orderInfoDO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        TransactionDefinition transactionDefinition <span class="token operator">=</span> new <span class="token function">DefaultTransactionDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取事务 开始业务执行</span>
        TransactionStatus transaction <span class="token operator">=</span> transactionManager<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span>transactionDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        try <span class="token punctuation">{<!-- --></span>
            AccountDO accountDO <span class="token operator">=</span> accountDAO<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>orderInfoDO<span class="token punctuation">.</span><span class="token function">getAccountId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> accountDO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"createOrder user is not present, accountId: {}"</span><span class="token punctuation">,</span> orderInfoDO<span class="token punctuation">.</span><span class="token function">getAccountId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">"用户不存在！"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 用户费用扣除</span>
            accountDO<span class="token punctuation">.</span><span class="token function">setBalance</span><span class="token punctuation">(</span>accountDO<span class="token punctuation">.</span><span class="token function">getBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>orderInfoDO<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            accountDAO<span class="token punctuation">.</span><span class="token function">updateByPrimaryKey</span><span class="token punctuation">(</span>accountDO<span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderInfoDAO<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>orderInfoDO<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"createOrderCode error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            transactionManager<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token string">"成功"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token function">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"create order failed, accountId: {}, errMsg: {}"</span><span class="token punctuation">,</span> orderInfoDO<span class="token punctuation">.</span><span class="token function">getAccountId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            transactionManager<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token string">"失败"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">error</span><span class="token punctuation">(</span>String  msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        throw new <span class="token function">RuntimeException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="mybatiss_plusseta_1018"></a>mybatiss plus多数据源事务管理（seta）</h5> 
<p>mybatis plus从3.3.0开始支持本地多数据源事务，无需第三方。<br> 尝试手动构建数据源结合JTA方案 如https://www.cnblogs.com/cicada-smile/p/13289306.html。</p> 
<p>多数据源事务方案一直是一个难题，通常的解决方案有以下二种。</p> 
<p>利用atomiks手动构建多数据源事务，适合数据源较少，配置的参数也不太多的项目。难点就是手动配置量大，需要耗费一定时间。<br> 用seata类似的分布式事务解决方案,难点就是需要搭建维护如seata-server的统一管理中心。</p> 
<pre><code class="prism language-c">不支持spring原生事务，不支持spring事务，不支持spring事务，可分别使用，千万不能混用。
再次强调不支持spring事务注解，可理解成独立写了一套事务方案。
只适合简单本地多数据源场景， 如果涉及异步和微服务等场景，请使用seata方案
</code></pre> 
<p>在需要切换数据源且需要事务支持的方法上加@DSTransactional.</p> 
<p>PS：一般需要分布式事务的场景大多数都是微服务化，个人并不建议在单体项目引入多数据源+分布式事务，有能力尽早拆开，可为过度方案。</p> 
<p>seata Github地址https://github.com/seata/seata<br> seata 文档https://seata.io/zh-cn/docs/overview/what-is-seata.html<br> seata 示例https://github.com/seata/seata-samples<br> seata 最新版本</p> 
<h2><a id="_1041"></a>总结：</h2> 
<p>使用mybatisplus来实现，基于上面的集中场景，完成配置式的开发。<br> 支持 数据源分组 ，适用于多种场景 纯粹多库 读写分离 一主多从 混合模式。<br> 支持数据库敏感配置信息 加密 ENC()。<br> 支持每个数据库独立初始化表结构schema和数据库database。<br> 支持无数据源启动，支持懒加载数据源（需要的时候再创建连接）。<br> 支持 自定义注解 ，需继承DS(3.2.0+)。<br> 提供并简化对Druid，HikariCp，BeeCp,Dbcp2的快速集成。<br> 提供对Mybatis-Plus，Quartz，ShardingJdbc，P6sy，Jndi等组件的集成方案。<br> 提供 自定义数据源来源 方案（如全从数据库加载）。<br> 提供项目启动后 动态增加移除数据源 方案。<br> 提供Mybatis环境下的 纯读写分离 方案。<br> 提供使用 spel动态参数 解析数据源方案。内置spel，session，header，支持自定义。<br> 支持 多层数据源嵌套切换 。（ServiceA &gt;&gt;&gt; ServiceB &gt;&gt;&gt; ServiceC）。<br> 提供 **基于seata的分布式事务方案。<br> 提供 本地多数据源事务方案。</p> 
<h2><a id="_1057"></a>引用</h2> 
<ul><li>https://zhuanlan.zhihu.com/p/529772940</li><li>https://blog.csdn.net/qq_40300227/article/details/125541289</li><li>https://www.jianshu.com/p/421f7be8627c</li><li>https://juejin.cn/post/6844904041852436493</li><li>https://blog.csdn.net/chenzoff/article/details/125077167</li><li>官网https://www.kancloud.cn/tracy5546/dynamic-datasource/purchase</li><li>https://blog.csdn.net/ooaash/article/details/117709676</li><li>https://www.kancloud.cn/ztgis/gisboot/2312961</li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/95201b5f648cd13cdabf149a094fabf1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">（附源码课件）10款Java小游戏满足你各种需求</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e8fb3f2f7b7e1dde7c8e3562bac880b3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">蚁群算法(ant system,AS)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>