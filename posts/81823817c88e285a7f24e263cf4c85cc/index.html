<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Linux】线程互斥详解：多线程会有什么问题？什么是互斥锁？C&#43;&#43;怎么封装使用互斥锁？ - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Linux】线程互斥详解：多线程会有什么问题？什么是互斥锁？C&#43;&#43;怎么封装使用互斥锁？" />
<meta property="og:description" content="多线程可以提高程序的并发性和运行效率，充分利用计算机的多核资源. 前面的几篇文章已经介绍了, Linux线程的基本概念、基本控制等内容.
我们已经看到了多线程可以提升运行效率等. 但是, 也发现了问题, 多线程可能会导致输出混乱、访问共享资源混乱、竞争等问题.
输出混乱只是小问题, 而像访问资源混乱、错误的问题 就比较大了.
线程互斥 在正式分析线程互斥之前. 以线程的角度再介绍三个概念, 这三个概念在介绍共享内存时就已经简单的提过.
临界资源和临界区 临界资源: 不同执行流都可以看到的同一资源, 就叫做临界资源临界区: 访问临界资源的代码, 就叫就临界区原子性: 一个操作, 如果只存在两种状态: 未完成、已完成, 而没有中间状态, 就称这个操作是具有原子性的. 那么, 一下面这段代码为例:
#include &lt;iostream&gt; #include &lt;unistd.h&gt; #include &lt;pthread.h&gt; using std::cout; using std::endl; int tickets = 10000; // 查票 void* inqureTicket(void* args) { const char* name = static_cast&lt;const char*&gt;(args); int cnt = 10; while (cnt--) { if (tickets &gt; 0) { usleep(100000); printf(&#34;%s: %lu 查到剩余票了, 还有: %d\n&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/81823817c88e285a7f24e263cf4c85cc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-17T21:13:12+08:00" />
<meta property="article:modified_time" content="2023-04-17T21:13:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Linux】线程互斥详解：多线程会有什么问题？什么是互斥锁？C&#43;&#43;怎么封装使用互斥锁？</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/7a/fe/k5gsYrNh_o.png" alt=" "></p> 
<p>多线程可以提高程序的并发性和运行效率，充分利用计算机的多核资源. 前面的几篇文章已经介绍了, Linux线程的基本概念、基本控制等内容.</p> 
<p>我们已经看到了多线程可以提升运行效率等. 但是, 也发现了问题, 多线程可能会导致输出混乱、访问共享资源混乱、竞争等问题.</p> 
<p>输出混乱只是小问题, 而像访问资源混乱、错误的问题 就比较大了.</p> 
<h2><a id="_8"></a>线程互斥</h2> 
<p>在正式分析线程互斥之前. 以线程的角度再介绍三个概念, 这三个概念在介绍共享内存时就已经简单的提过.</p> 
<h3><a id="_12"></a>临界资源和临界区</h3> 
<ol><li>临界资源: 不同执行流都可以看到的同一资源, 就叫做临界资源</li><li>临界区: 访问临界资源的代码, 就叫就临界区</li><li>原子性: 一个操作, 如果只存在两种状态: 未完成、已完成, 而没有中间状态, 就称这个操作是具有原子性的.</li></ol> 
<p>那么, 一下面这段代码为例:</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

<span class="token keyword">int</span> tickets <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>

<span class="token comment">// 查票</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">inqureTicket</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cnt<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: %lu 查到剩余票了, 还有: %d\n"</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"没有票了\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    pthread_t tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">,</span> tid3<span class="token punctuation">,</span> tid4<span class="token punctuation">;</span>

    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> inqureTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> inqureTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> inqureTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> inqureTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a9/73/DcHhYorw_o.gif" alt="cri_res_cri_sec |wide"></p> 
<p>这段代码中, 临界资源和临界区都是什么？</p> 
<p>首先, 票(<code>tickets</code>) 可以被所有线程看到, 并访问. 所以 <strong><code>票即为临界资源</code></strong>.</p> 
<p>而 不同线程所执行的回调函数<code>inquireTicket()</code>对临界资源进行了访问, 那么 整个回调函数就都是临界区吗？</p> 
<p>并不是, 只有访问了临界资源的那一部分代码被称作临界区, 即：</p> 
<p><img src="https://images2.imgbox.com/65/dc/ZBc2HwZR_o.png" alt=" "></p> 
<p>首先是, <code>if (tickets &gt; 0)</code> 访问临界资源, 对临界资源进行了判断.</p> 
<p>然后就是 输出了 <code>tickets</code> 也对临界资源进行了访问.</p> 
<p>所以, <strong><code>这一部分才叫 临界区</code></strong>.</p> 
<h3><a id="_84"></a>多线程访问临界资源的问题</h3> 
<p>多线程访问临界资源时有可能造成错误的.</p> 
<p>上面的代码执行之后, 没有发生错误. 是因为我们只是读取了临界资源, 并没有修改临界资源.</p> 
<p>如果我们将代码改为对临界资源的修改, 我们设置回调函数内循环抢票, 知道抢到0张票:</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

<span class="token keyword">int</span> tickets <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">grabTicket</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: %lu 抢到票了, 编号为: %d\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"没有票了, %s: %lu 放弃抢票\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    pthread_t tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">,</span> tid3<span class="token punctuation">,</span> tid4<span class="token punctuation">;</span>

    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_1"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_2"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_3"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_4"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行这段代码, 你就会发现有可能会出错误:</p> 
<p><img src="https://images2.imgbox.com/8a/3c/1S8t4sEm_o.gif" alt="抢票出错"></p> 
<p>可以看到, 线程3抢到了 编号为0的票, 线程4抢到了编号为-1的票. 这两张票 很明显是不应改存在的. 因为, 我们设置的 只有 <code>tickets &gt; 0</code> 才会输出 抢到票了, 这句话.</p> 
<p>那么为什么会出现这种情况呢？</p> 
<p>根据代码, 临界区是：</p> 
<p><img src="https://images2.imgbox.com/6a/4a/hG4A3ILe_o.png" alt=" "></p> 
<p>这部分代码存在两个计算： <code>tickets &gt; 0</code> 和 <code>tickets--</code></p> 
<p>造成 线程抢到负票, 其实就是因为 <code>tickets &gt; 0</code> 计算时发生了一些错误.</p> 
<blockquote> 
 <p>代码中有关算数计算的问题, 都是交给CPU执行的.</p> 
 <p>无论是 <code>+ - * /</code> 还是 <code>逻辑运算</code> 还是 <code>逻辑判断</code>. 最终, <code>CPU 都会通过 </code> <strong><code>位移运算</code></strong> 和 <strong><code>加法运算</code></strong> <code>来解决</code></p> 
</blockquote> 
<p>这个判断的过程时如何发生错误的呢？</p> 
<p>当 需要进行判断的时候, CPU 会将判断这个操作分成至少3步来进行：</p> 
<ol><li>CPU读取判断并放入寄存器中</li><li>CPU执行数据判断</li><li>CPU将判断结果返回到代码中</li></ol> 
<p>那么, 当 <code>tickets 为 1</code>, 且 <code>线程1</code> 进行判断时, 正常的情况是这样的:</p> 
<p><img src="https://images2.imgbox.com/6b/c4/Agq1XxbJ_o.png" alt=" "></p> 
<blockquote> 
 <p>CPU 进行逻辑判断, 其实是通过 判断式子, 计算出一个真值或假值, 进而返回到 判断语句中.</p> 
 <p>例如, 此例中 tickets = 1, 判断 <code>tickets &gt; 0</code>, CPU 就可能 计算 <code>1 + -0</code> 的结果, 然后将结果返回到 判断语句中</p> 
</blockquote> 
<p>此时, 判断的结果肯定是真, 所以会执行抢票语句, 然后 <code>tickets--</code>.</p> 
<p>这是正常的情况, 那么 如果出现其他情况呢？</p> 
<p>还是在 <code>tickets = 1</code> 时, 线程 1 需要进行判断, 但是 CPU计算完成之后, 还没有将结果返回给线程1的代码中, 却需要调度线程2了.</p> 
<p>然后 操作系统将CPU计算的结果保存到线程1的上下文数据中, 线程1 暂停运行:</p> 
<p><img src="https://images2.imgbox.com/b2/f1/YlBNzMS2_o.png" alt=" "></p> 
<p>然后 线程2被调度 运行需要进行判断, 现在 <code>tickets 依旧为1</code>, 然后 CPU 根据 tickets 为1进行计算, 计算完成之后, 还没有将结果返回给线程2代码中, 又需要调度线程3了.</p> 
<p>然后 操作系统又将 CPU计算的结果保存到线程2的上下文数据中, 线程2 暂停运行:</p> 
<p><img src="https://images2.imgbox.com/0c/fc/dk2fYZh7_o.png" alt=" "></p> 
<p>然后 线程3被调度 运行需要进行判断, 现在的 <code>tickets 还是1</code>, 然后CPU 根据tickets为1进行计算, 计算完成之后, 正常将结果返回给了线程3的代码中, 此时 tickets为1, 所以 判断结果肯定为真, 所以线程3 执行抢票操作 <code>tickets--</code>, <code>tickets 变为 0</code>. 线程3抢到 <code>编号为1</code> 的票:</p> 
<p><img src="https://images2.imgbox.com/df/53/dTLAkAkU_o.png" alt=" "></p> 
<p>然后 线程1又被调度, 操作系统恢复线程1的上下文数据, 上次已经计算出了结果, 所以该将线程1上下文数据中保存的上次CPU计算逻辑判断结果返回到代码中, 由于是根据 tickets为1 计算的, 所以结果为真, 此时 线程1 也会执行抢票操作 <code>tickets--</code>, <code>tickets 变为 -1</code>. 线程1抢到 <code>编号为0</code>的票:</p> 
<p><img src="https://images2.imgbox.com/7f/82/BGeKNqih_o.png" alt=" "></p> 
<p>然后 线程2又被调度, 操作系统恢复线程2的上下文数据, 将结果返回到代码中, 结果也是由 tickets 为1 计算的, 所以结果为真. 线程2也会执行抢票操作 <code>tickets--</code>, <code>tickets 变为 -2</code>. 线程2 抢到 <code>编号为-1</code> 的票.</p> 
<blockquote> 
 <p>线程2的再次调度, 与线程1再次调度的步骤相似, 不再画图演示</p> 
</blockquote> 
<p>由于CPU在执行线程的判断计算时, 突然因为某种情况需要调度其他线程, 就可能会造成最终判断错误的情况.</p> 
<blockquote> 
 <p>而 如果是执行 <code>tickets--</code> 时发生这种情况, 就有可能对票的数量修改混乱</p> 
 <p>很可能出现这样的情况:</p> 
 <p>线程1 执行完 <code>tickets--</code> 结果是 9999, 但是需要调度其他线程, 所以需要将 9999 存储到线程1的上下文数据中.</p> 
 <p>结果, CPU一直在调度其他线程, 票数实际已经被抢到了 5622. 但此时, 如果继续回去调度线程1, CPU就不会再计算, 而是恢复线程1的上下文数据, 然后发现已经计算过了, 就会直接将 9999 返回到线程1的代码中, 就会对全局变量作出修改. 将 5622 改为 9999.</p> 
 <p>此时 票的数量就会发生混乱.</p> 
</blockquote> 
<p>然而会造成这种结果的原因是什么？</p> 
<ol><li> <p>无论 <code>tickets &gt; 0</code> 还是 <code>tickets--</code> 这 <strong><code>两个计算操作都不是原子的</code></strong></p> <p>这两个操作都具有中间状态, 即 CPU计算的过程需要读取、计算、返回多个操作. 存在中间状态, 就有可能在处于中间状态的时候 暂停 然后其他线程访问同一个数据.</p> <p>如果, 这两个操作都是原子性的, 根本不存在什么中间状态, 就不会再造成这种情况</p> </li><li> <p>在已经有一个线程访问临界资源的时候, 其他线程依旧可以访问临界资源.</p> </li></ol> 
<p>有关操作的原子性, 本篇文章暂不涉及.</p> 
<p>本片文章会从第二个原因入手, 解决上面的线程数据不安全的问题.</p> 
<h3><a id="mutex_230"></a>mutex互斥量</h3> 
<p>第二个原因是: 在已经有一个线程访问临界资源的时候, 其他线程依旧可以访问临界资源</p> 
<p>那么要解决这个问题, 其实就是需要达成这三点:</p> 
<ol><li>代码必须要有互斥行为：当代码 <code>进入临界区</code> 执行时，<code>不允许其他线程进入该临界区</code></li><li>如果多个线程同时要执行临界区的代码，并且临界区没有线程在执行，那么<code>只能允许一个线程进入该临界区</code></li><li>如果线程 <code>不在临界区中</code> 执行，那么该线程 <code>不能阻止其他线程进入临界区</code></li></ol> 
<p>这三个要求其实<code>核心宗旨</code>只有一个, 即 <strong><code>给临界区加一把锁</code></strong>！</p> 
<p>当有线程进入临界区的时候, 就给临界区上一把锁, 阻止其他线程进入临界区. 这种锁, 被称为 <code>互斥锁</code>. 给代码实现互斥效果</p> 
<p>那么, 如何给代码上锁和解锁呢？</p> 
<h4><a id="__246"></a>锁的接口及使用 *</h4> 
<p>pthread 库为我们提供了 “造锁/买锁”、“改锁”、“上锁”、“解锁”、“毁锁/卖锁” 的接口:</p> 
<p><code>定义一个锁(造锁):</code></p> 
<p><img src="https://images2.imgbox.com/41/d3/dENqiDIm_o.png" alt=" "></p> 
<p>我们可以像定义变量一样, 使用 <code>pthread_mutex_t mutex;</code> 来定义一个互斥锁. 当然, 锁名可以随便设置.</p> 
<p>此锁, 即为 <strong><code>互斥量</code></strong></p> 
<blockquote> 
 <p>互斥锁的类型 <code>pthread_mutex_t</code> 是一个联合体.</p> 
</blockquote> 
<p><code>初始化锁(改锁):</code></p> 
<p><img src="https://images2.imgbox.com/86/0a/ug0roSQR_o.png" alt=" "></p> 
<p><code>pthread_mutex_init()</code> 是 pthread 库提供的初始化锁的接口, 第一个参数传入的就是需要初始化的锁的地址.</p> 
<p>第二个参数需要传入锁初始化的属性, 在接下来的使用中暂时不考虑.</p> 
<p>成功返回0, 否则返回错误码.</p> 
<p><code>摧毁锁:</code></p> 
<p><img src="https://images2.imgbox.com/a5/53/WaSU51N3_o.png" alt=" "></p> 
<p><code>pthread_mutex_destroy()</code> 用来摧毁定义的锁, 传入锁的指针.</p> 
<p>成功返回0, 否则返回错误码.</p> 
<p><code>上锁:</code></p> 
<p><code>pthread</code> 库为用户提供了, 两种不同的上锁方式：</p> 
<p><img src="https://images2.imgbox.com/c2/f0/f5HtB49g_o.png" alt=" "></p> 
<p><code>pthread_mutex_lock()</code>, 阻塞式上锁. 即 线程执行此接口时, 指定的锁已经被锁上了, 那么线程就进入阻塞状态, 知道解锁之后 此线程再上锁.</p> 
<p><code>pthread_mutex_trylock()</code>, 非阻塞式上锁. 即 线程执行此接口时, 尝试上锁, 如果指定的锁已经被锁上, 那么线程就先不上锁, 先去执行其他代码.</p> 
<p>上锁接口即为抢锁的接口, 哪个线程可以抢到, 哪个线程就能进入被锁上的区域.</p> 
<p>这两个接口, <code>一般用于 进入临界区之前</code></p> 
<p>当上锁成功, 则返回0, 否则返回一个错误码.</p> 
<p><code>解锁:</code></p> 
<p><img src="https://images2.imgbox.com/3e/24/ahE7Ya9Z_o.png" alt=" "></p> 
<p><code>pthread_mutex_unlock()</code> 解锁接口, <code>一般用于出临界区的时候</code></p> 
<p>当解锁成功, 返回0, 否则返回一个错误码.</p> 
<hr> 
<p>上面介绍了 <code>pthread</code> 库提供的互斥锁, 以及锁的一些接口.</p> 
<p>现在我们来使用以下锁.</p> 
<p>首先, 锁是需要定义的, 而且需要被可以抢占锁的线程看到.</p> 
<p>所以, 我们可以定义一个全局的锁, 然后在主线程内初始化:</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

<span class="token keyword">int</span> tickets <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
pthread_mutex_t mutex<span class="token punctuation">;</span>		<span class="token comment">// 定义锁</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">grabTicket</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 在即将进入临界区时加锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: %lu 抢到票了, 编号为: %d\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 在即将离开临界区时解锁</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"没有票了, %s: %lu 放弃抢票\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">// 初始化锁</span>

    pthread_t tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">,</span> tid3<span class="token punctuation">,</span> tid4<span class="token punctuation">;</span>

    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_1"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_2"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_3"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_4"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们定义了一个全局锁, 以保证所有线程都可以使用.</p> 
<p>我们在回调函数即将进入临界区的时候上锁, 在即将出临界区的时候解锁.</p> 
<blockquote> 
 <p>上锁和解锁, 一定要合理!</p> 
</blockquote> 
<p>然后查看代码的执行结果：</p> 
<p><img src="https://images2.imgbox.com/05/69/6DbGEYSE_o.gif" alt=" "></p> 
<p>可以看到, 抢票的过程是非常和谐的. <code>没有发生数据错误</code>的问题.</p> 
<p>但是, 票被抢完之后, 你会发现, <code>整个进程卡住了</code>. 这是为什么？</p> 
<p>在<code>没有上锁</code>的时候, 整个代码是可以<code>正常运行</code>的. 所以 <code>一定是锁的问题</code>.</p> 
<p>我们在即将进入临界区的时候, 上锁了. 也在即将出临界区的时候解锁的. 应该是没问题的.</p> 
<p>不过真的是这样吗？</p> 
<p>如果票被抢完了, <code>最后一次执行判断</code>语句, <code>会进到 哪个控制块中呢？</code> 是 if后 还是else后？</p> 
<p>我们<code>在if后的控制块中解锁</code>了, 但是并 <strong><code>没有在else后的控制块中解锁</code></strong>. 那么 <code>最后一次票数判断之后, 就会直接退出线程</code>.</p> 
<p>那么此时在推出线程的时候, 并 <strong><code>没有对已经上了的锁进行解锁</code></strong>.</p> 
<p>而我们知道, 我们使用的 <code>pthread_mutex_lock()</code> 是阻塞式上锁的. 如果执行的时候, 指定的锁已经被锁上了, 那就会阻塞式等待, 线程就会暂停运行.</p> 
<p>而 对指定锁上锁的线程已经退出了, 并且没有解锁. 所以其他线程会因为阻塞时等待而一直暂停运行.</p> 
<blockquote> 
 <p>上述现象是一种 <code>死锁</code> 现象.</p> 
 <p><strong><code>死锁是指在多线程的运行时, 每个线程都在等待其他线程释放资源, 导致所有线程都无法继续执行的一种状态</code></strong></p> 
 <p>(对进程也适用)</p> 
</blockquote> 
<p>所以, 是将我们还需要在else后的控制块中进行解锁：</p> 
<p><img src="https://images2.imgbox.com/ff/d2/4Y2rNSVO_o.png" alt=" "></p> 
<p>此时, 我们再执行代码：</p> 
<p><img src="https://images2.imgbox.com/66/d2/EKMJ6A79_o.gif" alt=" "></p> 
<p>可以看到, 票抢到很和谐, 而且线程退出的也很正常.</p> 
<p>但是, 也可以发现, 加了锁之后 整个进程的运行速度要满了许多. 因为要不停的上锁加解锁. 再加上 我们为了方便观察 在 if后 的控制块中使用了 两个usleep(100). 所以会很慢. 可以删除掉这两个语句.</p> 
<p>并且, 我们还发现, 为什么代码执行起来 好像并不是多线程一起执行的呢？而是排着队执行的？</p> 
<p>其实是因为, <strong><code>一个线程进入临界区加上锁之后, 其他进程就会进入阻塞状态. 在此线程的时间片内, 此线程就会一直进出临界区. 虽然此线程会在出临界区时解锁, 但是它又会马上进入下一个循环, 再次上锁. </code></strong></p> 
<p>而 <strong><code>其他线程想要申请到锁, 是需要先被CPU调度的, 线程的调度的消耗 对比 上锁和解锁消耗, 其实是很大的. 所以 线程调度并没有 上锁和解锁快</code></strong>. 所以, 我们实现的代码 <strong><code>在申请到锁的线程的时间片内, 其他线程是很难抢到锁的</code></strong>.</p> 
<p>所以, 我们可以在<code>线程解锁之后, 让线程等一会</code> 不让他马上进入下一个循环. <code>让CPU有充足的时间调度其他线程</code>. 然后就可以看到 <code>"百线争鸣"</code> 啦</p> 
<p><img src="https://images2.imgbox.com/1d/57/H74ZF4eI_o.png" alt=" "></p> 
<p>修改之后, 再看运行结果:</p> 
<p><img src="https://images2.imgbox.com/9c/c1/qtcIa51D_o.gif" alt=" "></p> 
<p>可以看到, 抢票过程非常的均匀, 也没有发生错错误</p> 
<h5><a id="_429"></a>锁的宏初始化</h5> 
<p><code>pthread</code> 库 为 锁的初始化提供了相应的接口<code>pthread_mutex_init()</code>.</p> 
<p>不过, 在man手册中还提到另一种初始化锁的方法. 不过此种方法只针对全局锁进行初始化.</p> 
<p>即 用宏初始化锁：<code>PTHREAD_MUTEX_INITIALIZER</code>.</p> 
<pre><code class="prism language-cpp">pthread_mutex_t mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>
或
<span class="token keyword">static</span> pthread_mutex_t mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>
</code></pre> 
<p>并且, 使用此宏初始化的锁, 不需要销毁. 即 不需要调用 <code>pthread_mutex_destroy()</code> 接口.</p> 
<p>这段代码可以演示一下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

<span class="token keyword">int</span> tickets <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
pthread_mutex_t mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>		<span class="token comment">// 定义全局锁, 并用宏来初始化</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">grabTicket</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在即将进入临界区时加锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: %lu 抢到票了, 编号为: %d\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在即将离开临界区时解锁</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"没有票了, %s: %lu 放弃抢票\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在线程即将退出时解锁</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    pthread_t tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">,</span> tid3<span class="token punctuation">,</span> tid4<span class="token punctuation">;</span>

    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_1"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_2"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_3"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_4"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这段代码的执行结果为：</p> 
<p><img src="https://images2.imgbox.com/f7/75/UA7z5lcF_o.gif" alt="define_init_mutex"></p> 
<p>多线程可以和谐的抢票.</p> 
<p>我们定义全局锁, 可以使用宏初始化.</p> 
<p>而如果我们在主线程中定义一个 <code>static</code> 修饰的锁, 其实 线程执行的函数是看不到的.</p> 
<p><img src="https://images2.imgbox.com/30/6c/XChHbeVz_o.png" alt=" "></p> 
<p>那么, 如何使其他线程看到呢？</p> 
<p>其实, 可以将主线程中定义的锁, 通过 <code>pthread_create()</code> 的第四个参数 传入线程执行的函数中.</p> 
<p>这样, 就可以让线程的函数看到锁.</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

<span class="token keyword">int</span> tickets <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">grabTicket</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    pthread_mutex_t<span class="token operator">*</span> pMutex <span class="token operator">=</span> <span class="token punctuation">(</span>pthread_mutex_t<span class="token operator">*</span><span class="token punctuation">)</span>args<span class="token punctuation">;</span>    <span class="token comment">// 将传入的参数强转为 锁类型</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>pMutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在即将进入临界区时加锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"thread: %lu 抢到票了, 编号为: %d\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>pMutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在即将离开临界区时解锁</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"没有票了, thread: %lu 放弃抢票\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>pMutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在线程即将退出时解锁</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> pthread_mutex_t mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>

    pthread_t tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">,</span> tid3<span class="token punctuation">,</span> tid4<span class="token punctuation">;</span>

    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> 			<span class="token comment">// 将锁地址当参数传入</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_1"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_2"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_3"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_4"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7b/4d/3iQ34qna_o.gif" alt=" "></p> 
<p>多线程也是可以很和谐的运行的.</p> 
<p>不过, 还有一个问题需要解决. 在之前, 我们是通过传入线程的序号来分辨线程的. 现在我们传入的是 锁的地址, 就不能确定线程的序号了.</p> 
<p>那么有没有一个方法, 既可以传入锁, 又可以传入线程的序号呢？</p> 
<p>当然, C语言可以使用结构体, C++ 可以使用类.</p> 
<p>下面我们使用结构体, 演示一下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

<span class="token keyword">int</span> tickets <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">threadData</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> _name<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    pthread_mutex_t<span class="token operator">*</span> _mutex<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>threadData<span class="token punctuation">;</span>							<span class="token comment">// 定义struct 成员包括 name 和 锁</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">grabTicket</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    threadData<span class="token operator">*</span> tD <span class="token operator">=</span> <span class="token punctuation">(</span>threadData<span class="token operator">*</span><span class="token punctuation">)</span>args<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>tD<span class="token operator">-&gt;</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在即将进入临界区时加锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: %lu 抢到票了, 编号为: %d\n"</span><span class="token punctuation">,</span> tD<span class="token operator">-&gt;</span>_name<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>tD<span class="token operator">-&gt;</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在即将离开临界区时解锁</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"没有票了, %s: %lu 放弃抢票\n"</span><span class="token punctuation">,</span> tD<span class="token operator">-&gt;</span>_name<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>tD<span class="token operator">-&gt;</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在线程即将退出时解锁</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> pthread_mutex_t mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>

    pthread_t tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">,</span> tid3<span class="token punctuation">,</span> tid4<span class="token punctuation">;</span>

    threadData<span class="token operator">*</span> tD1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">threadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    threadData<span class="token operator">*</span> tD2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">threadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    threadData<span class="token operator">*</span> tD3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">threadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    threadData<span class="token operator">*</span> tD4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">threadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tD1<span class="token operator">-&gt;</span>_mutex <span class="token operator">=</span> <span class="token operator">&amp;</span>mutex<span class="token punctuation">;</span>
    tD2<span class="token operator">-&gt;</span>_mutex <span class="token operator">=</span> <span class="token operator">&amp;</span>mutex<span class="token punctuation">;</span>
    tD3<span class="token operator">-&gt;</span>_mutex <span class="token operator">=</span> <span class="token operator">&amp;</span>mutex<span class="token punctuation">;</span>
    tD4<span class="token operator">-&gt;</span>_mutex <span class="token operator">=</span> <span class="token operator">&amp;</span>mutex<span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>tD1<span class="token operator">-&gt;</span>_name<span class="token punctuation">,</span> <span class="token string">"thread_1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>tD2<span class="token operator">-&gt;</span>_name<span class="token punctuation">,</span> <span class="token string">"thread_2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>tD3<span class="token operator">-&gt;</span>_name<span class="token punctuation">,</span> <span class="token string">"thread_3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>tD4<span class="token operator">-&gt;</span>_name<span class="token punctuation">,</span> <span class="token string">"thread_4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>tD1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>tD2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>tD3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> grabTicket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>tD4<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_1"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_2"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_3"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread join thread_4"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>也可以正常的执行:</p> 
<p><img src="https://images2.imgbox.com/30/1d/tWjQGurJ_o.gif" alt=" "></p> 
<h4><a id="_655"></a>锁的作用</h4> 
<p>上面我们介绍了锁, 使用了锁. 但锁到底有什么作用呢？</p> 
<p>我们使用锁对临界区上了锁, 好像是让线程的执行得更加规范, 在一个线程进入临界区之后, 就不让其他线程进入临界区了.</p> 
<p>但是, 为什么上了锁其他线程就进不去临界区呢？如果线程对临界区上了锁, 还没有出临界区的时候, 需要调度其他线程了. 线程会被切走吗？如果被切走了, 还会出现 线程数据安全的问题吗？</p> 
<p>我们先来回答第二个问题: <strong><code>如果线程对临界区上了锁, 还没有出临界区, 但是此时需要调用其他线程了, 当前线程会被切走吗？ 其他线程可以进入临界区吗？还会不会对临界资源有一定的影响？</code></strong></p> 
<p>答案是, 当前线程<code>会被切走</code>, 但是 其他线程<code>不可能再进入临界区</code>, 就<code>不可能再访问临界资源</code>.</p> 
<p>首先, 因为我们例子中的锁, 是一个 **<code>可以被其他所有线程看到的、只有一个的</code>**变量.</p> 
<p>并且, 我们让线程执行的代码中, 如果线程想要进入临界区, 就一定需要先申请锁. 而我们的锁只有一个, 如果锁已经被其他线程申请到了. 那么此时就不可能申请到锁, 只会进入阻塞状态.</p> 
<p>也就是说, 即使**<code>申请到锁、并且还没有解锁的线程当前并没有被调度, 其他线程也无法申请锁.</code>**</p> 
<p>可以理解为, 线程<code>申请到锁, 就是把锁拿走了</code>. <code>没有解锁</code>的时候, 就<code>一直拿着锁</code>. 即使没有被调度, 此线程也一直拿着锁. <code>其他线程就无法申请到锁</code>. 无法申请到锁, 就<code>无法继续执行代码</code>.</p> 
<blockquote> 
 <p>所以, 尽量不要在加了锁的临界区内做非常耗时的事情.</p> 
</blockquote> 
<p>这就是锁的作用.</p> 
<p>而 锁是可以被多个线程看到的资源, 那 <code>锁</code> 不就<code>是一个临界资源</code>吗？</p> 
<p>多线程访问未被保护的临界资源, 不是可能会发生一定的错乱吗？那么上锁和解锁的过程, 有没有可能发生错乱, 导致多个线程一起申请到锁呢？</p> 
<p>互斥锁是临界资源没错, 但 <strong><code>互斥锁的上锁和解锁过程, 已经被设计为了原子的</code></strong></p> 
<h4><a id="_685"></a>锁的大概原理</h4> 
<p>互斥锁本身, 是一个结构体类型数据. 除了成员, 其他没有什么值得详析说的.</p> 
<p>但, 上锁(<code>pthread_mutex_lock()</code>) 和 解锁(<code>pthread_mutex_unlock()</code>) 这两个过程, 是值得介绍以下的.</p> 
<p>这两个操作, 是如何设置为原子的的？</p> 
<p>首先, 介绍一个操作：为了实现互斥性, 大多数的体系结构都提供有 <code>swap</code> 或 <code>exchange</code> 等指令. 此指令的作用是, 直接将寄存器中的数据与内存中的数据做交换. 只有一条指令, 此指令是原子的.</p> 
<p>那么, 以 lock 和 unlock 的伪代码, 分析以下 这两个操作的原子性是怎么实现的：</p> 
<p><img src="https://images2.imgbox.com/6a/4d/Ext476DP_o.png" alt="|inline"></p> 
<p><img src="https://images2.imgbox.com/d5/41/6cvfYFXT_o.png" alt="|inline"></p> 
<p>我们针对 lock 修改过的伪代码分析.</p> 
<pre><code class="prism language-c++">// lock 伪代码
movb $0, %al
xchgb %al, mutex
if(al &gt; 0) {
	return 0;
}
else 
	阻塞等待;
goto lock;
</code></pre> 
<p>首先, <code>al</code> 表示寄存器, <code>mutex</code> 则表示在内存中的锁</p> 
<p><code>movb $0, %al</code>, 把 0 存入 al 寄存器中</p> 
<p><code>xchgb %al, mutex</code>, 交换 al寄存器 和 内存中mutex 的数据</p> 
<p><code>if(al &gt; 0) { return 0; }</code>, 如果 al 寄存器中的数据 大于 0, 则 申请锁成功, 返回 0.</p> 
<p>否则, 就阻塞等待.</p> 
<p>整个上锁函数执行的语句可以看作这几个过程.</p> 
<p>其中, <code>xchgb %al, mutex </code> 操作 是实际上锁的操作.</p> 
<p>我们用图来描述, 如果线程1 在执行上锁的操作:</p> 
<p><img src="https://images2.imgbox.com/af/a1/3DVga8Lk_o.png" alt=" "></p> 
<p>如果 没有上锁时, 锁的值是1.</p> 
<p>那么 执行 <code>xchgb %al, mutex</code> 将 al 中的0 与 mutex 的值交换, 其实就是 <strong><code>将 锁给了执行此语句的线程</code></strong></p> 
<p>为什么这样说呢.</p> 
<p>首先, <strong><code>线程的属性中是有维护寄存器的数据的, 即 线程的上下文数据</code></strong>.</p> 
<p>也就是说 <code>al寄存器中的数据</code>, 其实<code>就是 线程的上下文数据</code>. 如果<code>没有解锁</code>, 那么 此<code>线程从CPU 切走</code>时, <code>会将 寄存器数据(上下文数据)维护好, 一起切走</code>. 而此时<code>寄存器中的数据可能没有被清除</code>, 因为可能只是将寄存器数据存储到线程上下文数据中</p> 
<p>那么可能就有人觉得会有问题：<code>既然寄存器中数据还有</code>, 那么<code>下一个线程被调度</code>的时候, <code>不会直接读取寄存器中的数据吗？</code></p> 
<p><code>不会</code>, 新的线程被调度的时候, <code>首先</code>要做的就是<code>将线程自己的有关寄存器上下文数据恢复到寄存器中</code>. 也就是说, 当新线程被调度之后, CPU寄存器中会变为此线程的上下文数据.</p> 
<p>所以, 寄存器只是一个工具, 每个线程被调度时, 都会将自己上次维护的上下文数据恢复到寄存器中.</p> 
<p>那么, 就可以说如果在mutrex为1时(即锁没有被申请), 执行 <code>xchgb %al, mutex</code> 就是将锁给了执行此语句的线程.</p> 
<p>如果锁被带走了, 就意味着内存中 mutex 的值为0. 那么, 如果其他线程被调度, 再次执行上面的伪代码的类似逻辑, 那么 此线程的al上下文数据就会是0. 就代表着申请锁失败.</p> 
<p>那么也就是说, <strong><code>将内存中的数据换入寄存器中, 本质上就是 将内存中的数据 从共享状态 变为了线程私有</code></strong>. 因为 换入寄存器的数据, 基本当前线程的上下文数据.</p> 
<h3><a id="C__755"></a>C++封装互斥锁及相关使用 *</h3> 
<p><code>threadLock.hpp:</code></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">myMutex</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">myMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">myMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    pthread_mutex_t _lock<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 锁—警卫</span>
<span class="token keyword">class</span> <span class="token class-name">lockGuard</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">lockGuard</span><span class="token punctuation">(</span>myMutex<span class="token operator">*</span> myMutex<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">_myMutex</span><span class="token punctuation">(</span>myMutex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _myMutex<span class="token operator">-&gt;</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"上锁成功……\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">lockGuard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _myMutex<span class="token operator">-&gt;</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"解锁成功……\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    myMutex<span class="token operator">*</span> _myMutex<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>myThread.cpp:</code></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"threadLock.hpp"</span></span>

<span class="token keyword">int</span> tickets <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
myMutex mymutex<span class="token punctuation">;</span> <span class="token comment">// 定义一个锁类</span>

<span class="token comment">// 将抢票操作, 独立为一个函数实现</span>
<span class="token comment">// 抢票函数内有临界区, 所以需要上锁</span>
<span class="token keyword">bool</span> <span class="token function">grabTickets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">bool</span> ret <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 定义一个变量用于返回, 默认为false, 抢票成功改为 true</span>

    lockGuard <span class="token function">guard</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mymutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 上锁！</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tickets <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"thread: %lu 抢到票了, 编号为: %d\n"</span><span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tickets<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这个才是线程需要执行的函数</span>
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">startRoutine</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 强转</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">grabTickets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果抢票失败, 就 退出循环</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s, grab tickets success\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 为了方便观察, 设置为1s</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    pthread_t tid1<span class="token punctuation">,</span> tid2<span class="token punctuation">,</span> tid3<span class="token punctuation">,</span> tid4<span class="token punctuation">;</span>

    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> startRoutine<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> startRoutine<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> startRoutine<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> startRoutine<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread_4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread join thread_1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread join thread_2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread join thread_3\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread join thread_4\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这两个代码文件编译运行的执行结果是：</p> 
<p><img src="https://images2.imgbox.com/b4/c3/7ydyUZLj_o.gif" alt=" "></p> 
<p>在 <code>threadLock.hpp</code> 的这段代码中, 我们封装了两个类:</p> 
<ol><li> <p><code>myMutex互斥量类</code>, 即 <code>锁类</code>.</p> <p>构造函数的内容就是 锁的初始化. 析构函数的内容就是 锁的摧毁.</p> <p>还有两个成员函数就是 上锁和解锁.</p> </li><li> <p><code>lockGuard类</code>, 此类其实是为了更加简单的使用上锁和解锁而封装的.</p> <p>此类中, 定义了一个成员变量 是我们封装的 myMutex类.</p> <p>而 此类的构造函数, 首先通过初始化列表初始化成员变量. 然后通过成员变量来调用我们封装过的上锁函数. 就可以达到一个 实例化 <code>lockGuard</code> 对象自动上锁的功能</p> <p>然后是 此类的析构函数, 析构函数的内容就是通过成员变量调用我们封装过的解锁函数. 就可以达到 在 <code>lockGuard</code>对象析构的时候, 自动解锁的功能</p> </li></ol> 
<p>那么, 在 <code>myThread.cpp</code> 的这段使用我们封装的类的代码中, 我们是怎么上锁和解锁的？</p> 
<p>我们先实例化了一个 全局的 <code>myMutex 对象</code>, 以便于线程可以看到.</p> 
<p>然后, 将抢票的操作单独实现了一个函数, 抢票成功返回true, 失败返回 flase:</p> 
<p><img src="https://images2.imgbox.com/96/e6/xdGe4EbP_o.png" alt=" "></p> 
<p>并在此函数中, 即将进入临界区时, 使用我们实例化的 <code>myMutex 对象 </code> 实例化了一个 <code>lockGuard 对象</code>. 因为, 实例化 对象会自动执行构造函数, 而 lockGuard 类的构造函数内容就是 <code>上锁</code>. 所以 实例化 <code>lockGuard 对象</code> 就是自动上锁了.</p> 
<p>并没有手动去解锁, 因为此函数执行结束的时候, 临时对象的生命周期就要到了, 就会自动调用析构函数来释放自己. 而 <code>lockGuard</code> 类的析构函数内容就是 <code>解锁</code>. 所以 <code>lockGuard 对象</code> 生命结束, 就是自动解锁了.</p> 
<p>而我们 将 抢票逻辑的代码 单独实现了一个函数, 所以开始抢票就会自动上锁, 抢票失败或成功就会自动解锁</p> 
<blockquote> 
 <p>我们实现的上锁和解锁功能, 是基于C++类的特性来实现的.</p> 
 <p>并且, 一个类的生命周期是在其所在的控制块内. 所以还可以这样使用:</p> 
 <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"threadLock.hpp"</span></span>

<span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
myMutex mymutex<span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">startRoutine</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token comment">// 如果我们需要统计线程执行此函数了多少次, 我们只需要使用下面这段代码块</span>
 <span class="token punctuation">{<!-- --></span>
     lockGuard <span class="token function">myLock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mymutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
     cnt<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// 这也是一个控制块, myLock对象 出此控制块会自动调用析构函数, 即出此控制块会自动解锁.</span>

 <span class="token comment">// …… 其他代码</span>
<span class="token punctuation">}</span>
</code></pre> 
</blockquote> 
<h3><a id="_VS__923"></a>可重入 VS 线程安全</h3> 
<p>要对比可重入和线程安全. 就需要先了解这两个名词的概念</p> 
<h4><a id="_927"></a>概念</h4> 
<ul><li> <p><strong><code>线程安全：</code></strong> <strong><code>多线程并发运行同一段代码时, 单一线程不会影响到其他线程或整个进程的运行结果, 就叫做线程安全</code></strong></p> <p>如果会影响线程或进程, 就被称为 <code>线程不安全</code></p> </li><li> <p><strong><code>可重入：</code></strong> 同一个函数被不同执行流调用, 在一个执行流执行没结束时, 有其他执行流再次执行此函数, 这个现象叫 <code>重入</code>.</p> <p>如果, <strong><code>函数被重入执行结果等不会发生错误, 则成此函数为可重入的函数</code></strong>. 否则 为不可重入的函数</p> 
  <blockquote> 
   <p>函数被重入会出现错误, 其实是因为代码编写错误出现了BUG. 其实是编写者的问题, 而不是函数的问题.</p> 
   <p>重入是一种特性, 而不是一种错误.</p> 
  </blockquote> </li></ul> 
<p><img src="https://images2.imgbox.com/7c/39/YOoRfp3z_o.png" alt=""></p> 
<h4><a id="_944"></a>常见的线程不安全的情况</h4> 
<ul><li> <p>不保护共享变量的函数</p> </li><li> <p>函数状态随着被调用 会发生变化的函数</p> <p>比如, 我们在函数内部定义了一个静态变量, 然后不加锁的++, 用来统计线程调用此函数的次数</p> </li><li> <p>返回指向静态变量指针的函数</p> </li><li> <p>调用线程不安全函数的函数</p> </li></ul> 
<h4><a id="_956"></a>常见的线程安全的情况</h4> 
<ul><li>每个线程对全局变量或者静态变量 <strong><code>只有读取权限，没有写入权限</code></strong>，一般来说这些线程是 <code>安全</code> 的</li><li>类或接口对于线程来说都是 <code>原子操作</code></li><li>多个线程之间的切换<code>不会导致</code>该接口的<code>执行结果存在二义性</code></li></ul> 
<h4><a id="__962"></a>常见不可重入的情况 **</h4> 
<ul><li> <p><code>调用了malloc/free</code>函数，因为 <code>malloc函数是用全局链表来管理堆的</code></p> <p>如何理解 <code>malloc</code> 使用全局链表管理堆的呢？</p> <p>其实, malloc 在堆区动态开辟空间, 实际是调用了 系统调用brk. 并且 并不只是简单的开辟一块空间. 还需要将开辟出的空间以 全局链表的形式管理起来.</p> <p>进程地址空间是由PCB维护的, 在源码中即 task_struct 的成员 mm_struct 类型的变量.</p> <p>而在mm_struct 结构体中, 存在着一个成员是用来描述 虚拟内存列表：</p> <p><img src="https://images2.imgbox.com/bf/fc/fl3Jx5bA_o.png" alt="|wide"></p> <p>此变量就是用来维护开辟出来的堆的:</p> <p><img src="https://images2.imgbox.com/5e/a2/j5fU2p6s_o.png" alt=" "></p> <p>我们使用 malloc 开辟出10块空间, 就会以 vm 的形式组成一个 10个节点的链表. 释放一块空间, 就会删除一个节点.</p> <p>这就是管理堆的形式. 此链表是全局的.</p> </li><li> <p>调用了标准I/O库函数，标准I/O库的很多实现都以不可重入的方式使用全局数据结构</p> </li><li> <p>可重入函数体内使用了静态的数据结构</p> </li></ul> 
<h4><a id="_988"></a>常见可重入的情况</h4> 
<ul><li>不使用全局变量或静态变量</li><li>不使用用malloc或者new开辟出的空间</li><li>不调用不可重入函数</li><li>不返回静态或全局数据，所有数据都有函数的调用者提供</li><li>使用本地数据，或者通过制作全局数据的本地拷贝来保护全局数据</li></ul> 
<h4><a id="_996"></a>可重入与线程安全联系</h4> 
<ul><li>函数是可重入的，那就是线程安全的</li><li>函数是不可重入的，那就不能由多个线程使用，有可能引发线程安全问题</li><li>如果一个函数中有全局变量，那么这个函数既不是线程安全也不是可重入的</li></ul> 
<h4><a id="_1002"></a>可重入与线程安全区别</h4> 
<ul><li>重入函数是线程安全函数的一种</li><li>线程安全不一定是可重入的，而可重入函数则一定是线程安全的。</li><li>如果将对临界资源的访问加上锁，则这个函数是线程安全的. 但如果这个重入函数 若锁还未释放则可能会产生死锁，因此是不可重入的</li></ul> 
<p>这里提到一个名称, <code>死锁</code>. 那什么是死锁？</p> 
<h3><a id="_1010"></a>死锁</h3> 
<p><code>死锁</code>是什么？</p> 
<p><strong><code>死锁</code></strong>：在一组进程、线程中的各个进程、线程 <code>均占有不会释放的资源</code>，但 <strong><code>因互相申请被其他进程、线程所占用不会释放的资源而处于的一种永久等待状态</code></strong>.</p> 
<p>这是死锁的概念. 我们可以使用下面这段代码实现死锁：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
pthread_mutex_t mutexA <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>
pthread_mutex_t mutexB <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">startRoutineA</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexB<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"cnt: %d"</span><span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexB<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">startRoutineB</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexB<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"cnt: %d"</span><span class="token punctuation">,</span> cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexB<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexA<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexA<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexB<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pthread_t tidA<span class="token punctuation">,</span> tidB<span class="token punctuation">;</span>

    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tidA<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> startRoutineA<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"threadA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tidB<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> startRoutineB<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"threadB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tidA<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tidB<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行这段代码：</p> 
<p><img src="https://images2.imgbox.com/e8/d6/eqnaBrwk_o.gif" alt=" "></p> 
<p>这段代码的执行结果就是, 卡住. 没有代码在真正运行.</p> 
<p>这是为什么呢？</p> 
<p>首先我们定义了两个锁, 使用了两个线程.</p> 
<p>线程A, 先申请 锁A, 等1s, 再申请 锁B.</p> 
<p>线程B, 先申请 锁B, 等1s, 再申请 锁A.</p> 
<p>而 线程A和B 几乎是同时运行代码的. 也就是说 线程A 申请到锁A 和 线程B 申请到 锁B, <code>几乎</code>是同时的.</p> 
<p>再加上让他俩等了1s, 就导致, <code>线程A 拿着锁A, 在申请锁B</code>, <code>线程B 拿着锁B, 在申请锁A</code>. 他俩<code>都申请不到</code>, <code>直接造成死锁</code>.</p> 
<h4><a id="_1089"></a>死锁产生的必要条件</h4> 
<ol><li>互斥条件：: 一个资源每次只能被一个执行流使用</li><li>请求与保持条件: 一个执行流因请求资源而阻塞时，对已获得的资源保持不放</li><li>不剥夺条件: 一个执行流已获得的资源，在末使用完之前，不能强行剥夺</li><li>循环等待条件: 若干执行流之间形成一种头尾相接的循环等待资源的关系</li></ol> 
<p>这是死锁产生的四个必要条件</p> 
<p>有产生条件, 就有避免方法</p> 
<h4><a id="_1100"></a>死锁的避免方法</h4> 
<p>最直接有效的避免方法是 <strong><code>不使用锁</code></strong>. 虽然锁可以解决一些多线程的问题, 但是可能会造成死锁, 而且 上锁和解锁的过程是需要消耗资源的. 如果不停的上锁和解锁, 一定会托慢进程的运行速度.</p> 
<p>所以, 在需要使用锁的场景, <strong><code>最好先不要考虑如何设置锁, 可以先考虑一下是否可以不用锁</code></strong></p> 
<p>如果非要使用锁, 那就得考虑避免死锁:</p> 
<ol><li>破坏死锁的四个必要条件</li><li>加锁顺序一致</li><li>避免锁未释放的场景</li><li>资源一次性分配</li></ol> 
<p>可以通过这四种手段, 来尽量避免死锁.</p> 
<hr> 
<p>文章介绍到这里, 就要结束啦~</p> 
<p>感谢阅读~</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4feb46258d6e5d2a75410e03d280132d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python setattr/getattr</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/484cd617314f33e49672d33dce7e8307/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue3&#43;Springboot图片下载</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>