<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s 1.28版本二进制安装 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s 1.28版本二进制安装" />
<meta property="og:description" content="本文目录 二进制安装Kubernetes（k8s）v1.28.0介绍1.环境1.0.环境准备1.Linux网卡没有eth0显示ens33或者其它（以ens33为例）方法一：修改网卡配置方法二：重新安装机器(本文为虚拟机) 2.克隆的虚拟机，修改UUID，保证k8s集群每台机器UUID唯一 1.1.k8s基础系统环境配置1.配置IP2.设置主机名3.配置yum源4.安装一些必备工具4.1 下载离线所需文件(可选)CentOS7CentOS8Ubuntu 下载包和依赖 5.选择性下载需要工具(可选)6.关闭防火墙7.关闭SELinux8.关闭交换分区9.网络配置（俩种方式二选一）10.进行时间同步11.配置ulimit12.配置免密登录13.添加启用源14.升级内核至4.18版本以上15.安装ipvsadm16.修改内核参数17.所有节点配置hosts本地解析 2.k8s基本组件安装2.1.安装Containerd作为Runtime （推荐）2.1.1 配置Containerd所需的模块2.1.2 加载模块2.1.3 配置Containerd所需的内核2.1.4 创建Containerd的配置文件2.1.5 启动并设置为开机启动2.1.6 配置crictl客户端连接的运行时位置 2.2 安装docker作为Runtime （不推荐）2.2.1 解压docker程序2.2.2 创建containerd的service文件2.2.3 准备docker的service文件2.2.4 准备docker的socket文件2.2.5 配置加速器2.2.6 启动docker2.2.7 解压cri-docker2.2.8 写入启动cri-docker配置文件2.2.9 写入cri-docker的socket配置文件2.2.10 启动cri-docker 2.3.k8s与etcd下载及安装（仅在master01操作）2.3.1 解压k8s安装包2.3.2 查看版本2.3.3 将组件发送至其他k8s节点 2.3 创建证书相关文件(获取打包后文件的tar包) 3.相关证书生成3.1.生成etcd证书3.1.1 所有master节点创建证书存放目录3.1.2 master01节点生成etcd证书3.1.3 将证书复制到其他节点 3.2.生成k8s相关证书3.2.1 所有k8s节点(master&#43;slave节点)创建证书存放目录3.2.2 master01节点生成k8s证书3.2.3 master01节点生成apiserver聚合证书3.2.4 master01节点生成controller-manage的证书3.2.5 master01节点生成kube-scheduler的证书3.2.6 master01节点生成admin的证书配置3.2.7 master01节点创建kube-proxy证书3.2.8 master01节点创建ServiceAccount Key ——secret3.2.9 将证书发送到其他master节点3.2.10 查看证书 4.k8s系统组件配置4.1.etcd配置4.1.1 master01配置4.1.2 master02配置4.1.3 master03配置 4.2.创建service4.2.1 创建etcd.service并启动4.2.2 创建etcd证书目录4.2.3 查看etcd状态 5.高可用配置5.1 NGINX高可用方案 (推荐)5.1.1 master01节点进行编译5.1.2 写入启动配置 5.2 keepalived和haproxy 高可用方案 (不推荐)5.2.1 安装keepalived和haproxy服务5.2.2 修改haproxy配置文件（配置文件一样）5." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/837387519cff673ac88b6d158cfb8046/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-20T13:47:16+08:00" />
<meta property="article:modified_time" content="2023-10-20T13:47:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s 1.28版本二进制安装</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>本文目录</h4> 
 <ul><li><a href="#Kubernetesk8sv1280_1" rel="nofollow">二进制安装Kubernetes（k8s）v1.28.0</a></li><li><a href="#_6" rel="nofollow">介绍</a></li><li><a href="#1_20" rel="nofollow">1.环境</a></li><li><ul><li><a href="#10_42" rel="nofollow">1.0.环境准备</a></li><li><ul><li><a href="#1Linuxeth0ens33ens33_44" rel="nofollow">1.Linux网卡没有eth0显示ens33或者其它（以ens33为例）</a></li><li><ul><li><a href="#_46" rel="nofollow">方法一：修改网卡配置</a></li><li><a href="#_66" rel="nofollow">方法二：重新安装机器(本文为虚拟机)</a></li></ul> 
    </li><li><a href="#2UUIDk8sUUID_76" rel="nofollow">2.克隆的虚拟机，修改UUID，保证k8s集群每台机器UUID唯一</a></li></ul> 
   </li><li><a href="#11k8s_88" rel="nofollow">1.1.k8s基础系统环境配置</a></li><li><ul><li><a href="#1IP_92" rel="nofollow">1.配置IP</a></li><li><a href="#2_292" rel="nofollow">2.设置主机名</a></li><li><a href="#3yum_311" rel="nofollow">3.配置yum源</a></li><li><a href="#4_350" rel="nofollow">4.安装一些必备工具</a></li><li><ul><li><a href="#41__363" rel="nofollow">4.1 下载离线所需文件(可选)</a></li><li><ul><li><a href="#CentOS7_367" rel="nofollow">CentOS7</a></li><li><a href="#CentOS8_425" rel="nofollow">CentOS8</a></li><li><a href="#Ubuntu__474" rel="nofollow">Ubuntu 下载包和依赖</a></li></ul> 
    </li></ul> 
    </li><li><a href="#5_531" rel="nofollow">5.选择性下载需要工具(可选)</a></li><li><a href="#6_609" rel="nofollow">6.关闭防火墙</a></li><li><a href="#7SELinux_616" rel="nofollow">7.关闭SELinux</a></li><li><a href="#8_632" rel="nofollow">8.关闭交换分区</a></li><li><a href="#9_651" rel="nofollow">9.网络配置（俩种方式二选一）</a></li><li><a href="#10_680" rel="nofollow">10.进行时间同步</a></li><li><a href="#11ulimit_752" rel="nofollow">11.配置ulimit</a></li><li><a href="#12_787" rel="nofollow">12.配置免密登录</a></li><li><a href="#13_820" rel="nofollow">13.添加启用源</a></li><li><a href="#14418_839" rel="nofollow">14.升级内核至4.18版本以上</a></li><li><a href="#15ipvsadm_874" rel="nofollow">15.安装ipvsadm</a></li><li><a href="#16_952" rel="nofollow">16.修改内核参数</a></li><li><a href="#17hosts_1066" rel="nofollow">17.所有节点配置hosts本地解析</a></li></ul> 
  </li></ul> 
  </li><li><a href="#2k8s_1082" rel="nofollow">2.k8s基本组件安装</a></li><li><ul><li><a href="#21ContainerdRuntime__1086" rel="nofollow">2.1.安装Containerd作为Runtime （推荐）</a></li><li><ul><li><a href="#211_Containerd_1189" rel="nofollow">2.1.1 配置Containerd所需的模块</a></li><li><a href="#212__1208" rel="nofollow">2.1.2 加载模块</a></li><li><a href="#213_Containerd_1222" rel="nofollow">2.1.3 配置Containerd所需的内核</a></li><li><a href="#214_Containerd_1247" rel="nofollow">2.1.4 创建Containerd的配置文件</a></li><li><a href="#215__1297" rel="nofollow">2.1.5 启动并设置为开机启动</a></li><li><a href="#216_crictl_1319" rel="nofollow">2.1.6 配置crictl客户端连接的运行时位置</a></li></ul> 
   </li><li><a href="#22_dockerRuntime__1359" rel="nofollow">2.2 安装docker作为Runtime （不推荐）</a></li><li><ul><li><a href="#221_docker_1361" rel="nofollow">2.2.1 解压docker程序</a></li><li><a href="#222_containerdservice_1373" rel="nofollow">2.2.2 创建containerd的service文件</a></li><li><a href="#223_dockerservice_1430" rel="nofollow">2.2.3 准备docker的service文件</a></li><li><a href="#224_dockersocket_1504" rel="nofollow">2.2.4 准备docker的socket文件</a></li><li><a href="#225__1540" rel="nofollow">2.2.5 配置加速器</a></li><li><a href="#226_docker_1575" rel="nofollow">2.2.6 启动docker</a></li><li><a href="#227_cridocker_1606" rel="nofollow">2.2.7 解压cri-docker</a></li><li><a href="#228_cridocker_1620" rel="nofollow">2.2.8 写入启动cri-docker配置文件</a></li><li><a href="#229_cridockersocket_1680" rel="nofollow">2.2.9 写入cri-docker的socket配置文件</a></li><li><a href="#2210_cridocker_1716" rel="nofollow">2.2.10 启动cri-docker</a></li></ul> 
   </li><li><a href="#23k8setcdmaster01_1734" rel="nofollow">2.3.k8s与etcd下载及安装（仅在master01操作）</a></li><li><ul><li><a href="#231_k8s_1736" rel="nofollow">2.3.1 解压k8s安装包</a></li><li><a href="#232__1780" rel="nofollow">2.3.2 查看版本</a></li><li><a href="#233_k8s_1791" rel="nofollow">2.3.3 将组件发送至其他k8s节点</a></li></ul> 
   </li><li><a href="#23_tar_1815" rel="nofollow">2.3 创建证书相关文件(获取打包后文件的tar包)</a></li></ul> 
  </li><li><a href="#3_1824" rel="nofollow">3.相关证书生成</a></li><li><ul><li><a href="#31etcd_1841" rel="nofollow">3.1.生成etcd证书</a></li><li><ul><li><a href="#311_master_1843" rel="nofollow">3.1.1 所有master节点创建证书存放目录</a></li><li><a href="#312_master01etcd_1849" rel="nofollow">3.1.2 master01节点生成etcd证书</a></li><li><a href="#313__1995" rel="nofollow">3.1.3 将证书复制到其他节点</a></li></ul> 
   </li><li><a href="#32k8s_2006" rel="nofollow">3.2.生成k8s相关证书</a></li><li><ul><li><a href="#321_k8smasterslave_2008" rel="nofollow">3.2.1 所有k8s节点(master+slave节点)创建证书存放目录</a></li><li><a href="#322_master01k8s_2014" rel="nofollow">3.2.2 master01节点生成k8s证书</a></li><li><a href="#323_master01apiserver_2126" rel="nofollow">3.2.3 master01节点生成apiserver聚合证书</a></li><li><a href="#324_master01controllermanage_2203" rel="nofollow">3.2.4 master01节点生成controller-manage的证书</a></li><li><a href="#325_master01kubescheduler_2327" rel="nofollow">3.2.5 master01节点生成kube-scheduler的证书</a></li><li><a href="#326_master01admin_2450" rel="nofollow">3.2.6 master01节点生成admin的证书配置</a></li><li><a href="#327_master01kubeproxy_2570" rel="nofollow">3.2.7 master01节点创建kube-proxy证书</a></li><li><a href="#328_master01ServiceAccount_Key_secret_2695" rel="nofollow">3.2.8 master01节点创建ServiceAccount Key ——secret</a></li><li><a href="#329_master_2721" rel="nofollow">3.2.9 将证书发送到其他master节点</a></li><li><a href="#3210__2732" rel="nofollow">3.2.10 查看证书</a></li></ul> 
  </li></ul> 
  </li><li><a href="#4k8s_2753" rel="nofollow">4.k8s系统组件配置</a></li><li><ul><li><a href="#41etcd_2755" rel="nofollow">4.1.etcd配置</a></li><li><ul><li><a href="#411_master01_2791" rel="nofollow">4.1.1 master01配置</a></li><li><a href="#412_master02_2845" rel="nofollow">4.1.2 master02配置</a></li><li><a href="#413_master03_2899" rel="nofollow">4.1.3 master03配置</a></li></ul> 
   </li><li><a href="#42service_2953" rel="nofollow">4.2.创建service</a></li><li><ul><li><a href="#421_etcdservice_2957" rel="nofollow">4.2.1 创建etcd.service并启动</a></li><li><a href="#422_etcd_2990" rel="nofollow">4.2.2 创建etcd证书目录</a></li><li><a href="#423_etcd_3009" rel="nofollow">4.2.3 查看etcd状态</a></li></ul> 
  </li></ul> 
  </li><li><a href="#5_3035" rel="nofollow">5.高可用配置</a></li><li><ul><li><a href="#51_NGINX__3048" rel="nofollow">5.1 NGINX高可用方案 (推荐)</a></li><li><ul><li><a href="#511_master01_3049" rel="nofollow">5.1.1 master01节点进行编译</a></li><li><a href="#512__3082" rel="nofollow">5.1.2 写入启动配置</a></li></ul> 
   </li><li><a href="#52_keepalivedhaproxy___3169" rel="nofollow">5.2 keepalived和haproxy 高可用方案 (不推荐)</a></li><li><ul><li><a href="#521_keepalivedhaproxy_3171" rel="nofollow">5.2.1 安装keepalived和haproxy服务</a></li><li><a href="#522_haproxy_3180" rel="nofollow">5.2.2 修改haproxy配置文件（配置文件一样）</a></li><li><a href="#523_Master01keepalived_master_3276" rel="nofollow">5.2.3 Master01配置keepalived master节点</a></li><li><a href="#524_Master02keepalived_backup_3317" rel="nofollow">5.2.4 Master02配置keepalived backup节点</a></li><li><a href="#525_Master03keepalived_backup_3359" rel="nofollow">5.2.5 Master03配置keepalived backup节点</a></li><li><a href="#526_lb_3430" rel="nofollow">5.2.6 健康检查脚本配置（lb主机）</a></li><li><a href="#527__3476" rel="nofollow">5.2.7 启动服务</a></li><li><a href="#528__3491" rel="nofollow">5.2.8 测试高可用</a></li></ul> 
  </li></ul> 
  </li><li><a href="#6k8s_3505" rel="nofollow">6.k8s组件配置</a></li><li><ul><li><a href="#61apiservermaster_3513" rel="nofollow">6.1.创建apiserver（所有master节点）</a></li><li><ul><li><a href="#611_master01_3515" rel="nofollow">6.1.1 master01节点配置</a></li><li><a href="#612_master02_3567" rel="nofollow">6.1.2 master02节点配置</a></li><li><a href="#613_master03_3619" rel="nofollow">6.1.3 master03节点配置</a></li><li><a href="#614_apiservermaster_3725" rel="nofollow">6.1.4 启动apiserver（所有master节点）</a></li></ul> 
   </li><li><a href="#62kubecontrollermanager_servicemaster_3741" rel="nofollow">6.2.配置kube-controller-manager service（所有master节点）</a></li><li><ul><li><a href="#621_kubecontrollermanager_3821" rel="nofollow">6.2.1 启动kube-controller-manager，并查看状态</a></li></ul> 
   </li><li><a href="#63kubescheduler_servicemaster_3837" rel="nofollow">6.3.配置kube-scheduler service（所有master节点）</a></li><li><ul><li><a href="#631_master_3839" rel="nofollow">6.3.1 所有master节点配置，且配置相同</a></li><li><a href="#632__3890" rel="nofollow">6.3.2 启动并查看服务状态</a></li></ul> 
  </li></ul> 
  </li><li><a href="#7TLS_Bootstrapping_3906" rel="nofollow">7.TLS Bootstrapping配置</a></li><li><ul><li><a href="#71_master01_3908" rel="nofollow">7.1 在master01上配置</a></li><li><a href="#72_bootstrapsecretyaml_3966" rel="nofollow">7.2 编写bootstrap.secret.yaml</a></li><li><a href="#73__4060" rel="nofollow">7.3 查看集群状态，没问题的话继续后续操作</a></li></ul> 
  </li><li><a href="#8node_4074" rel="nofollow">8.node节点配置</a></li><li><ul><li><a href="#81master01_4076" rel="nofollow">8.1.在master01上将证书复制到其他节点</a></li><li><a href="#82kubelet_4084" rel="nofollow">8.2.kubelet配置</a></li><li><ul><li><a href="#821_dockerRuntime_4088" rel="nofollow">8.2.1 当使用docker作为Runtime（不推荐）</a></li><li><a href="#822_ContainerdRuntime__4131" rel="nofollow">8.2.2 当使用Containerd作为Runtime （推荐）</a></li><li><a href="#823_k8skubelet_4177" rel="nofollow">8.2.3 所有k8s节点创建kubelet的配置文件</a></li><li><a href="#824_kubelet_4324" rel="nofollow">8.2.4 启动kubelet</a></li><li><a href="#825__4342" rel="nofollow">8.2.5 查看集群</a></li><li><a href="#826__4357" rel="nofollow">8.2.6 查看容器运行时</a></li></ul> 
   </li><li><a href="#83kubeproxy_4379" rel="nofollow">8.3.kube-proxy配置</a></li><li><ul><li><a href="#831_kubeconfig_4381" rel="nofollow">8.3.1 将kubeconfig发送至其他节点</a></li><li><a href="#832_k8skubeproxyservice_4390" rel="nofollow">8.3.2 所有k8s节点添加kube-proxy的service文件</a></li><li><a href="#833_k8skubeproxy_4431" rel="nofollow">8.3.3 所有k8s节点添加kube-proxy的配置</a></li><li><a href="#834_kubeproxy_4586" rel="nofollow">8.3.4 启动kube-proxy</a></li></ul> 
  </li></ul> 
  </li><li><a href="#9_4604" rel="nofollow">9.安装网络插件</a></li><li><ul><li><a href="#90docker_4631" rel="nofollow">9.0安装docker</a></li><li><a href="#91Calico_4637" rel="nofollow">9.1安装Calico（推荐）</a></li><li><ul><li><a href="#tigeraoperatoryaml__4643" rel="nofollow">方法一：使用tigera-operator.yaml 方式安装(推荐)</a></li><li><ul><li><a href="#1tigeraoperatoryaml_4647" rel="nofollow">1.安装tigera-operator.yaml</a></li><li><a href="#2customeresourcesyaml_4653" rel="nofollow">2.下载custome-resources.yaml文件</a></li><li><a href="#3calico_4659" rel="nofollow">3.修改calico网段</a></li><li><a href="#4calico_4667" rel="nofollow">4.安装calico</a></li><li><a href="#5calicopod_4673" rel="nofollow">5.监听calico的所有pod是否安装完成</a></li></ul> 
    </li><li><a href="#calicoyaml_4697" rel="nofollow">方法二：使用calico.yaml方式安装</a></li><li><ul><li><a href="#1calico_4699" rel="nofollow">1.更改calico网段</a></li><li><a href="#2_4750" rel="nofollow">2.查看容器状态</a></li></ul> 
   </li></ul> 
   </li><li><a href="#92_cilium_4769" rel="nofollow">9.2 安装cilium（不推荐）</a></li><li><ul><li><a href="#921_helm_4771" rel="nofollow">9.2.1 安装helm</a></li><li><a href="#922_cilium_4783" rel="nofollow">9.2.2 安装cilium</a></li><li><a href="#923__4806" rel="nofollow">9.2.3 查看</a></li><li><a href="#924__4820" rel="nofollow">9.2.4 下载专属监控面板</a></li><li><a href="#925__4846" rel="nofollow">9.2.5 下载部署测试用例</a></li><li><a href="#926_pod_4859" rel="nofollow">9.2.6 查看pod</a></li><li><a href="#927_NodePort_4897" rel="nofollow">9.2.7 修改为NodePort</a></li><li><a href="#928__4915" rel="nofollow">9.2.8 查看端口</a></li><li><a href="#929__4932" rel="nofollow">9.2.9 访问</a></li></ul> 
  </li></ul> 
  </li><li><a href="#10CoreDNS_4942" rel="nofollow">10.安装CoreDNS</a></li><li><ul><li><a href="#101master01_4944" rel="nofollow">10.1以下步骤只在master01操作</a></li><li><ul><li><a href="#1011__4946" rel="nofollow">10.1.1 修改文件</a></li></ul> 
  </li></ul> 
  </li><li><a href="#11Metrics_Server_4986" rel="nofollow">11.安装Metrics Server</a></li><li><ul><li><a href="#111_master01_4988" rel="nofollow">11.1 以下步骤只在master01操作</a></li><li><ul><li><a href="#1111_Metricsserver_4990" rel="nofollow">11.1.1 安装Metrics-server</a></li><li><a href="#1112__5052" rel="nofollow">11.1.2 稍等片刻查看状态</a></li></ul> 
  </li></ul> 
  </li><li><a href="#12_5064" rel="nofollow">12.集群验证</a></li><li><ul><li><a href="#121_pod_5066" rel="nofollow">12.1 部署pod资源</a></li><li><a href="#122_podkubernetes_5094" rel="nofollow">12.2 用pod解析默认命名空间中的kubernetes</a></li><li><a href="#123__5113" rel="nofollow">12.3 测试跨命名空间是否可以解析</a></li><li><a href="#124_Kuberneteskubernetes_svc_443kubednsservice_53_5137" rel="nofollow">12.4 每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53</a></li><li><a href="#125_PodPod_5156" rel="nofollow">12.5 Pod和Pod之前要能通</a></li><li><a href="#126_3_5192" rel="nofollow">12.6 创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）</a></li></ul> 
  </li><li><a href="#13dashboard_5238" rel="nofollow">13.安装dashboard</a></li><li><ul><li><a href="#131dashboardsvcNodePort_5250" rel="nofollow">13.1更改dashboard的svc为NodePort，如果已是请忽略</a></li><li><a href="#132_ymldashboard_5271" rel="nofollow">13.2 修改yml中的dashboard镜像地址</a></li><li><a href="#133_dashboard_5284" rel="nofollow">13.3 应用启动dashboard</a></li><li><a href="#134__5296" rel="nofollow">13.4 查看端口号</a></li><li><a href="#135_token_5304" rel="nofollow">13.5 创建token</a></li><li><a href="#136_dashboard_5335" rel="nofollow">13.6 登录dashboard</a></li></ul> 
  </li><li><a href="#14ingressnginx_5344" rel="nofollow">14.ingress-nginx安装</a></li><li><ul><li><a href="#141__5350" rel="nofollow">14.1 执行部署</a></li><li><a href="#142_ingress_5555" rel="nofollow">14.2 过滤查看ingress端口</a></li></ul> 
  </li><li><a href="#15IPv6_5563" rel="nofollow">15.IPv6测试</a></li><li><a href="#16_5658" rel="nofollow">16.安装命令行自动补全功能</a></li><li><a href="#_5667" rel="nofollow">附录（可选）</a></li></ul> 
</div> 
<p></p> 
<h2><a id="Kubernetesk8sv1280_1"></a>二进制安装Kubernetes（k8s）v1.28.0</h2> 
<p>  二进制安装比较复杂，但是也比较稳定，适用于线上环境使用。</p> 
<p>  本笔记参考自：<a href="https://github.com/cby-chen/Kubernetes">https://github.com/cby-chen/Kubernetes</a> ，针对文中内容，有部分镜像无法拉取等，还有一部分有点小问题，自己有做一些小的提示、修改。建议参考本文安装即可。</p> 
<h2><a id="_6"></a>介绍</h2> 
<p>kubernetes（k8s）二进制高可用安装部署，支持IPv4+IPv6双栈。</p> 
<p>我使用IPV6的目的是在公网进行访问，所以我配置了IPV6静态地址。</p> 
<p>若您没有IPV6环境，或者不想使用IPv6，不对主机进行配置IPv6地址即可。</p> 
<p>不配置IPV6，不影响后续，不过集群依旧是支持IPv6的。为后期留有扩展可能性。</p> 
<p>若不要IPv6 ，不给网卡配置IPv6即可，不要对IPv6相关配置删除或操作，否则会出问题。</p> 
<p><font color="green"> 我安装的时候，未进行IPV6网络的配置，按照本文步骤可以正常完成 k8s 1.28 版本的安装，教程可正常使用。如有其他问题出现，请自行排查解决。我使用的版本是 CentOS 7.9</font></p> 
<h2><a id="1_20"></a>1.环境</h2> 
<table><thead><tr><th>主机名称</th><th>IP地址</th><th>说明</th><th>软件</th></tr></thead><tbody><tr><td></td><td>192.168.1.60</td><td>外网节点</td><td>下载各种所需安装包</td></tr><tr><td>Master01</td><td>192.168.0.31</td><td>master节点</td><td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br>kubelet、kube-proxy、nfs-client、haproxy、keepalived、nginx</td></tr><tr><td>Master02</td><td>192.168.0.32</td><td>master节点</td><td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br>kubelet、kube-proxy、nfs-client、haproxy、keepalived、nginx</td></tr><tr><td>Master03</td><td>192.168.0.33</td><td>master节点</td><td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br>kubelet、kube-proxy、nfs-client、haproxy、keepalived、nginx</td></tr><tr><td>Node01</td><td>192.168.0.34</td><td>node节点</td><td>kubelet、kube-proxy、nfs-client、nginx</td></tr><tr><td>Node02</td><td>192.168.0.35</td><td>node节点</td><td>kubelet、kube-proxy、nfs-client、nginx</td></tr><tr><td></td><td>192.168.0.36</td><td>VIP</td><td></td></tr></tbody></table> 
<p>网段</p> 
<blockquote> 
 <p>物理主机：192.168.0.0/24<br> service：10.96.0.0/12<br> pod：172.16.0.0/12</p> 
</blockquote> 
<p>Github博主的安装包：<a href="https://ghproxy.com/https://github.com/cby-chen/Kubernetes/releases/download/v1.28.0/kubernetes-v1.28.0.tar">https://ghproxy.com/https://github.com/cby-chen/Kubernetes/releases/download/v1.28.0/kubernetes-v1.28.0.tar</a></p> 
<p>我自己准备的安装包：<a href="https://pan.baidu.com/s/1qKe3Sj97WQI8gJp1Cx8Ipg?pwd=4wbd" rel="nofollow">https://pan.baidu.com/s/1qKe3Sj97WQI8gJp1Cx8Ipg?pwd=4wbd</a></p> 
<h3><a id="10_42"></a>1.0.环境准备</h3> 
<h4><a id="1Linuxeth0ens33ens33_44"></a>1.Linux网卡没有eth0显示ens33或者其它（以ens33为例）</h4> 
<h5><a id="_46"></a>方法一：修改网卡配置</h5> 
<blockquote> 
 <p>1.使用命令 <strong>ip addr</strong> 查看 linux 是否有 eth0 网卡</p> 
 <p>2.<strong>vi /etc/sysconfig/network-scripts/ifcfg-ens33</strong> 将里面的 <strong>NAME</strong> 和 <strong>DEVICE</strong> 项修改为 eth0，<strong>ONBOOT</strong>需修改为yes</p> 
 <p>3.重命名网卡名称</p> 
 <p><strong>cd /etc/sysconfig/network-scripts/</strong></p> 
 <p><strong>mv ifcfg-ens33 ifcfg-eth0</strong></p> 
 <p>4.编辑 <strong>/etc/default/grub</strong>，加入net.ifnames=0 biosdevname=0 到 GRUB_CMALINE_LINUX 变量中（注意空格别遗漏）</p> 
 <p>5.执行命令： <em><strong>grub2-mkconfig -o /boot/grub2/grub.cfg</strong></em> ，重新生成GRUB配置并更新内核参数</p> 
 <p>6.执行命令：<strong>reboot</strong> 重启系统</p> 
 <p>7.使用命令 <strong>ip addr</strong> 查看 eth0 网卡是否已经变更成功</p> 
</blockquote> 
<h5><a id="_66"></a>方法二：重新安装机器(本文为虚拟机)</h5> 
<blockquote> 
 <p>安装系统时，直接指定网卡名为 eth0<br>  <br> <img src="https://images2.imgbox.com/a5/4a/1H6VkBFM_o.png" alt="请添加图片描述"><br>  <br> 进入安装界面的时候，选中第一个 Install CentOS 7。按下 Tab 键。敲空格让光标回到第二行。</p> 
 <p>输入 net.ifnames=0 空格 biosdevname=0 然后按回车就行。 （中间要有空格哦！）</p> 
</blockquote> 
<h4><a id="2UUIDk8sUUID_76"></a>2.克隆的虚拟机，修改UUID，保证k8s集群每台机器UUID唯一</h4> 
<p>在每一台节点上执行如下操作：</p> 
<blockquote> 
 <p>1.执行命令 <strong>uuidgen eth0</strong> 生成一个 UUID</p> 
 <p>2.执行命令 <strong>vi /etc/sysconfig/network-scripts/ifcfg-eth0</strong> ，将UUID修改为新生成的</p> 
 <p>3.执行命令 <strong>service network restart</strong>，重启网络</p> 
 <p>4.执行命令 <strong>nmcli con show</strong>，查看UUID是否配置生效</p> 
</blockquote> 
<h3><a id="11k8s_88"></a>1.1.k8s基础系统环境配置</h3> 
<blockquote> 
 <p><font color="red">1.1 步骤中的17步操作，均在所有节点执行</font></p> 
</blockquote> 
<h4><a id="1IP_92"></a>1.配置IP</h4> 
<blockquote> 
 <p>根据自身情况设定，IP/UUID/eth0设定没问题了的话，此步可忽略</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 注意！</span>
<span class="token comment"># 若虚拟机是进行克隆的那么网卡的UUID会重复</span>
<span class="token comment"># 若UUID重复需要重新生成新的UUID</span>
<span class="token comment"># UUID重复无法获取到IPV6地址</span>
<span class="token comment"># </span>
<span class="token comment"># 查看当前的网卡列表和 UUID：</span>
<span class="token comment"># nmcli con show</span>
<span class="token comment"># 删除要更改 UUID 的网络连接：</span>
<span class="token comment"># nmcli con delete uuid &lt;原 UUID&gt;</span>
<span class="token comment"># 重新生成 UUID：</span>
<span class="token comment"># nmcli con add type ethernet ifname &lt;接口名称&gt; con-name &lt;新名称&gt;</span>
<span class="token comment"># 重新启用网络连接：</span>
<span class="token comment"># nmcli con up &lt;新名称&gt;</span>

<span class="token comment"># 更改网卡的UUID</span>
<span class="token function">ssh</span> root@192.168.0.31 <span class="token string">"nmcli con delete uuid 708a1497-2192-43a5-9f03-2ab936fb3c44;nmcli con add type ethernet ifname eth0 con-name eth0;nmcli con up eth0"</span>
<span class="token function">ssh</span> root@192.168.0.32 <span class="token string">"nmcli con delete uuid 708a1497-2192-43a5-9f03-2ab936fb3c44;nmcli con add type ethernet ifname eth0 con-name eth0;nmcli con up eth0"</span>
<span class="token function">ssh</span> root@192.168.0.33 <span class="token string">"nmcli con delete uuid 708a1497-2192-43a5-9f03-2ab936fb3c44;nmcli con add type ethernet ifname eth0 con-name eth0;nmcli con up eth0"</span>
<span class="token function">ssh</span> root@192.168.0.34 <span class="token string">"nmcli con delete uuid 708a1497-2192-43a5-9f03-2ab936fb3c44;nmcli con add type ethernet ifname eth0 con-name eth0;nmcli con up eth0"</span>
<span class="token function">ssh</span> root@192.168.0.35 <span class="token string">"nmcli con delete uuid 708a1497-2192-43a5-9f03-2ab936fb3c44;nmcli con add type ethernet ifname eth0 con-name eth0;nmcli con up eth0"</span>

<span class="token comment"># 参数解释</span>
<span class="token comment"># </span>
<span class="token comment"># ssh ssh root@192.168.0.31</span>
<span class="token comment"># 使用SSH登录到IP为192.168.0.31的主机，使用root用户身份。</span>
<span class="token comment"># </span>
<span class="token comment"># nmcli con delete uuid 708a1497-2192-43a5-9f03-2ab936fb3c44</span>
<span class="token comment"># 删除 UUID 为 708a1497-2192-43a5-9f03-2ab936fb3c44 的网络连接，这是 NetworkManager 中一种特定网络配置的唯一标识符。</span>
<span class="token comment"># </span>
<span class="token comment"># nmcli con add type ethernet ifname eth0 con-name eth0</span>
<span class="token comment"># 添加一种以太网连接类型，并指定接口名为 eth0，连接名称也为 eth0。</span>
<span class="token comment"># </span>
<span class="token comment"># nmcli con up eth0</span>
<span class="token comment"># 开启 eth0 这个网络连接。</span>
<span class="token comment"># </span>
<span class="token comment"># 简单来说，这个命令的作用是删除一个特定的网络连接配置，并添加一个名为 eth0 的以太网连接，然后启用这个新的连接。</span>

<span class="token comment"># 修改静态的IPv4地址</span>
<span class="token function">ssh</span> root@192.168.0.31 <span class="token string">"nmcli con mod eth0 ipv4.addresses 192.168.0.31/24; nmcli con mod eth0 ipv4.gateway  192.168.0.1; nmcli con mod eth0 ipv4.method manual; nmcli con mod eth0 ipv4.dns "</span><span class="token number">8.8</span>.8.8<span class="token string">"; nmcli con up eth0"</span>
<span class="token function">ssh</span> root@192.168.0.32 <span class="token string">"nmcli con mod eth0 ipv4.addresses 192.168.0.32/24; nmcli con mod eth0 ipv4.gateway  192.168.0.1; nmcli con mod eth0 ipv4.method manual; nmcli con mod eth0 ipv4.dns "</span><span class="token number">8.8</span>.8.8<span class="token string">"; nmcli con up eth0"</span>
<span class="token function">ssh</span> root@192.168.0.33 <span class="token string">"nmcli con mod eth0 ipv4.addresses 192.168.0.33/24; nmcli con mod eth0 ipv4.gateway  192.168.0.1; nmcli con mod eth0 ipv4.method manual; nmcli con mod eth0 ipv4.dns "</span><span class="token number">8.8</span>.8.8<span class="token string">"; nmcli con up eth0"</span>
<span class="token function">ssh</span> root@192.168.0.34 <span class="token string">"nmcli con mod eth0 ipv4.addresses 192.168.0.34/24; nmcli con mod eth0 ipv4.gateway  192.168.0.1; nmcli con mod eth0 ipv4.method manual; nmcli con mod eth0 ipv4.dns "</span><span class="token number">8.8</span>.8.8<span class="token string">"; nmcli con up eth0"</span>
<span class="token function">ssh</span> root@192.168.0.35 <span class="token string">"nmcli con mod eth0 ipv4.addresses 192.168.0.35/24; nmcli con mod eth0 ipv4.gateway  192.168.0.1; nmcli con mod eth0 ipv4.method manual; nmcli con mod eth0 ipv4.dns "</span><span class="token number">8.8</span>.8.8<span class="token string">"; nmcli con up eth0"</span>

<span class="token comment"># 参数解释</span>
<span class="token comment"># </span>
<span class="token comment"># ssh root@192.168.0.154</span>
<span class="token comment"># 使用SSH登录到IP为192.168.0.154的主机，使用root用户身份。</span>
<span class="token comment"># </span>
<span class="token comment"># "nmcli con mod eth0 ipv4.addresses 192.168.0.31/24"</span>
<span class="token comment"># 修改eth0网络连接的IPv4地址为192.168.0.31，子网掩码为 24。</span>
<span class="token comment"># </span>
<span class="token comment"># "nmcli con mod eth0 ipv4.gateway 192.168.0.1"</span>
<span class="token comment"># 修改eth0网络连接的IPv4网关为192.168.0.1。</span>
<span class="token comment"># </span>
<span class="token comment"># "nmcli con mod eth0 ipv4.method manual"</span>
<span class="token comment"># 将eth0网络连接的IPv4配置方法设置为手动。</span>
<span class="token comment"># </span>
<span class="token comment"># "nmcli con mod eth0 ipv4.dns "8.8.8.8"</span>
<span class="token comment"># 将eth0网络连接的IPv4 DNS服务器设置为 8.8.8.8。</span>
<span class="token comment"># </span>
<span class="token comment"># "nmcli con up eth0"</span>
<span class="token comment"># 启动eth0网络连接。</span>
<span class="token comment"># </span>
<span class="token comment"># 总体来说，这条命令是通过SSH远程登录到指定的主机，并使用网络管理命令 (nmcli) 修改eth0网络连接的配置，包括IP地址、网关、配置方法和DNS服务器，并启动该网络连接。</span>

<span class="token comment"># 没有IPv6选择不配置即可</span>
<span class="token function">ssh</span> root@192.168.0.31 <span class="token string">"nmcli con mod eth0 ipv6.addresses fc00:43f4:1eea:1::10; nmcli con mod eth0 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod eth0 ipv6.method manual; nmcli con mod eth0 ipv6.dns "</span><span class="token number">2400</span>:3200::1<span class="token string">"; nmcli con up eth0"</span>
<span class="token function">ssh</span> root@192.168.0.32 <span class="token string">"nmcli con mod eth0 ipv6.addresses fc00:43f4:1eea:1::20; nmcli con mod eth0 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod eth0 ipv6.method manual; nmcli con mod eth0 ipv6.dns "</span><span class="token number">2400</span>:3200::1<span class="token string">"; nmcli con up eth0"</span>
<span class="token function">ssh</span> root@192.168.0.33 <span class="token string">"nmcli con mod eth0 ipv6.addresses fc00:43f4:1eea:1::30; nmcli con mod eth0 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod eth0 ipv6.method manual; nmcli con mod eth0 ipv6.dns "</span><span class="token number">2400</span>:3200::1<span class="token string">"; nmcli con up eth0"</span>
<span class="token function">ssh</span> root@192.168.0.34 <span class="token string">"nmcli con mod eth0 ipv6.addresses fc00:43f4:1eea:1::40; nmcli con mod eth0 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod eth0 ipv6.method manual; nmcli con mod eth0 ipv6.dns "</span><span class="token number">2400</span>:3200::1<span class="token string">"; nmcli con up eth0"</span>
<span class="token function">ssh</span> root@192.168.0.35 <span class="token string">"nmcli con mod eth0 ipv6.addresses fc00:43f4:1eea:1::50; nmcli con mod eth0 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod eth0 ipv6.method manual; nmcli con mod eth0 ipv6.dns "</span><span class="token number">2400</span>:3200::1<span class="token string">"; nmcli con up eth0"</span>

<span class="token comment"># 参数解释</span>
<span class="token comment"># </span>
<span class="token comment"># ssh root@192.168.0.31</span>
<span class="token comment"># 通过SSH连接到IP地址为192.168.0.31的远程主机，使用root用户进行登录。</span>
<span class="token comment"># </span>
<span class="token comment"># "nmcli con mod eth0 ipv6.addresses fc00:43f4:1eea:1::10"</span>
<span class="token comment"># 使用nmcli命令修改eth0接口的IPv6地址为fc00:43f4:1eea:1::10。</span>
<span class="token comment"># </span>
<span class="token comment"># "nmcli con mod eth0 ipv6.gateway fc00:43f4:1eea:1::1"</span>
<span class="token comment"># 使用nmcli命令修改eth0接口的IPv6网关为fc00:43f4:1eea:1::1。</span>
<span class="token comment"># </span>
<span class="token comment"># "nmcli con mod eth0 ipv6.method manual"</span>
<span class="token comment"># 使用nmcli命令将eth0接口的IPv6配置方法修改为手动配置。</span>
<span class="token comment"># </span>
<span class="token comment"># "nmcli con mod eth0 ipv6.dns "2400:3200::1"</span>
<span class="token comment"># 使用nmcli命令设置eth0接口的IPv6 DNS服务器为2400:3200::1。</span>
<span class="token comment"># </span>
<span class="token comment"># "nmcli con up eth0"</span>
<span class="token comment"># 使用nmcli命令启动eth0接口。</span>
<span class="token comment"># </span>
<span class="token comment"># 这个命令的目的是在远程主机上配置eth0接口的IPv6地址、网关、配置方法和DNS服务器，并启动eth0接口。</span>


<span class="token comment"># 查看网卡配置</span>
<span class="token comment"># nmcli device show eth0</span>
<span class="token comment"># nmcli con show eth0</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span>
<span class="token assign-left variable">TYPE</span><span class="token operator">=</span>Ethernet
<span class="token assign-left variable">PROXY_METHOD</span><span class="token operator">=</span>none
<span class="token assign-left variable">BROWSER_ONLY</span><span class="token operator">=</span>no
<span class="token assign-left variable">BOOTPROTO</span><span class="token operator">=</span>none
<span class="token assign-left variable">DEFROUTE</span><span class="token operator">=</span>yes
<span class="token assign-left variable">IPV4_FAILURE_FATAL</span><span class="token operator">=</span>no
<span class="token assign-left variable">IPV6INIT</span><span class="token operator">=</span>yes
<span class="token assign-left variable">IPV6_AUTOCONF</span><span class="token operator">=</span>no
<span class="token assign-left variable">IPV6_DEFROUTE</span><span class="token operator">=</span>yes
<span class="token assign-left variable">IPV6_FAILURE_FATAL</span><span class="token operator">=</span>no
<span class="token assign-left variable">IPV6_ADDR_GEN_MODE</span><span class="token operator">=</span>stable-privacy
<span class="token assign-left variable">NAME</span><span class="token operator">=</span>eth0
<span class="token assign-left variable">UUID</span><span class="token operator">=</span>424fd260-c480-4899-97e6-6fc9722031e8
<span class="token assign-left variable">DEVICE</span><span class="token operator">=</span>eth0
<span class="token assign-left variable">ONBOOT</span><span class="token operator">=</span>yes
<span class="token assign-left variable">IPADDR</span><span class="token operator">=</span><span class="token number">192.168</span>.0.31
<span class="token assign-left variable">PREFIX</span><span class="token operator">=</span><span class="token number">24</span>
<span class="token assign-left variable">GATEWAY</span><span class="token operator">=</span><span class="token number">192.168</span>.8.1
<span class="token assign-left variable">DNS1</span><span class="token operator">=</span><span class="token number">8.8</span>.8.8
<span class="token assign-left variable">IPV6ADDR</span><span class="token operator">=</span>fc00:43f4:1eea:1::10/128
<span class="token assign-left variable">IPV6_DEFAULTGW</span><span class="token operator">=</span>fc00:43f4:1eea:1::1
<span class="token assign-left variable">DNS2</span><span class="token operator">=</span><span class="token number">2400</span>:3200::1
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># </span>



<span class="token comment"># 参数解释</span>
<span class="token comment"># </span>
<span class="token comment"># TYPE=Ethernet</span>
<span class="token comment"># 指定连接类型为以太网。</span>
<span class="token comment"># </span>
<span class="token comment"># PROXY_METHOD=none</span>
<span class="token comment"># 指定不使用代理方法。</span>
<span class="token comment"># </span>
<span class="token comment"># BROWSER_ONLY=no</span>
<span class="token comment"># 指定不仅仅在浏览器中使用代理。</span>
<span class="token comment"># </span>
<span class="token comment"># BOOTPROTO=none</span>
<span class="token comment"># 指定自动分配地址的方式为无（即手动配置IP地址）。</span>
<span class="token comment"># </span>
<span class="token comment"># DEFROUTE=yes</span>
<span class="token comment"># 指定默认路由开启。</span>
<span class="token comment"># </span>
<span class="token comment"># IPV4_FAILURE_FATAL=no</span>
<span class="token comment"># 指定IPv4连接失败时不宣告严重错误。</span>
<span class="token comment"># </span>
<span class="token comment"># IPV6INIT=yes</span>
<span class="token comment"># 指定启用IPv6。</span>
<span class="token comment"># </span>
<span class="token comment"># IPV6_AUTOCONF=no</span>
<span class="token comment"># 指定不自动配置IPv6地址。</span>
<span class="token comment"># </span>
<span class="token comment"># IPV6_DEFROUTE=yes</span>
<span class="token comment"># 指定默认IPv6路由开启。</span>
<span class="token comment"># </span>
<span class="token comment"># IPV6_FAILURE_FATAL=no</span>
<span class="token comment"># 指定IPv6连接失败时不宣告严重错误。</span>
<span class="token comment"># </span>
<span class="token comment"># IPV6_ADDR_GEN_MODE=stable-privacy</span>
<span class="token comment"># 指定IPv6地址生成模式为稳定隐私模式。</span>
<span class="token comment"># </span>
<span class="token comment"># NAME=eth0</span>
<span class="token comment"># 指定设备名称为eth0。</span>
<span class="token comment"># </span>
<span class="token comment"># UUID=424fd260-c480-4899-97e6-6fc9722031e8</span>
<span class="token comment"># 指定设备的唯一标识符。</span>
<span class="token comment"># </span>
<span class="token comment"># DEVICE=eth0</span>
<span class="token comment"># 指定设备名称为eth0。</span>
<span class="token comment"># </span>
<span class="token comment"># ONBOOT=yes</span>
<span class="token comment"># 指定开机自动启用这个连接。</span>
<span class="token comment"># </span>
<span class="token comment"># IPADDR=192.168.0.31</span>
<span class="token comment"># 指定IPv4地址为192.168.0.31。</span>
<span class="token comment"># </span>
<span class="token comment"># PREFIX=24</span>
<span class="token comment"># 指定IPv4地址的子网掩码为24。</span>
<span class="token comment"># </span>
<span class="token comment"># GATEWAY=192.168.8.1</span>
<span class="token comment"># 指定IPv4的网关地址为192.168.8.1。</span>
<span class="token comment"># </span>
<span class="token comment"># DNS1=8.8.8.8</span>
<span class="token comment"># 指定首选DNS服务器为8.8.8.8。</span>
<span class="token comment"># </span>
<span class="token comment"># IPV6ADDR=fc00:43f4:1eea:1::10/128</span>
<span class="token comment"># 指定IPv6地址为fc00:43f4:1eea:1::10，子网掩码为128。</span>
<span class="token comment"># </span>
<span class="token comment"># IPV6_DEFAULTGW=fc00:43f4:1eea:1::1</span>
<span class="token comment"># 指定IPv6的默认网关地址为fc00:43f4:1eea:1::1。</span>
<span class="token comment"># </span>
<span class="token comment"># DNS2=2400:3200::1</span>
<span class="token comment"># 指定备用DNS服务器为2400:3200::1。</span>
</code></pre> 
<h4><a id="2_292"></a>2.设置主机名</h4> 
<pre><code class="prism language-shell">hostnamectl set-hostname k8s-master01
hostnamectl set-hostname k8s-master02
hostnamectl set-hostname k8s-master03
hostnamectl set-hostname k8s-node01
hostnamectl set-hostname k8s-node02

<span class="token comment"># 参数解释</span>
<span class="token comment"># </span>
<span class="token comment"># 参数: set-hostname</span>
<span class="token comment"># 解释: 这是hostnamectl命令的一个参数，用于设置系统的主机名。</span>
<span class="token comment"># </span>
<span class="token comment"># 参数: k8s-master01</span>
<span class="token comment"># 解释: 这是要设置的主机名，将系统的主机名设置为"k8s-master01"。</span>
</code></pre> 
<h4><a id="3yum_311"></a>3.配置yum源</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 其他系统的源地址</span>
<span class="token comment"># https://mirrors.tuna.tsinghua.edu.cn/help/</span>

<span class="token comment"># 对于 Ubuntu</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/cn.archive.ubuntu.com/mirrors.ustc.edu.cn/g'</span> /etc/apt/sources.list

<span class="token comment"># 对于 CentOS 7</span>
<span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-e</span> <span class="token string">'s|^#baseurl=http://mirror.centos.org/centos|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-i.bak</span> <span class="token punctuation">\</span>
         /etc/yum.repos.d/CentOS-*.repo

<span class="token comment"># 对于 CentOS 8</span>
<span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-e</span> <span class="token string">'s|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos|g'</span> <span class="token punctuation">\</span>
         <span class="token parameter variable">-i.bak</span> <span class="token punctuation">\</span>
         /etc/yum.repos.d/CentOS-*.repo

<span class="token comment"># 对于私有仓库</span>
<span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^#baseurl=http://mirror.centos.org/\$contentdir|baseurl=http://192.168.1.123/centos|g'</span> <span class="token parameter variable">-i.bak</span>  /etc/yum.repos.d/CentOS-*.repo

<span class="token comment"># 参数解释</span>
<span class="token comment"># </span>
<span class="token comment"># 以上命令是用于更改系统软件源的配置，以便从国内镜像站点下载软件包和更新。</span>
<span class="token comment"># </span>
<span class="token comment"># 对于 Ubuntu 系统，将 /etc/apt/sources.list 文件中的软件源地址 cn.archive.ubuntu.com 替换为 mirrors.ustc.edu.cn。</span>
<span class="token comment"># </span>
<span class="token comment"># 对于 CentOS 7 系统，将 /etc/yum.repos.d/CentOS-*.repo 文件中的 mirrorlist 注释掉，并将 baseurl 的值替换为 https://mirrors.tuna.tsinghua.edu.cn/centos。</span>
<span class="token comment"># </span>
<span class="token comment"># 对于 CentOS 8 系统，同样将 /etc/yum.repos.d/CentOS-*.repo 文件中的 mirrorlist 注释掉，并将 baseurl 的值替换为 https://mirrors.tuna.tsinghua.edu.cn/centos。</span>
<span class="token comment"># </span>
<span class="token comment"># 对于私有仓库，将 /etc/yum.repos.d/CentOS-*.repo 文件中的 mirrorlist 注释掉，并将 baseurl 的值替换为私有仓库地址 http://192.168.1.123/centos。</span>
<span class="token comment"># </span>
<span class="token comment"># 这些命令通过使用 sed 工具和正则表达式，对相应的配置文件进行批量的替换操作，从而更改系统软件源配置。</span>
</code></pre> 
<h4><a id="4_350"></a>4.安装一些必备工具</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 对于 Ubuntu</span>
<span class="token function">apt</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt</span> upgrade <span class="token parameter variable">-y</span> <span class="token operator">&amp;&amp;</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token function">wget</span> psmisc <span class="token function">vim</span> net-tools nfs-kernel-server telnet lvm2 <span class="token function">git</span> <span class="token function">tar</span> <span class="token function">curl</span>

<span class="token comment"># 对于 CentOS 7</span>
yum update <span class="token parameter variable">-y</span> <span class="token operator">&amp;&amp;</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span>  <span class="token function">wget</span> psmisc <span class="token function">vim</span> net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> <span class="token function">tar</span> <span class="token function">curl</span>

<span class="token comment"># 对于 CentOS 8</span>
yum update <span class="token parameter variable">-y</span> <span class="token operator">&amp;&amp;</span> yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">wget</span> psmisc <span class="token function">vim</span> net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> network-scripts <span class="token function">tar</span> <span class="token function">curl</span>
</code></pre> 
<h5><a id="41__363"></a>4.1 下载离线所需文件(可选)</h5> 
<p>在互联网服务器上安装一个一模一样的系统进行下载所需包</p> 
<h6><a id="CentOS7_367"></a>CentOS7</h6> 
<pre><code class="prism language-shell"><span class="token comment"># 下载必要工具</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> createrepo yum-utils <span class="token function">wget</span> epel*

<span class="token comment"># 下载全量依赖包</span>
repotrack createrepo <span class="token function">wget</span> psmisc <span class="token function">vim</span> net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> <span class="token function">tar</span> <span class="token function">curl</span> gcc keepalived haproxy bash-completion chrony sshpass ipvsadm ipset sysstat conntrack libseccomp

<span class="token comment"># 删除libseccomp</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> libseccomp-*.rpm

<span class="token comment"># 下载libseccomp</span>
<span class="token function">wget</span> http://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm

<span class="token comment"># 创建yum源信息</span>
createrepo <span class="token parameter variable">-u</span> <span class="token parameter variable">-d</span> /data/centos7/

<span class="token comment"># 拷贝包到内网机器上</span>
<span class="token function">scp</span> <span class="token parameter variable">-r</span> /data/centos7/ root@192.168.0.31:
<span class="token function">scp</span> <span class="token parameter variable">-r</span> /data/centos7/ root@192.168.0.32:
<span class="token function">scp</span> <span class="token parameter variable">-r</span> /data/centos7/ root@192.168.0.33:
<span class="token function">scp</span> <span class="token parameter variable">-r</span> /data/centos7/ root@192.168.0.34:
<span class="token function">scp</span> <span class="token parameter variable">-r</span> /data/centos7/ root@192.168.0.35:

<span class="token comment"># 在内网机器上创建repo配置文件</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /etc/yum.repos.d/*
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/yum.repos.d/123.repo  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
[cby]
name=CentOS-<span class="token variable">$releasever</span> - Media
baseurl=file:///root/centos7/
gpgcheck=0
enabled=1
EOF</span>

<span class="token comment"># 安装下载好的包</span>
yum clean all
yum makecache
yum <span class="token function">install</span> /root/centos7/* --skip-broken <span class="token parameter variable">-y</span>

<span class="token comment">#### 备注 #####</span>
<span class="token comment"># 安装完成后，可能还会出现yum无法使用那么再次执行</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /etc/yum.repos.d/*
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/yum.repos.d/123.repo  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
[cby]
name=CentOS-<span class="token variable">$releasever</span> - Media
baseurl=file:///root/centos7/
gpgcheck=0
enabled=1
EOF</span>
yum clean all
yum makecache
yum <span class="token function">install</span> /root/centos7/* --skip-broken <span class="token parameter variable">-y</span>

<span class="token comment">#### 备注 #####</span>
<span class="token comment"># 安装 chrony 和 libseccomp</span>
<span class="token comment"># yum install /root/centos7/libseccomp-2.5.1*.rpm -y</span>
<span class="token comment"># yum install /root/centos7/chrony-*.rpm -y</span>
</code></pre> 
<h6><a id="CentOS8_425"></a>CentOS8</h6> 
<pre><code class="prism language-shell"><span class="token comment"># 下载必要工具</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> createrepo yum-utils <span class="token function">wget</span> epel*

<span class="token comment"># 下载全量依赖包</span>
repotrack <span class="token function">wget</span> psmisc <span class="token function">vim</span> net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> network-scripts <span class="token function">tar</span> <span class="token function">curl</span> gcc keepalived haproxy bash-completion chrony sshpass ipvsadm ipset sysstat conntrack libseccomp

<span class="token comment"># 创建yum源信息</span>
createrepo <span class="token parameter variable">-u</span> <span class="token parameter variable">-d</span> /data/centos8/

<span class="token comment"># 拷贝包到内网机器上</span>
<span class="token function">scp</span> <span class="token parameter variable">-r</span> centos8/ root@192.168.0.31:
<span class="token function">scp</span> <span class="token parameter variable">-r</span> centos8/ root@192.168.0.32:
<span class="token function">scp</span> <span class="token parameter variable">-r</span> centos8/ root@192.168.0.33:
<span class="token function">scp</span> <span class="token parameter variable">-r</span> centos8/ root@192.168.0.34:
<span class="token function">scp</span> <span class="token parameter variable">-r</span> centos8/ root@192.168.0.35:

<span class="token comment"># 在内网机器上创建repo配置文件</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /etc/yum.repos.d/*
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/yum.repos.d/123.repo  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
[cby]
name=CentOS-<span class="token variable">$releasever</span> - Media
baseurl=file:///root/centos8/
gpgcheck=0
enabled=1
EOF</span>

<span class="token comment"># 安装下载好的包</span>
yum clean all
yum makecache
yum <span class="token function">install</span> /root/centos8/* --skip-broken <span class="token parameter variable">-y</span>

<span class="token comment">#### 备注 #####</span>
<span class="token comment"># 安装完成后，可能还会出现yum无法使用那么再次执行</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /etc/yum.repos.d/*
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/yum.repos.d/123.repo  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
[cby]
name=CentOS-<span class="token variable">$releasever</span> - Media
baseurl=file:///root/centos8/
gpgcheck=0
enabled=1
EOF</span>

yum clean all
yum makecache
yum <span class="token function">install</span> /root/centos8/* --skip-broken <span class="token parameter variable">-y</span>
</code></pre> 
<h6><a id="Ubuntu__474"></a>Ubuntu 下载包和依赖</h6> 
<pre><code class="prism language-shell"><span class="token shebang important">#!/bin/bash</span>

<span class="token assign-left variable">logfile</span><span class="token operator">=</span><span class="token number">123</span>.log
<span class="token assign-left variable">ret</span><span class="token operator">=</span><span class="token string">""</span>
<span class="token keyword">function</span> <span class="token function-name function">getDepends</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token builtin class-name">echo</span> <span class="token string">"fileName is"</span> <span class="token variable">$1</span><span class="token operator">&gt;&gt;</span><span class="token variable">$logfile</span>
   <span class="token comment"># use tr to del &lt; &gt;</span>
   <span class="token assign-left variable">ret</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">apt-cache</span> depends $1<span class="token operator">|</span><span class="token function">grep</span> Depends <span class="token operator">|</span><span class="token function">cut</span> -d: <span class="token parameter variable">-f2</span> <span class="token operator">|</span><span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">"&lt;&gt;"</span><span class="token variable">`</span></span>
   <span class="token builtin class-name">echo</span> <span class="token variable">$ret</span><span class="token operator">|</span><span class="token function">tee</span>  <span class="token parameter variable">-a</span> <span class="token variable">$logfile</span>
<span class="token punctuation">}</span>
<span class="token comment"># 需要获取其所依赖包的包</span>
<span class="token assign-left variable">libs</span><span class="token operator">=</span><span class="token string">"wget psmisc vim net-tools nfs-kernel-server telnet lvm2 git tar curl gcc keepalived haproxy bash-completion chrony sshpass ipvsadm ipset sysstat conntrack libseccomp"</span>

<span class="token comment"># download libs dependen. deep in 3</span>
<span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$i</span> <span class="token parameter variable">-lt</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span>
<span class="token keyword">do</span>
    <span class="token builtin class-name">let</span> i++
    <span class="token builtin class-name">echo</span> <span class="token variable">$i</span>
    <span class="token comment"># download libs</span>
    <span class="token assign-left variable">newlist</span><span class="token operator">=</span><span class="token string">" "</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">j</span> <span class="token keyword">in</span> <span class="token variable">$libs</span>
    <span class="token keyword">do</span>
        <span class="token assign-left variable">added</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>getDepends $j<span class="token variable">)</span></span>"</span>
        <span class="token assign-left variable">newlist</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$newlist</span> <span class="token variable">$added</span>"</span>
        <span class="token function">apt</span> <span class="token function">install</span> <span class="token variable">$added</span> <span class="token parameter variable">--reinstall</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-y</span>
    <span class="token keyword">done</span>

    <span class="token assign-left variable">libs</span><span class="token operator">=</span><span class="token variable">$newlist</span>
<span class="token keyword">done</span>

<span class="token comment"># 创建源信息</span>
<span class="token function">apt</span> <span class="token function">install</span> dpkg-dev
<span class="token function">sudo</span> <span class="token function">cp</span> /var/cache/apt/archives/*.deb /data/ubuntu/ <span class="token parameter variable">-r</span>
dpkg-scanpackages <span class="token builtin class-name">.</span> /dev/null <span class="token operator">|</span><span class="token function">gzip</span> <span class="token operator">&gt;</span> /data/ubuntu/Packages.gz <span class="token parameter variable">-r</span>

<span class="token comment"># 拷贝包到内网机器上</span>
<span class="token function">scp</span> <span class="token parameter variable">-r</span> ubuntu/ root@192.168.0.31:
<span class="token function">scp</span> <span class="token parameter variable">-r</span> ubuntu/ root@192.168.0.32:
<span class="token function">scp</span> <span class="token parameter variable">-r</span> ubuntu/ root@192.168.0.33:
<span class="token function">scp</span> <span class="token parameter variable">-r</span> ubuntu/ root@192.168.0.34:
<span class="token function">scp</span> <span class="token parameter variable">-r</span> ubuntu/ root@192.168.0.35:

<span class="token comment"># 在内网机器上配置apt源</span>
<span class="token function">vim</span> /etc/apt/sources.list
<span class="token function">cat</span> /etc/apt/sources.list
deb file:root/ ubuntu/

<span class="token comment"># 安装deb包</span>
<span class="token function">apt</span> <span class="token function">install</span> ./*.deb

</code></pre> 
<h4><a id="5_531"></a>5.选择性下载需要工具(可选)</h4> 
<pre><code class="prism language-shell"><span class="token shebang important">#!/bin/bash</span>

<span class="token comment"># 查看版本地址：</span>
<span class="token comment"># </span>
<span class="token comment"># https://github.com/containernetworking/plugins/releases/</span>
<span class="token comment"># https://github.com/containerd/containerd/releases/</span>
<span class="token comment"># https://github.com/kubernetes-sigs/cri-tools/releases/</span>
<span class="token comment"># https://github.com/Mirantis/cri-dockerd/releases/</span>
<span class="token comment"># https://github.com/etcd-io/etcd/releases/</span>
<span class="token comment"># https://github.com/cloudflare/cfssl/releases/</span>
<span class="token comment"># https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG</span>
<span class="token comment"># https://download.docker.com/linux/static/stable/x86_64/</span>
<span class="token comment"># https://github.com/opencontainers/runc/releases/</span>
<span class="token comment"># https://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/</span>
<span class="token comment"># https://github.com/helm/helm/tags</span>
<span class="token comment"># http://nginx.org/download/</span>

<span class="token comment"># Version numbers</span>
<span class="token assign-left variable">cni_plugins_version</span><span class="token operator">=</span><span class="token string">'v1.3.0'</span>
<span class="token assign-left variable">cri_containerd_cni_version</span><span class="token operator">=</span><span class="token string">'1.7.3'</span>
<span class="token assign-left variable">crictl_version</span><span class="token operator">=</span><span class="token string">'v1.28.0'</span>
<span class="token assign-left variable">cri_dockerd_version</span><span class="token operator">=</span><span class="token string">'0.3.4'</span>
<span class="token assign-left variable">etcd_version</span><span class="token operator">=</span><span class="token string">'v3.5.9'</span>
<span class="token assign-left variable">cfssl_version</span><span class="token operator">=</span><span class="token string">'1.6.4'</span>
<span class="token assign-left variable">kubernetes_server_version</span><span class="token operator">=</span><span class="token string">'1.28.0'</span>
<span class="token assign-left variable">docker_version</span><span class="token operator">=</span><span class="token string">'24.0.5'</span>
<span class="token assign-left variable">runc_version</span><span class="token operator">=</span><span class="token string">'1.1.9'</span>
<span class="token assign-left variable">kernel_version</span><span class="token operator">=</span><span class="token string">'5.4.254'</span>
<span class="token assign-left variable">helm_version</span><span class="token operator">=</span><span class="token string">'3.12.3'</span>
<span class="token assign-left variable">nginx_version</span><span class="token operator">=</span><span class="token string">'1.25.2'</span>

<span class="token comment"># URLs </span>
<span class="token assign-left variable">base_url</span><span class="token operator">=</span><span class="token string">'https://ghproxy.com/https://github.com'</span>
<span class="token assign-left variable">kernel_url</span><span class="token operator">=</span><span class="token string">"http://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/kernel-lt-<span class="token variable">${kernel_version}</span>-1.el7.elrepo.x86_64.rpm"</span>
<span class="token assign-left variable">runc_url</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${base_url}</span>/opencontainers/runc/releases/download/v<span class="token variable">${runc_version}</span>/runc.amd64"</span>
<span class="token assign-left variable">docker_url</span><span class="token operator">=</span><span class="token string">"https://download.docker.com/linux/static/stable/x86_64/docker-<span class="token variable">${docker_version}</span>.tgz"</span>
<span class="token assign-left variable">cni_plugins_url</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${base_url}</span>/containernetworking/plugins/releases/download/<span class="token variable">${cni_plugins_version}</span>/cni-plugins-linux-amd64-<span class="token variable">${cni_plugins_version}</span>.tgz"</span>
<span class="token assign-left variable">cri_containerd_cni_url</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${base_url}</span>/containerd/containerd/releases/download/v<span class="token variable">${cri_containerd_cni_version}</span>/cri-containerd-cni-<span class="token variable">${cri_containerd_cni_version}</span>-linux-amd64.tar.gz"</span>
<span class="token assign-left variable">crictl_url</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${base_url}</span>/kubernetes-sigs/cri-tools/releases/download/<span class="token variable">${crictl_version}</span>/crictl-<span class="token variable">${crictl_version}</span>-linux-amd64.tar.gz"</span>
<span class="token assign-left variable">cri_dockerd_url</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${base_url}</span>/Mirantis/cri-dockerd/releases/download/v<span class="token variable">${cri_dockerd_version}</span>/cri-dockerd-<span class="token variable">${cri_dockerd_version}</span>.amd64.tgz"</span>
<span class="token assign-left variable">etcd_url</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${base_url}</span>/etcd-io/etcd/releases/download/<span class="token variable">${etcd_version}</span>/etcd-<span class="token variable">${etcd_version}</span>-linux-amd64.tar.gz"</span>
<span class="token assign-left variable">cfssl_url</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${base_url}</span>/cloudflare/cfssl/releases/download/v<span class="token variable">${cfssl_version}</span>/cfssl_<span class="token variable">${cfssl_version}</span>_linux_amd64"</span>
<span class="token assign-left variable">cfssljson_url</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${base_url}</span>/cloudflare/cfssl/releases/download/v<span class="token variable">${cfssl_version}</span>/cfssljson_<span class="token variable">${cfssl_version}</span>_linux_amd64"</span>
<span class="token assign-left variable">helm_url</span><span class="token operator">=</span><span class="token string">"https://mirrors.huaweicloud.com/helm/v<span class="token variable">${helm_version}</span>/helm-v<span class="token variable">${helm_version}</span>-linux-amd64.tar.gz"</span>
<span class="token assign-left variable">kubernetes_server_url</span><span class="token operator">=</span><span class="token string">"https://storage.googleapis.com/kubernetes-release/release/v<span class="token variable">${kubernetes_server_version}</span>/kubernetes-server-linux-amd64.tar.gz"</span>
<span class="token assign-left variable">nginx_url</span><span class="token operator">=</span><span class="token string">"http://nginx.org/download/nginx-<span class="token variable">${nginx_version}</span>.tar.gz"</span>

<span class="token comment"># Download packages</span>
<span class="token assign-left variable">packages</span><span class="token operator">=</span><span class="token punctuation">(</span>
  <span class="token variable">$kernel_url</span>
  <span class="token variable">$runc_url</span>
  <span class="token variable">$docker_url</span>
  <span class="token variable">$cni_plugins_url</span>
  <span class="token variable">$cri_containerd_cni_url</span>
  <span class="token variable">$crictl_url</span>
  <span class="token variable">$cri_dockerd_url</span>
  <span class="token variable">$etcd_url</span>
  <span class="token variable">$cfssl_url</span>
  <span class="token variable">$cfssljson_url</span>
  <span class="token variable">$helm_url</span>
  <span class="token variable">$kubernetes_server_url</span>
  <span class="token variable">$nginx_url</span>
<span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">package_url</span> <span class="token keyword">in</span> <span class="token string">"<span class="token variable">${packages<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>"</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token assign-left variable">filename</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> <span class="token string">"<span class="token variable">$package_url</span>"</span><span class="token variable">)</span></span>
  <span class="token keyword">if</span> <span class="token function">curl</span> <span class="token parameter variable">--parallel</span> --parallel-immediate <span class="token parameter variable">-k</span> <span class="token parameter variable">-L</span> <span class="token parameter variable">-C</span> - <span class="token parameter variable">-o</span> <span class="token string">"<span class="token variable">$filename</span>"</span> <span class="token string">"<span class="token variable">$package_url</span>"</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Downloaded <span class="token variable">$filename</span>"</span>
  <span class="token keyword">else</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Failed to download <span class="token variable">$filename</span>"</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
  <span class="token keyword">fi</span>
<span class="token keyword">done</span>
</code></pre> 
<h4><a id="6_609"></a>6.关闭防火墙</h4> 
<pre><code class="prism language-shell"><span class="token comment"># Ubuntu忽略，CentOS执行</span>
systemctl disable <span class="token parameter variable">--now</span> firewalld
</code></pre> 
<h4><a id="7SELinux_616"></a>7.关闭SELinux</h4> 
<pre><code class="prism language-shell"><span class="token comment"># Ubuntu忽略，CentOS执行</span>
setenforce <span class="token number">0</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config

<span class="token comment"># 参数解释</span>
<span class="token comment"># </span>
<span class="token comment"># setenforce 0</span>
<span class="token comment"># 此命令用于设置 SELinux 的执行模式。0 表示关闭 SELinux。</span>
<span class="token comment"># </span>
<span class="token comment"># sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config</span>
<span class="token comment"># 该命令使用 sed 工具来编辑 /etc/selinux/config 文件。其中 '-i' 参数表示直接修改原文件，而不是输出到终端或另一个文件。's#SELINUX=enforcing#SELINUX=disabled#g' 是 sed 的替换命令，它将文件中所有的 "SELINUX=enforcing" 替换为 "SELINUX=disabled"。这里的 '#' 是分隔符，用于替代传统的 '/' 分隔符，以避免与路径中的 '/' 冲突。</span>
</code></pre> 
<h4><a id="8_632"></a>8.关闭交换分区</h4> 
<pre><code class="prism language-shell"><span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab
swapoff <span class="token parameter variable">-a</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sysctl</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">vm.swappiness</span><span class="token operator">=</span><span class="token number">0</span>

<span class="token function">cat</span> /etc/fstab
<span class="token comment"># /dev/mapper/centos-swap swap                    swap    defaults        0 0</span>


<span class="token comment"># 参数解释：</span>
<span class="token comment"># </span>
<span class="token comment"># -ri: 这个参数用于在原文件中替换匹配的模式。-r表示扩展正则表达式，-i允许直接修改文件。</span>
<span class="token comment"># 's/.*swap.*/#&amp;/': 这是一个sed命令，用于在文件/etc/fstab中找到包含swap的行，并在行首添加#来注释掉该行。</span>
<span class="token comment"># /etc/fstab: 这是一个文件路径，即/etc/fstab文件，用于存储文件系统表。</span>
<span class="token comment"># swapoff -a: 这个命令用于关闭所有启用的交换分区。</span>
<span class="token comment"># sysctl -w vm.swappiness=0: 这个命令用于修改vm.swappiness参数的值为0，表示系统在物理内存充足时更倾向于使用物理内存而非交换分区。</span>
</code></pre> 
<h4><a id="9_651"></a>9.网络配置（俩种方式二选一）</h4> 
<pre><code class="prism language-shell"><span class="token comment"># Ubuntu忽略，CentOS执行</span>

<span class="token comment"># 方式一</span>
<span class="token comment"># systemctl disable --now NetworkManager</span>
<span class="token comment"># systemctl start network &amp;&amp; systemctl enable network</span>

<span class="token comment"># 方式二</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/NetworkManager/conf.d/calico.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
[keyfile]
unmanaged-devices=interface-name:cali*;interface-name:tunl*
EOF</span>
systemctl restart NetworkManager

<span class="token comment"># 参数解释</span>
<span class="token comment">#</span>
<span class="token comment"># 这个参数用于指定不由 NetworkManager 管理的设备。它由以下两个部分组成</span>
<span class="token comment"># </span>
<span class="token comment"># interface-name:cali*</span>
<span class="token comment"># 表示以 "cali" 开头的接口名称被排除在 NetworkManager 管理之外。例如，"cali0", "cali1" 等接口不受 NetworkManager 管理。</span>
<span class="token comment"># </span>
<span class="token comment"># interface-name:tunl*</span>
<span class="token comment"># 表示以 "tunl" 开头的接口名称被排除在 NetworkManager 管理之外。例如，"tunl0", "tunl1" 等接口不受 NetworkManager 管理。</span>
<span class="token comment"># </span>
<span class="token comment"># 通过使用这个参数，可以将特定的接口排除在 NetworkManager 的管理范围之外，以便其他工具或进程可以独立地管理和配置这些接口。</span>
</code></pre> 
<h4><a id="10_680"></a>10.进行时间同步</h4> 
<blockquote> 
 <p>服务端：31 客户端：32-35，服务端在31执行，客户端在32-35执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 服务端</span>
<span class="token comment"># apt install chrony -y</span>
yum <span class="token function">install</span> chrony <span class="token parameter variable">-y</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/chrony.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
pool ntp.aliyun.com iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
allow 192.168.0.0/24
local stratum 10
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
EOF</span>

systemctl restart chronyd
systemctl <span class="token builtin class-name">enable</span> chronyd

<span class="token comment"># 客户端</span>
<span class="token comment"># apt install chrony -y</span>
yum <span class="token function">install</span> chrony <span class="token parameter variable">-y</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/chrony.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
pool 192.168.0.31 iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
keyfile /etc/chrony.keys
leapsectz right/UTC
logdir /var/log/chrony
EOF</span>

systemctl restart chronyd
systemctl <span class="token builtin class-name">enable</span> chronyd

<span class="token comment">#使用客户端进行验证</span>
chronyc sources <span class="token parameter variable">-v</span>

<span class="token comment"># 参数解释</span>
<span class="token comment">#</span>
<span class="token comment"># pool ntp.aliyun.com iburst</span>
<span class="token comment"># 指定使用ntp.aliyun.com作为时间服务器池，iburst选项表示在初始同步时会发送多个请求以加快同步速度。</span>
<span class="token comment"># </span>
<span class="token comment"># driftfile /var/lib/chrony/drift</span>
<span class="token comment"># 指定用于保存时钟漂移信息的文件路径。</span>
<span class="token comment"># </span>
<span class="token comment"># makestep 1.0 3</span>
<span class="token comment"># 设置当系统时间与服务器时间偏差大于1秒时，会以1秒的步长进行调整。如果偏差超过3秒，则立即进行时间调整。</span>
<span class="token comment"># </span>
<span class="token comment"># rtcsync</span>
<span class="token comment"># 启用硬件时钟同步功能，可以提高时钟的准确性。</span>
<span class="token comment"># </span>
<span class="token comment"># allow 192.168.0.0/24</span>
<span class="token comment"># 允许192.168.0.0/24网段范围内的主机与chrony进行时间同步。</span>
<span class="token comment"># </span>
<span class="token comment"># local stratum 10</span>
<span class="token comment"># 将本地时钟设为stratum 10，stratum值表示时钟的准确度，值越小表示准确度越高。</span>
<span class="token comment"># </span>
<span class="token comment"># keyfile /etc/chrony.keys</span>
<span class="token comment"># 指定使用的密钥文件路径，用于对时间同步进行身份验证。</span>
<span class="token comment"># </span>
<span class="token comment"># leapsectz right/UTC</span>
<span class="token comment"># 指定时区为UTC。</span>
<span class="token comment"># </span>
<span class="token comment"># logdir /var/log/chrony</span>
<span class="token comment"># 指定日志文件存放目录。</span>
</code></pre> 
<h4><a id="11ulimit_752"></a>11.配置ulimit</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-SHn</span> <span class="token number">65535</span>

<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/security/limits.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
* soft nofile 655360
* hard nofile 131072
* soft nproc 655350
* hard nproc 655350
* seft memlock unlimited
* hard memlock unlimitedd
EOF</span>

<span class="token comment"># 参数解释</span>
<span class="token comment">#</span>
<span class="token comment"># soft nofile 655360</span>
<span class="token comment"># soft表示软限制，nofile表示一个进程可打开的最大文件数，默认值为1024。这里的软限制设置为655360，即一个进程可打开的最大文件数为655360。</span>
<span class="token comment">#</span>
<span class="token comment"># hard nofile 131072</span>
<span class="token comment"># hard表示硬限制，即系统设置的最大值。nofile表示一个进程可打开的最大文件数，默认值为4096。这里的硬限制设置为131072，即系统设置的最大文件数为131072。</span>
<span class="token comment">#</span>
<span class="token comment"># soft nproc 655350</span>
<span class="token comment"># soft表示软限制，nproc表示一个用户可创建的最大进程数，默认值为30720。这里的软限制设置为655350，即一个用户可创建的最大进程数为655350。</span>
<span class="token comment">#</span>
<span class="token comment"># hard nproc 655350</span>
<span class="token comment"># hard表示硬限制，即系统设置的最大值。nproc表示一个用户可创建的最大进程数，默认值为4096。这里的硬限制设置为655350，即系统设置的最大进程数为655350。</span>
<span class="token comment">#</span>
<span class="token comment"># seft memlock unlimited</span>
<span class="token comment"># seft表示软限制，memlock表示一个进程可锁定在RAM中的最大内存，默认值为64 KB。这里的软限制设置为unlimited，即一个进程可锁定的最大内存为无限制。</span>
<span class="token comment">#</span>
<span class="token comment"># hard memlock unlimited</span>
<span class="token comment"># hard表示硬限制，即系统设置的最大值。memlock表示一个进程可锁定在RAM中的最大内存，默认值为64 KB。这里的硬限制设置为unlimited，即系统设置的最大内存锁定为无限制。</span>
</code></pre> 
<h4><a id="12_787"></a>12.配置免密登录</h4> 
<blockquote> 
 <p>所有节点执行,满足各节点之间可以互相免密</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># apt install -y sshpass</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> sshpass
ssh-keygen <span class="token parameter variable">-f</span> /root/.ssh/id_rsa <span class="token parameter variable">-P</span> <span class="token string">''</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IP</span><span class="token operator">=</span><span class="token string">"192.168.0.31 192.168.0.32 192.168.0.33 192.168.0.34 192.168.0.35"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SSHPASS</span><span class="token operator">=</span><span class="token number">111111</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">HOST</span> <span class="token keyword">in</span> <span class="token variable">$IP</span><span class="token punctuation">;</span><span class="token keyword">do</span>
     sshpass <span class="token parameter variable">-e</span> ssh-copy-id <span class="token parameter variable">-o</span> <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no <span class="token variable">$HOST</span>
<span class="token keyword">done</span>

<span class="token comment"># 这段脚本的作用是在一台机器上安装sshpass工具，并通过sshpass自动将本机的SSH公钥复制到多个远程主机上，以实现无需手动输入密码的SSH登录。</span>
<span class="token comment"># </span>
<span class="token comment"># 具体解释如下：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. `apt install -y sshpass` 或 `yum install -y sshpass`：通过包管理器（apt或yum）安装sshpass工具，使得后续可以使用sshpass命令。</span>
<span class="token comment"># </span>
<span class="token comment"># 2. `ssh-keygen -f /root/.ssh/id_rsa -P ''`：生成SSH密钥对。该命令会在/root/.ssh目录下生成私钥文件id_rsa和公钥文件id_rsa.pub，同时不设置密码（即-P参数后面为空），方便后续通过ssh-copy-id命令自动复制公钥。</span>
<span class="token comment"># </span>
<span class="token comment"># 3. `export IP="192.168.0.31 192.168.0.32 192.168.0.33 192.168.0.34 192.168.0.35"`：设置一个包含多个远程主机IP地址的环境变量IP，用空格分隔开，表示要将SSH公钥复制到这些远程主机上。</span>
<span class="token comment"># </span>
<span class="token comment"># 4. `export SSHPASS=111111`：设置环境变量SSHPASS，将sshpass所需的SSH密码（在这里是"111111"）赋值给它，这样sshpass命令可以自动使用这个密码进行登录。</span>
<span class="token comment"># </span>
<span class="token comment"># 5. `for HOST in $IP;do`：遍历环境变量IP中的每个IP地址，并将当前IP地址赋值给变量HOST。</span>
<span class="token comment"># </span>
<span class="token comment"># 6. `sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $HOST`：使用sshpass工具复制本机的SSH公钥到远程主机。其中，-e选项表示使用环境变量中的密码（即SSHPASS）进行登录，-o StrictHostKeyChecking=no选项表示连接时不检查远程主机的公钥，以避免交互式确认。</span>
<span class="token comment"># </span>
<span class="token comment"># 通过这段脚本，可以方便地将本机的SSH公钥复制到多个远程主机上，实现无需手动输入密码的SSH登录。</span>
</code></pre> 
<h4><a id="13_820"></a>13.添加启用源</h4> 
<pre><code class="prism language-shell"><span class="token comment"># Ubuntu忽略，CentOS执行</span>

<span class="token comment"># 为 RHEL-8或 CentOS-8配置源</span>
yum <span class="token function">install</span> https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm <span class="token parameter variable">-y</span> 
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s@mirrorlist@#mirrorlist@g"</span> /etc/yum.repos.d/elrepo.repo 
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g"</span> /etc/yum.repos.d/elrepo.repo 

<span class="token comment"># 为 RHEL-7 SL-7 或 CentOS-7 安装 ELRepo </span>
yum <span class="token function">install</span> https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm <span class="token parameter variable">-y</span> 
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s@mirrorlist@#mirrorlist@g"</span> /etc/yum.repos.d/elrepo.repo 
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g"</span> /etc/yum.repos.d/elrepo.repo 

<span class="token comment"># 查看可用安装包</span>
yum  <span class="token parameter variable">--disablerepo</span><span class="token operator">=</span><span class="token string">"*"</span>  <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span><span class="token string">"elrepo-kernel"</span>  list  available
</code></pre> 
<h4><a id="14418_839"></a>14.升级内核至4.18版本以上</h4> 
<blockquote> 
 <p>centos7直接执行下面的v7整合命令即可。省的一行一行执行</p> 
 <p>也可以一行一行执行，不执行整合命令</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># Ubuntu忽略，CentOS执行</span>

<span class="token comment"># 安装最新的内核</span>
<span class="token comment"># 我这里选择的是稳定版kernel-ml   如需更新长期维护版本kernel-lt  </span>
yum <span class="token parameter variable">-y</span> <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>elrepo-kernel  <span class="token function">install</span>  kernel-ml

<span class="token comment"># 查看已安装那些内核</span>
<span class="token function">rpm</span> <span class="token parameter variable">-qa</span> <span class="token operator">|</span> <span class="token function">grep</span> kernel

<span class="token comment"># 查看默认内核</span>
grubby --default-kernel

<span class="token comment"># 若不是最新的使用命令设置</span>
grubby --set-default <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> /boot/vmlinuz-* <span class="token operator">|</span> <span class="token function">grep</span> elrepo<span class="token variable">)</span></span>

<span class="token comment"># 重启生效</span>
<span class="token function">reboot</span>

<span class="token comment"># v8 整合命令为：</span>
yum <span class="token function">install</span> https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s@mirrorlist@#mirrorlist@g"</span> /etc/yum.repos.d/elrepo.repo <span class="token punctuation">;</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g"</span> /etc/yum.repos.d/elrepo.repo <span class="token punctuation">;</span> yum  <span class="token parameter variable">--disablerepo</span><span class="token operator">=</span><span class="token string">"*"</span>  <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span><span class="token string">"elrepo-kernel"</span>  list  available <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> yum  <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>elrepo-kernel  <span class="token function">install</span> kernel-lt <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> grubby --default-kernel <span class="token punctuation">;</span> <span class="token function">reboot</span> 

<span class="token comment"># v7 整合命令为：</span>
yum <span class="token function">install</span> https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s@mirrorlist@#mirrorlist@g"</span> /etc/yum.repos.d/elrepo.repo <span class="token punctuation">;</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g"</span> /etc/yum.repos.d/elrepo.repo <span class="token punctuation">;</span> yum  <span class="token parameter variable">--disablerepo</span><span class="token operator">=</span><span class="token string">"*"</span>  <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span><span class="token string">"elrepo-kernel"</span>  list  available <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> yum  <span class="token parameter variable">--enablerepo</span><span class="token operator">=</span>elrepo-kernel  <span class="token function">install</span>  kernel-lt <span class="token parameter variable">-y</span> <span class="token punctuation">;</span> grubby --set-default <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> /boot/vmlinuz-* <span class="token operator">|</span> <span class="token function">grep</span> elrepo<span class="token variable">)</span></span> <span class="token punctuation">;</span> grubby --default-kernel <span class="token punctuation">;</span> <span class="token function">reboot</span> 

<span class="token comment"># 离线版本 </span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> /root/cby/kernel-lt-*-1.el7.elrepo.x86_64.rpm <span class="token punctuation">;</span> grubby --set-default <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> /boot/vmlinuz-* <span class="token operator">|</span> <span class="token function">grep</span> elrepo<span class="token variable">)</span></span> <span class="token punctuation">;</span> grubby --default-kernel <span class="token punctuation">;</span> <span class="token function">reboot</span> 
</code></pre> 
<h4><a id="15ipvsadm_874"></a>15.安装ipvsadm</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 对于CentOS7离线安装</span>
<span class="token comment"># yum install /root/centos7/ipset-*.el7.x86_64.rpm /root/centos7/lm_sensors-libs-*.el7.x86_64.rpm  /root/centos7/ipset-libs-*.el7.x86_64.rpm /root/centos7/sysstat-*.el7_9.x86_64.rpm  /root/centos7/ipvsadm-*.el7.x86_64.rpm  -y</span>

<span class="token comment"># 对于 Ubuntu</span>
<span class="token comment"># apt install ipvsadm ipset sysstat conntrack -y</span>

<span class="token comment"># 对于 CentOS</span>
yum <span class="token function">install</span> ipvsadm ipset sysstat conntrack libseccomp <span class="token parameter variable">-y</span>

<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/modules-load.d/ipvs.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF 
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
EOF</span>

systemctl restart systemd-modules-load.service

lsmod <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-e</span> ip_vs <span class="token parameter variable">-e</span> nf_conntrack
<span class="token comment">#ip_vs_sh               16384  0</span>
<span class="token comment">#ip_vs_wrr              16384  0</span>
<span class="token comment">#ip_vs_rr               16384  0</span>
<span class="token comment">#ip_vs                 180224  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr</span>
<span class="token comment">#nf_conntrack          176128  1 ip_vs</span>
<span class="token comment">#nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs</span>
<span class="token comment">#nf_defrag_ipv4         16384  1 nf_conntrack</span>
<span class="token comment">#libcrc32c              16384  3 nf_conntrack,xfs,ip_vs</span>

<span class="token comment"># 参数解释</span>
<span class="token comment">#</span>
<span class="token comment"># ip_vs</span>
<span class="token comment"># IPVS 是 Linux 内核中的一个模块，用于实现负载均衡和高可用性。它通过在前端代理服务器上分发传入请求到后端实际服务器上，提供了高性能和可扩展的网络服务。</span>
<span class="token comment">#</span>
<span class="token comment"># ip_vs_rr</span>
<span class="token comment"># IPVS 的一种调度算法之一，使用轮询方式分发请求到后端服务器，每个请求按顺序依次分发。</span>
<span class="token comment">#</span>
<span class="token comment"># ip_vs_wrr</span>
<span class="token comment"># IPVS 的一种调度算法之一，使用加权轮询方式分发请求到后端服务器，每个请求按照指定的权重比例分发。</span>
<span class="token comment">#</span>
<span class="token comment"># ip_vs_sh</span>
<span class="token comment"># IPVS 的一种调度算法之一，使用哈希方式根据源 IP 地址和目标 IP 地址来分发请求。</span>
<span class="token comment">#</span>
<span class="token comment"># nf_conntrack</span>
<span class="token comment"># 这是一个内核模块，用于跟踪和管理网络连接，包括 TCP、UDP 和 ICMP 等协议。它是实现防火墙状态跟踪的基础。</span>
<span class="token comment">#</span>
<span class="token comment"># ip_tables</span>
<span class="token comment"># 这是一个内核模块，提供了对 Linux 系统 IP 数据包过滤和网络地址转换（NAT）功能的支持。</span>
<span class="token comment">#</span>
<span class="token comment"># ip_set</span>
<span class="token comment"># 这是一个内核模块，扩展了 iptables 的功能，支持更高效的 IP 地址集合操作。</span>
<span class="token comment">#</span>
<span class="token comment"># xt_set</span>
<span class="token comment"># 这是一个内核模块，扩展了 iptables 的功能，支持更高效的数据包匹配和操作。</span>
<span class="token comment">#</span>
<span class="token comment"># ipt_set</span>
<span class="token comment"># 这是一个用户空间工具，用于配置和管理 xt_set 内核模块。</span>
<span class="token comment">#</span>
<span class="token comment"># ipt_rpfilter</span>
<span class="token comment"># 这是一个内核模块，用于实现反向路径过滤，用于防止 IP 欺骗和 DDoS 攻击。</span>
<span class="token comment">#</span>
<span class="token comment"># ipt_REJECT</span>
<span class="token comment"># 这是一个 iptables 目标，用于拒绝 IP 数据包，并向发送方发送响应，指示数据包被拒绝。</span>
<span class="token comment">#</span>
<span class="token comment"># ipip</span>
<span class="token comment"># 这是一个内核模块，用于实现 IP 封装在 IP（IP-over-IP）的隧道功能。它可以在不同网络之间创建虚拟隧道来传输 IP 数据包。</span>
</code></pre> 
<h4><a id="16_952"></a>16.修改内核参数</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf</span>
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384

net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
net.ipv6.conf.all.forwarding = 1
EOF</span>

<span class="token function">sysctl</span> <span class="token parameter variable">--system</span>

<span class="token comment"># 这些是Linux系统的一些参数设置，用于配置和优化网络、文件系统和虚拟内存等方面的功能。以下是每个参数的详细解释：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. net.ipv4.ip_forward = 1</span>
<span class="token comment">#    - 这个参数启用了IPv4的IP转发功能，允许服务器作为网络路由器转发数据包。</span>
<span class="token comment"># </span>
<span class="token comment"># 2. net.bridge.bridge-nf-call-iptables = 1</span>
<span class="token comment">#    - 当使用网络桥接技术时，将数据包传递到iptables进行处理。</span>
<span class="token comment">#   </span>
<span class="token comment"># 3. fs.may_detach_mounts = 1</span>
<span class="token comment">#    - 允许在挂载文件系统时，允许被其他进程使用。</span>
<span class="token comment">#   </span>
<span class="token comment"># 4. vm.overcommit_memory=1</span>
<span class="token comment">#    - 该设置允许原始的内存过量分配策略，当系统的内存已经被完全使用时，系统仍然会分配额外的内存。</span>
<span class="token comment"># </span>
<span class="token comment"># 5. vm.panic_on_oom=0</span>
<span class="token comment">#    - 当系统内存不足（OOM）时，禁用系统崩溃和重启。</span>
<span class="token comment"># </span>
<span class="token comment"># 6. fs.inotify.max_user_watches=89100</span>
<span class="token comment">#    - 设置系统允许一个用户的inotify实例可以监控的文件数目的上限。</span>
<span class="token comment"># </span>
<span class="token comment"># 7. fs.file-max=52706963</span>
<span class="token comment">#    - 设置系统同时打开的文件数的上限。</span>
<span class="token comment"># </span>
<span class="token comment"># 8. fs.nr_open=52706963</span>
<span class="token comment">#    - 设置系统同时打开的文件描述符数的上限。</span>
<span class="token comment"># </span>
<span class="token comment"># 9. net.netfilter.nf_conntrack_max=2310720</span>
<span class="token comment">#    - 设置系统可以创建的网络连接跟踪表项的最大数量。</span>
<span class="token comment"># </span>
<span class="token comment"># 10. net.ipv4.tcp_keepalive_time = 600</span>
<span class="token comment">#     - 设置TCP套接字的空闲超时时间（秒），超过该时间没有活动数据时，内核会发送心跳包。</span>
<span class="token comment"># </span>
<span class="token comment"># 11. net.ipv4.tcp_keepalive_probes = 3</span>
<span class="token comment">#     - 设置未收到响应的TCP心跳探测次数。</span>
<span class="token comment"># </span>
<span class="token comment"># 12. net.ipv4.tcp_keepalive_intvl = 15</span>
<span class="token comment">#     - 设置TCP心跳探测的时间间隔（秒）。</span>
<span class="token comment"># </span>
<span class="token comment"># 13. net.ipv4.tcp_max_tw_buckets = 36000</span>
<span class="token comment">#     - 设置系统可以使用的TIME_WAIT套接字的最大数量。</span>
<span class="token comment"># </span>
<span class="token comment"># 14. net.ipv4.tcp_tw_reuse = 1</span>
<span class="token comment">#     - 启用TIME_WAIT套接字的重新利用，允许新的套接字使用旧的TIME_WAIT套接字。</span>
<span class="token comment"># </span>
<span class="token comment"># 15. net.ipv4.tcp_max_orphans = 327680</span>
<span class="token comment">#     - 设置系统可以同时存在的TCP套接字垃圾回收包裹数的最大数量。</span>
<span class="token comment"># </span>
<span class="token comment"># 16. net.ipv4.tcp_orphan_retries = 3</span>
<span class="token comment">#     - 设置系统对于孤立的TCP套接字的重试次数。</span>
<span class="token comment"># </span>
<span class="token comment"># 17. net.ipv4.tcp_syncookies = 1</span>
<span class="token comment">#     - 启用TCP SYN cookies保护，用于防止SYN洪泛攻击。</span>
<span class="token comment"># </span>
<span class="token comment"># 18. net.ipv4.tcp_max_syn_backlog = 16384</span>
<span class="token comment">#     - 设置新的TCP连接的半连接数（半连接队列）的最大长度。</span>
<span class="token comment"># </span>
<span class="token comment"># 19. net.ipv4.ip_conntrack_max = 65536</span>
<span class="token comment">#     - 设置系统可以创建的网络连接跟踪表项的最大数量。</span>
<span class="token comment"># </span>
<span class="token comment"># 20. net.ipv4.tcp_timestamps = 0</span>
<span class="token comment">#     - 关闭TCP时间戳功能，用于提供更好的安全性。</span>
<span class="token comment"># </span>
<span class="token comment"># 21. net.core.somaxconn = 16384</span>
<span class="token comment">#     - 设置系统核心层的连接队列的最大值。</span>
<span class="token comment"># </span>
<span class="token comment"># 22. net.ipv6.conf.all.disable_ipv6 = 0</span>
<span class="token comment">#     - 启用IPv6协议。</span>
<span class="token comment"># </span>
<span class="token comment"># 23. net.ipv6.conf.default.disable_ipv6 = 0</span>
<span class="token comment">#     - 启用IPv6协议。</span>
<span class="token comment"># </span>
<span class="token comment"># 24. net.ipv6.conf.lo.disable_ipv6 = 0</span>
<span class="token comment">#     - 启用IPv6协议。</span>
<span class="token comment"># </span>
<span class="token comment"># 25. net.ipv6.conf.all.forwarding = 1</span>
<span class="token comment">#     - 允许IPv6数据包转发。</span>
</code></pre> 
<h4><a id="17hosts_1066"></a>17.所有节点配置hosts本地解析</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/hosts <span class="token operator">&lt;&lt;</span><span class="token string">EOF
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.0.31 k8s-master01
192.168.0.32 k8s-master02
192.168.0.33 k8s-master03
192.168.0.34 k8s-node01
192.168.0.35 k8s-node02
192.168.0.36 lb-vip
EOF</span>
</code></pre> 
<h2><a id="2k8s_1082"></a>2.k8s基本组件安装</h2> 
<p><strong>注意 ： 2.1 和 2.2 二选其一即可</strong></p> 
<h3><a id="21ContainerdRuntime__1086"></a>2.1.安装Containerd作为Runtime （推荐）</h3> 
<blockquote> 
 <p>master+node所有节点安装</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># https://github.com/containernetworking/plugins/releases/</span>
<span class="token comment"># wget https://ghproxy.com/https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-amd64-v1.3.0.tgz</span>
<span class="token function">mkdir</span> ~/lzb
<span class="token builtin class-name">cd</span> lzb/

<span class="token comment">#创建cni插件所需目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/cni/net.d /opt/cni/bin
<span class="token comment">#解压cni二进制包</span>
<span class="token function">tar</span> xf cni-plugins-linux-amd64-v*.tgz <span class="token parameter variable">-C</span> /opt/cni/bin/

<span class="token comment"># https://github.com/containerd/containerd/releases/</span>
<span class="token comment"># wget https://ghproxy.com/https://github.com/containerd/containerd/releases/download/v1.7.3/cri-containerd-cni-1.7.3-linux-amd64.tar.gz</span>

<span class="token comment">#解压</span>
<span class="token function">tar</span> <span class="token parameter variable">-xzf</span> cri-containerd-cni-*-linux-amd64.tar.gz <span class="token parameter variable">-C</span> /

<span class="token comment">#创建服务启动文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/systemd/system/containerd.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/local/bin/containerd
Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=infinity
TasksMax=infinity
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
EOF</span>


<span class="token comment"># 参数解释：</span>
<span class="token comment">#</span>
<span class="token comment"># 这是一个用于启动containerd容器运行时的systemd unit文件。下面是对该文件不同部分的详细解释：</span>
<span class="token comment"># </span>
<span class="token comment"># [Unit]</span>
<span class="token comment"># Description=containerd container runtime</span>
<span class="token comment"># 描述该unit的作用是作为containerd容器运行时。</span>
<span class="token comment"># </span>
<span class="token comment"># Documentation=https://containerd.io</span>
<span class="token comment"># 指向容器运行时的文档的URL。</span>
<span class="token comment"># </span>
<span class="token comment"># After=network.target local-fs.target</span>
<span class="token comment"># 定义了在哪些依赖项之后该unit应该被启动。在网络和本地文件系统加载完成后启动，确保了容器运行时在这些依赖项可用时才会启动。</span>
<span class="token comment"># </span>
<span class="token comment"># [Service]</span>
<span class="token comment"># ExecStartPre=-/sbin/modprobe overlay</span>
<span class="token comment"># 在启动containerd之前执行的命令。这里的命令是尝试加载内核的overlay模块，如果失败则忽略错误继续执行下面的命令。</span>
<span class="token comment"># </span>
<span class="token comment"># ExecStart=/usr/local/bin/containerd</span>
<span class="token comment"># 实际执行的命令，用于启动containerd容器运行时。</span>
<span class="token comment"># </span>
<span class="token comment"># Type=notify</span>
<span class="token comment"># 指定服务的通知类型。这里使用notify类型，表示当服务就绪时会通过通知的方式告知systemd。</span>
<span class="token comment"># </span>
<span class="token comment"># Delegate=yes</span>
<span class="token comment"># 允许systemd对此服务进行重启和停止操作。</span>
<span class="token comment"># </span>
<span class="token comment"># KillMode=process</span>
<span class="token comment"># 在终止容器运行时时使用的kill模式。这里使用process模式，表示通过终止进程来停止容器运行时。</span>
<span class="token comment"># </span>
<span class="token comment"># Restart=always</span>
<span class="token comment"># 定义了当容器运行时终止后的重启策略。这里设置为always，表示无论何时终止容器运行时，都会自动重新启动。</span>
<span class="token comment"># </span>
<span class="token comment"># RestartSec=5</span>
<span class="token comment"># 在容器运行时终止后重新启动之前等待的秒数。</span>
<span class="token comment"># </span>
<span class="token comment"># LimitNPROC=infinity</span>
<span class="token comment"># 指定容器运行时可以使用的最大进程数量。这里设置为无限制。</span>
<span class="token comment"># </span>
<span class="token comment"># LimitCORE=infinity</span>
<span class="token comment"># 指定容器运行时可以使用的最大CPU核心数量。这里设置为无限制。</span>
<span class="token comment"># </span>
<span class="token comment"># LimitNOFILE=infinity</span>
<span class="token comment"># 指定容器运行时可以打开的最大文件数。这里设置为无限制。</span>
<span class="token comment"># </span>
<span class="token comment"># TasksMax=infinity</span>
<span class="token comment"># 指定容器运行时可以创建的最大任务数。这里设置为无限制。</span>
<span class="token comment"># </span>
<span class="token comment"># OOMScoreAdjust=-999</span>
<span class="token comment"># 指定容器运行时的OOM（Out-Of-Memory）分数调整值。负数值表示容器运行时的优先级较高。</span>
<span class="token comment"># </span>
<span class="token comment"># [Install]</span>
<span class="token comment"># WantedBy=multi-user.target</span>
<span class="token comment"># 定义了服务的安装位置。这里指定为multi-user.target，表示将服务安装为多用户模式下的启动项。</span>
</code></pre> 
<h4><a id="211_Containerd_1189"></a>2.1.1 配置Containerd所需的模块</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/modules-load.d/containerd.conf</span>
overlay
br_netfilter
EOF</span>

<span class="token comment"># 参数解释：</span>
<span class="token comment">#</span>
<span class="token comment"># containerd是一个容器运行时，用于管理和运行容器。它支持多种不同的参数配置来自定义容器运行时的行为和功能。</span>
<span class="token comment"># </span>
<span class="token comment"># 1. overlay：overlay是容器d默认使用的存储驱动，它提供了一种轻量级的、可堆叠的、逐层增量的文件系统。它通过在现有文件系统上叠加文件系统层来创建容器的文件系统视图。每个容器可以有自己的一组文件系统层，这些层可以共享基础镜像中的文件，并在容器内部进行修改。使用overlay可以有效地使用磁盘空间，并使容器更加轻量级。</span>
<span class="token comment"># </span>
<span class="token comment"># 2. br_netfilter：br_netfilter是Linux内核提供的一个网络过滤器模块，用于在容器网络中进行网络过滤和NAT转发。当容器和主机之间的网络通信需要进行DNAT或者SNAT时，br_netfilter模块可以将IP地址进行转换。它还可以提供基于iptables规则的网络过滤功能，用于限制容器之间或容器与外部网络之间的通信。</span>
<span class="token comment"># </span>
<span class="token comment"># 这些参数可以在containerd的配置文件或者命令行中指定。例如，可以通过设置--storage-driver参数来选择使用overlay作为存储驱动，通过设置--iptables参数来启用或禁用br_netfilter模块。具体的使用方法和配置细节可以参考containerd的官方文档。</span>
</code></pre> 
<h4><a id="212__1208"></a>2.1.2 加载模块</h4> 
<pre><code class="prism language-shell">systemctl restart systemd-modules-load.service

<span class="token comment"># 参数解释：</span>
<span class="token comment"># - `systemctl`: 是Linux系统管理服务的命令行工具，可以管理systemd init系统。</span>
<span class="token comment"># - `restart`: 是systemctl命令的一个选项，用于重新启动服务。</span>
<span class="token comment"># - `systemd-modules-load.service`: 是一个系统服务，用于加载内核模块。</span>
<span class="token comment"># </span>
<span class="token comment"># 将上述参数结合在一起来解释`systemctl restart systemd-modules-load.service`的含义：</span>
<span class="token comment"># 这个命令用于重新启动系统服务`systemd-modules-load.service`，它是负责加载内核模块的服务。在重新启动该服务后，系统会重新加载所有的内核模块。</span>
</code></pre> 
<h4><a id="213_Containerd_1222"></a>2.1.3 配置Containerd所需的内核</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/99-kubernetes-cri.conf</span>
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF</span>

<span class="token comment"># 加载内核</span>
<span class="token function">sysctl</span> <span class="token parameter variable">--system</span>

<span class="token comment"># 参数解释：</span>
<span class="token comment"># </span>
<span class="token comment"># 这些参数是Linux操作系统中用于网络和网络桥接设置的参数。</span>
<span class="token comment"># </span>
<span class="token comment"># - net.bridge.bridge-nf-call-iptables：这个参数控制网络桥接设备是否调用iptables规则处理网络数据包。当该参数设置为1时，网络数据包将被传递到iptables进行处理；当该参数设置为0时，网络数据包将绕过iptables直接传递。默认情况下，这个参数的值是1，即启用iptables规则处理网络数据包。</span>
<span class="token comment"># </span>
<span class="token comment"># - net.ipv4.ip_forward：这个参数用于控制是否启用IP转发功能。IP转发使得操作系统可以将接收到的数据包从一个网络接口转发到另一个网络接口。当该参数设置为1时，启用IP转发功能；当该参数设置为0时，禁用IP转发功能。在网络环境中，通常需要启用IP转发功能来实现不同网络之间的通信。默认情况下，这个参数的值是0，即禁用IP转发功能。</span>
<span class="token comment"># </span>
<span class="token comment"># - net.bridge.bridge-nf-call-ip6tables：这个参数与net.bridge.bridge-nf-call-iptables类似，但是它用于IPv6数据包的处理。当该参数设置为1时，IPv6数据包将被传递到ip6tables进行处理；当该参数设置为0时，IPv6数据包将绕过ip6tables直接传递。默认情况下，这个参数的值是1，即启用ip6tables规则处理IPv6数据包。</span>
<span class="token comment"># </span>
<span class="token comment"># 这些参数的值可以通过修改操作系统的配置文件（通常是'/etc/sysctl.conf'）来进行设置。修改完成后，需要使用'sysctl -p'命令重载配置文件使参数生效。</span>
</code></pre> 
<h4><a id="214_Containerd_1247"></a>2.1.4 创建Containerd的配置文件</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 参数解释：</span>
<span class="token comment"># </span>
<span class="token comment"># 这段代码是用于修改并配置containerd的参数。</span>
<span class="token comment"># </span>
<span class="token comment"># 1. 首先使用命令`mkdir -p /etc/containerd`创建/etc/containerd目录，如果该目录已存在，则不进行任何操作。</span>
<span class="token comment"># 2. 使用命令`containerd config default | tee /etc/containerd/config.toml`创建默认配置文件，并将输出同时传递给/etc/containerd/config.toml文件。</span>
<span class="token comment"># 3. 使用sed命令修改/etc/containerd/config.toml文件，将SystemdCgroup参数的值从false改为true。-i参数表示直接在原文件中进行编辑。</span>
<span class="token comment"># 4. 使用cat命令结合grep命令查看/etc/containerd/config.toml文件中SystemdCgroup参数的值是否已修改为true。</span>
<span class="token comment"># 5. 使用sed命令修改/etc/containerd/config.toml文件，将registry.k8s.io的地址替换为m.daocloud.io/registry.k8s.io。-i参数表示直接在原文件中进行编辑。</span>
<span class="token comment"># 6. 使用cat命令结合grep命令查看/etc/containerd/config.toml文件中sandbox_image参数的值是否已修改为m.daocloud.io/registry.k8s.io。</span>
<span class="token comment"># 7. 使用sed命令修改/etc/containerd/config.toml文件，将config_path参数的值从""改为"/etc/containerd/certs.d"。-i参数表示直接在原文件中进行编辑。</span>
<span class="token comment"># 8. 使用cat命令结合grep命令查看/etc/containerd/config.toml文件中certs.d参数的值是否已修改为/etc/containerd/certs.d。</span>
<span class="token comment"># 9. 使用mkdir命令创建/etc/containerd/certs.d/docker.io目录，如果目录已存在，则不进行任何操作。-p参数表示创建目录时，如果父级目录不存在，则自动创建父级目录。</span>
<span class="token comment"># </span>
<span class="token comment"># 最后，使用cat重定向操作符将内容写入/etc/containerd/certs.d/docker.io/hosts.toml文件。该文件会配置加速器，其中server参数设置为"https://docker.io"，host参数设置为"https://hub-mirror.c.163.com"，并添加capabilities参数。</span>

<span class="token comment"># 创建默认配置文件</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/containerd
containerd config default <span class="token operator">|</span> <span class="token function">tee</span> /etc/containerd/config.toml

<span class="token comment"># 修改Containerd的配置文件</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#SystemdCgroup\ \=\ false#SystemdCgroup\ \=\ true#g"</span> /etc/containerd/config.toml
<span class="token function">cat</span> /etc/containerd/config.toml <span class="token operator">|</span> <span class="token function">grep</span> SystemdCgroup
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#registry.k8s.io#m.daocloud.io/registry.k8s.io#g"</span> /etc/containerd/config.toml
<span class="token function">cat</span> /etc/containerd/config.toml <span class="token operator">|</span> <span class="token function">grep</span> sandbox_image
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#config_path\ \=\ <span class="token entity" title='\"'>\"</span><span class="token entity" title='\"'>\"</span>#config_path\ \=\ <span class="token entity" title='\"'>\"</span>/etc/containerd/certs.d<span class="token entity" title='\"'>\"</span>#g"</span> /etc/containerd/config.toml
<span class="token function">cat</span> /etc/containerd/config.toml <span class="token operator">|</span> <span class="token function">grep</span> certs.d

<span class="token comment"># 配置加速器</span>
<span class="token function">mkdir</span> /etc/containerd/certs.d/docker.io <span class="token parameter variable">-pv</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/containerd/certs.d/docker.io/hosts.toml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
server = "https://docker.io"
[host."https://hub-mirror.c.163.com"]
  capabilities = ["pull", "resolve"]
EOF</span>

<span class="token comment"># 注意！</span>
<span class="token comment"># SystemdCgroup参数是containerd中的一个配置参数，用于设置containerd在运行过程中使用的Cgroup（控制组）路径。Containerd使用SystemdCgroup参数来指定应该使用哪个Cgroup来跟踪和管理容器的资源使用。</span>
<span class="token comment"># </span>
<span class="token comment"># Cgroup是Linux内核提供的一种资源隔离和管理机制，可以用于限制、分配和监控进程组的资源使用。使用Cgroup，可以将容器的资源限制和隔离，以防止容器之间的资源争用和不公平的竞争。</span>
<span class="token comment"># </span>
<span class="token comment"># 通过设置SystemdCgroup参数，可以确保containerd能够找到正确的Cgroup路径，并正确地限制和隔离容器的资源使用，确保容器可以按照预期的方式运行。如果未正确设置SystemdCgroup参数，可能会导致容器无法正确地使用资源，或者无法保证资源的公平分配和隔离。</span>
<span class="token comment"># </span>
<span class="token comment"># 总而言之，SystemdCgroup参数的作用是为了确保containerd能够正确地管理容器的资源使用，以实现资源的限制、隔离和公平分配。</span>
</code></pre> 
<h4><a id="215__1297"></a>2.1.5 启动并设置为开机启动</h4> 
<pre><code class="prism language-shell">systemctl daemon-reload
<span class="token comment"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span>

systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> containerd.service
<span class="token comment"># 启用并立即启动docker.service单元。docker.service是Docker守护进程的systemd服务单元。</span>

systemctl stop containerd.service
<span class="token comment"># 停止运行中的docker.service单元，即停止Docker守护进程。</span>

systemctl start containerd.service
<span class="token comment"># 启动docker.service单元，即启动Docker守护进程。</span>

systemctl restart containerd.service
<span class="token comment"># 重启docker.service单元，即重新启动Docker守护进程。</span>

systemctl status containerd.service
<span class="token comment"># 显示docker.service单元的当前状态，包括运行状态、是否启用等信息。</span>
</code></pre> 
<h4><a id="216_crictl_1319"></a>2.1.6 配置crictl客户端连接的运行时位置</h4> 
<pre><code class="prism language-shell"><span class="token comment"># https://github.com/kubernetes-sigs/cri-tools/releases/</span>
<span class="token comment"># wget https://ghproxy.com/https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.28.0/crictl-v1.28.0-linux-amd64.tar.gz</span>

<span class="token comment">#解压</span>
<span class="token function">tar</span> xf crictl-v*-linux-amd64.tar.gz <span class="token parameter variable">-C</span> /usr/bin/
<span class="token comment">#生成配置文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/crictl.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
EOF</span>

<span class="token comment">#测试</span>
systemctl restart  containerd
crictl info

<span class="token comment"># 注意！</span>
<span class="token comment"># 下面是参数`crictl`的详细解释</span>
<span class="token comment"># </span>
<span class="token comment"># `crictl`是一个用于与容器运行时通信的命令行工具。它是容器运行时接口（CRI）工具的一个实现，可以对容器运行时进行管理和操作。</span>
<span class="token comment"># </span>
<span class="token comment"># 1. `runtime-endpoint: unix:///run/containerd/containerd.sock`</span>
<span class="token comment"># 指定容器运行时的终端套接字地址。在这个例子中，指定的地址是`unix:///run/containerd/containerd.sock`，这是一个Unix域套接字地址。</span>
<span class="token comment"># </span>
<span class="token comment"># 2. `image-endpoint: unix:///run/containerd/containerd.sock`</span>
<span class="token comment"># 指定容器镜像服务的终端套接字地址。在这个例子中，指定的地址是`unix:///run/containerd/containerd.sock`，这是一个Unix域套接字地址。</span>
<span class="token comment"># </span>
<span class="token comment"># 3. `timeout: 10`</span>
<span class="token comment"># 设置与容器运行时通信的超时时间，单位是秒。在这个例子中，超时时间被设置为10秒。</span>
<span class="token comment"># </span>
<span class="token comment"># 4. `debug: false`</span>
<span class="token comment"># 指定是否开启调式模式。在这个例子中，调式模式被设置为关闭，即`false`。如果设置为`true`，则会输出更详细的调试信息。</span>
<span class="token comment"># </span>
<span class="token comment"># 这些参数可以根据需要进行修改，以便与容器运行时进行有效的通信和管理。</span>
</code></pre> 
<h3><a id="22_dockerRuntime__1359"></a>2.2 安装docker作为Runtime （不推荐）</h3> 
<h4><a id="221_docker_1361"></a>2.2.1 解压docker程序</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 二进制包下载地址：https://download.docker.com/linux/static/stable/x86_64/</span>
<span class="token comment"># wget https://download.docker.com/linux/static/stable/x86_64/docker-24.0.5.tgz</span>

<span class="token comment">#解压</span>
<span class="token function">tar</span> xf docker-*.tgz 
<span class="token comment">#拷贝二进制文件</span>
<span class="token function">cp</span> docker/* /usr/bin/
</code></pre> 
<h4><a id="222_containerdservice_1373"></a>2.2.2 创建containerd的service文件</h4> 
<pre><code class="prism language-shell"><span class="token comment">#创建containerd的service文件,并且启动</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span>/etc/systemd/system/containerd.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/bin/containerd
Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=1048576
TasksMax=infinity
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
EOF</span>

<span class="token comment"># 参数解释：</span>
<span class="token comment"># </span>
<span class="token comment"># [Unit]</span>
<span class="token comment"># - Description=containerd container runtime：指定服务的描述信息。</span>
<span class="token comment"># - Documentation=https://containerd.io：指定服务的文档链接。</span>
<span class="token comment"># - After=network.target local-fs.target：指定服务的启动顺序，在网络和本地文件系统启动之后再启动该服务。</span>
<span class="token comment"># </span>
<span class="token comment"># [Service]</span>
<span class="token comment"># - ExecStartPre=-/sbin/modprobe overlay：在启动服务之前执行的命令，使用`-`表示忽略错误。</span>
<span class="token comment"># - ExecStart=/usr/bin/containerd：指定服务的启动命令。</span>
<span class="token comment"># - Type=notify：指定服务的类型，`notify`表示服务会在启动完成后向systemd发送通知。</span>
<span class="token comment"># - Delegate=yes：允许服务代理其他服务的应答，例如收到关机命令后终止其他服务。</span>
<span class="token comment"># - KillMode=process：指定服务终止时的行为，`process`表示终止服务进程。</span>
<span class="token comment"># - Restart=always：指定服务终止后是否自动重启，`always`表示总是自动重启。</span>
<span class="token comment"># - RestartSec=5：指定服务重启的时间间隔，单位为秒。</span>
<span class="token comment"># - LimitNPROC=infinity：限制服务的最大进程数，`infinity`表示没有限制。</span>
<span class="token comment"># - LimitCORE=infinity：限制服务的最大核心数，`infinity`表示没有限制。</span>
<span class="token comment"># - LimitNOFILE=1048576：限制服务的最大文件数，指定为1048576。</span>
<span class="token comment"># - TasksMax=infinity：限制服务的最大任务数，`infinity`表示没有限制。</span>
<span class="token comment"># - OOMScoreAdjust=-999：指定服务的OOM（Out of Memory）得分，负数表示降低被终止的概率。</span>
<span class="token comment"># </span>
<span class="token comment"># [Install]</span>
<span class="token comment"># - WantedBy=multi-user.target：指定服务的安装方式，`multi-user.target`表示该服务在多用户模式下安装。</span>


<span class="token comment"># 设置开机自启</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> containerd.service
</code></pre> 
<h4><a id="223_dockerservice_1430"></a>2.2.3 准备docker的service文件</h4> 
<pre><code class="prism language-shell"><span class="token comment">#准备docker的service文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/systemd/system/docker.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service containerd.service
Wants=network-online.target
Requires=docker.socket containerd.service

[Service]
Type=notify
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
ExecReload=/bin/kill -s HUP <span class="token variable">$MAINPID</span>
TimeoutSec=0
RestartSec=2
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process
OOMScoreAdjust=-500

[Install]
WantedBy=multi-user.target
EOF</span>

<span class="token comment"># 参数解释：</span>
<span class="token comment"># </span>
<span class="token comment"># [Unit]</span>
<span class="token comment"># - Description: 描述服务的作用，这里是Docker Application Container Engine，即Docker应用容器引擎。</span>
<span class="token comment"># - Documentation: 提供关于此服务的文档链接，这里是Docker官方文档链接。</span>
<span class="token comment"># - After: 说明该服务在哪些其他服务之后启动，这里是在网络在线、firewalld服务和containerd服务后启动。</span>
<span class="token comment"># - Wants: 说明该服务想要的其他服务，这里是网络在线服务。</span>
<span class="token comment"># - Requires: 说明该服务需要的其他服务，这里是docker.socket和containerd.service。</span>
<span class="token comment"># </span>
<span class="token comment"># [Service]</span>
<span class="token comment"># - Type: 服务类型，这里是notify，表示服务在启动完成时发送通知。</span>
<span class="token comment"># - ExecStart: 命令，启动该服务时会执行的命令，这里是/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock，即启动dockerd并指定一些参数，其中-H指定dockerd的监听地址为fd://，--containerd指定containerd的sock文件位置。</span>
<span class="token comment"># - ExecReload: 重载命令，当接收到HUP信号时执行的命令，这里是/bin/kill -s HUP $MAINPID，即发送HUP信号给主进程ID。</span>
<span class="token comment"># - TimeoutSec: 服务超时时间，这里是0，表示没有超时限制。</span>
<span class="token comment"># - RestartSec: 重启间隔时间，这里是2秒，表示重启失败后等待2秒再重启。</span>
<span class="token comment"># - Restart: 重启策略，这里是always，表示总是重启。</span>
<span class="token comment"># - StartLimitBurst: 启动限制次数，这里是3，表示在启动失败后最多重试3次。</span>
<span class="token comment"># - StartLimitInterval: 启动限制时间间隔，这里是60秒，表示两次启动之间最少间隔60秒。</span>
<span class="token comment"># - LimitNOFILE: 文件描述符限制，这里是infinity，表示没有限制。</span>
<span class="token comment"># - LimitNPROC: 进程数限制，这里是infinity，表示没有限制。</span>
<span class="token comment"># - LimitCORE: 核心转储限制，这里是infinity，表示没有限制。</span>
<span class="token comment"># - TasksMax: 最大任务数，这里是infinity，表示没有限制。</span>
<span class="token comment"># - Delegate: 修改权限，这里是yes，表示启用权限修改。</span>
<span class="token comment"># - KillMode: 杀死模式，这里是process，表示杀死整个进程组。</span>
<span class="token comment"># - OOMScoreAdjust: 用于调整进程在系统内存紧张时的优先级调整，这里是-500，表示将OOM分数降低500。</span>
<span class="token comment"># </span>
<span class="token comment"># [Install]</span>
<span class="token comment"># - WantedBy: 安装目标，这里是multi-user.target，表示在多用户模式下安装。</span>
<span class="token comment">#      在WantedBy参数中，我们可以使用以下参数：</span>
<span class="token comment">#      1. multi-user.target：指定该服务应该在多用户模式下启动。</span>
<span class="token comment">#      2. graphical.target：指定该服务应该在图形化界面模式下启动。</span>
<span class="token comment">#      3. default.target：指定该服务应该在系统的默认目标（runlevel）下启动。</span>
<span class="token comment">#      4. rescue.target：指定该服务应该在系统救援模式下启动。</span>
<span class="token comment">#      5. poweroff.target：指定该服务应该在关机时启动。</span>
<span class="token comment">#      6. reboot.target：指定该服务应该在重启时启动。</span>
<span class="token comment">#      7. halt.target：指定该服务应该在停止时启动。</span>
<span class="token comment">#      8. shutdown.target：指定该服务应该在系统关闭时启动。</span>
<span class="token comment">#      这些参数可以根据需要选择一个或多个，以告知系统在何时启动该服务。</span>

</code></pre> 
<h4><a id="224_dockersocket_1504"></a>2.2.4 准备docker的socket文件</h4> 
<pre><code class="prism language-shell"><span class="token comment">#准备docker的socket文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/systemd/system/docker.socket <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=Docker Socket for the API

[Socket]
ListenStream=/var/run/docker.sock
SocketMode=0660
SocketUser=root
SocketGroup=docker

[Install]
WantedBy=sockets.target
EOF</span>

<span class="token comment"># 这是一个用于Docker API的socket配置文件，包含了以下参数：</span>
<span class="token comment"># </span>
<span class="token comment"># [Unit]</span>
<span class="token comment"># - Description：描述了该socket的作用，即为Docker API的socket。</span>
<span class="token comment"># </span>
<span class="token comment"># [Socket]</span>
<span class="token comment"># - ListenStream：指定了socket的监听地址，该socket会监听在/var/run/docker.sock上，即Docker守护程序使用的默认sock文件。</span>
<span class="token comment"># - SocketMode：指定了socket文件的权限模式，此处为0660，即用户和用户组有读写权限，其他用户无权限。</span>
<span class="token comment"># - SocketUser：指定了socket文件的所有者，此处为root用户。</span>
<span class="token comment"># - SocketGroup：指定了socket文件的所属用户组，此处为docker用户组。</span>
<span class="token comment"># </span>
<span class="token comment"># [Install]</span>
<span class="token comment"># - WantedBy：指定了该socket被启用时的目标，此处为sockets.target，表示当sockets.target启动时启用该socket。</span>
<span class="token comment"># </span>
<span class="token comment"># 该配置文件的作用是为Docker提供API访问的通道，它监听在/var/run/docker.sock上，具有root用户权限，但只接受docker用户组的成员的连接，并且其他用户无法访问。这样，只有docker用户组的成员可以通过该socket与Docker守护进程进行通信。</span>

</code></pre> 
<h4><a id="225__1540"></a>2.2.5 配置加速器</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 配置加速器</span>
<span class="token function">mkdir</span> /etc/docker/ <span class="token parameter variable">-pv</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span>/etc/docker/daemon.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn/"
  ],
  "max-concurrent-downloads": 10,
  "log-driver": "json-file",
  "log-level": "warn",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
    },
  "data-root": "/var/lib/docker"
}
EOF</span>


<span class="token comment"># 该参数文件中包含以下参数：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. exec-opts: 用于设置Docker守护进程的选项，native.cgroupdriver=systemd表示使用systemd作为Cgroup驱动程序。</span>
<span class="token comment"># 2. registry-mirrors: 用于指定Docker镜像的镜像注册服务器。在这里有三个镜像注册服务器：https://docker.m.daocloud.io、https://docker.mirrors.ustc.edu.cn和http://hub-mirror.c.163.com。</span>
<span class="token comment"># 3. max-concurrent-downloads: 用于设置同时下载镜像的最大数量，默认值为3，这里设置为10。</span>
<span class="token comment"># 4. log-driver: 用于设置Docker守护进程的日志驱动程序，这里设置为json-file。</span>
<span class="token comment"># 5. log-level: 用于设置日志的级别，这里设置为warn。</span>
<span class="token comment"># 6. log-opts: 用于设置日志驱动程序的选项，这里有两个选项：max-size和max-file。max-size表示每个日志文件的最大大小，这里设置为10m，max-file表示保存的最大日志文件数量，这里设置为3。</span>
<span class="token comment"># 7. data-root: 用于设置Docker守护进程的数据存储根目录，默认为/var/lib/docker，这里设置为/var/lib/docker。</span>

</code></pre> 
<h4><a id="226_docker_1575"></a>2.2.6 启动docker</h4> 
<pre><code class="prism language-shell"><span class="token function">groupadd</span> <span class="token function">docker</span>
<span class="token comment">#创建docker组</span>

systemctl daemon-reload
<span class="token comment"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span>

systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> docker.socket
<span class="token comment"># 启用并立即启动docker.socket单元。docker.socket是一个systemd的socket单元，用于接收来自网络的Docker API请求。</span>

systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> docker.service
<span class="token comment"># 启用并立即启动docker.service单元。docker.service是Docker守护进程的systemd服务单元。</span>

systemctl stop docker.service
<span class="token comment"># 停止运行中的docker.service单元，即停止Docker守护进程。</span>

systemctl start docker.service
<span class="token comment"># 启动docker.service单元，即启动Docker守护进程。</span>

systemctl restart docker.service
<span class="token comment"># 重启docker.service单元，即重新启动Docker守护进程。</span>

systemctl status docker.service
<span class="token comment"># 显示docker.service单元的当前状态，包括运行状态、是否启用等信息。</span>

<span class="token function">docker</span> info
<span class="token comment">#验证</span>
</code></pre> 
<h4><a id="227_cridocker_1606"></a>2.2.7 解压cri-docker</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 由于1.24以及更高版本不支持docker所以安装cri-docker</span>
<span class="token comment"># 下载cri-docker </span>
<span class="token comment"># https://github.com/Mirantis/cri-dockerd/releases/</span>
<span class="token comment"># wget  https://ghproxy.com/https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.4/cri-dockerd-0.3.4.amd64.tgz</span>

<span class="token comment"># 解压cri-docker</span>
<span class="token function">tar</span> xvf cri-dockerd-*.amd64.tgz 
<span class="token function">cp</span> <span class="token parameter variable">-r</span> cri-dockerd/  /usr/bin/
<span class="token function">chmod</span> +x /usr/bin/cri-dockerd/cri-dockerd
</code></pre> 
<h4><a id="228_cridocker_1620"></a>2.2.8 写入启动cri-docker配置文件</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 写入启动配置文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span>  /usr/lib/systemd/system/cri-docker.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=CRI Interface for Docker Application Container Engine
Documentation=https://docs.mirantis.com
After=network-online.target firewalld.service docker.service
Wants=network-online.target
Requires=cri-docker.socket

[Service]
Type=notify
ExecStart=/usr/bin/cri-dockerd/cri-dockerd --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.7
ExecReload=/bin/kill -s HUP <span class="token variable">$MAINPID</span>
TimeoutSec=0
RestartSec=2
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target
EOF</span>


<span class="token comment"># [Unit]</span>
<span class="token comment"># - Description：该参数用于描述该单元的功能，这里描述的是CRI与Docker应用容器引擎的接口。</span>
<span class="token comment"># - Documentation：该参数指定了相关文档的网址，供用户参考。</span>
<span class="token comment"># - After：该参数指定了此单元应该在哪些其他单元之后启动，确保在网络在线、防火墙和Docker服务启动之后再启动此单元。</span>
<span class="token comment"># - Wants：该参数指定了此单元希望也启动的所有单元，此处是希望在网络在线之后启动。</span>
<span class="token comment"># - Requires：该参数指定了此单元需要依赖的单元，此处是cri-docker.socket单元。</span>
<span class="token comment"># </span>
<span class="token comment"># [Service]</span>
<span class="token comment"># - Type：该参数指定了服务的类型，这里是notify，表示当服务启动完成时向系统发送通知。</span>
<span class="token comment"># - ExecStart：该参数指定了将要运行的命令和参数，此处是执行/usr/bin/cri-dockerd/cri-dockerd命令，并指定了网络插件为cni和Pod基础设施容器的镜像为registry.aliyuncs.com/google_containers/pause:3.7。</span>
<span class="token comment"># - ExecReload：该参数指定在服务重载时运行的命令，此处是发送HUP信号给主进程。</span>
<span class="token comment"># - TimeoutSec：该参数指定了服务启动的超时时间，此处为0，表示无限制。</span>
<span class="token comment"># - RestartSec：该参数指定了自动重启服务的时间间隔，此处为2秒。</span>
<span class="token comment"># - Restart：该参数指定了在服务发生错误时自动重启，此处是始终重启。</span>
<span class="token comment"># - StartLimitBurst：该参数指定了在给定时间间隔内允许的启动失败次数，此处为3次。</span>
<span class="token comment"># - StartLimitInterval：该参数指定启动失败的时间间隔，此处为60秒。</span>
<span class="token comment"># - LimitNOFILE：该参数指定了允许打开文件的最大数量，此处为无限制。</span>
<span class="token comment"># - LimitNPROC：该参数指定了允许同时运行的最大进程数，此处为无限制。</span>
<span class="token comment"># - LimitCORE：该参数指定了允许生成的core文件的最大大小，此处为无限制。</span>
<span class="token comment"># - TasksMax：该参数指定了此服务的最大任务数，此处为无限制。</span>
<span class="token comment"># - Delegate：该参数指定了是否将控制权委托给指定服务，此处为是。</span>
<span class="token comment"># - KillMode：该参数指定了在终止服务时如何处理进程，此处是通过终止进程来终止服务。</span>
<span class="token comment"># </span>
<span class="token comment"># [Install]</span>
<span class="token comment"># - WantedBy：该参数指定了希望这个单元启动的多用户目标。在这里，这个单元希望在multi-user.target启动。</span>
</code></pre> 
<h4><a id="229_cridockersocket_1680"></a>2.2.9 写入cri-docker的socket配置文件</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 写入socket配置文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/cri-docker.socket <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=CRI Docker Socket for the API
PartOf=cri-docker.service

[Socket]
ListenStream=%t/cri-dockerd.sock
SocketMode=0660
SocketUser=root
SocketGroup=docker

[Install]
WantedBy=sockets.target
EOF</span>


<span class="token comment"># 该配置文件是用于systemd的单元配置文件(unit file)，用于定义一个socket单元。</span>
<span class="token comment"># </span>
<span class="token comment"># [Unit]</span>
<span class="token comment"># - Description：表示该单元的描述信息。</span>
<span class="token comment"># - PartOf：表示该单元是cri-docker.service的一部分。</span>
<span class="token comment"># </span>
<span class="token comment"># [Socket]</span>
<span class="token comment"># - ListenStream：指定了该socket要监听的地址和端口，这里使用了%t占位符，表示根据单元的类型来决定路径。%t/cri-dockerd.sock表示将监听Unix域套接字cri-dockerd.sock。Unix域套接字用于在同一台主机上的进程之间通信。</span>
<span class="token comment"># - SocketMode：指定了socket文件的权限模式，此处为0660，即用户和用户组有读写权限，其他用户无权限。</span>
<span class="token comment"># - SocketUser：指定了socket文件的所有者，此处为root用户。</span>
<span class="token comment"># - SocketGroup：指定了socket文件的所属用户组，此处为docker用户组。</span>
<span class="token comment"># </span>
<span class="token comment"># [Install]</span>
<span class="token comment"># - WantedBy：部分定义了该单元的安装配置信息。WantedBy=sockets.target表示当sockets.target单元启动时，自动启动该socket单元。sockets.target是一个系统服务，用于管理所有的socket单元。</span>
</code></pre> 
<h4><a id="2210_cridocker_1716"></a>2.2.10 启动cri-docker</h4> 
<pre><code class="prism language-shell">systemctl daemon-reload
<span class="token comment"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span>

systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> cri-docker.service
<span class="token comment"># 启用并立即启动cri-docker.service单元。cri-docker.service是cri-docker守护进程的systemd服务单元。</span>

systemctl restart cri-docker.service
<span class="token comment"># 重启cri-docker.service单元，即重新启动cri-docker守护进程。</span>

systemctl status docker.service
<span class="token comment"># 显示docker.service单元的当前状态，包括运行状态、是否启用等信息。</span>
</code></pre> 
<h3><a id="23k8setcdmaster01_1734"></a>2.3.k8s与etcd下载及安装（仅在master01操作）</h3> 
<h4><a id="231_k8s_1736"></a>2.3.1 解压k8s安装包</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 下载安装包</span>
<span class="token comment"># wget https://ghproxy.com/https://github.com/etcd-io/etcd/releases/download/v3.5.9/etcd-v3.5.9-linux-amd64.tar.gz</span>
<span class="token comment"># wget https://storage.googleapis.com/kubernetes-release/release/v1.28.0/kubernetes-server-linux-amd64.tar.gz</span>

<span class="token comment"># 解压k8s安装文件</span>
<span class="token builtin class-name">cd</span> ~/lzb
<span class="token function">tar</span> <span class="token parameter variable">-xf</span> kubernetes-server-linux-amd64.tar.gz  --strip-components<span class="token operator">=</span><span class="token number">3</span> <span class="token parameter variable">-C</span> /usr/local/bin kubernetes/server/bin/kube<span class="token punctuation">{<!-- --></span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class="token punctuation">}</span>

<span class="token comment"># 这是一个tar命令，用于解压指定的kubernetes-server-linux-amd64.tar.gz文件，并将其中的特定文件提取到/usr/local/bin目录下。</span>
<span class="token comment"># </span>
<span class="token comment"># 命令的解释如下：</span>
<span class="token comment"># - tar：用于处理tar压缩文件的命令。</span>
<span class="token comment"># - -xf：表示解压操作。</span>
<span class="token comment"># - kubernetes-server-linux-amd64.tar.gz：要解压的文件名。</span>
<span class="token comment"># - --strip-components=3：表示解压时忽略压缩文件中的前3级目录结构，提取文件时直接放到目标目录中。</span>
<span class="token comment"># - -C /usr/local/bin：指定提取文件的目标目录为/usr/local/bin。</span>
<span class="token comment"># - kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}：要解压和提取的文件名模式，用花括号括起来表示模式中的多个可能的文件名。</span>
<span class="token comment"># </span>
<span class="token comment"># 总的来说，这个命令的作用是将kubernetes-server-linux-amd64.tar.gz文件中的kubelet、kubectl、kube-apiserver、kube-controller-manager、kube-scheduler和kube-proxy六个文件提取到/usr/local/bin目录下，同时忽略文件路径中的前三级目录结构。</span>


<span class="token comment"># 解压etcd安装文件</span>
<span class="token function">tar</span> <span class="token parameter variable">-xf</span> etcd*.tar.gz <span class="token operator">&amp;&amp;</span> <span class="token function">mv</span> etcd-*/etcd /usr/local/bin/ <span class="token operator">&amp;&amp;</span> <span class="token function">mv</span> etcd-*/etcdctl /usr/local/bin/

<span class="token comment"># 这是一个将文件解压并移动到特定目录的命令。这是一个用于 Linux 系统中的命令。</span>
<span class="token comment"># </span>
<span class="token comment"># - tar -xf etcd*.tar.gz：这个命令将解压以 etcd 开头并以.tar.gz 结尾的文件。`-xf` 是使用 `tar` 命令的选项，它表示解压文件并展开其中的内容。</span>
<span class="token comment"># - mv etcd-*/etcd /usr/local/bin/：这个命令将 etcd 文件移动到 /usr/local/bin 目录。`mv` 是移动命令，它将 etcd-*/etcd 路径下的 etcd 文件移动到了 /usr/local/bin 目录。</span>
<span class="token comment"># - mv etcd-*/etcdctl /usr/local/bin/：这个命令将 etcdctl 文件移动到 /usr/local/bin 目录，和上一条命令类似。</span>
<span class="token comment"># </span>
<span class="token comment"># 总结起来，以上命令将从名为 etcd*.tar.gz 的压缩文件中解压出 etcd 和 etcdctl 文件，并将它们移动到 /usr/local/bin 目录中。</span>

<span class="token comment"># 查看/usr/local/bin下内容</span>
<span class="token function">ls</span> /usr/local/bin/
containerd               crictl       etcdctl                  kube-proxy
containerd-shim          critest      kube-apiserver           kube-scheduler
containerd-shim-runc-v1  ctd-decoder  kube-controller-manager
containerd-shim-runc-v2  ctr          kubectl
containerd-stress        etcd         kubelet
</code></pre> 
<h4><a id="232__1780"></a>2.3.2 查看版本</h4> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#  kubelet --version</span>
Kubernetes v1.28.0
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># etcdctl version</span>
etcdctl version: <span class="token number">3.5</span>.9
API version: <span class="token number">3.5</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># </span>
</code></pre> 
<h4><a id="233_k8s_1791"></a>2.3.3 将组件发送至其他k8s节点</h4> 
<pre><code class="prism language-shell"><span class="token assign-left variable">Master</span><span class="token operator">=</span><span class="token string">'k8s-master02 k8s-master03'</span>
<span class="token assign-left variable">Work</span><span class="token operator">=</span><span class="token string">'k8s-node01 k8s-node02'</span>

<span class="token comment"># 拷贝master组件（提示输入yes）</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$Master</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$NODE</span><span class="token punctuation">;</span> <span class="token function">scp</span> /usr/local/bin/kube<span class="token punctuation">{<!-- --></span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class="token punctuation">}</span> <span class="token variable">$NODE</span>:/usr/local/bin/<span class="token punctuation">;</span> <span class="token function">scp</span> /usr/local/bin/etcd* <span class="token variable">$NODE</span>:/usr/local/bin/<span class="token punctuation">;</span> <span class="token keyword">done</span>

<span class="token comment"># 该命令是一个for循环，对于在$Master变量中的每个节点，执行以下操作：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. 打印出节点的名称。</span>
<span class="token comment"># 2. 使用scp命令将/usr/local/bin/kubelet、kubectl、kube-apiserver、kube-controller-manager、kube-scheduler和kube-proxy文件复制到节点的/usr/local/bin/目录下。</span>
<span class="token comment"># 3. 使用scp命令将/usr/local/bin/etcd*文件复制到节点的/usr/local/bin/目录下。</span>


<span class="token comment"># 拷贝work组件（提示输入yes）</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$Work</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$NODE</span><span class="token punctuation">;</span> <span class="token function">scp</span> /usr/local/bin/kube<span class="token punctuation">{<!-- --></span>let,-proxy<span class="token punctuation">}</span> <span class="token variable">$NODE</span>:/usr/local/bin/ <span class="token punctuation">;</span> <span class="token keyword">done</span>
<span class="token comment"># 该命令是一个for循环，对于在$Master变量中的每个节点，执行以下操作：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. 打印出节点的名称。</span>
<span class="token comment"># 2. 使用scp命令将/usr/local/bin/kubelet和kube-proxy文件复制到节点的/usr/local/bin/目录下。</span>
</code></pre> 
<h3><a id="23_tar_1815"></a>2.3 创建证书相关文件(获取打包后文件的tar包)</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 请查看Github仓库 或者进行获取已经打好的包(下载下来是所有的准备好的文件，省去你一个个下载)</span>
https://github.com/cby-chen/Kubernetes/
https://github.com/cby-chen/Kubernetes/tags
https://github.com/cby-chen/Kubernetes/releases/download/v1.27.3/kubernetes-v1.27.3.tar
</code></pre> 
<h2><a id="3_1824"></a>3.相关证书生成</h2> 
<blockquote> 
 <p>master01节点执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># master01节点下载证书生成工具</span>
<span class="token comment"># wget "https://ghproxy.com/https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssl_1.6.4_linux_amd64" -O /usr/local/bin/cfssl</span>
<span class="token comment"># wget "https://ghproxy.com/https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssljson_1.6.4_linux_amd64" -O /usr/local/bin/cfssljson</span>

<span class="token comment"># 软件包内有</span>
<span class="token function">cp</span> cfssl_*_linux_amd64 /usr/local/bin/cfssl
<span class="token function">cp</span> cfssljson_*_linux_amd64 /usr/local/bin/cfssljson

<span class="token comment"># 添加执行权限</span>
<span class="token function">chmod</span> +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
</code></pre> 
<h3><a id="31etcd_1841"></a>3.1.生成etcd证书</h3> 
<h4><a id="311_master_1843"></a>3.1.1 所有master节点创建证书存放目录</h4> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> /etc/etcd/ssl <span class="token parameter variable">-p</span>
</code></pre> 
<h4><a id="312_master01etcd_1849"></a>3.1.2 master01节点生成etcd证书</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 写入生成证书所需的配置文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> ca-config.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  "signing": {
    "default": {
      "expiry": "876000h"
    },
    "profiles": {
      "kubernetes": {
        "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ],
        "expiry": "876000h"
      }
    }
  }
}
EOF</span>
<span class="token comment"># 这段配置文件是用于配置加密和认证签名的一些参数。</span>
<span class="token comment"># </span>
<span class="token comment"># 在这里，有两个部分：`signing`和`profiles`。</span>
<span class="token comment"># </span>
<span class="token comment"># `signing`包含了默认签名配置和配置文件。</span>
<span class="token comment"># 默认签名配置`default`指定了证书的过期时间为`876000h`。`876000h`表示证书有效期为100年。</span>
<span class="token comment"># </span>
<span class="token comment"># `profiles`部分定义了不同的证书配置文件。</span>
<span class="token comment"># 在这里，只有一个配置文件`kubernetes`。它包含了以下`usages`和过期时间`expiry`：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. `signing`：用于对其他证书进行签名</span>
<span class="token comment"># 2. `key encipherment`：用于加密和解密传输数据</span>
<span class="token comment"># 3. `server auth`：用于服务器身份验证</span>
<span class="token comment"># 4. `client auth`：用于客户端身份验证</span>
<span class="token comment"># </span>
<span class="token comment"># 对于`kubernetes`配置文件，证书的过期时间也是`876000h`，即100年。</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> etcd-ca-csr.json  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  "CN": "etcd",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "etcd",
      "OU": "Etcd Security"
    }
  ],
  "ca": {
    "expiry": "876000h"
  }
}
EOF</span>
<span class="token comment"># 这是一个用于生成证书签名请求（Certificate Signing Request，CSR）的JSON配置文件。JSON配置文件指定了生成证书签名请求所需的数据。</span>
<span class="token comment"># </span>
<span class="token comment"># - "CN": "etcd" 指定了希望生成的证书的CN字段（Common Name），即证书的主题，通常是该证书标识的实体的名称。</span>
<span class="token comment"># - "key": {} 指定了生成证书所使用的密钥的配置信息。"algo": "rsa" 指定了密钥的算法为RSA，"size": 2048 指定了密钥的长度为2048位。</span>
<span class="token comment"># - "names": [] 包含了生成证书时所需的实体信息。在这个例子中，只包含了一个实体，其相关信息如下：</span>
<span class="token comment">#   - "C": "CN" 指定了实体的国家/地区代码，这里是中国。</span>
<span class="token comment">#   - "ST": "Beijing" 指定了实体所在的省/州。</span>
<span class="token comment">#   - "L": "Beijing" 指定了实体所在的城市。</span>
<span class="token comment">#   - "O": "etcd" 指定了实体的组织名称。</span>
<span class="token comment">#   - "OU": "Etcd Security" 指定了实体所属的组织单位。</span>
<span class="token comment"># - "ca": {} 指定了生成证书时所需的CA（Certificate Authority）配置信息。</span>
<span class="token comment">#   - "expiry": "876000h" 指定了证书的有效期，这里是876000小时。</span>
<span class="token comment"># </span>
<span class="token comment"># 生成证书签名请求时，可以使用这个JSON配置文件作为输入，根据配置文件中的信息生成相应的CSR文件。然后，可以将CSR文件发送给CA进行签名，以获得有效的证书。</span>

<span class="token comment"># 生成etcd证书和etcd证书的key（如果你觉得以后可能会扩容，可以在ip那多写几个预留出来）</span>
<span class="token comment"># 若没有IPv6 可删除可保留 </span>

cfssl gencert <span class="token parameter variable">-initca</span> etcd-ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/etcd/ssl/etcd-ca
<span class="token comment"># 具体的解释如下：</span>
<span class="token comment"># </span>
<span class="token comment"># cfssl是一个用于生成TLS/SSL证书的工具，它支持PKI、JSON格式配置文件以及与许多其他集成工具的配合使用。</span>
<span class="token comment"># </span>
<span class="token comment"># gencert参数表示生成证书的操作。-initca参数表示初始化一个CA（证书颁发机构）。CA是用于签发其他证书的根证书。etcd-ca-csr.json是一个JSON格式的配置文件，其中包含了CA的详细信息，如私钥、公钥、有效期等。这个文件提供了生成CA证书所需的信息。</span>
<span class="token comment"># </span>
<span class="token comment"># | 符号表示将上一个命令的输出作为下一个命令的输入。</span>
<span class="token comment"># </span>
<span class="token comment"># cfssljson是cfssl工具的一个子命令，用于格式化cfssl生成的JSON数据。 -bare参数表示直接输出裸证书，即只生成证书文件，不包含其他格式的文件。/etc/etcd/ssl/etcd-ca是指定生成的证书文件的路径和名称。</span>
<span class="token comment"># </span>
<span class="token comment"># 所以，这条命令的含义是使用cfssl工具根据配置文件ca-csr.json生成一个CA证书，并将证书文件保存在/etc/etcd/ssl/etcd-ca路径下。</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> etcd-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  "CN": "etcd",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "etcd",
      "OU": "Etcd Security"
    }
  ]
}
EOF</span>
<span class="token comment"># 这段代码是一个JSON格式的配置文件，用于生成一个证书签名请求（Certificate Signing Request，CSR）。</span>
<span class="token comment"># </span>
<span class="token comment"># 首先，"CN"字段指定了该证书的通用名称（Common Name），这里设为"etcd"。</span>
<span class="token comment"># </span>
<span class="token comment"># 接下来，"key"字段指定了密钥的算法（"algo"字段）和长度（"size"字段），此处使用的是RSA算法，密钥长度为2048位。</span>
<span class="token comment"># </span>
<span class="token comment"># 最后，"names"字段是一个数组，其中包含了一个名字对象，用于指定证书中的一些其他信息。这个名字对象包含了以下字段：</span>
<span class="token comment"># - "C"字段指定了国家代码（Country），这里设置为"CN"。</span>
<span class="token comment"># - "ST"字段指定了省份（State）或地区，这里设置为"Beijing"。</span>
<span class="token comment"># - "L"字段指定了城市（Locality），这里设置为"Beijing"。</span>
<span class="token comment"># - "O"字段指定了组织（Organization），这里设置为"etcd"。</span>
<span class="token comment"># - "OU"字段指定了组织单元（Organizational Unit），这里设置为"Etcd Security"。</span>
<span class="token comment"># </span>
<span class="token comment"># 这些字段将作为证书的一部分，用于标识和验证证书的使用范围和颁发者等信息。</span>

cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-hostname</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.0.31,192.168.0.32,192.168.0.33 <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   etcd-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/etcd/ssl/etcd
<span class="token comment"># 这是一条使用cfssl生成etcd证书的命令，下面是各个参数的解释：</span>
<span class="token comment"># </span>
<span class="token comment"># -ca=/etc/etcd/ssl/etcd-ca.pem：指定用于签名etcd证书的CA文件的路径。</span>
<span class="token comment"># -ca-key=/etc/etcd/ssl/etcd-ca-key.pem：指定用于签名etcd证书的CA私钥文件的路径。</span>
<span class="token comment"># -config=ca-config.json：指定CA配置文件的路径，该文件定义了证书的有效期、加密算法等设置。</span>
<span class="token comment"># -hostname=xxxx：指定要为etcd生成证书的主机名和IP地址列表。</span>
<span class="token comment"># -profile=kubernetes：指定使用的证书配置文件，该文件定义了证书的用途和扩展属性。</span>
<span class="token comment"># etcd-csr.json：指定etcd证书请求的JSON文件的路径，该文件包含了证书请求的详细信息。</span>
<span class="token comment"># | cfssljson -bare /etc/etcd/ssl/etcd：通过管道将cfssl命令的输出传递给cfssljson命令，并使用-bare参数指定输出文件的前缀路径，这里将生成etcd证书的.pem和-key.pem文件。</span>
<span class="token comment"># </span>
<span class="token comment"># 这条命令的作用是使用指定的CA证书和私钥，根据证书请求的JSON文件和配置文件生成etcd的证书文件。</span>
</code></pre> 
<h4><a id="313__1995"></a>3.1.3 将证书复制到其他节点</h4> 
<blockquote> 
 <p>master01节点操作</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token assign-left variable">Master</span><span class="token operator">=</span><span class="token string">'k8s-master02 k8s-master03'</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$Master</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">ssh</span> <span class="token variable">$NODE</span> <span class="token string">"mkdir -p /etc/etcd/ssl"</span><span class="token punctuation">;</span> <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">scp</span> /etc/etcd/ssl/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/etcd/ssl/<span class="token variable">${FILE}</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span class="token punctuation">;</span> <span class="token keyword">done</span>

<span class="token comment"># 这个命令是一个简单的for循环，在一个由`$Master`存储的主机列表中迭代执行。对于每个主机，它使用`ssh`命令登录到主机，并在远程主机上创建一个名为`/etc/etcd/ssl`的目录（如果不存在）。接下来，它使用`scp`将本地主机上`/etc/etcd/ssl`目录中的四个文件（`etcd-ca-key.pem`，`etcd-ca.pem`，`etcd-key.pem`和`etcd.pem`）复制到远程主机的`/etc/etcd/ssl`目录中。最终的结果是，远程主机上的`/etc/etcd/ssl`目录中包含与本地主机上相同的四个文件的副本。</span>
</code></pre> 
<h3><a id="32k8s_2006"></a>3.2.生成k8s相关证书</h3> 
<h4><a id="321_k8smasterslave_2008"></a>3.2.1 所有k8s节点(master+slave节点)创建证书存放目录</h4> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/pki
</code></pre> 
<h4><a id="322_master01k8s_2014"></a>3.2.2 master01节点生成k8s证书</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 写入生成证书所需的配置文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> ca-csr.json   <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  "CN": "kubernetes",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "Kubernetes",
      "OU": "Kubernetes-manual"
    }
  ],
  "ca": {
    "expiry": "876000h"
  }
}
EOF</span>
<span class="token comment"># 这是一个用于生成 Kubernetes 相关证书的配置文件。该配置文件中包含以下信息：</span>
<span class="token comment"># </span>
<span class="token comment"># - CN：CommonName，即用于标识证书的通用名称。在此配置中，CN 设置为 "kubernetes"，表示该证书是用于 Kubernetes。</span>
<span class="token comment"># - key：用于生成证书的算法和大小。在此配置中，使用的算法是 RSA，大小是 2048 位。</span>
<span class="token comment"># - names：用于证书中的名称字段的详细信息。在此配置中，有以下字段信息：</span>
<span class="token comment">#   - C：Country，即国家。在此配置中，设置为 "CN"。</span>
<span class="token comment">#   - ST：State，即省/州。在此配置中，设置为 "Beijing"。</span>
<span class="token comment">#   - L：Locality，即城市。在此配置中，设置为 "Beijing"。</span>
<span class="token comment">#   - O：Organization，即组织。在此配置中，设置为 "Kubernetes"。</span>
<span class="token comment">#   - OU：Organization Unit，即组织单位。在此配置中，设置为 "Kubernetes-manual"。</span>
<span class="token comment"># - ca：用于证书签名的证书颁发机构（CA）的配置信息。在此配置中，设置了证书的有效期为 876000 小时。</span>
<span class="token comment"># </span>
<span class="token comment"># 这个配置文件可以用于生成 Kubernetes 相关的证书，以确保集群中的通信安全性。</span>

cfssl gencert <span class="token parameter variable">-initca</span> ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/ca

<span class="token comment"># 具体的解释如下：</span>
<span class="token comment"># </span>
<span class="token comment"># cfssl是一个用于生成TLS/SSL证书的工具，它支持PKI、JSON格式配置文件以及与许多其他集成工具的配合使用。</span>
<span class="token comment"># </span>
<span class="token comment"># gencert参数表示生成证书的操作。-initca参数表示初始化一个CA（证书颁发机构）。CA是用于签发其他证书的根证书。ca-csr.json是一个JSON格式的配置文件，其中包含了CA的详细信息，如私钥、公钥、有效期等。这个文件提供了生成CA证书所需的信息。</span>
<span class="token comment"># </span>
<span class="token comment"># | 符号表示将上一个命令的输出作为下一个命令的输入。</span>
<span class="token comment"># </span>
<span class="token comment"># cfssljson是cfssl工具的一个子命令，用于格式化cfssl生成的JSON数据。 -bare参数表示直接输出裸证书，即只生成证书文件，不包含其他格式的文件。/etc/kubernetes/pki/ca是指定生成的证书文件的路径和名称。</span>
<span class="token comment"># </span>
<span class="token comment"># 所以，这条命令的含义是使用cfssl工具根据配置文件ca-csr.json生成一个CA证书，并将证书文件保存在/etc/kubernetes/pki/ca路径下。</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> apiserver-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  "CN": "kube-apiserver",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "Kubernetes",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF</span>

<span class="token comment"># 这是一个用于生成 Kubernetes 相关证书的配置文件。该配置文件中包含以下信息：</span>
<span class="token comment"># </span>
<span class="token comment"># - `CN` 字段指定了证书的通用名称 (Common Name)，这里设置为 "kube-apiserver"，表示该证书用于 Kubernetes API Server。</span>
<span class="token comment"># - `key` 字段指定了生成证书时所选用的加密算法和密钥长度。这里选用了 RSA 算法，密钥长度为 2048 位。</span>
<span class="token comment"># - `names` 字段包含了一组有关证书持有者信息的项。这里使用了以下信息：</span>
<span class="token comment">#   - `C` 表示国家代码 (Country)，这里设置为 "CN" 表示中国。</span>
<span class="token comment">#   - `ST` 表示州或省份 (State)，这里设置为 "Beijing" 表示北京市。</span>
<span class="token comment">#   - `L` 表示城市或地区 (Location)，这里设置为 "Beijing" 表示北京市。</span>
<span class="token comment">#   - `O` 表示组织名称 (Organization)，这里设置为 "Kubernetes" 表示 Kubernetes。</span>
<span class="token comment">#   - `OU` 表示组织单位 (Organizational Unit)，这里设置为 "Kubernetes-manual" 表示手动管理的 Kubernetes 集群。</span>
<span class="token comment"># </span>
<span class="token comment"># 这个配置文件可以用于生成 Kubernetes 相关的证书，以确保集群中的通信安全性。</span>


<span class="token comment"># 生成一个根证书 ，多写了一些IP作为预留IP，为将来添加node做准备</span>
<span class="token comment"># 10.96.0.1是service网段的第一个地址，需要计算，192.168.0.36为高可用vip地址</span>
<span class="token comment"># 若没有IPv6 可删除可保留 </span>

cfssl gencert   <span class="token punctuation">\</span>
<span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem   <span class="token punctuation">\</span>
-ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem   <span class="token punctuation">\</span>
<span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json   <span class="token punctuation">\</span>
<span class="token parameter variable">-hostname</span><span class="token operator">=</span><span class="token number">10.96</span>.0.1,192.168.0.36,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.0.31,192.168.0.32,192.168.0.33,192.168.0.34,192.168.0.35,192.168.0.36,192.168.0.37,192.168.0.38,192.168.0.39  <span class="token punctuation">\</span>
<span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes   apiserver-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/apiserver

<span class="token comment"># 这个命令是使用cfssl工具生成Kubernetes API Server的证书。</span>
<span class="token comment"># </span>
<span class="token comment"># 命令的参数解释如下：</span>
<span class="token comment"># - `-ca=/etc/kubernetes/pki/ca.pem`：指定证书的颁发机构（CA）文件路径。</span>
<span class="token comment"># - `-ca-key=/etc/kubernetes/pki/ca-key.pem`：指定证书的颁发机构（CA）私钥文件路径。</span>
<span class="token comment"># - `-config=ca-config.json`：指定证书生成的配置文件路径，配置文件中包含了证书的有效期、加密算法等信息。</span>
<span class="token comment"># - `-hostname=10.96.0.1,192.168.0.36,127.0.0.1,fc00:43f4:1eea:1::10`：指定证书的主机名或IP地址列表。</span>
<span class="token comment"># - `-profile=kubernetes`：指定证书生成的配置文件中的配置文件名。</span>
<span class="token comment"># - `apiserver-csr.json`：API Server的证书签名请求配置文件路径。</span>
<span class="token comment"># - `| cfssljson -bare /etc/kubernetes/pki/apiserver`：通过管道将生成的证书输出到cfssljson工具，将其转换为PEM编码格式，并保存到 `/etc/kubernetes/pki/apiserver.pem` 和 `/etc/kubernetes/pki/apiserver-key.pem` 文件中。</span>
<span class="token comment"># </span>
<span class="token comment"># 最终，这个命令将会生成API Server的证书和私钥，并保存到指定的文件中。</span>

</code></pre> 
<h4><a id="323_master01apiserver_2126"></a>3.2.3 master01节点生成apiserver聚合证书</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> front-proxy-ca-csr.json  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  "CN": "kubernetes",
  "key": {
     "algo": "rsa",
     "size": 2048
  },
  "ca": {
    "expiry": "876000h"
  }
}
EOF</span>

<span class="token comment"># 这个JSON文件表示了生成一个名为"kubernetes"的证书的配置信息。这个证书是用来进行Kubernetes集群的身份验证和安全通信。</span>
<span class="token comment"># </span>
<span class="token comment"># 配置信息包括以下几个部分：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. "CN": "kubernetes"：这表示了证书的通用名称（Common Name），也就是证书所代表的实体的名称。在这里，证书的通用名称被设置为"kubernetes"，表示这个证书是用来代表Kubernetes集群。</span>
<span class="token comment"># </span>
<span class="token comment"># 2. "key"：这是用来生成证书的密钥相关的配置。在这里，配置使用了RSA算法，并且设置了密钥的大小为2048位。</span>
<span class="token comment"># </span>
<span class="token comment"># 3. "ca"：这个字段指定了证书的颁发机构（Certificate Authority）相关的配置。在这里，配置指定了证书的有效期为876000小时，即100年。这意味着该证书在100年内将被视为有效，过期后需要重新生成。</span>
<span class="token comment"># </span>
<span class="token comment"># 总之，这个JSON文件中的配置信息描述了如何生成一个用于Kubernetes集群的证书，包括证书的通用名称、密钥算法和大小以及证书的有效期。</span>

cfssl gencert   <span class="token parameter variable">-initca</span> front-proxy-ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/front-proxy-ca 
<span class="token comment"># 具体的解释如下：</span>
<span class="token comment"># </span>
<span class="token comment"># cfssl是一个用于生成TLS/SSL证书的工具，它支持PKI、JSON格式配置文件以及与许多其他集成工具的配合使用。</span>
<span class="token comment"># </span>
<span class="token comment"># gencert参数表示生成证书的操作。-initca参数表示初始化一个CA（证书颁发机构）。CA是用于签发其他证书的根证书。front-proxy-ca-csr.json是一个JSON格式的配置文件，其中包含了CA的详细信息，如私钥、公钥、有效期等。这个文件提供了生成CA证书所需的信息。</span>
<span class="token comment"># </span>
<span class="token comment"># | 符号表示将上一个命令的输出作为下一个命令的输入。</span>
<span class="token comment"># </span>
<span class="token comment"># cfssljson是cfssl工具的一个子命令，用于格式化cfssl生成的JSON数据。 -bare参数表示直接输出裸证书，即只生成证书文件，不包含其他格式的文件。/etc/kubernetes/pki/front-proxy-ca是指定生成的证书文件的路径和名称。</span>
<span class="token comment"># </span>
<span class="token comment"># 所以，这条命令的含义是使用cfssl工具根据配置文件ca-csr.json生成一个CA证书，并将证书文件保存在/etc/kubernetes/pki/front-proxy-ca路径下。</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> front-proxy-client-csr.json  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  "CN": "front-proxy-client",
  "key": {
     "algo": "rsa",
     "size": 2048
  }
}
EOF</span>

<span class="token comment"># 这是一个JSON格式的配置文件，用于描述一个名为"front-proxy-client"的配置。配置包括两个字段：CN和key。</span>
<span class="token comment"># </span>
<span class="token comment"># - CN（Common Name）字段表示证书的通用名称，这里为"front-proxy-client"。</span>
<span class="token comment"># - key字段描述了密钥的算法和大小。"algo"表示使用RSA算法，"size"表示密钥大小为2048位。</span>
<span class="token comment"># </span>
<span class="token comment"># 该配置文件用于生成一个SSL证书，用于在前端代理客户端进行认证和数据传输的加密。这个证书中的通用名称是"front-proxy-client"，使用RSA算法生成，密钥大小为2048位。</span>

cfssl gencert  <span class="token punctuation">\</span>
<span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem   <span class="token punctuation">\</span>
-ca-key<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca-key.pem   <span class="token punctuation">\</span>
<span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json   <span class="token punctuation">\</span>
<span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes   front-proxy-client-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/front-proxy-client

<span class="token comment"># 这个命令使用cfssl工具生成一个用于Kubernetes的front-proxy-client证书。</span>
<span class="token comment"># </span>
<span class="token comment"># 主要参数解释如下：</span>
<span class="token comment"># - `-ca=/etc/kubernetes/pki/front-proxy-ca.pem`: 指定用于签署证书的根证书文件路径。</span>
<span class="token comment"># - `-ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem`: 指定用于签署证书的根证书的私钥文件路径。</span>
<span class="token comment"># - `-config=ca-config.json`: 指定用于配置证书签署的配置文件路径。该配置文件描述了证书生成的一些规则，如加密算法和有效期等。</span>
<span class="token comment"># - `-profile=kubernetes`: 指定生成证书时使用的配置文件中定义的profile，其中包含了一些默认的参数。</span>
<span class="token comment"># - `front-proxy-client-csr.json`: 指定用于生成证书的CSR文件路径，该文件包含了证书请求的相关信息。</span>
<span class="token comment"># - `| cfssljson -bare /etc/kubernetes/pki/front-proxy-client`: 通过管道将生成的证书输出到cfssljson工具进行解析，并通过`-bare`参数将证书和私钥分别保存到指定路径。</span>
<span class="token comment"># </span>
<span class="token comment"># 这个命令的作用是根据提供的CSR文件和配置信息，使用指定的根证书和私钥生成一个前端代理客户端的证书，并将证书和私钥分别保存到`/etc/kubernetes/pki/front-proxy-client.pem`和`/etc/kubernetes/pki/front-proxy-client-key.pem`文件中。</span>
</code></pre> 
<h4><a id="324_master01controllermanage_2203"></a>3.2.4 master01节点生成controller-manage的证书</h4> 
<p>在《5.高可用配置》选择使用那种高可用方案<br> 若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.0.36:9443</code><br> 若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> manager-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  "CN": "system:kube-controller-manager",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:kube-controller-manager",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF</span>
<span class="token comment"># 这是一个用于生成密钥对（公钥和私钥）的JSON配置文件。下面是针对该文件中每个字段的详细解释：</span>
<span class="token comment"># </span>
<span class="token comment"># - "CN": 值为"system:kube-controller-manager"，代表通用名称（Common Name），是此密钥对的主题（subject）。</span>
<span class="token comment"># - "key": 这个字段用来定义密钥算法和大小。</span>
<span class="token comment">#   - "algo": 值为"rsa"，表示使用RSA算法。</span>
<span class="token comment">#   - "size": 值为2048，表示生成的密钥大小为2048位。</span>
<span class="token comment"># - "names": 这个字段用来定义密钥对的各个名称字段。</span>
<span class="token comment">#   - "C": 值为"CN"，表示国家（Country）名称是"CN"（中国）。</span>
<span class="token comment">#   - "ST": 值为"Beijing"，表示省/州（State/Province）名称是"Beijing"（北京）。</span>
<span class="token comment">#   - "L": 值为"Beijing"，表示城市（Locality）名称是"Beijing"（北京）。</span>
<span class="token comment">#   - "O": 值为"system:kube-controller-manager"，表示组织（Organization）名称是"system:kube-controller-manager"。</span>
<span class="token comment">#   - "OU": 值为"Kubernetes-manual"，表示组织单位（Organizational Unit）名称是"Kubernetes-manual"。</span>
<span class="token comment"># </span>
<span class="token comment"># 这个JSON配置文件基本上是告诉生成密钥对的工具，生成一个带有特定名称和属性的密钥对。</span>


cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   manager-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/controller-manager
<span class="token comment"># 这是一个命令行操作，使用cfssl工具生成证书。</span>
<span class="token comment"># </span>
<span class="token comment"># 1. `cfssl gencert` 是cfssl工具的命令，用于生成证书。</span>
<span class="token comment"># 2. `-ca` 指定根证书的路径和文件名，这里是`/etc/kubernetes/pki/ca.pem`。</span>
<span class="token comment"># 3. `-ca-key` 指定根证书的私钥的路径和文件名，这里是`/etc/kubernetes/pki/ca-key.pem`。</span>
<span class="token comment"># 4. `-config` 指定配置文件的路径和文件名，这里是`ca-config.json`。</span>
<span class="token comment"># 5. `-profile` 指定证书使用的配置文件中的配置模板，这里是`kubernetes`。</span>
<span class="token comment"># 6. `manager-csr.json` 是证书签发请求的配置文件，用于生成证书签发请求。</span>
<span class="token comment"># 7. `|` 管道操作符，将前一条命令的输出作为后一条命令的输入。</span>
<span class="token comment"># 8. `cfssljson -bare` 是 cfssl 工具的命令，作用是将证书签发请求的输出转换为PKCS＃1、PKCS＃8和x509 PEM文件。</span>
<span class="token comment"># 9. `/etc/kubernetes/pki/controller-manager` 是转换后的 PEM 文件的存储位置和文件名。</span>
<span class="token comment"># </span>
<span class="token comment"># 这个命令的作用是根据根证书和私钥、配置文件以及证书签发请求的配置文件，生成经过签发的控制器管理器证书和私钥，并将转换后的 PEM 文件保存到指定的位置。</span>


<span class="token comment"># 设置一个集群项</span>
<span class="token comment"># 在《5.高可用配置》选择使用那种高可用方案</span>
<span class="token comment"># 若使用 haproxy、keepalived 那么为 `--server=https://192.168.0.36:8443`</span>
<span class="token comment"># 若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>
kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://127.0.0.1:8443 <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig
<span class="token comment"># kubectl config set-cluster命令用于配置集群信息。</span>
<span class="token comment"># --certificate-authority选项指定了集群的证书颁发机构（CA）的路径，这个CA会验证kube-apiserver提供的证书是否合法。</span>
<span class="token comment"># --embed-certs选项用于将证书嵌入到生成的kubeconfig文件中，这样就不需要在kubeconfig文件中单独指定证书文件路径。</span>
<span class="token comment"># --server选项指定了kube-apiserver的地址，这里使用的是127.0.0.1:8443，表示使用本地主机上的kube-apiserver，默认端口为8443。</span>
<span class="token comment"># --kubeconfig选项指定了生成的kubeconfig文件的路径和名称，这里指定为/etc/kubernetes/controller-manager.kubeconfig。</span>
<span class="token comment"># 综上所述，kubectl config set-cluster命令的作用是在kubeconfig文件中设置集群信息，包括证书颁发机构、证书、kube-apiserver地址等。</span>


<span class="token comment"># 设置一个环境项，一个上下文</span>
kubectl config set-context system:kube-controller-manager@kubernetes <span class="token punctuation">\</span>
    <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
    <span class="token parameter variable">--user</span><span class="token operator">=</span>system:kube-controller-manager <span class="token punctuation">\</span>
    <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig
<span class="token comment"># 这个命令用于配置 Kubernetes 控制器管理器的上下文信息。下面是各个参数的详细解释：</span>
<span class="token comment"># 1. `kubectl config set-context system:kube-controller-manager@kubernetes`: 设置上下文的名称为 `system:kube-controller-manager@kubernetes`，这是一个标识符，用于唯一标识该上下文。</span>
<span class="token comment"># 2. `--cluster=kubernetes`: 指定集群的名称为 `kubernetes`，这是一个现有集群的标识符，表示要管理的 Kubernetes 集群。</span>
<span class="token comment"># 3. `--user=system:kube-controller-manager`: 指定使用的用户身份为 `system:kube-controller-manager`。这是一个特殊的用户身份，具有控制 Kubernetes 控制器管理器的权限。</span>
<span class="token comment"># 4. `--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig`: 指定 kubeconfig 文件的路径为 `/etc/kubernetes/controller-manager.kubeconfig`。kubeconfig 文件是一个用于管理 Kubernetes 配置的文件，包含了集群、用户和上下文的相关信息。</span>
<span class="token comment"># 通过运行这个命令，可以将这些配置信息保存到 `/etc/kubernetes/controller-manager.kubeconfig` 文件中，以便在后续的操作中使用。</span>



<span class="token comment"># 设置一个用户项</span>
kubectl config set-credentials system:kube-controller-manager <span class="token punctuation">\</span>
     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/controller-manager.pem <span class="token punctuation">\</span>
     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/controller-manager-key.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig
<span class="token comment"># 上述命令是用于设置 Kubernetes 的 controller-manager 组件的客户端凭据。下面是每个参数的详细解释：</span>
<span class="token comment"># </span>
<span class="token comment"># - `kubectl config`: 是使用 kubectl 命令行工具的配置子命令。</span>
<span class="token comment"># - `set-credentials`: 是定义一个新的用户凭据配置的子命令。</span>
<span class="token comment"># - `system:kube-controller-manager`: 是设置用户凭据的名称，`system:` 是 Kubernetes API Server 内置的身份验证器使用的用户标识符前缀，它表示是一个系统用户，在本例中是 kube-controller-manager 组件使用的身份。</span>
<span class="token comment"># - `--client-certificate=/etc/kubernetes/pki/controller-manager.pem`: 指定 controller-manager.pem 客户端证书的路径。</span>
<span class="token comment"># - `--client-key=/etc/kubernetes/pki/controller-manager-key.pem`: 指定 controller-manager-key.pem 客户端私钥的路径。</span>
<span class="token comment"># - `--embed-certs=true`: 表示将证书和私钥直接嵌入到生成的 kubeconfig 文件中，而不是通过引用外部文件。</span>
<span class="token comment"># - `--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig`: 指定生成的 kubeconfig 文件的路径和文件名，即 controller-manager.kubeconfig。</span>
<span class="token comment"># </span>
<span class="token comment"># 通过运行上述命令，将根据提供的证书和私钥信息，为 kube-controller-manager 创建一个 kubeconfig 文件，以便后续使用该文件进行身份验证和访问 Kubernetes API。</span>


<span class="token comment"># 设置默认环境</span>
kubectl config use-context system:kube-controller-manager@kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig
<span class="token comment"># 这个命令是用来指定kubectl使用指定的上下文环境来执行操作。上下文环境是kubectl用来确定要连接到哪个Kubernetes集群以及使用哪个身份验证信息的配置。</span>
<span class="token comment"># </span>
<span class="token comment"># 在这个命令中，`kubectl config use-context`是用来设置当前上下文环境的命令。 `system:kube-controller-manager@kubernetes`是指定的上下文名称，它告诉kubectl要使用的Kubernetes集群和身份验证信息。 </span>
<span class="token comment"># `--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig`是用来指定使用的kubeconfig文件的路径。kubeconfig文件是存储集群连接和身份验证信息的配置文件。</span>
<span class="token comment"># 通过执行这个命令，kubectl将使用指定的上下文来执行后续的操作，包括部署和管理Kubernetes资源。</span>


</code></pre> 
<h4><a id="325_master01kubescheduler_2327"></a>3.2.5 master01节点生成kube-scheduler的证书</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> scheduler-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  "CN": "system:kube-scheduler",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:kube-scheduler",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF</span>
<span class="token comment"># 这个命令是用来创建一个叫做scheduler-csr.json的文件，并将其中的内容赋值给该文件。</span>
<span class="token comment"># </span>
<span class="token comment"># 文件内容是一个JSON格式的文本，包含了一个描述证书请求的结构。</span>
<span class="token comment"># </span>
<span class="token comment"># 具体内容如下：</span>
<span class="token comment"># </span>
<span class="token comment"># - "CN": "system:kube-scheduler"：Common Name字段，表示该证书的名称为system:kube-scheduler。</span>
<span class="token comment"># - "key": {"algo": "rsa", "size": 2048}：key字段指定生成证书时使用的加密算法是RSA，并且密钥的长度为2048位。</span>
<span class="token comment"># - "names": [...]：names字段定义了证书中的另外一些标识信息。</span>
<span class="token comment"># - "C": "CN"：Country字段，表示国家/地区为中国。</span>
<span class="token comment"># - "ST": "Beijing"：State字段，表示省/市为北京。</span>
<span class="token comment"># - "L": "Beijing"：Locality字段，表示所在城市为北京。</span>
<span class="token comment"># - "O": "system:kube-scheduler"：Organization字段，表示组织为system:kube-scheduler。</span>
<span class="token comment"># - "OU": "Kubernetes-manual"：Organizational Unit字段，表示组织单元为Kubernetes-manual。</span>
<span class="token comment"># </span>
<span class="token comment"># 而EOF是一个占位符，用于标记开始和结束的位置。在开始的EOF之后到结束的EOF之间的内容将会被写入到scheduler-csr.json文件中。</span>
<span class="token comment"># </span>
<span class="token comment"># 总体来说，这个命令用于生成一个描述kube-scheduler证书请求的JSON文件。</span>

cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   scheduler-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/scheduler
<span class="token comment"># 上述命令是使用cfssl工具生成Kubernetes Scheduler的证书。</span>
<span class="token comment"># </span>
<span class="token comment"># 具体解释如下：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. `cfssl gencert`：使用cfssl工具生成证书。</span>
<span class="token comment"># 2. `-ca=/etc/kubernetes/pki/ca.pem`：指定根证书文件的路径。在这里，是指定根证书的路径为`/etc/kubernetes/pki/ca.pem`。</span>
<span class="token comment"># 3. `-ca-key=/etc/kubernetes/pki/ca-key.pem`：指定根证书私钥文件的路径。在这里，是指定根证书私钥的路径为`/etc/kubernetes/pki/ca-key.pem`。</span>
<span class="token comment"># 4. `-config=ca-config.json`：指定证书配置文件的路径。在这里，是指定证书配置文件的路径为`ca-config.json`。</span>
<span class="token comment"># 5. `-profile=kubernetes`：指定证书的配置文件中的一个配置文件模板。在这里，是指定配置文件中的`kubernetes`配置模板。</span>
<span class="token comment"># 6. `scheduler-csr.json`：指定Scheduler的证书签名请求文件（CSR）的路径。在这里，是指定请求文件的路径为`scheduler-csr.json`。</span>
<span class="token comment"># 7. `|`（管道符号）：将前一个命令的输出作为下一个命令的输入。</span>
<span class="token comment"># 8. `cfssljson`：将cfssl工具生成的证书签名请求(CSR)进行解析。</span>
<span class="token comment"># 9. `-bare /etc/kubernetes/pki/scheduler`：指定输出路径和前缀。在这里，是将解析的证书签名请求生成以下文件：`/etc/kubernetes/pki/scheduler.pem`（包含了证书）、`/etc/kubernetes/pki/scheduler-key.pem`（包含了私钥）。</span>
<span class="token comment"># </span>
<span class="token comment"># 总结来说，这个命令的目的是根据根证书、根证书私钥、证书配置文件、CSR文件等生成Kubernetes Scheduler的证书和私钥文件。</span>



<span class="token comment"># 在《5.高可用配置》选择使用那种高可用方案</span>
<span class="token comment"># 若使用 haproxy、keepalived 那么为 `--server=https://192.168.0.36:8443`</span>
<span class="token comment"># 若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>

kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://127.0.0.1:8443 <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig
<span class="token comment"># 该命令用于配置一个名为"kubernetes"的集群，并将其应用到/etc/kubernetes/scheduler.kubeconfig文件中。</span>
<span class="token comment"># </span>
<span class="token comment"># 该命令的解释如下：</span>
<span class="token comment"># - `kubectl config set-cluster kubernetes`: 设置一个集群并命名为"kubernetes"。</span>
<span class="token comment"># - `--certificate-authority=/etc/kubernetes/pki/ca.pem`: 指定集群使用的证书授权机构的路径。</span>
<span class="token comment"># - `--embed-certs=true`: 该标志指示将证书嵌入到生成的kubeconfig文件中。</span>
<span class="token comment"># - `--server=https://127.0.0.1:8443`: 指定集群的 API server 位置。</span>
<span class="token comment"># - `--kubeconfig=/etc/kubernetes/scheduler.kubeconfig`: 指定要保存 kubeconfig 文件的路径和名称。</span>

kubectl config set-credentials system:kube-scheduler <span class="token punctuation">\</span>
     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/scheduler.pem <span class="token punctuation">\</span>
     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/scheduler-key.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig
<span class="token comment"># 这段命令是用于设置 kube-scheduler 组件的身份验证凭据，并生成相应的 kubeconfig 文件。</span>
<span class="token comment"># </span>
<span class="token comment"># 解释每个选项的含义如下：</span>
<span class="token comment"># - `kubectl config set-credentials system:kube-scheduler`：设置 `system:kube-scheduler` 用户的身份验证凭据。</span>
<span class="token comment"># - `--client-certificate=/etc/kubernetes/pki/scheduler.pem`：指定一个客户端证书文件，用于基于证书的身份验证。在这种情况下，指定了 kube-scheduler 组件的证书文件路径。</span>
<span class="token comment"># - `--client-key=/etc/kubernetes/pki/scheduler-key.pem`：指定与客户端证书相对应的客户端私钥文件。</span>
<span class="token comment"># - `--embed-certs=true`：将客户端证书和私钥嵌入到生成的 kubeconfig 文件中。</span>
<span class="token comment"># - `--kubeconfig=/etc/kubernetes/scheduler.kubeconfig`：指定生成的 kubeconfig 文件的路径和名称。</span>
<span class="token comment"># </span>
<span class="token comment"># 该命令的目的是为 kube-scheduler 组件生成一个 kubeconfig 文件，以便进行身份验证和访问集群资源。kubeconfig 文件是一个包含了连接到 Kubernetes 集群所需的所有配置信息的文件，包括服务器地址、证书和秘钥等。</span>

kubectl config set-context system:kube-scheduler@kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--user</span><span class="token operator">=</span>system:kube-scheduler <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig
<span class="token comment"># 该命令用于设置一个名为"system:kube-scheduler@kubernetes"的上下文，具体配置如下：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. --cluster=kubernetes: 指定集群的名称为"kubernetes"，这个集群是在当前的kubeconfig文件中已经定义好的。</span>
<span class="token comment"># 2. --user=system:kube-scheduler: 指定用户的名称为"system:kube-scheduler"，这个用户也是在当前的kubeconfig文件中已经定义好的。这个用户用于认证和授权kube-scheduler组件访问Kubernetes集群的权限。</span>
<span class="token comment"># 3. --kubeconfig=/etc/kubernetes/scheduler.kubeconfig: 指定kubeconfig文件的路径为"/etc/kubernetes/scheduler.kubeconfig"，这个文件将被用来保存上下文的配置信息。</span>
<span class="token comment"># </span>
<span class="token comment"># 这个命令的作用是将上述的配置信息保存到指定的kubeconfig文件中，以便后续使用该文件进行认证和授权访问Kubernetes集群。</span>

kubectl config use-context system:kube-scheduler@kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig
<span class="token comment"># 上述命令是使用`kubectl`命令来配置Kubernetes集群中的调度器组件。</span>
<span class="token comment"># </span>
<span class="token comment"># `kubectl config use-context`命令用于切换`kubectl`当前使用的上下文。上下文是Kubernetes集群、用户和命名空间的组合，用于确定`kubectl`的连接目标。下面解释这个命令的不同部分：</span>
<span class="token comment"># </span>
<span class="token comment"># - `system:kube-scheduler@kubernetes`是一个上下文名称。它指定了使用`kube-scheduler`用户和`kubernetes`命名空间的系统级别上下文。系统级别上下文用于操作Kubernetes核心组件。</span>
<span class="token comment"># </span>
<span class="token comment"># - `--kubeconfig=/etc/kubernetes/scheduler.kubeconfig`用于指定Kubernetes配置文件的路径。Kubernetes配置文件包含连接到Kubernetes集群所需的身份验证和连接信息。</span>
<span class="token comment"># </span>
<span class="token comment"># 通过运行以上命令，`kubectl`将使用指定的上下文和配置文件，以便在以后的命令中能正确地与Kubernetes集群中的调度器组件进行交互。</span>
</code></pre> 
<h4><a id="326_master01admin_2450"></a>3.2.6 master01节点生成admin的证书配置</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> admin-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  "CN": "admin",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:masters",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF</span>
<span class="token comment"># 这段代码是一个JSON格式的配置文件，用于创建和配置一个名为"admin"的Kubernetes凭证。</span>
<span class="token comment"># </span>
<span class="token comment"># 这个凭证包含以下字段：</span>
<span class="token comment"># </span>
<span class="token comment"># - "CN": "admin": 这是凭证的通用名称，表示这是一个管理员凭证。</span>
<span class="token comment"># - "key": 这是一个包含证书密钥相关信息的对象。</span>
<span class="token comment">#   - "algo": "rsa"：这是使用的加密算法类型，这里是RSA加密算法。</span>
<span class="token comment">#   - "size": 2048：这是密钥的大小，这里是2048位。</span>
<span class="token comment"># - "names": 这是一个包含证书名称信息的数组。</span>
<span class="token comment">#   - "C": "CN"：这是证书的国家/地区字段，这里是中国。</span>
<span class="token comment">#   - "ST": "Beijing"：这是证书的省/州字段，这里是北京。</span>
<span class="token comment">#   - "L": "Beijing"：这是证书的城市字段，这里是北京。</span>
<span class="token comment">#   - "O": "system:masters"：这是证书的组织字段，这里是system:masters，表示系统的管理员组。</span>
<span class="token comment">#   - "OU": "Kubernetes-manual"：这是证书的部门字段，这里是Kubernetes-manual。</span>
<span class="token comment"># </span>
<span class="token comment"># 通过这个配置文件创建的凭证将具有管理员权限，并且可以用于管理Kubernetes集群。</span>

cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   admin-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/admin
<span class="token comment"># 上述命令是使用cfssl工具生成Kubernetes admin的证书。</span>
<span class="token comment"># </span>
<span class="token comment"># 具体解释如下：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. `cfssl gencert`：使用cfssl工具生成证书。</span>
<span class="token comment"># 2. `-ca=/etc/kubernetes/pki/ca.pem`：指定根证书文件的路径。在这里，是指定根证书的路径为`/etc/kubernetes/pki/ca.pem`。</span>
<span class="token comment"># 3. `-ca-key=/etc/kubernetes/pki/ca-key.pem`：指定根证书私钥文件的路径。在这里，是指定根证书私钥的路径为`/etc/kubernetes/pki/ca-key.pem`。</span>
<span class="token comment"># 4. `-config=ca-config.json`：指定证书配置文件的路径。在这里，是指定证书配置文件的路径为`ca-config.json`。</span>
<span class="token comment"># 5. `-profile=kubernetes`：指定证书的配置文件中的一个配置文件模板。在这里，是指定配置文件中的`kubernetes`配置模板。</span>
<span class="token comment"># 6. `admin-csr.json`：指定admin的证书签名请求文件（CSR）的路径。在这里，是指定请求文件的路径为`admin-csr.json`。</span>
<span class="token comment"># 7. `|`（管道符号）：将前一个命令的输出作为下一个命令的输入。</span>
<span class="token comment"># 8. `cfssljson`：将cfssl工具生成的证书签名请求(CSR)进行解析。</span>
<span class="token comment"># 9. `-bare /etc/kubernetes/pki/admin`：指定输出路径和前缀。在这里，是将解析的证书签名请求生成以下文件：`/etc/kubernetes/pki/admin.pem`（包含了证书）、`/etc/kubernetes/pki/admin-key.pem`（包含了私钥）。</span>
<span class="token comment"># </span>
<span class="token comment"># 总结来说，这个命令的目的是根据根证书、根证书私钥、证书配置文件、CSR文件等生成Kubernetes Scheduler的证书和私钥文件。</span>

<span class="token comment"># 在《5.高可用配置》选择使用那种高可用方案</span>
<span class="token comment"># 若使用 haproxy、keepalived 那么为 `--server=https://192.168.0.36:8443`</span>
<span class="token comment"># 若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>

kubectl config set-cluster kubernetes     <span class="token punctuation">\</span>
  --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true     <span class="token punctuation">\</span>
  <span class="token parameter variable">--server</span><span class="token operator">=</span>https://127.0.0.1:8443     <span class="token punctuation">\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig
<span class="token comment"># 该命令用于配置一个名为"kubernetes"的集群，并将其应用到/etc/kubernetes/scheduler.kubeconfig文件中。</span>
<span class="token comment"># </span>
<span class="token comment"># 该命令的解释如下：</span>
<span class="token comment"># - `kubectl config set-cluster kubernetes`: 设置一个集群并命名为"kubernetes"。</span>
<span class="token comment"># - `--certificate-authority=/etc/kubernetes/pki/ca.pem`: 指定集群使用的证书授权机构的路径。</span>
<span class="token comment"># - `--embed-certs=true`: 该标志指示将证书嵌入到生成的kubeconfig文件中。</span>
<span class="token comment"># - `--server=https://127.0.0.1:8443`: 指定集群的 API server 位置。</span>
<span class="token comment"># - `--kubeconfig=/etc/kubernetes/admin.kubeconfig`: 指定要保存 kubeconfig 文件的路径和名称。</span>

kubectl config set-credentials kubernetes-admin  <span class="token punctuation">\</span>
  --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/admin.pem     <span class="token punctuation">\</span>
  --client-key<span class="token operator">=</span>/etc/kubernetes/pki/admin-key.pem     <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true     <span class="token punctuation">\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig
<span class="token comment"># 这段命令是用于设置 kubernetes-admin 组件的身份验证凭据，并生成相应的 kubeconfig 文件。</span>
<span class="token comment"># </span>
<span class="token comment"># 解释每个选项的含义如下：</span>
<span class="token comment"># - `kubectl config set-credentials kubernetes-admin`：设置 `kubernetes-admin` 用户的身份验证凭据。</span>
<span class="token comment"># - `--client-certificate=/etc/kubernetes/pki/admin.pem`：指定一个客户端证书文件，用于基于证书的身份验证。在这种情况下，指定了 admin 组件的证书文件路径。</span>
<span class="token comment"># - `--client-key=/etc/kubernetes/pki/admin-key.pem`：指定与客户端证书相对应的客户端私钥文件。</span>
<span class="token comment"># - `--embed-certs=true`：将客户端证书和私钥嵌入到生成的 kubeconfig 文件中。</span>
<span class="token comment"># - `--kubeconfig=/etc/kubernetes/admin.kubeconfig`：指定生成的 kubeconfig 文件的路径和名称。</span>
<span class="token comment"># </span>
<span class="token comment"># 该命令的目的是为 admin 组件生成一个 kubeconfig 文件，以便进行身份验证和访问集群资源。kubeconfig 文件是一个包含了连接到 Kubernetes 集群所需的所有配置信息的文件，包括服务器地址、证书和秘钥等。</span>


kubectl config set-context kubernetes-admin@kubernetes    <span class="token punctuation">\</span>
  <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token punctuation">\</span>
  <span class="token parameter variable">--user</span><span class="token operator">=</span>kubernetes-admin     <span class="token punctuation">\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig
<span class="token comment"># 该命令用于设置一个名为"kubernetes-admin@kubernetes"的上下文，具体配置如下：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. --cluster=kubernetes: 指定集群的名称为"kubernetes"，这个集群是在当前的kubeconfig文件中已经定义好的。</span>
<span class="token comment"># 2. --user=kubernetes-admin: 指定用户的名称为"kubernetes-admin"，这个用户也是在当前的kubeconfig文件中已经定义好的。这个用户用于认证和授权admin组件访问Kubernetes集群的权限。</span>
<span class="token comment"># 3. --kubeconfig=/etc/kubernetes/admin.kubeconfig: 指定kubeconfig文件的路径为"/etc/kubernetes/admin.kubeconfig"，这个文件将被用来保存上下文的配置信息。</span>
<span class="token comment"># </span>
<span class="token comment"># 这个命令的作用是将上述的配置信息保存到指定的kubeconfig文件中，以便后续使用该文件进行认证和授权访问Kubernetes集群。</span>


kubectl config use-context kubernetes-admin@kubernetes  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig
<span class="token comment"># 上述命令是使用`kubectl`命令来配置Kubernetes集群中的调度器组件。</span>
<span class="token comment"># </span>
<span class="token comment"># `kubectl config use-context`命令用于切换`kubectl`当前使用的上下文。上下文是Kubernetes集群、用户和命名空间的组合，用于确定`kubectl`的连接目标。下面解释这个命令的不同部分：</span>
<span class="token comment"># </span>
<span class="token comment"># - `kubernetes-admin@kubernetes`是一个上下文名称。它指定了使用`kubernetes-admin`用户和`kubernetes`命名空间的系统级别上下文。系统级别上下文用于操作Kubernetes核心组件。</span>
<span class="token comment"># </span>
<span class="token comment"># - `--kubeconfig=/etc/kubernetes/admin.kubeconfig`用于指定Kubernetes配置文件的路径。Kubernetes配置文件包含连接到Kubernetes集群所需的身份验证和连接信息。</span>
<span class="token comment"># </span>
<span class="token comment"># 通过运行以上命令，`kubectl`将使用指定的上下文和配置文件，以便在以后的命令中能正确地与Kubernetes集群中的调度器组件进行交互。</span>
</code></pre> 
<h4><a id="327_master01kubeproxy_2570"></a>3.2.7 master01节点创建kube-proxy证书</h4> 
<p>在《5.高可用配置》选择使用那种高可用方案<br> 若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.0.36:8443</code><br> 若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></p> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> kube-proxy-csr.json  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
{
  "CN": "system:kube-proxy",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:kube-proxy",
      "OU": "Kubernetes-manual"
    }
  ]
}
EOF</span>
<span class="token comment"># 这段代码是一个JSON格式的配置文件，用于创建和配置一个名为"kube-proxy-csr"的Kubernetes凭证。</span>
<span class="token comment"># </span>
<span class="token comment"># 这个凭证包含以下字段：</span>
<span class="token comment"># </span>
<span class="token comment"># - "CN": "system:kube-proxy": 这是凭证的通用名称，表示这是一个管理员凭证。</span>
<span class="token comment"># - "key": 这是一个包含证书密钥相关信息的对象。</span>
<span class="token comment">#   - "algo": "rsa"：这是使用的加密算法类型，这里是RSA加密算法。</span>
<span class="token comment">#   - "size": 2048：这是密钥的大小，这里是2048位。</span>
<span class="token comment"># - "names": 这是一个包含证书名称信息的数组。</span>
<span class="token comment">#   - "C": "CN"：这是证书的国家/地区字段，这里是中国。</span>
<span class="token comment">#   - "ST": "Beijing"：这是证书的省/州字段，这里是北京。</span>
<span class="token comment">#   - "L": "Beijing"：这是证书的城市字段，这里是北京。</span>
<span class="token comment">#   - "O": "system:kube-proxy"：这是证书的组织字段，这里是system:kube-proxy。</span>
<span class="token comment">#   - "OU": "Kubernetes-manual"：这是证书的部门字段，这里是Kubernetes-manual。</span>
<span class="token comment"># </span>
<span class="token comment"># 通过这个配置文件创建的凭证将具有管理员权限，并且可以用于管理Kubernetes集群。</span>

cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   kube-proxy-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/kube-proxy
<span class="token comment"># 上述命令是使用cfssl工具生成Kubernetes admin的证书。</span>
<span class="token comment"># </span>
<span class="token comment"># 具体解释如下：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. `cfssl gencert`：使用cfssl工具生成证书。</span>
<span class="token comment"># 2. `-ca=/etc/kubernetes/pki/ca.pem`：指定根证书文件的路径。在这里，是指定根证书的路径为`/etc/kubernetes/pki/ca.pem`。</span>
<span class="token comment"># 3. `-ca-key=/etc/kubernetes/pki/ca-key.pem`：指定根证书私钥文件的路径。在这里，是指定根证书私钥的路径为`/etc/kubernetes/pki/ca-key.pem`。</span>
<span class="token comment"># 4. `-config=ca-config.json`：指定证书配置文件的路径。在这里，是指定证书配置文件的路径为`ca-config.json`。</span>
<span class="token comment"># 5. `-profile=kubernetes`：指定证书的配置文件中的一个配置文件模板。在这里，是指定配置文件中的`kubernetes`配置模板。</span>
<span class="token comment"># 6. `kube-proxy-csr.json`：指定admin的证书签名请求文件（CSR）的路径。在这里，是指定请求文件的路径为`kube-proxy-csr.json`。</span>
<span class="token comment"># 7. `|`（管道符号）：将前一个命令的输出作为下一个命令的输入。</span>
<span class="token comment"># 8. `cfssljson`：将cfssl工具生成的证书签名请求(CSR)进行解析。</span>
<span class="token comment"># 9. `-bare /etc/kubernetes/pki/kube-proxy`：指定输出路径和前缀。在这里，是将解析的证书签名请求生成以下文件：`/etc/kubernetes/pki/kube-proxy.pem`（包含了证书）、`/etc/kubernetes/pki/kube-proxy-key.pem`（包含了私钥）。</span>
<span class="token comment"># </span>
<span class="token comment"># 总结来说，这个命令的目的是根据根证书、根证书私钥、证书配置文件、CSR文件等生成Kubernetes Scheduler的证书和私钥文件。</span>

   
<span class="token comment"># 在《5.高可用配置》选择使用那种高可用方案</span>
<span class="token comment"># 若使用 haproxy、keepalived 那么为 `--server=https://192.168.0.36:8443`</span>
<span class="token comment"># 若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>

kubectl config set-cluster kubernetes     <span class="token punctuation">\</span>
  --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true     <span class="token punctuation">\</span>
  <span class="token parameter variable">--server</span><span class="token operator">=</span>https://127.0.0.1:8443     <span class="token punctuation">\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig
<span class="token comment"># 该命令用于配置一个名为"kubernetes"的集群，并将其应用到/etc/kubernetes/kube-proxy.kubeconfig文件中。</span>
<span class="token comment"># </span>
<span class="token comment"># 该命令的解释如下：</span>
<span class="token comment"># - `kubectl config set-cluster kubernetes`: 设置一个集群并命名为"kubernetes"。</span>
<span class="token comment"># - `--certificate-authority=/etc/kubernetes/pki/ca.pem`: 指定集群使用的证书授权机构的路径。</span>
<span class="token comment"># - `--embed-certs=true`: 该标志指示将证书嵌入到生成的kubeconfig文件中。</span>
<span class="token comment"># - `--server=https://127.0.0.1:8443`: 指定集群的 API server 位置。</span>
<span class="token comment"># - `--kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig`: 指定要保存 kubeconfig 文件的路径和名称。</span>

kubectl config set-credentials kube-proxy  <span class="token punctuation">\</span>
  --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/kube-proxy.pem     <span class="token punctuation">\</span>
  --client-key<span class="token operator">=</span>/etc/kubernetes/pki/kube-proxy-key.pem     <span class="token punctuation">\</span>
  --embed-certs<span class="token operator">=</span>true     <span class="token punctuation">\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig
<span class="token comment"># 这段命令是用于设置 kube-proxy 组件的身份验证凭据，并生成相应的 kubeconfig 文件。</span>
<span class="token comment"># </span>
<span class="token comment"># 解释每个选项的含义如下：</span>
<span class="token comment"># - `kubectl config set-credentials kube-proxy`：设置 `kube-proxy` 用户的身份验证凭据。</span>
<span class="token comment"># - `--client-certificate=/etc/kubernetes/pki/kube-proxy.pem`：指定一个客户端证书文件，用于基于证书的身份验证。在这种情况下，指定了 kube-proxy 组件的证书文件路径。</span>
<span class="token comment"># - `--client-key=/etc/kubernetes/pki/kube-proxy-key.pem`：指定与客户端证书相对应的客户端私钥文件。</span>
<span class="token comment"># - `--embed-certs=true`：将客户端证书和私钥嵌入到生成的 kubeconfig 文件中。</span>
<span class="token comment"># - `--kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig`：指定生成的 kubeconfig 文件的路径和名称。</span>
<span class="token comment"># </span>
<span class="token comment"># 该命令的目的是为 kube-proxy 组件生成一个 kubeconfig 文件，以便进行身份验证和访问集群资源。kubeconfig 文件是一个包含了连接到 Kubernetes 集群所需的所有配置信息的文件，包括服务器地址、证书和秘钥等。</span>

kubectl config set-context kube-proxy@kubernetes    <span class="token punctuation">\</span>
  <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token punctuation">\</span>
  <span class="token parameter variable">--user</span><span class="token operator">=</span>kube-proxy     <span class="token punctuation">\</span>
  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig
<span class="token comment"># 该命令用于设置一个名为"kube-proxy@kubernetes"的上下文，具体配置如下：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. --cluster=kubernetes: 指定集群的名称为"kubernetes"，这个集群是在当前的kubeconfig文件中已经定义好的。</span>
<span class="token comment"># 2. --user=kube-proxy: 指定用户的名称为"kube-proxy"，这个用户也是在当前的kubeconfig文件中已经定义好的。这个用户用于认证和授权kube-proxy组件访问Kubernetes集群的权限。</span>
<span class="token comment"># 3. --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig: 指定kubeconfig文件的路径为"/etc/kubernetes/kube-proxy.kubeconfig"，这个文件将被用来保存上下文的配置信息。</span>
<span class="token comment"># </span>
<span class="token comment"># 这个命令的作用是将上述的配置信息保存到指定的kubeconfig文件中，以便后续使用该文件进行认证和授权访问Kubernetes集群。</span>

kubectl config use-context kube-proxy@kubernetes  <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig
<span class="token comment"># 上述命令是使用`kubectl`命令来配置Kubernetes集群中的调度器组件。</span>
<span class="token comment"># </span>
<span class="token comment"># `kubectl config use-context`命令用于切换`kubectl`当前使用的上下文。上下文是Kubernetes集群、用户和命名空间的组合，用于确定`kubectl`的连接目标。下面解释这个命令的不同部分：</span>
<span class="token comment"># </span>
<span class="token comment"># - `kube-proxy@kubernetes`是一个上下文名称。它指定了使用`kube-proxy`用户和`kubernetes`命名空间的系统级别上下文。系统级别上下文用于操作Kubernetes核心组件。</span>
<span class="token comment"># </span>
<span class="token comment"># - `--kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig`用于指定Kubernetes配置文件的路径。Kubernetes配置文件包含连接到Kubernetes集群所需的身份验证和连接信息。</span>
<span class="token comment"># </span>
<span class="token comment"># 通过运行以上命令，`kubectl`将使用指定的上下文和配置文件，以便在以后的命令中能正确地与Kubernetes集群中的调度器组件进行交互。</span>
</code></pre> 
<h4><a id="328_master01ServiceAccount_Key_secret_2695"></a>3.2.8 master01节点创建ServiceAccount Key ——secret</h4> 
<pre><code class="prism language-shell">openssl genrsa <span class="token parameter variable">-out</span> /etc/kubernetes/pki/sa.key <span class="token number">2048</span>
openssl rsa <span class="token parameter variable">-in</span> /etc/kubernetes/pki/sa.key <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> /etc/kubernetes/pki/sa.pub

<span class="token comment"># 这两个命令是使用OpenSSL工具生成RSA密钥对。</span>
<span class="token comment"># </span>
<span class="token comment"># 命令1：openssl genrsa -out /etc/kubernetes/pki/sa.key 2048</span>
<span class="token comment"># 该命令用于生成私钥文件。具体解释如下：</span>
<span class="token comment"># - openssl：openssl命令行工具。</span>
<span class="token comment"># - genrsa：生成RSA密钥对。</span>
<span class="token comment"># - -out /etc/kubernetes/pki/sa.key：指定输出私钥文件的路径和文件名。</span>
<span class="token comment"># - 2048：指定密钥长度为2048位。</span>
<span class="token comment"># </span>
<span class="token comment"># 命令2：openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub</span>
<span class="token comment"># 该命令用于从私钥中导出公钥。具体解释如下：</span>
<span class="token comment"># - openssl：openssl命令行工具。</span>
<span class="token comment"># - rsa：与私钥相关的RSA操作。</span>
<span class="token comment"># - -in /etc/kubernetes/pki/sa.key：指定输入私钥文件的路径和文件名。</span>
<span class="token comment"># - -pubout：指定输出公钥。</span>
<span class="token comment"># - -out /etc/kubernetes/pki/sa.pub：指定输出公钥文件的路径和文件名。</span>
<span class="token comment"># </span>
<span class="token comment"># 总结：通过以上两个命令，我们可以使用OpenSSL工具生成一个RSA密钥对，并将私钥保存在/etc/kubernetes/pki/sa.key文件中，将公钥保存在/etc/kubernetes/pki/sa.pub文件中。</span>
</code></pre> 
<h4><a id="329_master_2721"></a>3.2.9 将证书发送到其他master节点</h4> 
<blockquote> 
 <p>master01节点操作</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment">#其他节点创建目录</span>
<span class="token comment"># mkdir  /etc/kubernetes/pki/ -p</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master02 k8s-master03<span class="token punctuation">;</span> <span class="token keyword">do</span>  <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> /etc/kubernetes/pki <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> etcd<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>  <span class="token function">scp</span> /etc/kubernetes/pki/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/kubernetes/pki/<span class="token variable">${FILE}</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">do</span>  <span class="token function">scp</span> /etc/kubernetes/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/kubernetes/<span class="token variable">${FILE}</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> 
<h4><a id="3210__2732"></a>3.2.10 查看证书</h4> 
<blockquote> 
 <p>master节点执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">ls</span> /etc/kubernetes/pki/
admin.csr          controller-manager.csr      kube-proxy.csr
admin-key.pem      controller-manager-key.pem  kube-proxy-key.pem
admin.pem          controller-manager.pem      kube-proxy.pem
apiserver.csr      front-proxy-ca.csr          sa.key
apiserver-key.pem  front-proxy-ca-key.pem      sa.pub
apiserver.pem      front-proxy-ca.pem          scheduler.csr
ca.csr             front-proxy-client.csr      scheduler-key.pem
ca-key.pem         front-proxy-client-key.pem  scheduler.pem
ca.pem             front-proxy-client.pem

<span class="token comment"># 一共26个就对了</span>
<span class="token function">ls</span> /etc/kubernetes/pki/ <span class="token operator">|</span><span class="token function">wc</span> <span class="token parameter variable">-l</span>
<span class="token number">26</span>
</code></pre> 
<h2><a id="4k8s_2753"></a>4.k8s系统组件配置</h2> 
<h3><a id="41etcd_2755"></a>4.1.etcd配置</h3> 
<pre><code class="prism language-shell">这个配置文件是用于 etcd 集群的配置，其中包含了一些重要的参数和选项：

- <span class="token variable"><span class="token variable">`</span>name<span class="token variable">`</span></span>：指定了当前节点的名称，用于集群中区分不同的节点。
- <span class="token variable"><span class="token variable">`</span>data-dir<span class="token variable">`</span></span>：指定了 etcd 数据的存储目录。
- <span class="token variable"><span class="token variable">`</span>wal-dir<span class="token variable">`</span></span>：指定了 etcd 数据写入磁盘的目录。
- <span class="token variable"><span class="token variable">`</span>snapshot-count<span class="token variable">`</span></span>：指定了触发快照的事务数量。
- <span class="token variable"><span class="token variable">`</span>heartbeat-interval<span class="token variable">`</span></span>：指定了 etcd 集群中节点之间的心跳间隔。
- <span class="token variable"><span class="token variable">`</span>election-timeout<span class="token variable">`</span></span>：指定了选举超时时间。
- <span class="token variable"><span class="token variable">`</span>quota-backend-bytes<span class="token variable">`</span></span>：指定了存储的限额，0 表示无限制。
- <span class="token variable"><span class="token variable">`</span>listen-peer-urls<span class="token variable">`</span></span>：指定了节点之间通信的 URL，使用 HTTPS 协议。
- <span class="token variable"><span class="token variable">`</span>listen-client-urls<span class="token variable">`</span></span>：指定了客户端访问 etcd 集群的 URL，同时提供了本地访问的 URL。
- <span class="token variable"><span class="token variable">`</span>max-snapshots<span class="token variable">`</span></span>：指定了快照保留的数量。
- <span class="token variable"><span class="token variable">`</span>max-wals<span class="token variable">`</span></span>：指定了日志保留的数量。
- <span class="token variable"><span class="token variable">`</span>initial-advertise-peer-urls<span class="token variable">`</span></span>：指定了节点之间通信的初始 URL。
- <span class="token variable"><span class="token variable">`</span>advertise-client-urls<span class="token variable">`</span></span>：指定了客户端访问 etcd 集群的初始 URL。
- <span class="token variable"><span class="token variable">`</span>discovery<span class="token variable">`</span></span>：定义了 etcd 集群发现相关的选项。
- <span class="token variable"><span class="token variable">`</span>initial-cluster<span class="token variable">`</span></span>：指定了 etcd 集群的初始成员。
- <span class="token variable"><span class="token variable">`</span>initial-cluster-token<span class="token variable">`</span></span>：指定了集群的 token。
- <span class="token variable"><span class="token variable">`</span>initial-cluster-state<span class="token variable">`</span></span>：指定了集群的初始状态。
- <span class="token variable"><span class="token variable">`</span>strict-reconfig-check<span class="token variable">`</span></span>：指定了严格的重新配置检查选项。
- <span class="token variable"><span class="token variable">`</span>enable-v2<span class="token variable">`</span></span>：启用了 v2 API。
- <span class="token variable"><span class="token variable">`</span>enable-pprof<span class="token variable">`</span></span>：启用了性能分析。
- <span class="token variable"><span class="token variable">`</span>proxy<span class="token variable">`</span></span>：设置了代理模式。
- <span class="token variable"><span class="token variable">`</span>client-transport-security<span class="token variable">`</span></span>：客户端的传输安全配置。
- <span class="token variable"><span class="token variable">`</span>peer-transport-security<span class="token variable">`</span></span>：节点之间的传输安全配置。
- <span class="token variable"><span class="token variable">`</span>debug<span class="token variable">`</span></span>：是否启用调试模式。
- <span class="token variable"><span class="token variable">`</span>log-package-levels<span class="token variable">`</span></span>：日志的输出级别。
- <span class="token variable"><span class="token variable">`</span>log-outputs<span class="token variable">`</span></span>：指定了日志的输出类型。
- <span class="token variable"><span class="token variable">`</span>force-new-cluster<span class="token variable">`</span></span>：是否强制创建一个新的集群。

这些参数和选项可以根据实际需求进行调整和配置。
</code></pre> 
<h4><a id="411_master01_2791"></a>4.1.1 master01配置</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/etcd/etcd.config.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
name: 'k8s-master01'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.0.31:2380'
listen-client-urls: 'https://192.168.0.31:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.0.31:2380'
advertise-client-urls: 'https://192.168.0.31:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.0.31:2380,k8s-master02=https://192.168.0.32:2380,k8s-master03=https://192.168.0.33:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF</span>
</code></pre> 
<h4><a id="412_master02_2845"></a>4.1.2 master02配置</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/etcd/etcd.config.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
name: 'k8s-master02'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.0.32:2380'
listen-client-urls: 'https://192.168.0.32:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.0.32:2380'
advertise-client-urls: 'https://192.168.0.32:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.0.31:2380,k8s-master02=https://192.168.0.32:2380,k8s-master03=https://192.168.0.33:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF</span>
</code></pre> 
<h4><a id="413_master03_2899"></a>4.1.3 master03配置</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/etcd/etcd.config.yml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF 
name: 'k8s-master03'
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: 'https://192.168.0.33:2380'
listen-client-urls: 'https://192.168.0.33:2379,http://127.0.0.1:2379'
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: 'https://192.168.0.33:2380'
advertise-client-urls: 'https://192.168.0.33:2379'
discovery:
discovery-fallback: 'proxy'
discovery-proxy:
discovery-srv:
initial-cluster: 'k8s-master01=https://192.168.0.31:2380,k8s-master02=https://192.168.0.32:2380,k8s-master03=https://192.168.0.33:2380'
initial-cluster-token: 'etcd-k8s-cluster'
initial-cluster-state: 'new'
strict-reconfig-check: false
enable-v2: true
enable-pprof: true
proxy: 'off'
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
peer-transport-security:
  cert-file: '/etc/kubernetes/pki/etcd/etcd.pem'
  key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem'
  peer-client-cert-auth: true
  trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem'
  auto-tls: true
debug: false
log-package-levels:
log-outputs: [default]
force-new-cluster: false
EOF</span>
</code></pre> 
<h3><a id="42service_2953"></a>4.2.创建service</h3> 
<blockquote> 
 <p>所有master节点操作</p> 
</blockquote> 
<h4><a id="421_etcdservice_2957"></a>4.2.1 创建etcd.service并启动</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/etcd.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Etcd Service
Documentation=https://coreos.com/etcd/docs/latest/
After=network.target

[Service]
Type=notify
ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml
Restart=on-failure
RestartSec=10
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
Alias=etcd3.service

EOF</span>
<span class="token comment"># 这是一个系统服务配置文件，用于启动和管理Etcd服务。</span>
<span class="token comment"># </span>
<span class="token comment"># [Unit] 部分包含了服务的一些基本信息，它定义了服务的描述和文档链接，并指定了服务应在网络连接之后启动。</span>
<span class="token comment"># </span>
<span class="token comment"># [Service] 部分定义了服务的具体配置。在这里，服务的类型被设置为notify，意味着当服务成功启动时，它将通知系统。ExecStart 指定了启动服务时要执行的命令，这里是运行 /usr/local/bin/etcd 命令并传递一个配置文件 /etc/etcd/etcd.config.yml。Restart 设置为 on-failure，意味着当服务失败时将自动重启，并且在10秒后进行重启。LimitNOFILE 指定了服务的最大文件打开数。</span>
<span class="token comment"># </span>
<span class="token comment"># [Install] 部分定义了服务的安装配置。WantedBy 指定了服务应该被启动的目标，这里是 multi-user.target，表示在系统进入多用户模式时启动。Alias 定义了一个别名，可以通过etcd3.service来引用这个服务。</span>
<span class="token comment"># </span>
<span class="token comment"># 这个配置文件描述了如何启动和管理Etcd服务，并将其安装到系统中。通过这个配置文件，可以确保Etcd服务在系统启动后自动启动，并在出现问题时进行重启。</span>
</code></pre> 
<h4><a id="422_etcd_2990"></a>4.2.2 创建etcd证书目录</h4> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> /etc/kubernetes/pki/etcd
<span class="token function">ln</span> <span class="token parameter variable">-s</span> /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/

systemctl daemon-reload
<span class="token comment"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span>

systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> etcd.service
<span class="token comment"># 启用并立即启动etcd.service单元。etcd.service是etcd守护进程的systemd服务单元。</span>

systemctl restart etcd.service
<span class="token comment"># 重启etcd.service单元，即重新启动etcd守护进程。</span>

systemctl status etcd.service
<span class="token comment"># etcd.service单元的当前状态，包括运行状态、是否启用等信息。</span>
</code></pre> 
<h4><a id="423_etcd_3009"></a>4.2.3 查看etcd状态</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 如果要用IPv6那么把IPv4地址修改为IPv6即可</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span>
etcdctl <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token string">"192.168.0.33:2379,192.168.0.32:2379,192.168.0.31:2379"</span> <span class="token parameter variable">--cacert</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem <span class="token parameter variable">--cert</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd.pem <span class="token parameter variable">--key</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out<span class="token operator">=</span>table
+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
<span class="token operator">|</span>     ENDPOINT      <span class="token operator">|</span>        ID        <span class="token operator">|</span> VERSION <span class="token operator">|</span> DB SIZE <span class="token operator">|</span> IS LEADER <span class="token operator">|</span> IS LEARNER <span class="token operator">|</span> RAFT <span class="token environment constant">TERM</span> <span class="token operator">|</span> RAFT INDEX <span class="token operator">|</span> RAFT APPLIED INDEX <span class="token operator">|</span> ERRORS <span class="token operator">|</span>
+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
<span class="token operator">|</span> <span class="token number">192.168</span>.0.33:2379 <span class="token operator">|</span> 6ae2196f75cd6d95 <span class="token operator">|</span>   <span class="token number">3.5</span>.9 <span class="token operator">|</span>   <span class="token number">20</span> kB <span class="token operator">|</span>     <span class="token boolean">false</span> <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>          <span class="token number">9</span> <span class="token operator">|</span>                  <span class="token number">9</span> <span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">192.168</span>.0.32:2379 <span class="token operator">|</span> 46cbf93f7713a252 <span class="token operator">|</span>   <span class="token number">3.5</span>.9 <span class="token operator">|</span>   <span class="token number">20</span> kB <span class="token operator">|</span>     <span class="token boolean">false</span> <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>          <span class="token number">9</span> <span class="token operator">|</span>                  <span class="token number">9</span> <span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">192.168</span>.0.31:2379 <span class="token operator">|</span> ec6051ffc7487dd7 <span class="token operator">|</span>   <span class="token number">3.5</span>.9 <span class="token operator">|</span>   <span class="token number">20</span> kB <span class="token operator">|</span>      <span class="token boolean">true</span> <span class="token operator">|</span>      <span class="token boolean">false</span> <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>          <span class="token number">9</span> <span class="token operator">|</span>                  <span class="token number">9</span> <span class="token operator">|</span>        <span class="token operator">|</span>
+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+

<span class="token comment"># 这个命令是使用etcdctl工具，用于查看指定etcd集群的健康状态。下面是每个参数的详细解释：</span>
<span class="token comment"># </span>
<span class="token comment"># - `--endpoints`：指定要连接的etcd集群节点的地址和端口。在这个例子中，指定了3个节点的地址和端口，分别是`192.168.0.33:2379,192.168.0.32:2379,192.168.0.31:2379`。</span>
<span class="token comment"># - `--cacert`：指定用于验证etcd服务器证书的CA证书的路径。在这个例子中，指定了CA证书的路径为`/etc/kubernetes/pki/etcd/etcd-ca.pem`。CA证书用于验证etcd服务器证书的有效性。</span>
<span class="token comment"># - `--cert`：指定用于与etcd服务器进行通信的客户端证书的路径。在这个例子中，指定了客户端证书的路径为`/etc/kubernetes/pki/etcd/etcd.pem`。客户端证书用于在与etcd服务器建立安全通信时进行身份验证。</span>
<span class="token comment"># - `--key`：指定与客户端证书配对的私钥的路径。在这个例子中，指定了私钥的路径为`/etc/kubernetes/pki/etcd/etcd-key.pem`。私钥用于对通信进行加密解密和签名验证。</span>
<span class="token comment"># - `endpoint status`：子命令，用于检查etcd集群节点的健康状态。</span>
<span class="token comment"># - `--write-out`：指定输出的格式。在这个例子中，指定以表格形式输出。</span>
<span class="token comment"># </span>
<span class="token comment"># 通过执行这个命令，可以获取到etcd集群节点的健康状态，并以表格形式展示。</span>
</code></pre> 
<h2><a id="5_3035"></a>5.高可用配置</h2> 
<p><em><em>注意</em> 5.1.1 和5.1.2 二选一即可</em>*</p> 
<p>选择使用那种高可用方案，同时可以俩种都选用，实现内外兼顾的效果，比如：<br> 5.1 的 NGINX方案实现集群内的高可用<br> 5.2 的 haproxy、keepalived 方案实现集群外访问</p> 
<p>在《3.2.生成k8s相关证书》</p> 
<p>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code><br> 若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.0.36:9443</code></p> 
<h3><a id="51_NGINX__3048"></a>5.1 NGINX高可用方案 (推荐)</h3> 
<h4><a id="511_master01_3049"></a>5.1.1 master01节点进行编译</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 安装编译环境</span>
yum <span class="token function">install</span> gcc <span class="token parameter variable">-y</span>

<span class="token comment"># 下载解压nginx二进制文件</span>
<span class="token comment"># wget http://nginx.org/download/nginx-1.25.1.tar.gz</span>
<span class="token function">tar</span> xvf nginx-*.tar.gz
<span class="token builtin class-name">cd</span> nginx-*

<span class="token comment"># 进行编译</span>
./configure --with-stream --without-http --without-http_uwsgi_module --without-http_scgi_module --without-http_fastcgi_module

<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> 

<span class="token comment"># 拷贝编译好的nginx</span>
<span class="token assign-left variable">node</span><span class="token operator">=</span><span class="token string">'k8s-master02 k8s-master03 k8s-node01 k8s-node02'</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$node</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">scp</span> <span class="token parameter variable">-r</span> /usr/local/nginx/ <span class="token variable">$NODE</span>:/usr/local/nginx/<span class="token punctuation">;</span> <span class="token keyword">done</span>

<span class="token comment"># 这是一系列命令行指令，用于编译和安装软件。</span>
<span class="token comment"># </span>
<span class="token comment"># 1. `./configure` 是用于配置软件的命令。在这个例子中，配置的软件是一个Web服务器，指定了一些选项来启用流模块，并禁用了HTTP、uwsgi、scgi和fastcgi模块。</span>
<span class="token comment"># 2. `--with-stream` 指定启用流模块。流模块通常用于代理TCP和UDP流量。</span>
<span class="token comment"># 3. `--without-http` 指定禁用HTTP模块。这意味着编译的软件将没有HTTP服务器功能。</span>
<span class="token comment"># 4. `--without-http_uwsgi_module` 指定禁用uwsgi模块。uwsgi是一种Web服务器和应用服务器之间的通信协议。</span>
<span class="token comment"># 5. `--without-http_scgi_module` 指定禁用scgi模块。scgi是一种用于将Web服务器请求传递到应用服务器的协议。</span>
<span class="token comment"># 6. `--without-http_fastcgi_module` 指定禁用fastcgi模块。fastcgi是一种用于在Web服务器和应用服务器之间交换数据的协议。</span>
<span class="token comment"># 7. `make` 是用于编译软件的命令。该命令将根据之前的配置生成可执行文件。</span>
<span class="token comment"># 8. `make install` 用于安装软件。该命令将生成的可执行文件和其他必要文件复制到系统的适当位置，以便可以使用该软件。</span>
<span class="token comment"># </span>
<span class="token comment"># 总之，这个命令序列用于编译一个配置了特定选项的Web服务器，并将其安装到系统中。</span>
</code></pre> 
<h4><a id="512__3082"></a>5.1.2 写入启动配置</h4> 
<blockquote> 
 <p>在所有节点（master和node）上执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 写入nginx配置文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/local/nginx/conf/kube-nginx.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
worker_processes 1;
events {
    worker_connections  1024;
}
stream {
    upstream backend {
    	least_conn;
        hash <span class="token variable">$remote_addr</span> consistent;
        server 192.168.0.31:6443        max_fails=3 fail_timeout=30s;
        server 192.168.0.32:6443        max_fails=3 fail_timeout=30s;
        server 192.168.0.33:6443        max_fails=3 fail_timeout=30s;
    }
    server {
        listen 127.0.0.1:8443;
        proxy_connect_timeout 1s;
        proxy_pass backend;
    }
}
EOF</span>
<span class="token comment"># 这段配置是一个nginx的stream模块的配置，用于代理TCP和UDP流量。</span>
<span class="token comment"># </span>
<span class="token comment"># 首先，`worker_processes 1;`表示启动一个worker进程用于处理流量。</span>
<span class="token comment"># 接下来，`events { worker_connections 1024; }`表示每个worker进程可以同时处理最多1024个连接。</span>
<span class="token comment"># 在stream块里面，定义了一个名为`backend`的upstream，用于负载均衡和故障转移。</span>
<span class="token comment"># `least_conn`表示使用最少连接算法进行负载均衡。</span>
<span class="token comment"># `hash $remote_addr consistent`表示用客户端的IP地址进行哈希分配请求，保持相同IP的请求始终访问同一台服务器。</span>
<span class="token comment"># `server`指令用于定义后端的服务器，每个服务器都有一个IP地址和端口号，以及一些可选的参数。</span>
<span class="token comment"># `max_fails=3`表示当一个服务器连续失败3次时将其标记为不可用。</span>
<span class="token comment"># `fail_timeout=30s`表示如果一个服务器被标记为不可用，nginx将在30秒后重新尝试。</span>
<span class="token comment"># 在server块内部，定义了一个监听地址为127.0.0.1:8443的服务器。</span>
<span class="token comment"># `proxy_connect_timeout 1s`表示与后端服务器建立连接的超时时间为1秒。</span>
<span class="token comment"># `proxy_pass backend`表示将流量代理到名为backend的上游服务器组。</span>
<span class="token comment"># </span>
<span class="token comment"># 总结起来，这段配置将流量代理到一个包含3个后端服务器的上游服务器组中，使用最少连接算法进行负载均衡，并根据客户端的IP地址进行哈希分配请求。如果一个服务器连续失败3次，则将其标记为不可用，并在30秒后重新尝试。</span>


<span class="token comment"># 写入启动配置文件</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/systemd/system/kube-nginx.service <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[Unit]
Description=kube-apiserver nginx proxy
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=forking
ExecStartPre=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -t
ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx
ExecReload=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -s reload
PrivateTmp=true
Restart=always
RestartSec=5
StartLimitInterval=0
LimitNOFILE=65536
 
[Install]
WantedBy=multi-user.target
EOF</span>
<span class="token comment"># 这是一个用于kube-apiserver的NGINX代理的systemd单位文件。</span>
<span class="token comment"># </span>
<span class="token comment"># [Unit]部分包含了单位的描述和依赖关系。它指定了在network.target和network-online.target之后启动，并且需要network-online.target。</span>
<span class="token comment"># </span>
<span class="token comment"># [Service]部分定义了如何运行该服务。Type指定了服务进程的类型（forking表示主进程会派生一个子进程）。ExecStartPre指定了在服务启动之前需要运行的命令，用于检查NGINX配置文件的语法是否正确。ExecStart指定了启动服务所需的命令。ExecReload指定了在重新加载配置文件时运行的命令。PrivateTmp设置为true表示将为服务创建一个私有的临时文件系统。Restart和RestartSec用于设置服务的自动重启机制。StartLimitInterval设置为0表示无需等待，可以立即重启服务。LimitNOFILE指定了服务的文件描述符的限制。</span>
<span class="token comment"># </span>
<span class="token comment"># [Install]部分指定了在哪些target下该单位应该被启用。</span>
<span class="token comment"># </span>
<span class="token comment"># 综上所述，此单位文件用于启动和管理kube-apiserver的NGINX代理服务。它通过NGINX来反向代理和负载均衡kube-apiserver的请求。该服务会在系统启动时自动启动，并具有自动重启的机制。</span>


<span class="token comment"># 设置开机自启</span>

systemctl daemon-reload
<span class="token comment"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-nginx.service
<span class="token comment"># 启用并立即启动kube-nginx.service单元。kube-nginx.service是kube-nginx守护进程的systemd服务单元。</span>
systemctl restart kube-nginx.service
<span class="token comment"># 重启kube-nginx.service单元，即重新启动kube-nginx守护进程。</span>
systemctl status kube-nginx.service
<span class="token comment"># kube-nginx.service单元的当前状态，包括运行状态、是否启用等信息。</span>
</code></pre> 
<h3><a id="52_keepalivedhaproxy___3169"></a>5.2 keepalived和haproxy 高可用方案 (不推荐)</h3> 
<h4><a id="521_keepalivedhaproxy_3171"></a>5.2.1 安装keepalived和haproxy服务</h4> 
<pre><code class="prism language-shell">systemctl disable <span class="token parameter variable">--now</span> firewalld
setenforce <span class="token number">0</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> keepalived haproxy
</code></pre> 
<h4><a id="522_haproxy_3180"></a>5.2.2 修改haproxy配置文件（配置文件一样）</h4> 
<pre><code class="prism language-shell"><span class="token comment"># cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span>/etc/haproxy/haproxy.cfg<span class="token operator">&lt;&lt;</span><span class="token string">"EOF"
global
 maxconn 2000
 ulimit-n 16384
 log 127.0.0.1 local0 err
 stats timeout 30s

defaults
 log global
 mode http
 option httplog
 timeout connect 5000
 timeout client 50000
 timeout server 50000
 timeout http-request 15s
 timeout http-keep-alive 15s


frontend monitor-in
 bind *:33305
 mode http
 option httplog
 monitor-uri /monitor

frontend k8s-master
 bind 0.0.0.0:9443
 bind 127.0.0.1:9443
 mode tcp
 option tcplog
 tcp-request inspect-delay 5s
 default_backend k8s-master


backend k8s-master
 mode tcp
 option tcplog
 option tcp-check
 balance roundrobin
 default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
 server  k8s-master01  192.168.0.31:6443 check
 server  k8s-master02  192.168.0.32:6443 check
 server  k8s-master03  192.168.0.33:6443 check
EOF</span>
</code></pre> 
<p>参数</p> 
<pre><code class="prism language-shell">这段配置代码是指定了一个HAProxy负载均衡器的配置。下面对各部分进行详细解释：
<span class="token number">1</span>. global:
   - maxconn <span class="token number">2000</span>: 设置每个进程的最大连接数为2000。
   - ulimit-n <span class="token number">16384</span>: 设置每个进程的最大文件描述符数为16384。
   - log <span class="token number">127.0</span>.0.1 local0 err: 指定日志的输出地址为本地主机的127.0.0.1，并且只记录错误级别的日志。
   - stats <span class="token function">timeout</span> 30s: 设置查看负载均衡器统计信息的超时时间为30秒。

<span class="token number">2</span>. defaults:
   - log global: 使默认日志与global部分相同。
   - mode http: 设定负载均衡器的工作模式为HTTP模式。
   - option httplog: 使负载均衡器记录HTTP协议的日志。
   - <span class="token function">timeout</span> connect <span class="token number">5000</span>: 设置与后端服务器建立连接的超时时间为5秒。
   - <span class="token function">timeout</span> client <span class="token number">50000</span>: 设置与客户端的连接超时时间为50秒。
   - <span class="token function">timeout</span> server <span class="token number">50000</span>: 设置与后端服务器连接的超时时间为50秒。
   - <span class="token function">timeout</span> http-request 15s: 设置处理HTTP请求的超时时间为15秒。
   - <span class="token function">timeout</span> http-keep-alive 15s: 设置保持HTTP连接的超时时间为15秒。

<span class="token number">3</span>. frontend monitor-in:
   - <span class="token builtin class-name">bind</span> *:33305: 监听所有IP地址的33305端口。
   - mode http: 设定frontend的工作模式为HTTP模式。
   - option httplog: 记录HTTP协议的日志。
   - monitor-uri /monitor: 设置监控URI为/monitor。

<span class="token number">4</span>. frontend k8s-master:
   - <span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0:9443: 监听所有IP地址的9443端口。
   - <span class="token builtin class-name">bind</span> <span class="token number">127.0</span>.0.1:9443: 监听本地主机的9443端口。
   - mode tcp: 设定frontend的工作模式为TCP模式。
   - option tcplog: 记录TCP协议的日志。
   - tcp-request inspect-delay 5s: 设置在接收到请求后延迟5秒进行检查。
   - default_backend k8s-master: 设置默认的后端服务器组为k8s-master。

<span class="token number">5</span>. backend k8s-master:
   - mode tcp: 设定backend的工作模式为TCP模式。
   - option tcplog: 记录TCP协议的日志。
   - option tcp-check: 启用TCP检查功能。
   - balance roundrobin: 使用轮询算法进行负载均衡。
   - default-server inter 10s downinter 5s rise <span class="token number">2</span> fall <span class="token number">2</span> slowstart 60s maxconn <span class="token number">250</span> maxqueue <span class="token number">256</span> weight <span class="token number">100</span>: 设置默认的服务器参数。
   - server k8s-master01 <span class="token number">192.168</span>.0.31:6443 check: 增加一个名为k8s-master01的服务器，IP地址为192.168.0.31，端口号为6443，并对其进行健康检查。
   - server k8s-master02 <span class="token number">192.168</span>.0.32:6443 check: 增加一个名为k8s-master02的服务器，IP地址为192.168.0.32，端口号为6443，并对其进行健康检查。
   - server k8s-master03 <span class="token number">192.168</span>.0.33:6443 check: 增加一个名为k8s-master03的服务器，IP地址为192.168.0.33，端口号为6443，并对其进行健康检查。

以上就是这段配置代码的详细解释。它主要定义了全局配置、默认配置、前端监听和后端服务器组的相关参数和设置。通过这些配置，可以实现负载均衡和监控功能。
</code></pre> 
<h4><a id="523_Master01keepalived_master_3276"></a>5.2.3 Master01配置keepalived master节点</h4> 
<pre><code class="prism language-shell"><span class="token comment">#cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/keepalived/keepalived.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
! Configuration File for keepalived

global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5 
    weight -5
    fall 2
    rise 1
}
vrrp_instance VI_1 {
    state MASTER
    # 注意网卡名
    interface eth0 
    mcast_src_ip 192.168.0.31
    virtual_router_id 51
    priority 100
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.0.36
    }
    track_script {
      chk_apiserver 
} }

EOF</span>
</code></pre> 
<h4><a id="524_Master02keepalived_backup_3317"></a>5.2.4 Master02配置keepalived backup节点</h4> 
<pre><code class="prism language-shell"><span class="token comment"># cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/keepalived/keepalived.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
! Configuration File for keepalived

global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5 
    weight -5
    fall 2
    rise 1

}
vrrp_instance VI_1 {
    state BACKUP
    # 注意网卡名
    interface eth0
    mcast_src_ip 192.168.0.32
    virtual_router_id 51
    priority 80
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.0.36
    }
    track_script {
      chk_apiserver 
} }

EOF</span>
</code></pre> 
<h4><a id="525_Master03keepalived_backup_3359"></a>5.2.5 Master03配置keepalived backup节点</h4> 
<pre><code class="prism language-shell"><span class="token comment"># cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/keepalived/keepalived.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
! Configuration File for keepalived

global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5 
    weight -5
    fall 2
    rise 1

}
vrrp_instance VI_1 {
    state BACKUP
    # 注意网卡名
    interface eth0
    mcast_src_ip 192.168.0.33
    virtual_router_id 51
    priority 50
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.0.36
    }
    track_script {
      chk_apiserver 
} }

EOF</span>
</code></pre> 
<p>参数</p> 
<pre><code class="prism language-shell">这是一个用于配置keepalived的配置文件。下面是对每个部分的详细解释：

- <span class="token variable"><span class="token variable">`</span>global_defs<span class="token variable">`</span></span>部分定义了全局参数。
- <span class="token variable"><span class="token variable">`</span>router_id<span class="token variable">`</span></span>参数指定了当前路由器的标识，这里设置为<span class="token string">"LVS_DEVEL"</span>。

- <span class="token variable"><span class="token variable">`</span>vrrp_script<span class="token variable">`</span></span>部分定义了一个VRRP脚本。<span class="token variable"><span class="token variable">`</span>chk_apiserver<span class="token variable">`</span></span>是脚本的名称，
    - <span class="token variable"><span class="token variable">`</span>script<span class="token variable">`</span></span>参数指定了脚本的路径。该脚本每5秒执行一次，返回值为0表示服务正常，返回值为1表示服务异常。
    - <span class="token variable"><span class="token variable">`</span>weight<span class="token variable">`</span></span>参数指定了根据脚本返回的值来调整优先级，这里设置为-5。
    - <span class="token variable"><span class="token variable">`</span>fall<span class="token variable">`</span></span>参数指定了失败阈值，当连续2次脚本返回值为1时认为服务异常。
    - <span class="token variable"><span class="token variable">`</span>rise<span class="token variable">`</span></span>参数指定了恢复阈值，当连续1次脚本返回值为0时认为服务恢复正常。

- <span class="token variable"><span class="token variable">`</span>vrrp_instance<span class="token variable">`</span></span>部分定义了一个VRRP实例。<span class="token variable"><span class="token variable">`</span>VI_1<span class="token variable">`</span></span>是实例的名称。
    - <span class="token variable"><span class="token variable">`</span>state<span class="token variable">`</span></span>参数指定了当前实例的状态，这里设置为MASTER表示当前实例是主节点。
    - <span class="token variable"><span class="token variable">`</span>interface<span class="token variable">`</span></span>参数指定了要监听的网卡，这里设置为eth0。
    - <span class="token variable"><span class="token variable">`</span>mcast_src_ip<span class="token variable">`</span></span>参数指定了VRRP报文的源IP地址，这里设置为192.168.0.31。
    - <span class="token variable"><span class="token variable">`</span>virtual_router_id<span class="token variable">`</span></span>参数指定了虚拟路由器的ID，这里设置为51。
    - <span class="token variable"><span class="token variable">`</span>priority<span class="token variable">`</span></span>参数指定了实例的优先级，优先级越高（数值越大）越有可能被选为主节点。
    - <span class="token variable"><span class="token variable">`</span>nopreempt<span class="token variable">`</span></span>参数指定了当主节点失效后不要抢占身份，即不要自动切换为主节点。
    - <span class="token variable"><span class="token variable">`</span>advert_int<span class="token variable">`</span></span>参数指定了发送广播的间隔时间，这里设置为2秒。
    - <span class="token variable"><span class="token variable">`</span>authentication<span class="token variable">`</span></span>部分指定了认证参数
    	- <span class="token variable"><span class="token variable">`</span>auth_type<span class="token variable">`</span></span>参数指定了认证类型，这里设置为PASS表示使用密码认证，
    	- <span class="token variable"><span class="token variable">`</span>auth_pass<span class="token variable">`</span></span>参数指定了认证密码，这里设置为K8SHA_KA_AUTH。
    - <span class="token variable"><span class="token variable">`</span>virtual_ipaddress<span class="token variable">`</span></span>部分指定了虚拟IP地址，这里设置为192.168.0.36。
    - <span class="token variable"><span class="token variable">`</span>track_script<span class="token variable">`</span></span>部分指定了要跟踪的脚本，这里跟踪了chk_apiserver脚本。
</code></pre> 
<h4><a id="526_lb_3430"></a>5.2.6 健康检查脚本配置（lb主机）</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span>  /etc/keepalived/check_apiserver.sh <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
#!/bin/bash

err=0
for k in \<span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">3</span><span class="token variable">)</span></span>
do
    check_code=\<span class="token variable"><span class="token variable">$(</span>pgrep haproxy<span class="token variable">)</span></span>
    if [[ \<span class="token variable">$check_code</span> == "" ]]; then
        err=\<span class="token variable"><span class="token variable">$(</span><span class="token function">expr</span> <span class="token punctuation">\</span>$err + <span class="token number">1</span><span class="token variable">)</span></span>
        sleep 1
        continue
    else
        err=0
        break
    fi
done

if [[ \<span class="token variable">$err</span> != "0" ]]; then
    echo "systemctl stop keepalived"
    /usr/bin/systemctl stop keepalived
    exit 1
else
    exit 0
fi
EOF</span>

<span class="token comment"># 给脚本授权</span>

<span class="token function">chmod</span> +x /etc/keepalived/check_apiserver.sh

<span class="token comment"># 这段脚本是一个简单的bash脚本，主要用来检查是否有名为haproxy的进程正在运行。</span>
<span class="token comment"># </span>
<span class="token comment"># 脚本的主要逻辑如下：</span>
<span class="token comment"># 1. 首先设置一个变量err为0，用来记录错误次数。</span>
<span class="token comment"># 2. 使用一个循环，在循环内部执行以下操作：</span>
<span class="token comment">#    a. 使用pgrep命令检查是否有名为haproxy的进程在运行。如果不存在该进程，将err加1，并暂停1秒钟，然后继续下一次循环。</span>
<span class="token comment">#    b. 如果存在haproxy进程，将err重置为0，并跳出循环。</span>
<span class="token comment"># 3. 检查err的值，如果不为0，表示检查失败，输出一条错误信息并执行“systemctl stop keepalived”命令停止keepalived进程，并退出脚本返回1。</span>
<span class="token comment"># 4. 如果err的值为0，表示检查成功，退出脚本返回0。</span>
<span class="token comment"># </span>
<span class="token comment"># 该脚本的主要作用是检查是否存在运行中的haproxy进程，如果无法检测到haproxy进程，将停止keepalived进程并返回错误状态。如果haproxy进程存在，则返回成功状态。这个脚本可能是作为一个健康检查脚本的一部分，在确保haproxy服务可用的情况下，才继续运行其他操作。</span>
</code></pre> 
<h4><a id="527__3476"></a>5.2.7 启动服务</h4> 
<pre><code class="prism language-shell">systemctl daemon-reload
<span class="token comment"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> haproxy.service
<span class="token comment"># 启用并立即启动haproxy.service单元。haproxy.service是haproxy守护进程的systemd服务单元。</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> keepalived.service
<span class="token comment"># 启用并立即启动keepalived.service单元。keepalived.service是keepalived守护进程的systemd服务单元。</span>
systemctl status haproxy.service
<span class="token comment"># haproxy.service单元的当前状态，包括运行状态、是否启用等信息。</span>
systemctl status keepalived.service
<span class="token comment"># keepalived.service单元的当前状态，包括运行状态、是否启用等信息。</span>
</code></pre> 
<h4><a id="528__3491"></a>5.2.8 测试高可用</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 能ping同</span>

<span class="token punctuation">[</span>root@k8s-node02 ~<span class="token punctuation">]</span><span class="token comment"># ping 192.168.0.36</span>

<span class="token comment"># 能telnet访问</span>

<span class="token punctuation">[</span>root@k8s-node02 ~<span class="token punctuation">]</span><span class="token comment"># telnet 192.168.0.36 9443</span>

<span class="token comment"># 关闭主节点，看vip是否漂移到备节点</span>
</code></pre> 
<h2><a id="6k8s_3505"></a>6.k8s组件配置</h2> 
<p>所有k8s节点创建以下目录</p> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes
</code></pre> 
<h3><a id="61apiservermaster_3513"></a>6.1.创建apiserver（所有master节点）</h3> 
<h4><a id="611_master01_3515"></a>6.1.1 master01节点配置</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-apiserver.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver <span class="token entity" title="\\">\\</span>
      --v=2  <span class="token entity" title="\\">\\</span>
      --allow-privileged=true  <span class="token entity" title="\\">\\</span>
      --bind-address=0.0.0.0  <span class="token entity" title="\\">\\</span>
      --secure-port=6443  <span class="token entity" title="\\">\\</span>
      --advertise-address=192.168.0.31 <span class="token entity" title="\\">\\</span>
      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  <span class="token entity" title="\\">\\</span>
      --service-node-port-range=30000-32767  <span class="token entity" title="\\">\\</span>
      --etcd-servers=https://192.168.0.31:2379,https://192.168.0.32:2379,https://192.168.0.33:2379 <span class="token entity" title="\\">\\</span>
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  <span class="token entity" title="\\">\\</span>
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  <span class="token entity" title="\\">\\</span>
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  <span class="token entity" title="\\">\\</span>
      --client-ca-file=/etc/kubernetes/pki/ca.pem  <span class="token entity" title="\\">\\</span>
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  <span class="token entity" title="\\">\\</span>
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  <span class="token entity" title="\\">\\</span>
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  <span class="token entity" title="\\">\\</span>
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  <span class="token entity" title="\\">\\</span>
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  <span class="token entity" title="\\">\\</span>
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  <span class="token entity" title="\\">\\</span>
      --service-account-issuer=https://kubernetes.default.svc.cluster.local <span class="token entity" title="\\">\\</span>
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  <span class="token entity" title="\\">\\</span>
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
      --authorization-mode=Node,RBAC  <span class="token entity" title="\\">\\</span>
      --enable-bootstrap-token-auth=true  <span class="token entity" title="\\">\\</span>
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token entity" title="\\">\\</span>
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  <span class="token entity" title="\\">\\</span>
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token entity" title="\\">\\</span>
      --requestheader-allowed-names=aggregator  <span class="token entity" title="\\">\\</span>
      --requestheader-group-headers=X-Remote-Group  <span class="token entity" title="\\">\\</span>
      --requestheader-extra-headers-prefix=X-Remote-Extra-  <span class="token entity" title="\\">\\</span>
      --requestheader-username-headers=X-Remote-User <span class="token entity" title="\\">\\</span>
      --enable-aggregator-routing=true
Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target

EOF</span>
</code></pre> 
<h4><a id="612_master02_3567"></a>6.1.2 master02节点配置</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-apiserver.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver <span class="token entity" title="\\">\\</span>
      --v=2  <span class="token entity" title="\\">\\</span>
      --allow-privileged=true  <span class="token entity" title="\\">\\</span>
      --bind-address=0.0.0.0  <span class="token entity" title="\\">\\</span>
      --secure-port=6443  <span class="token entity" title="\\">\\</span>
      --advertise-address=192.168.0.32 <span class="token entity" title="\\">\\</span>
      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  <span class="token entity" title="\\">\\</span>
      --service-node-port-range=30000-32767  <span class="token entity" title="\\">\\</span>
      --etcd-servers=https://192.168.0.31:2379,https://192.168.0.32:2379,https://192.168.0.33:2379 <span class="token entity" title="\\">\\</span>
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  <span class="token entity" title="\\">\\</span>
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  <span class="token entity" title="\\">\\</span>
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  <span class="token entity" title="\\">\\</span>
      --client-ca-file=/etc/kubernetes/pki/ca.pem  <span class="token entity" title="\\">\\</span>
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  <span class="token entity" title="\\">\\</span>
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  <span class="token entity" title="\\">\\</span>
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  <span class="token entity" title="\\">\\</span>
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  <span class="token entity" title="\\">\\</span>
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  <span class="token entity" title="\\">\\</span>
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  <span class="token entity" title="\\">\\</span>
      --service-account-issuer=https://kubernetes.default.svc.cluster.local <span class="token entity" title="\\">\\</span>
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  <span class="token entity" title="\\">\\</span>
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token entity" title="\\">\\</span>
      --authorization-mode=Node,RBAC  <span class="token entity" title="\\">\\</span>
      --enable-bootstrap-token-auth=true  <span class="token entity" title="\\">\\</span>
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token entity" title="\\">\\</span>
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  <span class="token entity" title="\\">\\</span>
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token entity" title="\\">\\</span>
      --requestheader-allowed-names=aggregator  <span class="token entity" title="\\">\\</span>
      --requestheader-group-headers=X-Remote-Group  <span class="token entity" title="\\">\\</span>
      --requestheader-extra-headers-prefix=X-Remote-Extra-  <span class="token entity" title="\\">\\</span>
      --requestheader-username-headers=X-Remote-User <span class="token entity" title="\\">\\</span>
      --enable-aggregator-routing=true

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target

EOF</span>
</code></pre> 
<h4><a id="613_master03_3619"></a>6.1.3 master03节点配置</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-apiserver.service  <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver <span class="token entity" title="\\">\\</span>
      --v=2  <span class="token entity" title="\\">\\</span>
      --allow-privileged=true  <span class="token entity" title="\\">\\</span>
      --bind-address=0.0.0.0  <span class="token entity" title="\\">\\</span>
      --secure-port=6443  <span class="token entity" title="\\">\\</span>
      --advertise-address=192.168.0.33 <span class="token entity" title="\\">\\</span>
      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  <span class="token entity" title="\\">\\</span>
      --service-node-port-range=30000-32767  <span class="token entity" title="\\">\\</span>
      --etcd-servers=https://192.168.0.31:2379,https://192.168.0.32:2379,https://192.168.0.33:2379 <span class="token entity" title="\\">\\</span>
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  <span class="token entity" title="\\">\\</span>
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  <span class="token entity" title="\\">\\</span>
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  <span class="token entity" title="\\">\\</span>
      --client-ca-file=/etc/kubernetes/pki/ca.pem  <span class="token entity" title="\\">\\</span>
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  <span class="token entity" title="\\">\\</span>
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  <span class="token entity" title="\\">\\</span>
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  <span class="token entity" title="\\">\\</span>
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  <span class="token entity" title="\\">\\</span>
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  <span class="token entity" title="\\">\\</span>
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  <span class="token entity" title="\\">\\</span>
      --service-account-issuer=https://kubernetes.default.svc.cluster.local <span class="token entity" title="\\">\\</span>
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  <span class="token entity" title="\\">\\</span>
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class="token entity" title="\\">\\</span>
      --authorization-mode=Node,RBAC  <span class="token entity" title="\\">\\</span>
      --enable-bootstrap-token-auth=true  <span class="token entity" title="\\">\\</span>
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  <span class="token entity" title="\\">\\</span>
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  <span class="token entity" title="\\">\\</span>
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  <span class="token entity" title="\\">\\</span>
      --requestheader-allowed-names=aggregator  <span class="token entity" title="\\">\\</span>
      --requestheader-group-headers=X-Remote-Group  <span class="token entity" title="\\">\\</span>
      --requestheader-extra-headers-prefix=X-Remote-Extra-  <span class="token entity" title="\\">\\</span>
      --requestheader-username-headers=X-Remote-User <span class="token entity" title="\\">\\</span>
      --enable-aggregator-routing=true

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target

EOF</span>
</code></pre> 
<p>参数</p> 
<pre><code class="prism language-shell">该配置文件是用于定义Kubernetes API Server的systemd服务的配置。systemd是一个用于启动和管理Linux系统服务的守护进程。

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
- Description: 服务的描述信息，用于显示在日志和系统管理工具中。
- Documentation: 提供关于服务的文档链接。
- After: 规定服务依赖于哪些其他服务或单元。在这个例子中，API Server服务在网络目标启动之后启动。

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
- ExecStart: 定义服务的命令行参数和命令。这里指定了API Server的启动命令，包括各种参数选项。
- Restart: 指定当服务退出时应该如何重新启动。在这个例子中，服务在失败时将被重新启动。
- RestartSec: 指定两次重新启动之间的等待时间。
- LimitNOFILE: 指定进程可以打开的文件描述符的最大数量。

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
- WantedBy: 指定服务应该安装到哪个系统目标。在这个例子中，服务将被安装到multi-user.target目标，以便在多用户模式下启动。

上述配置文件中定义的kube-apiserver服务将以指定的参数运行，这些参数包括：

- <span class="token variable"><span class="token variable">`</span><span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span><span class="token variable">`</span></span> 指定日志级别为2，打印详细的API Server日志。
- <span class="token variable"><span class="token variable">`</span>--allow-privileged<span class="token operator">=</span>true<span class="token variable">`</span></span> 允许特权容器运行。
- <span class="token variable"><span class="token variable">`</span>--bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0<span class="token variable">`</span></span> 绑定API Server监听的IP地址。
- <span class="token variable"><span class="token variable">`</span>--secure-port<span class="token operator">=</span><span class="token number">6443</span><span class="token variable">`</span></span> 指定API Server监听的安全端口。
- <span class="token variable"><span class="token variable">`</span>--advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.0.31<span class="token variable">`</span></span> 广告API Server的地址。
- <span class="token variable"><span class="token variable">`</span>--service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12,fd00:1111::/112<span class="token variable">`</span></span> 指定服务CIDR范围。
- <span class="token variable"><span class="token variable">`</span>--service-node-port-range<span class="token operator">=</span><span class="token number">30000</span>-32767<span class="token variable">`</span></span> 指定NodePort的范围。
- <span class="token variable"><span class="token variable">`</span>--etcd-servers<span class="token operator">=</span>https://192.168.0.31:2379,https://192.168.0.32:2379,https://192.168.0.33:2379<span class="token variable">`</span></span> 指定etcd服务器的地址。
- <span class="token variable"><span class="token variable">`</span>--etcd-cafile<span class="token variable">`</span></span> 指定etcd服务器的CA证书。
- <span class="token variable"><span class="token variable">`</span>--etcd-certfile<span class="token variable">`</span></span> 指定etcd服务器的证书。
- <span class="token variable"><span class="token variable">`</span>--etcd-keyfile<span class="token variable">`</span></span> 指定etcd服务器的私钥。
- <span class="token variable"><span class="token variable">`</span>--client-ca-file<span class="token variable">`</span></span> 指定客户端CA证书。
- <span class="token variable"><span class="token variable">`</span>--tls-cert-file<span class="token variable">`</span></span> 指定服务的证书。
- <span class="token variable"><span class="token variable">`</span>--tls-private-key-file<span class="token variable">`</span></span> 指定服务的私钥。
- <span class="token variable"><span class="token variable">`</span>--kubelet-client-certificate<span class="token variable">`</span></span> 和 <span class="token variable"><span class="token variable">`</span>--kubelet-client-key<span class="token variable">`</span></span> 指定与kubelet通信的客户端证书和私钥。
- <span class="token variable"><span class="token variable">`</span>--service-account-key-file<span class="token variable">`</span></span> 指定服务账户公钥文件。
- <span class="token variable"><span class="token variable">`</span>--service-account-signing-key-file<span class="token variable">`</span></span> 指定服务账户签名密钥文件。
- <span class="token variable"><span class="token variable">`</span>--service-account-issuer<span class="token variable">`</span></span> 指定服务账户的发布者。
- <span class="token variable"><span class="token variable">`</span>--kubelet-preferred-address-types<span class="token variable">`</span></span> 指定kubelet通信时的首选地址类型。
- <span class="token variable"><span class="token variable">`</span>--enable-admission-plugins<span class="token variable">`</span></span> 启用一系列准入插件。
- <span class="token variable"><span class="token variable">`</span>--authorization-mode<span class="token variable">`</span></span> 指定授权模式。
- <span class="token variable"><span class="token variable">`</span>--enable-bootstrap-token-auth<span class="token variable">`</span></span> 启用引导令牌认证。
- <span class="token variable"><span class="token variable">`</span>--requestheader-client-ca-file<span class="token variable">`</span></span> 指定请求头中的客户端CA证书。
- <span class="token variable"><span class="token variable">`</span>--proxy-client-cert-file<span class="token variable">`</span></span> 和 <span class="token variable"><span class="token variable">`</span>--proxy-client-key-file<span class="token variable">`</span></span> 指定代理客户端的证书和私钥。
- <span class="token variable"><span class="token variable">`</span>--requestheader-allowed-names<span class="token variable">`</span></span> 指定请求头中允许的名字。
- <span class="token variable"><span class="token variable">`</span>--requestheader-group-headers<span class="token variable">`</span></span> 指定请求头中的组头。
- <span class="token variable"><span class="token variable">`</span>--requestheader-extra-headers-prefix<span class="token variable">`</span></span> 指定请求头中的额外头前缀。
- <span class="token variable"><span class="token variable">`</span>--requestheader-username-headers<span class="token variable">`</span></span> 指定请求头中的用户名头。
- <span class="token variable"><span class="token variable">`</span>--enable-aggregator-routing<span class="token variable">`</span></span> 启用聚合路由。

整个配置文件为Kubernetes API Server提供了必要的参数，以便正确地启动和运行。
</code></pre> 
<h4><a id="614_apiservermaster_3725"></a>6.1.4 启动apiserver（所有master节点）</h4> 
<pre><code class="prism language-shell">systemctl daemon-reload
<span class="token comment"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span>

systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-apiserver.service
<span class="token comment"># 启用并立即启动kube-apiserver.service单元。kube-apiserver.service是kube-apiserver守护进程的systemd服务单元。</span>

systemctl restart kube-apiserver.service
<span class="token comment"># 重启kube-apiserver.service单元，即重新启动etcd守护进程。</span>

systemctl status kube-apiserver.service
<span class="token comment"># kube-apiserver.service单元的当前状态，包括运行状态、是否启用等信息。</span>
</code></pre> 
<h3><a id="62kubecontrollermanager_servicemaster_3741"></a>6.2.配置kube-controller-manager service（所有master节点）</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 所有master节点配置，且配置相同</span>
<span class="token comment"># 172.16.0.0/12为pod网段，按需求设置你自己的网段</span>

<span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-controller-manager.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-controller-manager <span class="token entity" title="\\">\\</span>
      --v=2 <span class="token entity" title="\\">\\</span>
      --bind-address=0.0.0.0 <span class="token entity" title="\\">\\</span>
      --root-ca-file=/etc/kubernetes/pki/ca.pem <span class="token entity" title="\\">\\</span>
      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem <span class="token entity" title="\\">\\</span>
      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem <span class="token entity" title="\\">\\</span>
      --service-account-private-key-file=/etc/kubernetes/pki/sa.key <span class="token entity" title="\\">\\</span>
      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig <span class="token entity" title="\\">\\</span>
      --leader-elect=true <span class="token entity" title="\\">\\</span>
      --use-service-account-credentials=true <span class="token entity" title="\\">\\</span>
      --node-monitor-grace-period=40s <span class="token entity" title="\\">\\</span>
      --node-monitor-period=5s <span class="token entity" title="\\">\\</span>
      --controllers=*,bootstrapsigner,tokencleaner <span class="token entity" title="\\">\\</span>
      --allocate-node-cidrs=true <span class="token entity" title="\\">\\</span>
      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112 <span class="token entity" title="\\">\\</span>
      --cluster-cidr=172.16.0.0/12,fc00:2222::/112 <span class="token entity" title="\\">\\</span>
      --node-cidr-mask-size-ipv4=24 <span class="token entity" title="\\">\\</span>
      --node-cidr-mask-size-ipv6=120 <span class="token entity" title="\\">\\</span>
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target

EOF</span>
</code></pre> 
<p>参数</p> 
<pre><code class="prism language-shell">这是一个用于启动 Kubernetes 控制器管理器的 systemd 服务单元文件。下面是对每个部分的详细解释：

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>：单元的基本信息部分，用于描述和标识这个服务单元。
Description：服务单元的描述信息，说明了该服务单元的作用，这里是 Kubernetes 控制器管理器。
Documentation：可选项，提供了关于该服务单元的文档链接。
After：定义了该服务单元在哪些其他单元之后启动，这里是 network.target，即在网络服务启动之后启动。

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>：定义了服务的运行参数和行为。
ExecStart：指定服务启动时执行的命令，这里是 /usr/local/bin/kube-controller-manager，并通过后续的行继续传递了一系列的参数设置。
Restart：定义了服务在退出后的重新启动策略，这里设置为 always，表示总是重新启动服务。
RestartSec：定义了重新启动服务的时间间隔，这里设置为 <span class="token number">10</span> 秒。

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>：定义了如何安装和启用服务单元。
WantedBy：指定了服务单元所属的 target，这里是 multi-user.target，表示启动多用户模式下的服务。
在 ExecStart 中传递的参数说明如下：

<span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span>：设置日志的详细级别为 <span class="token number">2</span>。
--bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0：绑定的 IP 地址，用于监听 Kubernetes 控制平面的请求，这里设置为 <span class="token number">0.0</span>.0.0，表示监听所有网络接口上的请求。
--root-ca-file：根证书文件的路径，用于验证其他组件的证书。
--cluster-signing-cert-file：用于签名集群证书的证书文件路径。
--cluster-signing-key-file：用于签名集群证书的私钥文件路径。
--service-account-private-key-file：用于签名服务账户令牌的私钥文件路径。
--kubeconfig：kubeconfig 文件的路径，包含了与 Kubernetes API 服务器通信所需的配置信息。
--leader-elect<span class="token operator">=</span>true：启用 Leader 选举机制，确保只有一个控制器管理器作为 leader 在运行。
--use-service-account-credentials<span class="token operator">=</span>true：使用服务账户的凭据进行认证和授权。
--node-monitor-grace-period<span class="token operator">=</span>40s：节点监控的优雅退出时间，节点长时间不响应时会触发节点驱逐。
--node-monitor-period<span class="token operator">=</span>5s：节点监控的检测周期，用于检测节点是否正常运行。
--controllers：指定要运行的控制器类型，在这里使用了通配符 *，表示运行所有的控制器，同时还包括了 bootstrapsigner 和 tokencleaner 控制器。
--allocate-node-cidrs<span class="token operator">=</span>true：为节点分配 CIDR 子网，用于分配 Pod 网络地址。
--service-cluster-ip-range：定义 Service 的 IP 范围，这里设置为 <span class="token number">10.96</span>.0.0/12 和 fd00::/108。
--cluster-cidr：定义集群的 CIDR 范围，这里设置为 <span class="token number">172.16</span>.0.0/12 和 fc00::/48。
--node-cidr-mask-size-ipv4：分配给每个节点的 IPv4 子网掩码大小，默认是 <span class="token number">24</span>。
--node-cidr-mask-size-ipv6：分配给每个节点的 IPv6 子网掩码大小，默认是 <span class="token number">120</span>。
--requestheader-client-ca-file：设置请求头中客户端 CA 的证书文件路径，用于认证请求头中的 CA 证书。

这个服务单元文件描述了 Kubernetes 控制器管理器的启动参数和行为，并且定义了服务的依赖关系和重新启动策略。通过 systemd 启动该服务单元，即可启动 Kubernetes 控制器管理器组件。
</code></pre> 
<h4><a id="621_kubecontrollermanager_3821"></a>6.2.1 启动kube-controller-manager，并查看状态</h4> 
<pre><code class="prism language-shell">systemctl daemon-reload
<span class="token comment"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span>

systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-controller-manager.service
<span class="token comment"># 启用并立即启动kube-controller-manager.service单元。kube-controller-manager.service是kube-controller-manager守护进程的systemd服务单元。</span>

systemctl restart kube-controller-manager.service
<span class="token comment"># 重启kube-controller-manager.service单元，即重新启动etcd守护进程。</span>

systemctl status kube-controller-manager.service
<span class="token comment"># kube-controller-manager.service单元的当前状态，包括运行状态、是否启用等信息。</span>
</code></pre> 
<h3><a id="63kubescheduler_servicemaster_3837"></a>6.3.配置kube-scheduler service（所有master节点）</h3> 
<h4><a id="631_master_3839"></a>6.3.1 所有master节点配置，且配置相同</h4> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-scheduler.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-scheduler <span class="token entity" title="\\">\\</span>
      --v=2 <span class="token entity" title="\\">\\</span>
      --bind-address=0.0.0.0 <span class="token entity" title="\\">\\</span>
      --leader-elect=true <span class="token entity" title="\\">\\</span>
      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target

EOF</span>
</code></pre> 
<p>参数</p> 
<pre><code class="prism language-shell">这是一个用于启动 Kubernetes 调度器的 systemd 服务单元文件。下面是对每个部分的详细解释：

<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>：单元的基本信息部分，用于描述和标识这个服务单元。
Description：服务单元的描述信息，说明了该服务单元的作用，这里是 Kubernetes 调度器。
Documentation：可选项，提供了关于该服务单元的文档链接。
After：定义了该服务单元在哪些其他单元之后启动，这里是 network.target，即在网络服务启动之后启动。

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>：定义了服务的运行参数和行为。
ExecStart：指定服务启动时执行的命令，这里是 /usr/local/bin/kube-scheduler，并通过后续的行继续传递了一系列的参数设置。
Restart：定义了服务在退出后的重新启动策略，这里设置为 always，表示总是重新启动服务。
RestartSec：定义了重新启动服务的时间间隔，这里设置为 <span class="token number">10</span> 秒。

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>：定义了如何安装和启用服务单元。
WantedBy：指定了服务单元所属的 target，这里是 multi-user.target，表示启动多用户模式下的服务。

在 ExecStart 中传递的参数说明如下：

<span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">2</span>：设置日志的详细级别为 <span class="token number">2</span>。
--bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0：绑定的 IP 地址，用于监听 Kubernetes 控制平面的请求，这里设置为 <span class="token number">0.0</span>.0.0，表示监听所有网络接口上的请求。
--leader-elect<span class="token operator">=</span>true：启用 Leader 选举机制，确保只有一个调度器作为 leader 在运行。
<span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig：kubeconfig 文件的路径，包含了与 Kubernetes API 服务器通信所需的配置信息。

这个服务单元文件描述了 Kubernetes 调度器的启动参数和行为，并且定义了服务的依赖关系和重新启动策略。通过 systemd 启动该服务单元，即可启动 Kubernetes 调度器组件。
</code></pre> 
<h4><a id="632__3890"></a>6.3.2 启动并查看服务状态</h4> 
<pre><code class="prism language-shell">systemctl daemon-reload
<span class="token comment"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span>

systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-scheduler.service
<span class="token comment"># 启用并立即启动kube-scheduler.service单元。kube-scheduler.service是kube-scheduler守护进程的systemd服务单元。</span>

systemctl restart kube-scheduler.service
<span class="token comment"># 重启kube-scheduler.service单元，即重新启动etcd守护进程。</span>

systemctl status kube-scheduler.service
<span class="token comment"># kube-scheduler.service单元的当前状态，包括运行状态、是否启用等信息。</span>
</code></pre> 
<h2><a id="7TLS_Bootstrapping_3906"></a>7.TLS Bootstrapping配置</h2> 
<h3><a id="71_master01_3908"></a>7.1 在master01上配置</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 在《5.高可用配置》选择使用那种高可用方案</span>
<span class="token comment"># 若使用 haproxy、keepalived 那么为 `--server=https://192.168.0.36:8443`</span>
<span class="token comment"># 若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span>

<span class="token function">mkdir</span> ~/bootstrap
<span class="token builtin class-name">cd</span> bootstrap

kubectl config set-cluster kubernetes     <span class="token punctuation">\</span>
--certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     <span class="token punctuation">\</span>
--embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://127.0.0.1:8443     <span class="token punctuation">\</span>
<span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
<span class="token comment"># 这是一个使用 kubectl 命令设置 Kubernetes 集群配置的命令示例。下面是对每个选项的详细解释：</span>
<span class="token comment"># </span>
<span class="token comment"># config set-cluster kubernetes：指定要设置的集群名称为 "kubernetes"，表示要修改名为 "kubernetes" 的集群配置。</span>
<span class="token comment"># --certificate-authority=/etc/kubernetes/pki/ca.pem：指定证书颁发机构（CA）的证书文件路径，用于验证服务器证书的有效性。</span>
<span class="token comment"># --embed-certs=true：将证书文件嵌入到生成的 kubeconfig 文件中。这样可以避免在 kubeconfig 文件中引用外部证书文件。</span>
<span class="token comment"># --server=https://127.0.0.1:8443：指定 Kubernetes API 服务器的地址和端口，这里使用的是 https 协议和本地地址（127.0.0.1），端口号为 8443。你可以根据实际环境修改该参数。</span>
<span class="token comment"># --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span>
<span class="token comment"># 通过执行此命令，你可以设置名为 "kubernetes" 的集群配置，并提供 CA 证书、API 服务器地址和端口，并将这些配置信息嵌入到 bootstrap-kubelet.kubeconfig 文件中。这个 kubeconfig 文件可以用于认证和授权 kubelet 组件与 Kubernetes API 服务器之间的通信。请确保路径和文件名与实际环境中的配置相匹配。</span>

kubectl config set-credentials tls-bootstrap-token-user     <span class="token punctuation">\</span>
<span class="token parameter variable">--token</span><span class="token operator">=</span>c8ad9c.2e4d610cf3e7426e <span class="token punctuation">\</span>
<span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
<span class="token comment"># 这是一个使用 kubectl 命令设置凭证信息的命令示例。下面是对每个选项的详细解释：</span>
<span class="token comment"># </span>
<span class="token comment"># config set-credentials tls-bootstrap-token-user：指定要设置的凭证名称为 "tls-bootstrap-token-user"，表示要修改名为 "tls-bootstrap-token-user" 的用户凭证配置。</span>
<span class="token comment"># --token=c8ad9c.2e4d610cf3e7426e：指定用户的身份验证令牌（token）。在这个示例中，令牌是 c8ad9c.2e4d610cf3e7426e。你可以根据实际情况修改该令牌。</span>
<span class="token comment"># --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span>
<span class="token comment"># 通过执行此命令，你可以设置名为 "tls-bootstrap-token-user" 的用户凭证，并将令牌信息加入到 bootstrap-kubelet.kubeconfig 文件中。这个 kubeconfig 文件可以用于认证和授权 kubelet 组件与 Kubernetes API 服务器之间的通信。请确保路径和文件名与实际环境中的配置相匹配。</span>

kubectl config set-context tls-bootstrap-token-user@kubernetes     <span class="token punctuation">\</span>
<span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token punctuation">\</span>
<span class="token parameter variable">--user</span><span class="token operator">=</span>tls-bootstrap-token-user     <span class="token punctuation">\</span>
<span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
<span class="token comment"># 这是一个使用 kubectl 命令设置上下文信息的命令示例。下面是对每个选项的详细解释：</span>
<span class="token comment"># </span>
<span class="token comment"># config set-context tls-bootstrap-token-user@kubernetes：指定要设置的上下文名称为 "tls-bootstrap-token-user@kubernetes"，表示要修改名为 "tls-bootstrap-token-user@kubernetes" 的上下文配置。</span>
<span class="token comment"># --cluster=kubernetes：指定上下文关联的集群名称为 "kubernetes"，表示使用名为 "kubernetes" 的集群配置。</span>
<span class="token comment"># --user=tls-bootstrap-token-user：指定上下文关联的用户凭证名称为 "tls-bootstrap-token-user"，表示使用名为 "tls-bootstrap-token-user" 的用户凭证配置。</span>
<span class="token comment"># --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span>
<span class="token comment"># 通过执行此命令，你可以设置名为 "tls-bootstrap-token-user@kubernetes" 的上下文，并将其关联到名为 "kubernetes" 的集群配置和名为 "tls-bootstrap-token-user" 的用户凭证配置。这样，bootstrap-kubelet.kubeconfig 文件就包含了完整的上下文信息，可以用于指定与 Kubernetes 集群建立连接时要使用的集群和凭证。请确保路径和文件名与实际环境中的配置相匹配。</span>

kubectl config use-context tls-bootstrap-token-user@kubernetes     <span class="token punctuation">\</span>
<span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
<span class="token comment"># 这是一个使用 kubectl 命令设置当前上下文的命令示例。下面是对每个选项的详细解释：</span>
<span class="token comment"># </span>
<span class="token comment"># config use-context tls-bootstrap-token-user@kubernetes：指定要使用的上下文名称为 "tls-bootstrap-token-user@kubernetes"，表示要将当前上下文切换为名为 "tls-bootstrap-token-user@kubernetes" 的上下文。</span>
<span class="token comment"># --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span>
<span class="token comment"># 通过执行此命令，你可以将当前上下文设置为名为 "tls-bootstrap-token-user@kubernetes" 的上下文。这样，当你执行其他 kubectl 命令时，它们将使用该上下文与 Kubernetes 集群进行交互。请确保路径和文件名与实际环境中的配置相匹配。</span>


<span class="token comment"># token的位置在bootstrap.secret.yaml，如果修改的话到这个文件修改</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /root/.kube <span class="token punctuation">;</span> <span class="token function">cp</span> /etc/kubernetes/admin.kubeconfig /root/.kube/config
</code></pre> 
<h3><a id="72_bootstrapsecretyaml_3966"></a>7.2 编写bootstrap.secret.yaml</h3> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> ~/bootstrap/bootstrap.secret.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: v1
kind: Secret
metadata:
  name: bootstrap-token-c8ad9c
  namespace: kube-system
type: bootstrap.kubernetes.io/token
stringData:
  description: "The default bootstrap token generated by 'kubelet '."
  token-id: c8ad9c
  token-secret: 2e4d610cf3e7426e
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"
  auth-extra-groups:  system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress
 
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubelet-bootstrap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:node-bootstrapper
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:bootstrappers:default-node-token
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-autoapprove-bootstrap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:bootstrappers:default-node-token
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-autoapprove-certificate-rotation
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:nodes
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - ""
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
    verbs:
      - "*"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: ""
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kube-apiserver
EOF</span>
</code></pre> 
<h3><a id="73__4060"></a>7.3 查看集群状态，没问题的话继续后续操作</h3> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 bootstrap<span class="token punctuation">]</span><span class="token comment"># kubectl get cs</span>
Warning: v1 ComponentStatus is deprecated <span class="token keyword">in</span> v1.19+
NAME                 STATUS    MESSAGE   ERROR
scheduler            Healthy   ok        
controller-manager   Healthy   ok        
etcd-0               Healthy   ok 

<span class="token comment"># 切记执行，别忘记！！！</span>
kubectl create <span class="token parameter variable">-f</span> bootstrap.secret.yaml
</code></pre> 
<h2><a id="8node_4074"></a>8.node节点配置</h2> 
<h3><a id="81master01_4076"></a>8.1.在master01上将证书复制到其他节点</h3> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /etc/kubernetes/
 
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">ssh</span> <span class="token variable">$NODE</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/pki<span class="token punctuation">;</span> <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig kube-proxy.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">scp</span> /etc/kubernetes/<span class="token variable">$FILE</span> <span class="token variable">$NODE</span>:/etc/kubernetes/<span class="token variable">${FILE}</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> 
<h3><a id="82kubelet_4084"></a>8.2.kubelet配置</h3> 
<p><strong>注意 ： 8.2.1 和 8.2.2 需要和 上方 2.1 和 2.2 对应起来</strong></p> 
<h4><a id="821_dockerRuntime_4088"></a>8.2.1 当使用docker作为Runtime（不推荐）</h4> 
<blockquote> 
 <p>所有节(master+node)点执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kubelet.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kubelet <span class="token entity" title="\\">\\</span>
    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  <span class="token entity" title="\\">\\</span>
    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig <span class="token entity" title="\\">\\</span>
    --config=/etc/kubernetes/kubelet-conf.yml <span class="token entity" title="\\">\\</span>
    --container-runtime-endpoint=unix:///run/cri-dockerd.sock  <span class="token entity" title="\\">\\</span>
    --node-labels=node.kubernetes.io/node=

[Install]
WantedBy=multi-user.target
EOF</span>

<span class="token comment"># 这是一个表示 Kubernetes Kubelet 服务的 systemd 单位文件示例。下面是对每个节（[Unit]、[Service]、[Install]）的详细解释：</span>
<span class="token comment"># </span>
<span class="token comment"># [Unit]</span>
<span class="token comment"># </span>
<span class="token comment"># Description=Kubernetes Kubelet：指定了此单位文件对应的服务描述信息为 "Kubernetes Kubelet"。</span>
<span class="token comment"># Documentation=...：指定了对该服务的文档链接。</span>
<span class="token comment"># [Service]</span>
<span class="token comment"># </span>
<span class="token comment"># ExecStart=/usr/local/bin/kubelet ...：指定了启动 Kubelet 服务的命令和参数。这里使用的是 /usr/local/bin/kubelet 命令，并传递了一系列参数来配置 Kubelet 的运行。这些参数包括：</span>
<span class="token comment"># --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定了用于引导 kubelet 的 kubeconfig 文件的路径和名称。</span>
<span class="token comment"># --kubeconfig=/etc/kubernetes/kubelet.kubeconfig：指定了 kubelet 的 kubeconfig 文件的路径和名称。</span>
<span class="token comment"># --config=/etc/kubernetes/kubelet-conf.yml：指定了 kubelet 的配置文件的路径和名称。</span>
<span class="token comment"># --container-runtime-endpoint=unix:///run/cri-dockerd.sock：指定了容器运行时接口的端点地址，这里使用的是 Docker 运行时（cri-dockerd）的 UNIX 套接字。</span>
<span class="token comment"># --node-labels=node.kubernetes.io/node=：指定了节点的标签。这里的示例只给节点添加了一个简单的标签 node.kubernetes.io/node=。</span>
<span class="token comment"># [Install]</span>
<span class="token comment"># </span>
<span class="token comment"># WantedBy=multi-user.target：指定了在 multi-user.target 被启动时，该服务应该被启用。</span>
<span class="token comment"># 通过这个单位文件，你可以配置 Kubelet 服务的启动参数，指定相关的配置文件和凭证文件，以及定义节点的标签。请确认路径和文件名与你的实际环境中的配置相匹配。</span>
</code></pre> 
<h4><a id="822_ContainerdRuntime__4131"></a>8.2.2 当使用Containerd作为Runtime （推荐）</h4> 
<blockquote> 
 <p>所有节(master+node)点执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/

<span class="token comment"># 所有k8s节点配置kubelet service</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kubelet.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF

[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=containerd.service
Requires=containerd.service

[Service]
ExecStart=/usr/local/bin/kubelet <span class="token entity" title="\\">\\</span>
    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  <span class="token entity" title="\\">\\</span>
    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig <span class="token entity" title="\\">\\</span>
    --config=/etc/kubernetes/kubelet-conf.yml <span class="token entity" title="\\">\\</span>
    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  <span class="token entity" title="\\">\\</span>
    --node-labels=node.kubernetes.io/node=

[Install]
WantedBy=multi-user.target
EOF</span>

<span class="token comment"># 这是一个表示 Kubernetes Kubelet 服务的 systemd 单位文件示例。与之前相比，添加了 After 和 Requires 字段来指定依赖关系。</span>
<span class="token comment"># </span>
<span class="token comment"># [Unit]</span>
<span class="token comment"># </span>
<span class="token comment"># Description=Kubernetes Kubelet：指定了此单位文件对应的服务描述信息为 "Kubernetes Kubelet"。</span>
<span class="token comment"># Documentation=...：指定了对该服务的文档链接。</span>
<span class="token comment"># After=containerd.service：指定了该服务在 containerd.service 服务之后启动。这表示 Kubelet 服务依赖于 containerd 服务的启动。</span>
<span class="token comment"># Requires=containerd.service：指定了该服务需要 containerd.service 服务存在。这表示 Kubelet 服务依赖于 containerd 服务的存在。</span>
<span class="token comment"># [Service]</span>
<span class="token comment"># </span>
<span class="token comment"># ExecStart=/usr/local/bin/kubelet ...：指定了启动 Kubelet 服务的命令和参数，与之前的示例相同。</span>
<span class="token comment"># --container-runtime-endpoint=unix:///run/containerd/containerd.sock：修改了容器运行时接口的端点地址，将其更改为使用 containerd 运行时（通过 UNIX 套接字）。</span>
<span class="token comment"># [Install]</span>
<span class="token comment"># </span>
<span class="token comment"># WantedBy=multi-user.target：指定了在 multi-user.target 被启动时，该服务应该被启用。</span>
<span class="token comment"># 通过这个单位文件，你可以配置 Kubelet 服务的启动参数，并指定了它依赖的 containerd 服务。确保路径和文件名与你实际环境中的配置相匹配。</span>
</code></pre> 
<h4><a id="823_k8skubelet_4177"></a>8.2.3 所有k8s节点创建kubelet的配置文件</h4> 
<blockquote> 
 <p>所有节(master+node)点执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/kubernetes/kubelet-conf.yml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: systemd
cgroupsPerQOS: true
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
containerLogMaxFiles: 5
containerLogMaxSize: 10Mi
contentType: application/vnd.kubernetes.protobuf
cpuCFSQuota: true
cpuManagerPolicy: none
cpuManagerReconcilePeriod: 10s
enableControllerAttachDetach: true
enableDebuggingHandlers: true
enforceNodeAllocatable:
- pods
eventBurst: 10
eventRecordQPS: 5
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: true
fileCheckFrequency: 20s
hairpinMode: promiscuous-bridge
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 20s
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
imageMinimumGCAge: 2m0s
iptablesDropBit: 15
iptablesMasqueradeBit: 14
kubeAPIBurst: 10
kubeAPIQPS: 5
makeIPTablesUtilChains: true
maxOpenFiles: 1000000
maxPods: 110
nodeStatusUpdateFrequency: 10s
oomScoreAdj: -999
podPidsLimit: -1
registryBurst: 10
registryPullQPS: 5
resolvConf: /etc/resolv.conf
rotateCertificates: true
runtimeRequestTimeout: 2m0s
serializeImagePulls: true
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
volumeStatsAggPeriod: 1m0s
EOF</span>

<span class="token comment"># 这是一个Kubelet的配置文件，用于配置Kubelet的各项参数。</span>
<span class="token comment"># </span>
<span class="token comment"># - apiVersion: kubelet.config.k8s.io/v1beta1：指定了配置文件的API版本为kubelet.config.k8s.io/v1beta1。</span>
<span class="token comment"># - kind: KubeletConfiguration：指定了配置类别为KubeletConfiguration。</span>
<span class="token comment"># - address: 0.0.0.0：指定了Kubelet监听的地址为0.0.0.0。</span>
<span class="token comment"># - port: 10250：指定了Kubelet监听的端口为10250。</span>
<span class="token comment"># - readOnlyPort: 10255：指定了只读端口为10255，用于提供只读的状态信息。</span>
<span class="token comment"># - authentication：指定了认证相关的配置信息。</span>
<span class="token comment">#   - anonymous.enabled: false：禁用了匿名认证。</span>
<span class="token comment">#   - webhook.enabled: true：启用了Webhook认证。</span>
<span class="token comment">#   - x509.clientCAFile: /etc/kubernetes/pki/ca.pem：指定了X509证书的客户端CA文件路径。</span>
<span class="token comment"># - authorization：指定了授权相关的配置信息。</span>
<span class="token comment">#   - mode: Webhook：指定了授权模式为Webhook。</span>
<span class="token comment">#   - webhook.cacheAuthorizedTTL: 5m0s：指定了授权缓存时间段为5分钟。</span>
<span class="token comment">#   - webhook.cacheUnauthorizedTTL: 30s：指定了未授权缓存时间段为30秒。</span>
<span class="token comment"># - cgroupDriver: systemd：指定了Cgroup驱动为systemd。</span>
<span class="token comment"># - cgroupsPerQOS: true：启用了每个QoS类别一个Cgroup的设置。</span>
<span class="token comment"># - clusterDNS: 指定了集群的DNS服务器地址列表。</span>
<span class="token comment">#   - 10.96.0.10：指定了DNS服务器地址为10.96.0.10。</span>
<span class="token comment"># - clusterDomain: cluster.local：指定了集群的域名后缀为cluster.local。</span>
<span class="token comment"># - containerLogMaxFiles: 5：指定了容器日志文件保留的最大数量为5个。</span>
<span class="token comment"># - containerLogMaxSize: 10Mi：指定了容器日志文件的最大大小为10Mi。</span>
<span class="token comment"># - contentType: application/vnd.kubernetes.protobuf：指定了内容类型为protobuf。</span>
<span class="token comment"># - cpuCFSQuota: true：启用了CPU CFS Quota。</span>
<span class="token comment"># - cpuManagerPolicy: none：禁用了CPU Manager。</span>
<span class="token comment"># - cpuManagerReconcilePeriod: 10s：指定了CPU管理器的调整周期为10秒。</span>
<span class="token comment"># - enableControllerAttachDetach: true：启用了控制器的挂载和拆卸。</span>
<span class="token comment"># - enableDebuggingHandlers: true：启用了调试处理程序。</span>
<span class="token comment"># - enforceNodeAllocatable: 指定了强制节点可分配资源的列表。</span>
<span class="token comment">#   - pods：强制节点可分配pods资源。</span>
<span class="token comment"># - eventBurst: 10：指定了事件突发的最大数量为10。</span>
<span class="token comment"># - eventRecordQPS: 5：指定了事件记录的最大请求量为5。</span>
<span class="token comment"># - evictionHard: 指定了驱逐硬性限制参数的配置信息。</span>
<span class="token comment">#   - imagefs.available: 15%：指定了镜像文件系统可用空间的限制为15%。</span>
<span class="token comment">#   - memory.available: 100Mi：指定了可用内存的限制为100Mi。</span>
<span class="token comment">#   - nodefs.available: 10%：指定了节点文件系统可用空间的限制为10%。</span>
<span class="token comment">#   - nodefs.inodesFree: 5%：指定了节点文件系统可用inode的限制为5%。</span>
<span class="token comment"># - evictionPressureTransitionPeriod: 5m0s：指定了驱逐压力转换的时间段为5分钟。</span>
<span class="token comment"># - failSwapOn: true：指定了在发生OOM时禁用交换分区。</span>
<span class="token comment"># - fileCheckFrequency: 20s：指定了文件检查频率为20秒。</span>
<span class="token comment"># - hairpinMode: promiscuous-bridge：设置了Hairpin Mode为"promiscuous-bridge"。</span>
<span class="token comment"># - healthzBindAddress: 127.0.0.1：指定了健康检查的绑定地址为127.0.0.1。</span>
<span class="token comment"># - healthzPort: 10248：指定了健康检查的端口为10248。</span>
<span class="token comment"># - httpCheckFrequency: 20s：指定了HTTP检查的频率为20秒。</span>
<span class="token comment"># - imageGCHighThresholdPercent: 85：指定了镜像垃圾回收的上阈值为85%。</span>
<span class="token comment"># - imageGCLowThresholdPercent: 80：指定了镜像垃圾回收的下阈值为80%。</span>
<span class="token comment"># - imageMinimumGCAge: 2m0s：指定了镜像垃圾回收的最小时间为2分钟。</span>
<span class="token comment"># - iptablesDropBit: 15：指定了iptables的Drop Bit为15。</span>
<span class="token comment"># - iptablesMasqueradeBit: 14：指定了iptables的Masquerade Bit为14。</span>
<span class="token comment"># - kubeAPIBurst: 10：指定了KubeAPI的突发请求数量为10个。</span>
<span class="token comment"># - kubeAPIQPS: 5：指定了KubeAPI的每秒请求频率为5个。</span>
<span class="token comment"># - makeIPTablesUtilChains: true：指定了是否使用iptables工具链。</span>
<span class="token comment"># - maxOpenFiles: 1000000：指定了最大打开文件数为1000000。</span>
<span class="token comment"># - maxPods: 110：指定了最大的Pod数量为110。</span>
<span class="token comment"># - nodeStatusUpdateFrequency: 10s：指定了节点状态更新的频率为10秒。</span>
<span class="token comment"># - oomScoreAdj: -999：指定了OOM Score Adjustment为-999。</span>
<span class="token comment"># - podPidsLimit: -1：指定了Pod的PID限制为-1，表示无限制。</span>
<span class="token comment"># - registryBurst: 10：指定了Registry的突发请求数量为10个。</span>
<span class="token comment"># - registryPullQPS: 5：指定了Registry的每秒拉取请求数量为5个。</span>
<span class="token comment"># - resolvConf: /etc/resolv.conf：指定了resolv.conf的文件路径。</span>
<span class="token comment"># - rotateCertificates: true：指定了是否轮转证书。</span>
<span class="token comment"># - runtimeRequestTimeout: 2m0s：指定了运行时请求的超时时间为2分钟。</span>
<span class="token comment"># - serializeImagePulls: true：指定了是否序列化镜像拉取。</span>
<span class="token comment"># - staticPodPath: /etc/kubernetes/manifests：指定了静态Pod的路径。</span>
<span class="token comment"># - streamingConnectionIdleTimeout: 4h0m0s：指定了流式连接的空闲超时时间为4小时。</span>
<span class="token comment"># - syncFrequency: 1m0s：指定了同步频率为1分钟。</span>
<span class="token comment"># - volumeStatsAggPeriod: 1m0s：指定了卷统计聚合周期为1分钟。</span>
</code></pre> 
<h4><a id="824_kubelet_4324"></a>8.2.4 启动kubelet</h4> 
<blockquote> 
 <p>所有节点(master+node)执行</p> 
</blockquote> 
<pre><code class="prism language-shell">systemctl daemon-reload
<span class="token comment"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span>

systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kubelet.service
<span class="token comment"># 启用并立即启动kubelet.service单元。kubelet.service是kubelet守护进程的systemd服务单元。</span>

systemctl restart kubelet.service
<span class="token comment"># 重启kubelet.service单元，即重新启动kubelet守护进程。</span>

systemctl status kubelet.service
<span class="token comment"># kubelet.service单元的当前状态，包括运行状态、是否启用等信息。</span>
</code></pre> 
<h4><a id="825__4342"></a>8.2.5 查看集群</h4> 
<blockquote> 
 <p>master01节点执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  get node</span>
NAME           STATUS     ROLES    AGE   VERSION
k8s-master01   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   18s   v1.28.0
k8s-master02   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   16s   v1.28.0
k8s-master03   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   16s   v1.28.0
k8s-node01     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   14s   v1.28.0
k8s-node02     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   14s   v1.28.0
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<h4><a id="826__4357"></a>8.2.6 查看容器运行时</h4> 
<blockquote> 
 <p>所有节(master+node)点执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe node | grep Runtime</span>
  Container Runtime Version:  containerd://1.7.3
  Container Runtime Version:  containerd://1.7.3
  Container Runtime Version:  containerd://1.7.3
  Container Runtime Version:  containerd://1.7.3
  Container Runtime Version:  containerd://1.7.3

<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe node | grep Runtime</span>
  Container Runtime Version:  docker://24.0.5
  Container Runtime Version:  docker://24.0.5
  Container Runtime Version:  docker://24.0.5
  Container Runtime Version:  docker://24.0.5
  Container Runtime Version:  docker://24.0.5

</code></pre> 
<h3><a id="83kubeproxy_4379"></a>8.3.kube-proxy配置</h3> 
<h4><a id="831_kubeconfig_4381"></a>8.3.1 将kubeconfig发送至其他节点</h4> 
<blockquote> 
 <p>master01节点执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># master-1执行</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">scp</span> /etc/kubernetes/kube-proxy.kubeconfig <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> 
<h4><a id="832_k8skubeproxyservice_4390"></a>8.3.2 所有k8s节点添加kube-proxy的service文件</h4> 
<blockquote> 
 <p>所有节点(master+node)执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span>  /usr/lib/systemd/system/kube-proxy.service <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-proxy <span class="token entity" title="\\">\\</span>
  --config=/etc/kubernetes/kube-proxy.yaml <span class="token entity" title="\\">\\</span>
  --v=2
Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target

EOF</span>

<span class="token comment"># 这是一个 systemd 服务单元文件的示例，用于配置 Kubernetes Kube Proxy 服务。下面是对其中一些字段的详细解释：</span>
<span class="token comment"># </span>
<span class="token comment"># [Unit]</span>
<span class="token comment"># </span>
<span class="token comment"># Description: 描述了该服务单元的用途，这里是 Kubernetes Kube Proxy。</span>
<span class="token comment"># Documentation: 指定了该服务单元的文档地址，即 https://github.com/kubernetes/kubernetes。</span>
<span class="token comment"># After: 指定该服务单元应在 network.target（网络目标）之后启动。</span>
<span class="token comment"># [Service]</span>
<span class="token comment"># </span>
<span class="token comment"># ExecStart: 指定了启动 Kube Proxy 服务的命令。通过 /usr/local/bin/kube-proxy 命令启动，并指定了配置文件的路径为 /etc/kubernetes/kube-proxy.yaml，同时指定了日志级别为 2。</span>
<span class="token comment"># Restart: 配置了服务在失败或退出后自动重启。</span>
<span class="token comment"># RestartSec: 配置了重启间隔，这里是每次重启之间的等待时间为 10 秒。</span>
<span class="token comment"># [Install]</span>
<span class="token comment"># </span>
<span class="token comment"># WantedBy: 指定了该服务单元的安装目标为 multi-user.target（多用户目标），表示该服务将在多用户模式下启动。</span>
<span class="token comment"># 通过配置这些字段，你可以启动和管理 Kubernetes Kube Proxy 服务。请注意，你需要根据实际情况修改 ExecStart 中的路径和文件名，确保与你的环境一致。另外，可以根据需求修改其他字段的值，以满足你的特定要求。</span>
</code></pre> 
<h4><a id="833_k8skubeproxy_4431"></a>8.3.3 所有k8s节点添加kube-proxy的配置</h4> 
<blockquote> 
 <p>所有节点(master+node)执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/kubernetes/kube-proxy.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
clientConnection:
  acceptContentTypes: ""
  burst: 10
  contentType: application/vnd.kubernetes.protobuf
  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
  qps: 5
clusterCIDR: 172.16.0.0/12,fc00:2222::/112
configSyncPeriod: 15m0s
conntrack:
  max: null
  maxPerCore: 32768
  min: 131072
  tcpCloseWaitTimeout: 1h0m0s
  tcpEstablishedTimeout: 24h0m0s
enableProfiling: false
healthzBindAddress: 0.0.0.0:10256
hostnameOverride: ""
iptables:
  masqueradeAll: false
  masqueradeBit: 14
  minSyncPeriod: 0s
  syncPeriod: 30s
ipvs:
  masqueradeAll: true
  minSyncPeriod: 5s
  scheduler: "rr"
  syncPeriod: 30s
kind: KubeProxyConfiguration
metricsBindAddress: 127.0.0.1:10249
mode: "ipvs"
nodePortAddresses: null
oomScoreAdj: -999
portRange: ""
udpIdleTimeout: 250ms
EOF</span>

<span class="token comment"># 这是一个Kubernetes的kube-proxy组件配置文件示例。以下是每个配置项的详细解释：</span>
<span class="token comment"># </span>
<span class="token comment"># 1. apiVersion: kubeproxy.config.k8s.io/v1alpha1</span>
<span class="token comment">#    - 指定该配置文件的API版本。</span>
<span class="token comment"># </span>
<span class="token comment"># 2. bindAddress: 0.0.0.0</span>
<span class="token comment">#    - 指定kube-proxy使用的监听地址。0.0.0.0表示监听所有网络接口。</span>
<span class="token comment"># </span>
<span class="token comment"># 3. clientConnection:</span>
<span class="token comment">#    - 客户端连接配置项。</span>
<span class="token comment"># </span>
<span class="token comment">#    a. acceptContentTypes: ""</span>
<span class="token comment">#       - 指定接受的内容类型。</span>
<span class="token comment"># </span>
<span class="token comment">#    b. burst: 10</span>
<span class="token comment">#       - 客户端请求超出qps设置时的最大突发请求数。</span>
<span class="token comment"># </span>
<span class="token comment">#    c. contentType: application/vnd.kubernetes.protobuf</span>
<span class="token comment">#       - 指定客户端请求的内容类型。</span>
<span class="token comment"># </span>
<span class="token comment">#    d. kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span>
<span class="token comment">#       - kube-proxy使用的kubeconfig文件路径。</span>
<span class="token comment"># </span>
<span class="token comment">#    e. qps: 5</span>
<span class="token comment">#       - 每秒向API服务器发送的请求数量。</span>
<span class="token comment"># </span>
<span class="token comment"># 4. clusterCIDR: 172.16.0.0/12,fc00:2222::/112</span>
<span class="token comment">#    - 指定集群使用的CIDR范围，用于自动分配Pod IP。</span>
<span class="token comment"># </span>
<span class="token comment"># 5. configSyncPeriod: 15m0s</span>
<span class="token comment">#    - 指定kube-proxy配置同步到节点的频率。</span>
<span class="token comment"># </span>
<span class="token comment"># 6. conntrack:</span>
<span class="token comment">#    - 连接跟踪设置。</span>
<span class="token comment"># </span>
<span class="token comment">#    a. max: null</span>
<span class="token comment">#       - 指定连接跟踪的最大值。</span>
<span class="token comment"># </span>
<span class="token comment">#    b. maxPerCore: 32768</span>
<span class="token comment">#       - 指定每个核心的最大连接跟踪数。</span>
<span class="token comment"># </span>
<span class="token comment">#    c. min: 131072</span>
<span class="token comment">#       - 指定最小的连接跟踪数。</span>
<span class="token comment"># </span>
<span class="token comment">#    d. tcpCloseWaitTimeout: 1h0m0s</span>
<span class="token comment">#       - 指定处于CLOSE_WAIT状态的TCP连接的超时时间。</span>
<span class="token comment"># </span>
<span class="token comment">#    e. tcpEstablishedTimeout: 24h0m0s</span>
<span class="token comment">#       - 指定已建立的TCP连接的超时时间。</span>
<span class="token comment"># </span>
<span class="token comment"># 7. enableProfiling: false</span>
<span class="token comment">#    - 是否启用性能分析。</span>
<span class="token comment"># </span>
<span class="token comment"># 8. healthzBindAddress: 0.0.0.0:10256</span>
<span class="token comment">#    - 指定健康检查监听地址和端口。</span>
<span class="token comment"># </span>
<span class="token comment"># 9. hostnameOverride: ""</span>
<span class="token comment">#    - 指定覆盖默认主机名的值。</span>
<span class="token comment"># </span>
<span class="token comment"># 10. iptables:</span>
<span class="token comment">#     - iptables设置。</span>
<span class="token comment"># </span>
<span class="token comment">#     a. masqueradeAll: false</span>
<span class="token comment">#        - 是否对所有流量使用IP伪装。</span>
<span class="token comment"># </span>
<span class="token comment">#     b. masqueradeBit: 14</span>
<span class="token comment">#        - 指定伪装的Bit标记。</span>
<span class="token comment"># </span>
<span class="token comment">#     c. minSyncPeriod: 0s</span>
<span class="token comment">#        - 指定同步iptables规则的最小间隔。</span>
<span class="token comment"># </span>
<span class="token comment">#     d. syncPeriod: 30s</span>
<span class="token comment">#        - 指定同步iptables规则的时间间隔。</span>
<span class="token comment"># </span>
<span class="token comment"># 11. ipvs:</span>
<span class="token comment">#     - ipvs设置。</span>
<span class="token comment"># </span>
<span class="token comment">#     a. masqueradeAll: true</span>
<span class="token comment">#        - 是否对所有流量使用IP伪装。</span>
<span class="token comment"># </span>
<span class="token comment">#     b. minSyncPeriod: 5s</span>
<span class="token comment">#        - 指定同步ipvs规则的最小间隔。</span>
<span class="token comment"># </span>
<span class="token comment">#     c. scheduler: "rr"</span>
<span class="token comment">#        - 指定ipvs默认使用的调度算法。</span>
<span class="token comment"># </span>
<span class="token comment">#     d. syncPeriod: 30s</span>
<span class="token comment">#        - 指定同步ipvs规则的时间间隔。</span>
<span class="token comment"># </span>
<span class="token comment"># 12. kind: KubeProxyConfiguration</span>
<span class="token comment">#     - 指定该配置文件的类型。</span>
<span class="token comment"># </span>
<span class="token comment"># 13. metricsBindAddress: 127.0.0.1:10249</span>
<span class="token comment">#     - 指定指标绑定的地址和端口。</span>
<span class="token comment"># </span>
<span class="token comment"># 14. mode: "ipvs"</span>
<span class="token comment">#     - 指定kube-proxy的模式。这里指定为ipvs，使用IPVS代理模式。</span>
<span class="token comment"># </span>
<span class="token comment"># 15. nodePortAddresses: null</span>
<span class="token comment">#     - 指定可用于NodePort的网络地址。</span>
<span class="token comment"># </span>
<span class="token comment"># 16. oomScoreAdj: -999</span>
<span class="token comment">#     - 指定kube-proxy的OOM优先级。</span>
<span class="token comment"># </span>
<span class="token comment"># 17. portRange: ""</span>
<span class="token comment">#     - 指定可用于服务端口范围。</span>
<span class="token comment"># </span>
<span class="token comment"># 18. udpIdleTimeout: 250ms</span>
<span class="token comment">#     - 指定UDP连接的空闲超时时间。</span>
</code></pre> 
<h4><a id="834_kubeproxy_4586"></a>8.3.4 启动kube-proxy</h4> 
<blockquote> 
 <p>所有节点(master+node)执行</p> 
</blockquote> 
<pre><code class="prism language-shell">systemctl daemon-reload
<span class="token comment"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span>

systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-proxy.service
<span class="token comment"># 启用并立即启动kube-proxy.service单元。kube-proxy.service是kube-proxy守护进程的systemd服务单元。</span>

systemctl restart kube-proxy.service
<span class="token comment"># 重启kube-proxy.service单元，即重新启动kube-proxy守护进程。</span>

systemctl status kube-proxy.service
<span class="token comment"># kube-proxy.service单元的当前状态，包括运行状态、是否启用等信息。</span>
</code></pre> 
<h2><a id="9_4604"></a>9.安装网络插件</h2> 
<p><strong>注意 9.1 和 9.2 二选其一即可，建议在此处创建好快照后在进行操作，后续出问题可以回滚</strong></p> 
<p><strong>centos7 要升级libseccomp 不然 无法安装网络插件，否则报错： failed to create shim task: OCI runtime create failed</strong></p> 
<blockquote> 
 <p>所有节点(master+node)执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># https://github.com/opencontainers/runc/releases</span>
<span class="token comment"># 升级runc</span>
<span class="token comment"># wget https://ghproxy.com/https://github.com/opencontainers/runc/releases/download/v1.1.9/runc.amd64</span>

<span class="token function">install</span> <span class="token parameter variable">-m</span> <span class="token number">755</span> runc.amd64 /usr/local/sbin/runc
<span class="token function">cp</span> <span class="token parameter variable">-p</span> /usr/local/sbin/runc  /usr/local/bin/runc
<span class="token function">cp</span> <span class="token parameter variable">-p</span> /usr/local/sbin/runc  /usr/bin/runc

<span class="token comment">#下载高于2.4以上的包</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> http://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm
<span class="token comment"># 清华源</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> https://mirrors.tuna.tsinghua.edu.cn/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm

<span class="token comment">#查看当前版本</span>
<span class="token punctuation">[</span>root@k8s-master-1 ~<span class="token punctuation">]</span><span class="token comment"># rpm -qa | grep libseccomp</span>
libseccomp-2.5.1-1.el8.x86_64
</code></pre> 
<h3><a id="90docker_4631"></a>9.0安装docker</h3> 
<blockquote> 
 <p>所有节点(master+node)都需要有docker环境</p> 
</blockquote> 
<p>参考：https://blog.csdn.net/lzb348110175/article/details/132847035</p> 
<h3><a id="91Calico_4637"></a>9.1安装Calico（推荐）</h3> 
<blockquote> 
 <p>如虚拟机，配置不能太低，起码2G内存。否则会有意外的问题</p> 
 <p>下面两种方法均可，推荐使用方法一</p> 
</blockquote> 
<h4><a id="tigeraoperatoryaml__4643"></a>方法一：使用tigera-operator.yaml 方式安装(推荐)</h4> 
<p>参考官网安装即可：<a href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart" rel="nofollow">https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart</a></p> 
<h5><a id="1tigeraoperatoryaml_4647"></a>1.安装tigera-operator.yaml</h5> 
<pre><code class="prism language-shell">kubectl create <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/projectcalico/calico/v3.26.3/manifests/tigera-operator.yaml
</code></pre> 
<h5><a id="2customeresourcesyaml_4653"></a>2.下载custome-resources.yaml文件</h5> 
<pre><code class="prism language-shell"><span class="token function">wget</span> https://raw.githubusercontent.com/projectcalico/calico/v3.26.3/manifests/custom-resources.yaml
</code></pre> 
<h5><a id="3calico_4659"></a>3.修改calico网段</h5> 
<pre><code class="prism language-shell"><span class="token function">vim</span> custom-resources.yaml

修改 cidr: <span class="token number">172.16</span>.0.0/12
</code></pre> 
<h5><a id="4calico_4667"></a>4.安装calico</h5> 
<pre><code class="prism language-shell">kubectl create <span class="token parameter variable">-f</span> custom-resources.yaml
</code></pre> 
<h5><a id="5calicopod_4673"></a>5.监听calico的所有pod是否安装完成</h5> 
<blockquote> 
 <p>直到所有的pod都处于Running状态。此处会一直卡在 镜像来回下载失败的问题上。多等一等就好了，我等了18分钟才全部运行好。</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">watch</span> kubectl get pods <span class="token parameter variable">-n</span> calico-system


<span class="token comment"># Every 2.0s: kubectl get pods -n calico-system                                                                                                                                                                                                      Wed Oct 18 # 11:51:21 2023</span>

<span class="token comment"># NAME                                       READY   STATUS    RESTARTS   AGE</span>
<span class="token comment"># calico-kube-controllers-598c557f8b-8m7wc   1/1     Running   0          18m</span>
<span class="token comment"># calico-node-4pxr8                          1/1     Running   0          18m</span>
<span class="token comment"># calico-node-bm55x                          1/1     Running   0          18m</span>
<span class="token comment"># calico-node-ftv7g                          1/1     Running   0          18m</span>
<span class="token comment"># calico-typha-668f7fd76f-77jgb              1/1     Running   0          18m</span>
<span class="token comment"># calico-typha-668f7fd76f-hhptj              1/1     Running   0          18m</span>
<span class="token comment"># csi-node-driver-pz2qc                      2/2     Running   0          18m</span>
<span class="token comment"># csi-node-driver-vwrz6                      2/2     Running   0          18m</span>
<span class="token comment"># csi-node-driver-zmj9m                      2/2     Running   0          18m</span>
</code></pre> 
<h4><a id="calicoyaml_4697"></a>方法二：使用calico.yaml方式安装</h4> 
<h5><a id="1calico_4699"></a>1.更改calico网段</h5> 
<blockquote> 
 <p>master01节点执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">wget</span> https://mirrors.chenby.cn/https://github.com/projectcalico/calico/blob/master/manifests/calico-typha.yaml

<span class="token function">cp</span> calico-typha.yaml calico.yaml
<span class="token function">cp</span> calico-typha.yaml calico-ipv6.yaml

<span class="token function">vim</span> calico.yaml
<span class="token comment"># 打开注释CALICO_IPV4POOL_CIDR</span>
    - name: CALICO_IPV4POOL_CIDR
      value: <span class="token string">"172.16.0.0/12"</span>

<span class="token comment"># vim calico-ipv6.yaml</span>
<span class="token comment"># calico-config ConfigMap处</span>
    <span class="token string">"ipam"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"calico-ipam"</span>,
        <span class="token string">"assign_ipv4"</span><span class="token builtin class-name">:</span> <span class="token string">"true"</span>,
        <span class="token string">"assign_ipv6"</span><span class="token builtin class-name">:</span> <span class="token string">"true"</span>
    <span class="token punctuation">}</span>,
    - name: IP
      value: <span class="token string">"autodetect"</span>

    - name: IP6
      value: <span class="token string">"autodetect"</span>

    - name: CALICO_IPV4POOL_CIDR
      value: <span class="token string">"172.16.0.0/12"</span>

    - name: CALICO_IPV6POOL_CIDR
      value: <span class="token string">"fc00:2222::/112"</span>

    - name: FELIX_IPV6SUPPORT
      value: <span class="token string">"true"</span>


<span class="token comment"># 若docker镜像拉不下来，可以使用国内的仓库</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#docker.io/calico/#m.daocloud.io/docker.io/calico/#g"</span> calico.yaml 
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#docker.io/calico/#m.daocloud.io/docker.io/calico/#g"</span> calico-ipv6.yaml


<span class="token comment"># 本地没有公网 IPv6 使用 calico.yaml</span>
kubectl apply <span class="token parameter variable">-f</span> calico.yaml

<span class="token comment"># 本地有公网 IPv6 使用 calico-ipv6.yaml </span>
<span class="token comment"># kubectl apply -f calico-ipv6.yaml </span>

</code></pre> 
<h5><a id="2_4750"></a>2.查看容器状态</h5> 
<blockquote> 
 <p>master01节点执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># calico 初始化会很慢 需要耐心等待一下，大约十分钟左右</span>
<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -A</span>
NAMESPACE     NAME                                       READY   STATUS    RESTARTS      AGE
kube-system   calico-kube-controllers-765c96cb9d-2r26x   <span class="token number">1</span>/1     Running   <span class="token number">0</span>             8m13s
kube-system   calico-node-jgzv7                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             21m
kube-system   calico-node-jwbzx                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             21m
kube-system   calico-node-pqgjh                          <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>19m ago<span class="token punctuation">)</span>   21m
kube-system   calico-node-tbn7t                          <span class="token number">1</span>/1     Running   <span class="token number">2</span> <span class="token punctuation">(</span>19m ago<span class="token punctuation">)</span>   21m
kube-system   calico-node-xmmzt                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             21m
kube-system   calico-typha-67c57cdf49-swvhz              <span class="token number">1</span>/1     Running   <span class="token number">0</span>             21m

<span class="token comment"># 如果看到STATUS状态不为Running,可以通过 kubectl describe pod [Pod名称] -n [namespace] 查看日志，如果是Terminated状态，可以通过kubectl delete pod [Pod名称] -n [namespace] --force 强制删除</span>
</code></pre> 
<h3><a id="92_cilium_4769"></a>9.2 安装cilium（不推荐）</h3> 
<h4><a id="921_helm_4771"></a>9.2.1 安装helm</h4> 
<pre><code class="prism language-shell"><span class="token comment"># [root@k8s-master01 ~]# curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3</span>
<span class="token comment"># [root@k8s-master01 ~]# chmod 700 get_helm.sh</span>
<span class="token comment"># [root@k8s-master01 ~]# ./get_helm.sh</span>

<span class="token function">wget</span> https://mirrors.huaweicloud.com/helm/v3.12.3/helm-v3.12.3-linux-amd64.tar.gz
<span class="token function">tar</span> xvf helm-*-linux-amd64.tar.gz
<span class="token function">cp</span> linux-amd64/helm /usr/local/bin/
</code></pre> 
<h4><a id="922_cilium_4783"></a>9.2.2 安装cilium</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 添加源</span>
helm repo <span class="token function">add</span> cilium https://helm.cilium.io

<span class="token comment"># 修改为国内源</span>
helm pull cilium/cilium
<span class="token function">tar</span> xvf cilium-*.tgz
<span class="token builtin class-name">cd</span> cilium/
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#quay.io/#m.daocloud.io/quay.io/#g"</span> values.yaml

<span class="token comment"># 默认参数安装</span>
helm <span class="token function">install</span>  cilium ./cilium/ <span class="token parameter variable">-n</span> kube-system

<span class="token comment"># 启用ipv6</span>
<span class="token comment"># helm install cilium cilium/cilium --namespace kube-system --set ipv6.enabled=true</span>

<span class="token comment"># 启用路由信息和监控插件</span>
<span class="token comment"># helm install cilium cilium/cilium --namespace kube-system --set hubble.relay.enabled=true --set hubble.ui.enabled=true --set prometheus.enabled=true --set operator.prometheus.enabled=true --set hubble.enabled=true --set hubble.metrics.enabled="{dns,drop,tcp,flow,port-distribution,icmp,http}" </span>

</code></pre> 
<h4><a id="923__4806"></a>9.2.3 查看</h4> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  get pod -A | grep cil</span>
kube-system   cilium-gmr6c                       <span class="token number">1</span>/1     Running       <span class="token number">0</span>             5m3s
kube-system   cilium-kzgdj                       <span class="token number">1</span>/1     Running       <span class="token number">0</span>             5m3s
kube-system   cilium-operator-69b677f97c-6pw4k   <span class="token number">1</span>/1     Running       <span class="token number">0</span>             5m3s
kube-system   cilium-operator-69b677f97c-xzzdk   <span class="token number">1</span>/1     Running       <span class="token number">0</span>             5m3s
kube-system   cilium-q2rnr                       <span class="token number">1</span>/1     Running       <span class="token number">0</span>             5m3s
kube-system   cilium-smx5v                       <span class="token number">1</span>/1     Running       <span class="token number">0</span>             5m3s
kube-system   cilium-tdjq4                       <span class="token number">1</span>/1     Running       <span class="token number">0</span>             5m3s
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<h4><a id="924__4820"></a>9.2.4 下载专属监控面板</h4> 
<p>安装时候没有创建 监控可以忽略</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment"># wget https://mirrors.chenby.cn/https://raw.githubusercontent.com/cilium/cilium/1.12.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml</span>

<span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment"># sed -i "s#docker.io/#m.daocloud.io/docker.io/#g" monitoring-example.yaml</span>

<span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment"># kubectl  apply -f monitoring-example.yaml</span>
namespace/cilium-monitoring created
serviceaccount/prometheus-k8s created
configmap/grafana-config created
configmap/grafana-cilium-dashboard created
configmap/grafana-cilium-operator-dashboard created
configmap/grafana-hubble-dashboard created
configmap/prometheus created
clusterrole.rbac.authorization.k8s.io/prometheus created
clusterrolebinding.rbac.authorization.k8s.io/prometheus created
service/grafana created
service/prometheus created
deployment.apps/grafana created
deployment.apps/prometheus created
<span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<h4><a id="925__4846"></a>9.2.5 下载部署测试用例</h4> 
<p>说明 测试用例 需要在 安装CoreDNS 之后即可完成</p> 
<pre><code class="prism language-shell"><span class="token function">wget</span> https://mirrors.chenby.cn/https://raw.githubusercontent.com/cilium/cilium/master/examples/kubernetes/connectivity-check/connectivity-check.yaml

<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#google.com#baidu.cn#g"</span> connectivity-check.yaml
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#quay.io/#m.daocloud.io/quay.io/#g"</span> connectivity-check.yaml

kubectl  apply <span class="token parameter variable">-f</span> connectivity-check.yaml
</code></pre> 
<h4><a id="926_pod_4859"></a>9.2.6 查看pod</h4> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment"># kubectl  get pod -A</span>
NAMESPACE           NAME                                                     READY   STATUS    RESTARTS      AGE
cilium-monitoring   grafana-59957b9549-6zzqh                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
cilium-monitoring   prometheus-7c8c9684bb-4v9cl                              <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             chenby-75b5d7fbfb-7zjsr                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>             27h
default             chenby-75b5d7fbfb-hbvr8                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>             27h
default             chenby-75b5d7fbfb-ppbzg                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>             27h
default             echo-a-6799dff547-pnx6w                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             echo-b-fc47b659c-4bdg9                                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             echo-b-host-67fcfd59b7-28r9s                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             host-to-b-multi-node-clusterip-69c57975d6-z4j2z          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             host-to-b-multi-node-headless-865899f7bb-frrmc           <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             pod-to-a-allowed-cnp-5f9d7d4b9d-hcd8x                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             pod-to-a-denied-cnp-65cc5ff97b-2rzb8                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             pod-to-a-dfc64f564-p7xcn                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             pod-to-b-intra-node-nodeport-677868746b-trk2l            <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             pod-to-b-multi-node-clusterip-76bbbc677b-knfq2           <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             pod-to-b-multi-node-headless-698c6579fd-mmvd7            <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             pod-to-b-multi-node-nodeport-5dc4b8cfd6-8dxmz            <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             pod-to-external-1111-8459965778-pjt9b                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
default             pod-to-external-fqdn-allow-google-cnp-64df9fb89b-l9l4q   <span class="token number">1</span>/1     Running   <span class="token number">0</span>             10m
kube-system         cilium-7rfj6                                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>             56s
kube-system         cilium-d4cch                                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>             56s
kube-system         cilium-h5x8r                                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>             56s
kube-system         cilium-operator-5dbddb6dbf-flpl5                         <span class="token number">1</span>/1     Running   <span class="token number">0</span>             56s
kube-system         cilium-operator-5dbddb6dbf-gcznc                         <span class="token number">1</span>/1     Running   <span class="token number">0</span>             56s
kube-system         cilium-t2xlz                                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>             56s
kube-system         cilium-z65z7                                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>             56s
kube-system         coredns-665475b9f8-jkqn8                                 <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>36h ago<span class="token punctuation">)</span>   36h
kube-system         hubble-relay-59d8575-9pl9z                               <span class="token number">1</span>/1     Running   <span class="token number">0</span>             56s
kube-system         hubble-ui-64d4995d57-nsv9j                               <span class="token number">2</span>/2     Running   <span class="token number">0</span>             56s
kube-system         metrics-server-776f58c94b-c6zgs                          <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>36h ago<span class="token punctuation">)</span>   37h
<span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<h4><a id="927_NodePort_4897"></a>9.2.7 修改为NodePort</h4> 
<p>安装时候没有创建 监控可以忽略</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment"># kubectl  edit svc  -n kube-system hubble-ui</span>
service/hubble-ui edited
<span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment"># kubectl  edit svc  -n cilium-monitoring grafana</span>
service/grafana edited
<span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment"># kubectl  edit svc  -n cilium-monitoring prometheus</span>
service/prometheus edited
<span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment">#</span>

type: NodePort
</code></pre> 
<h4><a id="928__4915"></a>9.2.8 查看端口</h4> 
<p>安装时候没有创建 监控可以忽略</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -A | grep monit</span>
cilium-monitoring   grafana                NodePort    <span class="token number">10.100</span>.250.17    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">3000</span>:30707/TCP           15m
cilium-monitoring   prometheus             NodePort    <span class="token number">10.100</span>.131.243   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9090</span>:31155/TCP           15m
<span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment">#</span>
<span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -A | grep hubble</span>
kube-system         hubble-metrics         ClusterIP   None             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9965</span>/TCP                 5m12s
kube-system         hubble-peer            ClusterIP   <span class="token number">10.100</span>.150.29    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP                  5m12s
kube-system         hubble-relay           ClusterIP   <span class="token number">10.109</span>.251.34    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP                   5m12s
kube-system         hubble-ui              NodePort    <span class="token number">10.102</span>.253.59    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:31219/TCP             5m12s
<span class="token punctuation">[</span>root@k8s-master01 yaml<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> 
<h4><a id="929__4932"></a>9.2.9 访问</h4> 
<p>安装时候没有创建 监控可以忽略</p> 
<pre><code class="prism language-shell">http://192.168.0.31:30707
http://192.168.0.31:31155
http://192.168.0.31:31219
</code></pre> 
<h2><a id="10CoreDNS_4942"></a>10.安装CoreDNS</h2> 
<h3><a id="101master01_4944"></a>10.1以下步骤只在master01操作</h3> 
<h4><a id="1011__4946"></a>10.1.1 修改文件</h4> 
<blockquote> 
 <p>corDNS需要使用helm 安装，如没有安装helm，请参考：9.2.1 安装helm</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 下载tgz包</span>
helm repo <span class="token function">add</span> coredns https://coredns.github.io/helm
helm pull coredns/coredns
<span class="token function">tar</span> xvf coredns-*.tgz
<span class="token builtin class-name">cd</span> coredns/

<span class="token comment"># 修改IP地址</span>
<span class="token function">vim</span> values.yaml
<span class="token function">cat</span> values.yaml <span class="token operator">|</span> <span class="token function">grep</span> clusterIP:
clusterIP: <span class="token string">"10.96.0.10"</span>

<span class="token comment"># 示例</span>
---
service:
<span class="token comment"># clusterIP: ""</span>
<span class="token comment"># clusterIPs: []</span>
<span class="token comment"># loadBalancerIP: ""</span>
<span class="token comment"># externalIPs: []</span>
<span class="token comment"># externalTrafficPolicy: ""</span>
<span class="token comment"># ipFamilyPolicy: ""</span>
  <span class="token comment"># The name of the Service</span>
  <span class="token comment"># If not set, a name is generated using the fullname template</span>
  clusterIP: <span class="token string">"10.96.0.10"</span>
  name: <span class="token string">""</span>
  annotations: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
---

<span class="token comment"># 修改为国内源 docker源可选</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#coredns/#m.daocloud.io/docker.io/coredns/#g"</span> values.yaml
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g"</span> values.yaml

<span class="token comment"># 默认参数安装</span>
helm <span class="token function">install</span>  coredns ./coredns/ <span class="token parameter variable">-n</span> kube-system
</code></pre> 
<h2><a id="11Metrics_Server_4986"></a>11.安装Metrics Server</h2> 
<h3><a id="111_master01_4988"></a>11.1 以下步骤只在master01操作</h3> 
<h4><a id="1111_Metricsserver_4990"></a>11.1.1 安装Metrics-server</h4> 
<p>在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率</p> 
<pre><code class="prism language-shell"><span class="token comment"># 单机版 </span>
<span class="token function">wget</span> https://mirrors.chenby.cn/https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
<span class="token comment"># 高可用版本(我第一次安装使用的高可用版本)</span>
<span class="token function">wget</span> https://mirrors.chenby.cn/https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/high-availability.yaml


<span class="token comment"># 修改配置(此处修改配置，直接从这里找对应文件即可：https://ghproxy.com/https://github.com/cby-chen/Kubernetes/releases/download/v1.28.0/kubernetes-v1.28.0.tar)</span>
<span class="token function">vim</span> components.yaml
<span class="token function">vim</span> high-availability.yaml

<span class="token comment"># 修改policy/v1beta1为policy/v1</span>
<span class="token comment"># 如果是 Kubernetes 1.25+ 版本，需要将这里的 apiVersion 从 policy/v1beta1 更换为 policy/v1</span>
<span class="token comment"># 否则会报错：no matches for kind "PodDisruptionBudget" in version "policy/v1beta1"</span>
apiVersion: policy/v1

<span class="token comment"># 需要添加内容的3处地方</span>
---
<span class="token comment"># 1</span>
- args:
        - --cert-dir<span class="token operator">=</span>/tmp
        - --secure-port<span class="token operator">=</span><span class="token number">4443</span>
        - --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,ExternalIP,Hostname
        - --kubelet-use-node-status-port
        - --metric-resolution<span class="token operator">=</span>15s
        - --kubelet-insecure-tls
        - --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem
        - --requestheader-username-headers<span class="token operator">=</span>X-Remote-User
        - --requestheader-group-headers<span class="token operator">=</span>X-Remote-Group
        - --requestheader-extra-headers-prefix<span class="token operator">=</span>X-Remote-Extra-

<span class="token comment"># 2</span>
        volumeMounts:
        - mountPath: /tmp
          name: tmp-dir
        - name: ca-ssl
          mountPath: /etc/kubernetes/pki

<span class="token comment"># 3</span>
      volumes:
      - emptyDir: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        name: tmp-dir
      - name: ca-ssl
        hostPath:
          path: /etc/kubernetes/pki
---


<span class="token comment"># 修改为国内源 docker源可选</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g"</span> components.yaml
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g"</span> high-availability.yaml

<span class="token comment"># 二选一</span>
kubectl apply <span class="token parameter variable">-f</span> components.yaml
<span class="token comment"># kubectl apply -f high-availability.yaml</span>

</code></pre> 
<h4><a id="1112__5052"></a>11.1.2 稍等片刻查看状态</h4> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl  top node</span>
NAME           CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%   
k8s-master01   185m         <span class="token number">4</span>%     1343Mi          <span class="token number">72</span>%       
k8s-master02   160m         <span class="token number">4</span>%     1207Mi          <span class="token number">65</span>%       
k8s-master03   143m         <span class="token number">3</span>%     1218Mi          <span class="token number">65</span>%       
k8s-node01     92m          <span class="token number">2</span>%     765Mi           <span class="token number">41</span>%       
k8s-node02     83m          <span class="token number">2</span>%     737Mi           <span class="token number">39</span>%   
</code></pre> 
<h2><a id="12_5064"></a>12.集群验证</h2> 
<h3><a id="121_pod_5066"></a>12.1 部署pod资源</h3> 
<blockquote> 
 <p>master01节点</p> 
</blockquote> 
<pre><code class="prism language-shell">cat<span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> kubectl apply <span class="token parameter variable">-f</span> -</span>
apiVersion: v1
kind: Pod
metadata:
  name: busybox
  namespace: default
spec:
  containers:
  - name: busybox
    image: docker.io/library/busybox:1.28
    command:
      - sleep
      - "3600"
    imagePullPolicy: IfNotPresent
  restartPolicy: Always
EOF</span>

<span class="token comment"># 查看</span>
<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl  get pod</span>
NAME      READY   STATUS    RESTARTS   AGE
busybox   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11s
</code></pre> 
<h3><a id="122_podkubernetes_5094"></a>12.2 用pod解析默认命名空间中的kubernetes</h3> 
<blockquote> 
 <p>master01节点</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 查看name</span>
<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl get svc</span>
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   4h16m

<span class="token comment"># 进行解析</span>
<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl exec  busybox -n default -- nslookup kubernetes</span>
Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 coredns-coredns.kube-system.svc.cluster.local

Name:      kubernetes
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.1 kubernetes.default.svc.cluster.local
</code></pre> 
<h3><a id="123__5113"></a>12.3 测试跨命名空间是否可以解析</h3> 
<blockquote> 
 <p>master01节点</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 查看有那些name</span>
<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl  get svc -A</span>
NAMESPACE     NAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE
default       kubernetes        ClusterIP   <span class="token number">10.96</span>.0.1        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP         4h17m
kube-system   calico-typha      ClusterIP   <span class="token number">10.99</span>.130.70     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">5473</span>/TCP        39m
kube-system   coredns-coredns   ClusterIP   <span class="token number">10.96</span>.0.10       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">53</span>/UDP,53/TCP   10m
kube-system   metrics-server    ClusterIP   <span class="token number">10.105</span>.219.158   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP         2m47s


<span class="token comment"># 进行解析</span>
<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl exec  busybox -n default -- nslookup coredns-coredns.kube-system</span>
Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 coredns-coredns.kube-system.svc.cluster.local

Name:      coredns-coredns.kube-system
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 coredns-coredns.kube-system.svc.cluster.local

</code></pre> 
<h3><a id="124_Kuberneteskubernetes_svc_443kubednsservice_53_5137"></a>12.4 每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53</h3> 
<blockquote> 
 <p>所有节点执行</p> 
</blockquote> 
<pre><code class="prism language-shell">telnet <span class="token number">10.96</span>.0.1 <span class="token number">443</span>
Trying <span class="token number">10.96</span>.0.1<span class="token punctuation">..</span>.
Connected to <span class="token number">10.96</span>.0.1.
Escape character is <span class="token string">'^]'</span><span class="token builtin class-name">.</span>

telnet <span class="token number">10.96</span>.0.10 <span class="token number">53</span>
Trying <span class="token number">10.96</span>.0.10<span class="token punctuation">..</span>.
Connected to <span class="token number">10.96</span>.0.10.
Escape character is <span class="token string">'^]'</span><span class="token builtin class-name">.</span>

<span class="token function">curl</span> <span class="token number">10.96</span>.0.10:53
curl: <span class="token punctuation">(</span><span class="token number">52</span><span class="token punctuation">)</span> Empty reply from server
</code></pre> 
<h3><a id="125_PodPod_5156"></a>12.5 Pod和Pod之前要能通</h3> 
<blockquote> 
 <p>master01节点执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl get po -owide</span>
NAME      READY   STATUS    RESTARTS   AGE     IP             NODE           NOMINATED NODE   READINESS GATES
busybox   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m58s   <span class="token number">172.18</span>.195.2   k8s-master03   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>


<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl get po -n kube-system -owide</span>
NAME                                       READY   STATUS    RESTARTS      AGE     IP              NODE           NOMINATED NODE   READINESS GATES
calico-kube-controllers-765c96cb9d-2r26x   <span class="token number">1</span>/1     Running   <span class="token number">0</span>             29m     <span class="token number">172.27</span>.14.193   k8s-node02     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-jgzv7                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             42m     <span class="token number">192.168</span>.0.32    k8s-master02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-jwbzx                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             42m     <span class="token number">192.168</span>.0.34    k8s-node01     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-pqgjh                          <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>40m ago<span class="token punctuation">)</span>   42m     <span class="token number">192.168</span>.0.33    k8s-master03   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-tbn7t                          <span class="token number">1</span>/1     Running   <span class="token number">2</span> <span class="token punctuation">(</span>40m ago<span class="token punctuation">)</span>   42m     <span class="token number">192.168</span>.0.31    k8s-master01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-node-xmmzt                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>             42m     <span class="token number">192.168</span>.0.35    k8s-node02     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
calico-typha-67c57cdf49-swvhz              <span class="token number">1</span>/1     Running   <span class="token number">0</span>             42m     <span class="token number">192.168</span>.0.31    k8s-master01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
coredns-coredns-6c9554fc94-b9md8           <span class="token number">1</span>/1     Running   <span class="token number">0</span>             13m     <span class="token number">172.18</span>.195.1    k8s-master03   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
metrics-server-5fd97bdcd-fjnbk             <span class="token number">1</span>/1     Running   <span class="token number">0</span>             5m30s   <span class="token number">172.25</span>.92.66    k8s-master02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
metrics-server-5fd97bdcd-kqzhh             <span class="token number">1</span>/1     Running   <span class="token number">0</span>             5m30s   <span class="token number">172.17</span>.125.2    k8s-node01     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>


<span class="token comment"># 进入busybox ping其他节点上的pod</span>
<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl exec -ti busybox -- sh</span>
/ <span class="token comment"># ping 192.168.0.34</span>
PING <span class="token number">192.168</span>.0.34 <span class="token punctuation">(</span><span class="token number">192.168</span>.0.34<span class="token punctuation">)</span>: <span class="token number">56</span> data bytes
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.0.34: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">63</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">42.624</span> ms
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.0.34: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">63</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.530</span> ms
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.0.34: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">63</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.568</span> ms
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.0.34: <span class="token assign-left variable">seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">63</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">1.066</span> ms

<span class="token comment"># 可以连通证明这个pod是可以跨命名空间和跨主机通信的</span>
</code></pre> 
<h3><a id="126_3_5192"></a>12.6 创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）</h3> 
<blockquote> 
 <p>master01节点执行</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> deployments.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
        ports:
        - containerPort: 80

EOF</span>

<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl  apply -f deployments.yaml </span>
deployment.apps/nginx-deployment created

<span class="token comment"># 查看nginx分布在3个节点上</span>
<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl  get pod -o wide</span>
NAME                                READY   STATUS    RESTARTS   AGE    IP               NODE           NOMINATED NODE   READINESS GATES
busybox                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m    <span class="token number">172.18</span>.195.2     k8s-master03   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-deployment-7c5ddbdf54-2sjj4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m2s   <span class="token number">172.17</span>.125.3     k8s-node01     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-deployment-7c5ddbdf54-7nkls   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m2s   <span class="token number">172.25</span>.244.193   k8s-master01   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-deployment-7c5ddbdf54-zt2rx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m2s   <span class="token number">172.25</span>.92.67     k8s-master02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>


<span class="token comment"># 删除nginx</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f deployments.yaml</span>
</code></pre> 
<h2><a id="13dashboard_5238"></a>13.安装dashboard</h2> 
<blockquote> 
 <p>此处使用 helm 安装，镜像拉取不下来，我第一次安装使用的yaml文件安装</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment">#下载所需yaml文件(目前最新版本v3.0.0-alpha0，2.7.0是仅次于3.0.0的最新版本)</span>
<span class="token comment"># 2.7.0版本：https://github.com/kubernetes/dashboard/releases/tag/v2.7.0</span>
<span class="token comment"># 原地址：https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml</span>

<span class="token punctuation">[</span>root@k8s-m1 certs<span class="token punctuation">]</span><span class="token comment"># wget https://ghproxy.com/https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml</span>
</code></pre> 
<h3><a id="131dashboardsvcNodePort_5250"></a>13.1更改dashboard的svc为NodePort，如果已是请忽略</h3> 
<pre><code class="prism language-shell"><span class="token comment">#修改recommended.yaml中service的相关部分，可以临时使用nodeport的方式访问</span>
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  type: NodePort  <span class="token comment"># 添加这个NodePort</span>
  ports:
    - port: <span class="token number">443</span>
      targetPort: <span class="token number">8443</span>
      nodePort: <span class="token number">32443</span>  <span class="token comment"># 添加这个端口</span>
  selector:
    k8s-app: kubernetes-dashboard
</code></pre> 
<h3><a id="132_ymldashboard_5271"></a>13.2 修改yml中的dashboard镜像地址</h3> 
<p>因为kubernetesui/dashboard 镜像在k8s集群拉取不下来，但是本地 docker 能拉去下来，所以镜像地址进行了修改。</p> 
<p>先将docker本地拉取下来的镜像上传至我的阿里云仓库，然后将yml中的地址修改为阿里云仓库，这样就可以正常拉取下来了</p> 
<p>如何上传至阿里云仓库，参考：https://blog.csdn.net/lzb348110175/article/details/132851150</p> 
<pre><code class="prism language-shell"><span class="token comment"># 镜像地址替换(此处阿里云仓库为公开，可以随意使用)</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#kubernetesui/#registry.cn-hangzhou.aliyuncs.com/lzb-kubernetesui/#g"</span> recommended.yaml
</code></pre> 
<h3><a id="133_dashboard_5284"></a>13.3 应用启动dashboard</h3> 
<pre><code class="prism language-shell">kubectl apply <span class="token parameter variable">-f</span> recommended.yaml

<span class="token comment"># 查看dashboard是否启动成功</span>
<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl  get pod -A</span>
NAMESPACE              NAME                                         READY   STATUS              RESTARTS      AGE
default                busybox                                      <span class="token number">1</span>/1     Running             <span class="token number">0</span>             24m
kubernetes-dashboard   dashboard-metrics-scraper-58767c966c-jwf7z   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>             9s
kubernetes-dashboard   kubernetes-dashboard-56d9879b6f-7xp26        <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>             10s
</code></pre> 
<h3><a id="134__5296"></a>13.4 查看端口号</h3> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl get svc kubernetes-dashboard -n kubernetes-dashboard</span>
NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>         AGE
kubernetes-dashboard   NodePort   <span class="token number">10.103</span>.94.98   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>:32443/TCP   108s
</code></pre> 
<h3><a id="135_token_5304"></a>13.5 创建token</h3> 
<pre><code class="prism language-shell"><span class="token function">cat</span> <span class="token operator">&gt;</span> dashboard-user.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kube-system
EOF</span>

kubectl  apply <span class="token parameter variable">-f</span> dashboard-user.yaml

<span class="token comment"># 创建token</span>
<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl -n kube-system create token admin-user</span>
eyJhbGciOiJSUzI1NiIsImtpZCI6IkMxQXdpZkc1dDlRUWdMUWpRaFE5R2F2ME56UlVXVTNmWUFrd0xkOTdXUVEifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNjk1NzE3NDk5LCJpYXQiOjE2OTU3MTM4OTksImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiNDQ0ODIzM2MtMGY4Yi00OGUwLTk2ZTctZmNlMDcyNmYxY2RmIn19LCJuYmYiOjE2OTU3MTM4OTksInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbi11c2VyIn0.njIBClKan5qDafEyOsmMmmRxAmBRllXf-A_nXG_5E6GWJO5tQBAHHLk7sRwoJ5qApuZW8wWjppuESjmmlBdjFH7BjWHWlRJNzHPnPcEQHZJa9lspdZkT_KyoCLCTm-qA0bT9NixTC8i9gbiv1_WTwBAM9xfn0Kuoi_Hivu9SSN8EebFV9GlyfUEEXXGVsrxdg4nGvpQpaQThPIc6BL1RjGHAOfnIS9W0s_t6ZvofOrxEdZk5KhO7ltIEvBGcsF3wnuvbRW6OoMPfrf73KHbGLNb3qRc0htsO9G0iQV4EMItBSDyqCD-zHgid0LIpU50yuYjoMjPyowmnLf8cDyuU7Q
</code></pre> 
<h3><a id="136_dashboard_5335"></a>13.6 登录dashboard</h3> 
<blockquote> 
 <p>31-35，哪个节点都可以登录dashboard</p> 
</blockquote> 
<p>https://192.168.0.31:32443/</p> 
<p><img src="https://images2.imgbox.com/e7/1e/yrf1UfUm_o.png" alt="请添加图片描述"></p> 
<h2><a id="14ingressnginx_5344"></a>14.ingress-nginx安装</h2> 
<blockquote> 
 <p>master01节点执行</p> 
</blockquote> 
<blockquote> 
 <p>ingress-nginx-admission Completed状态为Complted是正常的，因为是定时任务</p> 
</blockquote> 
<h3><a id="141__5350"></a>14.1 执行部署</h3> 
<pre><code class="prism language-shell"><span class="token function">wget</span> https://mirrors.chenby.cn/https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml

<span class="token comment"># 修改为国内源 docker源可选</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g"</span> deploy.yaml

<span class="token comment"># 搜索type,LoadBalancer修改为NodePort</span>
type: NodePort

<span class="token function">cat</span> <span class="token operator">&gt;</span> backend.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: default-http-backend
  labels:
    app.kubernetes.io/name: default-http-backend
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: default-http-backend
  template:
    metadata:
      labels:
        app.kubernetes.io/name: default-http-backend
    spec:
      terminationGracePeriodSeconds: 60
      containers:
      - name: default-http-backend
        image: registry.cn-hangzhou.aliyuncs.com/chenby/defaultbackend-amd64:1.5 
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 30
          timeoutSeconds: 5
        ports:
        - containerPort: 8080
        resources:
          limits:
            cpu: 10m
            memory: 20Mi
          requests:
            cpu: 10m
            memory: 20Mi
---
apiVersion: v1
kind: Service
metadata:
  name: default-http-backend
  namespace: kube-system
  labels:
    app.kubernetes.io/name: default-http-backend
spec:
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app.kubernetes.io/name: default-http-backend
EOF</span>

<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl  apply -f deploy.yaml </span>
namespace/ingress-nginx created
serviceaccount/ingress-nginx created
serviceaccount/ingress-nginx-admission created
role.rbac.authorization.k8s.io/ingress-nginx created
role.rbac.authorization.k8s.io/ingress-nginx-admission created
clusterrole.rbac.authorization.k8s.io/ingress-nginx created
clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created
rolebinding.rbac.authorization.k8s.io/ingress-nginx created
rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created
clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
configmap/ingress-nginx-controller created
service/ingress-nginx-controller created
service/ingress-nginx-controller-admission created
deployment.apps/ingress-nginx-controller created
job.batch/ingress-nginx-admission-create created
job.batch/ingress-nginx-admission-patch created
ingressclass.networking.k8s.io/nginx created
validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created

<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl  apply -f backend.yaml </span>
deployment.apps/default-http-backend created
service/default-http-backend created



<span class="token function">cat</span> <span class="token operator">&gt;</span> ingress-demo-app.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-server
spec:
  replicas: 2
  selector:
    matchLabels:
      app: hello-server
  template:
    metadata:
      labels:
        app: hello-server
    spec:
      containers:
      - name: hello-server
        image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/hello-server
        ports:
        - containerPort: 9000
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx-demo
  name: nginx-demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-demo
  template:
    metadata:
      labels:
        app: nginx-demo
    spec:
      containers:
      - image: nginx
        name: nginx
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: nginx-demo
  name: nginx-demo
spec:
  selector:
    app: nginx-demo
  ports:
  - port: 8000
    protocol: TCP
    targetPort: 80
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: hello-server
  name: hello-server
spec:
  selector:
    app: hello-server
  ports:
  - port: 8000
    protocol: TCP
    targetPort: 9000
---
apiVersion: networking.k8s.io/v1
kind: Ingress  
metadata:
  name: ingress-host-bar
spec:
  ingressClassName: nginx
  rules:
  - host: "hello.chenby.cn"
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: hello-server
            port:
              number: 8000
  - host: "demo.chenby.cn"
    http:
      paths:
      - pathType: Prefix
        path: "/nginx"  
        backend:
          service:
            name: nginx-demo
            port:
              number: 8000
EOF</span>


<span class="token comment"># 注意：等创建完成后在执行：</span>
<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl  apply -f ingress-demo-app.yaml </span>
deployment.apps/hello-server created
deployment.apps/nginx-demo created
service/nginx-demo created
service/hello-server created
ingress.networking.k8s.io/ingress-host-bar created

<span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl  get ingress</span>
NAME               CLASS   HOSTS                            ADDRESS   PORTS   AGE
ingress-host-bar   nginx   hello.chenby.cn,demo.chenby.cn             <span class="token number">80</span>      23s

</code></pre> 
<h3><a id="142_ingress_5555"></a>14.2 过滤查看ingress端口</h3> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master01 lzb<span class="token punctuation">]</span><span class="token comment"># kubectl  get svc -A | grep ingress</span>
ingress-nginx          ingress-nginx-controller             NodePort    <span class="token number">10.100</span>.181.56    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:30383/TCP,443:31913/TCP   8m37s
ingress-nginx          ingress-nginx-controller-admission   ClusterIP   <span class="token number">10.102</span>.63.31     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP                      8m37s
</code></pre> 
<h2><a id="15IPv6_5563"></a>15.IPv6测试</h2> 
<pre><code class="prism language-shell"><span class="token comment">#部署应用</span>

cat<span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> kubectl apply <span class="token parameter variable">-f</span> -</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chenby
spec:
  replicas: 3
  selector:
    matchLabels:
      app: chenby
  template:
    metadata:
      labels:
        app: chenby
    spec:
      containers:
      - name: chenby
        image: docker.io/library/nginx
        resources:
          limits:
            memory: "128Mi"
            cpu: "500m"
        ports:
        - containerPort: 80

---
apiVersion: v1
kind: Service
metadata:
  name: chenby
spec:
  ipFamilyPolicy: PreferDualStack
  ipFamilies:
  - IPv6
  - IPv4
  type: NodePort
  selector:
    app: chenby
  ports:
  - port: 80
    targetPort: 80
EOF</span>


<span class="token comment">#查看端口</span>
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl  get svc</span>
NAME           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
chenby         NodePort    fd00::a29c       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:30779/TCP   5s
<span class="token punctuation">[</span>root@k8s-master01 ~<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token comment">#使用内网访问</span>
<span class="token punctuation">[</span>root@localhost yaml<span class="token punctuation">]</span><span class="token comment"># curl -I http://[fd00::a29c]</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.21.6
Date: Thu, 05 May <span class="token number">2022</span> <span class="token number">10</span>:20:35 GMT
Content-Type: text/html
Content-Length: <span class="token number">615</span>
Last-Modified: Tue, <span class="token number">25</span> Jan <span class="token number">2022</span> <span class="token number">15</span>:03:52 GMT
Connection: keep-alive
ETag: <span class="token string">"61f01158-267"</span>
Accept-Ranges: bytes

<span class="token punctuation">[</span>root@localhost yaml<span class="token punctuation">]</span><span class="token comment"># curl -I http://192.168.0.31:30779</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.21.6
Date: Thu, 05 May <span class="token number">2022</span> <span class="token number">10</span>:20:59 GMT
Content-Type: text/html
Content-Length: <span class="token number">615</span>
Last-Modified: Tue, <span class="token number">25</span> Jan <span class="token number">2022</span> <span class="token number">15</span>:03:52 GMT
Connection: keep-alive
ETag: <span class="token string">"61f01158-267"</span>
Accept-Ranges: bytes

<span class="token punctuation">[</span>root@localhost yaml<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token comment">#使用公网访问</span>
<span class="token punctuation">[</span>root@localhost yaml<span class="token punctuation">]</span><span class="token comment"># curl -I http://[2409:8a10:9e18:9020::10]:30779</span>
HTTP/1.1 <span class="token number">200</span> OK
Server: nginx/1.21.6
Date: Thu, 05 May <span class="token number">2022</span> <span class="token number">10</span>:20:54 GMT
Content-Type: text/html
Content-Length: <span class="token number">615</span>
Last-Modified: Tue, <span class="token number">25</span> Jan <span class="token number">2022</span> <span class="token number">15</span>:03:52 GMT
Connection: keep-alive
ETag: <span class="token string">"61f01158-267"</span>
Accept-Ranges: bytes
</code></pre> 
<h2><a id="16_5658"></a>16.安装命令行自动补全功能</h2> 
<pre><code class="prism language-shell">yum <span class="token function">install</span> bash-completion <span class="token parameter variable">-y</span>
<span class="token builtin class-name">source</span> /usr/share/bash-completion/bash_completion
<span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>kubectl completion <span class="token function">bash</span><span class="token punctuation">)</span>
<span class="token builtin class-name">echo</span> <span class="token string">"source &lt;(kubectl completion bash)"</span> <span class="token operator">&gt;&gt;</span> ~/.bashrc
</code></pre> 
<h2><a id="_5667"></a>附录（可选）</h2> 
<pre><code class="prism language-shell"><span class="token comment"># 镜像加速器可以使用DaoCloud仓库，替换规则如下</span>
cr.l5d.io/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/cr.l5d.io/
docker.elastic.co/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/docker.elastic.co/
docker.io/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/docker.io/
gcr.io/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/gcr.io/
ghcr.io/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/ghcr.io/
k8s.gcr.io/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/k8s.gcr.io/
mcr.microsoft.com/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/mcr.microsoft.com/
nvcr.io/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/nvcr.io/
quay.io/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/quay.io/
registry.jujucharms.com/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/registry.jujucharms.com/
registry.k8s.io/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/registry.k8s.io/
registry.opensource.zalan.do/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/registry.opensource.zalan.do/
rocks.canonical.com/  <span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span> m.daocloud.io/rocks.canonical.com/




<span class="token comment"># 镜像版本要自行查看，因为镜像版本是随时更新的，文档无法做到实时更新</span>

<span class="token comment"># docker pull 镜像</span>

<span class="token function">docker</span> pull registry.cn-hangzhou.aliyuncs.com/chenby/cni:master 
<span class="token function">docker</span> pull registry.cn-hangzhou.aliyuncs.com/chenby/node:master
<span class="token function">docker</span> pull registry.cn-hangzhou.aliyuncs.com/chenby/kube-controllers:master
<span class="token function">docker</span> pull registry.cn-hangzhou.aliyuncs.com/chenby/typha:master
<span class="token function">docker</span> pull registry.cn-hangzhou.aliyuncs.com/chenby/coredns:v1.10.0
<span class="token function">docker</span> pull registry.cn-hangzhou.aliyuncs.com/chenby/pause:3.6
<span class="token function">docker</span> pull registry.cn-hangzhou.aliyuncs.com/chenby/metrics-server:v0.5.2
<span class="token function">docker</span> pull kubernetesui/dashboard:v2.7.0
<span class="token function">docker</span> pull kubernetesui/metrics-scraper:v1.0.8
<span class="token function">docker</span> pull quay.io/cilium/cilium:v1.12.6
<span class="token function">docker</span> pull quay.io/cilium/certgen:v0.1.8
<span class="token function">docker</span> pull quay.io/cilium/hubble-relay:v1.12.6
<span class="token function">docker</span> pull quay.io/cilium/hubble-ui-backend:v0.9.2
<span class="token function">docker</span> pull quay.io/cilium/hubble-ui:v0.9.2
<span class="token function">docker</span> pull quay.io/cilium/cilium-etcd-operator:v2.0.7
<span class="token function">docker</span> pull quay.io/cilium/operator:v1.12.6
<span class="token function">docker</span> pull quay.io/cilium/clustermesh-apiserver:v1.12.6
<span class="token function">docker</span> pull quay.io/coreos/etcd:v3.5.4
<span class="token function">docker</span> pull quay.io/cilium/startup-script:d69851597ea019af980891a4628fb36b7880ec26

<span class="token comment"># docker 保存镜像</span>
<span class="token function">docker</span> save registry.cn-hangzhou.aliyuncs.com/chenby/cni:master <span class="token parameter variable">-o</span> cni.tar 
<span class="token function">docker</span> save registry.cn-hangzhou.aliyuncs.com/chenby/node:master <span class="token parameter variable">-o</span> node.tar 
<span class="token function">docker</span> save registry.cn-hangzhou.aliyuncs.com/chenby/typha:master <span class="token parameter variable">-o</span> typha.tar 
<span class="token function">docker</span> save registry.cn-hangzhou.aliyuncs.com/chenby/kube-controllers:master <span class="token parameter variable">-o</span> kube-controllers.tar 
<span class="token function">docker</span> save registry.cn-hangzhou.aliyuncs.com/chenby/coredns:v1.10.0 <span class="token parameter variable">-o</span> coredns.tar 
<span class="token function">docker</span> save registry.cn-hangzhou.aliyuncs.com/chenby/pause:3.6 <span class="token parameter variable">-o</span> pause.tar 
<span class="token function">docker</span> save registry.cn-hangzhou.aliyuncs.com/chenby/metrics-server:v0.5.2 <span class="token parameter variable">-o</span> metrics-server.tar 
<span class="token function">docker</span> save kubernetesui/dashboard:v2.7.0 <span class="token parameter variable">-o</span> dashboard.tar 
<span class="token function">docker</span> save kubernetesui/metrics-scraper:v1.0.8 <span class="token parameter variable">-o</span> metrics-scraper.tar 
<span class="token function">docker</span> save quay.io/cilium/cilium:v1.12.6 <span class="token parameter variable">-o</span> cilium.tar 
<span class="token function">docker</span> save quay.io/cilium/certgen:v0.1.8 <span class="token parameter variable">-o</span> certgen.tar 
<span class="token function">docker</span> save quay.io/cilium/hubble-relay:v1.12.6 <span class="token parameter variable">-o</span> hubble-relay.tar 
<span class="token function">docker</span> save quay.io/cilium/hubble-ui-backend:v0.9.2 <span class="token parameter variable">-o</span> hubble-ui-backend.tar 
<span class="token function">docker</span> save quay.io/cilium/hubble-ui:v0.9.2 <span class="token parameter variable">-o</span> hubble-ui.tar 
<span class="token function">docker</span> save quay.io/cilium/cilium-etcd-operator:v2.0.7 <span class="token parameter variable">-o</span> cilium-etcd-operator.tar 
<span class="token function">docker</span> save quay.io/cilium/operator:v1.12.6 <span class="token parameter variable">-o</span> operator.tar 
<span class="token function">docker</span> save quay.io/cilium/clustermesh-apiserver:v1.12.6 <span class="token parameter variable">-o</span> clustermesh-apiserver.tar 
<span class="token function">docker</span> save quay.io/coreos/etcd:v3.5.4 <span class="token parameter variable">-o</span> etcd.tar 
<span class="token function">docker</span> save quay.io/cilium/startup-script:d69851597ea019af980891a4628fb36b7880ec26 <span class="token parameter variable">-o</span> startup-script.tar 

<span class="token comment"># 传输到各个节点</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">scp</span> <span class="token parameter variable">-r</span> images/  <span class="token variable">$NODE</span>:/root/ <span class="token punctuation">;</span> <span class="token keyword">done</span>

<span class="token comment"># 创建命名空间</span>
ctr ns create k8s.io

<span class="token comment"># 导入镜像</span>
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/cni.tar
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/node.tar
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/typha.tar
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/kube-controllers.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/coredns.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/pause.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/metrics-server.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/dashboard.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/metrics-scraper.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/dashboard.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/metrics-scraper.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/cilium.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/certgen.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/hubble-relay.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/hubble-ui-backend.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/hubble-ui.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/cilium-etcd-operator.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/operator.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/clustermesh-apiserver.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/etcd.tar 
ctr <span class="token parameter variable">--namespace</span> k8s.io image <span class="token function">import</span> images/startup-script.tar 

<span class="token comment"># pull tar包 解压后</span>
helm pull cilium/cilium

<span class="token comment"># 查看镜像版本</span>
root@hello:~/cilium<span class="token comment"># cat values.yaml| grep tag: -C1</span>
  repository: <span class="token string">"quay.io/cilium/cilium"</span>
  tag: <span class="token string">"v1.12.6"</span>
  pullPolicy: <span class="token string">"IfNotPresent"</span>
--
    repository: <span class="token string">"quay.io/cilium/certgen"</span>
    tag: <span class="token string">"v0.1.8@sha256:4a456552a5f192992a6edcec2febb1c54870d665173a33dc7d876129b199ddbd"</span>
    pullPolicy: <span class="token string">"IfNotPresent"</span>
--
      repository: <span class="token string">"quay.io/cilium/hubble-relay"</span>
      tag: <span class="token string">"v1.12.6"</span>
       <span class="token comment"># hubble-relay-digest</span>
--
        repository: <span class="token string">"quay.io/cilium/hubble-ui-backend"</span>
        tag: <span class="token string">"v0.9.2@sha256:a3ac4d5b87889c9f7cc6323e86d3126b0d382933bd64f44382a92778b0cde5d7"</span>
        pullPolicy: <span class="token string">"IfNotPresent"</span>
--
        repository: <span class="token string">"quay.io/cilium/hubble-ui"</span>
        tag: <span class="token string">"v0.9.2@sha256:d3596efc94a41c6b772b9afe6fe47c17417658956e04c3e2a28d293f2670663e"</span>
        pullPolicy: <span class="token string">"IfNotPresent"</span>
--
    repository: <span class="token string">"quay.io/cilium/cilium-etcd-operator"</span>
    tag: <span class="token string">"v2.0.7@sha256:04b8327f7f992693c2cb483b999041ed8f92efc8e14f2a5f3ab95574a65ea2dc"</span>
    pullPolicy: <span class="token string">"IfNotPresent"</span>
--
    repository: <span class="token string">"quay.io/cilium/operator"</span>
    tag: <span class="token string">"v1.12.6"</span>
    <span class="token comment"># operator-generic-digest</span>
--
    repository: <span class="token string">"quay.io/cilium/startup-script"</span>
    tag: <span class="token string">"d69851597ea019af980891a4628fb36b7880ec26"</span>
    pullPolicy: <span class="token string">"IfNotPresent"</span>
--
    repository: <span class="token string">"quay.io/cilium/cilium"</span>
    tag: <span class="token string">"v1.12.6"</span>
    <span class="token comment"># cilium-digest</span>
--
      repository: <span class="token string">"quay.io/cilium/clustermesh-apiserver"</span>
      tag: <span class="token string">"v1.12.6"</span>
      <span class="token comment"># clustermesh-apiserver-digest</span>
--
        repository: <span class="token string">"quay.io/coreos/etcd"</span>
        tag: <span class="token string">"v3.5.4@sha256:795d8660c48c439a7c3764c2330ed9222ab5db5bb524d8d0607cac76f7ba82a3"</span>
        pullPolicy: <span class="token string">"IfNotPresent"</span>
</code></pre> 
<blockquote> 
 <p>本文 Markdown 文档地址：<a href="https://pan.baidu.com/s/1apCmSd9YDXdnBDt_IItOug?pwd=iatz" rel="nofollow">https://pan.baidu.com/s/1apCmSd9YDXdnBDt_IItOug?pwd=iatz</a></p> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/48d86969c2e4465403066a1cd45301d5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Elasticsearch向量检索的演进与变革：从基础到应用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7cc12f9e61d47011f061767e9cb42253/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">echars 设置滚动条演示，</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>