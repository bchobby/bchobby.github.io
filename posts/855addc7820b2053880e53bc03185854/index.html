<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>实现OCR语言识别Demo（二）- 图片及识别内容的展现和交互 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="实现OCR语言识别Demo（二）- 图片及识别内容的展现和交互" />
<meta property="og:description" content="实现OCR语言识别Demo（二）- 图片及识别内容的展现和交互 实现图片展现OCR识别内容的绘制OCR识别内容的点击效果实现 上一篇文章中（想要回顾的可以看这里），我们实现了BottomSheet，那么这篇文章中，我们要来实现图片展现及识别内容展现了
实现图片展现 我们有2种方式去选择我们的图片，一种是通过选择本地的相册的图片，另一种是通过拍照获得，我们来实现这两种方式
MainActivity.kt
override fun onCreate(savedInstanceState: Bundle?) { ... super.onCreate(savedInstanceState) bindListeners() ... } private fun bindListeners() { open_take_pic.setOnClickListener { takeImage() } open_select_image.setOnClickListener { selectImageFromGallery() } } private val takeImageResult = registerForActivityResult(ActivityResultContracts.TakePicture()) { isSuccess -&gt; if (isSuccess) { latestTmpUri?.let { _ -&gt; CoroutineScope(Dispatchers.IO).launch { val compressedImageFile = Compressor.compress( applicationContext, takeImageTempFile!! ) image_preview.clearOcrBoxes() adapter.submitList(mutableListOf()) previewPhoto(compressedImageFile) postImage(compressedImageFile) } } } } private val selectImageFromGalleryResult = registerForActivityResult(ActivityResultContracts.GetContent()) { uri: Uri?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/855addc7820b2053880e53bc03185854/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-28T08:53:47+08:00" />
<meta property="article:modified_time" content="2022-07-28T08:53:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">实现OCR语言识别Demo（二）- 图片及识别内容的展现和交互</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>实现OCR语言识别Demo（二）- 图片及识别内容的展现和交互</h4> 
 <ul><li><ul><li><a href="#_4" rel="nofollow">实现图片展现</a></li><li><a href="#OCR_199" rel="nofollow">OCR识别内容的绘制</a></li><li><ul><li><a href="#OCR_321" rel="nofollow">OCR识别内容的点击效果实现</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>上一篇文章中（想要回顾的可以看<a href="https://blog.csdn.net/xiaozeiqwe/article/details/125536851">这里</a>），我们实现了BottomSheet，那么这篇文章中，我们要来实现图片展现及识别内容展现了</p> 
<h3><a id="_4"></a>实现图片展现</h3> 
<p>我们有2种方式去选择我们的图片，一种是通过选择本地的相册的图片，另一种是通过拍照获得，我们来实现这两种方式</p> 
<p>MainActivity.kt</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
    <span class="token function">bindListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">bindListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    open_take_pic<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span> <span class="token function">takeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    open_select_image<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span> <span class="token function">selectImageFromGallery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">val</span> takeImageResult <span class="token operator">=</span>
        <span class="token function">registerForActivityResult</span><span class="token punctuation">(</span>ActivityResultContracts<span class="token punctuation">.</span><span class="token function">TakePicture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> isSuccess <span class="token operator">-&gt;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                latestTmpUri<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span> _ <span class="token operator">-&gt;</span>
                    <span class="token function">CoroutineScope</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">val</span> compressedImageFile <span class="token operator">=</span> Compressor<span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span>
                            applicationContext<span class="token punctuation">,</span>
                            takeImageTempFile<span class="token operator">!!</span>
                        <span class="token punctuation">)</span>
                        image_preview<span class="token punctuation">.</span><span class="token function">clearOcrBoxes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        adapter<span class="token punctuation">.</span><span class="token function">submitList</span><span class="token punctuation">(</span><span class="token function">mutableListOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token function">previewPhoto</span><span class="token punctuation">(</span>compressedImageFile<span class="token punctuation">)</span>
                        <span class="token function">postImage</span><span class="token punctuation">(</span>compressedImageFile<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> selectImageFromGalleryResult <span class="token operator">=</span>
        <span class="token function">registerForActivityResult</span><span class="token punctuation">(</span>ActivityResultContracts<span class="token punctuation">.</span><span class="token function">GetContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> uri<span class="token operator">:</span> Uri<span class="token operator">?</span> <span class="token operator">-&gt;</span>
            uri<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> inputStream <span class="token operator">=</span> contentResolver<span class="token punctuation">.</span><span class="token function">openInputStream</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
                <span class="token keyword">val</span> tempFile <span class="token operator">=</span> <span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> fos <span class="token operator">=</span> tempFile<span class="token punctuation">.</span><span class="token function">outputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> buffer <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>
                <span class="token keyword">var</span> byteCount<span class="token operator">:</span> Int
                fos<span class="token punctuation">.</span><span class="token function">use</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>inputStream<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span> byteCount <span class="token operator">=</span> it<span class="token operator">!!</span> <span class="token punctuation">}</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span>
                    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        it<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> byteCount<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                inputStream<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token function">CoroutineScope</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">val</span> compressedImageFile <span class="token operator">=</span>
                        Compressor<span class="token punctuation">.</span><span class="token function">compress</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span> tempFile<span class="token punctuation">)</span>
                    image_preview<span class="token punctuation">.</span><span class="token function">clearOcrBoxes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    adapter<span class="token punctuation">.</span><span class="token function">submitList</span><span class="token punctuation">(</span><span class="token function">mutableListOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token function">previewPhoto</span><span class="token punctuation">(</span>compressedImageFile<span class="token punctuation">)</span>
                    <span class="token function">postImage</span><span class="token punctuation">(</span>compressedImageFile<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">takeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    takeImageTempFile <span class="token operator">=</span> <span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>takeImageTempFile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    lifecycleScope<span class="token punctuation">.</span><span class="token function">launchWhenStarted</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">getUriFromFile</span><span class="token punctuation">(</span>takeImageTempFile<span class="token operator">!!</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span> uri <span class="token operator">-&gt;</span>
                                                 latestTmpUri <span class="token operator">=</span> uri
                                                 takeImageResult<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
                                                <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">selectImageFromGallery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
selectImageFromGalleryResult<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>"image<span class="token comment">/*")

private fun createTempFile() =
	File.createTempFile("tmp_image_file", ".png", filesDir).apply {
    	createNewFile()
    	deleteOnExit()
}

private fun getUriFromFile(file: File): Uri {
    return FileProvider.getUriForFile(
        applicationContext,
        "${BuildConfig.APPLICATION_ID}.provider",
        file
    )
}

private fun previewPhoto(file: File) {
    runOnUiThread {
        Glide.with(applicationContext)
        .asBitmap()
        .override(displayWidth, displayHeight)
        .load(file)
        .into(image_preview)
    }
}

private fun postImage(file: File) {
    val picData = file.source().buffer().readByteString()
    val bodyData = "image_data=${
        URLEncoder.encode(
            picData.base64(),
            Charsets.UTF_8.name()
        )
	}"

    mockWebServer.enqueue(
        MockResponse().setBody(mockResponseJsonStr)
    )
	val mockUrl = mockWebServer.url("/ocr")

    val url = "http://${mockUrl.host}:${mockWebServer.port}"
    //        val url = "http://10.0.200.20:8080/ocr"

    val requestBody =
    bodyData.toRequestBody("application/x-www-form-urlencoded".toMediaType())
    val request = Request.Builder()
        .url(url)
        .post(requestBody)
        .addHeader("Content-Type", "application/x-www-form-urlencoded")
        .build()
	client.newCall(request).enqueue(object : Callback {
        override fun onFailure(call: Call, e: IOException) {
            Log.d("postImage", "onFailure: ${e.message}")
        }

        override fun onResponse(call: Call, response: Response) {
            if (response.isSuccessful) {
                val bodyString = response.body?.string()
                Log.d("postImage", "onResponse: $bodyString")
                val ocrResult =
                Gson().fromJson(bodyString, OcrResult::class.java)
                if (ocrResult.errId != 0) {
                    Log.d(
                        "postImage",
                        "onResponse error: errorId=${ocrResult.errId}, errorMsg = ${ocrResult.errMsg}"
                    )
                } else {
                    val ocrItems = convertOcrItems(ocrResult.result)
                    drawOcrBoxes(file, ocrItems)
                    adapter.submitList(ocrItems)
                }
            } else {
                Log.d(
                    "postImage",
                    "onResponse failure: " + response.body?.string()
                )
            }
        }
	})
}

private fun convertOcrItems(result: List&lt;OcrResult.Result&gt;): List&lt;OcrItem&gt; {
    val ocrItems = mutableListOf&lt;OcrItem&gt;()
    result.forEach {
        val colorR = (0..255).random()
        val colorG = (0..255).random()
        val colorB = (0..255).random()
        val ocrItem = OcrItem(
            boxes = it.boxes,
            text = it.text,
            score = it.score,
            color = Color.argb(
                255,
                colorR,
                colorG,
                colorB
            ).toColor()
        )
        ocrItems.add(ocrItem)
    }
    return ocrItems
}
</span></code></pre> 
<ul><li>我们实现了选择图片和拍照的事件，并在其回调中获取到图片文件进行操作</li><li>我们使用了第三方库Compressor对图片进行了压缩，这样用来减少服务器压力</li><li>展现图片以及展现识别内容前我们会先将以前的识别内容进行清空</li><li>将我们的识别内容列表进行清空操作</li><li>预先进行图片的预览，这一步由于我们去服务端请求需要耗费时间，所以如果是等待服务端响应后再一起展现图片的话，给用户的体验不是很好，所以这边先会将图片展现，然后再去请求服务端</li><li>展现图片和请求服务端都是使用压缩后的图片</li><li>展现图片使用了Glide进行渲染，并且对图片尺寸进行了设置，设置成了与我们在计算图片控件缩放时候一样的值</li><li>请求服务端数据使用okhttp进行接口调用，而我们现在使用了MockWebServer进行了假数据的模拟</li></ul> 
<p>最后，我们要实现我们的OcrImageView，我们定义了一个自定义控件OcrImageView，其继承自AppCompatImageView，其主要功能是根据我们的OCR识别内容进行在图片上识别内容的绘制以及一些点击的交互行为，首先我们先来进行自定义控件OcrImageView的实现</p> 
<p>这边需要注意的是，我们是依靠了设置我们的ImageView自定义控件的<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         a 
        
       
         n 
        
       
         d 
        
       
         r 
        
       
         o 
        
       
         i 
        
       
         d 
        
       
         : 
        
       
         s 
        
       
         c 
        
       
         a 
        
       
         l 
        
       
         e 
        
       
         T 
        
       
         y 
        
       
         p 
        
       
         e 
        
       
         = 
        
       
         " 
        
       
         f 
        
       
         i 
        
       
         t 
        
       
         C 
        
       
         e 
        
       
         n 
        
       
         t 
        
       
         e 
        
       
         r 
        
       
         " 
        
       
      
        android:scaleType="fitCenter" 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">an</span><span class="mord mathnormal">d</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">sc</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord">"</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right: 0.0715em;">tC</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right: 0.0278em;">er</span><span class="mord">"</span></span></span></span></span>属性根据控件高度的改变来达到了我们使其内部自动的进行了图片的缩放来达到的这个效果，并且是按比例进行缩放的，只有这样按比例进行操作，我们在后续才能进行精确的比例关系的映射来定位我们的识别内容</p> 
<h3><a id="OCR_199"></a>OCR识别内容的绘制</h3> 
<p>OcrImageView.kt</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">OcrImageView</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> attributeSet<span class="token operator">:</span> AttributeSet<span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">AppCompatImageView</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attributeSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">var</span> originWidth<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span>
    	<span class="token keyword">private</span> <span class="token keyword">var</span> originHeight<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span>
        
    	<span class="token keyword">private</span> <span class="token keyword">val</span> mPaint<span class="token operator">:</span> Paint <span class="token operator">=</span> <span class="token function">Paint</span><span class="token punctuation">(</span>Paint<span class="token punctuation">.</span>ANTI_ALIAS_FLAG<span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token keyword">val</span> ocrItems<span class="token operator">:</span> MutableList<span class="token operator">&lt;</span>OcrItem<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">mutableListOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">fun</span> <span class="token function">drawOcrBoxes</span><span class="token punctuation">(</span>
            ocrItems<span class="token operator">:</span> List<span class="token operator">&lt;</span>OcrItem<span class="token operator">&gt;</span><span class="token punctuation">,</span>
            originWidth<span class="token operator">:</span> Int<span class="token punctuation">,</span>
            originHeight<span class="token operator">:</span> Int
        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ocrItems<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ocrItems<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ocrItems<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>originWidth <span class="token operator">=</span> originWidth
            <span class="token keyword">this</span><span class="token punctuation">.</span>originHeight <span class="token operator">=</span> originHeight
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">postInvalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">fun</span> <span class="token function">clearOcrBoxes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token keyword">this</span><span class="token punctuation">.</span>ocrItems<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        	<span class="token function">postInvalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    	<span class="token punctuation">}</span>
        
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDraw</span><span class="token punctuation">(</span>canvas<span class="token operator">:</span> Canvas<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>canvas <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">onDrawOcrBoxes</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
    	<span class="token punctuation">}</span>
        
        <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">onDrawOcrBoxes</span><span class="token punctuation">(</span>canvas<span class="token operator">:</span> Canvas<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>drawable <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>ocrItems<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ocrRegions<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">val</span> count <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">val</span> values <span class="token operator">=</span> <span class="token function">FloatArray</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
            imageMatrix<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span>

            <span class="token keyword">val</span> offsetX <span class="token operator">=</span> values<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
            <span class="token keyword">val</span> offsetY <span class="token operator">=</span> values<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
            <span class="token keyword">val</span> scaleX <span class="token operator">=</span> values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">val</span> scaleY <span class="token operator">=</span> values<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>

            <span class="token comment">//图片在控件里的大小 * 在控件里的缩放比例 / 原始图片大小</span>
            <span class="token keyword">val</span> widthRatio<span class="token operator">:</span> Float <span class="token operator">=</span>
                <span class="token number">1.0f</span> <span class="token operator">*</span> drawable<span class="token punctuation">.</span>intrinsicWidth <span class="token operator">*</span> scaleX <span class="token operator">/</span> originWidth
            <span class="token keyword">val</span> heightRatio<span class="token operator">:</span> Float <span class="token operator">=</span>
                <span class="token number">1.0f</span> <span class="token operator">*</span> drawable<span class="token punctuation">.</span>intrinsicHeight <span class="token operator">*</span> scaleY <span class="token operator">/</span> originHeight

            ocrRegions<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            ocrItems<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{<!-- --></span>
                mPaint<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                mPaint<span class="token punctuation">.</span>color <span class="token operator">=</span> it<span class="token punctuation">.</span>color<span class="token punctuation">.</span><span class="token function">toArgb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                mPaint<span class="token punctuation">.</span>style <span class="token operator">=</span> Paint<span class="token punctuation">.</span>Style<span class="token punctuation">.</span>STROKE
                mPaint<span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">4f</span>

                <span class="token keyword">val</span> path <span class="token operator">=</span> <span class="token function">Path</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token keyword">val</span> point0 <span class="token operator">=</span> it<span class="token punctuation">.</span>boxes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                <span class="token keyword">val</span> point1 <span class="token operator">=</span> it<span class="token punctuation">.</span>boxes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                <span class="token keyword">val</span> point2 <span class="token operator">=</span> it<span class="token punctuation">.</span>boxes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
                <span class="token keyword">val</span> point3 <span class="token operator">=</span> it<span class="token punctuation">.</span>boxes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>

                path<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>
                    point0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> widthRatio <span class="token operator">+</span> offsetX<span class="token punctuation">,</span>
                    point0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> heightRatio <span class="token operator">+</span> offsetY
                <span class="token punctuation">)</span>
                path<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>
                    point1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> widthRatio <span class="token operator">+</span> offsetX<span class="token punctuation">,</span>
                    point1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> heightRatio <span class="token operator">+</span> offsetY
                <span class="token punctuation">)</span>
                path<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>
                    point2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> widthRatio <span class="token operator">+</span> offsetX<span class="token punctuation">,</span>
                    point2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> heightRatio <span class="token operator">+</span> offsetY
                <span class="token punctuation">)</span>
                path<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>
                    point3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> widthRatio <span class="token operator">+</span> offsetX<span class="token punctuation">,</span>
                    point3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> heightRatio <span class="token operator">+</span> offsetY
                <span class="token punctuation">)</span>
                path<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>
                    point0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> widthRatio <span class="token operator">+</span> offsetX<span class="token punctuation">,</span>
                    point0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> heightRatio <span class="token operator">+</span> offsetY
                <span class="token punctuation">)</span>

                canvas<span class="token punctuation">.</span><span class="token function">drawPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> mPaint<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            canvas<span class="token punctuation">.</span><span class="token function">restoreToCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>我们提供方法drawOcrBoxes供外层调用用来更新我们的识别内容，其中有三个参数，分别是OCR识别内容list，原始图片宽度，原始图片的高度，这边的原始图片的宽度和高度是指送去进行OCR识别的那张图片的宽高，即压缩过的图片的宽度和高度，这样我们才能根据缩放比例关系来将数据中的坐标点转换到我们的控件中的缩放后的图片上</li><li>我们在onDraw的super.onDraw方法后面添加我们的绘制逻辑，onDrawOcrBoxes里面我们会先获取图片的矩阵信息getImageMatrix方法获取，对于图片矩阵信息的知识这边不展开说了，我们只要知道这个矩阵信息里面包含了图片的偏移，缩放等信息，我们主要用到的就是其偏移和缩放值</li><li>通过矩阵信息获取其偏移量offsetX和offsetY，以及获取其缩放值scaleX和scaleY</li><li>计算出现在的图片对于原始图片的宽度和高度的比例，公式为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          宽高比 
         
        
          = 
         
        
          图片在控件里的大小 
         
        
          ∗ 
         
        
          在控件里的缩放比例 
         
        
          / 
         
        
          原始图片大小 
         
        
       
         宽高比 = 图片在控件里的大小 * 在控件里的缩放比例 / 原始图片大小 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord cjk_fallback">宽高比</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord cjk_fallback">图片在控件里的大小</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord cjk_fallback">在控件里的缩放比例</span><span class="mord">/</span><span class="mord cjk_fallback">原始图片大小</span></span></span></span></span></li><li>对列表进行循环，画每一个识别内容box，在画的时候，我们采用drawPath的方式进行绘制，绘制一个闭合的四边形区域，对每个box设置不同的颜色边框，颜色值我们会在得到数据后就进行数据的创建，所以这边只是需要取出来即可，采用Argb的形式进行设置</li><li>画每一个box的时候每一个path的坐标点都乘以宽高比，以转换到我们现有的图片上来，并且增加偏移量，如</li></ul> 
<pre><code class="prism language-kotlin">path<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>
    point0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> widthRatio <span class="token operator">+</span> offsetX<span class="token punctuation">,</span>
    point0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> heightRatio <span class="token operator">+</span> offsetY
<span class="token punctuation">)</span>
</code></pre> 
<ul><li>有draw就有clear，所以我们添加clearOcrBoxer方法，用于清除图片上的boxes</li></ul> 
<h4><a id="OCR_321"></a>OCR识别内容的点击效果实现</h4> 
<p>最后，我们实现一下图片上点击OCR识别内容box的点击效果，要实现这个我们需要对点击事件进行监听，监听到点击事件后，进行颜色的改变，并回调，而我们需要怎么确定我们点击的是哪一个box呢？我们先来看下代码实现</p> 
<p>OcrImageView.kt</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> <span class="token keyword">val</span> ocrRegions<span class="token operator">:</span> MutableList<span class="token operator">&lt;</span>Region<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">mutableListOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">private</span> <span class="token keyword">var</span> touchX <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">private</span> <span class="token keyword">var</span> touchY <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">private</span> <span class="token keyword">var</span> clickOcrItem<span class="token operator">:</span> OcrItem<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">private</span> <span class="token keyword">var</span> ocrImageListener<span class="token operator">:</span> OcrImageListener<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">clickOcrItem</span><span class="token punctuation">(</span>clickOcrItem<span class="token operator">:</span> OcrItem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clickOcrItem <span class="token operator">!=</span> clickOcrItem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clickOcrItem <span class="token operator">=</span> clickOcrItem
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clickOcrItem <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    <span class="token function">postInvalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">findOcrItemPositionWithRegion</span><span class="token punctuation">(</span>x<span class="token operator">:</span> Int<span class="token punctuation">,</span> y<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Int<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> region<span class="token punctuation">)</span> <span class="token keyword">in</span> ocrRegions<span class="token punctuation">.</span><span class="token function">withIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> index
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>

<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">performClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">performClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token operator">:</span> MotionEvent<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">when</span> <span class="token punctuation">(</span>event<span class="token operator">?</span><span class="token punctuation">.</span>action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        MotionEvent<span class="token punctuation">.</span>ACTION_DOWN <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            touchX <span class="token operator">=</span> event<span class="token punctuation">.</span>x<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            touchY <span class="token operator">=</span> event<span class="token punctuation">.</span>y<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        MotionEvent<span class="token punctuation">.</span>ACTION_MOVE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
        MotionEvent<span class="token punctuation">.</span>ACTION_UP <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>touchX <span class="token operator">==</span> event<span class="token punctuation">.</span>x<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> touchY <span class="token operator">==</span> event<span class="token punctuation">.</span>y<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>ocrRegions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">val</span> x <span class="token operator">=</span> event<span class="token punctuation">.</span>x<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> y <span class="token operator">=</span> event<span class="token punctuation">.</span>y<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token keyword">val</span> clickOcrItemIndex <span class="token operator">=</span> <span class="token function">findOcrItemPositionWithRegion</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clickOcrItemIndex <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">val</span> item <span class="token operator">=</span> ocrItems<span class="token punctuation">[</span>clickOcrItemIndex<span class="token punctuation">]</span>
                    <span class="token function">clickOcrItem</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
                    ocrImageListener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>clickOcrItemIndex<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
                    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">performClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">setOcrImageListener</span><span class="token punctuation">(</span>ocrImageListener<span class="token operator">:</span> OcrImageListener<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ocrImageListener <span class="token operator">=</span> ocrImageListener
<span class="token punctuation">}</span>

<span class="token keyword">fun</span> <span class="token function">selectOcrBox</span><span class="token punctuation">(</span>ocrItem<span class="token operator">:</span> OcrItem<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clickOcrItem</span><span class="token punctuation">(</span>ocrItem<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">buildRegion</span><span class="token punctuation">(</span>path<span class="token operator">:</span> Path<span class="token punctuation">)</span><span class="token operator">:</span> Region <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> pathBoundsRect <span class="token operator">=</span> <span class="token function">RectF</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    path<span class="token punctuation">.</span><span class="token function">computeBounds</span><span class="token punctuation">(</span>pathBoundsRect<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">Region</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setPath</span><span class="token punctuation">(</span>
            path<span class="token punctuation">,</span> <span class="token function">Region</span><span class="token punctuation">(</span>
                pathBoundsRect<span class="token punctuation">.</span>left<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                pathBoundsRect<span class="token punctuation">.</span>top<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                pathBoundsRect<span class="token punctuation">.</span>right<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                pathBoundsRect<span class="token punctuation">.</span>bottom<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">onDrawOcrBoxes</span><span class="token punctuation">(</span>canvas<span class="token operator">:</span> Canvas<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ocrItems<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ocrRegions<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    
    ocrRegions<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    ocrItems<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">{<!-- --></span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
        
        <span class="token keyword">val</span> region <span class="token operator">=</span> <span class="token function">buildRegion</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
        ocrRegions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span>

        <span class="token comment">//画clickocritem</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clickOcrItem <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clickOcrItem <span class="token operator">==</span> it<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            mPaint<span class="token punctuation">.</span>style <span class="token operator">=</span> Paint<span class="token punctuation">.</span>Style<span class="token punctuation">.</span>FILL
            mPaint<span class="token punctuation">.</span>color <span class="token operator">=</span> ContextCompat<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span> R<span class="token punctuation">.</span>color<span class="token punctuation">.</span>select_background<span class="token punctuation">)</span>
            canvas<span class="token punctuation">.</span><span class="token function">drawPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> mPaint<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>我们在画好box后，我们会根据box的四个点坐标，创建出一个Region区域，循环结束后，维护一个与ocrItem一一对应的一个List</li><li>我们重写了onTouchEvent方法，监听了鼠标的点击事件，如果是单击，我们使用点击的坐标x，y去我们的区域列表里面找，看是否有区域正好包含了这个x，y坐标点，如果包含，则说明点击了这个区域，我们即获取到这个区域对应的ocrItem，并为这个item设置成当前的clickItem，这样我们触发再次的onDraw重新绘制，我们就是画出此clickOcrItem</li><li>画完item后给与外层回调，外层可以用此回调来更新我们的RecycleView的列表显示</li><li>外层也可以通过selectOcrBox来使得触发选中某个OcrBox的操作，用于点击RecycleView列表中的某个item后反向选中对应的box</li></ul> 
<p>至此，整个Demo的技术点我们都得到了实现，有遇到类似需求的时候可以参考参考，其中的代码可能并非最好的，所以在使用的时候还是以自己的理解为主，这样你理解了吗？</p> 
<p>另，完整的项目大家可以到github去查看：https://github.com/xiaozeiqwe8/OCRDemo</p> 
<p><strong>最后还望各位兄弟姐妹们点个赞，关个注，更多的我理解的内容我还会陆续和大家分享的，谢谢大家！</strong></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/65b47dd2a36081244fa02072d2d99a2c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Origin(Pro)：3D图-投影、垂线、标签</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e875013c0faef8c6d8f75581616499be/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">我理解的算法 - 53.最大子数组和（超经典多种解法：强推、动态规划、Kadane算法）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>