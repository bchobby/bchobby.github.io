<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Redis 6.0 源码阅读笔记(9)-数据淘汰原理 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Redis 6.0 源码阅读笔记(9)-数据淘汰原理" />
<meta property="og:description" content="文章目录 1. 过期时间的存储源码分析 2. 数据的淘汰2.1 主动删除2.1.1 命令执行前触发2.1.2 命令执行时触发 2.2 定期删除 1. 过期时间的存储 在 redisDb 数据结构 一节中已经提到过，redis 数据库中有一个专门的 expires 字典用于存储显式设置了过期时间的数据(如 SETEX 命令设置的数据)。本节以 SETEX 命令为例，依据源码分析过期时间的设置过程
typedef struct redisDb { dict *dict; /* The keyspace for this DB */ dict *expires; /* Timeout of keys with a timeout set */ dict *blocking_keys; /* Keys with clients waiting for data (BLPOP)*/ dict *ready_keys; /* Blocked keys that received a PUSH */ dict *watched_keys; /* WATCHED keys for MULTI/EXEC CAS */ int id; /* Database ID */ long long avg_ttl; /* Average TTL, just for stats */ unsigned long expires_cursor; /* Cursor of the active expire cycle." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/92c3eeb766b8e04ed806d4ccaa84df09/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-24T15:15:53+08:00" />
<meta property="article:modified_time" content="2020-10-24T15:15:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Redis 6.0 源码阅读笔记(9)-数据淘汰原理</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1__2" rel="nofollow">1. 过期时间的存储</a></li><li><ul><li><ul><li><a href="#_19" rel="nofollow">源码分析</a></li></ul> 
  </li></ul> 
  </li><li><a href="#2__78" rel="nofollow">2. 数据的淘汰</a></li><li><ul><li><ul><li><a href="#21__85" rel="nofollow">2.1 主动删除</a></li><li><ul><li><a href="#211__87" rel="nofollow">2.1.1 命令执行前触发</a></li><li><a href="#212__342" rel="nofollow">2.1.2 命令执行时触发</a></li></ul> 
    </li><li><a href="#22__409" rel="nofollow">2.2 定期删除</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1__2"></a>1. 过期时间的存储</h2> 
<p>在 <a href="https://blog.csdn.net/weixin_45505313/article/details/108241541#12_redisDb_47">redisDb 数据结构</a> 一节中已经提到过，redis 数据库中有一个专门的 <code>expires</code> 字典用于存储<mark>显式设置了过期时间的数据(如 SETEX 命令设置的数据)</mark>。本节以 <code>SETEX</code> 命令为例，依据源码分析过期时间的设置过程</p> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> redisDb <span class="token punctuation">{<!-- --></span>
    dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>                 <span class="token comment">/* The keyspace for this DB */</span>
    dict <span class="token operator">*</span>expires<span class="token punctuation">;</span>              <span class="token comment">/* Timeout of keys with a timeout set */</span>
    dict <span class="token operator">*</span>blocking_keys<span class="token punctuation">;</span>        <span class="token comment">/* Keys with clients waiting for data (BLPOP)*/</span>
    dict <span class="token operator">*</span>ready_keys<span class="token punctuation">;</span>           <span class="token comment">/* Blocked keys that received a PUSH */</span>
    dict <span class="token operator">*</span>watched_keys<span class="token punctuation">;</span>         <span class="token comment">/* WATCHED keys for MULTI/EXEC CAS */</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>                     <span class="token comment">/* Database ID */</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> avg_ttl<span class="token punctuation">;</span>          <span class="token comment">/* Average TTL, just for stats */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> expires_cursor<span class="token punctuation">;</span> <span class="token comment">/* Cursor of the active expire cycle. */</span>
    list <span class="token operator">*</span>defrag_later<span class="token punctuation">;</span>         <span class="token comment">/* List of key names to attempt to defrag one by one, gradually. */</span>
<span class="token punctuation">}</span> redisDb<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_19"></a>源码分析</h4> 
<ol><li> <p><code>SETEX</code> 命令的处理函数为<code>t_string.c#setexCommand()</code>，可以看到该函数只是个入口，其本身并没有多少逻辑</p> <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">setexCommand</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 c<span class="token operator">-&gt;</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">tryObjectEncoding</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setGenericCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>OBJ_SET_NO_FLAGS<span class="token punctuation">,</span>c<span class="token operator">-&gt;</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token operator">-&gt;</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>c<span class="token operator">-&gt;</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>UNIT_SECONDS<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><code>t_string.c#setGenericCommand()</code> 函数在之前的文章中也提到过，此次重点关注和过期时间相关部分，可以看到关键的流程如下：</p> 
  <blockquote> 
   <p>根据 <code>expire</code> 参数，函数中有不同的处理。如果 <code>expire</code> 大于 0，说明客户端传输过来的命令显式设置了过期时间，则首先要对其进行转化校验。之后调用 <code>db.c#setExpire()</code> 函数将 key 和 过期时间保存到 redis 数据库的过期字典中</p> 
  </blockquote> <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">setGenericCommand</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">,</span> robj <span class="token operator">*</span>val<span class="token punctuation">,</span> robj <span class="token operator">*</span>expire<span class="token punctuation">,</span> <span class="token keyword">int</span> unit<span class="token punctuation">,</span> robj <span class="token operator">*</span>ok_reply<span class="token punctuation">,</span> robj <span class="token operator">*</span>abort_reply<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">long</span> <span class="token keyword">long</span> milliseconds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* initialized to avoid any harmness warning */</span>

 <span class="token keyword">if</span> <span class="token punctuation">(</span>expire<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getLongLongFromObjectOrReply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> expire<span class="token punctuation">,</span> <span class="token operator">&amp;</span>milliseconds<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>milliseconds <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token function">addReplyErrorFormat</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token string">"invalid expire time in %s"</span><span class="token punctuation">,</span>c<span class="token operator">-&gt;</span>cmd<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>unit <span class="token operator">==</span> UNIT_SECONDS<span class="token punctuation">)</span> milliseconds <span class="token operator">*</span><span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
 <span class="token keyword">if</span> <span class="token punctuation">(</span>expire<span class="token punctuation">)</span> <span class="token function">setExpire</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>c<span class="token operator">-&gt;</span>db<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token function">mstime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>milliseconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre> </li><li> <p><code>db.c#setExpire()</code> 函数逻辑非常简练，可以分为以下几步：</p> 
  <blockquote> 
   <ol><li>首先调用 <code>dictFind()</code> 函数从数据库保存普通数据的字典(<code>db-&gt;dict</code>)中找到 key 所在的节点，据此判断 key 是否存在</li><li>key 存在的话，调用 <code>dictAddOrFind()</code> 函数使用这个 key 在数据库的过期字典(<code>db-&gt;expires</code>)中插入一个新的节点或者找到已经存在的节点，然后调用<code>dictSetSignedIntegerVal()</code> 函数将过期时间设置为这个节点的 value</li><li>最后如果当前服务端是可写的从节点，则需要将过期数据专门记录下来，调用 <code>rememberSlaveKeyWithExpire()</code> 函数实现</li></ol> 
  </blockquote> <pre><code class="prism language-c"><span class="token comment">/* Set an expire to the specified key. If the expire is set in the context
* of an user calling a command 'c' is the client, otherwise 'c' is set
* to NULL. The 'when' parameter is the absolute unix time in milliseconds
* after which the key will no longer be considered valid. */</span>
<span class="token keyword">void</span> <span class="token function">setExpire</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">,</span> redisDb <span class="token operator">*</span>db<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 dictEntry <span class="token operator">*</span>kde<span class="token punctuation">,</span> <span class="token operator">*</span>de<span class="token punctuation">;</span>

 <span class="token comment">/* Reuse the sds from the main dict in the expire dict */</span>
 kde <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>db<span class="token operator">-&gt;</span>dict<span class="token punctuation">,</span>key<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">serverAssertWithInfo</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>kde <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 de <span class="token operator">=</span> <span class="token function">dictAddOrFind</span><span class="token punctuation">(</span>db<span class="token operator">-&gt;</span>expires<span class="token punctuation">,</span><span class="token function">dictGetKey</span><span class="token punctuation">(</span>kde<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">dictSetSignedIntegerVal</span><span class="token punctuation">(</span>de<span class="token punctuation">,</span>when<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">int</span> writable_slave <span class="token operator">=</span> server<span class="token punctuation">.</span>masterhost <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>repl_slave_ro <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;&amp;</span> writable_slave <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> CLIENT_MASTER<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token function">rememberSlaveKeyWithExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<h2><a id="2__78"></a>2. 数据的淘汰</h2> 
<p>在<a href="https://blog.csdn.net/weixin_45505313/article/details/99714605#5_Redis__116"> Redis 内存淘汰策略</a>一节中，我们提到了 redis 共有 6 种数据淘汰的策略，本节将介绍 redis 是如何执行这些策略的。不过在此之前，我们首先要知道 redis 的过期数据删除其实有两种触发方式：</p> 
<blockquote> 
 <ol><li>主动删除<br> 发生在 redis 处理读写请求的过程，例如执行 get/set 等命令</li><li>定期删除<br> 发生在 redis 定时任务执行过程</li></ol> 
</blockquote> 
<h4><a id="21__85"></a>2.1 主动删除</h4> 
<p>主动删除数据的动作其实也会多处触发，首先服务端解析完客户端传输过来的命令，准备执行前会检查 redis 占用内存是否超过了配置值，从而判断是否需要释放空间。另外在命令执行的过程中也会检查 key 是否过期了，对过期的 key 需要删除处理</p> 
<h5><a id="211__87"></a>2.1.1 命令执行前触发</h5> 
<ol><li> <p>这部分的处理在<code>server.c#processCommand()</code> 函数中，不了解命令处理流程的读者可参考<a href="https://blog.csdn.net/weixin_45505313/article/details/107816424">Redis 6.0 源码阅读笔记(1)-Redis 服务端启动及命令执行</a>。以下源码省略了与数据淘汰无关的部分，可以看到其主要逻辑如下：</p> 
  <blockquote> 
   <ol><li>如果 redis 配置中设置了最大内存，并且 lua 脚本没有超时，则需要进行下一步处理</li><li>调用<code>freeMemoryIfNeededAndSafe()</code>函数进行数据淘汰处理</li></ol> 
  </blockquote> <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">processCommand</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

 <span class="token comment">/* Handle the maxmemory directive.
  *
  * Note that we do not want to reclaim memory if we are here re-entering
  * the event loop since there is a busy Lua script running in timeout
  * condition, to avoid mixing the propagation of scripts with the
  * propagation of DELs due to eviction. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>server<span class="token punctuation">.</span>lua_timedout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">int</span> out_of_memory <span class="token operator">=</span> <span class="token function">freeMemoryIfNeededAndSafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">;</span>
     <span class="token comment">/* freeMemoryIfNeeded may flush slave output buffers. This may result
      * into a slave, that may be the active client, to be freed. */</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>current_client <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>

     <span class="token comment">/* It was impossible to free enough memory, and the command the client
      * is trying to execute is denied during OOM conditions or the client
      * is in MULTI/EXEC context? Error. */</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>out_of_memory <span class="token operator">&amp;&amp;</span>
         <span class="token punctuation">(</span>is_denyoom_command <span class="token operator">||</span>
          <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> CLIENT_MULTI <span class="token operator">&amp;&amp;</span>
           c<span class="token operator">-&gt;</span>cmd<span class="token operator">-&gt;</span>proc <span class="token operator">!=</span> discardCommand<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token function">rejectCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> shared<span class="token punctuation">.</span>oomerr<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token comment">/* Save out_of_memory result at script start, otherwise if we check OOM
      * untill first write within script, memory used by lua stack and
      * arguments might interfere. */</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>cmd<span class="token operator">-&gt;</span>proc <span class="token operator">==</span> evalCommand <span class="token operator">||</span> c<span class="token operator">-&gt;</span>cmd<span class="token operator">-&gt;</span>proc <span class="token operator">==</span> evalShaCommand<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         server<span class="token punctuation">.</span>lua_oom <span class="token operator">=</span> out_of_memory<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><code>evict.c#freeMemoryIfNeededAndSafe()</code> 函数只是个入口，真正的数据淘汰处理在<code>evict.c#freeMemoryIfNeeded()</code> 函数中。这个函数的实现代码很长，不过可以分为以下几个步骤：</p> 
  <blockquote> 
   <ol><li>首先进行各项检查，例如调用 <code>getMaxmemoryState()</code> 函数检查服务端当前占用内存是不是超过了最大内存设置，之后还要检查 redis 服务端最大内存的处理策略 (<code>server.maxmemory_policy</code>)是不是禁止删除数据</li><li>根据服务端最大内存的处理策略的不同，会有不同的处理： 
     <ol><li>对于<mark>最近最少使用 LRU</mark>，<mark>最少使用 LFU</mark> 以及<mark>到达过期时间 TTL</mark> 这几种对 key 有一定要求的删除策略，需要遍历所有 redis 数据库，根据最大内存的处理策略进一步确定删除 key 的范围（所有数据(<code>db-&gt;dict</code>)或者过期数据(<code>db-&gt;expires</code>))，然后调用 <code>evict.c#evictionPoolPopulate()</code> 函数从中挑选出可以删除的候选 key，最后确定一个最佳的 <code>bestkey</code></li><li>对于<mark>随机淘汰</mark>这种对 key 没太多要求的删除策略，同样遍历所有 redis 数据库，根据最大内存的处理策略确定删除 key 的范围，然后调用 <code>dict.c#dictGetRandomKey()</code> 挑选 <code>bestkey</code></li></ol> </li><li>确定了要删除的 <code>bestkey</code>，将其删除即可。如果释放的内存还是没有达到要求，while 循环继续</li></ol> 
  </blockquote> <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">freeMemoryIfNeededAndSafe</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lua_timedout <span class="token operator">||</span> server<span class="token punctuation">.</span>loading<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token function">freeMemoryIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* This function is periodically called to see if there is memory to free
 * according to the current "maxmemory" settings. In case we are over the
 * memory limit, the function will try to free some memory to return back
 * under the limit.
 *
 * The function returns C_OK if we are under the memory limit or if we
 * were over the limit, but the attempt to free memory was successful.
 * Otehrwise if we are over the memory limit, but not enough memory
 * was freed to return back under the limit, the function returns C_ERR. */</span>
<span class="token keyword">int</span> <span class="token function">freeMemoryIfNeeded</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">int</span> keys_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token comment">/* By default replicas should ignore maxmemory
  * and just be masters exact copies. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>masterhost <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>repl_slave_ignore_maxmemory<span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

 size_t mem_reported<span class="token punctuation">,</span> mem_tofree<span class="token punctuation">,</span> mem_freed<span class="token punctuation">;</span>
 mstime_t latency<span class="token punctuation">,</span> eviction_latency<span class="token punctuation">,</span> lazyfree_latency<span class="token punctuation">;</span>
 <span class="token keyword">long</span> <span class="token keyword">long</span> delta<span class="token punctuation">;</span>
 <span class="token keyword">int</span> slaves <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> result <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>

 <span class="token comment">/* When clients are paused the dataset should be static not just from the
  * POV of clients not being able to write, but also from the POV of
  * expires and evictions of keys not being performed. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clientsArePaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_reported<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>mem_tofree<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span>
     <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

 mem_freed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

 <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_NO_EVICTION<span class="token punctuation">)</span>
     <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* We need to free memory, but policy forbids. */</span>

 <span class="token keyword">while</span> <span class="token punctuation">(</span>mem_freed <span class="token operator">&lt;</span> mem_tofree<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">int</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
     <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> next_db <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     sds bestkey <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> bestdbid<span class="token punctuation">;</span>
     redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span>
     dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>
     dictEntry <span class="token operator">*</span>de<span class="token punctuation">;</span>

     <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> <span class="token punctuation">(</span>MAXMEMORY_FLAG_LRU<span class="token operator">|</span>MAXMEMORY_FLAG_LFU<span class="token punctuation">)</span> <span class="token operator">||</span>
         server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_TTL<span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">struct</span> evictionPoolEntry <span class="token operator">*</span>pool <span class="token operator">=</span> EvictionPoolLRU<span class="token punctuation">;</span>

         <span class="token keyword">while</span><span class="token punctuation">(</span>bestkey <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             <span class="token keyword">unsigned</span> <span class="token keyword">long</span> total_keys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> keys<span class="token punctuation">;</span>

             <span class="token comment">/* We don't want to make local-db choices when expiring keys,
              * so to start populate the eviction pool sampling keys from
              * every DB. */</span>
             <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>i<span class="token punctuation">;</span>
                 dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token operator">?</span>
                         db<span class="token operator">-&gt;</span>dict <span class="token punctuation">:</span> db<span class="token operator">-&gt;</span>expires<span class="token punctuation">;</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keys <span class="token operator">=</span> <span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                     <span class="token function">evictionPoolPopulate</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> dict<span class="token punctuation">,</span> db<span class="token operator">-&gt;</span>dict<span class="token punctuation">,</span> pool<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     total_keys <span class="token operator">+</span><span class="token operator">=</span> keys<span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>total_keys<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">/* No keys to evict. */</span>

             <span class="token comment">/* Go backward from best to worst element to evict. */</span>
             <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> EVPOOL_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> k<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                 bestdbid <span class="token operator">=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">;</span>

                 <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">&amp;</span> MAXMEMORY_FLAG_ALLKEYS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                     de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>dict<span class="token punctuation">,</span>
                         pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                     de <span class="token operator">=</span> <span class="token function">dictFind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>db<span class="token punctuation">[</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>dbid<span class="token punctuation">]</span><span class="token punctuation">.</span>expires<span class="token punctuation">,</span>
                         pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>

                 <span class="token comment">/* Remove the entry from the pool. */</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">!=</span> pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span>
                     <span class="token function">sdsfree</span><span class="token punctuation">(</span>pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                 pool<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                 <span class="token comment">/* If the key exists, is our pick. Otherwise it is
                  * a ghost and we need to try the next element. */</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                     bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">break</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                     <span class="token comment">/* Ghost... Iterate again. */</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>

     <span class="token comment">/* volatile-random and allkeys-random policy */</span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM <span class="token operator">||</span>
              server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_VOLATILE_RANDOM<span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token comment">/* When evicting a random key, we try to evict a key for
          * each DB, so we use the static 'next_db' variable to
          * incrementally visit all DBs. */</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">++</span>next_db<span class="token punctuation">)</span> <span class="token operator">%</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span>
             db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>j<span class="token punctuation">;</span>
             dict <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>maxmemory_policy <span class="token operator">==</span> MAXMEMORY_ALLKEYS_RANDOM<span class="token punctuation">)</span> <span class="token operator">?</span>
                     db<span class="token operator">-&gt;</span>dict <span class="token punctuation">:</span> db<span class="token operator">-&gt;</span>expires<span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictSize</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 de <span class="token operator">=</span> <span class="token function">dictGetRandomKey</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 bestkey <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 bestdbid <span class="token operator">=</span> j<span class="token punctuation">;</span>
                 <span class="token keyword">break</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>

     <span class="token comment">/* Finally remove the selected key. */</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>bestdbid<span class="token punctuation">;</span>
         robj <span class="token operator">*</span>keyobj <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>bestkey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">propagateExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">,</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">/* We compute the amount of memory freed by db*Delete() alone.
          * It is possible that actually the memory needed to propagate
          * the DEL in AOF and replication link is greater than the one
          * we are freeing removing the key, but we can't account for
          * that otherwise we would never exit the loop.
          *
          * AOF and Output buffer memory will be freed eventually so
          * we only care about memory used by the key space. */</span>
         delta <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction<span class="token punctuation">)</span>
             <span class="token function">dbAsyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">else</span>
             <span class="token function">dbSyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">signalModifiedKey</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-del"</span><span class="token punctuation">,</span>eviction_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
         delta <span class="token operator">-</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         mem_freed <span class="token operator">+</span><span class="token operator">=</span> delta<span class="token punctuation">;</span>
         server<span class="token punctuation">.</span>stat_evictedkeys<span class="token operator">++</span><span class="token punctuation">;</span>
         <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_EVICTED<span class="token punctuation">,</span> <span class="token string">"evicted"</span><span class="token punctuation">,</span>
             keyobj<span class="token punctuation">,</span> db<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">decrRefCount</span><span class="token punctuation">(</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
         keys_freed<span class="token operator">++</span><span class="token punctuation">;</span>

         <span class="token comment">/* When the memory to free starts to be big enough, we may
          * start spending so much time here that is impossible to
          * deliver data to the slaves fast enough, so we force the
          * transmission here inside the loop. */</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>slaves<span class="token punctuation">)</span> <span class="token function">flushSlavesOutputBuffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">/* Normally our stop condition is the ability to release
          * a fixed, pre-computed amount of memory. However when we
          * are deleting objects in another thread, it's better to
          * check, from time to time, if we already reached our target
          * memory, since the "mem_freed" amount is computed only
          * across the dbAsyncDelete() call, while the thread can
          * release the memory all the time. */</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_eviction <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>keys_freed <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 <span class="token comment">/* Let's satisfy our stop condition. */</span>
                 mem_freed <span class="token operator">=</span> mem_tofree<span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">goto</span> cant_free<span class="token punctuation">;</span> <span class="token comment">/* nothing to free... */</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>

cant_free<span class="token punctuation">:</span>
 <span class="token comment">/* We are here if we are not able to reclaim memory. There is only one
  * last thing we can try: check if the lazyfree thread has jobs in queue
  * and wait... */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">bioPendingJobsOfType</span><span class="token punctuation">(</span>BIO_LAZY_FREE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getMaxmemoryState</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             result <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>
             <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-lazyfree"</span><span class="token punctuation">,</span>lazyfree_latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"eviction-cycle"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<h5><a id="212__342"></a>2.1.2 命令执行时触发</h5> 
<ol><li> <p>以本文第一节中的 <code>SETEX</code>命令为例，<code>t_string.c#setGenericCommand()</code> 函数中最终将数据保存进 redis 数据库的函数为 <code>genericSetKey()</code></p> <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">setGenericCommand</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">,</span> robj <span class="token operator">*</span>val<span class="token punctuation">,</span> robj <span class="token operator">*</span>expire<span class="token punctuation">,</span> <span class="token keyword">int</span> unit<span class="token punctuation">,</span> robj <span class="token operator">*</span>ok_reply<span class="token punctuation">,</span> robj <span class="token operator">*</span>abort_reply<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token function">genericSetKey</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>c<span class="token operator">-&gt;</span>db<span class="token punctuation">,</span>key<span class="token punctuation">,</span>val<span class="token punctuation">,</span>flags <span class="token operator">&amp;</span> OBJ_SET_KEEPTTL<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><code>t_string.c#genericSetKey()</code> 函数的实现很简练，不再赘述，此处重点关注 <code>lookupKeyWrite()</code> 函数</p> <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">genericSetKey</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">,</span> redisDb <span class="token operator">*</span>db<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">,</span> robj <span class="token operator">*</span>val<span class="token punctuation">,</span> <span class="token keyword">int</span> keepttl<span class="token punctuation">,</span> <span class="token keyword">int</span> signal<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lookupKeyWrite</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token function">dbAdd</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>key<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
     <span class="token function">dbOverwrite</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>key<span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">incrRefCount</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keepttl<span class="token punctuation">)</span> <span class="token function">removeExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>signal<span class="token punctuation">)</span> <span class="token function">signalModifiedKey</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>db<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><code>db.c#lookupKeyWrite()</code> 函数只是个入口，可以看到它最终会调用到 <code>expireIfNeeded()</code> 函数，而这个函数就是 redis 命令执行过程中删除过期数据的关键</p> <pre><code class="prism language-c">robj <span class="token operator">*</span><span class="token function">lookupKeyWriteWithFlags</span><span class="token punctuation">(</span>redisDb <span class="token operator">*</span>db<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token function">expireIfNeeded</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token function">lookupKey</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>key<span class="token punctuation">,</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

robj <span class="token operator">*</span><span class="token function">lookupKeyWrite</span><span class="token punctuation">(</span>redisDb <span class="token operator">*</span>db<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> <span class="token function">lookupKeyWriteWithFlags</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> key<span class="token punctuation">,</span> LOOKUP_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><code>db.c#expireIfNeeded()</code> 函数逻辑较为简单，主要做了如下几个动作：</p> 
  <blockquote> 
   <ol><li>调用函数 <code>keyIsExpired()</code> 判断 key 是否过期</li><li>向slave节点传播执行过期 key 的动作并发送事件通知</li><li>删除过期 key</li></ol> 
  </blockquote> <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">expireIfNeeded</span><span class="token punctuation">(</span>redisDb <span class="token operator">*</span>db<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">keyIsExpired</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

 <span class="token comment">/* If we are running in the context of a slave, instead of
  * evicting the expired key from the database, we return ASAP:
  * the slave key expiration is controlled by the master that will
  * send us synthesized DEL operations for expired keys.
  *
  * Still we try to return the right information to the caller,
  * that is, 0 if we think the key should be still valid, 1 if
  * we think the key is expired at this time. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>masterhost <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

 <span class="token comment">/* Delete the key */</span>
 server<span class="token punctuation">.</span>stat_expiredkeys<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token function">propagateExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>key<span class="token punctuation">,</span>server<span class="token punctuation">.</span>lazyfree_lazy_expire<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_EXPIRED<span class="token punctuation">,</span>
     <span class="token string">"expired"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>db<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> retval <span class="token operator">=</span> server<span class="token punctuation">.</span>lazyfree_lazy_expire <span class="token operator">?</span> <span class="token function">dbAsyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>key<span class="token punctuation">)</span> <span class="token punctuation">:</span>
                                            <span class="token function">dbSyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span> <span class="token function">signalModifiedKey</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>db<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<h4><a id="22__409"></a>2.2 定期删除</h4> 
<ol><li> <p>定期删除是通过 redis 定时任务实现的，而定时任务入口为 <code>server.c#serverCron()</code> 函数。这个函数实现代码较多，以下省略不相关的部分，只关注定期删除数据的部分，关键函数为 <code>server.c#databasesCron()</code></p> <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">serverCron</span><span class="token punctuation">(</span><span class="token keyword">struct</span> aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>clientData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 

 <span class="token comment">/* Handle background operations on Redis databases. */</span>
 <span class="token function">databasesCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">/* Start a scheduled AOF rewrite if this was requested by the user while
  * a BGSAVE was in progress. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasActiveChildProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
     server<span class="token punctuation">.</span>aof_rewrite_scheduled<span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token function">rewriteAppendOnlyFileBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">/* Check if a background saving or AOF rewrite in progress terminated. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasActiveChildProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">ldbPendingChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token function">checkChildrenDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">/* If there is not a background saving/rewrite in progress check if
      * we have to save/rewrite now. */</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>saveparamslen<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">struct</span> saveparam <span class="token operator">*</span>sp <span class="token operator">=</span> server<span class="token punctuation">.</span>saveparams<span class="token operator">+</span>j<span class="token punctuation">;</span>

         <span class="token comment">/* Save if we reached the given amount of changes,
          * the given amount of seconds, and if the latest bgsave was
          * successful or if, in case of an error, at least
          * CONFIG_BGSAVE_RETRY_DELAY seconds already elapsed. */</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>dirty <span class="token operator">&gt;=</span> sp<span class="token operator">-&gt;</span>changes <span class="token operator">&amp;&amp;</span>
             server<span class="token punctuation">.</span>unixtime<span class="token operator">-</span>server<span class="token punctuation">.</span>lastsave <span class="token operator">&gt;</span> sp<span class="token operator">-&gt;</span>seconds <span class="token operator">&amp;&amp;</span>
             <span class="token punctuation">(</span>server<span class="token punctuation">.</span>unixtime<span class="token operator">-</span>server<span class="token punctuation">.</span>lastbgsave_try <span class="token operator">&gt;</span>
              CONFIG_BGSAVE_RETRY_DELAY <span class="token operator">||</span>
              server<span class="token punctuation">.</span>lastbgsave_status <span class="token operator">==</span> C_OK<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">{<!-- --></span>
             <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"%d changes in %d seconds. Saving..."</span><span class="token punctuation">,</span>
                 sp<span class="token operator">-&gt;</span>changes<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>sp<span class="token operator">-&gt;</span>seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
             rdbSaveInfo rsi<span class="token punctuation">,</span> <span class="token operator">*</span>rsiptr<span class="token punctuation">;</span>
             rsiptr <span class="token operator">=</span> <span class="token function">rdbPopulateSaveInfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rsi<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token function">rdbSaveBackground</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>rdb_filename<span class="token punctuation">,</span>rsiptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>

     <span class="token comment">/* Trigger an AOF rewrite if needed. */</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_state <span class="token operator">==</span> AOF_ON <span class="token operator">&amp;&amp;</span>
         <span class="token operator">!</span><span class="token function">hasActiveChildProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
         server<span class="token punctuation">.</span>aof_rewrite_perc <span class="token operator">&amp;&amp;</span>
         server<span class="token punctuation">.</span>aof_current_size <span class="token operator">&gt;</span> server<span class="token punctuation">.</span>aof_rewrite_min_size<span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">long</span> <span class="token keyword">long</span> base <span class="token operator">=</span> server<span class="token punctuation">.</span>aof_rewrite_base_size <span class="token operator">?</span>
             server<span class="token punctuation">.</span>aof_rewrite_base_size <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
         <span class="token keyword">long</span> <span class="token keyword">long</span> growth <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_current_size<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span>base<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>growth <span class="token operator">&gt;=</span> server<span class="token punctuation">.</span>aof_rewrite_perc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"Starting automatic rewriting of AOF on %lld%% growth"</span><span class="token punctuation">,</span>growth<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token function">rewriteAppendOnlyFileBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>


 <span class="token comment">/* AOF postponed flush: Try at every cron cycle if the slow fsync
  * completed. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_flush_postponed_start<span class="token punctuation">)</span> <span class="token function">flushAppendOnlyFile</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">/* AOF write errors: in this case we have a buffer to flush as well and
  * clear the AOF error in case of success to make the DB writable again,
  * however to try every second is enough in case of 'hz' is set to
  * an higher frequency. */</span>
 <span class="token function">run_with_period</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_last_write_status <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span>
         <span class="token function">flushAppendOnlyFile</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><code>server.c#databasesCron()</code> 函数会对数据库执行删除过期键、调整大小以及渐进式 rehash 等动作，<mark>本节主要关注删除过期键的操作</mark>，这部分由<code>expire.c#activeExpireCycle()</code>函数实现</p> <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">databasesCron</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token comment">/* Expire keys by random sampling. Not required for slaves
  * as master will synthesize DELs for us. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>active_expire_enabled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">iAmMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token function">activeExpireCycle</span><span class="token punctuation">(</span>ACTIVE_EXPIRE_CYCLE_SLOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
         <span class="token function">expireSlaveKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 <span class="token comment">/* Defrag keys gradually. */</span>
 <span class="token function">activeDefragCycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">/* Perform hash tables rehashing if needed, but only if there are no
  * other processes saving the DB on disk. Otherwise rehashing is bad
  * as will cause a lot of copy-on-write of memory pages. */</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasActiveChildProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">/* We use global counters so if we stop the computation at a given
      * DB we'll be able to start from the successive in the next
      * cron loop iteration. */</span>
     <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> resize_db <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> rehash_db <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> dbs_per_call <span class="token operator">=</span> CRON_DBS_PER_CALL<span class="token punctuation">;</span>
     <span class="token keyword">int</span> j<span class="token punctuation">;</span>

     <span class="token comment">/* Don't test more DBs than we have. */</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>dbs_per_call <span class="token operator">&gt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">)</span> dbs_per_call <span class="token operator">=</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span>

     <span class="token comment">/* Resize */</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> dbs_per_call<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token function">tryResizeHashTables</span><span class="token punctuation">(</span>resize_db <span class="token operator">%</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
         resize_db<span class="token operator">++</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token comment">/* Rehash */</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>activerehashing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> dbs_per_call<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             <span class="token keyword">int</span> work_done <span class="token operator">=</span> <span class="token function">incrementallyRehash</span><span class="token punctuation">(</span>rehash_db<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>work_done<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 <span class="token comment">/* If the function did some work, stop here, we'll do
                  * more at the next cron loop. */</span>
                 <span class="token keyword">break</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                 <span class="token comment">/* If this db didn't need rehash, we'll try the next one. */</span>
                 rehash_db<span class="token operator">++</span><span class="token punctuation">;</span>
                 rehash_db <span class="token operator">%</span><span class="token operator">=</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><code>expire.c#activeExpireCycle()</code>函数实现代码很长，其中需要注意的步骤如下：</p> 
  <blockquote> 
   <ol><li>遍历指定个数的db（如16）进行删除过期数据的操作</li><li>针对每个 db 每轮遍历不超过指定数量（如20）的节点，随机获取有过期时间的节点数据，调用<code>activeExpireCycleTryExpire()</code> 函数尝试删除数据</li><li>每个db 的遍历的轮数累积到16次的时候，会判断使用的时间是否超过定时任务执行时间的 25%(<code>timelimit = 1000000*ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC/server.hz/100</code>)，超过就停止删除数据过程</li><li>最后如果<mark>已经删除的过期数据</mark>与<mark>随机选中的待过期数据</mark>的比值超过了配置值，也停止删除数据</li></ol> 
  </blockquote> <pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">define</span> ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC 25 </span><span class="token comment">/* Max % of CPU to use. */</span>
<span class="token keyword">void</span> <span class="token function">activeExpireCycle</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
     <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> dbs_per_call <span class="token operator">&amp;&amp;</span> timelimit_exit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">/* Expired and checked in a single loop. */</span>
     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> expired<span class="token punctuation">,</span> sampled<span class="token punctuation">;</span>

     redisDb <span class="token operator">*</span>db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span><span class="token punctuation">(</span>current_db <span class="token operator">%</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">/* Increment the DB now so we are sure if we run out of time
      * in the current DB we'll restart from the next. This allows to
      * distribute the time evenly across DBs. */</span>
     current_db<span class="token operator">++</span><span class="token punctuation">;</span>

     <span class="token comment">/* Continue to expire if at the end of the cycle there are still
      * a big percentage of keys to expire, compared to the number of keys
      * we scanned. The percentage, stored in config_cycle_acceptable_stale
      * is not fixed, but depends on the Redis configured "expire effort". */</span>
     <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">unsigned</span> <span class="token keyword">long</span> num<span class="token punctuation">,</span> slots<span class="token punctuation">;</span>
         <span class="token keyword">long</span> <span class="token keyword">long</span> now<span class="token punctuation">,</span> ttl_sum<span class="token punctuation">;</span>
         <span class="token keyword">int</span> ttl_samples<span class="token punctuation">;</span>
         iteration<span class="token operator">++</span><span class="token punctuation">;</span>

         <span class="token comment">/* If there is nothing to expire try next DB ASAP. */</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">=</span> <span class="token function">dictSize</span><span class="token punctuation">(</span>db<span class="token operator">-&gt;</span>expires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             db<span class="token operator">-&gt;</span>avg_ttl <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
             <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         slots <span class="token operator">=</span> <span class="token function">dictSlots</span><span class="token punctuation">(</span>db<span class="token operator">-&gt;</span>expires<span class="token punctuation">)</span><span class="token punctuation">;</span>
         now <span class="token operator">=</span> <span class="token function">mstime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">/* When there are less than 1% filled slots, sampling the key
          * space is expensive, so stop here waiting for better times...
          * The dictionary will be resized asap. */</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">&amp;&amp;</span> slots <span class="token operator">&gt;</span> DICT_HT_INITIAL_SIZE <span class="token operator">&amp;&amp;</span>
             <span class="token punctuation">(</span>num<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span>slots <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

         <span class="token comment">/* The main collection cycle. Sample random keys among keys
          * with an expire set, checking for expired ones. */</span>
         expired <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         sampled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         ttl_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         ttl_samples <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

         <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">&gt;</span> config_keys_per_loop<span class="token punctuation">)</span>
             num <span class="token operator">=</span> config_keys_per_loop<span class="token punctuation">;</span>

         <span class="token comment">/* Here we access the low level representation of the hash table
          * for speed concerns: this makes this code coupled with dict.c,
          * but it hardly changed in ten years.
          *
          * Note that certain places of the hash table may be empty,
          * so we want also a stop condition about the number of
          * buckets that we scanned. However scanning for free buckets
          * is very fast: we are in the cache line scanning a sequential
          * array of NULL pointers, so we can scan a lot more buckets
          * than keys in the same time. */</span>
         <span class="token keyword">long</span> max_buckets <span class="token operator">=</span> num<span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">;</span>
         <span class="token keyword">long</span> checked_buckets <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

         <span class="token keyword">while</span> <span class="token punctuation">(</span>sampled <span class="token operator">&lt;</span> num <span class="token operator">&amp;&amp;</span> checked_buckets <span class="token operator">&lt;</span> max_buckets<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> table <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> table <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> table<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>table <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">dictIsRehashing</span><span class="token punctuation">(</span>db<span class="token operator">-&gt;</span>expires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

                 <span class="token keyword">unsigned</span> <span class="token keyword">long</span> idx <span class="token operator">=</span> db<span class="token operator">-&gt;</span>expires_cursor<span class="token punctuation">;</span>
                 idx <span class="token operator">&amp;</span><span class="token operator">=</span> db<span class="token operator">-&gt;</span>expires<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>sizemask<span class="token punctuation">;</span>
                 dictEntry <span class="token operator">*</span>de <span class="token operator">=</span> db<span class="token operator">-&gt;</span>expires<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span>table<span class="token punctuation">]</span><span class="token punctuation">.</span>table<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
                 <span class="token keyword">long</span> <span class="token keyword">long</span> ttl<span class="token punctuation">;</span>

                 <span class="token comment">/* Scan the current bucket of the current table. */</span>
                 checked_buckets<span class="token operator">++</span><span class="token punctuation">;</span>
                 <span class="token keyword">while</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                     <span class="token comment">/* Get the next entry now since this entry may get
                      * deleted. */</span>
                     dictEntry <span class="token operator">*</span>e <span class="token operator">=</span> de<span class="token punctuation">;</span>
                     de <span class="token operator">=</span> de<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>

                     ttl <span class="token operator">=</span> <span class="token function">dictGetSignedIntegerVal</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token operator">-</span>now<span class="token punctuation">;</span>
                     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">activeExpireCycleTryExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>e<span class="token punctuation">,</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> expired<span class="token operator">++</span><span class="token punctuation">;</span>
                     <span class="token keyword">if</span> <span class="token punctuation">(</span>ttl <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                         <span class="token comment">/* We want the average TTL of keys yet
                          * not expired. */</span>
                         ttl_sum <span class="token operator">+</span><span class="token operator">=</span> ttl<span class="token punctuation">;</span>
                         ttl_samples<span class="token operator">++</span><span class="token punctuation">;</span>
                     <span class="token punctuation">}</span>
                     sampled<span class="token operator">++</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
             db<span class="token operator">-&gt;</span>expires_cursor<span class="token operator">++</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         total_expired <span class="token operator">+</span><span class="token operator">=</span> expired<span class="token punctuation">;</span>
         total_sampled <span class="token operator">+</span><span class="token operator">=</span> sampled<span class="token punctuation">;</span>

         <span class="token comment">/* Update the average TTL stats for this database. */</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>ttl_samples<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             <span class="token keyword">long</span> <span class="token keyword">long</span> avg_ttl <span class="token operator">=</span> ttl_sum<span class="token operator">/</span>ttl_samples<span class="token punctuation">;</span>

             <span class="token comment">/* Do a simple running average with a few samples.
              * We just use the current estimate with a weight of 2%
              * and the previous estimate with a weight of 98%. */</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>db<span class="token operator">-&gt;</span>avg_ttl <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> db<span class="token operator">-&gt;</span>avg_ttl <span class="token operator">=</span> avg_ttl<span class="token punctuation">;</span>
             db<span class="token operator">-&gt;</span>avg_ttl <span class="token operator">=</span> <span class="token punctuation">(</span>db<span class="token operator">-&gt;</span>avg_ttl<span class="token operator">/</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">49</span> <span class="token operator">+</span> <span class="token punctuation">(</span>avg_ttl<span class="token operator">/</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         <span class="token comment">/* We can't block forever here even if there are many keys to
          * expire. So after a given amount of milliseconds return to the
          * caller waiting for the other active expire cycle. */</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>iteration <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* check once every 16 iterations. */</span>
             elapsed <span class="token operator">=</span> <span class="token function">ustime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>elapsed <span class="token operator">&gt;</span> timelimit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 timelimit_exit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                 server<span class="token punctuation">.</span>stat_expired_time_cap_reached_count<span class="token operator">++</span><span class="token punctuation">;</span>
                 <span class="token keyword">break</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token comment">/* We don't repeat the cycle for the current database if there are
          * an acceptable amount of stale keys (logically expired but yet
          * not reclaimed). */</span>
     <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>sampled <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
              <span class="token punctuation">(</span>expired<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span>sampled<span class="token punctuation">)</span> <span class="token operator">&gt;</span> config_cycle_acceptable_stale<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><code>expire.c#activeExpireCycleTryExpire()</code>是真正尝试删除过期数据的处理函数，以下源码简单明了，不再赘述</p> <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">activeExpireCycleTryExpire</span><span class="token punctuation">(</span>redisDb <span class="token operator">*</span>db<span class="token punctuation">,</span> dictEntry <span class="token operator">*</span>de<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">long</span> <span class="token keyword">long</span> t <span class="token operator">=</span> <span class="token function">dictGetSignedIntegerVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&gt;</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     sds key <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
     robj <span class="token operator">*</span>keyobj <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token function">propagateExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">,</span>server<span class="token punctuation">.</span>lazyfree_lazy_expire<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>lazyfree_lazy_expire<span class="token punctuation">)</span>
         <span class="token function">dbAsyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">else</span>
         <span class="token function">dbSyncDelete</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">notifyKeyspaceEvent</span><span class="token punctuation">(</span>NOTIFY_EXPIRED<span class="token punctuation">,</span>
         <span class="token string">"expired"</span><span class="token punctuation">,</span>keyobj<span class="token punctuation">,</span>db<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">trackingInvalidateKey</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">decrRefCount</span><span class="token punctuation">(</span>keyobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
     server<span class="token punctuation">.</span>stat_expiredkeys<span class="token operator">++</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2e2133a682c2c8c9b2b03c3599b841f6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">苹果手机怎么清理听筒灰尘_iPhone手机听筒声音小、有杂音？成都苹果维修点教你轻松解决...</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/abcf35cce545f97a4cb6def781c0b1e6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">面试题集锦</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>