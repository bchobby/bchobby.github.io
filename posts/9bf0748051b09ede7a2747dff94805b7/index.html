<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Netty实战 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Netty实战" />
<meta property="og:description" content="1. Netty介绍与相关基础知识 1.1 Netty介绍 简介
Netty是由JBOSS提供的一个java开源框架。Netty提供异步的、事件驱动的网络应用程序框架和工具，用以快速开发高性能、高可靠性的网络服务器和客户端程序。也就是说，Netty 是一个基于NIO的客户、服务器端编程框架，使用Netty 可以确保你快速和简单的开发出一个网络应用，例如实现了某种协议的客户、服务端应用。Netty相当于简化和流线化了网络应用的编程开发过程，例如：基于TCP和UDP的socket服务开发。“快速”和“简单”并不用产生维护性或性能上的问题。Netty 是一个吸收了多种协议（包括FTP、SMTP、HTTP等各种二进制文本协议）的实现经验，并经过相当精心设计的项目。最终，Netty 成功的找到了一种方式，在保证易于开发的同时还保证了其应用的性能，稳定性和伸缩性。
（1） Netty提供了简单易用的API
（2） 基于事件驱动的编程方式来编写网络通信程序
（3） 更高的吞吐量
（4） 学习难度低
应用场景：
JavaEE： Dubbo
大数据：Apache Storm（Supervisor worker进程间的通信也是基于Netty来实现的）
1.2 BIO、NIO、AIO介绍与区别 阻塞与非阻塞
主要指的是访问IO的线程是否会阻塞（或者说是等待）
线程访问资源，该资源是否准备就绪的一种处理方式。
同步和异步
主要是指的数据的请求方式
同步和异步是指访问数据的一种机制
BIO
同步阻塞IO，Block IO，IO操作时会阻塞线程，并发处理能力低。
我们熟知的Socket编程就是BIO，一个socket连接一个处理线程（这个线程负责这个Socket连接的一系列数据传输操作）。阻塞的原因在于：操作系统允许的线程数量是有限的，多个socket申请与服务端建立连接时，服务端不能提供相应数量的处理线程，没有分配到处理线程的连接就会阻塞等待或被拒绝
NIO
同步非阻塞IO，None-Block IO
NIO是对BIO的改进，基于Reactor模型。我们知道，一个socket连接只有在特点时候才会发生数据传输IO操作，大部分时间这个“数据通道”是空闲的，但还是占用着线程。NIO作出的改进就是“一个请求一个线程”，在连接到服务端的众多socket中，只有需要进行IO操作的才能获取服务端的处理线程进行IO。这样就不会因为线程不够用而限制了socket的接入
AIO（NIO 2.0）
异步非阻塞IO
这种IO模型是由操作系统先完成了客户端请求处理再通知服务器去启动线程进行处理。AIO也称NIO2.0，在JDK7开始支持。
1.3 Netty Reactor模型 - 单线程模型、多线程模型、主从多线程模型介绍 1.3.1 单线程模型 用户发起IO请求到Reactor线程，Ractor线程将用户的IO请求放入到通道，然后再进行后续处理，处理完成后，Reactor线程重新获得控制权，继续其他客户端的处理，这种模型一个时间点只有一个任务在执行，这个任务执行完了，再去执行下一个任务。
但单线程的Reactor模型每一个用户事件都在一个线程中执行：性能有极限，不能处理成百上千的事件当负荷达到一定程度时，性能将会下降某一个事件处理器发生故障，不能继续处理其他事件
1.3.2 Reactor多线程模型 Reactor多线程模型是由一组NIO线程来处理IO操作（之前是单个线程），所以在请求处理上会比上一中模型效率更高，可以处理更多的客户端请求。这种模式使用多个线程执行多个任务，任务可以同时执行，但是如果并发仍然很大，Reactor仍然无法处理大量的客户端请求
1.3.3 Reactor主从多线程模型 这种线程模型是Netty推荐使用的线程模型，这种模型适用于高并发场景，一组线程池接收请求，一组线程池处理IO。
1.4 Netty - 基于web socket简单聊天DEMO实现 后端编写
导入依赖
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt; &lt;project xmlns=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/9bf0748051b09ede7a2747dff94805b7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-29T13:21:32+08:00" />
<meta property="article:modified_time" content="2020-12-29T13:21:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Netty实战</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1%09Netty_0"></a>1. Netty介绍与相关基础知识</h3> 
<h3><a id="11_Netty_2"></a>1.1 Netty介绍</h3> 
<p><strong>简介</strong><br> Netty是由JBOSS提供的一个java开源框架。Netty提供异步的、事件驱动的网络应用程序框架和工具，用以快速开发高性能、高可靠性的网络服务器和客户端程序。也就是说，Netty 是一个基于NIO的客户、服务器端编程框架，使用Netty 可以确保你快速和简单的开发出一个网络应用，例如实现了某种协议的客户、服务端应用。Netty相当于简化和流线化了网络应用的编程开发过程，例如：基于TCP和UDP的socket服务开发。“快速”和“简单”并不用产生维护性或性能上的问题。Netty 是一个吸收了多种协议（包括FTP、SMTP、HTTP等各种二进制文本协议）的实现经验，并经过相当精心设计的项目。最终，Netty 成功的找到了一种方式，在保证易于开发的同时还保证了其应用的性能，稳定性和伸缩性。<br> （1） Netty提供了简单易用的API<br> （2） 基于事件驱动的编程方式来编写网络通信程序<br> （3） 更高的吞吐量<br> （4） 学习难度低<br> <strong>应用场景：</strong><br> JavaEE： Dubbo<br> 大数据：Apache Storm（Supervisor worker进程间的通信也是基于Netty来实现的）</p> 
<h3><a id="12%09BIONIOAIO_13"></a>1.2 BIO、NIO、AIO介绍与区别</h3> 
<p><strong>阻塞与非阻塞</strong><br> 主要指的是访问IO的线程是否会阻塞（或者说是等待）<br> 线程访问资源，该资源是否准备就绪的一种处理方式。<br> <img src="https://images2.imgbox.com/44/a5/Xkf2GWSF_o.png" alt="在这里插入图片描述"><strong>同步和异步</strong><br> 主要是指的数据的请求方式<br> 同步和异步是指访问数据的一种机制<br> <img src="https://images2.imgbox.com/28/7a/BOWhJLir_o.png" alt="在这里插入图片描述"><br> <strong>BIO</strong><br> 同步阻塞IO，Block IO，IO操作时会阻塞线程，并发处理能力低。<br> 我们熟知的Socket编程就是BIO，一个socket连接一个处理线程（这个线程负责这个Socket连接的一系列数据传输操作）。阻塞的原因在于：操作系统允许的线程数量是有限的，多个socket申请与服务端建立连接时，服务端不能提供相应数量的处理线程，没有分配到处理线程的连接就会阻塞等待或被拒绝<br> <img src="https://images2.imgbox.com/90/ae/211CLVRV_o.png" alt="在这里插入图片描述"><br> <strong>NIO</strong><br> 同步非阻塞IO，None-Block IO<br> NIO是对BIO的改进，基于Reactor模型。我们知道，一个socket连接只有在特点时候才会发生数据传输IO操作，大部分时间这个“数据通道”是空闲的，但还是占用着线程。NIO作出的改进就是“一个请求一个线程”，在连接到服务端的众多socket中，只有需要进行IO操作的才能获取服务端的处理线程进行IO。这样就不会因为线程不够用而限制了socket的接入<br> <img src="https://images2.imgbox.com/9b/c9/imq72Tl2_o.png" alt="在这里插入图片描述"><br> <strong>AIO（NIO 2.0）</strong><br> 异步非阻塞IO<br> 这种IO模型是由操作系统先完成了客户端请求处理再通知服务器去启动线程进行处理。AIO也称NIO2.0，在JDK7开始支持。</p> 
<h3><a id="13%09Netty_Reactor___33"></a>1.3 Netty Reactor模型 - 单线程模型、多线程模型、主从多线程模型介绍</h3> 
<h3><a id="131__35"></a>1.3.1 单线程模型</h3> 
<p>用户发起IO请求到Reactor线程，Ractor线程将用户的IO请求放入到通道，然后再进行后续处理，处理完成后，Reactor线程重新获得控制权，继续其他客户端的处理，这种模型一个时间点只有一个任务在执行，这个任务执行完了，再去执行下一个任务。</p> 
<ol><li>但单线程的Reactor模型每一个用户事件都在一个线程中执行：</li><li>性能有极限，不能处理成百上千的事件</li><li>当负荷达到一定程度时，性能将会下降</li><li>某一个事件处理器发生故障，不能继续处理其他事件<br> <img src="https://images2.imgbox.com/fd/52/Z6hmegNU_o.png" alt="在这里插入图片描述"></li></ol> 
<h3><a id="132%09Reactor_42"></a>1.3.2 Reactor多线程模型</h3> 
<p>Reactor多线程模型是由一组NIO线程来处理IO操作（之前是单个线程），所以在请求处理上会比上一中模型效率更高，可以处理更多的客户端请求。这种模式使用多个线程执行多个任务，任务可以同时执行，但是如果并发仍然很大，Reactor仍然无法处理大量的客户端请求<br> <img src="https://images2.imgbox.com/a4/9c/mp3Qll53_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="133%09Reactor_45"></a>1.3.3 Reactor主从多线程模型</h3> 
<p>这种线程模型是Netty推荐使用的线程模型，这种模型适用于高并发场景，一组线程池接收请求，一组线程池处理IO。<br> <img src="https://images2.imgbox.com/29/fb/KuJgj8Um_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="14%09Netty__web_socketDEMO_48"></a>1.4 Netty - 基于web socket简单聊天DEMO实现</h3> 
<p><strong>后端编写</strong></p> 
<p><strong>导入依赖</strong></p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>project xmlns<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0"</span>
         xmlns<span class="token operator">:</span>xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         xsi<span class="token operator">:</span>schemaLocation<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="token operator">&gt;</span>
    <span class="token generics function"><span class="token punctuation">&lt;</span>modelVersion<span class="token punctuation">&gt;</span></span><span class="token number">4.0</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>modelVersion<span class="token operator">&gt;</span>
    <span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>xuwenfei<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>netty_chat<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics function"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.0</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
    <span class="token generics function"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span>
        <span class="token generics function"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>io<span class="token punctuation">.</span>netty<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>netty<span class="token operator">-</span>all<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics function"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">4.1</span><span class="token number">.42</span><span class="token punctuation">.</span>Final<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>project<span class="token operator">&gt;</span>
</code></pre> 
<p><strong>编写Netty Server</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>xuwenfei<span class="token punctuation">.</span>netty_chat<span class="token punctuation">;</span>
<span class="token keyword">import</span> io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>bootstrap<span class="token punctuation">.</span>ServerBootstrap<span class="token punctuation">;</span>
<span class="token keyword">import</span> io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>ChannelFuture<span class="token punctuation">;</span>
<span class="token keyword">import</span> io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>NioEventLoopGroup<span class="token punctuation">;</span>
<span class="token keyword">import</span> io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>NioServerSocketChannel<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketNettyServer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建两个线程池</span>
        NioEventLoopGroup mainGrp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 主线程池</span>
        NioEventLoopGroup subGrp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从线程池</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 创建Netty服务器启动对象</span>
            ServerBootstrap serverBootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 初始化服务器启动对象</span>
            serverBootstrap
                    <span class="token comment">// 指定使用上面创建的两个线程池</span>
                    <span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>mainGrp<span class="token punctuation">,</span> subGrp<span class="token punctuation">)</span>
                    <span class="token comment">// 指定Netty通道类型</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span>NioServerSocketChannel<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token comment">// 指定通道初始化器用来加载当Channel收到事件消息后，</span>
                    <span class="token comment">// 如何进行业务处理</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebSocketChannelInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 绑定服务器端口，以同步的方式启动服务器</span>
            ChannelFuture future <span class="token operator">=</span> serverBootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">9090</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 等待服务器关闭</span>
            future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 优雅关闭服务器</span>
            mainGrp<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            subGrp<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>编写通道初始化器</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketChannelInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics function"><span class="token punctuation">&lt;</span>SocketChannel<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 初始化通道</span>
    <span class="token comment">// 在这个方法中去加载对应的ChannelHandler</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span>SocketChannel ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取管道，将一个一个的ChannelHandler添加到管道中</span>
        ChannelPipeline pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加一个http的编解码器</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpServerCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加一个用于支持大数据流的支持</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChunkedWriteHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加一个聚合器，这个聚合器主要是将HttpMessage聚合成FullHttpRequest/Response</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpObjectAggregator</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 需要指定接收请求的路由</span>
        <span class="token comment">// 必须使用以ws后缀结尾的url才能访问</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebSocketServerProtocolHandler</span><span class="token punctuation">(</span><span class="token string">"/ws"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加自定义的Handler</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>编写处理消息的ChannelHandler</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics function"><span class="token punctuation">&lt;</span>TextWebSocketFrame<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 用来保存所有的客户端连接</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> ChannelGroup clients <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelGroup</span><span class="token punctuation">(</span>GlobalEventExecutor<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> SimpleDateFormat sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-mm-dd hh:MM"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 当Channel中有新的事件消息会自动调用</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> TextWebSocketFrame msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当接收到数据后会自动调用</span>

        <span class="token comment">// 获取客户端发送过来的文本消息</span>
        String text <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到消息数据为："</span> <span class="token operator">+</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>Channel client <span class="token operator">:</span> clients<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 将消息发送到所有的客户端</span>
            client<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextWebSocketFrame</span><span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 当有新的客户端连接服务器之后，会自动调用这个方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerAdded</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将新的通道加入到clients</span>
        clients<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="15%09websocket_173"></a>1.5 websocket以及前端代码编写</h3> 
<p>WebSocket protocol 是HTML5一种新的协议。它实现了浏览器与服务器全双工通信(full-duplex)。一开始的握手需要借HTTP请求完成。Websocket是应用层第七层上的一个应用层协议，它必须依赖 HTTP 协议进行一次握手，握手成功后，数据就直接从 TCP 通道传输，与 HTTP 无关了<br> <strong>前端编写</strong></p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">&gt;</span>
<span class="token generics function"><span class="token punctuation">&lt;</span>head<span class="token punctuation">&gt;</span></span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">&gt;</span>
    <span class="token generics function"><span class="token punctuation">&lt;</span>title<span class="token punctuation">&gt;</span></span>在线聊天室<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token generics function"><span class="token punctuation">&lt;</span>body<span class="token punctuation">&gt;</span></span>
<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"text"</span> id<span class="token operator">=</span><span class="token string">"message"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"button"</span> value<span class="token operator">=</span><span class="token string">"发送消息"</span> onclick<span class="token operator">=</span><span class="token string">"sendMsg()"</span><span class="token operator">&gt;</span>

接收到的消息<span class="token operator">:</span>
<span class="token operator">&lt;</span>p id<span class="token operator">=</span><span class="token string">"server_message"</span> style<span class="token operator">=</span><span class="token string">"background-color: #AAAAAA"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>

<span class="token generics function"><span class="token punctuation">&lt;</span>script<span class="token punctuation">&gt;</span></span>

    var websocket <span class="token operator">=</span> null<span class="token punctuation">;</span>

    <span class="token comment">// 判断当前浏览器是否支持websocket</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>WebSocket<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        websocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">"ws://127.0.0.1:9090/ws"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        websocket<span class="token punctuation">.</span>onopen <span class="token operator">=</span> function <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"建立连接."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        websocket<span class="token punctuation">.</span>onclose <span class="token operator">=</span> function <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"断开连接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        websocket<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> function <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"接收到服务器消息:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            var server_message <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"server_message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            server_message<span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> e<span class="token punctuation">.</span>data <span class="token operator">+</span> <span class="token string">"&lt;br/&gt;"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"当前浏览器不支持web socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    function <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        var message <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> 
<h3><a id="16%09MUIHTML5HBuilder_222"></a>1.6 MUI、HTML5+、HBuilder介绍</h3> 
<p><strong>MUI介绍</strong><br> <a href="http://dev.dcloud.net.cn/mui/" rel="nofollow">官网地址:http://dev.dcloud.net.cn/mui/</a></p> 
<p>MUI是一个轻量级的前端框架。MUI以iOS平台UI为基础，补充部分Android平台特有的UI控件。MUI不依赖任何第三方JS库，压缩后的JS和CSS文件仅有100+K和60+K，可以根据自己的需要，自定义去下载对应的模块。并且MUI编写的前端，可以打包成APK和IPA安装文件，在手机端运行。也就是，编写一套代码，就可以在Android、IOS下运行。</p> 
<p><strong>API地址：</strong></p> 
<p><a href="http://dev.dcloud.net.cn/mui/ui/" rel="nofollow">http://dev.dcloud.net.cn/mui/ui/</a></p> 
<p><strong>H5+</strong><br> H5+提供了对HTML5的增强，提供了40WAPI给程序员使用。使用H5+ API可以轻松开发二维码扫描、摄像头、地图位置、消息推送等功能<br> <img src="https://images2.imgbox.com/04/fd/gLhpj7Ft_o.png" alt="在这里插入图片描述"><br> <strong>API地址：</strong></p> 
<p><a href="http://www.html5plus.org/doc/zh_cn/accelerometer.html#" rel="nofollow">http://www.html5plus.org/doc/zh_cn/accelerometer.html#</a></p> 
<p><strong>HBuilder</strong><br> 前端开发工具。本次项目所有的前端使用HBuilder开发。在项目开发完后，也会使用HBuilder来进行打包<br> Android/IOS的安装包。</p> 
<p><a href="http://www.dcloud.io/" rel="nofollow">http://www.dcloud.io/</a></p> 
<h3><a id="17%09MUI_245"></a>1.7 MUI前端开发</h3> 
<h3><a id="171%09MUI_246"></a>1.7.1 创建项目/页面/添加MUI元素</h3> 
<p><strong>创建MUI移动App项目</strong><br> <img src="https://images2.imgbox.com/93/07/WzlerZ2p_o.png" alt="在这里插入图片描述"><br> <strong>页面创建，添加组件</strong></p> 
<p><a href="http://dev.dcloud.net.cn/mui/ui/#accordion" rel="nofollow">http://dev.dcloud.net.cn/mui/ui/#accordion</a></p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>js/mui.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>css/mui.min.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mui-bar mui-bar-nav<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mui-title<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>登录页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mui-content<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mui-input-group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mui-input-row<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>用户名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mui-input-clear<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>请输入用户名<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zhangsan<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mui-input-row<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>密码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mui-input-password<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>请输入密码<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mui-button-row<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>confirm<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mui-btn mui-btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>确认<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mui-btn mui-btn-danger<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>取消<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="172%09_284"></a>1.7.2 获取页面元素/添加点击事件</h3> 
<p><strong>获取页面元素</strong></p> 
<pre><code class="prism language-html">mui.plusReady(function() {
				// 使用document.getElementById来获取Input组件数据
				var username = document.getElementById("username");
				var password = document.getElementById("password");
				var confirm = document.getElementById("confirm");
				
				// 绑定事件
				confirm.addEventListener("tap", function() {
					alert("按下按钮");
				});
			});

</code></pre> 
<p><strong>批量绑定页面元素的点击事件</strong></p> 
<pre><code class="prism language-html">mui(".mui-table-view").on('tap','.mui-table-view-cell',function(){
});
</code></pre> 
<p><strong>使用原生JS的事件绑定方式</strong></p> 
<pre><code class="prism language-html">// 绑定事件
				confirm.addEventListener("tap", function() {
					alert("按下按钮");
				});

</code></pre> 
<h3><a id="173%09ajax_316"></a>1.7.3 发起ajax请求</h3> 
<p><strong>前端</strong><br> <strong>当我们点击确认按钮的时候，将用户名和密码发送给后端服务器</strong><br> <img src="https://images2.imgbox.com/5d/f3/YHeBnDfd_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-html">// 发送ajax请求
					mui.ajax('http://172.16.1.203:9000/login', {
						data: {
							username: username.value,
							password: password.value
						},
						dataType: 'json', //服务器返回json格式数据
						type: 'post', //HTTP请求类型
						timeout: 10000, //超时时间设置为10秒；
						headers: {
							'Content-Type': 'application/json'
						},
						success: function(data) {
							// 使用JSON.stringify可以将JSON对象转换为String字符串
							console.log(JSON.stringify(data));
							
							var jsonStr = JSON.stringify(data);
							var jsonObj = JSON.parse(jsonStr);
							
							if(data.success) {
								var user =  {
									username: username.value,
									password: password.value
								}
								// 将对象数据放入到缓存中，需要转换为字符串
								plus.storage.setItem("user", JSON.stringify(user));
								
								mui.openWindow({
								    url: 'login_success.html', 
								    id:'login_succss.html'
								  });
							}
							else {
								mui.openWindow({
								    url: 'login_failed.html', 
								    id:'login_failed.html'
								 });
							}
						},
						error: function(xhr, type, errorThrown) {
							//异常处理；
							console.log(type);
						}
</code></pre> 
<p>注：172.16.1.203,此Ip，为统一局域网下的ip,查看方式如下<br> <img src="https://images2.imgbox.com/62/55/d8amD6mf_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ba/a8/4sHMntba_o.png" alt="在这里插入图片描述"><br> <strong>后端</strong><br> <strong>基于SpringBoot编写一个web应用，主要是用于接收ajax请求，响应一些数据到前端</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Map <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> User user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Map map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"tom"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">"123"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"登录成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">"登录失败，请检查用户名和密码是否输入正确"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="174%09JSONJSON_395"></a>1.7.4 字符串转JSON对象以及JSON对象转字符串</h3> 
<p><strong>将JSON对象转换为字符串</strong></p> 
<pre><code class="prism language-html">// 使用JSON.stringify可以将JSON对象转换为String字符串
console.log(JSON.stringify(data));
var jsonStr = JSON.stringify(data);
</code></pre> 
<p><strong>将字符串转换为JSON对象</strong></p> 
<pre><code class="prism language-html">var jsonObj = JSON.parse(jsonStr);
</code></pre> 
<h3><a id="175%09_408"></a>1.7.5 页面跳转</h3> 
<pre><code class="prism language-html">mui.openWindow({
								    url: 'login_success.html', 
								    id:'login_succss.html'
								  });
</code></pre> 
<h3><a id="176%09App_416"></a>1.7.6 App客户端缓存操作</h3> 
<p>大量的App很多时候都需要将服务器端响应的数据缓存到手机App本地。</p> 
<p><a href="http://www.html5plus.org/doc/zh_cn/storage.html" rel="nofollow">http://www.html5plus.org/doc/zh_cn/storage.html</a></p> 
<p>在App中缓存的数据，就是以key-value键值对来存放的。<br> <img src="https://images2.imgbox.com/6a/f2/QdFQy4SR_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-html">
**将数据放入到本地缓存中**

```html
if(data.success) {
								var user =  {
									username: username.value,
									password: password.value
								}
								// 将对象数据放入到缓存中，需要转换为字符串
								plus.storage.setItem("user", JSON.stringify(user));
</code></pre> 
<p><strong>从本地缓存中读取数据</strong></p> 
<pre><code class="prism language-html">// 从storage本地缓存中获取对应的数据
var userStr = plus.storage.getItem("user");

</code></pre> 
<h3><a id="2%09_444"></a>2 构建项目</h3> 
<h3><a id="21%09_445"></a>2.1 项目功能需求、技术架构介绍</h3> 
<p><strong>功能需求</strong><br> 登录/注册<br> 个人信息<br> 搜索添加好友<br> 好友聊天</p> 
<p><strong>技术架构</strong></p> 
<p><strong>前端</strong><br> 开发工具：HBuilder<br> 框架：MUI、H5+<br> <a href="https://pan.baidu.com/s/1M4buI9bjLphfqMdr9KuNYQ" rel="nofollow">下载地址:https://pan.baidu.com/s/1M4buI9bjLphfqMdr9KuNYQ 提取码：XWFN</a><br> <strong>后端</strong><br> 开发工具：IDEA<br> 框架：Spring Boot、MyBatis、Spring MVC、FastDFS、Netty<br> 数据库：mysql</p> 
<h3><a id="22%09_463"></a>2.2 使用模拟器进行测试</h3> 
<p><strong>安装附件中的夜神Android模拟器</strong></p> 
<p><strong>双击桌面图标启动模拟器</strong><br> <img src="https://images2.imgbox.com/20/75/34oajgat_o.png" alt="在这里插入图片描述"><br> <strong>安装后找到模拟器的安装目录</strong><br> <img src="https://images2.imgbox.com/c9/13/TwC5xaWI_o.png" alt="在这里插入图片描述"><br> <strong>到命令行中执行以下命令</strong></p> 
<pre><code class="prism language-java">nox_adb connect <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">62001</span>
nox_adb devices
</code></pre> 
<p><img src="https://images2.imgbox.com/08/7f/hell095s_o.png" alt="在这里插入图片描述"><br> <strong>进入到Hbuilder安装目录下的tools/adbs目录</strong><br> <img src="https://images2.imgbox.com/25/62/oillDIos_o.png" alt="在这里插入图片描述"><br> <strong>切换到命令行中执行以下命令</strong></p> 
<pre><code class="prism language-java">adb connect <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">62001</span>
adb devices
</code></pre> 
<p><img src="https://images2.imgbox.com/84/f5/ZJXQrPZT_o.png" alt="在这里插入图片描述"><br> <strong>打开HBuilder开始调试</strong><br> <img src="https://images2.imgbox.com/66/63/9pRPFVFc_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23%09__HBuilder_490"></a>2.3 前端 - HBuilder前端项目导入</h3> 
<p>从GitHub下载前端包Netty-Mui-Chat.zip解压，并导入到HBuilder中</p> 
<p><img src="https://images2.imgbox.com/7d/7a/u6o18gQe_o.png" alt="在这里插入图片描述"></p> 
<p><a href="https://github.com/wenfei-alibaba/Netty-public.git">下载地址：https://github.com/wenfei-alibaba/Netty-public.git</a></p> 
<h3><a id="24%09__SpringBootMyBatis_499"></a>2.4 后端 - 导入数据库/SpringBoot项目/MyBatis逆向工程</h3> 
<p><strong>从GitHub下载hchat.sql脚本在开发工具中执行</strong><br> <img src="https://images2.imgbox.com/de/d7/gYzgKiKL_o.png" alt="在这里插入图片描述"></p> 
<p><a href="https://github.com/wenfei-alibaba/Netty-public.git">下载地址：https://github.com/wenfei-alibaba/Netty-public.git</a></p> 
<p><strong>数据库表结构介绍</strong><br> tb_user用户表<br> <img src="https://images2.imgbox.com/1b/3e/eO5gpyQ3_o.png" alt="在这里插入图片描述"><br> tb_friend朋友表<br> <img src="https://images2.imgbox.com/6b/a9/wEvbrTsv_o.png" alt="在这里插入图片描述"><br> tb_friend_req申请好友表<br> <img src="https://images2.imgbox.com/83/1b/dDFOe5nC_o.png" alt="在这里插入图片描述"><br> tb_friend_req申请好友表 <br> <img src="https://images2.imgbox.com/de/e2/RXLvCnck_o.png" alt="在这里插入图片描述"><br> tb_chat_record聊天记录表<br> <img src="https://images2.imgbox.com/9f/64/eeg7M3Lf_o.png" alt="在这里插入图片描述"><br> <strong>使用MyBatis逆向工程生成代码</strong><br> 从GitHub下载generatorSqlmapCustom.zip解压导入到IDEA中，并配置项目所使用的JDK<br> <img src="https://images2.imgbox.com/9d/7e/YIVSBJi4_o.png" alt="在这里插入图片描述"></p> 
<p><a href="https://github.com/wenfei-alibaba/Netty-public.git">下载地址：https://github.com/wenfei-alibaba/Netty-public.git</a></p> 
<p><strong>创建Spring Boot项目</strong></p> 
<p>从GitHub下载application.properties配置文件以及pom.xml</p> 
<p><img src="https://images2.imgbox.com/1c/58/CsoyxqKN_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="25%09__Spring_BootNetty_529"></a>2.5 后端 - Spring Boot整合Netty搭建后台</h3> 
<p><strong>spring boot整合Netty</strong><br> 从GitHub下载spring-netty.zip，然后将java文件导入到项目中<br> <img src="https://images2.imgbox.com/97/a8/6zno5glz_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6c/86/Vjcu962e_o.png" alt="在这里插入图片描述"><br> <strong>启动Spring Boot，导入HTML页面,使用浏览器打开测试Netty是否整合成功</strong></p> 
<h3><a id="3%09___535"></a>3 业务开发 - 用户注册/登录/个人信息</h3> 
<h3><a id="31%09__536"></a>3.1 用户登录功能 -后端开发</h3> 
<p>从GitHub下载Util.zip，解压后将雪花算法ID生成器，IdWorker.java文件导入到项目中</p> 
<p><a href="https://github.com/wenfei-alibaba/Netty-public.git">下载地址：https://github.com/wenfei-alibaba/Netty-public.git</a></p> 
<p><img src="https://images2.imgbox.com/25/9b/PctL0ALz_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/a1/e4/KIsD9SoZ_o.png" alt="在这里插入图片描述"></p> 
<p>初始化IdWorker</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.xuwenfei.hchat.mapper"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Application<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> IdWorker <span class="token function">idWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IdWorker</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>创建Result实体类</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 将返回给客户端的数据封装到实体类中
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Result</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> success<span class="token punctuation">;</span> <span class="token comment">// 是否操作成功</span>
    <span class="token keyword">private</span> String message<span class="token punctuation">;</span> <span class="token comment">// 返回消息</span>
    <span class="token keyword">private</span> Object result<span class="token punctuation">;</span> <span class="token comment">// 返回附件的对象</span>

    <span class="token keyword">public</span> <span class="token function">Result</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> success<span class="token punctuation">,</span> String message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>success <span class="token operator">=</span> success<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Result</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> success<span class="token punctuation">,</span> String message<span class="token punctuation">,</span> Object result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>success <span class="token operator">=</span> success<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>result <span class="token operator">=</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> success<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> success<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>success <span class="token operator">=</span> success<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMessage</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Object <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setResult</span><span class="token punctuation">(</span>Object result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>result <span class="token operator">=</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>创建返回给客户端的User实体类</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 用来返回给客户端
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> String id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String picSmall<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String picNormal<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String nickname<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String qrcode<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String clientId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String sign<span class="token punctuation">;</span>
    <span class="token keyword">private</span> Date createtime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String phone<span class="token punctuation">;</span>

    <span class="token keyword">public</span> String <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> username<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUsername</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getPicSmall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> picSmall<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPicSmall</span><span class="token punctuation">(</span>String picSmall<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>picSmall <span class="token operator">=</span> picSmall<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getPicNormal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> picNormal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPicNormal</span><span class="token punctuation">(</span>String picNormal<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>picNormal <span class="token operator">=</span> picNormal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> nickname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNickname</span><span class="token punctuation">(</span>String nickname<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nickname <span class="token operator">=</span> nickname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getQrcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> qrcode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setQrcode</span><span class="token punctuation">(</span>String qrcode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>qrcode <span class="token operator">=</span> qrcode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> clientId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setClientId</span><span class="token punctuation">(</span>String clientId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clientId <span class="token operator">=</span> clientId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> sign<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSign</span><span class="token punctuation">(</span>String sign<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sign <span class="token operator">=</span> sign<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Date <span class="token function">getCreatetime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> createtime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCreatetime</span><span class="token punctuation">(</span>Date createtime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>createtime <span class="token operator">=</span> createtime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> phone<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPhone</span><span class="token punctuation">(</span>String phone<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>phone <span class="token operator">=</span> phone<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"User{"</span> <span class="token operator">+</span>
                <span class="token string">"username='"</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", picSmall='"</span> <span class="token operator">+</span> picSmall <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", picNormal='"</span> <span class="token operator">+</span> picNormal <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>UserController实现</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/findAll"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>TbUser<span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> TbUser user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            User _user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>_user <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"登录失败，将检查用户名或者密码是否正确"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"登录成功"</span><span class="token punctuation">,</span> _user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"登录错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result <span class="token function">register</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> TbUser user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果注册成功，不抛出抛出异常，如果注册失败抛出异常</span>
            userService<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"注册成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/upload"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result <span class="token function">upload</span><span class="token punctuation">(</span>MultipartFile file<span class="token punctuation">,</span> String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            User user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> userid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"上传成功"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"上传失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"上传失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/updateNickname"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result <span class="token function">updateNickname</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> TbUser user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            userService<span class="token punctuation">.</span><span class="token function">updateNickname</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"更新成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"更新失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/findById"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> User <span class="token function">findById</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/findByUsername"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result <span class="token function">findByUsername</span><span class="token punctuation">(</span>String userid<span class="token punctuation">,</span> String friendUsername<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            User user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span>userid<span class="token punctuation">,</span> friendUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"搜索成功"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"没有找到该用户"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"搜索失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>UserService接口定义</strong></p> 
<pre><code class="prism language-java"> <span class="token comment">/**
     * 用来登录检查，检查用户名和密码是否匹配
     * @param username 用户名
     * @param password 密码
     * @return 如果登录成功返回用户对象，否则返回null
     */</span>
    User <span class="token function">login</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span> String password<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>编写UserServiceImpl实现</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> User <span class="token function">login</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span> String password<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            TbUserExample example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TbUserExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            TbUserExample<span class="token punctuation">.</span>Criteria criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            criteria<span class="token punctuation">.</span><span class="token function">andUsernameEqualTo</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>

            List<span class="token generics function"><span class="token punctuation">&lt;</span>TbUser<span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>userList <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> userList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 对密码进行校验</span>
                String encodingPassword <span class="token operator">=</span> DigestUtils<span class="token punctuation">.</span><span class="token function">md5DigestAsHex</span><span class="token punctuation">(</span>password<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>encodingPassword<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    BeanUtils<span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>userList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="32%09___856"></a>3.2 用户登录功能 - 前端&amp;测试</h3> 
<h3><a id="33%09___857"></a>3.3 注册功能 - 后端</h3> 
<p><strong>UserController</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result <span class="token function">register</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> TbUser user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果注册成功，不抛出抛出异常，如果注册失败抛出异常</span>
            userService<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"注册成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>UserService接口</strong></p> 
<pre><code class="prism language-java"> <span class="token comment">/**
     * 注册用户，将用户信息保存到数据库中
     * 如果抛出异常则，注册失败，否则，注册成功
     * @param user 用户信息
     */</span>
    <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span>TbUser user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>UserServiceImpl实现</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span>TbUser user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 1. 判断这个用户名是否存在</span>
            TbUserExample example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TbUserExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            TbUserExample<span class="token punctuation">.</span>Criteria criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            criteria<span class="token punctuation">.</span><span class="token function">andUsernameEqualTo</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            List<span class="token generics function"><span class="token punctuation">&lt;</span>TbUser<span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>userList <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> userList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"用户已存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 2. 将用户信息保存到数据库中</span>
            <span class="token comment">// 使用雪花算法来生成唯一ID</span>
            user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 对密码进行MD5加密</span>
            user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>DigestUtils<span class="token punctuation">.</span><span class="token function">md5DigestAsHex</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setPicSmall</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setPicNormal</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 生成二维码，并且将二维码的路径保存到数据库中</span>
            <span class="token comment">// 要生成二维码中的字符串</span>
            String qrcodeStr <span class="token operator">=</span> <span class="token string">"hichat://"</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取一个临时目录，用来保存临时的二维码图片</span>
            String tempDir <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"hcat.tmpdir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String qrCodeFilePath <span class="token operator">=</span> tempDir <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".png"</span><span class="token punctuation">;</span>
            qrCodeUtils<span class="token punctuation">.</span><span class="token function">createQRCode</span><span class="token punctuation">(</span>qrCodeFilePath<span class="token punctuation">,</span> qrcodeStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 将临时保存的二维码上传到FastDFS</span>
            String url <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"fdfs.httpurl"</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                    fastDFSClient<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>qrCodeFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            user<span class="token punctuation">.</span><span class="token function">setQrcode</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setCreatetime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"注册失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="34%09___931"></a>3.4 注册功能 - 前端&amp;测试</h3> 
<h3><a id="35%09FASTDFS___932"></a>3.5 FASTDFS - 文件服务器介绍与搭建</h3> 
<p><strong>什么是FastDFS</strong><br> FastDFS 是用 c 语言编写的一款开源的分布式文件系统。FastDFS 为互联网量身定制，充分考虑了冗余备份、负载均衡、线性扩容等机制，并注重高可用、高性能等指标，使用 FastDFS很容易搭建一套高性能的文件服务器集群提供文件上传、下载等服务。<br> FastDFS 架构包括 Tracker server 和 Storage server。客户端请求 Tracker server 进行文件上传、下载，通过 Tracker server 调度最终由 Storage server 完成文件上传和下载。<br> Tracker server 作用是负载均衡和调度，通过 Tracker server 在文件上传时可以根据一些策略找到 Storage server 提供文件上传服务。可以将 tracker 称为追踪服务器或调度服务器。<br> Storage server 作用是文件存储，客户端上传的文件最终存储在 Storage 服务器上，Storageserver 没有实现自己的文件系统而是利用操作系统 的文件系统来管理文件。可以将storage称为存储服务器。<br> <img src="https://images2.imgbox.com/5d/99/UfpgiXpk_o.png" alt="在这里插入图片描述"><br> <strong>服务端两个角色：</strong><br> Tracker：管理集群，tracker 也可以实现集群。每个 tracker 节点地位平等。收集 Storage 集群的状态。<br> Storage：实际保存文件 Storage 分为多个组，每个组之间保存的文件是不同的。每个组内部可以有多个成员，组成员内部保存的内容是一样的，组成员的地位是一致的，没有主从的概念。</p> 
<p><strong>在Linux中搭建FastDFS</strong></p> 
<p><a href="https://pan.baidu.com/s/1JPjB5dxVDUyM-QXbjc1v_Q" rel="nofollow">下载地址：https://pan.baidu.com/s/1JPjB5dxVDUyM-QXbjc1v_Q 提取码：XWFN</a></p> 
<p>解压缩fastdfs-image-server.zip<br> 双击vmx文件，然后启动。<br> 注意：遇到下列提示选择“我已移动该虚拟机”！<br> <img src="https://images2.imgbox.com/ed/f4/eF4MthJh_o.png" alt="在这里插入图片描述"><br> IP地址已经固定为192.168.25.133 ，请设置你的仅主机网段为25。<br> 登录名为root 密码为itcast</p> 
<h3><a id="36%09FASTDFS__Spring_Boot_953"></a>3.6 FASTDFS - 整合Spring Boot</h3> 
<p>导入从github上下载的ComponetImport.java工具类<br> 导入从github上下载的FastDFSClient.java、FileUtils.java工具类</p> 
<h3><a id="37%09___957"></a>3.7 个人信息 - 后端照片上传功能开发</h3> 
<p><strong>注入FastDFS相关Bean</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> Environment env<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> FastDFSClient fastDFSClient<span class="token punctuation">;</span>

</code></pre> 
<p><strong>编写UserService</strong><br> 将新上传的图片保存到用户信息数据库中</p> 
<pre><code class="prism language-java"> <span class="token comment">/**
     * 上传头像
     * @param file 客户端上传的文件
     * @param userid 用户id
     * @return 如果上传成功，返回用户信息。否则返回null
     */</span>
    User <span class="token function">upload</span><span class="token punctuation">(</span>MultipartFile file<span class="token punctuation">,</span> String userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>编写UserServiceImpl</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> User <span class="token function">upload</span><span class="token punctuation">(</span>MultipartFile file<span class="token punctuation">,</span> String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回在FastDFS中的URL路径，这个路径是不带http://192.168.25.133/..</span>
            String url <span class="token operator">=</span> fastDFSClient<span class="token punctuation">.</span><span class="token function">uploadFace</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 在FastDFS上传的时候，会自动生成一个缩略图</span>
            <span class="token comment">// 文件名_150x150.后缀</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> fileNameList <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String fileName <span class="token operator">=</span> fileNameList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            String ext <span class="token operator">=</span> fileNameList<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            String picSmallUrl <span class="token operator">=</span> fileName <span class="token operator">+</span> <span class="token string">"_150x150."</span> <span class="token operator">+</span> ext<span class="token punctuation">;</span>

            String prefix <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"fdfs.httpurl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            TbUser tbUser <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 设置头像大图片</span>
            tbUser<span class="token punctuation">.</span><span class="token function">setPicNormal</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置头像小图片</span>
            tbUser<span class="token punctuation">.</span><span class="token function">setPicSmall</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> picSmallUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将新的头像URL更新到数据库中</span>
            userMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKey</span><span class="token punctuation">(</span>tbUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 将用户信息返回到Controller</span>
            User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            BeanUtils<span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>tbUser<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> user<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="38%09___1016"></a>3.8 个人信息 - 前端&amp;测试头像上传</h3> 
<p><img src="https://images2.imgbox.com/9b/ea/o2Wz04il_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8a/96/dZjRpYnC_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="39%09___1019"></a>3.9 个人信息 - 修改昵称后端实现</h3> 
<p><strong>编写UserController</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/updateNickname"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result <span class="token function">updateNickname</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> TbUser user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            userService<span class="token punctuation">.</span><span class="token function">updateNickname</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"更新成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"更新失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>UserSevice接口</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 更新昵称
     * @param id 用户的id
     * @param nickname 昵称
     */</span>
    <span class="token keyword">void</span> <span class="token function">updateNickname</span><span class="token punctuation">(</span>String id<span class="token punctuation">,</span> String nickname<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>UserServiceImpl实现</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateNickname</span><span class="token punctuation">(</span>String id<span class="token punctuation">,</span> String nickname<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>nickname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            TbUser tbUser <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tbUser<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>nickname<span class="token punctuation">)</span><span class="token punctuation">;</span>
            userMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKey</span><span class="token punctuation">(</span>tbUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"昵称不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="310%09__1063"></a>3.10 个人信息 -重新加载用户信息后端实现</h3> 
<p><strong>Controller</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/findById"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> User <span class="token function">findById</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>UserService</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 根据用户id查找用户信息
     * @param userid 用户id
     * @return 用户对象
     */</span>
    User <span class="token function">findById</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p><strong>UserServiceImpl</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> User <span class="token function">findById</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        TbUser tbUser <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BeanUtils<span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>tbUser<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="311%09___1095"></a>3.11 个人信息 - 修改昵称前端测试</h3> 
<p><img src="https://images2.imgbox.com/07/0a/V0g3pSCq_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/eb/60/KsXKvPN8_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="312%09___1100"></a>3.12 个人信息 - 二维码生成后端编写</h3> 
<p>二维码是在用户注册的时候，就根据用户的用户名来自动生成一个二维码图片，并且保存到FastDFS中。<br> 需要对注册的方法进行改造，在注册用户时，编写逻辑保存二维码。并将二维码图片的链接保存到数据库中。<br> <strong>二维码前端页面展示</strong><br> <img src="https://images2.imgbox.com/d1/84/NRq1zBo0_o.png" alt="在这里插入图片描述"><br> 导入二维码生成工具类<br> 导入QRCodeUtils.java文件</p> 
<p><strong>UserServiceImpl</strong><br> 修改注册方法，在注册时，将使用二维码生成工具将二维码保存到FastDFS，并保存链接更新数据库</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span>TbUser user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 查询用户是否存在</span>
    TbUserExample example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TbUserExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    TbUserExample<span class="token punctuation">.</span>Criteria criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    criteria<span class="token punctuation">.</span><span class="token function">andUsernameEqualTo</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    List<span class="token generics function"><span class="token punctuation">&lt;</span>TbUser<span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.1 如果存在抛出异常</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>userList <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> userList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"用户名已经存在!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// MD5加密保存</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>DigestUtils<span class="token punctuation">.</span><span class="token function">md5DigestAsHex</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPicSmall</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPicNormal</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取临时目录</span>
        String tmpFolder <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"hcat.tmpdir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String qrCodeFile <span class="token operator">=</span> tmpFolder <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".png"</span><span class="token punctuation">;</span>
        qrCodeUtils<span class="token punctuation">.</span><span class="token function">createQRCode</span><span class="token punctuation">(</span>qrCodeFile<span class="token punctuation">,</span> <span class="token string">"user_code:"</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            String url <span class="token operator">=</span> fastDFSClient<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>qrCodeFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setQrcode</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"上传文件失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        user<span class="token punctuation">.</span><span class="token function">setCreatetime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="313%09___1150"></a>3.13 个人信息 - 二维码生成前端测试</h3> 
<h3><a id="4%09___1151"></a>4 业务开发 - 发现页面与通信录</h3> 
<h3><a id="41%09___1152"></a>4.1 搜索朋友 - 后端开发</h3> 
<p><strong>在搜索朋友的时候需要进行以下判断：</strong></p> 
<ol><li>不能添加自己为好友</li><li>如果搜索的用户已经是好友了，就不能再添加了</li><li>如果已经申请过好友并且好友并没有处理这个请求了，也不能再申请。</li></ol> 
<p><strong>前端页面展示</strong><br> <img src="https://images2.imgbox.com/03/5f/Olwd1teI_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/04/a4/7QdajTAm_o.png" alt="在这里插入图片描述"><br> <strong>搜索朋友其实就是用户搜索，所以我们只需要根据用户名将对应的用户搜索出来即可</strong></p> 
<p><strong>编写UserController</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/findByUsername"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result <span class="token function">findByUsername</span><span class="token punctuation">(</span>String userid<span class="token punctuation">,</span> String friendUsername<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            User user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span>userid<span class="token punctuation">,</span> friendUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"搜索成功"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"没有找到该用户"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"搜索失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>编写UserService接口</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 根据用户名搜索用户（好友搜索）
     * 在搜索用户的时候不需要进行校验
     * @param userid 用户id
     * @param friendUsername 好友的用户名
     * @return 如果搜索到好友，就返回用户对象，否则返回null
     */</span>
    User <span class="token function">findByUsername</span><span class="token punctuation">(</span>String userid<span class="token punctuation">,</span> String friendUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>编写UserServiceImpl实现</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> User <span class="token function">findByUsername</span><span class="token punctuation">(</span>String userid<span class="token punctuation">,</span> String friendUsername<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        TbUserExample example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TbUserExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TbUserExample<span class="token punctuation">.</span>Criteria criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        criteria<span class="token punctuation">.</span><span class="token function">andUsernameEqualTo</span><span class="token punctuation">(</span>friendUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>

        List<span class="token generics function"><span class="token punctuation">&lt;</span>TbUser<span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span>
        TbUser friend <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        User friendUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BeanUtils<span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>friend<span class="token punctuation">,</span> friendUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> friendUser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="42%09___1215"></a>4.2 搜索朋友 - 前端测试联调</h3> 
<h3><a id="43%09___1216"></a>4.3 添加好友 - 发送好友请求后端开发</h3> 
<p><strong>编写FriendController</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"sendRequest"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> TbFriendReq friendReq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            friendService<span class="token punctuation">.</span><span class="token function">sendRequest</span><span class="token punctuation">(</span>friendReq<span class="token punctuation">.</span><span class="token function">getFromUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> friendReq<span class="token punctuation">.</span><span class="token function">getToUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"已申请"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span>RuntimeException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"申请好友失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>编写FriendService</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 发送好友请求
     * @param fromUserid 申请好友的用户id
     * @param toUserid 要添加的好友id
     */</span>
    <span class="token keyword">void</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span>String fromUserid<span class="token punctuation">,</span> String toUserid<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>编写FriendServiceImpl实现</strong></p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span>String fromUserid<span class="token punctuation">,</span> String toUserid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 检查是否允许添加好友</span>
        TbUser friend <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>toUserid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">checkAllowToAddFriend</span><span class="token punctuation">(</span>fromUserid<span class="token punctuation">,</span> friend<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加好友请求</span>
        TbFriendReq friendReq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TbFriendReq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        friendReq<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        friendReq<span class="token punctuation">.</span><span class="token function">setFromUserid</span><span class="token punctuation">(</span>fromUserid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        friendReq<span class="token punctuation">.</span><span class="token function">setToUserid</span><span class="token punctuation">(</span>toUserid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        friendReq<span class="token punctuation">.</span><span class="token function">setCreatetime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        friendReq<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        friendReqMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>friendReq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="44%09__1266"></a>4.4 添加好友 -前端测试</h3> 
<h3><a id="45%09__1267"></a>4.5 展示好友请求 -后端开发</h3> 
<p><strong>前端页面展示</strong><br> <img src="https://images2.imgbox.com/71/fb/pkao3QPk_o.png" alt="在这里插入图片描述"><br> <strong>编写Controller</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/findFriendReqByUserid"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>FriendReq<span class="token punctuation">&gt;</span></span> <span class="token function">findFriendReqByUserid</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> friendService<span class="token punctuation">.</span><span class="token function">findFriendReqByUserid</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>编写FriendService</strong></p> 
<pre><code class="prism language-java"> <span class="token comment">/**
     * 根据用户ID查询他对应的好友请求
     * @param userid 当前登录的用户
     * @return 请求好友的用户列表
     */</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>FriendReq<span class="token punctuation">&gt;</span></span> <span class="token function">findFriendReqByUserid</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>编写FriendServiceImpl实现</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>FriendReq<span class="token punctuation">&gt;</span></span> <span class="token function">findFriendReqByUserid</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 根据用户的id查询对应的好友请求</span>
        TbFriendReqExample example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TbFriendReqExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TbFriendReqExample<span class="token punctuation">.</span>Criteria criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        criteria<span class="token punctuation">.</span><span class="token function">andToUseridEqualTo</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        criteria<span class="token punctuation">.</span><span class="token function">andStatusEqualTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        List<span class="token generics function"><span class="token punctuation">&lt;</span>TbFriendReq<span class="token punctuation">&gt;</span></span> tbFriendReqList <span class="token operator">=</span> friendReqMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>FriendReq<span class="token punctuation">&gt;</span></span> friendReqList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>FriendReq<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据好友请求，将发起好友请求的用户信息返回</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>TbFriendReq tbFriendReq <span class="token operator">:</span> tbFriendReqList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            TbUser tbUser <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>tbFriendReq<span class="token punctuation">.</span><span class="token function">getFromUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            FriendReq friendReq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FriendReq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            BeanUtils<span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>tbUser<span class="token punctuation">,</span> friendReq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置好友请求的id</span>
            friendReq<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>tbFriendReq<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            friendReqList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>friendReq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> friendReqList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="46%09___1318"></a>4.6 展示好友请求 - 前端测试</h3> 
<h3><a id="47%09___1319"></a>4.7 添加好友 - 接受好友请求后端开发</h3> 
<p>添加好友需要双方互相添加。<br> 例如：A接受B的好友申请，则将A成为B的好友，同时B也成为A的好友。<br> <strong>编写FriendController</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/acceptFriendReq"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result <span class="token function">acceptFriendReq</span><span class="token punctuation">(</span>String reqid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            friendService<span class="token punctuation">.</span><span class="token function">acceptFriendReq</span><span class="token punctuation">(</span>reqid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"添加好友成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"添加好友失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>编写FriendService</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 接收好友请求
     * @param reqid 好友请求的id
     */</span>
    <span class="token keyword">void</span> <span class="token function">acceptFriendReq</span><span class="token punctuation">(</span>String reqid<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>编写FriendServiceImpl</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">acceptFriendReq</span><span class="token punctuation">(</span>String reqid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>reqid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 将好友请求的status标志设置为1，表示已经处理了该好友请求</span>
        TbFriendReq friendReq <span class="token operator">=</span> friendReqMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>reqid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        friendReq<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        friendReqMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKey</span><span class="token punctuation">(</span>friendReq<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 互相添加好友，在tb_friend表中应该添加两条记录</span>
        TbFriend friend1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TbFriend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        friend1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        friend1<span class="token punctuation">.</span><span class="token function">setUserid</span><span class="token punctuation">(</span>friendReq<span class="token punctuation">.</span><span class="token function">getFromUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        friend1<span class="token punctuation">.</span><span class="token function">setFriendsId</span><span class="token punctuation">(</span>friendReq<span class="token punctuation">.</span><span class="token function">getToUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        friend1<span class="token punctuation">.</span><span class="token function">setCreatetime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        TbFriend friend2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TbFriend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        friend2<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        friend2<span class="token punctuation">.</span><span class="token function">setUserid</span><span class="token punctuation">(</span>friendReq<span class="token punctuation">.</span><span class="token function">getToUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        friend2<span class="token punctuation">.</span><span class="token function">setFriendsId</span><span class="token punctuation">(</span>friendReq<span class="token punctuation">.</span><span class="token function">getFromUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        friend2<span class="token punctuation">.</span><span class="token function">setCreatetime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        friendMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>friend1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        friendMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>friend2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="48%09__1373"></a>4.8 添加好友 -拒绝添加好友后端开发</h3> 
<p>在用户选择忽略好友请求时，我们只需要将之前的好友请求状态（status）设置为1。无需添加好友。</p> 
<p><strong>编写FriendController</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/ignoreFriendReq"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result <span class="token function">ignoreFriendReq</span><span class="token punctuation">(</span>String reqid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            friendService<span class="token punctuation">.</span><span class="token function">ignoreFriendReq</span><span class="token punctuation">(</span>reqid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"忽略好友请求成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"忽略好友请求失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>编写FriendService接口</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 忽略好友请求
     * @param reqid 好友请求的id
     */</span>
    <span class="token keyword">void</span> <span class="token function">ignoreFriendReq</span><span class="token punctuation">(</span>String reqid<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>编写FriendServiceImpl实现</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ignoreFriendReq</span><span class="token punctuation">(</span>String reqid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        TbFriendReq tbFriendReq <span class="token operator">=</span> friendReqMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>reqid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tbFriendReq<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        friendReqMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKey</span><span class="token punctuation">(</span>tbFriendReq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="49%09___1410"></a>4.9 通信录功能 - 后端</h3> 
<p>通信录功能就是要根据当前登录用户的id，获取到用户的好友列表。<br> <strong>前端页面效果</strong><br> <img src="https://images2.imgbox.com/99/92/m1DKYLoT_o.png" alt="在这里插入图片描述"><br> <strong>编写FriendController</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/findFriendByUserid"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">findFriendByUserid</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> friendService<span class="token punctuation">.</span><span class="token function">findFriendByUserid</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>编写FriendService</strong></p> 
<pre><code class="prism language-java"> <span class="token comment">/**
     * 查询我的好友
     * @param userid 当前登录的用户id
     * @return 好友列表
     */</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">findFriendByUserid</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>编写FriendServiceImpl</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">findFriendByUserid</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 根据userid查询tb_friend表中的数据</span>
        TbFriendExample friendExample <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TbFriendExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TbFriendExample<span class="token punctuation">.</span>Criteria criteria <span class="token operator">=</span> friendExample<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        criteria<span class="token punctuation">.</span><span class="token function">andUseridEqualTo</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        List<span class="token generics function"><span class="token punctuation">&lt;</span>TbFriend<span class="token punctuation">&gt;</span></span> tbFriendList <span class="token operator">=</span> friendMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>friendExample<span class="token punctuation">)</span><span class="token punctuation">;</span>

        List<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> friendList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历好友列表，将好友的用户信息查询出来</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>TbFriend tbFriend <span class="token operator">:</span> tbFriendList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 根据好友的id将他对应的用户信息查询出来</span>
            TbUser tbUser <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>tbFriend<span class="token punctuation">.</span><span class="token function">getFriendsId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            User friend <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            BeanUtils<span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>tbUser<span class="token punctuation">,</span> friend<span class="token punctuation">)</span><span class="token punctuation">;</span>

            friendList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>friend<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> friendList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5%09___1465"></a>5 业务开发 - 聊天业务</h3> 
<h3><a id="51%09__idNetty_1466"></a>5.1 聊天业务 - 用户id关联Netty通道后端开发</h3> 
<p><img src="https://images2.imgbox.com/f6/5b/w5ezJ62A_o.png" alt="在这里插入图片描述"><br> <strong>要使用netty来进行两个客户端之间的通信，需要提前建立好用户id与Netty通道的关联。服务器端需要对消息进行保存。<br> 每一个App客户端登录的时候，就需要建立用户id与通道的关联。</strong></p> 
<p><strong>导入SpringUtil工具类<br> 此工具类主要用来在普通Java类中获取Spring容器中的bean</strong></p> 
<p><strong>定义消息实体类</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> Integer type<span class="token punctuation">;</span> <span class="token comment">// 消息类型</span>
    <span class="token keyword">private</span> TbChatRecord chatRecord<span class="token punctuation">;</span>    <span class="token comment">// 聊天消息</span>
    <span class="token keyword">private</span> Object ext<span class="token punctuation">;</span>  <span class="token comment">// 扩展消息字段</span>

    <span class="token keyword">public</span> Integer <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setType</span><span class="token punctuation">(</span>Integer type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> TbChatRecord <span class="token function">getChatRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> chatRecord<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChatRecord</span><span class="token punctuation">(</span>TbChatRecord chatRecord<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatRecord <span class="token operator">=</span> chatRecord<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Object <span class="token function">getExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> ext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setExt</span><span class="token punctuation">(</span>Object ext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ext <span class="token operator">=</span> ext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>定义UserChannelMap用来保存用户id与Channel通道关联</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserChannelMap</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> HashMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Channel<span class="token punctuation">&gt;</span></span> userChannelMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span>String userid<span class="token punctuation">,</span> Channel channel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        userChannelMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userid<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Channel <span class="token function">get</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userChannelMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>编写ChatHandller</strong><br> 用户在第一次登陆到手机App时，会自动发送一个type为0的消息，此时，需要建立用户与Channel通道的关联。后续，将会根据userid获取到Channel，给用户推送消息。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 处理消息的handler
 * TextWebSocketFrame: 在netty中，是用于为websocket专门处理文本的对象，frame是消息的载体
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics function"><span class="token punctuation">&lt;</span>TextWebSocketFrame<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 用来保存所有的客户端连接</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> ChannelGroup clients <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelGroup</span><span class="token punctuation">(</span>GlobalEventExecutor<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> SimpleDateFormat sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-mm-dd hh:MM"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 当Channel中有新的事件消息会自动调用</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> TextWebSocketFrame msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当接收到数据后会自动调用</span>

        <span class="token comment">// 获取客户端发送过来的文本消息</span>
        String text <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到消息数据为："</span> <span class="token operator">+</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Message message <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> Message<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 通过SpringUtil工具类获取Spring上下文容器</span>
        ChatRecordService chatRecordService <span class="token operator">=</span> SpringUtil<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ChatRecordService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 处理客户端连接的消息</span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token comment">// 建立用户与通道的关联</span>
                String userid <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getChatRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                UserChannelMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userid<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"建立用户:"</span> <span class="token operator">+</span> userid <span class="token operator">+</span> <span class="token string">"与通道"</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"的关联"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                UserChannelMap<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理客户端发送好友消息</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到用户消息"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将聊天消息保存到数据库</span>
                TbChatRecord chatRecord <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getChatRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                chatRecordService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>chatRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 如果发送消息好友在线，可以直接将消息发送给好友</span>
                Channel channel <span class="token operator">=</span> UserChannelMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>chatRecord<span class="token punctuation">.</span><span class="token function">getFriendid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>channel <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextWebSocketFrame</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 如果不在线，暂时不发送</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户"</span> <span class="token operator">+</span> chatRecord<span class="token punctuation">.</span><span class="token function">getFriendid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"不在线"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理客户端的签收消息</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                <span class="token comment">// 将消息记录设置为已读</span>
                chatRecordService<span class="token punctuation">.</span><span class="token function">updateStatusHasRead</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getChatRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
                <span class="token comment">// 接收心跳消息</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到心跳消息:"</span> <span class="token operator">+</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token comment">// 当有新的客户端连接服务器之后，会自动调用这个方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerAdded</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将新的通道加入到clients</span>
        clients<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> Throwable cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        UserChannelMap<span class="token punctuation">.</span><span class="token function">removeByChannelId</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asLongText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerRemoved</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"关闭通道"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        UserChannelMap<span class="token punctuation">.</span><span class="token function">removeByChannelId</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asLongText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        UserChannelMap<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="52%09___1610"></a>5.2 聊天业务 - 用户断开连接、连接异常取消关联通道</h3> 
<p><strong>服务器端应该根据通道的ID，来取消用户id与通道的关联关系。</strong><br> <strong>UserChannelMap类</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 根据通道id移除用户与channel的关联
     * @param channelId 通道的id
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">removeByChannelId</span><span class="token punctuation">(</span>String channelId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>channelId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>String s <span class="token operator">:</span> userChannelMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Channel channel <span class="token operator">=</span> userChannelMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>channelId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asLongText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户端连接断开,取消用户"</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">"与通道"</span> <span class="token operator">+</span> channelId <span class="token operator">+</span> <span class="token string">"的关联"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                userChannelMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>ChatHandler类</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> Throwable cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        UserChannelMap<span class="token punctuation">.</span><span class="token function">removeByChannelId</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asLongText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerRemoved</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"关闭通道"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        UserChannelMap<span class="token punctuation">.</span><span class="token function">removeByChannelId</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asLongText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        UserChannelMap<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="53%09___1650"></a>5.3 聊天业务 - 发送聊天消息后端开发</h3> 
<p>将消息发送到好友对应的Channel通道，并将消息记录保存到数据库中</p> 
<p>编写ChatHandler</p> 
<p>获取ChatRecordService服务</p> 
<pre><code class="prism language-java"><span class="token comment">// 通过SpringUtil工具类获取Spring上下文容器</span>
        ChatRecordService chatRecordService <span class="token operator">=</span> SpringUtil<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ChatRecordService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 处理客户端连接的消息</span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token comment">// 建立用户与通道的关联</span>
                String userid <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getChatRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                UserChannelMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userid<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"建立用户:"</span> <span class="token operator">+</span> userid <span class="token operator">+</span> <span class="token string">"与通道"</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"的关联"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                UserChannelMap<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理客户端发送好友消息</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到用户消息"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将聊天消息保存到数据库</span>
                TbChatRecord chatRecord <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getChatRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                chatRecordService<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>chatRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 如果发送消息好友在线，可以直接将消息发送给好友</span>
                Channel channel <span class="token operator">=</span> UserChannelMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>chatRecord<span class="token punctuation">.</span><span class="token function">getFriendid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>channel <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextWebSocketFrame</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 如果不在线，暂时不发送</span>
                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户"</span> <span class="token operator">+</span> chatRecord<span class="token punctuation">.</span><span class="token function">getFriendid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"不在线"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理客户端的签收消息</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                <span class="token comment">// 将消息记录设置为已读</span>
                chatRecordService<span class="token punctuation">.</span><span class="token function">updateStatusHasRead</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getChatRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
                <span class="token comment">// 接收心跳消息</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"接收到心跳消息:"</span> <span class="token operator">+</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p><strong>编写ChatRecordService接口</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 将聊天记录保存到数据库中
     * @param chatRecord
     */</span>
    <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span>TbChatRecord chatRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>编写ChatRecordServiceImpl实现</strong></p> 
<pre><code class="prism language-java">   <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span>TbChatRecord chatRecord<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        chatRecord<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chatRecord<span class="token punctuation">.</span><span class="token function">setHasRead</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chatRecord<span class="token punctuation">.</span><span class="token function">setCreatetime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chatRecord<span class="token punctuation">.</span><span class="token function">setHasDelete</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        chatRecordMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>chatRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="54%09___1721"></a>5.4 聊天业务 - 加载聊天记录功能</h3> 
<p>根据userid和friendid加载未读的聊天记录</p> 
<p><strong>编写ChatRecordController</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/findByUserIdAndFriendId"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>TbChatRecord<span class="token punctuation">&gt;</span></span> <span class="token function">findByUserIdAndFriendId</span><span class="token punctuation">(</span>String userid<span class="token punctuation">,</span> String friendid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> chatRecordService<span class="token punctuation">.</span><span class="token function">findByUserIdAndFriendId</span><span class="token punctuation">(</span>userid<span class="token punctuation">,</span> friendid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>TbChatRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>编写ChatRecordService</strong></p> 
<pre><code class="prism language-java">  <span class="token comment">/**
     * 根据用户id和好友id将聊天记录查询出来
     * @param userid 用户id
     * @param friendid 好友id
     * @return 聊天记录列表
     */</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>TbChatRecord<span class="token punctuation">&gt;</span></span> <span class="token function">findByUserIdAndFriendId</span><span class="token punctuation">(</span>String userid<span class="token punctuation">,</span> String friendid<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>编写ChatRecordServiceImpl实现</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>TbChatRecord<span class="token punctuation">&gt;</span></span> <span class="token function">findByUserIdAndFriendId</span><span class="token punctuation">(</span>String userid<span class="token punctuation">,</span> String friendid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 需要：</span>
        TbChatRecordExample example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TbChatRecordExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        TbChatRecordExample<span class="token punctuation">.</span>Criteria criteria1 <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TbChatRecordExample<span class="token punctuation">.</span>Criteria criteria2 <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将 userid -&gt; friendid的聊天记录查询出来</span>
        criteria1<span class="token punctuation">.</span><span class="token function">andUseridEqualTo</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        criteria1<span class="token punctuation">.</span><span class="token function">andFriendidEqualTo</span><span class="token punctuation">(</span>friendid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        criteria1<span class="token punctuation">.</span><span class="token function">andHasDeleteEqualTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将 friendid -&gt; userid的聊天记录查询出来</span>
        criteria2<span class="token punctuation">.</span><span class="token function">andUseridEqualTo</span><span class="token punctuation">(</span>friendid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        criteria2<span class="token punctuation">.</span><span class="token function">andFriendidEqualTo</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        criteria2<span class="token punctuation">.</span><span class="token function">andHasDeleteEqualTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        example<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>criteria1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        example<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>criteria2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将发给userid的所有聊天记录设置为已读</span>
        TbChatRecordExample exampleQuerySendToMe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TbChatRecordExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TbChatRecordExample<span class="token punctuation">.</span>Criteria criteriaQuerySendToMe <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        criteriaQuerySendToMe<span class="token punctuation">.</span><span class="token function">andFriendidEqualTo</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        criteriaQuerySendToMe<span class="token punctuation">.</span><span class="token function">andHasReadEqualTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        List<span class="token generics function"><span class="token punctuation">&lt;</span>TbChatRecord<span class="token punctuation">&gt;</span></span> tbChatRecords <span class="token operator">=</span> chatRecordMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>exampleQuerySendToMe<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>TbChatRecord tbChatRecord <span class="token operator">:</span> tbChatRecords<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            tbChatRecord<span class="token punctuation">.</span><span class="token function">setHasRead</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            chatRecordMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKey</span><span class="token punctuation">(</span>tbChatRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">return</span> chatRecordMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="55%09___1790"></a>5.5 聊天业务 - 已读/未读消息状态标记</h3> 
<p><strong>已读消息</strong><br> 当用户接收到聊天消息，且聊天窗口被打开，就会发送一条用来签收的消息到Netty服务器<br> 用户打开聊天窗口，加载所有聊天记录，此时会把发给他的所有消息设置为已读<br> <strong>未读消息</strong><br> 如果用户没有打开聊天窗口，就认为消息是未读的</p> 
<p><strong>ChatRecordController</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/findUnreadByUserid"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>TbChatRecord<span class="token punctuation">&gt;</span></span> <span class="token function">findUnreadByUserid</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> chatRecordService<span class="token punctuation">.</span><span class="token function">findUnreadByUserid</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>TbChatRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>ChatRecordService</strong></p> 
<pre><code class="prism language-java"> <span class="token comment">/**
     * 设置消息为已读
     * @param id 聊天记录的id
     */</span>
    <span class="token keyword">void</span> <span class="token function">updateStatusHasRead</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>ChatRecordServiceImpl</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateStatusHasRead</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        TbChatRecord tbChatRecord <span class="token operator">=</span> chatRecordMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tbChatRecord<span class="token punctuation">.</span><span class="token function">setHasRead</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        chatRecordMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKey</span><span class="token punctuation">(</span>tbChatRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>ChatHandler</strong></p> 
<pre><code class="prism language-java"> <span class="token comment">// 处理客户端的签收消息</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                <span class="token comment">// 将消息记录设置为已读</span>
                chatRecordService<span class="token punctuation">.</span><span class="token function">updateStatusHasRead</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getChatRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="56%09___1839"></a>5.6 聊天业务 - 未读消息读取</h3> 
<p>在用户第一次打开App的时候，需要将所有的未读消息加载到App<br> <strong>ChatRecordController</strong></p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/findUnreadByUserid"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>TbChatRecord<span class="token punctuation">&gt;</span></span> <span class="token function">findUnreadByUserid</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> chatRecordService<span class="token punctuation">.</span><span class="token function">findUnreadByUserid</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>TbChatRecord<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>ChatRecordService</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * 根据用户id，查询发给他的未读消息记录
     * @param userid 用户id
     * @return 未读消息列表
     */</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>TbChatRecord<span class="token punctuation">&gt;</span></span> <span class="token function">findUnreadByUserid</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>ChatRecordServiceImpl</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>TbChatRecord<span class="token punctuation">&gt;</span></span> <span class="token function">findUnreadByUserid</span><span class="token punctuation">(</span>String userid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        TbChatRecordExample example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TbChatRecordExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TbChatRecordExample<span class="token punctuation">.</span>Criteria criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置查询发给userid的消息</span>
        criteria<span class="token punctuation">.</span><span class="token function">andFriendidEqualTo</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        criteria<span class="token punctuation">.</span><span class="token function">andHasReadEqualTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> chatRecordMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="6%09___1879"></a>6 业务开发 - 心跳机制</h3> 
<h3><a id="61%09Netty_1880"></a>6.1 Netty心跳处理以及读写超时设置</h3> 
<p>Netty并不能监听到客户端设置为飞行模式时，自动关闭对应的通道资源。我们需要让Netty能够定期检测某个通道是否空闲，如果空闲超过一定的时间，就可以将对应客户端的通道资源关闭。<br> <img src="https://images2.imgbox.com/1a/c3/CZNE92n1_o.png" alt="在这里插入图片描述"><br> <strong>编写后端Netty心跳检查的Handler</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HearBeatHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userEventTriggered</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> Object evt<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>evt <span class="token keyword">instanceof</span> <span class="token class-name">IdleStateEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            IdleStateEvent idleStateEvent <span class="token operator">=</span> <span class="token punctuation">(</span>IdleStateEvent<span class="token punctuation">)</span>evt<span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>idleStateEvent<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> IdleState<span class="token punctuation">.</span>READER_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"读空闲事件触发..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>idleStateEvent<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> IdleState<span class="token punctuation">.</span>WRITER_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"写空闲事件触发..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>idleStateEvent<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> IdleState<span class="token punctuation">.</span>ALL_IDLE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"---------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"读写空闲事件触发"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"关闭通道资源"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>在通道初始化器中（WebSocketInitailizer）添加心跳检查</strong></p> 
<pre><code class="prism language-java"> <span class="token comment">// 添加Netty空闲超时检查的支持</span>
        <span class="token comment">// 1. 读空闲超时（超过一定的时间会发送对应的事件消息）</span>
        <span class="token comment">// 2. 写空闲超时</span>
        <span class="token comment">// 3. 读写空闲超时</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HearBeatHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加自定义的handler</span>
        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="62%09Netty_1922"></a>6.2 测试Netty心跳机制</h3>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/916e8d7c5444e97f78b022e1bfb22cf1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2020-12-29</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ce36b259ca9c4cf99179fe537f054934/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android整理-Activity</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>