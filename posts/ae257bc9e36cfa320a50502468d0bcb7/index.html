<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>流动粒子（flow01001） - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="流动粒子（flow01001）" />
<meta property="og:description" content="流动粒子（flow01001） 示例HTMLCSSJS 更多有趣示例 尽在知屋安砖社区
示例 HTML &lt;script id=&#34;vertexShader_particle&#34; type=&#34;x-shader/x-vertex&#34;&gt; attribute vec3 a_position; attribute vec3 a_particle; attribute vec2 a_reference; uniform float u_time; uniform mat4 u_m_model; uniform mat4 u_m_view; uniform mat4 u_m_MVP; uniform mat4 u_m_proj; uniform sampler2D b_position; uniform sampler2D b_velocity; varying vec3 v_colour; varying float v_fogDepth; varying float v_opacity; float random(vec2 st) { return fract(sin(dot(st, vec2(12.9898,78.233)))* 43758.5453123); } vec3 hsv2rgb(vec3 c) { vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/ae257bc9e36cfa320a50502468d0bcb7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-21T15:17:42+08:00" />
<meta property="article:modified_time" content="2021-04-21T15:17:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">流动粒子（flow01001）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>流动粒子（flow01001）</h4> 
 <ul><li><a href="#_3" rel="nofollow">示例</a></li><li><a href="#HTML_5" rel="nofollow">HTML</a></li><li><a href="#CSS_507" rel="nofollow">CSS</a></li><li><a href="#JS_571" rel="nofollow">JS</a></li></ul> 
</div> 
<p></p> 
<p><strong>更多有趣示例 尽在</strong><kbd><a href="https://www.zhuanspace.com" rel="nofollow"><mark>知屋安砖社区</mark></a></kbd></p> 
<h2><a id="_3"></a>示例</h2> 
<p><img src="https://images2.imgbox.com/59/c9/7lLUm2aB_o.gif" alt="在这里插入图片描述"></p> 
<h2><a id="HTML_5"></a>HTML</h2> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vertexShader_particle<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-vertex<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
  attribute vec3 a_position<span class="token punctuation">;</span>
  attribute vec3 a_particle<span class="token punctuation">;</span>
  attribute vec2 a_reference<span class="token punctuation">;</span>
  
  uniform float u_time<span class="token punctuation">;</span>
  uniform mat4 u_m_model<span class="token punctuation">;</span>
  uniform mat4 u_m_view<span class="token punctuation">;</span>
  uniform mat4 u_m_MVP<span class="token punctuation">;</span>
  uniform mat4 u_m_proj<span class="token punctuation">;</span>
  
  uniform sampler2D b_position<span class="token punctuation">;</span>
  uniform sampler2D b_velocity<span class="token punctuation">;</span>
  
  varying vec3 v_colour<span class="token punctuation">;</span>
  varying float v_fogDepth<span class="token punctuation">;</span>
  varying float v_opacity<span class="token punctuation">;</span>
  
  float <span class="token function">random</span><span class="token punctuation">(</span>vec2 st<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>st<span class="token punctuation">,</span>
                         <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">12.9898</span><span class="token punctuation">,</span><span class="token number">78.233</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span>
        <span class="token number">43758.5453123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  vec3 <span class="token function">hsv2rgb</span><span class="token punctuation">(</span>vec3 c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    vec4 <span class="token constant">K</span> <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span> <span class="token operator">/</span> <span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec3 p <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">fract</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>xxx <span class="token operator">+</span> <span class="token constant">K</span><span class="token punctuation">.</span>xyz<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">6.0</span> <span class="token operator">-</span> <span class="token constant">K</span><span class="token punctuation">.</span>www<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> c<span class="token punctuation">.</span>z <span class="token operator">*</span> <span class="token function">mix</span><span class="token punctuation">(</span><span class="token constant">K</span><span class="token punctuation">.</span>xxx<span class="token punctuation">,</span> <span class="token function">clamp</span><span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token constant">K</span><span class="token punctuation">.</span>xxx<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  float <span class="token function">hash21</span><span class="token punctuation">(</span>vec2 p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    p <span class="token operator">=</span> <span class="token function">fract</span><span class="token punctuation">(</span>p <span class="token operator">*</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">233.34</span><span class="token punctuation">,</span> <span class="token number">851.74</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p <span class="token operator">+=</span> <span class="token function">dot</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> p <span class="token operator">+</span> <span class="token number">23.45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">*</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  mat3 <span class="token function">fromQuat</span><span class="token punctuation">(</span>vec4 q<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    float x <span class="token operator">=</span> q<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    float y <span class="token operator">=</span> q<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    float z <span class="token operator">=</span> q<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
    float w <span class="token operator">=</span> q<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
    float x2 <span class="token operator">=</span> q<span class="token punctuation">.</span>x<span class="token operator">*</span><span class="token number">2.</span><span class="token punctuation">;</span>
    float y2 <span class="token operator">=</span> q<span class="token punctuation">.</span>y<span class="token operator">*</span><span class="token number">2.</span><span class="token punctuation">;</span>
    float z2 <span class="token operator">=</span> q<span class="token punctuation">.</span>z<span class="token operator">*</span><span class="token number">2.</span><span class="token punctuation">;</span>
    
    float xx <span class="token operator">=</span> x <span class="token operator">*</span> x2<span class="token punctuation">;</span>
    float yx <span class="token operator">=</span> y <span class="token operator">*</span> x2<span class="token punctuation">;</span>
    float yy <span class="token operator">=</span> y <span class="token operator">*</span> y2<span class="token punctuation">;</span>
    float zx <span class="token operator">=</span> z <span class="token operator">*</span> x2<span class="token punctuation">;</span>
    float zy <span class="token operator">=</span> z <span class="token operator">*</span> y2<span class="token punctuation">;</span>
    float zz <span class="token operator">=</span> z <span class="token operator">*</span> z2<span class="token punctuation">;</span>
    float wx <span class="token operator">=</span> w <span class="token operator">*</span> x2<span class="token punctuation">;</span>
    float wy <span class="token operator">=</span> w <span class="token operator">*</span> y2<span class="token punctuation">;</span>
    float wz <span class="token operator">=</span> w <span class="token operator">*</span> z2<span class="token punctuation">;</span>
      
    <span class="token keyword">return</span> <span class="token function">mat3</span><span class="token punctuation">(</span>
      <span class="token number">1.</span> <span class="token operator">-</span> yy <span class="token operator">-</span>zz<span class="token punctuation">,</span> yx <span class="token operator">-</span>wz<span class="token punctuation">,</span> zx <span class="token operator">+</span> wy<span class="token punctuation">,</span>
      yx <span class="token operator">+</span> wz<span class="token punctuation">,</span> <span class="token number">1.</span> <span class="token operator">-</span> xx <span class="token operator">-</span> zz<span class="token punctuation">,</span> zy <span class="token operator">-</span> wx<span class="token punctuation">,</span>
      zx <span class="token operator">-</span> wy<span class="token punctuation">,</span> zy <span class="token operator">+</span> wx<span class="token punctuation">,</span> <span class="token number">1.</span> <span class="token operator">-</span> xx <span class="token operator">-</span> yy
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">/**
   * Generates a look-at matrix with the given eye position, focal point, and up axis.
   * If you want a matrix that actually makes an object look at another object, you should use targetTo instead.
   *
   * @param {mat4} out mat4 frustum matrix will be written into
   * @param {vec3} eye Position of the viewer
   * @param {vec3} center Point the viewer is looking at
   * @param {vec3} up vec3 pointing up
   * @returns {mat4} out
   */</span>
  mat4 <span class="token function">lookAt</span><span class="token punctuation">(</span>vec3 e<span class="token punctuation">,</span> vec3 c<span class="token punctuation">,</span> vec3 u<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
      <span class="token comment">// if (Math.abs(e.x - c.x) &lt; EPSILON &amp;&amp;</span>
      <span class="token comment">//     Math.abs(e.y - c.y) &lt; EPSILON &amp;&amp;</span>
      <span class="token comment">//     Math.abs(e.z - c.z) &lt; EPSILON) {<!-- --></span>
      <span class="token comment">//   return new Mat4();</span>
      <span class="token comment">// }</span>
      
      vec3 off <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>e <span class="token operator">-</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      vec3 or <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span>
        u<span class="token punctuation">.</span>y <span class="token operator">*</span> off<span class="token punctuation">.</span>z <span class="token operator">-</span> u<span class="token punctuation">.</span>z <span class="token operator">*</span> off<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        u<span class="token punctuation">.</span>z <span class="token operator">*</span> off<span class="token punctuation">.</span>x <span class="token operator">-</span> u<span class="token punctuation">.</span>x <span class="token operator">*</span> off<span class="token punctuation">.</span>z<span class="token punctuation">,</span>
        u<span class="token punctuation">.</span>x <span class="token operator">*</span> off<span class="token punctuation">.</span>y <span class="token operator">-</span> u<span class="token punctuation">.</span>y <span class="token operator">*</span> off<span class="token punctuation">.</span>x
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      or <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>or<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      vec3 tn <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span>
        off<span class="token punctuation">.</span>y <span class="token operator">*</span> or<span class="token punctuation">.</span>z <span class="token operator">-</span> off<span class="token punctuation">.</span>z <span class="token operator">*</span> or<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        off<span class="token punctuation">.</span>z <span class="token operator">*</span> or<span class="token punctuation">.</span>x <span class="token operator">-</span> off<span class="token punctuation">.</span>x <span class="token operator">*</span> or<span class="token punctuation">.</span>z<span class="token punctuation">,</span>
        off<span class="token punctuation">.</span>x <span class="token operator">*</span> or<span class="token punctuation">.</span>y <span class="token operator">-</span> off<span class="token punctuation">.</span>y <span class="token operator">*</span> or<span class="token punctuation">.</span>x
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      tn <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>tn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">return</span> <span class="token function">mat4</span><span class="token punctuation">(</span>
        or<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
        tn<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
        off<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        
        or<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        tn<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        off<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        
        or<span class="token punctuation">.</span>z<span class="token punctuation">,</span>
        tn<span class="token punctuation">.</span>z<span class="token punctuation">,</span>
        off<span class="token punctuation">.</span>z<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        
        <span class="token operator">-</span><span class="token punctuation">(</span>or<span class="token punctuation">.</span>x <span class="token operator">*</span> e<span class="token punctuation">.</span>x <span class="token operator">+</span> or<span class="token punctuation">.</span>y <span class="token operator">*</span> e<span class="token punctuation">.</span>y <span class="token operator">+</span> or<span class="token punctuation">.</span>z <span class="token operator">*</span> e<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token punctuation">(</span>tn<span class="token punctuation">.</span>x <span class="token operator">*</span> e<span class="token punctuation">.</span>x <span class="token operator">+</span> tn<span class="token punctuation">.</span>y <span class="token operator">*</span> e<span class="token punctuation">.</span>y <span class="token operator">+</span> tn<span class="token punctuation">.</span>z <span class="token operator">*</span> e<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token punctuation">(</span>off<span class="token punctuation">.</span>x <span class="token operator">*</span> e<span class="token punctuation">.</span>x <span class="token operator">+</span> off<span class="token punctuation">.</span>y <span class="token operator">*</span> e<span class="token punctuation">.</span>y <span class="token operator">+</span> off<span class="token punctuation">.</span>z <span class="token operator">*</span> e<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">1</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  vec3 <span class="token function">palette</span><span class="token punctuation">(</span> <span class="token keyword">in</span> float t<span class="token punctuation">,</span> <span class="token keyword">in</span> vec3 a<span class="token punctuation">,</span> <span class="token keyword">in</span> vec3 b<span class="token punctuation">,</span> <span class="token keyword">in</span> vec3 c<span class="token punctuation">,</span> <span class="token keyword">in</span> vec3 d <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token operator">*</span><span class="token function">cos</span><span class="token punctuation">(</span> <span class="token number">6.28318</span><span class="token operator">*</span><span class="token punctuation">(</span>c<span class="token operator">*</span>t<span class="token operator">+</span>d<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// vec4 pos = vec4(a_particle, 1.);</span>
    <span class="token comment">// vec4 mvPos = u_m_view * u_m_model * pos;</span>
    <span class="token comment">// gl_Position = u_m_proj * mvPos;</span>
    <span class="token comment">// float isq = ( 1. / -mvPos.z );</span>
    <span class="token comment">// gl_PointSize = (100.) * isq;</span>
    
    vec3 position <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>b_position<span class="token punctuation">,</span> a_reference<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    vec3 velocity <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>b_velocity<span class="token punctuation">,</span> a_reference<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    
    <span class="token comment">// vec4 quat = vec4(normalize(velocity), 0.);</span>
    <span class="token comment">// mat3 mat = fromQuat(quat);</span>
    <span class="token comment">// vec3 particle = a_particle * vec3(1, 1.+length(velocity*velocity*.05), 1) * .1 * mat;</span>
    
    float vl <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>velocity<span class="token operator">*</span>velocity<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">.01</span><span class="token punctuation">,</span> <span class="token number">5.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec3 p <span class="token operator">=</span> a_particle <span class="token operator">*</span> <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">1.</span><span class="token operator">-</span>vl<span class="token operator">*</span><span class="token number">.2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1.</span><span class="token operator">+</span>vl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float vl1 <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">20.</span><span class="token punctuation">,</span> <span class="token function">length</span><span class="token punctuation">(</span>velocity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p <span class="token operator">*=</span> <span class="token punctuation">(</span><span class="token number">.3</span> <span class="token operator">+</span> vl1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    mat4 look <span class="token operator">=</span> <span class="token function">lookAt</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
      <span class="token function">normalize</span><span class="token punctuation">(</span>velocity<span class="token punctuation">)</span><span class="token punctuation">,</span> 
      <span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec3 particle <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">vec4</span><span class="token punctuation">(</span>p  <span class="token operator">*</span> <span class="token number">.2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> look<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    <span class="token comment">// vec3 particle = (vec4(a_particle.yzx*vec3(1,1,1.+length(velocity*velocity)*.01), 1) * .2 * look).xyz;</span>
    
    position <span class="token operator">+=</span> particle<span class="token punctuation">;</span>
    
    vec4 pos <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    float l <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    vec4 mvPos <span class="token operator">=</span> u_m_view <span class="token operator">*</span> u_m_model <span class="token operator">*</span> pos<span class="token punctuation">;</span>
    
    v_fogDepth <span class="token operator">=</span> mvPos<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
    
    float isq <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token number">1.</span> <span class="token operator">/</span> <span class="token operator">-</span>mvPos<span class="token punctuation">.</span>z <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    float b <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">80.</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float s <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span>b<span class="token operator">*</span><span class="token number">6.</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v_opacity <span class="token operator">=</span> b<span class="token punctuation">;</span>
    
    gl_Position <span class="token operator">=</span> u_m_proj <span class="token operator">*</span> mvPos<span class="token punctuation">;</span>
    float hash <span class="token operator">=</span> <span class="token function">hash21</span><span class="token punctuation">(</span>a_reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v_colour <span class="token operator">=</span> <span class="token function">palette</span><span class="token punctuation">(</span>
      hash<span class="token operator">*</span><span class="token number">.5</span><span class="token operator">+</span><span class="token number">.3</span><span class="token punctuation">,</span> 
      <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0.3</span><span class="token punctuation">,</span><span class="token number">0.2</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// v_colour = hsv2rgb(vec3(.6 + hash * .3 + vl1 * .1, 1., hash * .5 + .3));</span>
    <span class="token comment">// if(length(a_reference) == 0.) v_colour = vec3(1,0,0);</span>
  <span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>vertexShader_buffer<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-vertex<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">attribute vec4 a_position<span class="token punctuation">;</span>
  
  uniform mat4 u_modelViewMatrix<span class="token punctuation">;</span>
  uniform mat4 u_projectionMatrix<span class="token punctuation">;</span>
  
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    gl_Position <span class="token operator">=</span> a_position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fragmentShader_velocity<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
  #extension GL_OES_standard_derivatives <span class="token punctuation">:</span> enable
  precision highp float<span class="token punctuation">;</span>
  
  uniform vec2 u_resolution<span class="token punctuation">;</span>
  uniform vec2 u_mouse<span class="token punctuation">;</span>
  uniform float u_time<span class="token punctuation">;</span>
  uniform sampler2D s_noise<span class="token punctuation">;</span>
  uniform int u_frame<span class="token punctuation">;</span>
  uniform float u_nsize<span class="token punctuation">;</span>
  uniform float u_seed<span class="token punctuation">;</span>
  
  uniform sampler2D b_velocity<span class="token punctuation">;</span>
  uniform sampler2D b_position<span class="token punctuation">;</span>
  
  #define <span class="token constant">PI</span> <span class="token number">3.141592653589793</span>
  #define <span class="token constant">HPI</span> <span class="token number">1.5707963267948966</span>
  #define <span class="token constant">TAU</span> <span class="token number">6.283185307179586</span>
  #define <span class="token constant">G</span> <span class="token number">0.67408</span>
  mat4 <span class="token function">rotationMatrix</span><span class="token punctuation">(</span>vec3 axis<span class="token punctuation">,</span> float angle<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
      axis <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>axis<span class="token punctuation">)</span><span class="token punctuation">;</span>
      float s <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      float c <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      float oc <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> c<span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token function">mat4</span><span class="token punctuation">(</span>oc <span class="token operator">*</span> axis<span class="token punctuation">.</span>x <span class="token operator">*</span> axis<span class="token punctuation">.</span>x <span class="token operator">+</span> c<span class="token punctuation">,</span>           oc <span class="token operator">*</span> axis<span class="token punctuation">.</span>x <span class="token operator">*</span> axis<span class="token punctuation">.</span>y <span class="token operator">-</span> axis<span class="token punctuation">.</span>z <span class="token operator">*</span> s<span class="token punctuation">,</span>  oc <span class="token operator">*</span> axis<span class="token punctuation">.</span>z <span class="token operator">*</span> axis<span class="token punctuation">.</span>x <span class="token operator">+</span> axis<span class="token punctuation">.</span>y <span class="token operator">*</span> s<span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span>
                  oc <span class="token operator">*</span> axis<span class="token punctuation">.</span>x <span class="token operator">*</span> axis<span class="token punctuation">.</span>y <span class="token operator">+</span> axis<span class="token punctuation">.</span>z <span class="token operator">*</span> s<span class="token punctuation">,</span>  oc <span class="token operator">*</span> axis<span class="token punctuation">.</span>y <span class="token operator">*</span> axis<span class="token punctuation">.</span>y <span class="token operator">+</span> c<span class="token punctuation">,</span>           oc <span class="token operator">*</span> axis<span class="token punctuation">.</span>y <span class="token operator">*</span> axis<span class="token punctuation">.</span>z <span class="token operator">-</span> axis<span class="token punctuation">.</span>x <span class="token operator">*</span> s<span class="token punctuation">,</span>  <span class="token number">0.0</span><span class="token punctuation">,</span>
                  oc <span class="token operator">*</span> axis<span class="token punctuation">.</span>z <span class="token operator">*</span> axis<span class="token punctuation">.</span>x <span class="token operator">-</span> axis<span class="token punctuation">.</span>y <span class="token operator">*</span> s<span class="token punctuation">,</span>  oc <span class="token operator">*</span> axis<span class="token punctuation">.</span>y <span class="token operator">*</span> axis<span class="token punctuation">.</span>z <span class="token operator">+</span> axis<span class="token punctuation">.</span>x <span class="token operator">*</span> s<span class="token punctuation">,</span>  oc <span class="token operator">*</span> axis<span class="token punctuation">.</span>z <span class="token operator">*</span> axis<span class="token punctuation">.</span>z <span class="token operator">+</span> c<span class="token punctuation">,</span>           <span class="token number">0.0</span><span class="token punctuation">,</span>
                  <span class="token number">0.0</span><span class="token punctuation">,</span>                                <span class="token number">0.0</span><span class="token punctuation">,</span>                                <span class="token number">0.0</span><span class="token punctuation">,</span>                                <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  vec3 <span class="token function">hash33</span><span class="token punctuation">(</span>vec3 p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span>
      <span class="token function">sin</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">43543.454354</span><span class="token punctuation">,</span>
      <span class="token function">sin</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">7531.154354</span><span class="token punctuation">,</span>
      <span class="token function">sin</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10053.75315</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    vec2 uv <span class="token operator">=</span> gl_FragCoord<span class="token punctuation">.</span>xy <span class="token operator">/</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
    vec3 position <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>b_position<span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    vec3 velocity <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>b_velocity<span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    vec3 acceleration <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec3 f <span class="token operator">=</span> position<span class="token punctuation">;</span>
    
    float tm <span class="token operator">=</span> u_time<span class="token punctuation">;</span>
    
    float l <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    position <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token function">vec4</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">rotationMatrix</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>tm <span class="token operator">*</span> <span class="token number">25.</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cos</span><span class="token punctuation">(</span>tm <span class="token operator">*</span> <span class="token number">10.</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sin</span><span class="token punctuation">(</span>tm<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>tm <span class="token operator">*</span> <span class="token number">5.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.5</span> <span class="token operator">+</span> <span class="token number">10.</span> <span class="token operator">/</span> l<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    
    vec3 spherical <span class="token operator">=</span> <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">1.</span><span class="token operator">/</span><span class="token function">max</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">atan</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span>y<span class="token punctuation">,</span> position<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">acos</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span>z <span class="token operator">/</span> l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    float a <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>spherical<span class="token punctuation">.</span>yz<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5.</span> <span class="token operator">+</span> tm<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5.</span><span class="token punctuation">;</span>
    
    acceleration<span class="token punctuation">.</span>x <span class="token operator">=</span> spherical<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>spherical<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>spherical<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> a<span class="token punctuation">;</span>
    acceleration<span class="token punctuation">.</span>y <span class="token operator">=</span> spherical<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>spherical<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>spherical<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> a<span class="token punctuation">;</span>
    acceleration<span class="token punctuation">.</span>z <span class="token operator">=</span> spherical<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>spherical<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">*</span> a<span class="token punctuation">;</span>
    
    f <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>f <span class="token operator">-</span> acceleration<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">1.</span><span class="token punctuation">;</span>
    f <span class="token operator">*=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">10.</span><span class="token punctuation">,</span> <span class="token number">40.</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span><span class="token punctuation">;</span>
    
    vec3 vel <span class="token operator">=</span> velocity <span class="token operator">*</span> <span class="token number">.99</span> <span class="token operator">+</span> <span class="token punctuation">(</span>acceleration <span class="token operator">+</span> f<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.5</span><span class="token punctuation">;</span>
    
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>vel<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fragmentShader_position<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
  #extension GL_OES_standard_derivatives <span class="token punctuation">:</span> enable
  precision highp float<span class="token punctuation">;</span>
  
  uniform vec2 u_resolution<span class="token punctuation">;</span>
  uniform vec2 u_mouse<span class="token punctuation">;</span>
  uniform float u_time<span class="token punctuation">;</span>
  uniform float u_delta<span class="token punctuation">;</span>
  uniform sampler2D s_noise<span class="token punctuation">;</span>
  uniform bool u_nreset<span class="token punctuation">;</span>
  
  uniform sampler2D b_prime<span class="token punctuation">;</span>
  uniform sampler2D b_velocity<span class="token punctuation">;</span>
  uniform sampler2D b_position<span class="token punctuation">;</span>
  uniform sampler2D b_origin<span class="token punctuation">;</span>
  
  vec2 <span class="token function">getScreenSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    vec2 uv <span class="token operator">=</span> <span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>xy <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">min</span><span class="token punctuation">(</span>u_resolution<span class="token punctuation">.</span>y<span class="token punctuation">,</span> u_resolution<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> uv<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  vec3 <span class="token function">hash33</span><span class="token punctuation">(</span>vec3 p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">fract</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span>
      <span class="token function">sin</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">43543.454354</span><span class="token punctuation">,</span>
      <span class="token function">sin</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">7531.154354</span><span class="token punctuation">,</span>
      <span class="token function">sin</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10053.75315</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    vec2 uv <span class="token operator">=</span> <span class="token function">getScreenSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec2 s <span class="token operator">=</span> gl_FragCoord<span class="token punctuation">.</span>xy <span class="token operator">/</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
    
    vec3 position <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>b_position<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    vec3 velocity <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>b_velocity<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    
    vec3 pos <span class="token operator">=</span> position <span class="token operator">+</span> velocity <span class="token operator">*</span> u_delta <span class="token operator">*</span> <span class="token number">.5</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">100.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      pos <span class="token operator">=</span> pos <span class="token operator">/</span> <span class="token function">length</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fragmentShader_particle<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
  #extension GL_OES_standard_derivatives <span class="token punctuation">:</span> enable
  precision highp float<span class="token punctuation">;</span>
  
  uniform vec2 u_resolution<span class="token punctuation">;</span>
  uniform vec2 u_mouse<span class="token punctuation">;</span>
  uniform float u_time<span class="token punctuation">;</span>
  uniform sampler2D s_noise<span class="token punctuation">;</span>
  uniform bool u_transition<span class="token punctuation">;</span>
  uniform float u_transition_val<span class="token punctuation">;</span>
  
  uniform sampler2D b_prime<span class="token punctuation">;</span>
  uniform sampler2D b_position<span class="token punctuation">;</span>
  
  varying vec3 v_colour<span class="token punctuation">;</span>
  varying float v_fogDepth<span class="token punctuation">;</span>
  varying float v_opacity<span class="token punctuation">;</span>
  
  vec2 <span class="token function">getScreenSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    vec2 uv <span class="token operator">=</span> <span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>xy <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">min</span><span class="token punctuation">(</span>u_resolution<span class="token punctuation">.</span>y<span class="token punctuation">,</span> u_resolution<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> uv<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    float fade <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">1.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> u_transition_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token function">mix</span><span class="token punctuation">(</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v_colour<span class="token punctuation">,</span> fade<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//     vec2 uv = gl_PointCoord.xy - .5;</span>
<span class="token comment">//     vec2 s = gl_FragCoord.xy / u_resolution.xy;</span>
    
<span class="token comment">//     float l = length(uv);</span>
<span class="token comment">//     float c = smoothstep(.5, 0., l);</span>
<span class="token comment">//     float fog = smoothstep(-200., -1., v_fogDepth);</span>
<span class="token comment">//     float opacity = c*fog;</span>
<span class="token comment">//     if(c &lt; .1) discard;</span>
    
<span class="token comment">//     float fade = smoothstep(1., 0., u_transition_val);</span>
    
<span class="token comment">//     gl_FragColor = vec4(</span>
<span class="token comment">//       mix(</span>
<span class="token comment">//         vec4(1.),</span>
<span class="token comment">//         mix(</span>
<span class="token comment">//           vec4(1), </span>
<span class="token comment">//           vec4(v_colour, opacity), </span>
<span class="token comment">//           c),</span>
<span class="token comment">//         fade</span>
<span class="token comment">//       )</span>
<span class="token comment">//     );</span>
  <span class="token punctuation">}</span>
  
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fragmentShader_blur<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
  #extension GL_OES_standard_derivatives <span class="token punctuation">:</span> enable
  precision highp float<span class="token punctuation">;</span>
  
  uniform vec2 u_resolution<span class="token punctuation">;</span>
  uniform vec2 u_mouse<span class="token punctuation">;</span>
  uniform float u_time<span class="token punctuation">;</span>
  uniform sampler2D s_noise<span class="token punctuation">;</span>
  
  uniform sampler2D b_prime<span class="token punctuation">;</span>
  uniform sampler2D b_blur<span class="token punctuation">;</span>
  
  varying vec3 v_colour<span class="token punctuation">;</span>
  
  vec2 <span class="token function">getScreenSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    vec2 uv <span class="token operator">=</span> <span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>xy <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">min</span><span class="token punctuation">(</span>u_resolution<span class="token punctuation">.</span>y<span class="token punctuation">,</span> u_resolution<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> uv<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    vec2 uv <span class="token operator">=</span> <span class="token function">getScreenSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    vec2 s <span class="token operator">=</span> gl_FragCoord<span class="token punctuation">.</span>xy <span class="token operator">/</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
    
    vec4 n1 <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>b_blur<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec4 n <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token function">texture2D</span><span class="token punctuation">(</span>b_prime<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    vec4 c <span class="token operator">=</span> n1<span class="token operator">*</span><span class="token number">.5</span> <span class="token operator">+</span> n<span class="token operator">*</span><span class="token number">.5</span><span class="token punctuation">;</span>

    gl_FragColor <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fragmentShader_bloom<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
  #extension GL_OES_standard_derivatives <span class="token punctuation">:</span> enable
  precision highp float<span class="token punctuation">;</span>
  
  uniform vec2 u_resolution<span class="token punctuation">;</span>
  uniform vec2 u_mouse<span class="token punctuation">;</span>
  uniform float u_time<span class="token punctuation">;</span>
  uniform sampler2D s_noise<span class="token punctuation">;</span>
  uniform int u_bloomstep<span class="token punctuation">;</span>
  
  uniform sampler2D b_prime<span class="token punctuation">;</span>
  uniform sampler2D b_blur<span class="token punctuation">;</span>
  uniform sampler2D b_bloom<span class="token punctuation">;</span>
  
  varying vec3 v_colour<span class="token punctuation">;</span>
  
  vec2 <span class="token function">getScreenSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    vec2 uv <span class="token operator">=</span> <span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>xy <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">min</span><span class="token punctuation">(</span>u_resolution<span class="token punctuation">.</span>y<span class="token punctuation">,</span> u_resolution<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> uv<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  vec4 <span class="token function">tex</span><span class="token punctuation">(</span>sampler2D tex<span class="token punctuation">,</span> vec2 co<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token function">texture2D</span><span class="token punctuation">(</span>tex<span class="token punctuation">,</span> co<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    vec2 uv <span class="token operator">=</span> <span class="token function">getScreenSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    vec2 s <span class="token operator">=</span> gl_FragCoord<span class="token punctuation">.</span>xy <span class="token operator">/</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
    vec2 p <span class="token operator">=</span> <span class="token number">1.</span><span class="token operator">/</span>u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
    
    
    <span class="token comment">// vec4 n1 = texture2D(b_blur, s);</span>
    <span class="token comment">// vec4 n = texture2D(b_prime, s);</span>
    
    vec4 n1<span class="token punctuation">;</span>
    vec4 c<span class="token punctuation">;</span>
    vec4 n <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>b_prime<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vec4 n2 <span class="token operator">=</span> n<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>u_bloomstep <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      n1 <span class="token operator">=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_blur<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1 <span class="token operator">+=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_blur<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1 <span class="token operator">+=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_blur<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token operator">*</span><span class="token number">2.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1 <span class="token operator">+=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_blur<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token operator">*</span><span class="token number">3.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1 <span class="token operator">+=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_blur<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token operator">*</span><span class="token operator">-</span><span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1 <span class="token operator">+=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_blur<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token operator">*</span><span class="token operator">-</span><span class="token number">2.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1 <span class="token operator">+=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_blur<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token operator">*</span><span class="token operator">-</span><span class="token number">3.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1<span class="token operator">/=</span><span class="token number">7.</span><span class="token punctuation">;</span>
      c <span class="token operator">=</span> n1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>u_bloomstep <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      n1 <span class="token operator">=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_bloom<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1 <span class="token operator">+=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_bloom<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1 <span class="token operator">+=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_bloom<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token operator">*</span><span class="token number">2.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1 <span class="token operator">+=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_bloom<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token operator">*</span><span class="token number">3.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1 <span class="token operator">+=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_bloom<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token operator">*</span><span class="token operator">-</span><span class="token number">1.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1 <span class="token operator">+=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_bloom<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token operator">*</span><span class="token operator">-</span><span class="token number">2.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1 <span class="token operator">+=</span> <span class="token function">tex</span><span class="token punctuation">(</span>b_bloom<span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token function">vec2</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token operator">*</span><span class="token operator">-</span><span class="token number">3.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      n1<span class="token operator">/=</span><span class="token number">7.</span><span class="token punctuation">;</span>
      c <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> <span class="token function">vec4</span><span class="token punctuation">(</span><span class="token number">2.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    gl_FragColor <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fragmentShader_buffer<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x-shader/x-fragment<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
  #extension GL_OES_standard_derivatives <span class="token punctuation">:</span> enable
  precision highp float<span class="token punctuation">;</span>
  
  uniform vec2 u_resolution<span class="token punctuation">;</span>
  uniform vec2 u_mouse<span class="token punctuation">;</span>
  uniform float u_time<span class="token punctuation">;</span>
  uniform sampler2D s_noise<span class="token punctuation">;</span>
  uniform bool u_transition<span class="token punctuation">;</span>
  uniform float u_transition_val<span class="token punctuation">;</span>
  
  uniform sampler2D b_prime<span class="token punctuation">;</span>
  uniform sampler2D b_blur<span class="token punctuation">;</span>
  uniform sampler2D b_bloom<span class="token punctuation">;</span>
  
  varying vec3 v_colour<span class="token punctuation">;</span>
  
  vec2 <span class="token function">getScreenSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    vec2 uv <span class="token operator">=</span> <span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>xy <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">min</span><span class="token punctuation">(</span>u_resolution<span class="token punctuation">.</span>y<span class="token punctuation">,</span> u_resolution<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> uv<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    vec2 uv <span class="token operator">=</span> <span class="token function">getScreenSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    vec2 s <span class="token operator">=</span> gl_FragCoord<span class="token punctuation">.</span>xy <span class="token operator">/</span> u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
    
    vec2 p <span class="token operator">=</span> <span class="token number">.5</span><span class="token operator">/</span>u_resolution<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
    
    <span class="token comment">// vec4 bloom = texture2D(b_bloom, s);</span>
    vec4 n <span class="token operator">=</span> <span class="token function">texture2D</span><span class="token punctuation">(</span>b_blur<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    float fade <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">1.</span><span class="token punctuation">,</span> <span class="token number">0.</span><span class="token punctuation">,</span> u_transition_val<span class="token punctuation">)</span><span class="token punctuation">;</span>

    gl_FragColor <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>
      <span class="token function">mix</span><span class="token punctuation">(</span>
        <span class="token function">vec3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        n<span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> fade<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token operator">-</span>fade<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>controls<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playpause checked<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">checked</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>checked<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>None<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>playpause<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>check<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h2><a id="CSS_507"></a>CSS</h2> 
<pre><code class="prism language-css"><span class="token selector">body</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">background</span><span class="token punctuation">:</span> #66f<span class="token punctuation">;</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">canvas</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100vh<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100vw<span class="token punctuation">;</span>
  <span class="token property">touch-action</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.osc</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.button</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>
  <span class="token property">z-index</span><span class="token punctuation">:</span> 10<span class="token punctuation">;</span>
  <span class="token property">right</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.controls</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>
  <span class="token property">z-index</span><span class="token punctuation">:</span> 10<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.playpause</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">background</span><span class="token punctuation">:</span> #AAB<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.playpause label</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
  <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>

  <span class="token property">width</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>

  <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>

  <span class="token property">border-color</span><span class="token punctuation">:</span> transparent transparent transparent #202020<span class="token punctuation">;</span>
  <span class="token property">transition</span><span class="token punctuation">:</span> 100ms all ease<span class="token punctuation">;</span>
  <span class="token property">will-change</span><span class="token punctuation">:</span> border-width<span class="token punctuation">;</span>

  <span class="token property">border-style</span><span class="token punctuation">:</span> double<span class="token punctuation">;</span>
  <span class="token property">border-width</span><span class="token punctuation">:</span> 0px 0 0px 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.playpause input[type='checkbox']</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.playpause.checked label</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">border-style</span><span class="token punctuation">:</span> double<span class="token punctuation">;</span>
  <span class="token property">border-width</span><span class="token punctuation">:</span> 0px 0 0px 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.playpause label</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">border-style</span><span class="token punctuation">:</span> solid<span class="token punctuation">;</span>
  <span class="token property">border-width</span><span class="token punctuation">:</span> 10px 0 10px 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* } */</span>
</code></pre> 
<h2><a id="JS_571"></a>JS</h2> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Vec2<span class="token punctuation">,</span> Vec3<span class="token punctuation">,</span> Mat2<span class="token punctuation">,</span> Mat3<span class="token punctuation">,</span> Mat4<span class="token punctuation">,</span> Quat <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'https://cdn.skypack.dev/wtc-math'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> gifJs <span class="token keyword">from</span> <span class="token string">'https://cdn.skypack.dev/gif.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Determine whether a number is a power of 2</span>
<span class="token keyword">function</span> <span class="token function">powerOf2</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> v <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>v <span class="token operator">&amp;</span> <span class="token punctuation">(</span>v <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Return the next greatest power of 2</span>
<span class="token keyword">function</span> <span class="token function">nextPow2</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  v<span class="token operator">--</span><span class="token punctuation">;</span>
  v <span class="token operator">|=</span> v <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  v <span class="token operator">|=</span> v <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
  v <span class="token operator">|=</span> v <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
  v <span class="token operator">|=</span> v <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
  v <span class="token operator">|=</span> v <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
  v<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Update a provided image to the nearest power of 2 in size.</span>
<span class="token keyword">const</span> <span class="token function-variable function">pow2Image</span> <span class="token operator">=</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> newWidth <span class="token operator">=</span> <span class="token function">powerOf2</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">?</span> c<span class="token punctuation">.</span>width <span class="token punctuation">:</span> <span class="token function">nextPow2</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> newHeight <span class="token operator">=</span> <span class="token function">powerOf2</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token operator">?</span> c<span class="token punctuation">.</span>height <span class="token punctuation">:</span> <span class="token function">nextPow2</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> _c <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ctx <span class="token operator">=</span> _c<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  _c<span class="token punctuation">.</span>width <span class="token operator">=</span> newWidth<span class="token punctuation">;</span>
  _c<span class="token punctuation">.</span>height <span class="token operator">=</span> newHeight<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> newWidth<span class="token punctuation">,</span> newHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> _c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">asyncImageLoad</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> src<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
    img<span class="token punctuation">.</span>onerror <span class="token operator">=</span> reject<span class="token punctuation">;</span>
    img<span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> glEnumToString <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> haveEnumsForType <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> enums <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">addEnums</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> type <span class="token operator">=</span> gl<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>haveEnumsForType<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> gl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> gl<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">const</span> existing <span class="token operator">=</span> enums<span class="token punctuation">[</span>gl<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          enums<span class="token punctuation">[</span>gl<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> existing <span class="token operator">?</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>existing<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> | </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">:</span> key<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      haveEnumsForType<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">glEnumToString</span><span class="token punctuation">(</span>gl<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">addEnums</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> enums<span class="token punctuation">[</span>value<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">?</span> <span class="token template-string"><span class="token string">`0x</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">:</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">addExtensions</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Set up the extensions</span>
  ctx<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'OES_standard_derivatives'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'EXT_shader_texture_lod'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'OES_texture_float'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'WEBGL_color_buffer_float'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'OES_texture_float_linear'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'EXT_color_buffer_float'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createContext</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> opt_attribs<span class="token punctuation">,</span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> ctx <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"webgl"</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_el<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"experimental-webgl"</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">addExtensions</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">quatToMat4</span> <span class="token operator">=</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>array<span class="token punctuation">)</span> q <span class="token operator">=</span> q<span class="token punctuation">.</span>array<span class="token punctuation">;</span> <span class="token comment">// This just transforms a provided vector into to an array.</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>q <span class="token keyword">instanceof</span> <span class="token class-name">Array</span> <span class="token operator">&amp;&amp;</span> q<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">,</span> w<span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> z2<span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x <span class="token operator">*</span> <span class="token number">2.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">const</span> xx <span class="token operator">=</span> x <span class="token operator">*</span> x2<span class="token punctuation">,</span>
            yx <span class="token operator">=</span> y <span class="token operator">*</span> x2<span class="token punctuation">,</span>
            yy <span class="token operator">=</span> y <span class="token operator">*</span> y2<span class="token punctuation">,</span>
            zx <span class="token operator">=</span> z <span class="token operator">*</span> x2<span class="token punctuation">,</span>
            zy <span class="token operator">=</span> z <span class="token operator">*</span> y2<span class="token punctuation">,</span>
            zz <span class="token operator">=</span> z <span class="token operator">*</span> z2<span class="token punctuation">,</span>
            wx <span class="token operator">=</span> w <span class="token operator">*</span> x2<span class="token punctuation">,</span>
            wy <span class="token operator">=</span> w <span class="token operator">*</span> y2<span class="token punctuation">,</span>
            wz <span class="token operator">=</span> w <span class="token operator">*</span> z2<span class="token punctuation">;</span>
      
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Mat4</span><span class="token punctuation">(</span>
        <span class="token number">1</span> <span class="token operator">-</span> yy <span class="token operator">-</span>zz<span class="token punctuation">,</span> yx <span class="token operator">-</span>wz<span class="token punctuation">,</span> zx <span class="token operator">+</span> wy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        yx <span class="token operator">+</span> wz<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> xx <span class="token operator">-</span> zz<span class="token punctuation">,</span> zy <span class="token operator">-</span> wx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        zx <span class="token operator">-</span> wy<span class="token punctuation">,</span> zy <span class="token operator">+</span> wx<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> xx <span class="token operator">-</span> yy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Renderer</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">static</span> #defaultOptions <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    width<span class="token punctuation">:</span> <span class="token number">512</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token number">512</span><span class="token punctuation">,</span>
    pxRatio<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>devicePixelRatio<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    clearing<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    depthTesting<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    premultipliedAlpha<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
    
  <span class="token keyword">static</span> <span class="token constant">BLENDING_DEBUG</span>      <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token constant">BLENDING_NORMAL</span>      <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token constant">BLENDING_ADDITIVE</span>    <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token constant">BLENDING_SUBTRACTIVE</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token constant">BLENDING_MULTIPLY</span>    <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token constant">BLENDING_OFF</span>         <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

  isWebgl2 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  #blending<span class="token punctuation">;</span>
  #blendingEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  #buffers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> Renderer<span class="token punctuation">.</span>#defaultOptions<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> options<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> options<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pxRatio <span class="token operator">=</span> options<span class="token punctuation">.</span>pxRatio<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clearing <span class="token operator">=</span> options<span class="token punctuation">.</span>clearing<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>depthTesting <span class="token operator">=</span> options<span class="token punctuation">.</span>depthTesting<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canvas <span class="token operator">=</span> canvas <span class="token operator">||</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pxRatio<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pxRatio<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>premultipliedAlpha <span class="token operator">=</span> options<span class="token punctuation">.</span>premultipliedAlpha<span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"webgl"</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"experimental-webgl"</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>viewportWidth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>viewportHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>uniformResolution <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> <span class="token string">'resolution'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_V2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">resize</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> ratio<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> w<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> h<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pxRatio <span class="token operator">=</span> ratio <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pxRatio<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pxRatio<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pxRatio<span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>viewportWidth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>viewportHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>uniformResolution <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> <span class="token string">'resolution'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_V2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">setViewport</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> w <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">.</span>pxRatio<span class="token punctuation">;</span>
    <span class="token keyword">let</span> h <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">.</span>pxRatio<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      w <span class="token operator">=</span> dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      h <span class="token operator">=</span> dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uniformResolution <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> <span class="token string">'resolution'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_V2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>w<span class="token punctuation">,</span> h<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">addExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'OES_standard_derivatives'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'EXT_shader_texture_lod'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'OES_texture_float'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'WEBGL_color_buffer_float'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'OES_texture_float_linear'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span><span class="token string">'EXT_color_buffer_float'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">linkBuffer</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> hasBuffer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#buffers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>buffer <span class="token operator">===</span> b<span class="token punctuation">)</span> hasBuffer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>hasBuffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>
        buffer<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
        buffer<span class="token punctuation">.</span>drawType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    buffer<span class="token punctuation">.</span><span class="token function">link</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentProgram<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">setupProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> buffers<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> uniforms<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentProgram <span class="token operator">=</span> program<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>premultiplied <span class="token operator">=</span> program<span class="token punctuation">.</span>premultiplied<span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>depthTesting <span class="token operator">=</span> program<span class="token punctuation">.</span>depthTesting<span class="token punctuation">;</span>
    
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>program<span class="token punctuation">.</span>blending <span class="token operator">===</span> Program<span class="token punctuation">.</span><span class="token constant">BLENDING_NORMAL</span> <span class="token operator">&amp;&amp;</span> program<span class="token punctuation">.</span>transparent <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>blending <span class="token operator">=</span> Program<span class="token punctuation">.</span><span class="token constant">BLENDING_OFF</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>blending <span class="token operator">=</span> program<span class="token punctuation">.</span>blending<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>clearColour <span class="token operator">=</span> program<span class="token punctuation">.</span>clearColour<span class="token punctuation">;</span>
    <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clearColour<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// console.log('prem', this.premultipliedAlpha)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>premultipliedAlpha<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clearColour <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clearColour<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> c <span class="token operator">*</span> a <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>clearColour<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// TODO: Unlink unused buffers during this setup phase as well.</span>
    buffers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>buffer <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">linkBuffer</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token comment">// this.ctx.enable(ctx.DEPTH_TEST);</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>depthTesting<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token constant">DEPTH_TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    uniforms<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>uniform <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      uniform<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>program<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>uniformResolution<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>program<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span>points<span class="token punctuation">,</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">bindFramebuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">FRAMEBUFFER</span><span class="token punctuation">,</span> buffer<span class="token operator">?</span><span class="token punctuation">.</span>fb <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clearing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>depthTesting<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">DEPTH_BUFFER_BIT</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentProgram<span class="token punctuation">.</span>renderType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> Program<span class="token punctuation">.</span><span class="token constant">RENDER_TRIANGLES</span><span class="token punctuation">:</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> Program<span class="token punctuation">.</span><span class="token constant">RENDER_STRIP</span><span class="token punctuation">:</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> Program<span class="token punctuation">.</span><span class="token constant">RENDER_LINES</span><span class="token punctuation">:</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">LINE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> Program<span class="token punctuation">.</span><span class="token constant">RENDER_LINELOOP</span><span class="token punctuation">:</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">LINE_LOOP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> Program<span class="token punctuation">.</span><span class="token constant">RENDER_POINTS</span><span class="token punctuation">:</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">POINTS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
  <span class="token punctuation">}</span>

  <span class="token comment">/* SETTERS AND GETTERS */</span>
  <span class="token keyword">get</span> <span class="token function">blending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#blending <span class="token operator">||</span> Program<span class="token punctuation">.</span><span class="token constant">BLENDING_NORMAL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">blending</span><span class="token punctuation">(</span>blending<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>blending <span class="token operator">===</span> Renderer<span class="token punctuation">.</span><span class="token constant">BLENDING_DEBUG</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>breakLog<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>blending<span class="token punctuation">,</span> Renderer<span class="token punctuation">.</span><span class="token constant">BLENDING_OFF</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>premultiplied<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>breakLog <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>#blending <span class="token operator">=</span> blending<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">BLEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">blendFuncSeparate</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_ALPHA</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_ALPHA</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>#blending <span class="token operator">=</span> blending<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>blending <span class="token operator">===</span> Renderer<span class="token punctuation">.</span><span class="token constant">BLENDING_OFF</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">BLEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>#blendingEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#blendingEnabled <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">BLEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// this.ctx.alphaFunc(this.ctx.GL_GREATER, 0.5);</span>
      <span class="token comment">// this.ctx.enable(this.ctx.GL_ALPHA_TEST);</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>#blendingEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>premultiplied <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>blending<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> Renderer<span class="token punctuation">.</span><span class="token constant">BLENDING_NORMAL</span><span class="token punctuation">:</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">blendFuncSeparate</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_ALPHA</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_ALPHA</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> Renderer<span class="token punctuation">.</span><span class="token constant">BLENDING_ADDITIVE</span><span class="token punctuation">:</span> 
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">blendFunc</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> Renderer<span class="token punctuation">.</span><span class="token constant">BLENDING_SUBTRACTIVE</span><span class="token punctuation">:</span> 
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">blendFuncSeparate</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_COLOR</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_ALPHA</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> Renderer<span class="token punctuation">.</span><span class="token constant">BLENDING_MULTIPLY</span><span class="token punctuation">:</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">blendFuncSeparate</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">SRC_COLOR</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">SRC_ALPHA</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>blending<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> Renderer<span class="token punctuation">.</span><span class="token constant">BLENDING_NORMAL</span><span class="token punctuation">:</span> 
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">blendFuncSeparate</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">SRC_ALPHA</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_ALPHA</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_ALPHA</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> Renderer<span class="token punctuation">.</span><span class="token constant">BLENDING_ADDITIVE</span><span class="token punctuation">:</span> 
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">blendFunc</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">SRC_ALPHA</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> Renderer<span class="token punctuation">.</span><span class="token constant">BLENDING_SUBTRACTIVE</span><span class="token punctuation">:</span> 
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">blendFunc</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ONE_MINUS_SRC_COLOR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> Renderer<span class="token punctuation">.</span><span class="token constant">BLENDING_MULTIPLY</span><span class="token punctuation">:</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">blendFunc</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">SRC_COLOR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Buffer</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">static</span> #defaultAttribute <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        numComponents<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        stride<span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> #defaults <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
        name<span class="token punctuation">:</span> <span class="token string">'position'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    normalized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    drawType<span class="token punctuation">:</span> window<span class="token punctuation">.</span>WebGLRenderingContext<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">,</span>
    type<span class="token punctuation">:</span> window<span class="token punctuation">.</span>WebGLRenderingContext<span class="token punctuation">.</span><span class="token constant">FLOAT</span>
  <span class="token punctuation">}</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> data<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span>#defaults<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attributes <span class="token operator">=</span> options<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>a <span class="token operator">=&gt;</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span>#defaultAttribute<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>normalized <span class="token operator">=</span> options<span class="token punctuation">.</span>normalized<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>drawType <span class="token operator">=</span> options<span class="token punctuation">.</span>drawType<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> options<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>data <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">link</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> hasBuffer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> location <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`a_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>attributes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>attribute <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`a_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>attribute<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> attribute<span class="token punctuation">.</span>numComponents<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>normalized<span class="token punctuation">,</span> attribute<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> attribute<span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">{<!-- --></span>
  
  <span class="token keyword">static</span> <span class="token constant">RENDER_TRIANGLES</span>     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token constant">RENDER_STRIP</span>         <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token constant">RENDER_LINES</span>         <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token constant">RENDER_LINELOOP</span>      <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token constant">RENDER_POINTS</span>        <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
  
  <span class="token keyword">static</span> #defaultOptions <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    renderType<span class="token punctuation">:</span> Program<span class="token punctuation">.</span><span class="token constant">RENDER_TRIANGLES</span><span class="token punctuation">,</span>
    clearColour<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    blending<span class="token punctuation">:</span> Renderer<span class="token punctuation">.</span><span class="token constant">BLENDING_OFF</span><span class="token punctuation">,</span>
    premultiplied<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    transparent<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    depthTesting<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  
  #vShader
  #fShader
  #p
  #renderType
  
  <span class="token function">constructor</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> vertexShaderSource<span class="token punctuation">,</span> fragmentShaderSource<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> Program<span class="token punctuation">.</span>#defaultOptions<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderType <span class="token operator">=</span> options<span class="token punctuation">.</span>renderType<span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>clearColour <span class="token operator">=</span> options<span class="token punctuation">.</span>clearColour<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>blending <span class="token operator">=</span> options<span class="token punctuation">.</span>blending<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>premultiplied <span class="token operator">=</span> options<span class="token punctuation">.</span>premultiplied<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>transparent <span class="token operator">=</span> options<span class="token punctuation">.</span>transparent<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>depthTesting <span class="token operator">=</span> options<span class="token punctuation">.</span>depthTesting<span class="token punctuation">;</span>
    
    <span class="token comment">// Create the shaders</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vShader <span class="token operator">=</span> Program<span class="token punctuation">.</span><span class="token function">createShaderOfType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">,</span> vertexShaderSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fShader <span class="token operator">=</span> Program<span class="token punctuation">.</span><span class="token function">createShaderOfType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">,</span> fragmentShaderSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Create the program and link the shaders</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#p <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#p<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#p<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">linkProgram</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Check the result of linking</span>
    <span class="token keyword">var</span> linked <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">getProgramParameter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#p<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">LINK_STATUS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>linked<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> error <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">getProgramInfoLog</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Failed to link program: '</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">deleteProgram</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">deleteShader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">deleteShader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">get</span> <span class="token function">program</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#p<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* SETTERS AND GETTERS */</span>

  <span class="token keyword">set</span> <span class="token function">renderType</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      Program<span class="token punctuation">.</span><span class="token constant">RENDER_TRIANGLES</span><span class="token punctuation">,</span>
      Program<span class="token punctuation">.</span><span class="token constant">RENDER_STRIP</span><span class="token punctuation">,</span>
      Program<span class="token punctuation">.</span><span class="token constant">RENDER_LINES</span><span class="token punctuation">,</span>
      Program<span class="token punctuation">.</span><span class="token constant">RENDER_LINELOOP</span><span class="token punctuation">,</span>
      Program<span class="token punctuation">.</span><span class="token constant">RENDER_POINTS</span>
    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#renderType <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">renderType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#renderType<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">/**
   * Static Methods
   */</span>

	<span class="token comment">/**
	 * Create a shader of a given type given a context, type and source.
	 *
   * @static
	 * @param  {WebGLContext} ctx The context under which to create the shader
	 * @param  {WebGLShaderType} type The shader type, vertex or fragment
	 * @param  {string} source The shader source.
	 * @return {WebGLShader} The created shader
	 */</span>
  <span class="token keyword">static</span> <span class="token function">createShaderOfType</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> type<span class="token punctuation">,</span> source<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> shader <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">shaderSource</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">compileShader</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Check the compile status</span>
    <span class="token keyword">const</span> compiled <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getShaderParameter</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token constant">COMPILE_STATUS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>compiled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Something went wrong during compilation; get the error</span>
      <span class="token keyword">const</span> lastError <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getShaderInfoLog</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>Program<span class="token punctuation">.</span><span class="token function">addLineNumbersWithError</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> lastError<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\nError compiling </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token function">glEnumToString</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>lastError<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span><span class="token function">deleteShader</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> shader<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token function">addLineNumbersWithError</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> log <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>
    <span class="token keyword">const</span> errorRE <span class="token operator">=</span> <span class="token regex">/ERROR:\s*\d+:(\d+)/gi</span><span class="token punctuation">;</span>
    <span class="token comment">// Note: Error message formats are not defined by any spec so this may or may not work.</span>
    <span class="token keyword">const</span> matches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>log<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span>errorRE<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lineNoToErrorMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span>matches<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> ndx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> lineNo <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> next <span class="token operator">=</span> matches<span class="token punctuation">[</span>ndx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> end <span class="token operator">=</span> next <span class="token operator">?</span> next<span class="token punctuation">.</span>index <span class="token punctuation">:</span> log<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">const</span> msg <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>lineNo <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> msg<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> src<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> lineNo<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> err <span class="token operator">=</span> lineNoToErrorMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>lineNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>lineNo <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>line<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>err <span class="token operator">?</span> `\n\n<span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> $<span class="token punctuation">{<!-- --></span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">}</span><span class="token template-string"><span class="token string">`;
    }).join('\n');
  }
}
class Uniform {
  static TYPE_INT = 0
  static TYPE_FLOAT = 1
  static TYPE_V2 = 2
  static TYPE_V3 = 3
  static TYPE_V4 = 4
  static TYPE_BOOL = 5
  static TYPE_M2 = 6
  static TYPE_M3 = 7
  static TYPE_M4 = 8
  
  #prefix = 'u'
  
  constructor(ctx, name, type, value) {
    this.ctx = ctx;
    this.name = name;
    this.type = type;
    this.value = value;
  }
  
  prebind() {
    
  }
  
  bind(program) {
    this.prebind(program);
    const location = this.ctx.getUniformLocation(program, `</span></span>$<span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>#prefix<span class="token punctuation">}</span>_$<span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token template-string"><span class="token string">`);
    switch(this.type) {
      case Uniform.TYPE_INT : 
        if(!isNaN(this.value)) this.ctx.uniform1i( location, this.value );
        break;
      case Uniform.TYPE_FLOAT : 
        if(!isNaN(this.value)) this.ctx.uniform1f( location, this.value);
        break;
      case Uniform.TYPE_V2 : 
        if(this.value instanceof Array &amp;&amp; this.value.length === 2.) this.ctx.uniform2fv( location, this.value);
        break;
      case Uniform.TYPE_V3 : 
        if(this.value instanceof Array &amp;&amp; this.value.length === 3.) this.ctx.uniform3fv( location, this.value);
        break;
      case Uniform.TYPE_V4 : 
        if(this.value instanceof Array &amp;&amp; this.value.length === 4.) this.ctx.uniform4fv( location, this.value);
        break;
      case Uniform.TYPE_BOOL : 
        if(!isNaN(this.value)) this.ctx.uniform1i( location, this.value);
        break;
      case Uniform.TYPE_M2 : 
        if(this.value instanceof Array &amp;&amp; this.value.length === 4.) this.ctx.uniformMatrix2fv( location, false, this.value);
      case Uniform.TYPE_M3 : 
        if(this.value instanceof Array &amp;&amp; this.value.length === 9.) this.ctx.uniformMatrix3fv( location, false, this.value);
      case Uniform.TYPE_M4 : 
        if(this.value instanceof Array &amp;&amp; this.value.length === 16.) this.ctx.uniformMatrix4fv( location, false, this.value);
        break;
    }
  }
}
class Texture extends Uniform {
  #prefix = 's'
  static #defaultOptions = {
    textureType: 0,
    minFilter: window.WebGLRenderingContext.LINEAR,
    magFilter: window.WebGLRenderingContext.LINEAR,
    makePowerOf2: false,
    generateMipMap: false
  }
  static masteri = 0
  
  static IMAGETYPE_REGULAR = 0
  static IMAGETYPE_TILE = 1
  static IMAGETYPE_MIRROR = 2
  
  constructor(ctx, name, options) {
    super(ctx, name, 0, null);
    options = Object.assign({}, Texture.#defaultOptions, options);
    this.textureType = options.textureType;
    this.minFilter = options.minFilter;
    this.magFilter = options.magFilter;
    this.makePowerOf2 = options.makePowerOf2;
    this.generateMipMap = options.generateMipMap;
    this.url = options.url;
    this.data = options.data;
    this.value = Texture.masteri++;
  }
  async preload() {
    const store = {};

    const img = new Image();
    img.crossOrigin = "anonymous";

    await asyncImageLoad(img, this.url);
    
    if(this.makePowerOf2) this.image = pow2Image(img);
    else this.image = img;

    // this.loadTexture(gl, n, store);
    return this;
  }
  
  prebind(program) {
    if(!this.image) return;
    
    const texture = this.ctx.createTexture(); // Create the texture object
    
    this.ctx.pixelStorei(this.ctx.UNPACK_FLIP_Y_WEBGL, true);
    this.ctx.bindTexture(this.ctx.TEXTURE_2D, texture);
    
    this.ctx.activeTexture(this.ctx.TEXTURE0 + this.value);
    
    // Set the parameters based on the passed type
    // In WebGL images are wrapped by default, so we don't need to check for that
    if(this.textureType === Texture.IMAGETYPE_MIRROR) {
      this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_WRAP_S, this.ctx.MIRRORED_REPEAT);
      this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_WRAP_T, this.ctx.MIRRORED_REPEAT);
    } else if(this.textureType === Texture.IMAGETYPE_REGULAR) {
      this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_WRAP_S, this.ctx.CLAMP_TO_EDGE);
      this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_WRAP_T, this.ctx.CLAMP_TO_EDGE);
    }
    
    this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_MIN_FILTER, this.minFilter);
    this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_MAG_FILTER, this.magFilter);
    
    // Upload the image into the texture.
    if(this.data) {
      this.ctx.texImage2D(this.ctx.TEXTURE_2D, 0, this.ctx.RGBA, this.ctx.RGBA, this.ctx.UNSIGNED_BYTE, this.data);
    } else {
      this.ctx.texImage2D(this.ctx.TEXTURE_2D, 0, this.ctx.RGBA, this.ctx.RGBA, this.ctx.UNSIGNED_BYTE, this.image);
    }
    
    if(this.generateMipMap) this.ctx.generateMipmap(this.ctx.TEXTURE_2D);
  }
}
class FrameBuffer {
  static #defaultOptions = {
    width: 512,
    height: 512,
    pxRatio: Math.min(window.devicePixelRatio, 2),
    tiling: Texture.IMAGETYPE_REGULAR,
    texdepth: FrameBuffer.TEXTYPE_HALF_FLOAT_OES,
    data: null,
    depthTesting: false
  }
  static TEXTYPE_FLOAT = 0
  static TEXTYPE_UNSIGNED_BYTE = 1
  static TEXTYPE_HALF_FLOAT_OES = 2

  #fb1
  #fb2
  #activeFB
  #name
  #width
  #height
  #pxRatio
  #tiling = Texture.IMAGETYPE_REGULAR
  #texdepth = FrameBuffer.TEXTYPE_HALF_FLOAT_OES
  #data;

  constructor(renderer, name, options) {
    options = Object.assign({}, FrameBuffer.#defaultOptions, options);
    
    this.width = options.width;
    this.height = options.height;
    this.pxRatio = options.pxRatio;
    this.tiling = options.tiling;
    this.texdepth = options.texdepth;
    this.depthTesting = options.depthTesting;
    
    this.#name = name;
    this.value = Texture.masteri++;
    
    this.ctx = renderer.ctx;
    this.renderer = renderer;
    
    this.data = options.data;
    
    this.#fb1 = this.createFrameBuffer();
    this.#fb2 = this.createFrameBuffer();
    this.#activeFB = this.#fb1;
  }
  resize(width, height) {
    this.width = width;
    this.height = height;
    this.#fb1 = this.createFrameBuffer();
    this.#fb2 = this.createFrameBuffer();
    this.#activeFB = this.#fb1;
  }
  createFrameBuffer() {
    const targetTexture = this.ctx.createTexture();
    this.ctx.bindTexture(this.ctx.TEXTURE_2D, targetTexture);
    {
      // define size and format of level 0
      const level = 0;
      let internalFormat = this.ctx.RGBA;
      const border = 0;
      let format = this.ctx.RGBA;
      let t;
      if(this.texdepth === FrameBuffer.TEXTYPE_FLOAT) {
        const e = this.ctx.getExtension('OES_texture_float');
        t = this.ctx.FLOAT;
        // internalFormat = this.ctx.FLOAT;
        // format = this.ctx.FLOAT;
      } else if(this.texdepth &amp; FrameBuffer.TEXTYPE_HALF_FLOAT_OES) {
        // t = gl.renderer.isWebgl2 ? e.HALF_FLOAT : e.HALF_FLOAT_OES;
        //     gl.renderer.extensions['OES_texture_half_float'] ? gl.renderer.extensions['OES_texture_half_float'].HALF_FLOAT_OES : 
        //     gl.UNSIGNED_BYTE;
        const e = this.ctx.getExtension('OES_texture_half_float');
        t = this.renderer.isWebgl2 ? this.ctx.HALF_FLOAT : e.HALF_FLOAT_OES;
        // format = gl.RGBA;
        if(this.renderer.isWebgl2) {
          internalFormat = this.ctx.RGBA16F;
        }
        // internalFormat = gl.RGB32F;
        // format = gl.RGB32F;
        // window.gl = gl
        // t = e.HALF_FLOAT_OES;
      } else {
        t = this.ctx.UNSIGNED_BYTE;
      }
      const type = t;
      const data = this.data;
      this.ctx.texImage2D(this.ctx.TEXTURE_2D, level, internalFormat,
                    this.width*this.pxRatio, this.height*this.pxRatio, border,
                    format, type, data);
      // gl.generateMipmap(gl.TEXTURE_2D);

      // set the filtering so we don't need mips
      this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_MIN_FILTER, this.ctx.NEAREST);
      this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_MAG_FILTER, this.ctx.NEAREST);
      
      // Set the parameters based on the passed type
      if(this.tiling === Texture.IMAGETYPE_TILE) {
        this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_WRAP_S, this.ctx.REPEAT);
        this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_WRAP_T, this.ctx.REPEAT);
      } else if(this.tiling === Texture.IMAGETYPE_MIRROR) {
        this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_WRAP_S, this.ctx.MIRRORED_REPEAT);
        this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_WRAP_T, this.ctx.MIRRORED_REPEAT);
      } else if(this.tiling === Texture.IMAGETYPE_REGULAR) {
        this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_WRAP_S, this.ctx.CLAMP_TO_EDGE);
        this.ctx.texParameteri(this.ctx.TEXTURE_2D, this.ctx.TEXTURE_WRAP_T, this.ctx.CLAMP_TO_EDGE);
      }
    }
    
    // Create and bind the framebuffer
    const fb = this.ctx.createFramebuffer();
    this.ctx.bindFramebuffer(this.ctx.FRAMEBUFFER, fb);
    
    if(this.depthTesting) {
      var ext = this.ctx.getExtension('WEBGL_depth_texture');
      let depth = this.ctx.createTexture();
      this.ctx.bindTexture(this.ctx.TEXTURE_2D, depth);
      this.ctx.texImage2D(
        this.ctx.TEXTURE_2D, 0, this.ctx.DEPTH_COMPONENT, this.width*this.pxRatio, this.height*this.pxRatio, 0, this.ctx.DEPTH_COMPONENT, this.ctx.UNSIGNED_SHORT, null);
      this.ctx.framebufferTexture2D(this.ctx.FRAMEBUFFER, this.ctx.DEPTH_ATTACHMENT, this.ctx.TEXTURE_2D, depth, 0);
    }

    // attach the texture as the first color attachment
    const attachmentPoint = this.ctx.COLOR_ATTACHMENT0;
    const level = 0;
    this.ctx.framebufferTexture2D(
      this.ctx.FRAMEBUFFER, 
      attachmentPoint, 
      this.ctx.TEXTURE_2D, 
      targetTexture, 
      level);

    return {
      fb: fb,
      frameTexture: targetTexture
    };
  }
  bind() {
    // find the active texture based on the index
    let uniform = this.ctx.getUniformLocation(this.renderer.currentProgram.program, `</span></span>b_$<span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>#name<span class="token punctuation">}</span>`<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Set the texture unit to the uniform</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span>uniform<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">TEXTURE0</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Bind the texture</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#activeFB<span class="token punctuation">.</span>frameTexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Finally, ping-pong the texture</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#activeFB <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#activeFB <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#fb1 <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#fb2 <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#fb1<span class="token punctuation">;</span>
    
    <span class="token comment">// this.renderer.render(n, this.#activeFB);</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#activeFB<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">data</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Float32Array</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#data <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#data <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">width</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#width <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#width <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">height</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#height <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#height <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">pxRatio</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#pxRatio <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">pxRatio</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#pxRatio <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">tiling</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Texture<span class="token punctuation">.</span><span class="token constant">IMAGETYPE_REGULAR</span><span class="token punctuation">,</span> Texture<span class="token punctuation">.</span><span class="token constant">IMAGETYPE_TILE</span><span class="token punctuation">,</span> Texture<span class="token punctuation">.</span><span class="token constant">IMAGETYPE_MIRROR</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#tiling <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">tiling</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#tiling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">texdepth</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FrameBuffer<span class="token punctuation">.</span><span class="token constant">TEXTYPE_FLOAT</span><span class="token punctuation">,</span> FrameBuffer<span class="token punctuation">.</span><span class="token constant">TEXTYPE_UNSIGNED_BYTE</span><span class="token punctuation">,</span> FrameBuffer<span class="token punctuation">.</span><span class="token constant">TEXTYPE_HALF_FLOAT_OES</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#texdepth <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">texdepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#texdepth<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Camera</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">static</span> #defaultOptions <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    fov<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">,</span>
    aspect<span class="token punctuation">:</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">/</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">,</span>
    near<span class="token punctuation">:</span> <span class="token number">.5</span><span class="token punctuation">,</span>
    far<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    pos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    up<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  #fov
  #aspect
  #near
  #far
  #pos
  #target
  #up
  #updateDebounce
  
  #model
  #view
  #proj
  #<span class="token constant">MVP</span>
  
  #u_model
  #u_view
  #u_proj
  #u_MVP
  
  #q
  
  #name
  
  <span class="token function">constructor</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> name<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> Camera<span class="token punctuation">.</span>#defaultOptions<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderer <span class="token operator">=</span> renderer<span class="token punctuation">;</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> renderer<span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>fov <span class="token operator">=</span> options<span class="token punctuation">.</span>fov<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>aspect <span class="token operator">=</span> options<span class="token punctuation">.</span>aspect<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>near <span class="token operator">=</span> options<span class="token punctuation">.</span>near<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>far <span class="token operator">=</span> options<span class="token punctuation">.</span>far<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> options<span class="token punctuation">.</span>pos<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> options<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>up <span class="token operator">=</span> options<span class="token punctuation">.</span>up<span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">q</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Quat</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>#q <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>#model <span class="token operator">=</span> <span class="token function">quatToMat4</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#q<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>#u_model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> <span class="token string">'m_model'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_M4</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#model<span class="token punctuation">.</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">q</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#q <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">Quat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span>nt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#updateDebounce<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// this.#updateDebounce = setTimeout(() =&gt; {<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>#model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>#view <span class="token operator">=</span> Mat4<span class="token punctuation">.</span><span class="token function">lookAt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pos<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>up<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>#proj <span class="token operator">=</span> Mat4<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fov<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspect<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>near<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>far<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>#<span class="token constant">MVP</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#proj<span class="token punctuation">.</span><span class="token function">multiplyNew</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#view<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#model<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">this</span><span class="token punctuation">.</span>#u_view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> <span class="token string">'m_view'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_M4</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#view<span class="token punctuation">.</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>#u_proj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> <span class="token string">'m_proj'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_M4</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#proj<span class="token punctuation">.</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>#u_MVP <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> <span class="token string">'m_MVP'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_M4</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#<span class="token constant">MVP</span><span class="token punctuation">.</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">this</span><span class="token punctuation">.</span>setup <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// }, nt ? 0 : 50);</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">name</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#name <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#name <span class="token operator">||</span> <span class="token string">'camera'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">fov</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNaN</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#fov <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">fov</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#fov<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">aspect</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNaN</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#aspect <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">aspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#aspect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">near</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNaN</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#near <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">near</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#near<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">far</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNaN</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#far <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">far</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#far<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">pos</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Vec3</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#pos <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#pos<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">target</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Vec3</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#target <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">target</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">set</span> <span class="token function">up</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Vec3</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#up <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#up<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">u_model</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#u_model<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">u_view</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#u_view<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">u_proj</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#u_proj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">u_MVP</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#u_MVP<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">uniforms</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>u_model<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>u_view<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>u_proj<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>u_MVP<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> dimensions <span class="token operator">=</span> <span class="token punctuation">[</span>window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> texturesize <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> particles <span class="token operator">=</span> texturesize <span class="token operator">*</span> texturesize<span class="token punctuation">;</span>
<span class="token keyword">const</span> textureArraySize <span class="token operator">=</span> texturesize<span class="token operator">*</span>texturesize<span class="token operator">*</span><span class="token number">4.</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Renderer</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> width<span class="token punctuation">:</span> dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> alpha<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> premultipliedAlpha<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> preserveDrawingBuffer<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ctx <span class="token operator">=</span> renderer<span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>

<span class="token keyword">let</span> drawing <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">1.0</span><span class="token punctuation">,</span>   <span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token number">1.0</span><span class="token punctuation">,</span>   <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span>   <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>particles <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vertices<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  vertices<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  vertices<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span>vertices <span class="token operator">=</span> vertices<span class="token punctuation">;</span>
<span class="token keyword">let</span> references <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>particles <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> referenceIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> references<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> referenceIndex <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
  referenceIndex <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token punctuation">(</span>index <span class="token operator">%</span> texturesize<span class="token punctuation">)</span> <span class="token operator">/</span> texturesize<span class="token punctuation">;</span>
  <span class="token keyword">const</span> y <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>index <span class="token operator">/</span> texturesize<span class="token punctuation">)</span> <span class="token operator">/</span> texturesize<span class="token punctuation">;</span>
  
    <span class="token comment">// console.log(i, '----');</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span> j <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token comment">// console.log(i, i + j, i + j + 1);</span>
    <span class="token comment">// console.log(x, y);</span>
    <span class="token comment">// console.log('  ');</span>
    references<span class="token punctuation">[</span>i <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
    references<span class="token punctuation">[</span>i <span class="token operator">+</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> y<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> drawBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> drawing<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> particleBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> 
  attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
        name<span class="token punctuation">:</span> <span class="token string">'particle'</span><span class="token punctuation">,</span>
        numComponents<span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> referenceBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> references<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> 
  attributes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
        name<span class="token punctuation">:</span> <span class="token string">'reference'</span><span class="token punctuation">,</span>
        numComponents<span class="token punctuation">:</span> <span class="token number">2</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> vertexShader_particle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'vertexShader_particle'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
<span class="token keyword">const</span> vertexShader_buffer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'vertexShader_buffer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>

<span class="token keyword">const</span> programPosition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Program</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> vertexShader_buffer<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'fragmentShader_position'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>  
  renderType<span class="token punctuation">:</span> Program<span class="token punctuation">.</span><span class="token constant">RENDER_STRIP</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> programVelocity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Program</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> vertexShader_buffer<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'fragmentShader_velocity'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>  
  renderType<span class="token punctuation">:</span> Program<span class="token punctuation">.</span><span class="token constant">RENDER_STRIP</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> programBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Program</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> vertexShader_buffer<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'fragmentShader_buffer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> 
  clearColour<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">.1</span><span class="token punctuation">,</span><span class="token number">.1</span><span class="token punctuation">,</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
  <span class="token comment">// blending: Renderer.BLENDING_ADDITIVE, </span>
  depthTesting<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
  transparent<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  
  renderType<span class="token punctuation">:</span> Program<span class="token punctuation">.</span><span class="token constant">RENDER_STRIP</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> programBlur <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Program</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> vertexShader_buffer<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'fragmentShader_blur'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>  
  clearColour<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">.1</span><span class="token punctuation">,</span><span class="token number">.1</span><span class="token punctuation">,</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
  renderType<span class="token punctuation">:</span> Program<span class="token punctuation">.</span><span class="token constant">RENDER_STRIP</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> programBloom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Program</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> vertexShader_buffer<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'fragmentShader_bloom'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>  
  clearColour<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">.1</span><span class="token punctuation">,</span><span class="token number">.1</span><span class="token punctuation">,</span><span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
  renderType<span class="token punctuation">:</span> Program<span class="token punctuation">.</span><span class="token constant">RENDER_STRIP</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> programMain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Program</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> vertexShader_particle<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'fragmentShader_particle'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> 
  clearColour<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">.05</span><span class="token punctuation">,</span> <span class="token number">.15</span><span class="token punctuation">,</span> <span class="token number">.35</span><span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
  <span class="token comment">// renderType: Program.RENDER_POINTS, </span>
  renderType<span class="token punctuation">:</span> Program<span class="token punctuation">.</span><span class="token constant">RENDER_TRIANGLES</span><span class="token punctuation">,</span> 
  <span class="token comment">// blending: Renderer.BLENDING_MULTIPLY, </span>
  depthTesting<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
  transparent<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">'time'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_FLOAT</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uDelta <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">'delta'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_FLOAT</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mouse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">'mouse'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_V2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.</span><span class="token punctuation">,</span><span class="token number">0.</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> frame <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">'frame'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_INT</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> nsize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">'nsize'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_FLOAT</span><span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> nreset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">'nreset'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_BOOL</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> transition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">'transition'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_BOOL</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> transition_val <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">'transition_val'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_FLOAT</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bloomstep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">'bloomstep'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_INT</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> seed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uniform</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">'seed'</span><span class="token punctuation">,</span> Uniform<span class="token punctuation">.</span><span class="token constant">TYPE_FLOAT</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> originData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>particles <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> positionData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>particles <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> velocityData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>particles <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> bailout <span class="token operator">=</span> <span class="token number">0.</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> radius <span class="token operator">=</span> <span class="token number">5.</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> minRadius <span class="token operator">=</span> <span class="token number">1.</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> rn <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> phi <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token number">2.</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> costheta <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.</span> <span class="token operator">-</span> <span class="token number">1.</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> u <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> theta <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">acos</span><span class="token punctuation">(</span> costheta <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// let r = radius * Math.max(.8, Math.min(Math.cbrt( u ), .85));</span>
  <span class="token keyword">let</span> r <span class="token operator">=</span> radius <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cbrt</span><span class="token punctuation">(</span> u <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> x <span class="token operator">=</span> r <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span> theta <span class="token punctuation">)</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span> phi <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> y <span class="token operator">=</span> r <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span> theta <span class="token punctuation">)</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span> phi <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> z <span class="token operator">=</span> r <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span> theta <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
  const posit = new Vec2(z, x);
  if(Math.abs(y) &gt; .5) {
    bailout++;
    if(bailout &gt;= 100.) return;
    else {
      create(i);
      return;
    }
  } else {
    bailout = 0.;
  }*/</span>

  positionData<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
  positionData<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> y<span class="token punctuation">;</span>
  positionData<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> z<span class="token punctuation">;</span>
  positionData<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  
  originData<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
  originData<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> y<span class="token punctuation">;</span>
  originData<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> z<span class="token punctuation">;</span>
  originData<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  
  velocityData<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
  velocityData<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> y<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
  velocityData<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> z<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>
  velocityData<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> textureArraySize<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">create</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> primarybuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FrameBuffer</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> <span class="token string">'prime'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  width<span class="token punctuation">:</span> dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  height<span class="token punctuation">:</span> dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// tiling: Texture.IMAGETYPE_TILE,</span>
  tiling<span class="token punctuation">:</span> Texture<span class="token punctuation">.</span><span class="token constant">IMAGETYPE_REGULAR</span><span class="token punctuation">,</span>
  texdepth<span class="token punctuation">:</span> FrameBuffer<span class="token punctuation">.</span><span class="token constant">TEXTYPE_FLOAT</span><span class="token punctuation">,</span>
  pxRatio<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>devicePixelRatio<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  depthTesting<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> blurBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FrameBuffer</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> <span class="token string">'blur'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  width<span class="token punctuation">:</span> dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  height<span class="token punctuation">:</span> dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// tiling: Texture.IMAGETYPE_TILE,</span>
  tiling<span class="token punctuation">:</span> Texture<span class="token punctuation">.</span><span class="token constant">IMAGETYPE_REGULAR</span><span class="token punctuation">,</span>
  texdepth<span class="token punctuation">:</span> FrameBuffer<span class="token punctuation">.</span><span class="token constant">TEXTYPE_FLOAT</span><span class="token punctuation">,</span>
  pxRatio<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>devicePixelRatio<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  depthTesting<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bloomBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FrameBuffer</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> <span class="token string">'bloom'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  width<span class="token punctuation">:</span> dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  height<span class="token punctuation">:</span> dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// tiling: Texture.IMAGETYPE_TILE,</span>
  tiling<span class="token punctuation">:</span> Texture<span class="token punctuation">.</span><span class="token constant">IMAGETYPE_REGULAR</span><span class="token punctuation">,</span>
  texdepth<span class="token punctuation">:</span> FrameBuffer<span class="token punctuation">.</span><span class="token constant">TEXTYPE_FLOAT</span><span class="token punctuation">,</span>
  pxRatio<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>devicePixelRatio<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> positionBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FrameBuffer</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> <span class="token string">'position'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  width<span class="token punctuation">:</span> texturesize<span class="token punctuation">,</span>
  height<span class="token punctuation">:</span> texturesize<span class="token punctuation">,</span>
  <span class="token comment">// tiling: Texture.IMAGETYPE_TILE,</span>
  tiling<span class="token punctuation">:</span> Texture<span class="token punctuation">.</span><span class="token constant">IMAGETYPE_TILE</span><span class="token punctuation">,</span>
  texdepth<span class="token punctuation">:</span> FrameBuffer<span class="token punctuation">.</span><span class="token constant">TEXTYPE_FLOAT</span><span class="token punctuation">,</span>
  pxRatio<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> positionData
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> velocityBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FrameBuffer</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> <span class="token string">'velocity'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  width<span class="token punctuation">:</span> texturesize<span class="token punctuation">,</span>
  height<span class="token punctuation">:</span> texturesize<span class="token punctuation">,</span>
  <span class="token comment">// tiling: Texture.IMAGETYPE_TILE,</span>
  tiling<span class="token punctuation">:</span> Texture<span class="token punctuation">.</span><span class="token constant">IMAGETYPE_TILE</span><span class="token punctuation">,</span>
  texdepth<span class="token punctuation">:</span> FrameBuffer<span class="token punctuation">.</span><span class="token constant">TEXTYPE_FLOAT</span><span class="token punctuation">,</span>
  pxRatio<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> velocityData
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> originBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FrameBuffer</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> <span class="token string">'origin'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  width<span class="token punctuation">:</span> texturesize<span class="token punctuation">,</span>
  height<span class="token punctuation">:</span> texturesize<span class="token punctuation">,</span>
  <span class="token comment">// tiling: Texture.IMAGETYPE_TILE,</span>
  tiling<span class="token punctuation">:</span> Texture<span class="token punctuation">.</span><span class="token constant">IMAGETYPE_TILE</span><span class="token punctuation">,</span>
  texdepth<span class="token punctuation">:</span> FrameBuffer<span class="token punctuation">.</span><span class="token constant">TEXTYPE_FLOAT</span><span class="token punctuation">,</span>
  pxRatio<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> originData
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cp<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> compositions <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> <span class="token number">50</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> <span class="token number">20</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> <span class="token number">40</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> <span class="token number">20</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> <span class="token number">50</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> <span class="token number">40</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> <span class="token number">15</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> <span class="token number">40</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> <span class="token number">40</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> cp<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scaleNew</span><span class="token punctuation">(</span><span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> cp<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> <span class="token number">30</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> <span class="token number">30</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> <span class="token number">30</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> cam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Camera</span><span class="token punctuation">(</span>renderer<span class="token punctuation">,</span> <span class="token string">'main'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> fov<span class="token punctuation">:</span> <span class="token number">1.8</span><span class="token punctuation">,</span> far<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span> aspect<span class="token punctuation">:</span> dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">/</span>dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> camop <span class="token operator">=</span> compositions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> camtime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pointerdown <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pointermoving <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pointerTimeout<span class="token punctuation">;</span>
<span class="token keyword">let</span> lastPos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vec2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pointerdown'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  pointerdown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  pointerTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    pointermoving <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
  lastPos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vec2</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>x<span class="token punctuation">,</span> e<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pointerup'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  pointerdown <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  pointerTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    pointermoving <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token function">clearTimeout</span><span class="token punctuation">(</span>pointerTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pointermove'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>pointerdown<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> newPos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vec2</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>x<span class="token punctuation">,</span> e<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> diff <span class="token operator">=</span> newPos<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>lastPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lastPos <span class="token operator">=</span> newPos<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> q <span class="token operator">=</span> cam<span class="token punctuation">.</span>q<span class="token punctuation">;</span>
    q<span class="token punctuation">.</span><span class="token function">rotateY</span><span class="token punctuation">(</span>diff<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    q<span class="token punctuation">.</span><span class="token function">rotateX</span><span class="token punctuation">(</span>diff<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cam<span class="token punctuation">.</span>q <span class="token operator">=</span> q<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//   let q = cam.q;</span>
  
<span class="token comment">//       this.#u_model = new Uniform(this.ctx, 'm_model', Uniform.TYPE_M4, this.#model.array);</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> playing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">setPlaying</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  playing <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> playpause <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.playpause'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> playpauseCheck <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.playpause input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
playpauseCheck<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  playpause<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">toggle</span><span class="token punctuation">(</span><span class="token string">'checked'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>checked<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setPlaying</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>checked<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> autoTransitionTimer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> timeToTransition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">setupValues</span> <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  transition<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  nsize<span class="token punctuation">.</span>value <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.5</span> <span class="token operator">+</span> <span class="token number">.1</span><span class="token punctuation">;</span>
  nreset<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
  dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
  cam<span class="token punctuation">.</span>aspect <span class="token operator">=</span> dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">/</span>dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// camop = compositions[i];,</span>
  camop <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    pos<span class="token punctuation">:</span> compositions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pos<span class="token punctuation">.</span><span class="token function">scaleNew</span><span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    target<span class="token punctuation">:</span> compositions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">scaleNew</span><span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endPos<span class="token punctuation">:</span> compositions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>endPos<span class="token punctuation">.</span><span class="token function">scaleNew</span><span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    endTarget<span class="token punctuation">:</span> compositions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>endTarget<span class="token punctuation">.</span><span class="token function">scaleNew</span><span class="token punctuation">(</span><span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    time<span class="token punctuation">:</span> compositions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>time
  <span class="token punctuation">}</span>
  cam<span class="token punctuation">.</span>pos <span class="token operator">=</span> camop<span class="token punctuation">.</span>pos<span class="token punctuation">;</span>
  cam<span class="token punctuation">.</span>target <span class="token operator">=</span> camop<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
  cam<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cam<span class="token punctuation">.</span>q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Quat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  camtime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  renderer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  primarybuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  blurBuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  time<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">10000</span><span class="token punctuation">;</span>
  seed<span class="token punctuation">.</span>value <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">1000.</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    seed<span class="token punctuation">.</span>value <span class="token operator">+=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.5</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  timeToTransition <span class="token operator">=</span> camop<span class="token punctuation">.</span>time<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
  autoTransitionTimer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// autoTransitionTimer = setTimeout(setupTransition, );</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">setupTransition</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>transition<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token function">clearTimeout</span><span class="token punctuation">(</span>autoTransitionTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  transition<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  transition_val<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">setupValues</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>compositions<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setupValues</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> oldpos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>playing <span class="token operator">!==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>pointermoving <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token function">setupTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> timeout<span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth<span class="token punctuation">;</span>
    dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>
    cam<span class="token punctuation">.</span>aspect <span class="token operator">=</span> dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">/</span>dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    cam<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    renderer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    primarybuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    blurBuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bloomBuffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dimensions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> <span class="token function-variable function">cubeInOut</span> <span class="token operator">=</span> d <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">4</span> <span class="token operator">*</span> d<span class="token operator">**</span><span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span> <span class="token operator">*</span> d <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">3</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> opx <span class="token operator">=</span> renderer<span class="token punctuation">.</span>pxRatio<span class="token punctuation">;</span>
<span class="token keyword">let</span> then <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// let framenum = 0;</span>
<span class="token comment">// let framesPerFrame = 10;</span>
<span class="token comment">// let gif = new gifJs({<!-- --></span>
<span class="token comment">//   workers: 2,</span>
<span class="token comment">//   quality: 10</span>
<span class="token comment">// });</span>
<span class="token comment">// gif.on('finished', function(blob) {<!-- --></span>
<span class="token comment">//   console.log('ss')</span>
<span class="token comment">//   window.open(URL.createObjectURL(blob));</span>
<span class="token comment">// });</span>

<span class="token comment">// const offscreenCanvas = document.createElement("canvas");</span>
<span class="token comment">// offscreenCanvas.className = 'osc';</span>
<span class="token comment">// offscreenCanvas.width = canvas.width;</span>
<span class="token comment">// offscreenCanvas.height = canvas.height;</span>
<span class="token comment">// const osctx = offscreenCanvas.getContext("2d");</span>
<span class="token comment">// document.body.appendChild(offscreenCanvas);</span>

<span class="token keyword">let</span> gifDone <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span>delta<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  
<span class="token comment">//   if(framenum &lt; 10 * framesPerFrame) {<!-- --></span>
<span class="token comment">//     if(framenum % framesPerFrame == 0) {<!-- --></span>
<span class="token comment">//       // gif.addFrame(canvas, {delay: 100});</span>

<span class="token comment">//       osctx.drawImage(canvas,0,0);</span>

<span class="token comment">//       gif.addFrame(offscreenCanvas, {copy: true, delay: 100});</span>
<span class="token comment">//       // gif.addFrame(ctx, {copy: true});</span>
<span class="token comment">//     }</span>
<span class="token comment">//     framenum++;</span>
<span class="token comment">//   } else if(gifDone === false) {<!-- --></span>
<span class="token comment">//     console.log(framenum)</span>

<span class="token comment">//     gif.render();</span>
    
<span class="token comment">//     window.gif = gif;</span>
    
<span class="token comment">//     gifDone = true;</span>
<span class="token comment">//   }</span>
  
	<span class="token keyword">let</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
	<span class="token keyword">let</span> _delta <span class="token operator">=</span> now <span class="token operator">-</span> then<span class="token punctuation">;</span>
	then <span class="token operator">=</span> now<span class="token punctuation">;</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span>_delta <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  
  <span class="token keyword">if</span><span class="token punctuation">(</span>playing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">// timeToTransition = camop.time*1000;</span>
    autoTransitionTimer <span class="token operator">+=</span> _delta<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>autoTransitionTimer <span class="token operator">&gt;</span> timeToTransition<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      timeToTransition <span class="token operator">=</span> <span class="token number">Infinity</span><span class="token punctuation">;</span>
      <span class="token function">setupTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    bloomstep<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    uDelta<span class="token punctuation">.</span>value <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>_delta<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    time<span class="token punctuation">.</span>value <span class="token operator">+=</span> _delta <span class="token operator">*</span> <span class="token number">.05</span><span class="token punctuation">;</span>

    frame<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>transition<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      transition_val<span class="token punctuation">.</span>value <span class="token operator">+=</span> _delta <span class="token operator">*</span> <span class="token number">.5</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>transition_val<span class="token punctuation">.</span>value <span class="token operator">&gt;=</span> <span class="token number">0.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      transition_val<span class="token punctuation">.</span>value <span class="token operator">-=</span> _delta <span class="token operator">*</span> <span class="token number">.5</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    camtime <span class="token operator">+=</span> _delta<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>camtime <span class="token operator">&lt;=</span> camop<span class="token punctuation">.</span>time <span class="token operator">&amp;&amp;</span> camop<span class="token punctuation">.</span>endPos<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> ntime <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>camtime<span class="token operator">/</span>camop<span class="token punctuation">.</span>time<span class="token punctuation">,</span> <span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> tween <span class="token operator">=</span> <span class="token function">cubeInOut</span><span class="token punctuation">(</span>ntime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cam<span class="token punctuation">.</span>pos <span class="token operator">=</span> Vec3<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>camop<span class="token punctuation">.</span>pos<span class="token punctuation">,</span> camop<span class="token punctuation">.</span>endPos<span class="token punctuation">,</span> tween<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cam<span class="token punctuation">.</span>target <span class="token operator">=</span> Vec3<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>camop<span class="token punctuation">.</span>target<span class="token punctuation">,</span> camop<span class="token punctuation">.</span>endTarget<span class="token punctuation">,</span> tween<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cam<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    renderer<span class="token punctuation">.</span><span class="token function">setViewport</span><span class="token punctuation">(</span><span class="token punctuation">[</span>velocityBuffer<span class="token punctuation">.</span>width<span class="token punctuation">,</span> velocityBuffer<span class="token punctuation">.</span>height<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    renderer<span class="token punctuation">.</span><span class="token function">setupProgram</span><span class="token punctuation">(</span>programVelocity<span class="token punctuation">,</span> <span class="token punctuation">[</span>drawBuffer<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>time<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> mouse<span class="token punctuation">,</span> velocityBuffer<span class="token punctuation">,</span> positionBuffer<span class="token punctuation">,</span> nsize<span class="token punctuation">,</span> seed<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    velocityBuffer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    renderer<span class="token punctuation">.</span><span class="token function">setupProgram</span><span class="token punctuation">(</span>programPosition<span class="token punctuation">,</span> <span class="token punctuation">[</span>drawBuffer<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>time<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> mouse<span class="token punctuation">,</span> velocityBuffer<span class="token punctuation">,</span> positionBuffer<span class="token punctuation">,</span> uDelta<span class="token punctuation">,</span> originBuffer<span class="token punctuation">,</span> nreset<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    positionBuffer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  renderer<span class="token punctuation">.</span><span class="token function">setViewport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  renderer<span class="token punctuation">.</span><span class="token function">setupProgram</span><span class="token punctuation">(</span>programMain<span class="token punctuation">,</span> <span class="token punctuation">[</span>particleBuffer<span class="token punctuation">,</span> referenceBuffer<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>time<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> mouse<span class="token punctuation">,</span> velocityBuffer<span class="token punctuation">,</span> primarybuffer<span class="token punctuation">,</span> positionBuffer<span class="token punctuation">,</span> <span class="token operator">...</span>cam<span class="token punctuation">.</span>uniforms<span class="token punctuation">,</span> transition<span class="token punctuation">,</span> transition_val<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  primarybuffer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>particles <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// renderer.render(particles * 6);</span>
  
  renderer<span class="token punctuation">.</span><span class="token function">setupProgram</span><span class="token punctuation">(</span>programBlur<span class="token punctuation">,</span> <span class="token punctuation">[</span>drawBuffer<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>time<span class="token punctuation">,</span> mouse<span class="token punctuation">,</span> primarybuffer<span class="token punctuation">,</span> positionBuffer<span class="token punctuation">,</span> blurBuffer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  blurBuffer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// bloomstep.value = 0;</span>
  <span class="token comment">// renderer.setupProgram(programBloom, [drawBuffer], [], [time, mouse, primarybuffer, positionBuffer, blurBuffer, bloomstep, bloomBuffer]);</span>
  <span class="token comment">// bloomBuffer.render(4);</span>
  <span class="token comment">// bloomstep.value = 1;</span>
  <span class="token comment">// renderer.setupProgram(programBloom, [drawBuffer], [], [time, mouse, primarybuffer, positionBuffer, blurBuffer, bloomstep, bloomBuffer]);</span>
  <span class="token comment">// bloomBuffer.render(4);</span>
  
  renderer<span class="token punctuation">.</span><span class="token function">setupProgram</span><span class="token punctuation">(</span>programBuffer<span class="token punctuation">,</span> <span class="token punctuation">[</span>drawBuffer<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>time<span class="token punctuation">,</span> mouse<span class="token punctuation">,</span> primarybuffer<span class="token punctuation">,</span> positionBuffer<span class="token punctuation">,</span> bloomBuffer<span class="token punctuation">,</span> blurBuffer<span class="token punctuation">,</span> transition<span class="token punctuation">,</span> transition_val<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  renderer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  nreset<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cc7c83b46010c3863ce2feb8f1d4af3e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">万字长文，38 图爆肝 Redis 基础！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1e36f8d8298cdfeac34963938980cfc5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">标题Ant Design of Vue 组件库中Modal“确认“按钮和“取消“按钮成英文状态</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>