<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>laravel5.8整合JWT - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="laravel5.8整合JWT" />
<meta property="og:description" content="记录一次laravel5.8开发的API接口，引入JWT的流程。
laravel&#43;JWT的整合教程在网上有很多，根据网上的教程整合期间，还是踩了很多坑。
虽然这些坑都能在网上搜索到解决办法，但网上的其他教程都没有注明需要注意的点在哪里。
开始之前，先放两个链接。
jwt-auth for laravel的安装与使用.
JWT 完整使用详解【这篇很详细，讲得也很到位，基本看这篇就够了】.
我也是根据这几篇文章进行的整合。
laravel中使用的是jwt-auth库，那么先安装:
step1:
# 建议使用1.0以上版本 composer require tymon/jwt-auth step2：发布配置文件
# 这条命令会在 config 下增加一个 jwt.php 的配置文件 php artisan vendor:publish --provider=&#34;Tymon\JWTAuth\Providers\LaravelServiceProvider&#34; step3: 生成加密密钥
# 这条命令会在 .env 文件下生成一个加密密钥，如：JWT_SECRET=foobar php artisan jwt:secret step4：更新校验用户登录的模型
以User为例:
&lt;?php namespace App; use Illuminate\Database\Eloquent\Model; use Illuminate\Notifications\Notifiable; use Tymon\JWTAuth\Contracts\JWTSubject; use Illuminate\Foundation\Auth\User as Authenticatable; class User extends Authenticatable implements JWTSubject { use Notifiable; /** * 可以被批量赋值的属性. * @var array */ protected $fillable = []; protected $hidden = []; /** * 关联到模型的数据表 * * @var string */ protected $table = &#39;&#39;; /** * 表明模型是否应该被打上时间戳 * * @var bool */ public $timestamps = false; /** * Get the identifier that will be stored in the subject claim of the JWT." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/b2fd1820fcaa1f5c2b514d6883c5d2fc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-11T16:26:15+08:00" />
<meta property="article:modified_time" content="2020-06-11T16:26:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">laravel5.8整合JWT</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>记录一次laravel5.8开发的API接口，引入JWT的流程。<br> laravel+JWT的整合教程在网上有很多，根据网上的教程整合期间，还是踩了很多坑。<br> 虽然这些坑都能在网上搜索到解决办法，但网上的其他教程都没有注明需要注意的点在哪里。</p> 
<p>开始之前，先放两个链接。</p> 
<p><a href="https://blog.csdn.net/yt_php/article/details/86354133">jwt-auth for laravel的安装与使用</a>.<br> <a href="https://learnku.com/articles/10885/full-use-of-jwt" rel="nofollow">JWT 完整使用详解【这篇很详细，讲得也很到位，基本看这篇就够了】</a>.</p> 
<p>我也是根据这几篇文章进行的整合。</p> 
<p>laravel中使用的是jwt-auth库，那么先安装:<br> step1:</p> 
<pre><code class="prism language-javascript"># 建议使用<span class="token number">1.0</span>以上版本
composer require tymon<span class="token operator">/</span>jwt<span class="token operator">-</span>auth
</code></pre> 
<p>step2：发布配置文件</p> 
<pre><code class="prism language-javascript"># 这条命令会在 config 下增加一个 jwt<span class="token punctuation">.</span>php 的配置文件
php artisan vendor<span class="token punctuation">:</span>publish <span class="token operator">--</span>provider<span class="token operator">=</span><span class="token string">"Tymon\JWTAuth\Providers\LaravelServiceProvider"</span>
</code></pre> 
<p>step3: 生成加密密钥</p> 
<pre><code class="prism language-javascript"># 这条命令会在 <span class="token punctuation">.</span>env 文件下生成一个加密密钥，如：<span class="token constant">JWT_SECRET</span><span class="token operator">=</span>foobar
php artisan jwt<span class="token punctuation">:</span>secret
</code></pre> 
<p>step4：更新校验用户登录的模型<br> 以User为例:</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span><span class="token operator">?</span>php

namespace App<span class="token punctuation">;</span>

use Illuminate\Database\Eloquent\Model<span class="token punctuation">;</span>
use Illuminate\Notifications\Notifiable<span class="token punctuation">;</span>
use Tymon\JWTAuth\Contracts\JWTSubject<span class="token punctuation">;</span>
use Illuminate\Foundation\Auth\User <span class="token keyword">as</span> Authenticatable<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Authenticatable</span> <span class="token keyword">implements</span> <span class="token class-name">JWTSubject</span>
<span class="token punctuation">{<!-- --></span>
    use Notifiable<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 可以被批量赋值的属性.
     * @var array
     */</span>
    <span class="token keyword">protected</span> $fillable <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> $hidden   <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 关联到模型的数据表
     *
     * @var string
     */</span>
    <span class="token keyword">protected</span> $table <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 表明模型是否应该被打上时间戳
     *
     * @var bool
     */</span>
    <span class="token keyword">public</span> $timestamps <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Get the identifier that will be stored in the subject claim of the JWT.
     *
     * @return mixed
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getJWTIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return a key value array, containing any custom claims to be added to the JWT.
     *
     * @return array
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getJWTCustomClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 覆盖Laravel中默认的getAuthPassword方法, 可返回自己需要的字段.
     * @return array

    public function getAuthPassword(){
        return ['password'=&gt;$this-&gt;attributes['password'], 'phone'=&gt;$this-&gt;attributes['phone']];
    }*/</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>当然，这里也可以不用user，你可以创建你自己的用于登录校验的模型。<br> 后面jwt-auth进行登录校验时，会使用到这个模型。</p> 
<p>step5: 修改auth.php</p> 
<pre><code class="prism language-javascript">    <span class="token comment">// 这里定义可以用的 guard(看守器)</span>
    <span class="token comment">// driver 指的就是上面的对 Guard 契约的具体实现那个类了</span>
    <span class="token comment">// users 是下面 providers 数组 key 为 users 的那个</span>
    <span class="token string">'guards'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string">'web'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
            <span class="token string">'driver'</span> <span class="token operator">=&gt;</span> <span class="token string">'session'</span><span class="token punctuation">,</span>
            <span class="token string">'provider'</span> <span class="token operator">=&gt;</span> <span class="token string">'users'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token string">'api'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
            <span class="token string">'driver'</span> <span class="token operator">=&gt;</span> <span class="token string">'jwt'</span><span class="token punctuation">,</span> <span class="token comment">// 这里原是token，改为jwt</span>
            <span class="token string">'provider'</span> <span class="token operator">=&gt;</span> <span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token comment">// 这里的user指的是下面providers中配置的users</span>
            <span class="token comment">//'hash' =&gt; false,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'providers'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string">'users'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
            <span class="token string">'driver'</span> <span class="token operator">=&gt;</span> <span class="token string">'eloquent'</span><span class="token punctuation">,</span> <span class="token comment">// 这里使用的用户提供器，默认是EloquentUserProvider.</span>
            <span class="token string">'model'</span> <span class="token operator">=&gt;</span> App\User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token comment">// 这个的作用是指定认证所需的 user 来源的数据表，可根据需要修改为你自己需要认证用户的模型.</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// 'users' =&gt; [</span>
        <span class="token comment">//     'driver' =&gt; 'database',</span>
        <span class="token comment">//     'table' =&gt; 'users',</span>
        <span class="token comment">// ],</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> 
<p><strong>划重点：<br> 1. 因为是用的API接口，使用guards（看守器）中的api中的driver要改为jwt.<br> 2. providers中users中配置的model，需指向关联用户的模型。关联用户的模型需extends Illuminate\Foundation\Auth\User 并 implements JWTSubject，并重写getJWTIdentifier()和getJWTCustomClaims()，如上面的User模型。</strong></p> 
<pre><code>以上就是配置过程。
好，接下来，我们就来看看laravel中怎么使用jwt。
</code></pre> 
<p>先来个controller，同样来自这个<a href="https://learnku.com/articles/10885/full-use-of-jwt" rel="nofollow">JWT 完整使用详解【这篇很详细，讲得也很到位，基本看这篇就够了】</a>：</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span><span class="token operator">?</span>php

namespace App\Http\Controllers<span class="token punctuation">;</span>

use App\User<span class="token punctuation">;</span>
use Illuminate\Http\Request<span class="token punctuation">;</span>
use Illuminate\Support\Facades\Auth<span class="token punctuation">;</span>
use Tymon\JWTAuth\Facades\JWTAuth<span class="token punctuation">;</span>
use Log<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * Create a new AuthController instance.
     * 要求附带email和password（数据来源users表）
     *
     * @return void
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 这里额外注意了：官方文档样例中只除外了『login』</span>
        <span class="token comment">// 这样的结果是，token 只能在有效期以内进行刷新，过期无法刷新</span>
        <span class="token comment">// 如果把 refresh 也放进去，token 即使过期但仍在刷新期以内也可刷新</span>
        <span class="token comment">// 不过刷新一次作废</span>
        <span class="token comment">//$this-&gt;middleware('auth:api', ['except' =&gt; ['login']]);</span>
        <span class="token comment">// 另外关于上面的中间件，官方文档写的是『auth:api』</span>
        <span class="token comment">// 但是我推荐用 『jwt.auth』，效果是一样的，但是有更加丰富的报错信息返回</span>
        <span class="token comment">// auth:api   auth指的是中间件 App\Http\Kernel中$routeMiddleware定义的。而后面 :api 是路由参数，指定了要使用哪个看守器，可以看到下面 api 对应的看守器就是 jwt 的看守器。</span>
        <span class="token comment">// 并且你可以直接使用 auth ，这样就相当于使用 defaults 中指定的看守器，即 session。</span>
        <span class="token comment">// Lumen 默认用的就是 api 那个，所以你直接用 auth 作为 api 路由的中间件完全没问题</span>
        <span class="token comment">// Laravel 中指定了两个看守器，而且默认的并不是 api，所以你必须得用 auth:api 作为路由的中间件</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Get a JWT via given credentials.
     *
     * @return \Illuminate\Http\JsonResponse
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

        $credentials <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * 这里创建token有三种方式
         * 1. 基于账密参数
         **/</span>
         $token <span class="token operator">=</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">'api'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">attempt</span><span class="token punctuation">(</span>$credentials<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* 2. 基于 users 模型返回的实例
            $user = User::where([
                ['phone', $credentials['phone'], ['password', $credentials['password']]]
            ])-&gt;first();
          $token = auth('api')-&gt;login($user);
         */</span>

        <span class="token comment">/* 3. 基于 users 模型中的主键 id
          $token = auth('api')-&gt;tokenById($user-&gt;id);
         */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'error'</span> <span class="token operator">=&gt;</span> <span class="token string">'Unauthorized'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string">'access_token'</span> <span class="token operator">=&gt;</span> $token<span class="token punctuation">,</span>
            <span class="token string">'token_type'</span>   <span class="token operator">=&gt;</span> <span class="token string">'bearer'</span><span class="token punctuation">,</span>
            <span class="token string">'expires_in'</span>   <span class="token operator">=&gt;</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">'api'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getTTL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// return $this-&gt;respondWithToken($token);</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Get the authenticated User.
     *
     * @return \Illuminate\Http\JsonResponse
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        $user <span class="token operator">=</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">'api'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $r<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> $user<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">json</span><span class="token punctuation">(</span>$r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Log the user out (Invalidate the token).
     *
     * @return \Illuminate\Http\JsonResponse
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">logout</span><span class="token punctuation">(</span>Request $request<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        $token <span class="token operator">=</span> $request<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            JWTAuth<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">invalidate</span><span class="token punctuation">(</span>JWTAuth<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token string">"status"</span> <span class="token operator">=&gt;</span> <span class="token string">"success"</span><span class="token punctuation">,</span>
                <span class="token string">"message"</span><span class="token operator">=&gt;</span> <span class="token string">"User successfully logged out."</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JWTException</span> $e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// something went wrong whilst attempting to encode the token</span>
            <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token string">"status"</span> <span class="token operator">=&gt;</span> <span class="token string">"error"</span><span class="token punctuation">,</span>
                <span class="token string">"message"</span> <span class="token operator">=&gt;</span> <span class="token string">"Failed to logout, please try again."</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">//auth('api')-&gt;logout();  使用该方法，注销无效。</span>

        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'message'</span> <span class="token operator">=&gt;</span> <span class="token string">'Successfully logged out'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Refresh a token.
     * 刷新token，如果开启黑名单，以前的token便会失效。
     * 值得注意的是用上面的getToken再获取一次Token并不算做刷新，两次获得的Token是并行的，即两个都可用。
     * @return \Illuminate\Http\JsonResponse
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">respondWithToken</span><span class="token punctuation">(</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">'api'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Get the token array structure.
     *
     * @param  string $token
     *
     * @return \Illuminate\Http\JsonResponse
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">respondWithToken</span><span class="token punctuation">(</span>$token<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string">'access_token'</span> <span class="token operator">=&gt;</span> $token<span class="token punctuation">,</span>
            <span class="token string">'token_type'</span>   <span class="token operator">=&gt;</span> <span class="token string">'bearer'</span><span class="token punctuation">,</span>
            <span class="token string">'expires_in'</span>   <span class="token operator">=&gt;</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">'api'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getTTL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">60</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>然后添加路由：</p> 
<pre><code class="prism language-javascript"><span class="token comment">/* jwt 测试*/</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'/auth/login'</span><span class="token punctuation">,</span> <span class="token string">'\App\Http\Controllers\AuthController@login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 需要登录后访问的接口放这里</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'jwt.auth:api'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token string">'auth'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'/logout'</span><span class="token punctuation">,</span> <span class="token string">'\App\Http\Controllers\AuthController@logout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'/refresh'</span><span class="token punctuation">,</span> <span class="token string">'\App\Http\Controllers\AuthController@refresh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'/findUser'</span><span class="token punctuation">,</span> <span class="token string">'\App\Http\Controllers\AuthController@me'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>laravel中api接口的地址默认会加上前缀/api，所以我的测试路由地址如下：</p> 
<pre><code class="prism language-javascript"><span class="token operator">/</span>api<span class="token operator">/</span>auth<span class="token operator">/</span>login   #登录
<span class="token operator">/</span>api<span class="token operator">/</span>auth<span class="token operator">/</span>logout  #注销
<span class="token operator">/</span>api<span class="token operator">/</span>auth<span class="token operator">/</span>refresh #刷新token
<span class="token operator">/</span>api<span class="token operator">/</span>auth<span class="token operator">/</span>findUser #刷新查询登录用户信息
</code></pre> 
<p>直接使用postman进行测试，关于postman大家可自行搜索，网上都有教程。<br> 先测试登录接口。<br> 希望一切顺利。<br> <img src="https://images2.imgbox.com/40/1c/YFpjpkIS_o.png" alt="测试登录接口截图"><br> 接口直接返回401 unauthorized，出现问题。<br> 先怀疑账号密码错误，经再三确认，账号密码没错。排除嫌疑。<br> 那就是jwt认证用户的问题了。<br> 开始分析AuthController中的login方法。login方法很简单，如下：</p> 
<pre><code class="prism language-javascript">    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 这里只接收参数</span>
        $credentials <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'phone'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> $token <span class="token operator">=</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">'api'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">attempt</span><span class="token punctuation">(</span>$credentials<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'error'</span> <span class="token operator">=&gt;</span> <span class="token string">'Unauthorized'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">respondWithToken</span><span class="token punctuation">(</span>$token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>那就是，auth(‘api’)-&gt;attempt()返回的问题了。</p> 
<p>进一步定位，发现auth(‘api’)-&gt;attempt($credentials)返回的是false。<br> auth(‘api’)就是使用我们在auth.php中配置的key为api的看守器，可以理解为返回了一个jwt的guard。<br> attempt()返回false，有哪些情况呢?</p> 
<p>一路跟踪源码，发现最终是，Illuminate\Hashing\AbstractHasher中的check(）方法返回的false。<br> 返回false的语句是：password_verify($value, $hashedValue)。<br> 好吧，就是密码校验返回的false。</p> 
<p>为什么输入密码正确，但auth(‘api’)-&gt;attempt()却校验密码返回false呢？<br> 网上搜索。<br> 然后一片文章出现在眼前，还是先放链接：<a href="https://www.cnblogs.com/mzli/p/11975913.html" rel="nofollow">laravel jwttoken jwt attempt laravel auth-&gt;attempt() 返回false</a>.</p> 
<p>问题定位成功：密码校验方式问题。<br> auth(‘api’)-&gt;attempt()默认的加密方式为Bcrypt，bcrypt又名HASH::make()，laravel框架中默认的加密方式就是HASH:::make。</p> 
<p>这时终于明了，网上很多laravel+jwt整合的例子，他们都有一个前提：</p> 
<blockquote> 
 <p>用户默认的加密方式是laravel框架自带的加密方式。</p> 
</blockquote> 
<p>所以他们按照教程，很顺利的就测试通过。</p> 
<p><strong>画重点：<br> laravel中使用jwt时，需注意用户认证的加密方式。<br> auth(‘api’)-&gt;attempt()默认使用的是laravel框架中默认的bcrypt。<br> 如果你的加密方式不是laravel框架的默认加密方式，auth(‘api’)-&gt;attempt()会返回false。<br> 你需要自己扩展认证方式。</strong></p> 
<p>那怎么auth(‘api’)-&gt;attempt()怎么更改为MD5的认证方式呢？<br> 继续百度之。<br> 同样，网上有很多种解决方法，但个人认为下面这篇，操作起来最简单。<br> 还是先上链接：<a href="https://blog.csdn.net/weixin_30847271/article/details/97862650">Laravel核心解读 – 扩展用户认证系统</a>.</p> 
<p>先自定义的用户提供器CustomEloquentUserProvider，继承自EloquentUserProvider，通过它的validateCredentials来实现我们自己系统的密码验证规则，由于用户提供器的其它方法不用改变沿用EloquentUserProvider里的实现就可以。</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span><span class="token operator">?</span>php
<span class="token comment">/**
 * Created by PhpStorm.
 * User: 86157
 * Date: 2020/6/5
 * Time: 14:50
 */</span>

namespace App\Providers<span class="token punctuation">;</span>


use Illuminate\Auth\EloquentUserProvider<span class="token punctuation">;</span>
use Illuminate\Contracts\Auth\Authenticatable<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">CustomEloquentUserProvider</span> <span class="token keyword">extends</span> <span class="token class-name">EloquentUserProvider</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * Validate a user against the given credentials.
     *
     * @param \Illuminate\Contracts\Auth\Authenticatable $user
     * @param array $credentials
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">validateCredentials</span><span class="token punctuation">(</span>Authenticatable $user<span class="token punctuation">,</span> array $credentials<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        $plain <span class="token operator">=</span> $credentials<span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 这里需要传入加密后的密码</span>
        $authPassword <span class="token operator">=</span> $user<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getAuthPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里是从数据库中user表中查询出的密码  可在user中重写getAuthPassword()</span>
        <span class="token keyword">return</span> <span class="token function">strtoupper</span><span class="token punctuation">(</span>$plain<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">strtoupper</span><span class="token punctuation">(</span>$authPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后在AppServiceProvider中的boot()方法中注册：</p> 
<pre><code class="prism language-javascript">    <span class="token comment">/**
     * Bootstrap any application services.
     *
     * @return void
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 注册服务提供者  重新注册校验用户的服务提供者</span>
        Auth<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">provider</span><span class="token punctuation">(</span><span class="token string">"custom-eloquent"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>$app<span class="token punctuation">,</span> $config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomEloquentUserProvider</span><span class="token punctuation">(</span>$app<span class="token punctuation">[</span><span class="token string">'hash'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> $config<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>最后在config/auth.php里配置让看守器使用新注册的custom-eloquent作为用户提供器了。<br> 修改后的config/auth.php配置如下:</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span><span class="token operator">?</span>php

<span class="token keyword">return</span> <span class="token punctuation">[</span>

    <span class="token comment">// 这里是指定默认的看守器</span>
    <span class="token comment">// web 的意思取下面 guards 数组 key 为 web 的那个</span>
    <span class="token string">'defaults'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string">'guard'</span> <span class="token operator">=&gt;</span> <span class="token string">'web'</span><span class="token punctuation">,</span>
        <span class="token string">'passwords'</span> <span class="token operator">=&gt;</span> <span class="token string">'users'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// 这里定义可以用的 guard(看守器)</span>
    <span class="token comment">// driver 指的就是上面的对 Guard 契约的具体实现那个类了</span>
    <span class="token comment">// users 是下面 providers 数组 key 为 users 的那个</span>
    <span class="token string">'guards'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string">'web'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
            <span class="token string">'driver'</span> <span class="token operator">=&gt;</span> <span class="token string">'session'</span><span class="token punctuation">,</span>
            <span class="token string">'provider'</span> <span class="token operator">=&gt;</span> <span class="token string">'users'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token string">'api'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
            <span class="token string">'driver'</span> <span class="token operator">=&gt;</span> <span class="token string">'jwt'</span><span class="token punctuation">,</span> <span class="token comment">// 这里原是token，改为jwt</span>
            <span class="token string">'provider'</span> <span class="token operator">=&gt;</span> <span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token comment">// 这里的user指的是下面providers中配置的users</span>
            <span class="token comment">//'hash' =&gt; false,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token string">'providers'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string">'users'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
            <span class="token comment">//'driver' =&gt; 'eloquent', // 这里使用的用户提供器，默认是EloquentUserProvider.</span>
            <span class="token string">'driver'</span> <span class="token operator">=&gt;</span> <span class="token string">'custom-eloquent'</span><span class="token punctuation">,</span> <span class="token comment">// 这里已改为自定义的用户提供器</span>
            <span class="token string">'model'</span> <span class="token operator">=&gt;</span> App\User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token comment">// 这个的作用是指定认证所需的 user 来源的数据表，可根据需要修改为你自己需要认证用户的模型.</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token comment">// 'users' =&gt; [</span>
        <span class="token comment">//     'driver' =&gt; 'database',</span>
        <span class="token comment">//     'table' =&gt; 'users',</span>
        <span class="token comment">// ],</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token string">'passwords'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string">'users'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
            <span class="token string">'provider'</span> <span class="token operator">=&gt;</span> <span class="token string">'users'</span><span class="token punctuation">,</span>
            <span class="token string">'table'</span> <span class="token operator">=&gt;</span> <span class="token string">'password_resets'</span><span class="token punctuation">,</span>
            <span class="token string">'expire'</span> <span class="token operator">=&gt;</span> <span class="token number">60</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

<span class="token punctuation">]</span><span class="token punctuation">;</span>

</code></pre> 
<p>config/auth.php中的providers，其users中的driver已改为我们在AppServiceProvider中新注册的custom-eloquent了。</p> 
<p>以上，问题已经定位，并找到解决方案。<br> 再次进行测试登录接口。<br> <img src="https://images2.imgbox.com/12/a1/q5Se9aXx_o.png" alt="登录测试截图"><br> 登录接口测试成功，已获取到jwt生成的token。</p> 
<p>获取用户信息:<br> <img src="https://images2.imgbox.com/78/60/60aaSFuA_o.png" alt="获取用户信息"><br> 这里需要注意的是，获取用户请求需要携带token.<br> 怎么携带token? 如下设置:<br> <img src="https://images2.imgbox.com/1f/3d/lR6bJ6Rv_o.png" alt="获取用户请求时设置token"></p> 
<p>用户注销:<br> <img src="https://images2.imgbox.com/9c/ee/ndzldJOB_o.png" alt="用户注销截图"><br> 又出幺蛾子！！！<br> Route [login] not defined，还是关键词网上搜索。<br> 顺利找到原因，还是先上链接： <a href="https://blog.csdn.net/beyond__devil/article/details/102715980">Laravel Passport API token 验证，出现 Route [login] not defined 报错</a>.</p> 
<p>好吧，不用谢，我是勤劳的搬运工。<br> 原因：<br> 中间件UrlGenerator的 redirectTo() 方法，因为没定义 ‘login’ 路由，导致抛出了这个异常。<br> 但，这是API接口啊，你给我从定向到另一个路由去，要闹哪样？<br> 你直接给我返回个json啊！<br> 最终解决方法：</p> 
<pre><code>api 请求 header 添加：
Accept: application/json
然后就会抛出 AuthenticationException 异常，我们可以在 
app/Exceptions/Handler.php
捕获异常，重新定义渲染。
</code></pre> 
<p>好吧，postman中，发送请求时设置Accept: application/json.<br> <img src="https://images2.imgbox.com/54/b6/z5EhdLdh_o.png" alt="发送请求时，设置Accept"><br> 设置后返回401Unauthorized。<br> 返回正常，因为token过期了。<br> 为了测试，token只设置了1分钟的实效。</p> 
<p>好吧，过期后，正好试试可否刷新token。<br> <img src="https://images2.imgbox.com/5f/3d/IdPY2Amq_o.png" alt="过期后刷新token"><br> 咦！<br> 过期后不能刷新token吗？<br> 那不是token签发后，过期了就只能重新登录了？重新输入用户名密码登录，那多麻烦。<br> 而且体验也不好。</p> 
<p>查看jwt.php的配置</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span><span class="token operator">?</span>php

<span class="token comment">/*
 * This file is part of jwt-auth.
 *
 * (c) Sean Tymon &lt;tymon148@gmail.com&gt;
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */</span>

<span class="token keyword">return</span> <span class="token punctuation">[</span>

    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | JWT Authentication Secret
    |--------------------------------------------------------------------------
    |
    | Don't forget to set this in your .env file, as it will be used to sign
    | your tokens. A helper command is provided for this:
    | `php artisan jwt:secret`
    |
    | Note: This will be used for Symmetric algorithms only (HMAC),
    | since RSA and ECDSA use a private/public key combo (See below).
    |
    */</span>
    <span class="token comment">// 用于加密生成 token 的 secret</span>
    <span class="token string">'secret'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_SECRET'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | JWT Authentication Keys
    |--------------------------------------------------------------------------
    |
    | The algorithm you are using, will determine whether your tokens are
    | signed with a random string (defined in `JWT_SECRET`) or using the
    | following public &amp; private keys.
    |
    | Symmetric Algorithms:
    | HS256, HS384 &amp; HS512 will use `JWT_SECRET`.
    |
    | Asymmetric Algorithms:
    | RS256, RS384 &amp; RS512 / ES256, ES384 &amp; ES512 will use the keys below.
    |
    */</span>

    <span class="token string">'keys'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>

        <span class="token comment">/*
        |--------------------------------------------------------------------------
        | Public Key
        |--------------------------------------------------------------------------
        |
        | A path or resource to your public key.
        |
        | E.g. 'file://path/to/public/key'
        |
        */</span>

        <span class="token string">'public'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_PUBLIC_KEY'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">/*
        |--------------------------------------------------------------------------
        | Private Key
        |--------------------------------------------------------------------------
        |
        | A path or resource to your private key.
        |
        | E.g. 'file://path/to/private/key'
        |
        */</span>

        <span class="token string">'private'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_PRIVATE_KEY'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token comment">/*
        |--------------------------------------------------------------------------
        | Passphrase
        |--------------------------------------------------------------------------
        |
        | The passphrase for your private key. Can be null if none set.
        |
        */</span>

        <span class="token string">'passphrase'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_PASSPHRASE'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | JWT time to live
    |--------------------------------------------------------------------------
    |
    | Specify the length of time (in minutes) that the token will be valid for.
    | Defaults to 1 hour.
    |
    | You can also set this to null, to yield a never expiring token.
    | Some people may want this behaviour for e.g. a mobile app.
    | This is not particularly recommended, so make sure you have appropriate
    | systems in place to revoke the token if necessary.
    | Notice: If you set this to null you should remove 'exp' element from 'required_claims' list.
    |
    */</span>
    <span class="token comment">// 指定 access_token 有效的时间长度（以分钟为单位），默认为1小时，您也可以将其设置为空，以产生永不过期的标记</span>
    <span class="token string">'ttl'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_TTL'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 这里为了测试，设置为1分钟。</span>

    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | Refresh time to live
    |--------------------------------------------------------------------------
    |
    | Specify the length of time (in minutes) that the token can be refreshed
    | within. I.E. The user can refresh their token within a 2 week window of
    | the original token being created until they must re-authenticate.
    | Defaults to 2 weeks.
    |
    | You can also set this to null, to yield an infinite refresh time.
    | Some may want this instead of never expiring tokens for e.g. a mobile app.
    | This is not particularly recommended, so make sure you have appropriate
    | systems in place to revoke the token if necessary.

    | 刷新时间指的是在这个时间内可以凭旧 token 换取一个新 token。
    | 例如 token 有效时间为 60 分钟，刷新时间为 20160 分钟。
    | 在 60 分钟内可以通过这个 token 获取新 token。
    | 但是超过 60 分钟是不可以的，然后你可以一直循环获取，直到总时间超过 20160 分钟，不能再获取。
    |
    */</span>

    <span class="token string">'refresh_ttl'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_REFRESH_TTL'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 一周：20160 这里为了测试，设置为5分钟。</span>

    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | JWT hashing algorithm
    |--------------------------------------------------------------------------
    |
    | Specify the hashing algorithm that will be used to sign the token.
    |
    | See here: https://github.com/namshi/jose/tree/master/src/Namshi/JOSE/Signer/OpenSSL
    | for possible values.
    |
    | 指定将用于对令牌进行签名的散列算法。
    |
    */</span>

    <span class="token string">'algo'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_ALGO'</span><span class="token punctuation">,</span> <span class="token string">'HS256'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | Required Claims
    |--------------------------------------------------------------------------
    |
    | Specify the required claims that must exist in any token.
    | A TokenInvalidException will be thrown if any of these claims are not
    | present in the payload.
    |
    | 指定必须存在于任何令牌中的声明。
    */</span>

    <span class="token string">'required_claims'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string">'iss'</span><span class="token punctuation">,</span>
        <span class="token string">'iat'</span><span class="token punctuation">,</span>
        <span class="token string">'exp'</span><span class="token punctuation">,</span>
        <span class="token string">'nbf'</span><span class="token punctuation">,</span>
        <span class="token string">'sub'</span><span class="token punctuation">,</span>
        <span class="token string">'jti'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | Persistent Claims
    |--------------------------------------------------------------------------
    |
    | Specify the claim keys to be persisted when refreshing a token.
    | `sub` and `iat` will automatically be persisted, in
    | addition to the these claims.
    |
    | Note: If a claim does not exist then it will be ignored.
    | 指定在刷新令牌时要保留的声明密钥。
    */</span>

    <span class="token string">'persistent_claims'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token comment">// 'foo',</span>
        <span class="token comment">// 'bar',</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | Lock Subject
    |--------------------------------------------------------------------------
    |
    | This will determine whether a `prv` claim is automatically added to
    | the token. The purpose of this is to ensure that if you have multiple
    | authentication models e.g. `App\User` &amp; `App\OtherPerson`, then we
    | should prevent one authentication request from impersonating another,
    | if 2 tokens happen to have the same id across the 2 different models.
    |
    | Under specific circumstances, you may want to disable this behaviour
    | e.g. if you only have one authentication model, then you would save
    | a little on token size.
    |
    */</span>

    <span class="token string">'lock_subject'</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | Leeway
    |--------------------------------------------------------------------------
    |
    | This property gives the jwt timestamp claims some "leeway".
    | Meaning that if you have any unavoidable slight clock skew on
    | any of your servers then this will afford you some level of cushioning.
    |
    | This applies to the claims `iat`, `nbf` and `exp`.
    |
    | Specify in seconds - only if you know you need it.
    |
    */</span>

    <span class="token string">'leeway'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_LEEWAY'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | Blacklist Enabled
    |--------------------------------------------------------------------------
    |
    | In order to invalidate tokens, you must have the blacklist enabled.
    | If you do not want or need this functionality, then set this to false.
    |
    | 为了使令牌无效，您必须启用黑名单。
    | 如果您不想或不需要此功能，请将其设置为 false。
    */</span>

    <span class="token string">'blacklist_enabled'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_BLACKLIST_ENABLED'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/*
    | -------------------------------------------------------------------------
    | Blacklist Grace Period
    | -------------------------------------------------------------------------
    |
    | When multiple concurrent requests are made with the same JWT,
    | it is possible that some of them fail, due to token regeneration
    | on every request.
    |
    | Set grace period in seconds to prevent parallel request failure.
    |
    | 当多个并发请求使用相同的JWT进行时，
    | 由于 access_token 的刷新 ，其中一些可能会失败
    | 以秒为单位设置请求时间以防止并发的请求失败。
    |
    */</span>

    <span class="token string">'blacklist_grace_period'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_BLACKLIST_GRACE_PERIOD'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | Cookies encryption
    |--------------------------------------------------------------------------
    |
    | By default Laravel encrypt cookies for security reason.
    | If you decide to not decrypt cookies, you will have to configure Laravel
    | to not encrypt your cookie token by adding its name into the $except
    | array available in the middleware "EncryptCookies" provided by Laravel.
    | see https://laravel.com/docs/master/responses#cookies-and-encryption
    | for details.
    |
    | Set it to true if you want to decrypt cookies.
    |
    */</span>

    <span class="token string">'decrypt_cookies'</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span>

    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | Providers
    |--------------------------------------------------------------------------
    |
    | Specify the various providers used throughout the package.
    |
    | 指定整个包中使用的各种提供程序。
    */</span>

    <span class="token string">'providers'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>

        <span class="token comment">/*
        |--------------------------------------------------------------------------
        | JWT Provider
        |--------------------------------------------------------------------------
        |
        | Specify the provider that is used to create and decode the tokens.
        | 指定用于创建和解码令牌的提供程序。
        */</span>

        <span class="token string">'jwt'</span> <span class="token operator">=&gt;</span> Tymon\JWTAuth\Providers\<span class="token constant">JWT</span>\Lcobucci<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>

        <span class="token comment">/*
        |--------------------------------------------------------------------------
        | Authentication Provider
        |--------------------------------------------------------------------------
        |
        | Specify the provider that is used to authenticate users.
        | 指定用于对用户进行身份验证的提供程序。
        |
        */</span>

        <span class="token string">'auth'</span> <span class="token operator">=&gt;</span> Tymon\JWTAuth\Providers\Auth\Illuminate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>

        <span class="token comment">/*
        |--------------------------------------------------------------------------
        | Storage Provider
        |--------------------------------------------------------------------------
        |
        | Specify the provider that is used to store tokens in the blacklist.
        | 指定用于在黑名单中存储标记的提供程序。
        */</span>

        <span class="token string">'storage'</span> <span class="token operator">=&gt;</span> Tymon\JWTAuth\Providers\Storage\Illuminate<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>

    <span class="token punctuation">]</span><span class="token punctuation">,</span>

<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>其中</p> 
<pre><code class="prism language-javascript"><span class="token string">'ttl'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_TTL'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 这里为了测试，设置为1分钟。</span>
<span class="token string">'refresh_ttl'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_REFRESH_TTL'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 一周：20160 这里为了测试，设置为5分钟。</span>
</code></pre> 
<p>这就表示，jwt生成的token有效期为2分钟，在token的有效期内，可以携带token过来刷新token。<br> 若超过5分钟，则不能刷新token，只能重新登录。</p> 
<p>那token过期后，不想重新登录，想刷新怎么办呢？</p> 
<p>同样，先上链接：<a href="https://learnku.com/articles/7264/using-jwt-auth-to-implement-api-user-authentication-and-painless-refresh-access-token" rel="nofollow">使用 Jwt-Auth 实现 API 用户认证以及无痛刷新访问令牌<br> </a>.</p> 
<p>可以采用中间件来处理</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span><span class="token operator">?</span>php

namespace App\Http\Middleware<span class="token punctuation">;</span>

use Closure<span class="token punctuation">;</span>
use Illuminate\Support\Facades\Auth<span class="token punctuation">;</span>
use Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException<span class="token punctuation">;</span>
use Tymon\JWTAuth\Exceptions\JWTException<span class="token punctuation">;</span>
use Tymon\JWTAuth\Exceptions\TokenExpiredException<span class="token punctuation">;</span>
use Tymon\JWTAuth\Http\Middleware\BaseMiddleware<span class="token punctuation">;</span>
use Log<span class="token punctuation">;</span>

<span class="token comment">// 注意，这里要继承的是 jwt 的 BaseMiddleware</span>
<span class="token keyword">class</span> <span class="token class-name">JwtRefreshToken</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMiddleware</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * Handle an incoming request.
     * @param  \Illuminate\Http\Request $request
     * @param  \Closure $next
     * @throws \Symfony\Component\HttpKernel\Exception\UnauthorizedHttpException
     *
     * @return mixed
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span>$request<span class="token punctuation">,</span> Closure $next<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 检查此次请求中是否带有 token，如果没有则抛出异常。</span>
        $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">checkForToken</span><span class="token punctuation">(</span>$request<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用 try 包裹，以捕捉 token 过期所抛出的 TokenExpiredException  异常</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 检测用户的登录状态，如果正常则通过</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>auth<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">parseToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">$next</span><span class="token punctuation">(</span>$request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedHttpException</span><span class="token punctuation">(</span><span class="token string">'jwt-auth'</span><span class="token punctuation">,</span> <span class="token string">'未登录'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TokenExpiredException</span> $exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 此处捕获到了 token 过期所抛出的 TokenExpiredException 异常，我们在这里需要做的是刷新该用户的 token 并将它添加到响应头中</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 刷新用户的 token</span>
                $token <span class="token operator">=</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>auth<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 使用一次性登录以保证此次请求的成功</span>
                Auth<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">guard</span><span class="token punctuation">(</span><span class="token string">'api'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">onceUsingId</span><span class="token punctuation">(</span>$<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>auth<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getPayloadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">buildClaimsCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">toPlainArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'sub'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JWTException</span> $exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Log<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">error</span><span class="token punctuation">(</span>$exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果捕获到此异常，即代表 refresh 也过期了，用户无法刷新令牌，需要重新登录。</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedHttpException</span><span class="token punctuation">(</span><span class="token string">'jwt-auth'</span><span class="token punctuation">,</span> $exception<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 在响应头中返回新的 token</span>
        <span class="token keyword">return</span> $<span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setAuthenticationHeader</span><span class="token punctuation">(</span><span class="token function">$next</span><span class="token punctuation">(</span>$request<span class="token punctuation">)</span><span class="token punctuation">,</span> $token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>然后，App\Http\Kernel中$routeMiddleware增加:</p> 
<pre><code class="prism language-javascript"><span class="token string">'jwt_refresh_token'</span> <span class="token operator">=&gt;</span> \App\Http\Middleware\JwtRefreshToken<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>
</code></pre> 
<p>最后修改api.php中的路由，修改的路由如下:</p> 
<pre><code class="prism language-javascript"><span class="token comment">/* jwt 测试*/</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'/auth/login'</span><span class="token punctuation">,</span> <span class="token string">'\App\Http\Controllers\AuthController@login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 需要登录后访问的接口放这里</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'jwt_refresh_token'</span><span class="token punctuation">,</span> <span class="token string">'jwt.auth:api'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token string">'auth'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'/logout'</span><span class="token punctuation">,</span> <span class="token string">'\App\Http\Controllers\AuthController@logout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'/refresh'</span><span class="token punctuation">,</span> <span class="token string">'\App\Http\Controllers\AuthController@refresh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'/findUser'</span><span class="token punctuation">,</span> <span class="token string">'\App\Http\Controllers\AuthController@me'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>画重点: 路由中间件jwt_refresh_token需放在第一位</strong></p> 
<p>token过期后，可以暂时通过此次请求，并在此次请求中刷新该用户的 token，最后在响应头中将新的 token 返回给前端，前端拿到新的token后，更新token。</p> 
<p><strong>这里需要注意的是，当jwt.php中设置的refresh_ttl到期后，refresh()将会失效。之后只能重新登录。</strong><br> 以上，是token过期后刷新的情况。</p> 
<p>那么，若是token未过期，刷新了token后，原token可以继续使用吗？<br> jwt.php中这么两个配置:</p> 
<pre><code class="prism language-javascript">    <span class="token comment">/*
    |--------------------------------------------------------------------------
    | Blacklist Enabled
    |--------------------------------------------------------------------------
    | 为了使令牌无效，您必须启用黑名单。
    | 如果您不想或不需要此功能，请将其设置为 false。
    */</span>

    <span class="token string">'blacklist_enabled'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_BLACKLIST_ENABLED'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    
    <span class="token comment">/*
    | -------------------------------------------------------------------------
    | Blacklist Grace Period
    | -------------------------------------------------------------------------
    | 当多个并发请求使用相同的JWT进行时，
    | 由于 access_token 的刷新 ，其中一些可能会失败
    | 以秒为单位设置请求时间以防止并发的请求失败。
    |
    */</span>

    <span class="token string">'blacklist_grace_period'</span> <span class="token operator">=&gt;</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">'JWT_BLACKLIST_GRACE_PERIOD'</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> 
<p>blacklist_grace_period：可以设置在多少秒内，旧token还可以继续使用。<br> 若想刷新后，旧token立即失效，可以设置为0秒。</p> 
<p><strong>jwt token 注销:<br> 注销时，需注意：auth(‘api’)-&gt;logout(); 使用该方法，注销无效。</strong><br> 未深究原因，待后面有空深入研究下。知道原因的，也可以告知我下。</p> 
<p>jwt-auth中，token注销，实则是把token加入黑名单。<br> 最终调用 Laravel 当前的 Cache，将 Token 加入缓存。</p> 
<p>也就是说，jwt-auth中token注销会使用laravel框架的Cache。<br> 如果API接口要集群的话，laravel的Cache就需要使用redis之类的第三方缓存，而不是使用默认的file.<br> Cache使用file的话，会导致，token在某台API接口服务器中失效，但在其他接口服务器中却可以正常使用。</p> 
<p>以上，记录了本次引入jwt的过程，和其中碰到的问题。可能有疏漏的地方。但把自己认为应该注意的地方都标注了。<br> 写得有些凌乱，但也不想改了。<br> 后面有时间再重新修整吧。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a54d72c5d786a469131408cf30b68b70/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决使用python过程中可能出现的编码问题UnicodeEncodeError</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/89533b3b043fd64b6351438fc8ef0345/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;中string的常用操作</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>