<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【应急基础】————2、开机启动项 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【应急基础】————2、开机启动项" />
<meta property="og:description" content="在应急响应时，开机启动项是必查的项，下面梳理一下关于开机启动与服务相关需要排查的点。直接从init开始说。
RHEL5、RHEL6、RHEL7的init系统分别为SysV init、Upstart、Systemd
CentOS 5 启动流程如下：
1）加载BIOS的硬件信息与进行自我测试，并依据设置取得第一个可启动设备； 2）读取并执行第一个启动设备内MBR（主引导分区）的Boot Loader（即是gurb等程序）； 3）依据Boot Loader的设置加载Kernel，Kernel会开始检测硬件与加载驱动程序； 4）在硬件驱动成功后，Kernel会主动调用init进程（/sbin/init），init的配置文件/etc/inittab； 5）init执行/etc/rc.d/rc.sysinit文件来准备软件的操作环境（如网络、时区等）； 6）init执行runlevel的各个服务的启动（script方式）； 7）init执行/etc/rc.d/rc.local文件； 8）init执行终端机模拟程序mingetty来启动login程序，最后等待用户登录。 init程序会读取init的配置文件/etc/inittab,并依据此文件来进行初始化工作。/etc/inittab文件主要作用是指定运行级别，执行系统初始化脚本（/etc/rc.d/rc.sysinit）,启动相应运行级别下的服务和启动终端。
[root@jianshe_28 admin]# cat /etc/inittab # # inittab This file describes how the INIT process should set up # the system in a certain run-level. # # Author: Miquel van Smoorenburg, &lt;miquels@drinkel.nl.mugnet.org&gt; # Modified for RHS Linux by Marc Ewing and Donnie Barnes # # Default runlevel. The runlevels used by RHS are: # 0 - halt (Do NOT set initdefault to this) # 1 - Single user mode # 2 - Multiuser, without NFS (The same as 3, if you do not have networking) # 3 - Full multiuser mode # 4 - unused # 5 - X11 # 6 - reboot (Do NOT set initdefault to this) # id:3:initdefault: # System initialization." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/bc488faace2ffc11bfebb31134d0998d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-02-22T16:28:19+08:00" />
<meta property="article:modified_time" content="2019-02-22T16:28:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【应急基础】————2、开机启动项</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>在应急响应时，开机启动项是必查的项，下面梳理一下关于开机启动与服务相关需要排查的点。直接从init开始说。<br> RHEL5、RHEL6、RHEL7的init系统分别为SysV init、Upstart、Systemd</p> 
<p><img alt="" class="has" height="375" src="https://images2.imgbox.com/7e/43/MQY0FF6b_o.png" width="702"></p> 
<h3>CentOS 5</h3> 
<p>启动流程如下：</p> 
<pre class="has"><code class="language-html">1）加载BIOS的硬件信息与进行自我测试，并依据设置取得第一个可启动设备；

2）读取并执行第一个启动设备内MBR（主引导分区）的Boot Loader（即是gurb等程序）；

3）依据Boot Loader的设置加载Kernel，Kernel会开始检测硬件与加载驱动程序；

4）在硬件驱动成功后，Kernel会主动调用init进程（/sbin/init），init的配置文件/etc/inittab；

5）init执行/etc/rc.d/rc.sysinit文件来准备软件的操作环境（如网络、时区等）；

6）init执行runlevel的各个服务的启动（script方式）；

7）init执行/etc/rc.d/rc.local文件；

8）init执行终端机模拟程序mingetty来启动login程序，最后等待用户登录。</code></pre> 
<p>init程序会读取init的配置文件/etc/inittab,并依据此文件来进行初始化工作。/etc/inittab文件主要作用是指定运行级别，执行系统初始化脚本（/etc/rc.d/rc.sysinit）,启动相应运行级别下的服务和启动终端。</p> 
<pre class="has"><code class="language-perl">[root@jianshe_28 admin]# cat /etc/inittab
#
# inittab This file describes how the INIT process should set up
# the system in a certain run-level.
#
# Author: Miquel van Smoorenburg, &lt;miquels@drinkel.nl.mugnet.org&gt;
# Modified for RHS Linux by Marc Ewing and Donnie Barnes
#

# Default runlevel. The runlevels used by RHS are:
# 0 - halt (Do NOT set initdefault to this)
# 1 - Single user mode
# 2 - Multiuser, without NFS (The same as 3, if you do not have networking)
# 3 - Full multiuser mode
# 4 - unused
# 5 - X11
# 6 - reboot (Do NOT set initdefault to this)
# 
id:3:initdefault:

# System initialization.
si::sysinit:/etc/rc.d/rc.sysinit

l0:0:wait:/etc/rc.d/rc 0
l1:1:wait:/etc/rc.d/rc 1
l2:2:wait:/etc/rc.d/rc 2
l3:3:wait:/etc/rc.d/rc 3
l4:4:wait:/etc/rc.d/rc 4
l5:5:wait:/etc/rc.d/rc 5
l6:6:wait:/etc/rc.d/rc 6

# Trap CTRL-ALT-DELETE
ca::ctrlaltdel:/sbin/shutdown -t3 -r now

# When our UPS tells us power has failed, assume we have a few minutes
# of power left. Schedule a shutdown for 2 minutes from now.
# This does, of course, assume you have powerd installed and your
# UPS connected and working correctly. 
pf::powerfail:/sbin/shutdown -f -h +2 "Power Failure; System Shutting Down"

# If power was restored before the shutdown kicked in, cancel it.
pr:12345:powerokwait:/sbin/shutdown -c "Power Restored; Shutdown Cancelled"



# Run gettys in standard runlevels
1:2345:respawn:/sbin/mingetty tty1
2:2345:respawn:/sbin/mingetty tty2
3:2345:respawn:/sbin/mingetty tty3
4:2345:respawn:/sbin/mingetty tty4
5:2345:respawn:/sbin/mingetty tty5
6:2345:respawn:/sbin/mingetty tty6

# Run xdm in runlevel 5
x:5:respawn:/etc/X11/prefdm -nodaemon</code></pre> 
<p>inittab文件中的值都是如下格式：<br> id:runlevel:action:process</p> 
<p><strong>id：</strong><br> id是指入口标识符，他是个字符串，对于getty、mingetty等，需求id和tty的编号相同，否则getty将不能正常工作。</p> 
<p><strong>runlevel：</strong><br> 指定runlevel的级别。能指定多个runlevel级别，也能不为runlevel字段指定特定的值。<br> 运行级别决定了系统启动的绝大部分行为和目的。这个级别从0到6，具有不同的功能。不同的运行级定义如下：</p> 
<pre class="has"><code class="language-perl"># 0 - 停机（千万别把initdefault设置为0，否则系统永远无法启动）
# 1 - 单用户模式
# 2 - 多用户，没有 NFS
# 3 - 完全多用户模式(标准的运行级)
# 4 - 系统保留的
# 5 - X11 （x window)
# 6 - 重新启动</code></pre> 
<p>action：</p> 
<p>定义了该进程应该运行在何种状态下，其中action常用的种类有：</p> 
<p><img alt="" class="has" height="160" src="https://images2.imgbox.com/03/94/2gIwhj2M_o.png" width="684"></p> 
<p>下面看一下具体的配置</p> 
<p>id:3:initdefault:</p> 
<p>设置runlevel</p> 
<p>si::sysinit:/etc/rc.d/rc.sysinit</p> 
<p>执行了/etc/rc.d/rc.sysinit，一个shell脚本，他主要是完成一些系统初始化的工作，例如激活交换分区，检查磁盘，加载硬件模块及其他一些需要优先执行任务。</p> 
<p>l0:0:wait:/etc/rc.d/rc 0<br> l1:1:wait:/etc/rc.d/rc 1<br> l2:2:wait:/etc/rc.d/rc 2<br> l3:3:wait:/etc/rc.d/rc 3<br> l4:4:wait:/etc/rc.d/rc 4<br> l5:5:wait:/etc/rc.d/rc 5<br> l6:6:wait:/etc/rc.d/rc 6<br> /etc/rc.d/rc是个shell脚本，接受runlevel参数，去执行该runlevel目录下的所有的rc启动脚本。以启动级别为3为例，/etc/rc.d/rc3.d/其实都是一些链接文件，真正的rc启动脚本实际上都是放在/etc/rc.d/init.d/目录下。而这些rc启动脚本有着类似的用法，他们一般能接受start、stop、restart、status等参数。</p> 
<p><img alt="" class="has" height="100" src="https://images2.imgbox.com/fe/06/NeaxQ6CD_o.png" width="683"></p> 
<p>凡是以Kxx开头的，都以stop为参数来调用；凡是以Sxx开头的，都以start为参数来调用。xx是数字、表示的是启动顺序，按xx从小到大来执行。<br> 我们来用chkconfig修改一下试试</p> 
<p><img alt="" class="has" height="120" src="https://images2.imgbox.com/73/25/sdqLXeVx_o.png" width="683"></p> 
<p>另外说明一下应急响应中我们都会检查/etc/rc.local，其实也是在rcN.d中。<br> /etc/rc.local是软链到了/etc/rc.d/rc.local</p> 
<p><img alt="" class="has" height="64" src="https://images2.imgbox.com/b6/a9/AkZFuZUp_o.png" width="680"></p> 
<p>Redhat中的运行模式2、3、5都把/etc/rc.d/rc.local做为初始化脚本中的最后一个</p> 
<p><img alt="" class="has" height="63" src="https://images2.imgbox.com/23/94/3bPZZVqo_o.png" width="681"></p> 
<p>1:2345:respawn:/sbin/mingetty tty1<br> 2:2345:respawn:/sbin/mingetty tty2<br> 3:2345:respawn:/sbin/mingetty tty3<br> 4:2345:respawn:/sbin/mingetty tty4<br> 5:2345:respawn:/sbin/mingetty tty5<br> 6:2345:respawn:/sbin/mingetty tty6<br> init接下来会打开6个终端，以便用户登录系统。</p> 
<p>总结一下，针对CentOS5系统，需要排查的点：<br> 1）/etc/inittab<br> 该文件是可以运行process的，这里我们添加一行<br> 0:235:once:/bin/vinc<br> 内容如下</p> 
<p><img alt="" class="has" height="84" src="https://images2.imgbox.com/42/89/YBAn9tgP_o.png" width="680"></p> 
<p>重启</p> 
<p><img alt="" class="has" height="82" src="https://images2.imgbox.com/2d/6d/W88qsACW_o.png" width="679"></p> 
<p>2）/etc/rc.d/rc.sysinit<br> 在最后插入一行/bin/vinc</p> 
<p><img alt="" class="has" height="63" src="https://images2.imgbox.com/df/20/iCuNYisy_o.png" width="679"></p> 
<p>3）/etc/rc.d/init.d<br> 4）/etc/rc.d/rc.local</p> 
<p> </p> 
<h3>CentOS 6</h3> 
<p>启动流程如下：</p> 
<p><img alt="" class="has" height="381" src="https://images2.imgbox.com/4a/86/lT6waLnu_o.png" width="639"></p> 
<p>init会读取配置文件/etc/inittab 和 /etc/init/*.conf。先看一下/etc/inittab</p> 
<pre class="has"><code class="language-perl">[root@server120 src]# cat /etc/inittab
# inittab is only used by upstart for the default runlevel.
#
# ADDING OTHER CONFIGURATION HERE WILL HAVE NO EFFECT ON YOUR SYSTEM.
#
# System initialization is started by /etc/init/rcS.conf
#
# Individual runlevels are started by /etc/init/rc.conf
#
# Ctrl-Alt-Delete is handled by /etc/init/control-alt-delete.conf
#
# Terminal gettys are handled by /etc/init/tty.conf and /etc/init/serial.conf,
# with configuration in /etc/sysconfig/init.
#
# For information on how to write upstart event handlers, or how
# upstart works, see init(5), init(8), and initctl(8).
#
# Default runlevel. The runlevels used are:
# 0 - halt (Do NOT set initdefault to this)
# 1 - Single user mode
# 2 - Multiuser, without NFS (The same as 3, if you do not have networking)
# 3 - Full multiuser mode
# 4 - unused
# 5 - X11
# 6 - reboot (Do NOT set initdefault to this)
# 
id:3:initdefault:</code></pre> 
<p>通过注释可以看到，upstart只使用inittab读取默认的runlevel。添加其他的配置都不会生效，其他的配置都移动到了/etc/init/*.conf下。<br> 系统初始化/etc/init/rcS.conf<br> 对应runlevel的服务启动/etc/init/rc.conf<br> 终端配置/etc/init/tty.conf<br> ….</p> 
<p>总结一下，针对CentOS6系统，需要排查的点：<br> 1）/etc/init/*.conf<br> vim tty.conf，添加一行<br> exec /bin/vinc<br> 内容如下</p> 
<p><img alt="" class="has" height="100" src="https://images2.imgbox.com/00/c3/NUhjBPDv_o.png" width="682"></p> 
<p>重启</p> 
<p><img alt="" class="has" height="62" src="https://images2.imgbox.com/17/08/buCs0hjd_o.png" width="680"></p> 
<p>2）/etc/rc.d/rc.sysinit<br> 3）/etc/rc.d/init.d<br> 4）/etc/rc.d/rc.local</p> 
<h3>0x03 CentOS7</h3> 
<p>开机启动流程如下：</p> 
<pre class="has"><code class="language-perl">1）UEFi或BIOS初始化，运行POST开机自检

2）选择启动设备

3）引导装载程序, centos7是grub2

4）加载装载程序的配置文件： /etc/grub.d/   /etc/default/grub    /boot/grub2/grub.cfg

5）加载initramfs驱动模块

6）加载内核选项

7）内核初始化， centos7使用systemd代替init

8）执行initrd.target所有单元，包括挂载/etc/fstab

9）从initramfs根文件系统切换到磁盘根目录

10）systemd执行默认target配置，配置文件/etc/systemd/system/default.target

11）systemd执行sysinit.target初始化系统及basic.target准备操作系统

12）systemd启动multi-user.target下的本机与服务器服务

13）systemd执行multi-user.target下的/etc/rc.d/rc.local

14）systemd执行multi-user.target下的getty.target及登入服务

15）systemd执行graphical需要的服务</code></pre> 
<p>CentOS7使用的是systemd，相较于以前的init有很大的不同。</p> 
<p>/etc/inittab是空的</p> 
<pre class="has"><code class="language-perl">[root@localhost init.d]# cat /etc/inittab | grep -v "^$" | grep -v "^#"

[root@localhost init.d]#</code></pre> 
<pre class="has"><code class="language-html">也没有/etc/init目录
</code></pre> 
<pre class="has"><code class="language-perl">[root@localhost init.d]# ls -al /etc/init

ls: cannot access /etc/init: No such file or directory</code></pre> 
<p>/etc/rc3.d/和/etc/rc.d/init.d/还存在，所以向后兼容sysv init脚本，在centos5、6系统上/etc/init.d/目录下的服务脚本，systemd也能够对其进行管理</p> 
<pre class="has"><code class="language-perl">[root@localhost init.d]# ls -al /etc/rc3.d/

total 4

drwxr-xr-x.  2 root root   81 May 30 14:09 .

drwxr-xr-x. 10 root root 4096 May 30 14:31 ..

lrwxrwxrwx.  1 root root   20 Nov  7  2016 K50netconsole -&gt; ../init.d/netconsole

lrwxrwxrwx.  1 root root   17 Nov  7  2016 S10network -&gt; ../init.d/network

lrwxrwxrwx.  1 root root   23 Jan 17  2017 S90zabbix_agentd -&gt; ../init.d/zabbix_agentd

lrwxrwxrwx.  1 root root   15 May 30 14:09 S99ossec -&gt; ../init.d/ossec</code></pre> 
<p>systemd提供更优秀的框架以表示系统服务间的依赖关系，尽可能启动更少进程，尽可能将更多进程并行启动，尽可能减少对shell脚本的依赖。systemd的核心概念是unit，unit表示不同类型的systemd对象，通过配置文件进行标识和配置，文件中主要包含了系统服务，监听socket，保存的系统快照以及其他与init相关的信息。</p> 
<p>查看所有的unit类型：</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# systemctl -t help       

Available unit types:

service

socket

busname

target

snapshot

device

mount

automount

swap

timer

path

slice

scope</code></pre> 
<p>用途如下：</p> 
<pre class="has"><code class="language-perl">Service unit：文件扩展名.service 用于定义系统服务
Target unit：文件扩展名.target 用于模拟实现运行级别
Device unit： .device 用于定义内核识别的设备
Mount unit： .mount 定义文件系统的挂载点
Socket unit： .socket 用于标识进程间通行用的socket文件，也可在系统启动时，延迟启动服务，实现按需启动
Snapshot unit： .snapshot 管理系统快照
Swap unit： .swap 用于标识swap设备
Automount unit： .automount 文件系统的自动挂载点
Path unit： .path 用于定义文件系统中的一个文件或目录使用，常用于当文件系统变化时，延迟激活服务，如spool目录</code></pre> 
<p>配置文件中主要保存在：</p> 
<pre class="has"><code class="language-perl">/usr/lib/systemd/system/    每个服务最主要的启动脚本设置，类似于之前的/etc/init.d/ 

/run/systemd/system/    系统执行过程中所产生的服务脚本，比上面目录优先运行

/etc/systemd/system/    管理员建立的执行脚本，类似于/etc/rc.d/rcN.d/Sxx类的功能，比上面目录优先运行</code></pre> 
<pre class="has"><code class="language-perl">[root@localhost system]# ls /usr/lib/systemd/system/

abrt-ccpp.service                       psacct.service

abrtd.service                           quotaon.service

abrt-oops.service                       rc-local.service

...

[root@localhost system]# ls /run/systemd/system/

session-1006.scope      session-161401.scope    session-24243.scope    session-54837.scope

session-1160.scope      session-162551.scope    session-24243.scope.d  session-54837.scope.d

...

[root@localhost system]# ls /etc/systemd/system/

basic.target.wants                           default.target           sockets.target.wants

dbus-org.fedoraproject.FirewallD1.service    default.target.wants     sysinit.target.wants

dbus-org.freedesktop.NetworkManager.service  getty.target.wants       system-update.target.wants

dbus-org.freedesktop.nm-dispatcher.service   multi-user.target.wants</code></pre> 
<p>我们来看下sshd.service</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# cat sshd.service | grep -v "^$" | grep -v "^#"

[Unit]

Description=OpenSSH server daemon

Documentation=man:sshd(8) man:sshd_config(5)

After=network.target sshd-keygen.service

Wants=sshd-keygen.service

[Service]

EnvironmentFile=/etc/sysconfig/sshd

ExecStart=/usr/sbin/sshd -D $OPTIONS

ExecReload=/bin/kill -HUP $MAINPID

KillMode=process

Restart=on-failure

RestartSec=42s

[Install]

WantedBy=multi-user.target</code></pre> 
<p>文件包含三部分。</p> 
<p>[Unit]：描述信息与依赖关系</p> 
<p>[Service]：ExecStartPre 定义启动服务之前应该运行的命令；ExecStart 定义启动服务的具体命令行语法。</p> 
<p>[Install]：WangtedBy 表明这个服务是在多用户模式下所需要的。</p> 
<p>我们再来看下multi-user.target</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# cat multi-user.target | grep -v "^$" | grep -v "^#"

[Unit]

Description=Multi-User System

Documentation=man:systemd.special(7)

Requires=basic.target

Conflicts=rescue.service rescue.target

After=basic.target rescue.service rescue.target

AllowIsolate=yes</code></pre> 
<pre class="has"><code class="language-html"> </code></pre> 
<p>Requires表明 multi-user.target 启动的时候 basic.target 也必须被启动，basic.target 停止的时候，multi-user.target 也必须停止。接着查看 basic.target 文件，会发现它又指定了 sysinit.target 等其他的单元必须随之启动。同样 sysinit.target 也会包含其他的单元。采用这样的层层链接的结构，最终所有需要支持多用户模式的组件服务都会被初始化启动好。</p> 
<p>此外在/etc/systemd/system 目录下还可以看到诸如*.wants 的目录</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# ls multi-user.target.wants/   

brandbot.path  plymouth-quit.service           systemd-logind.service

dbus.service   plymouth-quit-wait.service      systemd-update-utmp-runlevel.service

getty.target   systemd-ask-password-wall.path  systemd-user-sessions.service</code></pre> 
<p>放在该目录下的配置单元文件等同于在[Unit]小节中的 wants 关键字，即本单元启动时，还需要启动这些单元。</p> 
<p>查看multi-user.target的依赖关系</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# systemctl list-dependencies multi-user.target     

multi-user.target

├─abrt-ccpp.service
├─abrt-oops.service
├─abrt-vmcore.service
├─abrt-xorg.service
├─abrtd.service
├─atd.service
├─auditd.service</code></pre> 
<p>查看systemd管理的所有单元</p> 
<pre class="has"><code>[root@localhost system]# systemctl list-unit-files

UNIT FILE                                   STATE  

proc-sys-fs-binfmt_misc.automount           static 

dev-hugepages.mount                         static 

dev-mqueue.mount                            static</code></pre> 
<p>查看服务状态</p> 
<pre class="has"><code>[root@localhost system]# systemctl list-unit-files --type service     

UNIT FILE                                   STATE  

abrt-ccpp.service                           enabled

abrt-oops.service                           enabled</code></pre> 
<p>State的状态如下：</p> 
<pre class="has"><code class="language-perl">loaded:Unit配置文件已处理

active(running):一次或多次持续处理的运行

active(exited):成功完成一次性的配置

active(waiting):运行中，等待一个事件

inactive:不运行

enabled:开机启动

disabled:开机不启动

static:开机不启动，但可被另一个启用的服务激活</code></pre> 
<p>使用 systemctl 控制单元时，通常需要使用单元文件的全名，包括扩展名（例如 sshd.service），如果无扩展名，systemctl 默认把扩展名当作 .service。</p> 
<p>启动httpd服务</p> 
<pre class="has"><code>[root@localhost system]# systemctl start httpd</code></pre> 
<p>停止httpd服务</p> 
<pre class="has"><code>[root@localhost system]# systemctl stop httpd</code></pre> 
<p>查看httpd服务运行状态</p> 
<pre class="has"><code>[root@localhost system]# systemctl status httpd</code></pre> 
<p>在centOS7上由.target来代替运行级别。</p> 
<p>查看我们的机器上有多少个target</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# ls /usr/lib/systemd/system/*.target | head -n 5

/usr/lib/systemd/system/basic.target

/usr/lib/systemd/system/bluetooth.target

/usr/lib/systemd/system/cryptsetup-pre.target

/usr/lib/systemd/system/cryptsetup.target

/usr/lib/systemd/system/ctrl-alt-del.target</code></pre> 
<p>运行级别与target的对照如下：</p> 
<pre class="has"><code class="language-perl">runlevel0.target -&gt; poweroff.target

runlevel1.target -&gt; rescue.target

runlevel2.target -&gt; multi-user.target

runlevel3.target -&gt; multi-user.target

runlevel4.target -&gt; multi-user.target

runlevel5.target -&gt; graphical.target

runlevel6.target -&gt; reboot.target</code></pre> 
<p>运行级别切换</p> 
<p>在centOS6上，我们切换级别使用init，在centOS7上来切换用：</p> 
<pre class="has"><code class="language-perl">systemctl isolate poweroff.target</code></pre> 
<p>要想切换运行级别，AllowIsolate=yes才可以。</p> 
<pre class="has"><code>[root@localhost system]# cat poweroff.target | grep Allow

AllowIsolate=yes</code></pre> 
<p>修改文件需执行systemctl daemon-reload才能生效。</p> 
<p>查看默认运行级别</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# systemctl get-default

multi-user.target</code></pre> 
<p>修改默认运行级别</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# systemctl set-default graphical.target

Removed symlink /etc/systemd/system/default.target.

Created symlink from /etc/systemd/system/default.target to /usr/lib/systemd/system/graphical.target.</code></pre> 
<p>查看开机启动程序(相当于chkconfig –list)</p> 
<pre class="has"><code class="language-perl">ls /etc/systemd/system/multi-user.target.wants/</code></pre> 
<p>开机启动（相当于chkconfig httpd on）</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# systemctl enable httpd.service 

Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service.</code></pre> 
<p>去除开机启动（相当于chkconfig httpd off）</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# systemctl disable httpd.service                                

Removed symlink /etc/systemd/system/multi-user.target.wants/httpd.service.</code></pre> 
<p>查看服务是否开机启动（相当于chkconfig –list httpd）</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# systemctl is-enabled httpd.service

enabled</code></pre> 
<p>CentOS7下rc.local文件默认不会在开机执行，我们来看一下rc.local文件的内容</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# cat /etc/rc.local

#!/bin/bash

# THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES

#

# It is highly advisable to create own systemd services or udev rules

# to run scripts during boot instead of using this file.

#

# In contrast to previous versions due to parallel execution during boot

# this script will NOT be run after all other services.

#

# Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure

# that this script will be executed during boot.</code></pre> 
<p>可以看到一段注释，翻译如下：</p> 
<p>#这个文件是为了兼容性的问题而添加的。</p> 
<p>#强烈建议创建自己的systemd服务或udev规则来在开机时运行脚本而不是使用这个文件。</p> 
<p>#与以前的版本引导时的并行执行相比较，这个脚本将不会在其他所有的服务后执行。</p> 
<p>#请记住，你必须执行“chmod +x /etc/rc.d/rc.local”来确保确保这个脚本在引导时执行。</p> 
<p>然后我们看/usr/lib/systemd/system/rc-local.service</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# cat /usr/lib/systemd/system/rc-local.service | grep ExecStart

ExecStart=/etc/rc.d/rc.local start</code></pre> 
<p>那我们启动下rc-local.service</p> 
<pre class="has"><code class="language-perl">[root@localhost system]# chmod u+x /etc/rc.d/rc.local

[root@localhost system]# systemctl start rc-local</code></pre> 
<p>总结一下，针对CentOS7系统，需要排查的点：</p> 
<p>1）排查修改的service</p> 
<pre class="has"><code class="language-perl">find /usr/lib/systemd/system/ -name "*.service" | xargs ls -alt | head -n 5
find /etc/systemd/system/ -name "*.service" | xargs ls -alt | head -n 5</code></pre> 
<p>2）/etc/rc.d/init.d</p> 
<p>3）/etc/rc.d/rc.local</p> 
<p>不过需要看/etc/rc.d/rc.local是否有x权限。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/002235dea11c35a971572f53120118a5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决Source Not Found问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c716818e7f9d35978b1a6fc96b485a87/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43; 中max()与max_element()的区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>