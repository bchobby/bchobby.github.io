<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>实用的MCU非阻塞式框架---外设部分 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="实用的MCU非阻塞式框架---外设部分" />
<meta property="og:description" content="常用的单片机裸机非阻塞式框架 仅作参考
ADC采样滤波 0.约1024次AD后采样获取一次温度值
1.支持双电阻高低温区采样
2.一阶滤波、限幅滤波、温差比较 ---- 冒泡排序后取平均值
3.二分法获取查表获取温度
4.添加补偿温度
/**************************************************************************************************** Function Name :void NTC_GetTpTask(void) Description : Author :MECHT Version :V1.0 ****************************************************************************************************/ #define ADC_GROUP 8 #define NTC_GROUP_NUM 16 void NTC_GetTpTask(void) { static uint xdata Su16TempBuf1[ADC_GROUP] = {0}; static uchar xdata Su8BufIndex1 = 0;	//单个通道ADC值数组下标 static uint xdata Su16TempBuf2[ADC_GROUP] = {0}; static uchar xdata Su8BufIndex2 = 0;	//单通道平均值数组下标 static signed int xdata Su16TempBuf3[NTC_GROUP_NUM] = {0}; static uchar xdata Su8BufIndex3 = 0; static signed int xdata OldNtcValue = 0; static uint16_t Tempd = 0; static uint16_t OldAdcValue = 0; uint16_t AdcTempValue = 0; //临时值 uint16_t AdcTempAverage = 0;	//临时平均值 // 此部分根据单片机不同更换，目标都是获取AD值 ADCCON &amp;= ~(0X20); //清零 ADCCON |= 0X40; //Start ADC conversion while(!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/c17c503578f4a493f705d688ba426048/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-03T15:50:26+08:00" />
<meta property="article:modified_time" content="2023-12-03T15:50:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">实用的MCU非阻塞式框架---外设部分</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>常用的单片机裸机非阻塞式框架</h3> 
<p>仅作参考</p> 
<h3><a id="ADC_2"></a>ADC采样滤波</h3> 
<p>0.约1024次AD后采样获取一次温度值<br> 1.支持双电阻高低温区采样<br> 2.一阶滤波、限幅滤波、温差比较 ---- 冒泡排序后取平均值<br> 3.二分法获取查表获取温度<br> 4.添加补偿温度</p> 
<pre><code>/****************************************************************************************************
Function Name       :void NTC_GetTpTask(void)
Description         :
Author              :MECHT
Version             :V1.0
****************************************************************************************************/
#define ADC_GROUP       8
#define NTC_GROUP_NUM   16
void NTC_GetTpTask(void)
{
    static uint  xdata Su16TempBuf1[ADC_GROUP]  = {0};
    static uchar xdata Su8BufIndex1 = 0;				//单个通道ADC值数组下标
    static uint  xdata Su16TempBuf2[ADC_GROUP] = {0};
    static uchar xdata Su8BufIndex2 = 0;			    //单通道平均值数组下标
    static signed int xdata Su16TempBuf3[NTC_GROUP_NUM] = {0};
    static uchar xdata Su8BufIndex3 = 0;
    static signed int xdata OldNtcValue = 0;
    
    
    static uint16_t Tempd = 0;
    static uint16_t OldAdcValue = 0;
    
	uint16_t AdcTempValue   = 0;        //临时值
	uint16_t AdcTempAverage = 0;		//临时平均值
    
    // 此部分根据单片机不同更换，目标都是获取AD值
    ADCCON &amp;= ~(0X20);      //清零
    ADCCON |= 0X40;   //Start ADC conversion
    while(!(ADCCON &amp; 0X20));
    AdcTempValue = (ADCVH&lt;&lt;4)+(ADCVL&gt;&gt;4);
    //======================================================
    //======================================================
    
    //1.一阶滤波,需根据实际情况微调
    if(Su8BufIndex1 == 0)
        OldAdcValue = AdcTempValue;
    Su16TempBuf1[Su8BufIndex1] = 7*OldAdcValue/10 + 3*AdcTempValue/10;
    
    
    if(++Su8BufIndex1 &gt;= ADC_GROUP)
    {
        Su8BufIndex1 = 0;
        
        AdcTempAverage = AdcAverageHandle(Su16TempBuf1,ADC_GROUP,2);  //得到ADC平均值 
        
        Su16TempBuf2[Su8BufIndex2] = AdcTempAverage;
       
        if(++Su8BufIndex2 &gt;= ADC_GROUP)
        {
            Su8BufIndex2 = 0;
            
            NtcInfo.ADValue = AdcAverageHandle(Su16TempBuf2,ADC_GROUP,2); 
            //限幅滤波
            NtcInfo.ADValue  = ADC_Fliter(NtcInfo.ADValue );
            //==========================================================================================
			
			#if 1  //单通道  二分法查询温度
            Tempd = Find_temperaturePos(NtcInfo.ADValue,Cu16TempTable1,TEMP_Table_SIZE1);
            
            Su16TempBuf3[Su8BufIndex3] = -400+Tempd*5;
            if(++Su8BufIndex3 &gt;= NTC_GROUP_NUM)
            {
                Su8BufIndex3 = 0;
                
                NtcInfo.NtcTp = MyAverageHandle(Su16TempBuf3,NTC_GROUP_NUM,6);
                
                //若跟上一次相差0.5℃则不更新
                if((OldNtcValue - NtcInfo.NtcTp) == 5 || (NtcInfo.NtcTp - OldNtcValue)==5)
                {
                    NtcInfo.NtcTp = OldNtcValue;
                }
                else
                {
                    OldNtcValue = NtcInfo.NtcTp;
                }
                
         
                //根据不同模式提供不同的补偿温度
                switch(WorkInfo.Function)
                {
                    case FUN_O:
                       NtcInfo.NtcTp += WorkInfo.OffsetTp1*10;
                    case FUN_W:
                    case FUN_C:
                    case FUN_F:
                        NtcInfo.NtcTp += WorkInfo.OffsetTp2*10;   //补偿温度2
                        break;
                    case FUN_H:
                    case FUN_A:
                        NtcInfo.NtcTp += WorkInfo.OffsetTp3*10;  //补偿温度3
                        break;
                }
                
                if(NtcInfo.NtcTp &gt;= 850)
                    WorkInfo.NtcTemperature[1] = 850;
                else if(NtcInfo.NtcTp &lt;= -300)
                    WorkInfo.NtcTemperature[1] = -300;
                else
                    WorkInfo.NtcTemperature[1] = NtcInfo.NtcTp;
                
                WorkInfo.NtcTemperature[0] = TemperUnitChange(0,WorkInfo.NtcTemperature[1]);
            }
            
			#else  //双通道切换     
            //选择分压电阻
            switch(NtcInfo.DoubleRes)
            {
                case 0:
                    NtcInfo.NtcTp = Find_temperaturePos(NtcInfo.ADValue,Cu16TempTable1,TEMP_Table_SIZE1);
                    if(NtcInfo.NtcTp &gt;= 180)
                    {
                        NtcInfo.DoubleRes = 1;
                        //Pin_key_ntc = 1;        //单电阻
                    }
                    break;
                case 1:
                    NtcInfo.NtcTp = Find_temperaturePos(NtcInfo.ADValue,Cu16TempTable2,TEMP_Table_SIZE2);
                    NtcInfo.NtcTp += 170;	      //根据情况调整
                    if(NtcInfo.NtcTp &lt;= 170)
                    {
                        NtcInfo.DoubleRes = 0;
                       // Pin_key_ntc = 0;        //开双电阻
                    }
                    break;
            }
            //切换PIN脚
            if(NtcInfo.DoubleRes)
            {
                Pin_key_ntc = 0;
            }
            else
            {
                Pin_key_ntc = 1;        //单电阻
            }
			#endif
			
            NtcInfo.GetOnceTpFlag = 1;
        }
	}
    
}
</code></pre> 
<h3><a id="_151"></a>串口无阻塞发送–循环队列（应用层不仅仅适用于串口）</h3> 
<p>1.需要结合循环队列，非阻塞发送<br> 2.单片机资源紧张，串口发送时无需判断是否发送成功，1ms或者2ms发送一字节数据即可</p> 
<pre><code>typedef struct Queue
{
	unsigned char MaxSize;				//最大个数
	unsigned char NowCount;				//参考RTOS 增加当前个数，节省一行数据
	unsigned char head;        			//队头
	unsigned char fail;					//队尾
//	unsigned char (*DataBuf)[]; 		//队列缓冲区，节省空间后面的直接用数组
}QueueObject_t;    //简易队列

unsigned char QueueEmpty(QueueObject_t *Queue)//队空
{
	//return (Queue-&gt;fail==Queue-&gt;head)?1:0;	//减少运算
	return (Queue-&gt;NowCount==0)?1:0;
}
unsigned char QueueFull(QueueObject_t *Queue) //队满
{
	//return (((Queue-&gt;fail+1)%Queue-&gt;MaxSize)== Queue-&gt;head)?1:0;
	return (Queue-&gt;NowCount &gt;= Queue-&gt;MaxSize)?1:0;
}
void QueueAddTail(QueueObject_t *Queue,unsigned char info[],unsigned char length)  //入队 尾插
{
	if((QueueFull(Queue))) 	 //队列满退出
	{
		return;
	}
	
	//MyMemoryCpy(Queue-&gt;DataBuf[Queue-&gt;fail],info,length);
    MyMemoryCpy(SendQueueBuf[Queue-&gt;fail],info,length);			//由队列转换为数组
    
	Queue-&gt;fail = (Queue-&gt;fail+1)%Queue-&gt;MaxSize; //队尾+1，指向+1，此时指向的位置是空的，无数据
	Queue-&gt;NowCount++;                            //总量+1
}

void QueueDelete(QueueObject_t *Queue)//出队,头节点+1
{
	//if((QueueEmpty(Queue))) 	 //队列满退出，根据需求选择覆盖or退出
//	{
//		return;
//	}
	Queue-&gt;head = (Queue-&gt;head+1)%Queue-&gt;MaxSize;
	Queue-&gt;NowCount--;
}

void MyLog_Task(void)
{
	static unsigned char Su8UartSendTimes = 0;   		//发送次数，1次
	static unsigned char Su8SendIntervalCnt = 0; 		//每次发送间隔时间
	static unsigned char Su8SendSuccessIntervalCnt = 0; //一类数据发送完后的发送间隔时间
    
	if(GsUartInfo.Txing)       			//发送数据ing
    {
		//SFR  串口
		//UART_SFR_REG = GsUartInfo.QueueInfo_Tx-&gt;DataBuf[GsUartInfo.QueueInfo_Tx-&gt;head][GsUartInfo.TxBufIndex++]; //为节省空间直接将队列指针改为数组
        UART_SFR_REG = UartSendQueueBuf[GsUartSendQueueInfo.head][GsUartInfo.TxBufIndex++]; //队列改数组
        
        if(GsUartInfo.TxBufIndex &gt;= UartSendQueueBuf[GsUartSendQueueInfo.head][1])
        {
			GsUartInfo.TxBufIndex = 0;
			GsUartInfo.Txing = 0;
			
        }
		return;
    }
	
    if(Su8SendSuccessIntervalCnt != 0)       		//间隔发送，若时间少可去除，比如100ms
	{
		Su8SendSuccessIntervalCnt--;
		return;
	}
	
	if(QueueEmpty(&amp;GsUartSendQueueInfo))          //队列无数据时不发送
    {
		return;
    }

	
	//===========================================
	switch(GsUartInfo.TxStep)   					//发送步骤，间隔时间由轮询位置和case 2 共同决定
	{
		case 0:
			GsUartInfo.TxStep++;
			Su8UartSendTimes = 0;
			Su8SendIntervalCnt = UART_SAME_DATA_INTERVAL_TIME;   //第一次不间隔
			break;
		case 1:   								 	   //发送队列中的数据
			if(Su8UartSendTimes &lt; GsUartInfo.TxTimes)  //固定发送次数模式时
			{
				if(Su8SendIntervalCnt++ &gt;= UART_SAME_DATA_INTERVAL_TIME)//在1ms扫描时，间隔30ms发送以一次
				{
					Su8SendIntervalCnt = 0;
					
                    GsUartInfo.Txing = 1;			//启动发送
                    GsUartInfo.TxBufIndex = 0;		//重新发送
                    Su8UartSendTimes++;
				}
			}
			else								//实际发送多一次间隔时间1ms
			{
				GsUartInfo.TxStep++; //等待ACK,有ACK的情况则继续往下执行，否则会重发队头数据，不出队  //实际上到case 2 需要一段时间
				//加一个比较数据  ---  可用来应对MODBUS协议/或者直接使用队列头数据比较
			}
			break;
			
		case 2:						 		    //发送完成后或者  帧错误(未判断)出队
			Su8UartSendTimes   = 0;
			GsUartInfo.TxStep  = 0;
			QueueDelete(&amp;GsUartSendQueueInfo);   //出队
			Su8SendSuccessIntervalCnt = UART_SEND_FINISH_INTERVAL_TIME;    //间隔
			break;
		default:
			break;
	}
}
</code></pre> 
<h3><a id="_270"></a>软件定时器</h3> 
<p>1.设置1ms定时器中断，设置变量在定时器中断函数中++/–<br> 2.跑裸机都可参考此框架的非阻塞式延时。<br> 3.注意MCU的工作频率和机器周期。</p> 
<pre><code class="prism language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> Cnt1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> Cnt2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>Cnt1<span class="token punctuation">)</span>      	<span class="token comment">//1ms执行一次</span>
		<span class="token punctuation">{<!-- --></span>
			Cnt1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token function">task_1ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//在此任务函数中，可以继续计时</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>Cnt2 <span class="token operator">&gt;=</span> <span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment">//确定时间，10ms执行一次</span>
		<span class="token punctuation">{<!-- --></span>
			Cnt2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token function">task_10ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">timer0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">1</span>
<span class="token punctuation">{<!-- --></span>	
	TL0	<span class="token operator">=</span> <span class="token number">0x1C</span><span class="token punctuation">;</span>	<span class="token comment">//与计算值会有一定偏差，需做补偿</span>
	TH0	<span class="token operator">=</span> <span class="token number">0xFC</span><span class="token punctuation">;</span>	<span class="token comment">//定时器重赋值</span>
	Cnt1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//1ms定时器</span>
	Cnt2<span class="token operator">++</span><span class="token punctuation">;</span>     <span class="token comment">//不定	</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_303"></a>按键扫描</h3> 
<p>1.机械按键按下会产生抖动，通过非阻塞式的延时消抖，轻触按键也可以通过计数消抖。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">KeyScan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">//    if(0)               //开门、故障、某特定情况不需要按键时</span>
<span class="token comment">//        return;</span>
    
    <span class="token comment">//1.获取按键按位值</span>
	GsKeyInfo<span class="token punctuation">.</span>CurrentValue <span class="token operator">=</span> <span class="token function">Drv_Key_New_Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token comment">//2.按下判断和组合判断</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> GsKeyInfo<span class="token punctuation">.</span>CurrentValue<span class="token punctuation">)</span><span class="token comment">//按下</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>GsKeyInfo<span class="token punctuation">.</span>PreValue <span class="token operator">!=</span> GsKeyInfo<span class="token punctuation">.</span>CurrentValue<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>GsKeyInfo<span class="token punctuation">.</span>Pressing <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                GsKeyInfo<span class="token punctuation">.</span>PreValue <span class="token operator">=</span> GsKeyInfo<span class="token punctuation">.</span>CurrentValue<span class="token punctuation">;</span>
                GsKeyInfo<span class="token punctuation">.</span>PressCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>  
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/*
                    此部分不固定，根据需求决定做法
                
                    若按下的情况下切换按键，根据实际情况添加功能
                    1.双键轻触  --- 在脱手处判断时间
                    2.组合键    --- 单变双、三变双，这两个按键需要脱手触发或者按下触发但不是短触
                    3.无功能  ---- 单边多/多变单都不响应
                    4.
                */</span>
<span class="token comment">//                if(GsKeyInfo.PreValue == KeyCombine)             //上一次是组合按键值</span>
<span class="token comment">//                {<!-- --></span>
<span class="token comment">//                    if(GsKeyInfo.CurrentValue == One_of_Combine) //释放了一个属于组合按键值之一的键</span>
<span class="token comment">//                    {<!-- --></span>
<span class="token comment">//                        </span>
<span class="token comment">//                    }</span>
<span class="token comment">//                    else</span>
<span class="token comment">//                    {<!-- --></span>
<span class="token comment">//                       GsKeyInfo.PreValue = GsKeyInfo.CurrentValue;</span>
<span class="token comment">//                         GsKeyInfo.PressCnt = 0;</span>
<span class="token comment">//                    }</span>
<span class="token comment">//                }</span>
<span class="token comment">//                else</span>
                    
                    GsKeyInfo<span class="token punctuation">.</span>PreValue <span class="token operator">=</span> GsKeyInfo<span class="token punctuation">.</span>CurrentValue<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
        
        GsKeyInfo<span class="token punctuation">.</span>Pressing <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        
		GsKeyInfo<span class="token punctuation">.</span>PressCnt<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>GsKeyInfo<span class="token punctuation">.</span>PressCnt <span class="token operator">&gt;=</span> KEY_MAX_TIME<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			GsKeyInfo<span class="token punctuation">.</span>PressCnt <span class="token operator">=</span> KEY_MAX_TIME<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
        <span class="token comment">// ==  1.按下过程的功能</span>
        WorkInfo<span class="token punctuation">.</span>BackLightCnt <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>   <span class="token comment">//按下背光就打开倒计时</span>
		<span class="token comment">//===  2.长按、连续</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>WorkInfo<span class="token punctuation">.</span>WorkMode <span class="token operator">==</span> MODE_WORK<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span></span></span>
			<span class="token keyword">switch</span><span class="token punctuation">(</span>GsKeyInfo<span class="token punctuation">.</span>PreValue<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> KEY_Mode<span class="token operator">:</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>GsKeyInfo<span class="token punctuation">.</span>PressCnt <span class="token operator">==</span> <span class="token number">1000</span><span class="token punctuation">)</span>	<span class="token comment">//长按10S功能</span>
					<span class="token punctuation">{<!-- --></span>
						GsKeyInfo<span class="token punctuation">.</span>Type     <span class="token operator">=</span> KEY_TYPE_LONG<span class="token punctuation">;</span>
						GsKeyInfo<span class="token punctuation">.</span>PressOk  <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
						GsKeyInfo<span class="token punctuation">.</span>ActionValue <span class="token operator">=</span> GsKeyInfo<span class="token punctuation">.</span>PreValue<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
          
			<span class="token punctuation">}</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span><span class="token comment">//松手，进行按键选择</span>
	<span class="token punctuation">{<!-- --></span>
        GsKeyInfo<span class="token punctuation">.</span>Pressing <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>GsKeyInfo<span class="token punctuation">.</span>PressCnt <span class="token operator">&gt;=</span> KEY_SHORT_PRESS_MIN <span class="token operator">&amp;&amp;</span> GsKeyInfo<span class="token punctuation">.</span>PressCnt <span class="token operator">&lt;=</span> KEY_SHORT_PRESS_MAX<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">switch</span><span class="token punctuation">(</span>GsKeyInfo<span class="token punctuation">.</span>PreValue<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">case</span> C_KEY_BitMap_KEY1<span class="token operator">:</span>
				<span class="token keyword">case</span> C_KEY_BitMap_KEY2<span class="token operator">:</span>
				<span class="token keyword">case</span> C_KEY_BitMap_KEY3<span class="token operator">:</span>
				<span class="token keyword">case</span> C_KEY_BitMap_KEY4<span class="token operator">:</span>
					GsKeyInfo<span class="token punctuation">.</span>Type <span class="token operator">=</span> KEY_TYPE_SHORT<span class="token punctuation">;</span> 	<span class="token comment">//短按</span>
					GsKeyInfo<span class="token punctuation">.</span>PressOk <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
					GsKeyInfo<span class="token punctuation">.</span>ActionValue <span class="token operator">=</span> GsKeyInfo<span class="token punctuation">.</span>PreValue<span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">default</span><span class="token operator">:</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		GsKeyInfo<span class="token punctuation">.</span>PressCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment">//松手清零</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Key_Task</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>GsKeyInfo<span class="token punctuation">.</span>PressOk<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		GsKeyInfo<span class="token punctuation">.</span>PressOk <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		
        <span class="token function">KeyFunction</span><span class="token punctuation">(</span>GsKeyInfo<span class="token punctuation">.</span>ActionValue<span class="token punctuation">,</span>GsKeyInfo<span class="token punctuation">.</span>Type<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//根据长、短类型响应功能</span>
		
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span>           </span><span class="token comment">//按键调试串口打印</span></span>
		KeyValuebuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> GsKeyInfo<span class="token punctuation">.</span>ActionValue <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
		KeyValuebuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> GsKeyInfo<span class="token punctuation">.</span>ActionValue <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
		<span class="token function">UartSendDataHandle</span><span class="token punctuation">(</span>KeyValuebuf<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>UART_KEYVALUE<span class="token punctuation">,</span>UartSendBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		GsComInfo<span class="token punctuation">.</span><span class="token function">TxSendFun</span><span class="token punctuation">(</span>UartSendBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
		
		GsKeyInfo<span class="token punctuation">.</span>Type <span class="token operator">=</span> KEY_TYPE_NONE<span class="token punctuation">;</span>						     <span class="token comment">//默认类型</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">KeyFunction</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> ActionValue<span class="token punctuation">,</span><span class="token class-name">uint8_t</span> Type<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	<span class="token keyword">switch</span><span class="token punctuation">(</span>ActionValue<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
        
		<span class="token keyword">case</span> KEY_FanSpeed<span class="token operator">:</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>Type <span class="token operator">==</span> KEY_TYPE_SHORT<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">Key1_Short_Fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>Type <span class="token operator">==</span> KEY_TYPE_LONG<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">Key1_Long_Fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> KEY_Mode<span class="token operator">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>Type <span class="token operator">==</span> KEY_TYPE_SHORT<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">Key2_Short_Fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>Type <span class="token operator">==</span> KEY_TYPE_LONG<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
               
            	<span class="token function">Key2_Long_Fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="COM_457"></a>数码管显示（改为扫描COM可实现调节亮度）</h3> 
<p>1.假设是共阳双八数码管。<br> 2.假设用按键设置时，数码管闪烁显示。<br> 3.假设是单片机的P2口连接数码管引脚。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">DisplayScan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>   <span class="token comment">//1ms定时器中扫描</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> uchar Su8ScanStep <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//动态扫描步骤</span>
	 
	<span class="token keyword">if</span><span class="token punctuation">(</span>GbWorkStatus<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>GbLedEnableFlag <span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//消隐</span>
			P2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token number">0xFF</span><span class="token punctuation">;</span>	<span class="token comment">//共阳，给高电平不亮</span>
			LED_COM1_CLOSE<span class="token punctuation">;</span>				<span class="token comment">//第一个8片选关闭</span>
			LED_COM2_CLOSE<span class="token punctuation">;</span>				<span class="token comment">//第二个8片选关闭</span>

			<span class="token keyword">switch</span><span class="token punctuation">(</span>Su8ScanStep<span class="token punctuation">)</span>			<span class="token comment">//扫描步骤</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>     <span class="token comment">//first</span>
					P2 <span class="token operator">=</span> Gu8LedDigTableBuf<span class="token punctuation">[</span>Gu8LedFirstShowData<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//在外部确定Gu8LedFirstShowData的值是多少，将0-9和部分字母的编码列举在Gu8LedDigTableBuf[]数组中</span>
					LED_COM1_OPEN<span class="token punctuation">;</span>	<span class="token comment">//选中第一个数码管</span>
					LED_COM2_CLOSE<span class="token punctuation">;</span>
					Su8ScanStep<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//下一次显示第二个数码管</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
				
				<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>     <span class="token comment">//second </span>
					P2 <span class="token operator">=</span> Gu8LedDigTableBuf<span class="token punctuation">[</span>Gu8LedSecondShowData<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//第二位数据</span>
					P27 <span class="token operator">=</span> <span class="token operator">!</span>GbLedThirdShowEnable<span class="token punctuation">;</span>				 <span class="token comment">//是否带小数点</span>
					LED_COM1_CLOSE<span class="token punctuation">;</span>
					LED_COM2_OPEN<span class="token punctuation">;</span>
				
					<span class="token comment">//=============================以下为闪烁部分程序，不需要闪烁时，删除下面case 1程序，添加Su8ScanStep = 0;即可</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>GbLedFlickerFlag<span class="token punctuation">)</span>	<span class="token comment">//闪烁标志位，没有要求闪烁的话跳回到第一个数码管的显示</span>
					<span class="token punctuation">{<!-- --></span>
						Gu16LedOffFlickerCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
						Su8ScanStep <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">++</span>Gu16LedOffFlickerCnt <span class="token operator">&gt;=</span> LED_ON_FLICKER_TIME<span class="token punctuation">)</span><span class="token comment">//要求闪烁时，闪烁时期亮的时间</span>
					<span class="token punctuation">{<!-- --></span>
						Gu16LedOffFlickerCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
						Su8ScanStep<span class="token operator">++</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">else</span>
						Su8ScanStep <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span><span class="token comment">//</span>
					LED_COM1_CLOSE<span class="token punctuation">;</span>
					LED_COM2_CLOSE<span class="token punctuation">;</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">++</span>Gu16LedOnFlickerCnt <span class="token operator">&gt;=</span> LED_OFF_FLICKER_TIME<span class="token punctuation">)</span>	<span class="token comment">//闪烁时期灭的时间</span>
					<span class="token punctuation">{<!-- --></span>
						Gu16LedOnFlickerCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
						Su8ScanStep <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			LED_COM1_CLOSE<span class="token punctuation">;</span>
			LED_COM2_CLOSE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_525"></a>无源蜂鸣器</h3> 
<p>1.通电后需要一定震荡频率蜂鸣器才会响。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">BuzTask</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>xBuzInfo<span class="token punctuation">.</span>Times<span class="token punctuation">)</span>  <span class="token comment">//次数</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>xBuzInfo<span class="token punctuation">.</span>Cmd<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>xBuzInfo<span class="token punctuation">.</span>SoftCnt<span class="token operator">--</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>xBuzInfo<span class="token punctuation">.</span>IntervalTime<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					xBuzInfo<span class="token punctuation">.</span>SoftCnt <span class="token operator">=</span> xBuzInfo<span class="token punctuation">.</span>IntervalTime<span class="token punctuation">;</span> <span class="token comment">//间隔</span>
				<span class="token punctuation">}</span>
				xBuzInfo<span class="token punctuation">.</span>Cmd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
				xBuzInfo<span class="token punctuation">.</span>Times<span class="token operator">--</span><span class="token punctuation">;</span>						  	  <span class="token comment">//次数</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">--</span>xBuzInfo<span class="token punctuation">.</span>SoftCnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				xBuzInfo<span class="token punctuation">.</span>SoftCnt <span class="token operator">=</span> xBuzInfo<span class="token punctuation">.</span>OpenTime<span class="token punctuation">;</span>
				xBuzInfo<span class="token punctuation">.</span>Cmd <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
	
	<span class="token punctuation">}</span>
    
    xBuzInfo<span class="token punctuation">.</span><span class="token function">BuzDrv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">BuzDrv</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> <span class="token class-name">uint8_t</span> xdata Su8oldcmd <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>Su8oldcmd <span class="token operator">!=</span> xBuzInfo<span class="token punctuation">.</span>Cmd<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Su8oldcmd <span class="token operator">=</span> xBuzInfo<span class="token punctuation">.</span>Cmd<span class="token punctuation">;</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>xBuzInfo<span class="token punctuation">.</span>Cmd<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			BuzPwm_Enable<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			BuzPwm_Disable<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>##IO口模拟PWM</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">IoToPwmScan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>	<span class="token comment">//放在1ms定时器中</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Enable<span class="token punctuation">)</span>	
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">++</span>Cnt <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span>	<span class="token comment">//100ms低电平</span>
			PIN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>Cnt <span class="token operator">&lt;=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token comment">//100ms高电平</span>
			PIN <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			Cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
		Cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_598"></a>工业开关</h3> 
<p>1.分层扫描，高低都延时，随意更改开关个数</p> 
<pre><code>static void Switch_Scan(void)
{
    static uint8_t xdata Su8SwitchScanStep = 0;
    switch(Su8SwitchScanStep)
    {
        case 0:
            Su8SwitchScanStep = 1;
            break;
        case 1:
            F_SwitchPinValue1 = PIN_DIAL_SWITCH1;
            F_SwitchPinValue2 = PIN_DIAL_SWITCH2;
            F_SwitchPinValue3 = PIN_DIAL_SWITCH3;
            F_SwitchPinValue4 = PIN_DIAL_SWITCH4;
            F_SwitchPinValue5 = PIN_DIAL_SWITCH5;
            F_SwitchPinValue6 = PIN_DIAL_SWITCH6;
            F_SwitchPinValue7 = PIN_DIAL_SWITCH7;
            F_SwitchPinValue8 = PIN_DIAL_SWITCH8;
            Su8SwitchScanStep = 0;                      //修改此处
            break;
//        case 2:
//            P3CON |= 0x80;   
//            SWITCH_COM2 = 0;    //
//            P3CON &amp;= ~0x40;
//            
//            Su8SwitchScanStep = 3;
//            break;
//        case 3:
//            F_SwitchPinValue5 = PIN_DIAL_SWITCH4;
//            F_SwitchPinValue6 = PIN_DIAL_SWITCH3;
//            F_SwitchPinValue7 = PIN_DIAL_SWITCH2;
//            F_SwitchPinValue8 = PIN_DIAL_SWITCH1;
//            Su8SwitchScanStep = 4;
//            break;
//        case 4:
//            Su8SwitchScanStep = 0;
//            break;
        default:
            Su8SwitchScanStep = 0;
            break;
    }
}

static uint8_t GetSwitchValue(unsigned char Pin)
{
	uint8_t PinValue = 0;
	
	switch(Pin)
	{
		case 0:
			PinValue = F_SwitchPinValue1;
			break;
		case 1:
			PinValue = F_SwitchPinValue2;
			break;
		case 2:
			PinValue = F_SwitchPinValue3;
			break;
		case 3:
			PinValue = F_SwitchPinValue4;
			break;
		case 4:
			PinValue = F_SwitchPinValue5;
			break;
		case 5:
			PinValue = F_SwitchPinValue6;
			break;
		case 6:
			PinValue = F_SwitchPinValue7;
			break;
		case 7:
			PinValue = F_SwitchPinValue8;
			break;
	}
	return PinValue;
}


//最后通过200ms滤波获取值
void Drv_DialSwitch(void)
{
	uint8_t i  = 0;			        //max == 255
	uint8_t PinValue = 0;
	static uint8_t xdata Su8LowFilterCnt[Dial_Switch_NUM]  = {0};
    static uint8_t xdata Su8HighFilterCnt[Dial_Switch_NUM] = {0};
    
    Switch_Scan();                      //底层扫描
    
	for(i = 0;i &lt; Dial_Switch_NUM;i++)  //应用层获取
	{
		PinValue = GetSwitchValue(i);   //中间件
		
		if(!PinValue)                   //低电平是ON
		{
			Su8LowFilterCnt[i] = 0;
			
			if(Su8HighFilterCnt[i] &lt; DialSWICHT_FILTER_TIME)
			{
				Su8HighFilterCnt[i]++;
				if(Su8HighFilterCnt[i] &gt;= DialSWICHT_FILTER_TIME)
				{
					Gu8SwitchStateFlag_Ass |= 0x01 &lt;&lt; i;
				}
			}
		}
		else
		{
			Su8HighFilterCnt[i] = 0;
			
			if(Su8LowFilterCnt[i] &lt; DialSWICHT_FILTER_TIME)
			{
				Su8LowFilterCnt[i]++;
				if(Su8LowFilterCnt[i] &gt;= DialSWICHT_FILTER_TIME)
				{
					Gu8SwitchStateFlag_Ass &amp;= ~(0x01 &lt;&lt; i);
				}
			}
		}
	}
}
</code></pre> 
<p>最后：<br> 为避免全局变量满天飞，用结构体管理全局变量，若MCU内存不够，最后可解耦；</p> 
<pre><code>typedef struct
{
	/*
		MenuParameterSet: 为当前设置对象，在进行 +- 时无需判断模式
		MenuNub: 菜单编号，为功能之下的子菜单,初始化为1
	*/
    unsigned char Versions;     	// 版本号
    unsigned char BoardVersions;    // 软件版本
    unsigned char ID;              
    unsigned char Unit:1;           // 温度单位      0：F  1：C
    unsigned char TpType:1;        // 当前温度类型
    
    unsigned char ReinstatedFactoryFlag:1;  //恢复出场设置标志
    
    unsigned char BuzEn:1;          //蜂鸣器使能控制
    unsigned char OffsetTp1;        //补偿温度1         
    unsigned char OffsetTp2;        //补偿温度2 
    
    unsigned char WifiFlag:1;       // WIFI连接情况
    unsigned char WorkSwitch1:1;   
    unsigned char WorkSwitch2:1;    
    unsigned char WorkSwitch3:1;    
    unsigned char WorkSwitch4:1;  
   
    unsigned char CommSuccess:1;    // 通讯完成标志
    
    unsigned int SetTemperature[2]; // 设置温度 0：F  1：C
    signed int NtcTemperature[2];   // 环境温度 0：F  1：C
    
    
	unsigned char WorkMode;      	// 工作状态：	自检、自检模式、关机、待机、设置、工作
	unsigned char OldWorkMode;		// 上一次工作模式
	
    unsigned char Function;         // 功能
    unsigned char OldFunction;
    FunctionObject_t *FunObject;    // 当前功能对应参数

    unsigned char BackLightCnt;	    // 背光倒计时  默认5S

    unsigned char InitStep;         // 初始化步骤
    unsigned int InitCnt;           // 初始化计时器
    
    unsigned char NTC_State;        // NTC状态
   
    
    //=======================  故障
    unsigned char ErrorFlag:1;		// 有故障标志
    unsigned char ErrorShowCnt;     // 故障显示计时器
	unsigned int ErrorNub;			// 故障编号      //或起来显示的故障点
    unsigned int ErrorNubBackup;    // 故障编号备份 

    unsigned char BatVoltage;       //电池电压 
    //=========================================================
    unsigned int SpecialFunCnt;             //特殊功能计时器
    
    unsigned char LowVolFlag:1;     // 低压信号
    unsigned int LowHighVolStayCnt; // 低压保持时间 
    
	unsigned char CheckStep;		// 测试步骤
    unsigned char CheckCnt;            // 测试时间
    
    //======================= 预留 ==================
    unsigned int WorkTimeS;
    unsigned int WorkTimeUpCnt;
    unsigned int WorkTestCnt;
}WorkManageObject_t;
extern WorkManageObject_t xdata WorkInfo;
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9cc8f7dcb5274271548915e539b7043c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">shell脚本（一）—— 批量修改文件中的内容</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d660d6ad9df3f91c867c9d74d1e851e0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【话题】程序员的养生之法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>