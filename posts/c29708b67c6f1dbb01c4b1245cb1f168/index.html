<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>springCloud技术总结分享 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="springCloud技术总结分享" />
<meta property="og:description" content="文章目录 1.简介2 项目搭建2.1 Commons2.1.1 pojo2.1.2 service2.1.3 util 2.2 item service 商品服务2.3 user service 用户服务2.4 order service 订单服务2.5 测试 3. eureka 注册与发现3.1 实例操作3.1.1 eureka 注册与发现3.1.2 service provider 服务提供者 4.ribbon4.1 项目搭建4.2 eureka 和 “服务提供者”的高可用4.3 ribbon 负载均衡4.4 ribbon 重试 5 hystrix 断路器5.1 原理简介5.2 实例操作5.3 hystrix dashboard 断路器仪表盘 6.feignfeign &#43; ribbon 负载均衡和重试feign &#43; hystrix 降级feign &#43; hystrix 监控和熔断测试order service 调用商品库存服务和用户服务hystrix &#43; turbine 集群聚合监控 7. zuul API网关zuul 路由实例操作zuul 过滤实例操作 8. config 配置中心config创建项目应用 9. Spring Cloud Busconfig bus &#43; rabbitmq 消息总线配置刷新config 本地文系统 10." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/c29708b67c6f1dbb01c4b1245cb1f168/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-17T23:10:30+08:00" />
<meta property="article:modified_time" content="2020-05-17T23:10:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">springCloud技术总结分享</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1_3" rel="nofollow">1.简介</a></li><li><a href="#2__37" rel="nofollow">2 项目搭建</a></li><li><ul><li><a href="#21_Commons_133" rel="nofollow">2.1 Commons</a></li><li><ul><li><a href="#211__pojo_136" rel="nofollow">2.1.1 pojo</a></li><li><a href="#212__service_170" rel="nofollow">2.1.2 service</a></li><li><a href="#213_util_201" rel="nofollow">2.1.3 util</a></li></ul> 
   </li><li><a href="#22_item_service__793" rel="nofollow">2.2 item service 商品服务</a></li><li><a href="#23__user_service__858" rel="nofollow">2.3 user service 用户服务</a></li><li><a href="#24_order_service__932" rel="nofollow">2.4 order service 订单服务</a></li><li><a href="#25__1004" rel="nofollow">2.5 测试</a></li></ul> 
  </li><li><a href="#3_eureka__1027" rel="nofollow">3. eureka 注册与发现</a></li><li><ul><li><a href="#31__1061" rel="nofollow">3.1 实例操作</a></li><li><ul><li><a href="#311_eureka__1062" rel="nofollow">3.1.1 eureka 注册与发现</a></li><li><a href="#312_service_provider__1170" rel="nofollow">3.1.2 service provider 服务提供者</a></li></ul> 
  </li></ul> 
  </li><li><a href="#4ribbon_1207" rel="nofollow">4.ribbon</a></li><li><ul><li><a href="#41__1235" rel="nofollow">4.1 项目搭建</a></li><li><a href="#42_eureka___1385" rel="nofollow">4.2 eureka 和 “服务提供者”的高可用</a></li><li><a href="#43_ribbon__1510" rel="nofollow">4.3 ribbon 负载均衡</a></li><li><a href="#44_ribbon__1539" rel="nofollow">4.4 ribbon 重试</a></li></ul> 
  </li><li><a href="#5_hystrix__1649" rel="nofollow">5 hystrix 断路器</a></li><li><ul><li><a href="#51__1650" rel="nofollow">5.1 原理简介</a></li><li><a href="#52__1677" rel="nofollow">5.2 实例操作</a></li><li><a href="#53_hystrix_dashboard__1864" rel="nofollow">5.3 hystrix dashboard 断路器仪表盘</a></li></ul> 
  </li><li><a href="#6feign_2068" rel="nofollow">6.feign</a></li><li><ul><li><a href="#feign__ribbon__2334" rel="nofollow">feign + ribbon 负载均衡和重试</a></li><li><a href="#feign__hystrix__2369" rel="nofollow">feign + hystrix 降级</a></li><li><a href="#feign__hystrix__2491" rel="nofollow">feign + hystrix 监控和熔断测试</a></li><li><a href="#order_service__2571" rel="nofollow">order service 调用商品库存服务和用户服务</a></li><li><a href="#hystrix__turbine__2843" rel="nofollow">hystrix + turbine 集群聚合监控</a></li></ul> 
  </li><li><a href="#7_zuul_API_2960" rel="nofollow">7. zuul API网关</a></li><li><ul><li><a href="#zuul__2986" rel="nofollow">zuul 路由</a></li><li><a href="#_3050" rel="nofollow">实例操作</a></li><li><a href="#zuul__3438" rel="nofollow">zuul 过滤</a></li><li><a href="#_3527" rel="nofollow">实例操作</a></li></ul> 
  </li><li><a href="#8_config__3583" rel="nofollow">8. config 配置中心</a></li><li><ul><li><a href="#config_3609" rel="nofollow">config创建</a></li><li><a href="#_3648" rel="nofollow">项目应用</a></li></ul> 
  </li><li><a href="#9_Spring_Cloud_Bus_3949" rel="nofollow">9. Spring Cloud Bus</a></li><li><ul><li><a href="#config_bus__rabbitmq__3964" rel="nofollow">config bus + rabbitmq 消息总线配置刷新</a></li><li><a href="#config__4082" rel="nofollow">config 本地文系统</a></li></ul> 
  </li><li><a href="#10sleuth__4146" rel="nofollow">10.sleuth 链路跟踪</a></li><li><a href="#11sleuth__zipkin__4179" rel="nofollow">11.sleuth + zipkin 链路分析</a></li><li><a href="#_4249" rel="nofollow">总结</a></li><li><a href="#githubhttpsgithubcomlmy1965673628spdemogithttpsgithubcomlmy1965673628spdemogit_4283" rel="nofollow">github地址：[https://github.com/lmy1965673628/sp-demo.git](https://github.com/lmy1965673628/sp-demo.git)</a></li><li><a href="#cenos7httpspanbaiducoms1ioduPYTecZXH143S_5wUzAhttpspanbaiducoms1ioduPYTecZXH143S_5wUzA__qhhd_4284" rel="nofollow">cenos7镜像，链接：[https://pan.baidu.com/s/1ioduPYTecZXH143S_5wUzA](https://pan.baidu.com/s/1ioduPYTecZXH143S_5wUzA) 提取码：qhhd</a></li></ul> 
</div> 
<br> 本节教程开始学习springcloud的相关技术知识。在前几篇文章中我们讲解了目前主流技术的相关知识和案例实践，如redis缓存框架，Dubbo服务框架，nginx服务器框架，docker容器等系列知识。很期待各位能与本人进行技术交流。 
<br> 开始！ 
<p></p> 
<h2><a id="1_3"></a>1.简介</h2> 
<p>spring cloud 是<strong>一系列框架的集合</strong>。它利用 spring boot 的开发便利性巧妙地简化了分布式系统基础设施的开发，如服<strong>务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控</strong>等，都可以用 spring boot 的开发风格做到<strong>一键启动和部署</strong>。spring cloud 并没有重复制造轮子，它只是将目前各家公司开发的比较成熟、经得起实际考验的服务框架组合起来，通过 spring boot 风格进行再封装屏蔽掉了复杂的配置和实现原理，最终给开发者留出了一套<strong>简单易懂、易部署和易维护的分布式系统开发工具包</strong>。</p> 
<p>spring cloud 对于中小型互联网公司来说是一种福音，因为这类公司往往没有实力或者没有足够的资金投入去开发自己的分布式系统基础设施，使用 spring cloud <strong>一站式解决方案</strong>能在从容应对业务发展的同时<strong>大大减少开发成本</strong>。同时，随着近几年<strong>微服务架构和 docker 容器概念</strong>的火爆，也会让 spring cloud 在未来越来越“云”化的软件开发风格中立有一席之地，尤其是在目前五花八门的分布式解决方案中提供了<strong>标准化的、一站式的技术方案</strong>，意义可能会堪比当年 servlet 规范的诞生，有效推进服务端软件系统技术水平的进步。</p> 
<p>看下面的图，这是一套简洁版的架构设计图。我们依次进行讲解！<br> <img src="https://images2.imgbox.com/83/1e/KzemZMD9_o.png" alt="在这里插入图片描述">首先说一下它的技术组成<br> <strong>eureka</strong><br> 微服务治理，服务注册和发现<br> <strong>ribbon</strong><br> 负载均衡、请求重试<br> <strong>hystrix</strong><br> 断路器，服务降级、熔断<br> <strong>feign</strong><br> ribbon + hystrix 集成，并提供生命式客户端<br> <strong>hystrix dashboard 和 turbine</strong><br> hystrix 微服务监控<br> <strong>zuul</strong><br> API 网关，提供微服务的统一入口，并提供统一的权限验证<br> <strong>config</strong><br> 配置中心<br> <strong>bus</strong><br> 消息总线, 配置刷新<br> <strong>sleuth+zipkin</strong><br> 链路跟踪</p> 
<p><strong><mark>Spring Cloud 对比 Dubbo</mark></strong><br> <em><strong>Dubbo<br> Dubbo只是一个远程调用(RPC)框架<br> 默认基于长连接,支持多种序列化格式<br> Spring Cloud<br> 框架集<br> 提供了一整套微服务解决方案(全家桶)</strong></em><br> <img src="https://images2.imgbox.com/84/d0/0uZIYQQE_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2__37"></a>2 项目搭建</h2> 
<p>先将项目搭起来，结合实例讲解，比较容易下手<br> 本项目共分为三个服务：<br> <img src="https://images2.imgbox.com/64/90/8WJSj1p4_o.png" alt="在这里插入图片描述"></p> 
<ul><li>商品服务 item service，端口 8001</li><li>用户服务 user service，端口 8101</li><li>订单服务 order service，端口 8201</li></ul> 
<p>创建一个空的maven的项目，作为父级，删掉里面的src文件<br> <img src="https://images2.imgbox.com/d7/e2/fyI5i9go_o.png" alt="在这里插入图片描述"><br> 在pom.xml添加依赖</p> 
<pre><code class="prism language-powershell"> &lt;parent&gt;
        &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
        &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>parent&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;version&gt;2<span class="token punctuation">.</span>1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>RELEASE&lt;<span class="token operator">/</span>version&gt;
 &lt;<span class="token operator">/</span>parent&gt;
 &lt;dependencies&gt;
  		&lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>test&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;scope&gt;test&lt;<span class="token operator">/</span>scope&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>vintage&lt;<span class="token operator">/</span>groupId&gt;
                    &lt;artifactId&gt;junit<span class="token operator">-</span>vintage<span class="token operator">-</span>engine&lt;<span class="token operator">/</span>artifactId&gt;
                &lt;<span class="token operator">/</span>exclusion&gt;
            &lt;<span class="token operator">/</span>exclusions&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>module&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;jackson<span class="token operator">-</span>module<span class="token operator">-</span>parameter<span class="token operator">-</span>names&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;version&gt;2<span class="token punctuation">.</span>9<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>version&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>datatype&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;jackson<span class="token operator">-</span>datatype<span class="token operator">-</span>jdk8&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;version&gt;2<span class="token punctuation">.</span>9<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>version&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>datatype&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;jackson<span class="token operator">-</span>datatype<span class="token operator">-</span>jsr310&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;version&gt;2<span class="token punctuation">.</span>9<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>version&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>datatype&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;jackson<span class="token operator">-</span>datatype<span class="token operator">-</span>guava&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;version&gt;2<span class="token punctuation">.</span>9<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>version&gt;
        &lt;<span class="token operator">/</span>dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>projectlombok&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;lombok&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;version&gt;1<span class="token punctuation">.</span>18<span class="token punctuation">.</span>6&lt;<span class="token operator">/</span>version&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;javax<span class="token punctuation">.</span>servlet&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;javax<span class="token punctuation">.</span>servlet<span class="token operator">-</span>api&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;version&gt;3<span class="token punctuation">.</span>1<span class="token punctuation">.</span>0&lt;<span class="token operator">/</span>version&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>slf4j&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;slf4j<span class="token operator">-</span>api&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;version&gt;1<span class="token punctuation">.</span>7<span class="token punctuation">.</span>26&lt;<span class="token operator">/</span>version&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;commons<span class="token operator">-</span>lang3&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;version&gt;3<span class="token punctuation">.</span>9&lt;<span class="token operator">/</span>version&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
         &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>projectlombok&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;lombok&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;optional&gt;true&lt;<span class="token operator">/</span>optional&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
    &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>maven<span class="token punctuation">.</span>plugins&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;maven<span class="token operator">-</span>compiler<span class="token operator">-</span>plugin&lt;<span class="token operator">/</span>artifactId&gt;
                &lt;version&gt;3<span class="token punctuation">.</span>8<span class="token punctuation">.</span>0&lt;<span class="token operator">/</span>version&gt;
                &lt;configuration&gt;
                    &lt;source&gt;1<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>source&gt;
                    &lt;target&gt;1<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>target&gt;
                &lt;<span class="token operator">/</span>configuration&gt;
            &lt;<span class="token operator">/</span>plugin&gt;
        &lt;<span class="token operator">/</span>plugins&gt;
    &lt;<span class="token operator">/</span>build&gt;
</code></pre> 
<h3><a id="21_Commons_133"></a>2.1 Commons</h3> 
<p>创建Commons模块项目，右击项目，创建module项目<br> <img src="https://images2.imgbox.com/ff/95/9rkKKAUd_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/26/6d/i3N1XTDA_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="211__pojo_136"></a>2.1.1 pojo</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Item</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">Integer</span> number<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">User</span> user<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="212__service_170"></a>2.1.2 service</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ItemService</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//根据订单的id,获取订单中的商品列表</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//用户保存订单时,购买的所有商品,要减少商品库存</span>
	<span class="token keyword">void</span> <span class="token function">decreaseNumbers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//根据订单id,获取订单信息</span>
	<span class="token class-name">Order</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//保存订单</span>
	<span class="token keyword">void</span> <span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//根据用户id,获取用户的信息</span>
	<span class="token class-name">User</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//用户保存一个订单时,增加用户的积分</span>
	<span class="token keyword">void</span> <span class="token function">addScore</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">,</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="213_util_201"></a>2.1.3 util</h4> 
<p><strong>CookieUtil</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CookieUtil</span> <span class="token punctuation">{<!-- --></span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">String</span> domain<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> maxAge<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>domain <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			cookie<span class="token punctuation">.</span><span class="token function">setDomain</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
		cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span>maxAge<span class="token punctuation">)</span><span class="token punctuation">;</span>
		response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> maxAge<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">setCookie</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> maxAge<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">setCookie</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">setCookie</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token class-name">Cookie</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookies <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Cookie</span> cookie <span class="token operator">:</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					value <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> value<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">removeCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> domain<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">setCookie</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> domain<span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>JsonUtil</strong> 包含了对json操作的各种形式，满足开发几乎所有操作，建议收藏</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonUtil</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ObjectMapper</span> mapper<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">JsonInclude<span class="token punctuation">.</span>Include</span> DEFAULT_PROPERTY_INCLUSION <span class="token operator">=</span> <span class="token class-name">JsonInclude<span class="token punctuation">.</span>Include</span><span class="token punctuation">.</span>NON_DEFAULT<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> IS_ENABLE_INDENT_OUTPUT <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> CSV_DEFAULT_COLUMN_SEPARATOR <span class="token operator">=</span> <span class="token string">","</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">initMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">configPropertyInclusion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">configIndentOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">configCommon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson config error"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">configCommon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">config</span><span class="token punctuation">(</span>mapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">configPropertyInclusion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mapper<span class="token punctuation">.</span><span class="token function">setSerializationInclusion</span><span class="token punctuation">(</span>DEFAULT_PROPERTY_INCLUSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">configIndentOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mapper<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span>INDENT_OUTPUT<span class="token punctuation">,</span> IS_ENABLE_INDENT_OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        objectMapper<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">JsonGenerator<span class="token punctuation">.</span>Feature</span><span class="token punctuation">.</span>WRITE_BIGDECIMAL_AS_PLAIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">DeserializationFeature</span><span class="token punctuation">.</span>ACCEPT_EMPTY_STRING_AS_NULL_OBJECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">DeserializationFeature</span><span class="token punctuation">.</span>ACCEPT_SINGLE_VALUE_AS_ARRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">DeserializationFeature</span><span class="token punctuation">.</span>FAIL_ON_READING_DUP_TREE_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">DeserializationFeature</span><span class="token punctuation">.</span>FAIL_ON_NUMBERS_FOR_ENUMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token class-name">DeserializationFeature</span><span class="token punctuation">.</span>FAIL_ON_UNKNOWN_PROPERTIES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token class-name">DeserializationFeature</span><span class="token punctuation">.</span>FAIL_ON_NULL_FOR_PRIMITIVES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span>FAIL_ON_EMPTY_BEANS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">JsonParser<span class="token punctuation">.</span>Feature</span><span class="token punctuation">.</span>ALLOW_COMMENTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token class-name">JsonGenerator<span class="token punctuation">.</span>Feature</span><span class="token punctuation">.</span>ESCAPE_NON_ASCII<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">JsonGenerator<span class="token punctuation">.</span>Feature</span><span class="token punctuation">.</span>IGNORE_UNKNOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">JsonParser<span class="token punctuation">.</span>Feature</span><span class="token punctuation">.</span>ALLOW_UNQUOTED_FIELD_NAMES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span>WRITE_DATES_AS_TIMESTAMPS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">setDateFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token class-name">JsonParser<span class="token punctuation">.</span>Feature</span><span class="token punctuation">.</span>ALLOW_SINGLE_QUOTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ParameterNamesModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Jdk8Module</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JavaTimeModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GuavaModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setSerializationInclusion</span><span class="token punctuation">(</span><span class="token class-name">JsonInclude<span class="token punctuation">.</span>Include</span> inclusion<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        DEFAULT_PROPERTY_INCLUSION <span class="token operator">=</span> inclusion<span class="token punctuation">;</span>
        <span class="token function">configPropertyInclusion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setIndentOutput</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isEnable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        IS_ENABLE_INDENT_OUTPUT <span class="token operator">=</span> isEnable<span class="token punctuation">;</span>
        <span class="token function">configIndentOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">V</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson from error, url: {}, type: {}"</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">V</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson from error, type: {}"</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">V</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson from error, file path: {}, type: {}"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">V</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">Object</span> jsonObj<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>jsonObj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson from error, json: {}, type: {}"</span><span class="token punctuation">,</span> jsonObj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">V</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson from error, json: {}, type: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> c<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">V</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">,</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson from error, url: {}, type: {}"</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">V</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">,</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson from error, type: {}"</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">V</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">,</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson from error, file path: {}, type: {}"</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">V</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">Object</span> jsonObj<span class="token punctuation">,</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>jsonObj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson from error, json: {}, type: {}"</span><span class="token punctuation">,</span> jsonObj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">V</span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson from error, json: {}, type: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> type<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">String</span> <span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson to error, obj: {}"</span><span class="token punctuation">,</span> list<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">String</span> <span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">V</span> v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson to error, obj: {}"</span><span class="token punctuation">,</span> v<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">toFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Writer</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mapper<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValues</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeAll</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
            writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson to file error, path: {}, list: {}"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> list<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">toFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">V</span> v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Writer</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mapper<span class="token punctuation">.</span><span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValues</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
            writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson to file error, path: {}, obj: {}"</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> v<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson get string error, json: {}, key: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> <span class="token function">getInt</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson get int error, json: {}, key: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Long</span> <span class="token function">getLong</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson get long error, json: {}, key: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Double</span> <span class="token function">getDouble</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson get double error, json: {}, key: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BigInteger</span> <span class="token function">getBigInteger</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">0.00</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bigIntegerValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson get biginteger error, json: {}, key: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BigDecimal</span> <span class="token function">getBigDecimal</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decimalValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson get bigdecimal error, json: {}, key: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">booleanValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson get boolean error, json: {}, key: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getByte</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">binaryValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson get byte error, json: {}, key: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getList</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> string <span class="token operator">=</span> <span class="token function">getString</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">from</span><span class="token punctuation">(</span>string<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ArrayList</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">String</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson add error, json: {}, key: {}, value: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> json<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">JsonNode</span> jsonNode<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Short</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Short</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Integer</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Long</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Float</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Float</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Double</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">BigInteger</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> jsonNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson remove error, json: {}, key: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> json<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">String</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectNode</span><span class="token punctuation">)</span> node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson update error, json: {}, key: {}, value: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> json<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">JsonNode</span> node <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> mapper<span class="token punctuation">.</span><span class="token function">writerWithDefaultPrettyPrinter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson format json error, json: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> json<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isJson</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            mapper<span class="token punctuation">.</span><span class="token function">readTree</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"jackson check json error, json: {}"</span><span class="token punctuation">,</span> json<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">InputStream</span> <span class="token function">getResourceStream</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">InputStreamReader</span> <span class="token function">getResourceReader</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> inputStream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>JsonResult</strong>，此工具类也提供了多种响应形式，建议收藏</p> 
<pre><code class="prism language-java">
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 成功
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SUCCESS <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 没有登录
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NOT_LOGIN <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 发生异常
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> EXCEPTION <span class="token operator">=</span> <span class="token number">401</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 系统错误
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SYS_ERROR <span class="token operator">=</span> <span class="token number">402</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 参数错误
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> PARAMS_ERROR <span class="token operator">=</span> <span class="token number">403</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 不支持或已经废弃
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NOT_SUPPORTED <span class="token operator">=</span> <span class="token number">410</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * AuthCode错误
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INVALID_AUTHCODE <span class="token operator">=</span> <span class="token number">444</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 太频繁的调用
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TOO_FREQUENT <span class="token operator">=</span> <span class="token number">445</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 未知的错误
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> UNKNOWN_ERROR <span class="token operator">=</span> <span class="token number">499</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JsonResult</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JsonResult</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JsonResult</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">,</span> <span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">code</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">msg</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JsonResult</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JsonResult</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>SUCCESS<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>SUCCESS<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JsonResult</span> <span class="token function">err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>EXCEPTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JsonResult</span> <span class="token function">err</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>EXCEPTION<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22_item_service__793"></a>2.2 item service 商品服务</h3> 
<p>创建一个module项目，选择springboot<br> <img src="https://images2.imgbox.com/eb/73/VLnHpVdF_o.png" alt="在这里插入图片描述">看一下结构，创建图所示的controller，service包。<br> <img src="https://images2.imgbox.com/97/bb/gCmLKID1_o.png" alt="在这里插入图片描述"><br> ItemServiceImpl</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ItemService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"商品 1"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"商品 2"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"商品 3"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"商品 4"</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"商品 5"</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decreaseNumbers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Item</span> item <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"减少库存 - "</span><span class="token operator">+</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ItemService</span> itemService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${server.port}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{orderId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"server.port="</span><span class="token operator">+</span>port<span class="token operator">+</span><span class="token string">", orderId="</span><span class="token operator">+</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> itemService<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token string">"port="</span><span class="token operator">+</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/decreaseNumber"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">decreaseNumber</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        itemService<span class="token punctuation">.</span><span class="token function">decreaseNumbers</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>application.yml<br> <img src="https://images2.imgbox.com/5f/18/77vuZXXr_o.png" alt="在这里插入图片描述"><br> 修改pom.xml，引入Commons，并依赖父级<br> <img src="https://images2.imgbox.com/07/04/yLycXvZr_o.png" alt="在这里插入图片描述">在父级的pom.xml中添加module<br> <img src="https://images2.imgbox.com/f7/e7/1N1JueP7_o.png" alt="在这里插入图片描述"><br> 运行看一下是否成功。若启动失败，请查看具体原因进行分析，若需帮助，请留言。</p> 
<h3><a id="23__user_service__858"></a>2.3 user service 用户服务</h3> 
<p>过程跟上面一样，创建一个module项目，选择spring boot<br> 请自行创建吧！，目录结构如下<br> <img src="https://images2.imgbox.com/32/4e/A2Th27eO_o.png" alt="在这里插入图片描述"><br> <strong>UserServiceImpl</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${sp.user-service.users}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userJson<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"users json string : "</span><span class="token operator">+</span>userJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>userJson<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">User</span> u <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> u<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">"name-"</span><span class="token operator">+</span>id<span class="token punctuation">,</span> <span class="token string">"pwd-"</span><span class="token operator">+</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addScore</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">,</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//TODO 这里增加积分</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"user "</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">" - 增加积分 "</span><span class="token operator">+</span>score<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>UserController</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{userId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"get user, userId="</span><span class="token operator">+</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> u <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{userId}/score"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addScore</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        userService<span class="token punctuation">.</span><span class="token function">addScore</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">sp</span><span class="token punctuation">:</span>
  <span class="token key atrule">user-service</span><span class="token punctuation">:</span>
    <span class="token key atrule">users</span><span class="token punctuation">:</span> <span class="token string">"[{\"id\":7, \"username\":\"abc\",\"password\":\"123\"},{\"id\":8, \"username\":\"def\",\"password\":\"456\"},{\"id\":9, \"username\":\"ghi\",\"password\":\"789\"}]"</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8101</span>
</code></pre> 
<p><strong>pom.xml的配置跟item-service一样</strong></p> 
<p>启动程序，检验是否成功运行</p> 
<h3><a id="24_order_service__932"></a>2.4 order service 订单服务</h3> 
<p>一样的套路，创建一个子module，名字为order-service<br> <img src="https://images2.imgbox.com/5d/9b/NnWGNxC2_o.png" alt="在这里插入图片描述"><br> <strong>OrderServiceImpl</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//TODO: 调用user-service获取用户信息</span>
        <span class="token comment">//TODO: 调用item-service获取商品信息</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//TODO: 调用item-service减少商品库存</span>
        <span class="token comment">//TODO: 调用user-service增加用户积分</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"保存订单："</span><span class="token operator">+</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>OrderController</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{orderId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"get order, id="</span><span class="token operator">+</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Order</span> order <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//模拟post提交的数据</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">"123abc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"aaa"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"bbb"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">"ccc"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">"ddd"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">"eee"</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderService<span class="token punctuation">.</span><span class="token function">addOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8201</span>
</code></pre> 
<p><strong>pom.xml的配置跟item-service一样</strong></p> 
<h3><a id="25__1004"></a>2.5 测试</h3> 
<p>本次使用的工具是<strong>PostMan</strong>,启动所有服务<br> <img src="https://images2.imgbox.com/48/dd/MBaDdgkE_o.png" alt="在这里插入图片描述"></p> 
<ol><li> <p><strong>item-service</strong><br> 根据orderid，查询商品 http://localhost:8001/35。查看结果<br> <img src="https://images2.imgbox.com/1d/b4/iWWOvTQ0_o.png" alt="在这里插入图片描述">减少商品库存<br> http://localhost:8001/decreaseNumber<br> 使用postman，POST发送以下格式数据：<br> <mark><em>[{“id”:1, “name”:“abc”, “number”:23},{“id”:2, “name”:“def”, “number”:11}]</em></mark><br> <img src="https://images2.imgbox.com/dc/0e/rw4yadbB_o.png" alt="在这里插入图片描述"></p> </li><li> <p>user-service<br> 根据userid查询用户信息<br> <a href="http://localhost:8101/7" rel="nofollow">http://localhost:8101/7</a><br> 根据userid，为用户增加积分<br> <a rel="nofollow">http://localhost:8101/7/score?score=100</a></p> </li><li> <p>order-service<br> 根据orderid，获取订单<br> <a href="http://localhost:8201/123abc" rel="nofollow">http://localhost:8201/123abc</a><br> 保存订单，观察控制台日志输出<br> <a href="http://localhost:8201/" rel="nofollow">http://localhost:8201/</a></p> </li></ol> 
<h2><a id="3_eureka__1027"></a>3. eureka 注册与发现</h2> 
<p>看一下官网解释：<br> Eureka是基于REST（代表性状态转移）的服务，主要在AWS云中用于定位服务，以实现负载均衡和中间层服务器的故障转移。我们称此服务为Eureka服务器。Eureka还带有一个基于Java的客户端组件Eureka Client，它使与服务的交互变得更加容易。客户端还具有一个内置的负载平衡器，可以执行基本的循环负载平衡。在Netflix，更复杂的负载均衡器将Eureka包装起来，以基于流量，资源使用，错误条件等多种因素提供加权负载均衡，以提供出色的弹性。</p> 
<p>总结一下，它就是一个服务发现框架，服务？发现？是不是有点懵呢？OK，举个例子，拿租房子的案例说说。</p> 
<p>若没有中介的情况下，用户找房子租住，需要一个一个的寻找有房源的房东，费时费力，终究个人有限，找不到很多的房源。用户就相当于微服务的customer，房东相当于微服务的provider。消费者Consumer需要调用提供者Provider提供的一些服务，就像我们现在需要租他们的房子一样。</p> 
<p>若只是租客和房东之间直接进行寻找，效率是很低的，房东找不到租客赚不到钱，租客找不到房东住不了房。所以，房东需要将自己房源信息广播出去，如贴小广告，但是又有问题就出现了。<br> 1 不是租客的也能收到这种租房消息，这在现实世界没什么，但是在计算机的世界中就会出现资源消耗的问题。第二、租客这样还是很难找到你，试想一下我需要租房，我还需要东一个西一个地去找小广告吗，麻不麻烦？</p> 
<p>找中介就不一样了，它是为我们提供了统一房源的地方，我们消费者只需要跑到它那里去找就行了。而对于房东来说，他们也只需要把房源在中介那里发布就行了。</p> 
<p>看一下关系图：</p> 
<p><img src="https://images2.imgbox.com/0c/6a/YRsGK8lm_o.png" alt="在这里插入图片描述">但是，又有问题出现了：<br> 房东登记房源信息之后如果不想卖房子了怎么办？我们是不是需要让房东定期续约？如果房东不进行续约是不是要将他们从中介那里的注册列表中移除。<br> 租客是不是也要进行注册呢？不然合同乙方怎么来呢？<br> 中介可不可以做连锁店呢？如果这一个店因为某些不可抗力因素而无法使用，那么我们是否可以换一个连锁店呢？<br> 再看一下设计图：<br> <img src="https://images2.imgbox.com/e4/32/Ugh29bv6_o.png" alt="在这里插入图片描述">OK，接下来我们再看一下Eureka的相关概念<br> <strong>服务注册 Register：</strong><br> 当 Eureka 客户端向[<strong>Eureka</strong>] Server注册时，它将提供自身的元数据，比如IP地址、端口，运行状况指示符URL，主页等。<br> <strong>服务续约 Renew：</strong><br> Eureka 客户会每隔30秒(默认情况下)发送一次心跳来续约。通过续约来告知[Eureka] Server该 Eureka 客户仍然存在，没有出现问题。正常情况下，如果[Eureka] Server在90秒没有收到 Eureka 客户的续约，它会将实例从其注册表中删除。<br> <strong>获取注册列表信息 Fetch Registries：</strong><br> Eureka 客户端从服务器获取注册表信息，并将其缓存在本地。客户端会使用该信息查找其他服务，从而进行远程调用。该注册列表信息定期（每30秒钟）更新一次。每次返回注册列表信息可能与 Eureka 客户端的缓存信息不同, Eureka 客户端自动处理。如果由于某种原因导致注册列表信息不能及时匹配，Eureka 客户端则会重新获取整个注册表信息。</p> 
<p>Eureka 服务器缓存注册列表信息，整个注册表以及每个应用程序的信息进行了压缩，压缩内容和没有压缩的内容完全相同。Eureka 客户端和 Eureka 服务器可以使用JSON / XML格式进行通讯。在默认的情况下 Eureka 客户端使用压缩JSON格式来获取注册列表的信息。<br> <strong>服务下线 Cancel：</strong><br> Eureka客户端在程序关闭时向Eureka服务器发送取消请求。发送请求后，该客户端实例信息将从服务器的实例注册表中删除。该下线请求不会自动完成，它需要调用以下内容：DiscoveryManager.getInstance().shutdownComponent();<br> <strong>服务剔除 Eviction：</strong><br> 在默认的情况下，当Eureka客户端连续90秒(3个续约周期)没有向Eureka服务器发送服务续约，即心跳，Eureka服务器会将该服务实例从服务注册列表删除，即服务剔除。</p> 
<h3><a id="31__1061"></a>3.1 实例操作</h3> 
<h4><a id="311_eureka__1062"></a>3.1.1 eureka 注册与发现</h4> 
<p>讲了这么多概念，那如何使用呢？<br> 创建一个子module项目，名为sp-eureka。<br> <img src="https://images2.imgbox.com/c5/fd/mUvhiYF7_o.png" alt="在这里插入图片描述">修改pom.xml.<strong>我们需要引入父级的项目id相关信息，请结合自己的项目进行修改。</strong></p> 
<pre><code class="prism language-powershell">&lt;?xml version=<span class="token string">"1.0"</span> encoding=<span class="token string">"UTF-8"</span>?&gt;
&lt;project xmlns=<span class="token string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         xsi:schemaLocation=<span class="token string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;
    &lt;modelVersion&gt;4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0&lt;<span class="token operator">/</span>modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com<span class="token punctuation">.</span>ly&lt;<span class="token operator">/</span>groupId&gt;
        &lt;artifactId&gt;springCloud&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;version&gt;1<span class="token punctuation">.</span>0<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;<span class="token operator">/</span>parent&gt;

    &lt;artifactId&gt;<span class="token function">sp</span><span class="token operator">-</span>eureka&lt;<span class="token operator">/</span>artifactId&gt;
    &lt;version&gt;0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;name&gt;<span class="token function">sp</span><span class="token operator">-</span>eureka&lt;<span class="token operator">/</span>name&gt;
    &lt;description&gt;Demo project <span class="token keyword">for</span> Spring Boot&lt;<span class="token operator">/</span>description&gt;

    &lt;properties&gt;
        &lt;java<span class="token punctuation">.</span>version&gt;1<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>java<span class="token punctuation">.</span>version&gt;
        &lt;spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;Greenwich<span class="token punctuation">.</span>SR1&lt;<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;
    &lt;<span class="token operator">/</span>properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>eureka<span class="token operator">-</span>server&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
    &lt;<span class="token operator">/</span>dependencies&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>dependencies&lt;<span class="token operator">/</span>artifactId&gt;
                &lt;version&gt;$<span class="token punctuation">{<!-- --></span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version<span class="token punctuation">}</span>&lt;<span class="token operator">/</span>version&gt;
                &lt;<span class="token function">type</span>&gt;pom&lt;<span class="token operator">/</span><span class="token function">type</span>&gt;
                &lt;scope&gt;import&lt;<span class="token operator">/</span>scope&gt;
            &lt;<span class="token operator">/</span>dependency&gt;
        &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;<span class="token operator">/</span>dependencyManagement&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>maven<span class="token operator">-</span>plugin&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;<span class="token operator">/</span>plugin&gt;
        &lt;<span class="token operator">/</span>plugins&gt;
    &lt;<span class="token operator">/</span>build&gt;
&lt;<span class="token operator">/</span>project&gt;
</code></pre> 
<p><strong>别忘了在父级的pom.xml中添加module</strong></p> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2001</span>
  
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka1
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka
</code></pre> 
<p><strong>参数讲解：</strong></p> 
<ol><li>eureka 集群服务器之间，通过 hostname 来区分</li><li>eureka.server.enable-self-preservation<br> eureka 的自我保护状态：心跳失败的比例，在15分钟内是否低于85%,如果出现了低于的情况，Eureka Server会将当前的实例注册信息保护起来，同时提示一个警告，一旦进入保护模式，Eureka Server将会尝试保护其服务注册表中的信息，不再删除服务注册表中的数据。也就是不会注销任何微服务</li><li>eureka.client.register-with-eureka=false<br> 不向自身注册</li><li>eureka.client.fetch-registry=false<br> 不从自身拉取注册信息</li><li>eureka.instance.lease-expiration-duration-in-seconds<br> 最后一次心跳后，间隔多久认定微服务不可用，默认90</li></ol> 
<p><strong>主程序添加 @EnableEurekaServer</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpEurekaApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpEurekaApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>修改 hosts 文件，添加 eureka 域名映射</strong><br> C:\Windows\System32\drivers\etc\hosts<br> 添加内容：</p> 
<pre><code class="prism language-powershell">127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1       eureka1
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1       eureka2
</code></pre> 
<p>启动服务，并访问测试 <a href="https://www.csdn.net/">http://eureka1:2001</a>.，下面是一个可视化界面，下面的教程会详细介绍<br> <img src="https://images2.imgbox.com/27/8f/LYSFqSG1_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="312_service_provider__1170"></a>3.1.2 service provider 服务提供者</h4> 
<p>修改 item-service、user-service、order-service，把微服务注册到 eureka 服务器<br> 父级的pom.xml 添加 eureka 客户端依赖</p> 
<pre><code class="prism language-shell"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.springframework.cloud<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>
       spring-cloud-starter-netflix-eureka-client
    <span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.1</span>.1.RELEASE<span class="token operator">&lt;</span>/version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
</code></pre> 
<p><strong>application.yml 添加 eureka注册配置</strong>,三个服务的都要添加</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka
</code></pre> 
<p><strong>参数讲解：</strong></p> 
<ol><li> <p>eureka.instance.lease-renewal-interval-in-seconds<br> 心跳间隔时间，默认 30 秒</p> </li><li> <p>defaultZone，默认位置，可以修改为具体地理位置，比如：beiJing, shangHai, shenZhen 等，表示 eureka 服务器的部署位置</p> </li><li> <p>eureka.client.registry-fetch-interval-seconds<br> 拉取注册信息间隔时间，默认 30 秒</p> </li></ol> 
<p><strong>主程序启用服务注册发现客户端</strong>，<mark>三个服务都加上</mark></p> 
<p>修改 item-service、user-service 和 order-service， 主程序添加 <strong>@EnableDiscoveryClient</strong> 注解</p> 
<p>启动，并访问 eureka 查看注册信息<br> <img src="https://images2.imgbox.com/25/b8/juDcCifx_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/66/40/syNiVxa3_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="4ribbon_1207"></a>4.ribbon</h2> 
<p>Ribbon是一个基于HTTP和TCP的<strong>客户端负载均衡工具</strong>，它可有助于控制http和tcp的客户端行为，在ribbon中配置好服务提供者地址后，即可基于负载均衡算法自动为服务消费者提供服务。下面会介绍feign，此框架是在ribbon的基础上进行改进的，具体稍后会介绍。</p> 
<p>RestTemplate是Spring提供的一个访问Http服务的客户端类，就是微服务之间的调用是使用的RestTemplate。比如这个时候我们 消费者B 需要调用 提供者A 所提供的服务我们就需要这么写<br> 看一下伪代码：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>  
<span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>  
<span class="token comment">// 这里是提供者A的ip地址，但是如果使用了 Eureka 那么就应该是提供者A的名称  </span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SERVICE_PROVIDER_A <span class="token operator">=</span> <span class="token string">"http://localhost:8081"</span><span class="token punctuation">;</span>  

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/judge"</span><span class="token punctuation">)</span>  
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">judge</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token class-name">String</span> url <span class="token operator">=</span> SERVICE_PROVIDER_A <span class="token operator">+</span> <span class="token string">"/service1"</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre> 
<p>刚上面提到了负载均衡，那负载均衡的作用是啥呢？</p> 
<p><strong>概念</strong><br> 是指单台服务器性能达到极限时通过服务器集群来横向增加系统的吞吐量和性能。<strong>负载均衡是我们处理高并发、缓解网络压力和进行服务端扩容的重要手段之一</strong><br> <strong>服务端负载均衡</strong><br> 是不是联想到了nginx呢？它其实是作用于服务端的，是先发送请求，当到服务端的时候，nginx会先通过负载均衡算法在服务器列表中选择一个合适的进行访问。简单的说就是在服务端进行均衡算法中选择一个合适的服务进行访问。<br> <strong>客户端负载均衡</strong><br> 它在发送请求之前，通过算法在服务器列表中选择一个合适的服务发起请求。当然前提是有多个服务。</p> 
<p>这也许有些难以理解，我们看一下实例：</p> 
<h3><a id="41__1235"></a>4.1 项目搭建</h3> 
<p><img src="https://images2.imgbox.com/00/04/zNWn8rHN_o.png" alt="在这里插入图片描述"><br> 创建子module项目sp-ribbon。<br> <img src="https://images2.imgbox.com/00/07/AS2oGjJQ_o.png" alt="在这里插入图片描述"><strong>pom.xml</strong></p> 
<p>eureka-client 中已经包含 ribbon 依赖，需要添加 sp01-commons 依赖</p> 
<pre><code class="prism language-powershell">&lt;?xml version=<span class="token string">"1.0"</span> encoding=<span class="token string">"UTF-8"</span>?&gt;
&lt;project xmlns=<span class="token string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         xsi:schemaLocation=<span class="token string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;
    &lt;modelVersion&gt;4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0&lt;<span class="token operator">/</span>modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com<span class="token punctuation">.</span>ly&lt;<span class="token operator">/</span>groupId&gt;
        &lt;artifactId&gt;springCloud&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;version&gt;1<span class="token punctuation">.</span>0<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;<span class="token operator">/</span>parent&gt;
    &lt;artifactId&gt;<span class="token function">sp</span><span class="token operator">-</span>ribbon&lt;<span class="token operator">/</span>artifactId&gt;
    &lt;version&gt;0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;name&gt;<span class="token function">sp</span><span class="token operator">-</span>ribbon&lt;<span class="token operator">/</span>name&gt;
    &lt;description&gt;Demo project <span class="token keyword">for</span> Spring Boot&lt;<span class="token operator">/</span>description&gt;
    &lt;properties&gt;
        &lt;java<span class="token punctuation">.</span>version&gt;1<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>java<span class="token punctuation">.</span>version&gt;
        &lt;spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;Greenwich<span class="token punctuation">.</span>SR1&lt;<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;
    &lt;<span class="token operator">/</span>properties&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com<span class="token punctuation">.</span>ly&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;commons&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;version&gt;1<span class="token punctuation">.</span>0<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
    &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>dependencies&lt;<span class="token operator">/</span>artifactId&gt;
                &lt;version&gt;$<span class="token punctuation">{<!-- --></span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version<span class="token punctuation">}</span>&lt;<span class="token operator">/</span>version&gt;
                &lt;<span class="token function">type</span>&gt;pom&lt;<span class="token operator">/</span><span class="token function">type</span>&gt;
                &lt;scope&gt;import&lt;<span class="token operator">/</span>scope&gt;
            &lt;<span class="token operator">/</span>dependency&gt;
        &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;<span class="token operator">/</span>dependencyManagement&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>maven<span class="token operator">-</span>plugin&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;<span class="token operator">/</span>plugin&gt;
        &lt;<span class="token operator">/</span>plugins&gt;
    &lt;<span class="token operator">/</span>build&gt;
&lt;<span class="token operator">/</span>project&gt;
</code></pre> 
<p>请根据自己项目的情况适当修改。<br> <img src="https://images2.imgbox.com/e8/93/GPKI8m3n_o.png" alt="在这里插入图片描述"><br> <strong><mark>请自行在父级的pom中引入module</mark></strong></p> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> ribbon
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3001</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka
</code></pre> 
<p><strong>主程序</strong></p> 
<p>在启动类中创建 RestTemplate 实例，并注入到spring中管理<br> RestTemplate 是用来调用其他微服务的工具类，封装了远程调用代码，提供了一组用于远程调用的模板方法，例如：getForObject()、postForObject() 等</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpRibbonApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpRibbonApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建RibbonController，用于通过ribbon服务器获取其他服务信息，</p> 
<pre><code class="prism language-java">
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> rt<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/item-service/{orderId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//向指定微服务地址发送 get 请求，并获得该服务的返回结果</span>
        <span class="token comment">//{1} 占位符，用 orderId 填充</span>
        <span class="token keyword">return</span> rt<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://item-service/{1}"</span><span class="token punctuation">,</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/item-service/decreaseNumber"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">decreaseNumber</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//发送 post 请求</span>
        <span class="token keyword">return</span> rt<span class="token punctuation">.</span><span class="token function">postForObject</span><span class="token punctuation">(</span><span class="token string">"http://item-service/decreaseNumber"</span><span class="token punctuation">,</span> items<span class="token punctuation">,</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user-service/{userId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> rt<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://user-service/{1}"</span><span class="token punctuation">,</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user-service/{userId}/score"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addScore</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> rt<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://user-service/{1}/score?score={2}"</span><span class="token punctuation">,</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order-service/{orderId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> rt<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://order-service/{1}"</span><span class="token punctuation">,</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order-service"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> rt<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://order-service/"</span><span class="token punctuation">,</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>启动所有服务：<br> <img src="https://images2.imgbox.com/c8/d2/QXu3nx4s_o.png" alt="在这里插入图片描述"></p> 
<p>进行测试：</p> 
<ol><li>http://eureka1:2001</li><li>http://localhost:3001/item-service/35</li><li>http://localhost:3001/item-service/decreaseNumber<br> 使用postman，POST发送以下格式数据：<br> [{“id”:1, “name”:“abc”, “number”:23},{“id”:2, “name”:“def”, “number”:11}]</li><li>http://localhost:3001/user-service/7</li><li>http://localhost:3001/user-service/7/score?score=100</li><li>http://localhost:3001/order-service/123abc</li><li>http://localhost:3001/order-service/</li></ol> 
<p>OK，运行成功和测试成功</p> 
<h3><a id="42_eureka___1385"></a>4.2 eureka 和 “服务提供者”的高可用</h3> 
<p><img src="https://images2.imgbox.com/f1/bf/NbxKJuQA_o.png" alt="在这里插入图片描述"><br> 修改sp-eureka项目的配置文件</p> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml"> <span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
    
<span class="token comment">#server:</span>
<span class="token comment">#  port: 2001</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token comment">#  instance:</span>
<span class="token comment">#    hostname: eureka1</span>
<span class="token comment">#  client:</span>
<span class="token comment">#    register-with-eureka: false</span>
<span class="token comment">#    fetch-registry: false</span>

<span class="token punctuation">---</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> eureka1

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2001</span>
  
<span class="token comment"># eureka1 向 eureka2 注册</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka1
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span> 
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka

<span class="token punctuation">---</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> eureka2

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2002</span>
  
<span class="token comment"># eureka2 向 eureka1 注册</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka2
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka
</code></pre> 
<p>配置启动参数 --spring.profiles.active<br> <img src="https://images2.imgbox.com/cb/c9/25gRDoiq_o.png" alt="在这里插入图片描述"><br> 选择eureka的启动配置，修改name，名字随意<br> 更改参数为：–spring.profiles.active=eureka1<br> 保存<br> <img src="https://images2.imgbox.com/53/43/GicyHRmw_o.png" alt="在这里插入图片描述">复制一份：修改name，修改参数<br> <img src="https://images2.imgbox.com/b3/d3/F5asOlS5_o.png" alt="在这里插入图片描述">补充一下：<br> <mark>命令行运行时添加参数：<br> java -jar xxx.jar --spring.profiles.active=eureka1</mark></p> 
<p>访问 eureka 服务器，查看注册信息，http://eureka1:2001/<br> <img src="https://images2.imgbox.com/f4/e8/IWoIkjqt_o.png" alt="在这里插入图片描述">http://eureka2:2002/<br> <img src="https://images2.imgbox.com/81/df/TGvkfzC4_o.png" alt="在这里插入图片描述">eureka客户端注册时，向两个服务器注册<br> 修改以下微服务</p> 
<p><strong>sp02-itemservice<br> sp03-userservice<br> sp04-orderservice<br> sp06-ribbon</strong></p> 
<pre><code class="prism language-powershell">eureka:
  client:
    service<span class="token operator">-</span>url:
      defaultZone: http:<span class="token operator">/</span><span class="token operator">/</span>eureka1:2001<span class="token operator">/</span>eureka<span class="token punctuation">,</span> http:<span class="token operator">/</span><span class="token operator">/</span>eureka2:2002<span class="token operator">/</span>eureka
</code></pre> 
<p><em><strong>当一个 eureka 服务宕机时，仍可以连接另一个 eureka 服务</strong></em></p> 
<p><strong>item-service 高可用</strong><br> 修改item-serivice的yaml文件：</p> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> item<span class="token punctuation">-</span>service
    
<span class="token comment">#server:</span>
<span class="token comment">#  port: 8001</span>
  
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka

<span class="token punctuation">---</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> item1
  
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8001</span>
<span class="token punctuation">---</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> item2

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8002</span>
</code></pre> 
<p>修改配置参数，过程跟上面一样<br> <img src="https://images2.imgbox.com/28/e8/mL1B7wFM_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/71/f4/maxR8FzL_o.png" alt="在这里插入图片描述">配置好，看一下目前所有的服务<br> <img src="https://images2.imgbox.com/66/fa/3pn6U82D_o.png" alt="在这里插入图片描述"><br> 可以看到有2个eureka服务，2个itemService服务</p> 
<p><strong>启动测试</strong><br> 访问 eureka 查看 item-service 注册信息<br> <img src="https://images2.imgbox.com/8b/82/pB44tGpH_o.png" alt="在这里插入图片描述"><br> <strong>访问两个端口测试</strong><br> http://localhost:8001/35<br> http://localhost:8002/35</p> 
<p>然后可以关掉一个eureka服务，再测试，看是否成功。</p> 
<h3><a id="43_ribbon__1510"></a>4.3 ribbon 负载均衡</h3> 
<p><strong>RestTemplate 设置 @LoadBalanced</strong><br> <strong>@LoadBalanced</strong> 负载均衡注解，会对 RestTemplate 实例进行封装，创建动态代理对象，并切入（AOP）负载均衡代码，把请求分散分发到集群中的服务器</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpRibbonApplication</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@LoadBalanced</span> <span class="token comment">//负载均衡注解</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpRibbonApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>访问路径设置为服务id</strong><br> 由于ribbon使用了负载均衡，那服务访问不能使用ip了，改用服务id<br> <strong>访问测试</strong><br> 访问测试，ribbon 会把请求分发到 8001 和 8002 两个服务端口上<br> <strong>http://localhost:3001/item-service/34</strong><br> <img src="https://images2.imgbox.com/99/30/fyAn7Qjf_o.png" alt="在这里插入图片描述"><br> 重复刷新<br> <img src="https://images2.imgbox.com/50/43/sd60PDIP_o.png" alt="在这里插入图片描述"><br> 可以看到实现了消费者负载均衡</p> 
<h3><a id="44_ribbon__1539"></a>4.4 ribbon 重试</h3> 
<p>pom.xml 添加 spring-retry 依赖</p> 
<pre><code class="prism language-powershell">&lt;dependency&gt;
	&lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>retry&lt;<span class="token operator">/</span>groupId&gt;
	&lt;artifactId&gt;spring<span class="token operator">-</span>retry&lt;<span class="token operator">/</span>artifactId&gt;
&lt;<span class="token operator">/</span>dependency&gt;
</code></pre> 
<p><strong>application.yml 配置 ribbon 重试</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> ribbon
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3001</span>
  
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>    
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
      
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">OkToRetryOnAllOperations</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<p><strong>参数讲解</strong><br> <mark>1. OkToRetryOnAllOperations=true<br> 对连接超时、读取超时都进行重试<br> 2. MaxAutoRetriesNextServer<br> 更换实例的次数<br> 3. MaxAutoRetries<br> 当前实例重试次数，尝试失败会更换下一个实例</mark></p> 
<p><strong>主程序设置 RestTemplate 的请求工厂的超时属性</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpRibbonApplication</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@LoadBalanced</span> <span class="token comment">//负载均衡注解</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SimpleClientHttpRequestFactory</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//RestTemplate 中默认的 Factory 实例中，两个超时属性默认是 -1，</span>
        <span class="token comment">//未启用超时，也不会触发重试</span>
        <span class="token comment">//return new RestTemplate();</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpRibbonApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>item-service 的 ItemController 添加延迟代码，以便测试 ribbon 的重试机制</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ItemService</span> itemService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${server.port}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{orderId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"server.port="</span><span class="token operator">+</span>port<span class="token operator">+</span><span class="token string">", orderId="</span><span class="token operator">+</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">///--设置随机延迟</span>
        <span class="token keyword">long</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0.6</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"item-service-"</span><span class="token operator">+</span>port<span class="token operator">+</span><span class="token string">" - 暂停 "</span><span class="token operator">+</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">///~~</span>


        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> itemService<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token string">"port="</span><span class="token operator">+</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/decreaseNumber"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">decreaseNumber</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        itemService<span class="token punctuation">.</span><span class="token function">decreaseNumbers</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>访问，测试 ribbon 重试机制</strong></p> 
<p>通过 ribbon 访问 item-service，当超时，ribbon 会重试请求集群中其他服务器<br> <a href="https://www.csdn.net/">http://localhost:3001/item-service/35</a>.<br> 不断重新刷请求，可以看到有时item-service的俩个服务会随机打印日志，<br> 并且有时响应慢的时候会出现打印俩条，有时某一个服务打印俩条后，另一个也会打印<br> 这也是模拟了现实的情况，也对应了配置的参数，请朋友耐心测试<br> <img src="https://images2.imgbox.com/b7/a1/dnl1dRcp_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="5_hystrix__1649"></a>5 hystrix 断路器</h2> 
<h3><a id="51__1650"></a>5.1 原理简介</h3> 
<p>在微服务架构体系中，我们会根据业务拆分不同的服务，服务之间通过RPC调用，但有时为了高可用，有的 服务需要做集群部署。但有时候会因为网络的原因，会导致服务不能高可用，一旦有请求就会造成线程阻塞，若大量的请求涌入的话，servlet容器的资源就会耗尽，最终服务崩溃。服务之间的依懒性的特点，会使得故障进行传播，最终整个服务系统崩掉。这也是我们常说的<strong>雪崩效应</strong>。</p> 
<p>正是这种现象的出现，业界中借用电路的方式，设计了断路器模型。最终实现的目的就是在服务崩溃的时候，马上做出响应。</p> 
<p><strong>简介</strong><br> Hystrix是一个库，可通过添加等待时间容限和容错逻辑来帮助您控制这些分布式服务之间的交互。Hystrix通过隔离服务之间的访问点，停止服务之间的级联故障并提供后备选项来实现此目的，所有这些都可以提高系统的整体弹性。<br> <strong>总体来说[Hystrix]就是一个能进行熔断和降级的库，通过使用它能提高整个系统的弹性。</strong><br> 我们借用一个小案例说明一下<strong>熔断和降级</strong>的原理</p> 
<p>假如我们的服务一共有三个服务A,B,C。A调用B，B调用C。若服务C因为某些原因崩了。大量的请求就会导致C服务器阻塞。<br> <img src="https://images2.imgbox.com/ba/4a/nweypAgs_o.png" alt="在这里插入图片描述"></p> 
<p>当C服务阻塞了就会导致不能响应，那B因为一直没收到C响应，那B也会因此而阻塞最终崩溃，同理，A也会阻塞崩溃。<br> <img src="https://images2.imgbox.com/fb/64/K0CMcrPZ_o.png" alt="在这里插入图片描述"><br> 这种现象就是上面所说的服务雪崩。</p> 
<p>那<strong>熔断</strong>就是解决服务雪崩的一种方案。具体的过程是：当指定时间段内的请求失败率达到设置阈值时，系统就会通过断路器直接将此请求链路断开。</p> 
<p>结合上面例子，服务B调用服务C在指定时间段内，调用的失败率到达了一定的值，那<strong>Hystrix</strong>则会自动将 服务B与C 之间的请求都断了，以免导致服务雪崩现象。</p> 
<p>降级则为了更好的用户体验，当一个方法调用异常时，通过执行另一种代码逻辑来给用户友好的回复。</p> 
<p>所以熔断一个请求链路后，得给一个回应啊，降级就是干这活的。</p> 
<p>这个在大型网站比较常见的，比如微博突然有个热点非常火热，点击量直接飙升，当达到一定量的时候，就会提示你类似当前人数太多请稍后查看等信息。</p> 
<h3><a id="52__1677"></a>5.2 实例操作</h3> 
<p>为了更好的测试，复制 sp06-ribbon 项目，命名为sp07-hystrix。修改启动类的名称<br> <img src="https://images2.imgbox.com/fa/67/FdOIrgRl_o.png" alt="在这里插入图片描述"><br> yaml文件配置：其实就是修改一个name。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> hystrix

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3001</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka

<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">OkToRetryOnAllOperations</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<p>我们添加hystrix 起步依赖</p> 
<pre><code class="prism language-powershell">&lt;dependency&gt;
	&lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
	&lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>hystrix&lt;<span class="token operator">/</span>artifactId&gt;
&lt;<span class="token operator">/</span>dependency&gt;
</code></pre> 
<p><img src="https://images2.imgbox.com/51/0f/WBqbFDRQ_o.png" alt="在这里插入图片描述"><strong>主程序添加 @EnableCircuitBreaker 启用 hystrix 断路器</strong></p> 
<p><mark>启动断路器，断路器提供两个核心功能：</mark></p> 
<ol><li> <p>降级，超时、出错、不可到达时，对服务降级，返回错误信息或者是缓存数据</p> </li><li> <p>熔断，当服务压力过大，错误比例过多时，熔断所有请求，所有请求直接降级</p> </li><li> <p>可以使用 <strong>@SpringCloudApplication</strong> 注解代替三个注解</p> </li></ol> 
<pre><code class="prism language-java"><span class="token comment">//@EnableCircuitBreaker</span>
<span class="token comment">//@EnableDiscoveryClient</span>
<span class="token comment">//@SpringBootApplication</span>

<span class="token annotation punctuation">@SpringCloudApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpHystrixApplication</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@LoadBalanced</span> <span class="token comment">//负载均衡注解</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SimpleClientHttpRequestFactory</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//RestTemplate 中默认的 Factory 实例中，两个超时属性默认是 -1，</span>
        <span class="token comment">//未启用超时，也不会触发重试</span>
        <span class="token comment">//return new RestTemplate();</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpHystrixApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>RibbonController 中添加降级方法</strong></p> 
<p>为每个方法添加降级方法，例如 getItems() 添加降级方法 getItemsFB()<br> 添加 @HystrixCommand 注解，指定降级方法名</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> rt<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/item-service/{orderId}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"getItemsFB"</span><span class="token punctuation">)</span> <span class="token comment">//指定降级方法的方法名</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//向指定微服务地址发送 get 请求，并获得该服务的返回结果</span>
        <span class="token comment">//{1} 占位符，用 orderId 填充</span>
        <span class="token keyword">return</span> rt<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://item-service/{1}"</span><span class="token punctuation">,</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/item-service/decreaseNumber"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"decreaseNumberFB"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">decreaseNumber</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//发送 post 请求</span>
        <span class="token keyword">return</span> rt<span class="token punctuation">.</span><span class="token function">postForObject</span><span class="token punctuation">(</span><span class="token string">"http://item-service/decreaseNumber"</span><span class="token punctuation">,</span> items<span class="token punctuation">,</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user-service/{userId}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"getUserFB"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> rt<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://user-service/{1}"</span><span class="token punctuation">,</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user-service/{userId}/score"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"addScoreFB"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addScore</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> rt<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://user-service/{1}/score?score={2}"</span><span class="token punctuation">,</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order-service/{orderId}"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"getOrderFB"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> rt<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://order-service/{1}"</span><span class="token punctuation">,</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order-service"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"addOrderFB"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> rt<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://order-service/"</span><span class="token punctuation">,</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//降级方法的参数和返回值，需要和原始方法一致，方法名任意</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItemsFB</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"获取订单商品列表失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">decreaseNumberFB</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"更新商品库存失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserFB</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"获取用户信息失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addScoreFB</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> userId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"增加用户积分失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrderFB</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"获取订单失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addOrderFB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"添加订单失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>hystrix 短路超时设置</strong></p> 
<p>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</p> 
<p><mark>为了测试 hystrix 短路功能，我们把 hystrix 等待超时设置得非常小（500毫秒）</mark></p> 
<p><mark>此设置一般应大于 ribbon 的重试超时时长，例如 10 秒</mark></p> 
<pre><code class="prism language-yaml">
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> hystrix
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3001</span>
  
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
      
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">OkToRetryOnAllOperations</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  
<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">500</span>
</code></pre> 
<p><strong>启动项目进行测试</strong></p> 
<p><img src="https://images2.imgbox.com/cd/8d/6Db4yzgI_o.png" alt="在这里插入图片描述"></p> 
<ol><li>通过 hystrix 服务，访问可能超时失败的 item-service（我们在写ribbon的时候设置了线程的阻塞时间，而且是随机的）<br> http://localhost:3001/item-service/35<br> <img src="https://images2.imgbox.com/6a/ba/42ePoEDV_o.png" alt="在这里插入图片描述">随机刷几次，会看到成功的结果<br> <img src="https://images2.imgbox.com/76/ff/DHkHkqvp_o.png" alt="在这里插入图片描述"></li><li>通过 hystrix 服务，访问未启动的 user-service<br> http://localhost:3001/user-service/7<br> <img src="https://images2.imgbox.com/9a/e5/bo1nxMC3_o.png" alt="在这里插入图片描述"></li></ol> 
<p><strong>可以看到，如果 item-service 请求超时，hystrix 会立即执行降级方法<br> 访问 user-service，由于该服务未启动，hystrix也会立即执行降级方法</strong></p> 
<h3><a id="53_hystrix_dashboard__1864"></a>5.3 hystrix dashboard 断路器仪表盘</h3> 
<p>hystrix 对请求的熔断和断路处理，可以产生监控信息，hystrix dashboard可以实时的进行监控</p> 
<p>sp-hystrix 项目添加 actuator，并暴露 hystrix 监控端点<br> actuator 是 spring boot 提供的服务监控工具，提供了各种监控信息的监控端点<br> management.endpoints.web.exposure.include 配置选项， 可以指定端点名，来暴露监控端点<br> 如果要暴露所有端点，可以用 “*”</p> 
<p>pom.xml 添加 actuator 依赖</p> 
<pre><code class="prism language-powershell">&lt;dependency&gt;
	&lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
	&lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>actuator&lt;<span class="token operator">/</span>artifactId&gt;
&lt;<span class="token operator">/</span>dependency&gt;
</code></pre> 
<p>调整 application.yml 配置，并暴露 hystrix 监控端点</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> hystrix
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3001</span>
  
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
      
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">OkToRetryOnAllOperations</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  
<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">2000</span>

<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> hystrix.stream
</code></pre> 
<p>访问 actuator 路径，查看监控端点</p> 
<p>http://localhost:3001/actuator</p> 
<p><img src="https://images2.imgbox.com/ea/75/eAxdEYkd_o.png" alt="在这里插入图片描述"><br> <strong>新建 sp-hystrix-dashboard 字module项目</strong><br> 修改pom文件，别忘了修改父级pom文件，添加module</p> 
<pre><code class="prism language-powershell">&lt;?xml version=<span class="token string">"1.0"</span> encoding=<span class="token string">"UTF-8"</span>?&gt;
&lt;project xmlns=<span class="token string">"http://maven.apache.org/POM/4.0.0"</span>
         xmlns:xsi=<span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         xsi:schemaLocation=<span class="token string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;springCloud&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;groupId&gt;com<span class="token punctuation">.</span>ly&lt;<span class="token operator">/</span>groupId&gt;
        &lt;version&gt;1<span class="token punctuation">.</span>0<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;<span class="token operator">/</span>parent&gt;
    &lt;modelVersion&gt;4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0&lt;<span class="token operator">/</span>modelVersion&gt;
    &lt;version&gt;0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;name&gt;<span class="token function">sp</span><span class="token operator">-</span>hystrix<span class="token operator">-</span>dashboard&lt;<span class="token operator">/</span>name&gt;
    &lt;description&gt;Demo project <span class="token keyword">for</span> Spring Boot&lt;<span class="token operator">/</span>description&gt;
    &lt;artifactId&gt;<span class="token function">sp</span><span class="token operator">-</span>hystrix<span class="token operator">-</span>dashboard&lt;<span class="token operator">/</span>artifactId&gt;

    &lt;properties&gt;
        &lt;java<span class="token punctuation">.</span>version&gt;1<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>java<span class="token punctuation">.</span>version&gt;
        &lt;spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;Greenwich<span class="token punctuation">.</span>SR1&lt;<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;
    &lt;<span class="token operator">/</span>properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>eureka<span class="token operator">-</span>client&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>hystrix<span class="token operator">-</span>dashboard&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;

    &lt;<span class="token operator">/</span>dependencies&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>dependencies&lt;<span class="token operator">/</span>artifactId&gt;
                &lt;version&gt;$<span class="token punctuation">{<!-- --></span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version<span class="token punctuation">}</span>&lt;<span class="token operator">/</span>version&gt;
                &lt;<span class="token function">type</span>&gt;pom&lt;<span class="token operator">/</span><span class="token function">type</span>&gt;
                &lt;scope&gt;import&lt;<span class="token operator">/</span>scope&gt;
            &lt;<span class="token operator">/</span>dependency&gt;
        &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;<span class="token operator">/</span>dependencyManagement&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>maven<span class="token operator">-</span>plugin&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;<span class="token operator">/</span>plugin&gt;
        &lt;<span class="token operator">/</span>plugins&gt;
    &lt;<span class="token operator">/</span>build&gt;
&lt;<span class="token operator">/</span>project&gt;
</code></pre> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> hystrix<span class="token punctuation">-</span>dashboard
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">4001</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
</code></pre> 
<p><strong>主程序添加 @EnableHystrixDashboard 和 @EnableDiscoveryClient</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableHystrixDashboard</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpHystrixDashboardApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpHystrixDashboardApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>启动，并访问测试</strong><br> 开启所有服务，<strong>除了ribbon项目</strong>。<br> <img src="https://images2.imgbox.com/75/bd/l6kEwDa3_o.png" alt="在这里插入图片描述"><br> <strong>访问 hystrix dashboard</strong></p> 
<p>http://localhost:4001/hystrix<br> <img src="https://images2.imgbox.com/4e/21/LkRjHSHb_o.png" alt="在这里插入图片描述"><strong>填入 hystrix 的监控端点，开启监控</strong></p> 
<p>http://localhost:3001/actuator/hystrix.stream</p> 
<p><img src="https://images2.imgbox.com/d4/c6/Yxi3gRij_o.png" alt="在这里插入图片描述"><br> <strong>通过 hystrix 访问服务多次，观察监控信息</strong><br> http://localhost:3001/item-service/35<br> http://localhost:3001/user-service/7<br> http://localhost:3001/user-service/7/score?score=100<br> http://localhost:3001/order-service/123abc<br> http://localhost:3001/order-service/</p> 
<p><img src="https://images2.imgbox.com/fe/85/HcAHOKYH_o.png" alt="在这里插入图片描述">解释一下：<br> <img src="https://images2.imgbox.com/e6/cc/xTzaeNHI_o.png" alt="在这里插入图片描述"><br> <strong>hystrix 熔断</strong></p> 
<p>整个链路达到一定的阈值，默认情况下，10秒内产生超过20次请求，则符合第一个条件。 满足第一个条件的情况下，如果请求的错误百分比大于阈值，则会打开断路器，默认为50%。 Hystrix的逻辑，先判断是否满足第一个条件，再判断第二个条件，如果两个条件都满足，则会开启断路器</p> 
<p>断路器打开 5 秒后，会处于半开状态，会尝试转发请求，如果仍然失败，保持打开状态，如果成功，则关闭断路器</p> 
<p><strong>使用 apache 的并发访问测试工具 ab</strong></p> 
<p>http://httpd.apache.org/docs/current/platform/windows.html#down<br> <img src="https://images2.imgbox.com/85/03/gT0W1iyT_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/a1/f9/ILaF4ktj_o.png" alt="在这里插入图片描述"><br> 若由于网络不能访问，可从我网盘中下载：<br> 链接：<a href="https://pan.baidu.com/s/173977Nrmdtkkqxd97cnjTA" rel="nofollow">https://pan.baidu.com/s/173977Nrmdtkkqxd97cnjTA </a><br> 提取码：7xy1<br> 或者 微信扫一扫<br> <img src="https://images2.imgbox.com/31/3e/lKvWZf65_o.png" alt="在这里插入图片描述"><br> 或者从我的博客中直接下载<br> <a href="https://download.csdn.net/download/qq_37216403/12460257"><br> https://download.csdn.net/download/qq_37216403/12460257</a></p> 
<p><strong>用 ab 工具，以并发50次，来发送20000个请求</strong></p> 
<pre><code class="prism language-powershell">ab <span class="token operator">-</span>n 20000 <span class="token operator">-</span>c 50 http:<span class="token operator">/</span><span class="token operator">/</span>localhost:3001<span class="token operator">/</span>item<span class="token operator">-</span>service<span class="token operator">/</span>35
</code></pre> 
<p><img src="https://images2.imgbox.com/8e/7d/QPPJqOjb_o.png" alt="在这里插入图片描述"><strong>断路器状态为 Open，所有请求会被短路，直接降级执行 fallback 方法</strong><br> <img src="https://images2.imgbox.com/96/a2/PRtJWExH_o.png" alt="在这里插入图片描述"><strong>hystrix 配置</strong><br> 官方GitHub地址：https://github.com/Netflix/Hystrix/wiki/Configuration<br> <mark>考研英语的时候到了</mark></p> 
<p><strong>参数讲解</strong></p> 
<ol><li> <p>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds<br> 请求超时时间，超时后触发失败降级</p> </li><li> <p>hystrix.command.default.circuitBreaker.requestVolumeThreshold<br> 10秒内请求数量，默认20，如果没有达到该数量，即使请求全部失败，也不会触发断路器打开</p> </li><li> <p>hystrix.command.default.circuitBreaker.errorThresholdPercentage<br> 失败请求百分比，达到该比例则触发断路器打开</p> </li><li> <p>hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds<br> 断路器打开多长时间后，再次允许尝试访问（半开），仍失败则继续保持打开状态，如成功访问则关闭断路器，默认 5000</p> </li></ol> 
<h2><a id="6feign_2068"></a>6.feign</h2> 
<p>微服务应用中，ribbon 和 hystrix 总是同时出现，feign 整合了两者，并提供了声明式消费者客户端<br> <strong>用 feign 代替 hystrix+ribbon</strong></p> 
<p>创建子module项目sp-feign。项目结构如下：<br> <img src="https://images2.imgbox.com/5f/6c/5uhiVJlf_o.png" alt="在这里插入图片描述"><br> <strong>pom.xml</strong></p> 
<pre><code class="prism language-powershell">&lt;?xml version=<span class="token string">"1.0"</span> encoding=<span class="token string">"UTF-8"</span>?&gt;
&lt;project xmlns=<span class="token string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         xsi:schemaLocation=<span class="token string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;
    &lt;modelVersion&gt;4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0&lt;<span class="token operator">/</span>modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com<span class="token punctuation">.</span>ly&lt;<span class="token operator">/</span>groupId&gt;
        &lt;artifactId&gt;springCloud&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;version&gt;1<span class="token punctuation">.</span>0<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;<span class="token operator">/</span>parent&gt;
    &lt;artifactId&gt;<span class="token function">sp</span><span class="token operator">-</span>feign&lt;<span class="token operator">/</span>artifactId&gt;
    &lt;version&gt;0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;name&gt;<span class="token function">sp</span><span class="token operator">-</span>feign&lt;<span class="token operator">/</span>name&gt;
    &lt;description&gt;Demo project <span class="token keyword">for</span> Spring Boot&lt;<span class="token operator">/</span>description&gt;

    &lt;properties&gt;
        &lt;java<span class="token punctuation">.</span>version&gt;1<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>java<span class="token punctuation">.</span>version&gt;
        &lt;spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;Greenwich<span class="token punctuation">.</span>SR1&lt;<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;
    &lt;<span class="token operator">/</span>properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>actuator&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>eureka<span class="token operator">-</span>client&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>openfeign&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;


        &lt;dependency&gt;
            &lt;groupId&gt;com<span class="token punctuation">.</span>ly&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;commons&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;version&gt;1<span class="token punctuation">.</span>0<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
    &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>dependencies&lt;<span class="token operator">/</span>artifactId&gt;
                &lt;version&gt;$<span class="token punctuation">{<!-- --></span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version<span class="token punctuation">}</span>&lt;<span class="token operator">/</span>version&gt;
                &lt;<span class="token function">type</span>&gt;pom&lt;<span class="token operator">/</span><span class="token function">type</span>&gt;
                &lt;scope&gt;import&lt;<span class="token operator">/</span>scope&gt;
            &lt;<span class="token operator">/</span>dependency&gt;
        &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;<span class="token operator">/</span>dependencyManagement&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>maven<span class="token operator">-</span>plugin&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;<span class="token operator">/</span>plugin&gt;
        &lt;<span class="token operator">/</span>plugins&gt;
    &lt;<span class="token operator">/</span>build&gt;

&lt;<span class="token operator">/</span>project&gt;

</code></pre> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> feign
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3001</span>
  
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
</code></pre> 
<p><strong>主程序添加 @EnableDiscoveryClient 和 @EnableFeignClients</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpFeignApplication</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpFeignApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>feign 声明式客户端</strong></p> 
<p>feign 利用了我们熟悉的 spring mvc 注解来对接口方法进行设置，降低了我们的学习成本。</p> 
<p>通过这些设置,feign可以拼接后台服务的访问路径和提交的参数</p> 
<p>例如：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{userId}/score"</span><span class="token punctuation">)</span> 
<span class="token class-name">JsonResult</span> <span class="token function">addScore</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>当这样调用该方法：</p> 
<pre><code class="prism language-java">service<span class="token punctuation">.</span><span class="token function">addScore</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>那么 feign 会向服务器发送请求：<br> <mark>http://用户微服务/7/score?score=100</mark><br> 注意：<mark>如果 score 参数名与变量名不同，需要添加参数名设置</mark>：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{userId}/score"</span><span class="token punctuation">)</span> 
<span class="token class-name">JsonResult</span> <span class="token function">addScore</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>ItemFeignService</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Item</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">JsonResult</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"item-service"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ItemFeignService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{orderId}"</span><span class="token punctuation">)</span>
    <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/decreaseNumber"</span><span class="token punctuation">)</span>
    <span class="token class-name">JsonResult</span> <span class="token function">decreaseNumber</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>UserFeignService</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">JsonResult</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"user-service"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserFeignService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{userId}"</span><span class="token punctuation">)</span>
    <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 拼接路径 /{userId}/score?score=新增积分</span>
    <span class="token comment">// 如果请求参数和方法参数同名,@RequestParam可省略</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{userId}/score"</span><span class="token punctuation">)</span>
    <span class="token class-name">JsonResult</span> <span class="token function">addScore</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>OrderFeignService</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Order</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">JsonResult</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"order-service"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderFeignService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{orderId}"</span><span class="token punctuation">)</span>
    <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
    <span class="token class-name">JsonResult</span> <span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>FeignController</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Item</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Order</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ItemFeignService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OrderFeignService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">UserFeignService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">JsonResult</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ItemFeignService</span> itemServcie<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserFeignService</span> userServcie<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderFeignService</span> orderServcie<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/item-service/{orderId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> itemServcie<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/item-service/decreaseNumber"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">decreaseNumber</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> itemServcie<span class="token punctuation">.</span><span class="token function">decreaseNumber</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user-service/{userId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userServcie<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user-service/{userId}/score"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addScore</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userServcie<span class="token punctuation">.</span><span class="token function">addScore</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order-service/{orderId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> orderServcie<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order-service"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> orderServcie<span class="token punctuation">.</span><span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>启动服务，并访问测试</strong></p> 
<p><img src="https://images2.imgbox.com/57/56/ep3cyGWB_o.png" alt="在这里插入图片描述"></p> 
<p>进行测试，看是否成功获取数据</p> 
<ol><li>http://eureka1:2001<br> 2.http://localhost:3001/item-service/35</li><li>http://localhost:3001/item-service/decreaseNumber<br> 使用postman，POST发送以下格式数据：<br> [{“id”:1, “name”:“abc”, “number”:23},{“id”:2, “name”:“def”, “number”:11}]</li><li>http://localhost:3001/user-service/7</li><li>http://localhost:3001/user-service/7/score?score=100</li><li>http://localhost:3001/order-service/123abc</li><li>http://localhost:3001/order-service/</li></ol> 
<h3><a id="feign__ribbon__2334"></a>feign + ribbon 负载均衡和重试</h3> 
<p>无需额外配置，feign 默认已启用了 ribbon 负载均衡和重试机制。可以通过配置对参数进行调整</p> 
<p><strong>application.yml 配置 ribbon 超时和重试</strong><br> <em>ribbon.xxx</em> : 全局配置<br> <em>item-service.ribbon.xxx</em> : 对特定服务实例的配置</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> feign
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3001</span>
  
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
      
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  
<span class="token key atrule">item-service</span><span class="token punctuation">:</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">500</span>
    <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre> 
<p>启动服务，访问测试</p> 
<p>http://localhost:3001/item-service/35<br> <img src="https://images2.imgbox.com/16/15/LSHIbQGa_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="feign__hystrix__2369"></a>feign + hystrix 降级</h3> 
<p>feign 启用 hystrix<br> feign 默认没有启用 hystrix，添加配置，启用 hystrix</p> 
<pre><code class="prism language-powershell">feign<span class="token punctuation">.</span>hystrix<span class="token punctuation">.</span>enabled=true
</code></pre> 
<p>application.yml 添加配置</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<p>启用 hystrix 后，访问服务</p> 
<p>http://localhost:3001/item-service/35<br> 多刷几次<br> 当线程阻塞时间为1秒的时候，会被快速捕抓到，<br> 默认1秒会快速失败，没有降级方法时，会显示白板页<br> <img src="https://images2.imgbox.com/1b/db/pdHCQQCo_o.png" alt="在这里插入图片描述"><strong>可以添加配置，暂时减小降级超时时间，以便后续对降级进行测试</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">500</span>
</code></pre> 
<p><strong>feign + hystrix 降级</strong><br> <strong>降级类</strong><br> ItemFeignServiceFB</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemFeignServiceFB</span> <span class="token keyword">implements</span> <span class="token class-name">ItemFeignService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"无法获取订单商品列表"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">decreaseNumber</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"无法修改商品库存"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>OrderFeignServiceFB</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderFeignServiceFB</span> <span class="token keyword">implements</span> <span class="token class-name">OrderFeignService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"无法获取商品订单"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"无法保存订单"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>UserFeignServiceFB</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserFeignServiceFB</span> <span class="token keyword">implements</span> <span class="token class-name">UserFeignService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"无法获取用户信息"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addScore</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> userId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"无法增加用户积分"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>feign service 接口中指定降级类</strong><br> <strong>ItemFeignService</strong></p> 
<pre><code class="prism language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"item-service"</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">ItemFeignServiceFB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ItemFeignService</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p><strong>UserFeignService</strong></p> 
<pre><code class="prism language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"user-service"</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">UserFeignServiceFB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserFeignService</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p><strong>OrderFeignService</strong></p> 
<pre><code class="prism language-java">
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"order-service"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">OrderFeignServiceFB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderFeignService</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p><strong>启动服务，访问测试</strong></p> 
<p>http://localhost:3001/item-service/35<br> <img src="https://images2.imgbox.com/61/b5/53hapoGs_o.png" alt="在这里插入图片描述"></p> 
<p>多刷几次，能看到成功的结果</p> 
<p>此实验是模拟当某个服务器响应时间过长时并超过设置的时间段，将它降级，达到快速响应的结果，提高服务器的安全性，以及用户体验。</p> 
<h3><a id="feign__hystrix__2491"></a>feign + hystrix 监控和熔断测试</h3> 
<p>看一下架构<br> <img src="https://images2.imgbox.com/21/ac/euvpDanq_o.png" alt="在这里插入图片描述"></p> 
<p>修改sp-feign项目<br> <strong>pom.xml 添加 hystrix 起步依赖</strong><br> feign 没有包含完整的 hystrix 依赖</p> 
<pre><code class="prism language-powershell">&lt;dependency&gt;
	&lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
	&lt;artifactId&gt;
		spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>hystrix
	&lt;<span class="token operator">/</span>artifactId&gt;
&lt;<span class="token operator">/</span>dependency&gt;
</code></pre> 
<p><strong>主程序添加 @EnableCircuitBreaker</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableCircuitBreaker</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpFeignApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpFeignApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>sp-feign 配置 actuator，暴露 hystrix.stream 监控端点</p> 
<p><strong>actuator 依赖</strong></p> 
<p>确认已经添加了 actuator 依赖</p> 
<pre><code class="prism language-powershell">&lt;dependency&gt;
	&lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
	&lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>actuator&lt;<span class="token operator">/</span>artifactId&gt;
&lt;<span class="token operator">/</span>dependency&gt;
</code></pre> 
<p><strong>application.yml 暴露 hystrix.stream 端点</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> hystrix.stream
</code></pre> 
<p><strong>启动服务，查看监控端点</strong></p> 
<p>http://localhost:3001/actuator<br> <img src="https://images2.imgbox.com/5f/07/tCQjwkKT_o.png" alt="在这里插入图片描述"><br> <strong>hystrix dashboard</strong></p> 
<p>启动 hystrix dashboard 服务，填入 feign 监控路径，开启监控<br> <img src="https://images2.imgbox.com/f5/4d/eIXOnlav_o.png" alt="在这里插入图片描述"></p> 
<p>访问 http://localhost:4001/hystrix</p> 
<ol><li>填入 feign 监控路径<br> http://localhost:3001/actuator/hystrix.stream</li><li>访问微服务，以产生监控数据</li></ol> 
<p><em>http://localhost:3001/item-service/35<br> http://localhost:3001/user-service/7<br> http://localhost:3001/user-service/7/score?score=100<br> http://localhost:3001/order-service/123abc<br> http://localhost:3001/order-service/</em></p> 
<p>看一下我的<br> <img src="https://images2.imgbox.com/b6/b8/ZTKyhMBk_o.png" alt="在这里插入图片描述"><strong>熔断测试</strong></p> 
<p>用 ab 工具，以并发50次，来发送20000个请求</p> 
<pre><code class="prism language-powershell">ab <span class="token operator">-</span>n 20000 <span class="token operator">-</span>c 50 http:<span class="token operator">/</span><span class="token operator">/</span>localhost:3001<span class="token operator">/</span>item<span class="token operator">-</span>service<span class="token operator">/</span>35
</code></pre> 
<p><img src="https://images2.imgbox.com/40/a0/eJbvZUcv_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="order_service__2571"></a>order service 调用商品库存服务和用户服务</h3> 
<p><img src="https://images2.imgbox.com/ed/b8/2ec7bjww_o.png" alt="在这里插入图片描述">修改 order-service 项目，添加 feign，调用 item service 和 user service</p> 
<p><strong>pom.xml</strong><br> 添加以下依赖：</p> 
<ol><li>actuator</li><li>feign</li><li>hystrix</li></ol> 
<pre><code class="prism language-powershell">&lt;?xml version=<span class="token string">"1.0"</span> encoding=<span class="token string">"UTF-8"</span>?&gt;
&lt;project xmlns=<span class="token string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         xsi:schemaLocation=<span class="token string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;
    &lt;modelVersion&gt;4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0&lt;<span class="token operator">/</span>modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com<span class="token punctuation">.</span>ly&lt;<span class="token operator">/</span>groupId&gt;
        &lt;artifactId&gt;springCloud&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;version&gt;1<span class="token punctuation">.</span>0<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;<span class="token operator">/</span>parent&gt;
    &lt;artifactId&gt;order<span class="token operator">-</span>service&lt;<span class="token operator">/</span>artifactId&gt;
    &lt;version&gt;0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;name&gt;order<span class="token operator">-</span>service&lt;<span class="token operator">/</span>name&gt;
    &lt;description&gt;Demo project <span class="token keyword">for</span> Spring Boot&lt;<span class="token operator">/</span>description&gt;
    &lt;properties&gt;
        &lt;java<span class="token punctuation">.</span>version&gt;1<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>java<span class="token punctuation">.</span>version&gt;
    &lt;<span class="token operator">/</span>properties&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com<span class="token punctuation">.</span>ly&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;commons&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;version&gt;1<span class="token punctuation">.</span>0<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;
                spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>eureka<span class="token operator">-</span>client
            &lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>actuator&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;
                spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>hystrix
            &lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>openfeign&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
    &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>dependencies&lt;<span class="token operator">/</span>artifactId&gt;
                &lt;version&gt;Greenwich<span class="token punctuation">.</span>SR1&lt;<span class="token operator">/</span>version&gt;
                &lt;<span class="token function">type</span>&gt;pom&lt;<span class="token operator">/</span><span class="token function">type</span>&gt;
                &lt;scope&gt;import&lt;<span class="token operator">/</span>scope&gt;
            &lt;<span class="token operator">/</span>dependency&gt;
        &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;<span class="token operator">/</span>dependencyManagement&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>maven<span class="token operator">-</span>plugin&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;<span class="token operator">/</span>plugin&gt;
        &lt;<span class="token operator">/</span>plugins&gt;
    &lt;<span class="token operator">/</span>build&gt;
&lt;<span class="token operator">/</span>project&gt;
</code></pre> 
<p><strong>application.yml</strong></p> 
<p>ribbon 重试和 hystrix 超时，这里没有设置，采用了默认值</p> 
<pre><code class="prism language-yaml">
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service

  <span class="token comment"># server:</span>
  <span class="token comment">#  port: 8201</span>


<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka

<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> hystrix.stream

<span class="token punctuation">---</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> order1

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8201</span>

<span class="token punctuation">---</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> order2

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8202</span>

</code></pre> 
<p><strong>主程序</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@SpringCloudApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderServiceApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建feignclient包，结构如下<br> <img src="https://images2.imgbox.com/fe/57/pFNvClQ3_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"item-service"</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">ItemFeignServiceFB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ItemFeignService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{orderId}"</span><span class="token punctuation">)</span>
    <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/decreaseNumber"</span><span class="token punctuation">)</span>
    <span class="token class-name">JsonResult</span> <span class="token function">decreaseNumber</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemFeignServiceFB</span> <span class="token keyword">implements</span> <span class="token class-name">ItemFeignService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>

                    <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"缓存aaa"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"缓存bbb"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">"缓存ccc"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">"缓存ddd"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">"缓存eee"</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"无法获取订单商品列表"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">decreaseNumber</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"无法修改商品库存"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"user-service"</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">UserFeignServiceFB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserFeignService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{userId}"</span><span class="token punctuation">)</span>
    <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{userId}/score"</span><span class="token punctuation">)</span>
    <span class="token class-name">JsonResult</span> <span class="token function">addScore</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserFeignServiceFB</span> <span class="token keyword">implements</span> <span class="token class-name">UserFeignService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0.4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token string">"缓存name"</span><span class="token operator">+</span>userId<span class="token punctuation">,</span> <span class="token string">"缓存pwd"</span><span class="token operator">+</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"无法获取用户信息"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span> <span class="token function">addScore</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> userId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">"无法增加用户积分"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>OrderServiceImpl</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ItemFeignService</span> itemService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserFeignService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//调用user-service获取用户信息</span>
        <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//调用item-service获取商品信息</span>
        <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> itemService<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//调用item-service减少商品库存</span>
        itemService<span class="token punctuation">.</span><span class="token function">decreaseNumber</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//TODO: 调用user-service增加用户积分</span>
        userService<span class="token punctuation">.</span><span class="token function">addScore</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"保存订单："</span><span class="token operator">+</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>order-service 配置启动参数</strong></p> 
<p><mark>–spring.profiles.active=order1<br> –spring.profiles.active=order2</mark></p> 
<p><img src="https://images2.imgbox.com/2a/96/2S6gI66q_o.png" alt="在这里插入图片描述"></p> 
<p>启动服务：<br> <img src="https://images2.imgbox.com/62/c1/Kf86mEeM_o.png" alt="在这里插入图片描述"></p> 
<p><strong>进行测试</strong></p> 
<ol><li>根据orderid，获取订单<br> http://localhost:8201/123abc</li><li>保存订单<br> http://localhost:8201/</li><li>通过 feign 访问 order service<br> http://localhost:3001/order-service/123abc</li><li>http://localhost:3001/order-service/</li></ol> 
<p><strong>hystrix dashboard 监控 order service 断路器</strong><br> 访问 http://localhost:4001/hystrix ，填入 order service 的断路器监控路径，启动监控<br> http://localhost:8201/actuator/hystrix.stream<br> 或者<br> http://localhost:8202/actuator/hystrix.stream<br> 进行测试访问，可以看到监控信息<br> <img src="https://images2.imgbox.com/20/59/2uwgaLDL_o.png" alt="在这里插入图片描述"><br> 可以看到有集群的话，目前只能看一个，因此需要一个集群聚合监控，那用谁呢？</p> 
<h3><a id="hystrix__turbine__2843"></a>hystrix + turbine 集群聚合监控</h3> 
<p>hystrix dashboard 一次只能监控一个服务实例，使用 <strong>turbine</strong> 可以汇集监控信息，将聚合后的信息提供给 hystrix dashboard 来集中展示和监控<br> <img src="https://images2.imgbox.com/93/19/4uz7TK0V_o.png" alt="在这里插入图片描述">新建<strong>sp-turbine</strong> module项目，</p> 
<pre><code class="prism language-powershell">&lt;?xml version=<span class="token string">"1.0"</span> encoding=<span class="token string">"UTF-8"</span>?&gt;
&lt;project xmlns=<span class="token string">"http://maven.apache.org/POM/4.0.0"</span>
         xmlns:xsi=<span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         xsi:schemaLocation=<span class="token string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;springCloud&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;groupId&gt;com<span class="token punctuation">.</span>ly&lt;<span class="token operator">/</span>groupId&gt;
        &lt;version&gt;1<span class="token punctuation">.</span>0<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;<span class="token operator">/</span>parent&gt;
    &lt;modelVersion&gt;4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0&lt;<span class="token operator">/</span>modelVersion&gt;
    &lt;version&gt;0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;name&gt;<span class="token function">sp</span><span class="token operator">-</span>feign&lt;<span class="token operator">/</span>name&gt;
    &lt;artifactId&gt;<span class="token function">sp</span><span class="token operator">-</span>turbine&lt;<span class="token operator">/</span>artifactId&gt;
    &lt;properties&gt;
        &lt;java<span class="token punctuation">.</span>version&gt;1<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>java<span class="token punctuation">.</span>version&gt;
        &lt;spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;Greenwich<span class="token punctuation">.</span>SR1&lt;<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;
    &lt;<span class="token operator">/</span>properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>eureka<span class="token operator">-</span>client&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>turbine&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        
    &lt;<span class="token operator">/</span>dependencies&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>dependencies&lt;<span class="token operator">/</span>artifactId&gt;
                &lt;version&gt;$<span class="token punctuation">{<!-- --></span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version<span class="token punctuation">}</span>&lt;<span class="token operator">/</span>version&gt;
                &lt;<span class="token function">type</span>&gt;pom&lt;<span class="token operator">/</span><span class="token function">type</span>&gt;
                &lt;scope&gt;import&lt;<span class="token operator">/</span>scope&gt;
            &lt;<span class="token operator">/</span>dependency&gt;
        &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;<span class="token operator">/</span>dependencyManagement&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>maven<span class="token operator">-</span>plugin&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;<span class="token operator">/</span>plugin&gt;
        &lt;<span class="token operator">/</span>plugins&gt;
    &lt;<span class="token operator">/</span>build&gt;

&lt;<span class="token operator">/</span>project&gt;
</code></pre> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> turbin
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5001</span>
  
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
      
<span class="token key atrule">turbine</span><span class="token punctuation">:</span>
  <span class="token key atrule">app-config</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service<span class="token punctuation">,</span> feign
  <span class="token key atrule">cluster-name-expression</span><span class="token punctuation">:</span> new String("default")
</code></pre> 
<p><strong>主程序</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableTurbine</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpTurbineApplication</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpTurbineApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><strong>启动进行测试</strong>，</p> 
<ol><li>turbine 监控路径<br> http://localhost:5001/turbine.stream</li><li>在 hystrix dashboard 中填入turbine 监控路径，开启监控<br> http://localhost:4001/hystrix</li><li><strong>turbine聚合了feign服务和order-service服务集群的hystrix监控信息</strong></li></ol> 
<p><strong>访问下面测试数据，查看监控信息</strong></p> 
<ol><li>8201服务器产生监控数据:<br> http://localhost:8201/abc123<br> http://localhost:8201/</li><li>8202服务器产生监控数据:<br> http://localhost:8202/abc123<br> http://localhost:8202/</li><li>3001服务器产生监控数据:<br> http://localhost:3001/item-service/35<br> http://localhost:3001/item-service/decreaseNumber<br> 使用postman，POST发送以下格式数据：<br> <mark>[{“id”:1, “name”:“abc”, “number”:23},{“id”:2, “name”:“def”, “number”:11}]</mark><br> http://localhost:3001/user-service/7<br> http://localhost:3001/user-service/7/score?score=100<br> http://localhost:3001/order-service/123abc<br> http://localhost:3001/order-service/</li></ol> 
<h2><a id="7_zuul_API_2960"></a>7. zuul API网关</h2> 
<p>为什么需要服务网关？<br> 在分布式系统系统中，有商品、订单、用户、广告、支付等等一大批的服务，前端怎么调用呢？和每个服务一个个打交道？<br> 看一下用例图：<br> <img src="https://images2.imgbox.com/c1/49/cXiCpaOj_o.png" alt="在这里插入图片描述"><br> 如果让客户端直接与各个微服务通信，会有以下问题：</p> 
<ol><li>客户端不止一次请求不同的微服务，增加了客户端的复杂性。</li><li>存在跨域请求，在一定的场景下处理相对复杂。</li><li>认证复杂，每个微服务都需要独立认证。</li><li>难以重构，随着项目的迭代，可能需要重新划分微服务。</li><li>某些微服务可能使用了防火墙/浏览器不友好的协议，直接访问会有一定困难。</li></ol> 
<p>这就需要有一个角色充当所有请求的入口，这个角色就是<strong>服务网关</strong><br> 微服务网关是介于客户端和服务端之间的中间层，所有的外部请求都会先经过微服务网关。使用微服务网关后的架构如下：<br> <img src="https://images2.imgbox.com/3d/e0/GfRzdzhX_o.png" alt="在这里插入图片描述"><br> 客户端只须跟网关交互，而无须直接调用特定微服务的接口。这样开发就可以得到简化。不仅如此，使用微服务网关还有以下优点：</p> 
<ol><li>易于监控。可在微服务网关收集监控数据并将其推送到外部系统进行分析。</li><li>易于认证。可在微服务网关上进行认证，然后再将请求转发到后端的微服务，而无须在每个微服务上进行认证。</li><li>减少了客户端与各个微服务之间的交互次数。</li></ol> 
<p><strong>我们详细说说zuul</strong><br> Zuul是Netflix开源的微服务网关，它可以和Eureka、Ribbon、hystrix等组件配合使用。<br> 网关是系统对外的唯一入口，介于客户端和服务端之间，用于对请求进行身份验证，限流，路由，监控等操作。</p> 
<p>所以zuul中最重要的是路由和过滤器</p> 
<h3><a id="zuul__2986"></a>zuul 路由</h3> 
<p><strong>简单配置</strong></p> 
<p>先看一下目前的架构，<em>颜色有点不搭，凑合看吧</em><br> <img src="https://images2.imgbox.com/08/e9/nzO7BRK4_o.png" alt="在这里插入图片描述">解释一下：<br> 可以看到，zuul需要向eureka中注册。为啥呢？<br> 思考一个问题，在上节试验中，order需要访问user，item服务的信息。那user，item是服务提供者，order是服务消费者。所以说作为消费者的服务都注册到了eureka中，那zuul也注册了，是不是就可以获取到消费者了？<br> 那是不是就可以拿到所有消费者的数据(名称，ip，端口)？<br> 那这样的话，是不是就可以做路由映射了呢？<br> 比如 作为客户端，我们访问user服务的话，是这样的：<strong>http://localhost:8001/user-service/7</strong>。<br> 那现在可不可这样呢？<strong>http://localhost:9001/user-service/7</strong></p> 
<p><mark>这里可能会混淆上面我们试验feign的时候，用的是<strong>http://localhost:3001/user-service/7</strong>，那这里为啥不行呢？说明一下:</mark></p> 
<ol><li>zuul是用于<strong>客户端访问</strong>整个应用的流量入口，接收所有的<strong>请求</strong>，并将不同的请求转发至不同的微服务模块，其作用可类似于nginx。</li><li>feign是将当前微服务项目的一些服务接口暴露，用于各个微服务之间的服务调用。<strong>两者的应用层次以及原理均不相同</strong>。</li><li>zuul其实也含有hysstrix和ribbon，但是基于http，可 直接代理服务 。在它和服务间增加feign只会增加通讯消耗，没有其他意义。而feign的负载均衡是基于Eureka实现的</li><li><strong>feign主要做服务流控</strong>，feign的负载均衡是基于Eureka实现的，<strong>zuul主要做客户端流控</strong>，并且Zuul的负载均衡结合Eureka实现易用性较好，并且Zuul一般对第三方提供访问接口。</li></ol> 
<p>继续我们的话题，</p> 
<p><strong>统一前缀</strong><br> 这个 就是我们可以在请求前面加一个统一的前缀，比如我们刚刚调用的是http://localhost:9001/user-service/7，这个时候我们在yaml配置文件中添加如下。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">zuul</span><span class="token punctuation">:</span>  
  <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /zuul  
</code></pre> 
<p>这样我们就需要通过<strong>http://localhost:9001/zuul/user-service/7</strong>来进行访问了。</p> 
<p><strong>路由策略配置</strong></p> 
<p>前面的访问方式(直接使用服务名)，需要将微服务名称暴露给客户端，存在安全性问题。那我们可以自定义路径来替代微服务名称，即<strong>自定义路由策略</strong>。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token key atrule">user-service</span><span class="token punctuation">:</span> /user/<span class="token important">**</span>
</code></pre> 
<p>那请求就变成了：<strong>http://localhost:9001/zuul/user/7</strong></p> 
<p><strong>服务名屏蔽</strong></p> 
<p>其实配置完路由策略之后使用微服务名称还是可以访问的，这个时候你需要将服务名屏蔽。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">zuul</span><span class="token punctuation">:</span>  
 <span class="token key atrule">ignore-services</span><span class="token punctuation">:</span> <span class="token string">"*"</span> 
</code></pre> 
<p><strong>路径屏蔽</strong></p> 
<p>Zuul还可以指定屏蔽掉的路径 URI，即只要用户请求中包含指定的 URI 路径，那么该请求将无法访问到指定的服务。通过该方式可以限制用户的权限。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">zuul</span><span class="token punctuation">:</span>  
  <span class="token key atrule">ignore-patterns</span><span class="token punctuation">:</span> <span class="token important">**/item/**</span>  
</code></pre> 
<p>这样关于 item的请求我们就可以过滤掉了。</p> 
<ol><li>** 代表匹配多级任意路径</li><li>*代表匹配一级任意路径</li></ol> 
<p><strong>敏感请求头屏蔽</strong><br> 默认情况下，像 Cookie、Set-Cookie 等敏感请求头信息会被 zuul 屏蔽掉，我们可以将这些默认屏蔽去掉，也可以添加要屏蔽的请求头。</p> 
<p>实例操作开始，过于过滤稍后讲解</p> 
<h3><a id="_3050"></a>实例操作</h3> 
<p>创建sp-zuul module项目，<br> <img src="https://images2.imgbox.com/88/87/0oLKMqIC_o.png" alt="在这里插入图片描述"><br> pom.xml</p> 
<pre><code class="prism language-powershell">&lt;?xml version=<span class="token string">"1.0"</span> encoding=<span class="token string">"UTF-8"</span>?&gt;
&lt;project xmlns=<span class="token string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         xsi:schemaLocation=<span class="token string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;
    &lt;modelVersion&gt;4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0&lt;<span class="token operator">/</span>modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com<span class="token punctuation">.</span>ly&lt;<span class="token operator">/</span>groupId&gt;
        &lt;artifactId&gt;springCloud&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;version&gt;1<span class="token punctuation">.</span>0<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;<span class="token operator">/</span>parent&gt;
    &lt;artifactId&gt;<span class="token function">sp</span><span class="token operator">-</span>zuul&lt;<span class="token operator">/</span>artifactId&gt;
    &lt;version&gt;0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;name&gt;<span class="token function">sp</span><span class="token operator">-</span>zuul&lt;<span class="token operator">/</span>name&gt;
    &lt;description&gt;Demo project <span class="token keyword">for</span> Spring Boot&lt;<span class="token operator">/</span>description&gt;

    &lt;properties&gt;
        &lt;java<span class="token punctuation">.</span>version&gt;1<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>java<span class="token punctuation">.</span>version&gt;
        &lt;spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;Greenwich<span class="token punctuation">.</span>SR1&lt;<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;
    &lt;<span class="token operator">/</span>properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>eureka<span class="token operator">-</span>client&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>zuul&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>retry&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>retry&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com<span class="token punctuation">.</span>ly&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;commons&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;version&gt;1<span class="token punctuation">.</span>0<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
    &lt;<span class="token operator">/</span>dependencies&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>dependencies&lt;<span class="token operator">/</span>artifactId&gt;
                &lt;version&gt;$<span class="token punctuation">{<!-- --></span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version<span class="token punctuation">}</span>&lt;<span class="token operator">/</span>version&gt;
                &lt;<span class="token function">type</span>&gt;pom&lt;<span class="token operator">/</span><span class="token function">type</span>&gt;
                &lt;scope&gt;import&lt;<span class="token operator">/</span>scope&gt;
            &lt;<span class="token operator">/</span>dependency&gt;
        &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;<span class="token operator">/</span>dependencyManagement&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>maven<span class="token operator">-</span>plugin&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;<span class="token operator">/</span>plugin&gt;
        &lt;<span class="token operator">/</span>plugins&gt;
    &lt;<span class="token operator">/</span>build&gt;
&lt;<span class="token operator">/</span>project&gt;
</code></pre> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml">
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> zuul

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3001</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka

<span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token key atrule">item-service</span><span class="token punctuation">:</span> /item<span class="token punctuation">-</span>service/<span class="token important">**</span>
    <span class="token key atrule">user-service</span><span class="token punctuation">:</span> /user<span class="token punctuation">-</span>service/<span class="token important">**</span>
    <span class="token key atrule">order-service</span><span class="token punctuation">:</span> /order<span class="token punctuation">-</span>service/<span class="token important">**</span>
</code></pre> 
<p><strong>启动类</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableZuulProxy</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpZuulApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpZuulApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>启动服务，访问测试</strong></p> 
<p><img src="https://images2.imgbox.com/a5/77/E04r2sKy_o.png" alt="在这里插入图片描述"><br> 测试链接：</p> 
<p>http://eureka1:2001<br> http://localhost:3001/item-service/35<br> http://localhost:3001/item-service/decreaseNumber<br> 使用postman，POST发送以下格式数据：<br> <mark>[{“id”:1, “name”:“abc”, “number”:23},{“id”:2, “name”:“def”, “number”:11}]</mark><br> http://localhost:3001/user-service/7<br> http://localhost:3001/user-service/7/score?score=100<br> http://localhost:3001/order-service/123abc<br> http://localhost:3001/order-service/</p> 
<p><strong>zuul + ribbon 负载均衡</strong><br> zuul 已经集成了 ribbon，默认已经实现了负载均衡</p> 
<p><strong>zuul + ribbon 重试</strong><br> pom.xml 添加 spring-retry 依赖</p> 
<p><strong>配置 zuul 开启重试，并配置 ribbon 重试参数</strong><br> <mark>需要开启重试，默认不开启</mark></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> zuul
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3001</span>
  
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka

<span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">retryable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token comment">#  routes:</span>
<span class="token comment">#    item-service: /item-service/**</span>
<span class="token comment">#    user-service: /user-service/**</span>
<span class="token comment">#    order-service: /order-service/**</span>
    
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre> 
<p><strong>zuul + hystrix 降级</strong></p> 
<p>创建降级类<br> <mark>getRoute() 方法中指定应用此降级类的服务id，星号或null值可以通配所有服务</mark></p> 
<p><strong>ItemServiceFallback</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>fallback</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">JsonResult</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>zuul<span class="token punctuation">.</span>filters<span class="token punctuation">.</span>route<span class="token punctuation">.</span></span><span class="token class-name">FallbackProvider</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpHeaders</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ClientHttpResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemServiceFallback</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackProvider</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//当执行item-service失败，</span>
        <span class="token comment">//应用当前这个降级类</span>
        <span class="token keyword">return</span> <span class="token string">"item-service"</span><span class="token punctuation">;</span>
        <span class="token comment">//星号和null都表示所有微服务失败都应用当前降级类</span>
        <span class="token comment">//"*"; //null;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//该方法返回封装降级响应的对象</span>
    <span class="token comment">//ClientHttpResponse中封装降级响应</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ClientHttpResponse</span> <span class="token function">fallbackResponse</span><span class="token punctuation">(</span><span class="token class-name">String</span> route<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ClientHttpResponse</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClientHttpResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//下面三个方法都是协议号</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">HttpStatus</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getRawStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getStatusText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">getReasonPhrase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">InputStream</span> <span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"fallback body"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token string">"后台服务错误"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">HttpHeaders</span> <span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                headers<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> headers<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><strong>OrderServiceFallback</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>fallback</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ly<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">JsonResult</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>zuul<span class="token punctuation">.</span>filters<span class="token punctuation">.</span>route<span class="token punctuation">.</span></span><span class="token class-name">FallbackProvider</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpHeaders</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ClientHttpResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceFallback</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackProvider</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"order-service"</span><span class="token punctuation">;</span> <span class="token comment">//"*"; //null;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ClientHttpResponse</span> <span class="token function">fallbackResponse</span><span class="token punctuation">(</span><span class="token class-name">String</span> route<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">ClientHttpResponse</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClientHttpResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">HttpStatus</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getRawStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getStatusText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">getReasonPhrase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">InputStream</span> <span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"fallback body"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token string">"后台服务错误"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">HttpHeaders</span> <span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                headers<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> headers<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>zuul + hystrix 熔断</strong><br> 降低 hystrix 超时时间，以便测试降级</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> zuul
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3001</span>
  
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka

<span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">retryable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">2000</span>
  <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">1</span>
  
<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">500</span>
</code></pre> 
<p><strong>zuul + hystrix dashboard 监控</strong><br> 暴露 hystrix.stream 监控端点<br> <mark>zuul 已经包含 actuator 依赖</mark></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> hystrix.stream
</code></pre> 
<p>查看暴露的监控端点<br> <mark>http://localhost:3001/actuator</mark><br> <img src="https://images2.imgbox.com/2f/c4/09ikj1xi_o.png" alt="在这里插入图片描述"></p> 
<p>http://localhost:3001/actuator/hystrix.stream</p> 
<p><strong>开启监控</strong></p> 
<p>启动 sp-hystrix-dashboard，填入 zuul 的监控端点路径，开启监控<br> http://localhost:4001/hystrix<br> 填入监控端点：<br> http://localhost:3001/actuator/hystrix.stream<br> <img src="https://images2.imgbox.com/2f/01/6kLzIQAw_o.png" alt="在这里插入图片描述"><br> <strong>zuul + turbine 聚合监控</strong></p> 
<p>修改 turbine 项目，聚合 zuul 服务实例</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> turbin
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5001</span>
  
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
      
<span class="token key atrule">turbine</span><span class="token punctuation">:</span>
  <span class="token key atrule">app-config</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service<span class="token punctuation">,</span> zuul
  <span class="token key atrule">cluster-name-expression</span><span class="token punctuation">:</span> new String("default")
</code></pre> 
<p><strong>turbine 聚合监控端点</strong><br> http://localhost:5001/turbine.stream<br> <img src="https://images2.imgbox.com/95/ea/Fihr7Uau_o.png" alt="在这里插入图片描述"><strong>熔断测试</strong></p> 
<pre><code class="prism language-powershell">ab <span class="token operator">-</span>n 20000 <span class="token operator">-</span>c 50 http:<span class="token operator">/</span><span class="token operator">/</span>localhost:3001<span class="token operator">/</span>order<span class="token operator">-</span>service<span class="token operator">/</span>123abc
</code></pre> 
<p><img src="https://images2.imgbox.com/9d/5a/5mabxYKA_o.png" alt="在这里插入图片描述"><br> 参数详解参考图：<br> <img src="https://images2.imgbox.com/a6/4e/d57duEEF_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="zuul__3438"></a>zuul 过滤</h3> 
<p>如果说，路由功能是Zuul的基操的话，那么过滤器就是Zuul的利器了。毕竟所有请求都经过网关(Zuul)，那么我们可以进行各种过滤，这样我们就能实现<strong>限流</strong>，<strong>灰度发布</strong>，<strong>权限控制</strong>等等。</p> 
<p>其作用可以类比Servlet框架的Filter，或者AOP。所以只要过滤器能干的，他都能干。<br> <img src="https://images2.imgbox.com/76/5e/Lo96PFlC_o.png" alt="在这里插入图片描述"><br> <strong>简单实现一个请求时间日志打印</strong><br> 要实现自己定义的Filter我们只需要继承ZuulFilter然后将这个过滤器类以@Component注解加入 Spring 容器中就行了。</p> 
<p>而 Zuul 中的过滤器总共有 4 种类型，且每种类型都有对应的使用场景。</p> 
<ol><li>pre<br> 可以在请求被路由之前调用。适用于身份认证的场景，认证通过后再继续执行下面的流程。</li><li>route<br> 在路由请求时被调用。适用于灰度发布场景，在将要路由的时候可以做一些自定义的逻辑。</li><li>post<br> 在 route 和 error 过滤器之后被调用。这种过滤器将请求路由到达具体的服务之后执行。适用于需要添加响应头，记录响应日志等应用场景。</li><li>error<br> 处理请求时发生错误时被调用。在执行过程中发送错误时会进入 error 过滤器，可以用来统一记录错误信息。</li></ol> 
<p>请求时间日志打印源码：</p> 
<pre><code class="prism language-java"><span class="token comment">// 加入Spring容器  </span>
<span class="token annotation punctuation">@Component</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PreRequestFilter</span> <span class="token keyword">extends</span> <span class="token class-name">ZuulFilter</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 返回过滤器类型 这里是前置过滤器  </span>
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">return</span> <span class="token class-name">FilterConstants</span><span class="token punctuation">.</span>PRE_TYPE<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// 指定过滤顺序 越小越先执行，这里第一个执行  </span>
    <span class="token comment">// 当然不是只真正第一个 在Zuul内置中有其他过滤器会先执行  </span>
    <span class="token comment">// 那是写死的 比如 SERVLET_DETECTION_FILTER_ORDER = -3  </span>
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// 什么时候该进行过滤  </span>
    <span class="token comment">// 这里我们可以进行一些判断，这样我们就可以过滤掉一些不符合规定的请求等等  </span>
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// 如果过滤器允许通过则怎么进行处理  </span>
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZuulException</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token comment">// 这里我设置了全局的RequestContext并记录了请求开始时间  </span>
        <span class="token class-name">RequestContext</span> ctx <span class="token operator">=</span> <span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"startTime"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  

<span class="token comment">// lombok的日志  </span>
<span class="token annotation punctuation">@Slf4j</span>  
<span class="token comment">// 加入 Spring 容器  </span>
<span class="token annotation punctuation">@Component</span>  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccessLogFilter</span> <span class="token keyword">extends</span> <span class="token class-name">ZuulFilter</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 指定该过滤器的过滤类型  </span>
    <span class="token comment">// 此时是后置过滤器  </span>
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">return</span> <span class="token class-name">FilterConstants</span><span class="token punctuation">.</span>POST_TYPE<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// SEND_RESPONSE_FILTER_ORDER 是最后一个过滤器  </span>
    <span class="token comment">// 我们此过滤器在它之前执行  </span>
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">return</span> <span class="token class-name">FilterConstants</span><span class="token punctuation">.</span>SEND_RESPONSE_FILTER_ORDER <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// 过滤时执行的策略  </span>
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZuulException</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token class-name">RequestContext</span> context <span class="token operator">=</span> <span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment">// 从RequestContext获取原先的开始时间 并通过它计算整个时间间隔  </span>
        <span class="token class-name">Long</span> startTime <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"startTime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment">// 这里我可以获取HttpServletRequest来获取URI并且打印出来  </span>
        <span class="token class-name">String</span> uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>  
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"uri: "</span> <span class="token operator">+</span> uri <span class="token operator">+</span> <span class="token string">", duration: "</span> <span class="token operator">+</span> duration <span class="token operator">/</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre> 
<p>上面就简单实现了请求时间日志打印功能</p> 
<h3><a id="_3527"></a>实例操作</h3> 
<p>在我们项目创建一个过滤器，指定service为item-service，当参数有token才可以允许访问，否则不允许访问</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccessFilter</span> <span class="token keyword">extends</span> <span class="token class-name">ZuulFilter</span><span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token comment">//对指定的serviceid过滤，如果要过滤所有服务，直接返回 true</span>
	    
		<span class="token class-name">RequestContext</span> ctx <span class="token operator">=</span> <span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> serviceId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">FilterConstants</span><span class="token punctuation">.</span>SERVICE_ID_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"item-service"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZuulException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">RequestContext</span> ctx <span class="token operator">=</span> <span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">HttpServletRequest</span> req <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> at <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>at <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//此设置会阻止请求被路由到后台微服务</span>
			ctx<span class="token punctuation">.</span><span class="token function">setSendZuulResponse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			ctx<span class="token punctuation">.</span><span class="token function">setResponseStatusCode</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			ctx<span class="token punctuation">.</span><span class="token function">setResponseBody</span><span class="token punctuation">(</span><span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token class-name">JsonResult</span><span class="token punctuation">.</span>NOT_LOGIN<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//zuul过滤器返回的数据设计为以后扩展使用，</span>
		<span class="token comment">//目前该返回值没有被使用</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">FilterConstants</span><span class="token punctuation">.</span>PRE_TYPE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token comment">//该过滤器顺序要 &gt; 5，才能得到 serviceid</span>
		<span class="token keyword">return</span> <span class="token class-name">FilterConstants</span><span class="token punctuation">.</span>PRE_DECORATION_FILTER_ORDER<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>访问测试</strong></p> 
<ol><li>没有token参数不允许访问<br> http://localhost:3001/item-service/35<br> 返回结果是400<br> <img src="https://images2.imgbox.com/75/f7/VYSERKFo_o.png" alt="在这里插入图片描述"></li><li>有token参数可以访问<br> http://localhost:3001/item-service/35?token=1234（由于我们前面模拟了服务响应时间过长出现降级的情况，所以会出现降级的返回结果，但也是说明过滤起作用了，不是吗）<br> <img src="https://images2.imgbox.com/a9/b5/1GMoKBxD_o.png" alt="在这里插入图片描述">或者<br> <img src="https://images2.imgbox.com/e8/66/68XpYVC1_o.png" alt="在这里插入图片描述"></li></ol> 
<h2><a id="8_config__3583"></a>8. config 配置中心</h2> 
<p>当微服务系统逐渐庞大起来，那么多Consumer、Provider、Eureka Server、Zuul系统都会持有自己的配置，若出现了在项目运行的时候需要更改某些应用的配置的情况，如果我们不进行配置的统一管理，我们只能去每个应用下一个一个寻找配置文件然后修改配置文件再重启应用。</p> 
<p>首先对于分布式系统而言我们就不应该去每个应用下去分别修改配置文件，再者对于重启应用来说，服务无法访问所以直接抛弃了可用性，这是我们更不愿见到的。</p> 
<p>那么有没有一种方法既能对配置文件统一地进行管理，又能在项目运行时动态修改配置文件呢？</p> 
<p>看一下官方解释：<br> Spring Cloud Config为分布式系统中的外部化配置提供服务器和客户端支持。使用Config服务器，可以在中心位置管理所有环境中应用程序的外部属性。</p> 
<p>简单来说，Spring Cloud Config就是能将各个 应用/系统/模块 的配置文件存放到统一的地方然后进行管理(Git 或者 SVN)。</p> 
<p>你想一下，我们的应用是不是只有启动的时候才会进行配置文件的加载，那么我们的Spring Cloud Config就暴露出一个接口给启动应用来获取它所想要的配置文件，应用获取到配置文件然后再进行它的初始化工作，如下图<br> <img src="https://images2.imgbox.com/47/23/ocUv7GHT_o.png" alt="在这里插入图片描述"><br> 那你肯定还会有一个疑问，如果我在应用运行时去更改远程配置仓库(Git)中的对应配置文件，那么依赖于这个配置文件的已启动的应用会不会进行其相应配置的更改呢？</p> 
<p>答案是不会的。<br> 那怎么进行动态修改配置文件呢？这不是出现了配置漂移吗？</p> 
<p>别急，你可以使用Webhooks，这是 github提供的功能，它能确保远程库的配置文件更新后客户端中的配置信息也得到更新。</p> 
<p>Webhooks虽然能解决，但是你了解一下会发现它根本不适合用于生产环境，所以基本不会使用它的。</p> 
<p>一般我们会使用<strong>Bus消息总线</strong> +Spring Cloud Config进行配置的动态刷新。</p> 
<p>那消息总线下节再讲，我们先看config配置中心的具体应用</p> 
<h3><a id="config_3609"></a>config创建</h3> 
<p>yml 配置文件保存到 git 服务器，例如 github.com 或 gitee.com</p> 
<p>微服务启动时，从服务器获取配置文件</p> 
<p>既然提到了git服务器，我们就需要先进行创建一个config项目专门存放配置，并将其上传到git服务器上</p> 
<p>新建一个<strong>空的project</strong>，起名为config,删除src文件</p> 
<p><img src="https://images2.imgbox.com/e4/72/Q3xnnriw_o.png" alt="在这里插入图片描述"><br> 将item,user,order,zuul四个项目的yml配置文件,复制到config项目,并改名<br> <strong>item-service-dev.yml<br> user-service-dev.yml<br> order-service-dev.yml<br> zuul-dev.yml</strong></p> 
<p><img src="https://images2.imgbox.com/de/ac/dUzXDx2D_o.png" alt="在这里插入图片描述"><br> <strong>将 config 项目上传到 github</strong></p> 
<p><mark>请先注册账户并登录</mark></p> 
<p>新建仓库<br> <img src="https://images2.imgbox.com/af/c5/stXCtGv6_o.png" alt="在这里插入图片描述"></p> 
<p>仓库命名<br> <img src="https://images2.imgbox.com/65/02/yDcoXDa4_o.png" alt="在这里插入图片描述">创建好，看首页,点击进去查看详情，<br> <img src="https://images2.imgbox.com/b8/9d/yObuezzy_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3a/b9/iJQFSl1Y_o.png" alt="在这里插入图片描述">拿到这个地址，我们到idea进行同步一下(<mark>前提是你已配置好相关配置，若是第一次使用，请自行查阅资料进行相关配置，若有相关技术解答，可留言</mark>)</p> 
<p><img src="https://images2.imgbox.com/73/7b/u76I0Kc7_o.png" alt="在这里插入图片描述"><br> 项目克隆好后，我们直接将上面的config文件夹挪进来，同时复制到<br> <img src="https://images2.imgbox.com/c3/3f/sidXdwUs_o.png" alt="在这里插入图片描述"><br> 并上传到GitHub上，提交的时候可以看到有俩个选项。第二个可以同步到GitHub上的，只选择commit的话，只能提交到本地。</p> 
<p><img src="https://images2.imgbox.com/d0/8d/dNKJwHoD_o.png" alt="在这里插入图片描述"><br> 若不小心选择了commit的话，可以再次同步的<br> <img src="https://images2.imgbox.com/97/91/XTRcCIPY_o.png" alt="在这里插入图片描述"><mark>使用GitHub的话要有个本地仓库，我们可以使用GitHub的客户端进行配置，具体详细教程可自行查阅资料，后期我也会专门针对GitHub分享相关教程</mark><br> <img src="https://images2.imgbox.com/27/ed/zJnEgAXe_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c5/83/oGFXwWw1_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_3648"></a>项目应用</h3> 
<p>在原项目中添加module项目sp-config。<br> <img src="https://images2.imgbox.com/69/de/nWriWsCq_o.png" alt="在这里插入图片描述"><br> <strong>pom.xml</strong></p> 
<pre><code class="prism language-powershell">&lt;?xml version=<span class="token string">"1.0"</span> encoding=<span class="token string">"UTF-8"</span>?&gt;
&lt;project xmlns=<span class="token string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         xsi:schemaLocation=<span class="token string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;
    &lt;modelVersion&gt;4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0&lt;<span class="token operator">/</span>modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com<span class="token punctuation">.</span>ly&lt;<span class="token operator">/</span>groupId&gt;
        &lt;artifactId&gt;springCloud&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;version&gt;1<span class="token punctuation">.</span>0<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;<span class="token operator">/</span>parent&gt;
    &lt;artifactId&gt;<span class="token function">sp</span><span class="token operator">-</span>config&lt;<span class="token operator">/</span>artifactId&gt;
    &lt;version&gt;0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1<span class="token operator">-</span>SNAPSHOT&lt;<span class="token operator">/</span>version&gt;
    &lt;name&gt;<span class="token function">sp</span><span class="token operator">-</span>config&lt;<span class="token operator">/</span>name&gt;
    &lt;description&gt;Demo project <span class="token keyword">for</span> Spring Boot&lt;<span class="token operator">/</span>description&gt;

    &lt;properties&gt;
        &lt;java<span class="token punctuation">.</span>version&gt;1<span class="token punctuation">.</span>8&lt;<span class="token operator">/</span>java<span class="token punctuation">.</span>version&gt;
        &lt;spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;Greenwich<span class="token punctuation">.</span>SR1&lt;<span class="token operator">/</span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version&gt;
    &lt;<span class="token operator">/</span>properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>config<span class="token operator">-</span>server&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
            &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>eureka<span class="token operator">-</span>client&lt;<span class="token operator">/</span>artifactId&gt;
        &lt;<span class="token operator">/</span>dependency&gt;
    &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>dependencies&lt;<span class="token operator">/</span>artifactId&gt;
                &lt;version&gt;$<span class="token punctuation">{<!-- --></span>spring<span class="token operator">-</span>cloud<span class="token punctuation">.</span>version<span class="token punctuation">}</span>&lt;<span class="token operator">/</span>version&gt;
                &lt;<span class="token function">type</span>&gt;pom&lt;<span class="token operator">/</span><span class="token function">type</span>&gt;
                &lt;scope&gt;import&lt;<span class="token operator">/</span>scope&gt;
            &lt;<span class="token operator">/</span>dependency&gt;
        &lt;<span class="token operator">/</span>dependencies&gt;
    &lt;<span class="token operator">/</span>dependencyManagement&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot&lt;<span class="token operator">/</span>groupId&gt;
                &lt;artifactId&gt;spring<span class="token operator">-</span>boot<span class="token operator">-</span>maven<span class="token operator">-</span>plugin&lt;<span class="token operator">/</span>artifactId&gt;
            &lt;<span class="token operator">/</span>plugin&gt;
        &lt;<span class="token operator">/</span>plugins&gt;
    &lt;<span class="token operator">/</span>build&gt;

&lt;<span class="token operator">/</span>project&gt;

</code></pre> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>server
  
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/你的个人路径/sp<span class="token punctuation">-</span>config
          <span class="token key atrule">searchPaths</span><span class="token punctuation">:</span> config
          <span class="token key atrule">username</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>username
          <span class="token key atrule">password</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>password
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6001</span>
    
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
</code></pre> 
<p><strong>主程序添加 @EnableConfigServer 和 @EnableDiscoveryClient</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableConfigServer</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpConfigApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpConfigApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>启动，访问测试</strong><br> <img src="https://images2.imgbox.com/08/07/w932baB8_o.png" alt="在这里插入图片描述"><br> 访问 item-service-dev.yml 可以使用以下形式:</p> 
<ol><li>http://localhost:6001/item-service-dev.yml</li><li>http://localhost:6001/item-service/dev<br> <img src="https://images2.imgbox.com/8e/81/EaWeV4sk_o.png" alt="在这里插入图片描述"><br> <mark>测试其他文件<br> http://localhost:6001/user-service/dev<br> http://localhost:6001/zuul/dev</mark><br> …</li></ol> 
<p><strong>config 客户端</strong></p> 
<p>修改以下项目，从配置中心获取配置信息<br> item-service<br> user-service<br> order-service<br> sp-zuul</p> 
<p>在父级的<strong>pom.xml 添加 config 客户端依赖</strong></p> 
<pre><code class="prism language-powershell">&lt;dependency&gt;
	&lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
	&lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>config&lt;<span class="token operator">/</span>artifactId&gt;
	&lt;version&gt;2<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>RELEASE&lt;<span class="token operator">/</span>version&gt;
&lt;<span class="token operator">/</span>dependency&gt;
</code></pre> 
<p><strong>在四个项目中添加 bootstrap.yml</strong></p> 
<p><mark>bootstrap.yml，引导配置文件，先于 application.yml 加载</mark><br> 内容如下：</p> 
<p><strong>item-service</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">service-id</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>server
      <span class="token key atrule">name</span><span class="token punctuation">:</span> item<span class="token punctuation">-</span>service
      <span class="token key atrule">profile</span><span class="token punctuation">:</span> dev
    <span class="token key atrule">inetutils</span><span class="token punctuation">:</span>
      <span class="token key atrule">ignored-interfaces</span><span class="token punctuation">:</span> <span class="token comment"># 忽略的网卡</span>
        <span class="token punctuation">-</span> VM.*
      <span class="token key atrule">preferred-networks</span><span class="token punctuation">:</span> <span class="token comment"># 要是用的网卡的网段</span>
        <span class="token punctuation">-</span> 172.16.2
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
</code></pre> 
<p><strong>user-service</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">service-id</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>server
      <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service
      <span class="token key atrule">profile</span><span class="token punctuation">:</span> dev
    <span class="token key atrule">inetutils</span><span class="token punctuation">:</span>
      <span class="token key atrule">ignored-interfaces</span><span class="token punctuation">:</span> <span class="token comment"># 忽略的网卡</span>
        <span class="token punctuation">-</span> VM.*
      <span class="token key atrule">preferred-networks</span><span class="token punctuation">:</span> <span class="token comment"># 要是用的网卡的网段</span>
        <span class="token punctuation">-</span> 172.16.2
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
</code></pre> 
<p><strong>order-service</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">service-id</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>server
      <span class="token key atrule">name</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service
      <span class="token key atrule">profile</span><span class="token punctuation">:</span> dev
    <span class="token key atrule">inetutils</span><span class="token punctuation">:</span>
      <span class="token key atrule">ignored-interfaces</span><span class="token punctuation">:</span> <span class="token comment"># 忽略的网卡</span>
        <span class="token punctuation">-</span> VM.*
      <span class="token key atrule">preferred-networks</span><span class="token punctuation">:</span> <span class="token comment"># 要是用的网卡的网段</span>
        <span class="token punctuation">-</span> 172.16.2
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
</code></pre> 
<p><strong>zuul</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">service-id</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>server
      <span class="token key atrule">name</span><span class="token punctuation">:</span> zuul
      <span class="token key atrule">profile</span><span class="token punctuation">:</span> dev
    <span class="token key atrule">inetutils</span><span class="token punctuation">:</span>
      <span class="token key atrule">ignored-interfaces</span><span class="token punctuation">:</span> <span class="token comment"># 忽略的网卡</span>
        <span class="token punctuation">-</span> VM.*
      <span class="token key atrule">preferred-networks</span><span class="token punctuation">:</span> <span class="token comment"># 要是用的网卡的网段</span>
        <span class="token punctuation">-</span> 172.16.2
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka
</code></pre> 
<p><strong>启动服务，观察从配置中心获取配置信息的日志</strong>，先启动eureka，在启动config，然后在启动其他的服务<br> 当看到启动的时候出现如图所示的日志时，说明服务启动的时候从GitHub服务上获取的配置<br> <img src="https://images2.imgbox.com/47/25/z6R1INjy_o.png" alt="在这里插入图片描述"><br> <strong>配置刷新</strong></p> 
<p>spring cloud 允许<strong>运行时动态刷新配置</strong>，可以重新加载本地配置文件 application.yml，或者从配置中心获取新的配置信息</p> 
<p>以 <strong>user-service</strong> 为例演示配置刷新</p> 
<p><strong>pom.xml</strong><br> <strong>user-service</strong> 的 pom.xml 中添加 actuator 依赖</p> 
<pre><code class="prism language-yaml">&lt;dependency<span class="token punctuation">&gt;</span>
	&lt;groupId<span class="token punctuation">&gt;</span>org.springframework.boot&lt;/groupId<span class="token punctuation">&gt;</span>
	&lt;artifactId<span class="token punctuation">&gt;</span>spring<span class="token punctuation">-</span>boot<span class="token punctuation">-</span>starter<span class="token punctuation">-</span>actuator&lt;/artifactId<span class="token punctuation">&gt;</span>
&lt;/dependency<span class="token punctuation">&gt;</span>
</code></pre> 
<p><strong>yml 配置文件中暴露 refresh 端点</strong></p> 
<p>修改 github 仓库中的 user-service-dev.yml</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">sp</span><span class="token punctuation">:</span>
  <span class="token key atrule">user-service</span><span class="token punctuation">:</span>
    <span class="token key atrule">users</span><span class="token punctuation">:</span> <span class="token string">"[{\"id\":7, \"username\":\"abc\",\"password\":\"123\"},{\"id\":8, \"username\":\"def\",\"password\":\"456\"},{\"id\":9, \"username\":\"ghi\",\"password\":\"789\"}]"</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service
    
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8101</span>
  
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2002/eureka

<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> refresh
</code></pre> 
<p><strong>重启服务，查看暴露的刷新端点</strong><br> 查看暴露的刷新端点<br> http://localhost:8101/actuator<br> <img src="https://images2.imgbox.com/ba/07/pd2ceNbc_o.png" alt="在这里插入图片描述"><strong>UserServiceImpl 添加 @RefreshScope 注解</strong></p> 
<p>只允许对添加了 <strong>@RefreshScope</strong> 或 <strong>@ConfigurationProperties</strong> 注解的 Bean 刷新配置，可以将更新的配置数据注入到 Bean 中</p> 
<p><img src="https://images2.imgbox.com/3b/c1/8m1cCK04_o.png" alt="在这里插入图片描述"></p> 
<p><strong>先启动 user-service，再修改 config项目的user-service-dev.yml文件并提交</strong><br> 在末尾新添加一个用户id为99 的数据</p> 
<pre><code class="prism language-yaml"><span class="token comment"># 在末尾添加了一个新的用户数据</span>
<span class="token key atrule">sp</span><span class="token punctuation">:</span>
  <span class="token key atrule">user-service</span><span class="token punctuation">:</span>
    <span class="token key atrule">users</span><span class="token punctuation">:</span> <span class="token string">"[{\"id\":7, \"username\":\"abc\",\"password\":\"123\"},{\"id\":8, \"username\":\"def\",\"password\":\"456\"},{\"id\":9, \"username\":\"ghi\",\"password\":\"789\"},{\"id\":99, \"username\":\"aaa\",\"password\":\"111\"}]"</span>
</code></pre> 
<p><strong><mark>改完了，别忘了提交和同步到GitHub上。或者直接在GitHub上修改。</mark></strong></p> 
<p><strong>访问刷新端点刷新配置</strong></p> 
<p><mark>修改完配置文件，下一步就要刷新一下</mark></p> 
<p>刷新端点路径：<br> http://localhost:8101/actuator/refresh<br> 使用 postman 向刷新端点发送 post 请求，可以看到它能检测到你修改的信息<br> <img src="https://images2.imgbox.com/78/fd/BmqdrXWw_o.png" alt="在这里插入图片描述"><br> 那我们访问 user-service，查看动态更新的新用户数据<br> http://localhost:8101/99</p> 
<p><img src="https://images2.imgbox.com/ad/98/cTYUamrX_o.png" alt="在这里插入图片描述"><br> 再次修改，我们吧密码改为333<br> 重新刷新一下<br> 再次访问这个用户，可以看到信息已经加载了。<br> <img src="https://images2.imgbox.com/09/e4/X9YKT8xr_o.png" alt="在这里插入图片描述"><br> 那这里会产生一个疑问 ，上面只改了user的配置文件，进行了手动刷新，那若所有的项目的配置文件都需要刷新呢？难道每个项目都得自己手动挨个去刷新吗？有没有一种方式，只需要一个命令就可以实现所有的服务自动刷新各自的配置呢？</p> 
<p>既然这么问了，当然是有，下面的消息总线Bus就可以实现</p> 
<h2><a id="9_Spring_Cloud_Bus_3949"></a>9. Spring Cloud Bus</h2> 
<p><strong>定义</strong>：用于将服务和服务实例与分布式消息系统链接在一起的事件总线。在集群中传播状态更改很有用（例如配置更改事件）。</p> 
<p>简单理解为Spring Cloud Bus的作用就是管理和广播分布式系统中的消息，也就是消息引擎系统中的广播模式。当然作为消息总线的Spring Cloud Bus可以做很多事而不仅仅是客户端的配置刷新功能。</p> 
<p>而拥有了Spring Cloud Bus之后，我们只需要创建一个简单的请求，并且加上@ResfreshScope注解就能进行配置的动态修改了，下面我画了张图供你理解。</p> 
<p><img src="https://images2.imgbox.com/b3/23/itGO34X1_o.png" alt="在这里插入图片描述"><br> Spring Cloud Bus做配置更新的步骤:</p> 
<ol><li>提交配置文件触发post并给config server发送bus/refresh</li><li>config server接收到请求从git端更新配置并且发送给 Bus</li><li>bus接到消息并通知给其它客户端</li><li>其它客户端接收到通知，请求Server端获取最新配置</li><li>全部客户端均获取到最新的配置</li></ol> 
<h3><a id="config_bus__rabbitmq__3964"></a>config bus + rabbitmq 消息总线配置刷新</h3> 
<p>Spring Cloud Bus 的一个核心思想是通过分布式的启动器对 Spring Boot 应用进行扩展，也可以用来建立一个或多个应用之间的通信频道。目前唯一实现的方式是用 AMQP 消息代理作为通道，但是相同的基本功能集（还有一些取决于传输）在其他传输的路线图上</p> 
<p>这里说一下消息代理的概念</p> 
<p>消息代理（Message Broker）是一种消息验证、传输、路由的架构模式。消息代理是一个中间件产品，它的核心是一个消息的路由程序，用来实现接收和分发消息，并根据设定好的消息处理流来转发给正确的应用。它包括独立的通信和消息传递协议，能够实现组织内部和组织间的网络通信。设计代理的目的就是为了能够从应用程序中传入消息，并执行一些特别的操作。</p> 
<p>现有的消息代理开源产品：</p> 
<ul><li>ActiveMQ</li><li>Kafka</li><li>RabbitMQ</li><li>RocketMQ</li></ul> 
<p>目前Spring Cloud Bus 支持 RabbitMQ 和 Kafka，spring-cloud-starter-bus-amqp 、spring-cloud-starter-bus-kafka</p> 
<p>这里我用的是<strong>RabbitMQ</strong></p> 
<p>对于这个消息组件我们在另一篇文章详细讲解。<br> <a href="https://blog.csdn.net/qq_37216403/article/details/106472737">https://blog.csdn.net/qq_37216403/article/details/106472737</a></p> 
<p>当你看完rabbitMQ的相关技术知识后，对其有利一定的认识，那我们就开始操作如何使用rabbitMQ+bus进行动态更配置</p> 
<p>开始</p> 
<p><strong>需要动态更新配置的微服务，添加 spring cloud bus 依赖，并添加 rabbitmq 连接信息</strong><br> 修改以下微服务</p> 
<ul><li>item-service</li><li>user-service</li><li>order-service</li><li>zuul</li></ul> 
<p><strong>pom.xml 添加 spring cloud bus 依赖</strong></p> 
<pre><code class="prism language-powershell">&lt;dependency&gt;
    &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
    &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>bus<span class="token operator">-</span>amqp&lt;<span class="token operator">/</span>artifactId&gt;
    &lt;version&gt;2<span class="token punctuation">.</span>1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>RELEASE&lt;<span class="token operator">/</span>version&gt;
&lt;<span class="token operator">/</span>dependency&gt;
</code></pre> 
<p><strong>配置文件中添加 rabbitmq 连接信息</strong></p> 
<ol><li><strong>将GitHub上的config项目中每个配置文件进行修改修改,并提交到github</strong></li><li><strong>连接信息请修改成你的连接信息</strong></li></ol> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token punctuation">...</span><span class="token punctuation">...</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.180.161
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">password</span><span class="token punctuation">:</span> admin
</code></pre> 
<p><strong>sp-config项目配置rabbitmq连接信息，并暴露 bus-refresh 监控端点</strong></p> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-yaml">
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>server

  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/lmy1965673628/sp<span class="token punctuation">-</span>config
          <span class="token key atrule">searchPaths</span><span class="token punctuation">:</span> config
          <span class="token key atrule">username</span><span class="token punctuation">:</span> lmy1965673628
          <span class="token key atrule">password</span><span class="token punctuation">:</span> yang1965673628
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.180.161
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">password</span><span class="token punctuation">:</span> admin
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6001</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka

<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> bus<span class="token punctuation">-</span>refresh
</code></pre> 
<p>查看刷新端点<br> <a href="http://localhost:6001/actuator" rel="nofollow">http://localhost:6001/actuator</a><br> <img src="https://images2.imgbox.com/52/5b/mbULo5m2_o.png" alt="在这里插入图片描述"><br> <strong>启动服务，请求刷新端点发布刷新消息，测试一下看是否成功</strong>,<mark>每个服务启动一个就可以</mark></p> 
<p><img src="https://images2.imgbox.com/46/2b/cGkNmMPY_o.png" alt="在这里插入图片描述"></p> 
<p>再去修改GitHub的config项目，去改变用户id为<code>99</code>的值，然后提交并上传<br> <img src="https://images2.imgbox.com/65/5d/ujb66l4P_o.png" alt="在这里插入图片描述"></p> 
<p><strong>我们使用postman，去发送一个消息</strong><br> 向 bus-refresh 刷新端点发送 post 请求<br> <a href="http://localhost:6001/actuator/bus-refresh" rel="nofollow">http://localhost:6001/actuator/bus-refresh</a></p> 
<p><img src="https://images2.imgbox.com/0a/d7/AtDFHRrk_o.png" alt="在这里插入图片描述">返回没有信息，说明没啥问题，<br> 再去看看信息是否变化</p> 
<p>http://localhost:8101/99</p> 
<p><img src="https://images2.imgbox.com/77/9d/zVUL93CD_o.png" alt="在这里插入图片描述"><br> 再去改变值，把密码改成随机的，<mark>切记一定上传到GitHub上</mark></p> 
<p><img src="https://images2.imgbox.com/3d/97/2LOOdRMI_o.png" alt="在这里插入图片描述"><br> 可以看到确实成功了<br> <img src="https://images2.imgbox.com/a2/19/VxMROj7K_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="config__4082"></a>config 本地文系统</h3> 
<p>有的伙伴不想用GitHub，觉得GitHub连接有延迟，那还有一种方式，就是<strong>本地配置</strong></p> 
<p><strong>把配置文件保存到 sp12-config 项目的 resources/config 目录下</strong><br> <img src="https://images2.imgbox.com/b9/8f/cHoLZvW3_o.png" alt="在这里插入图片描述"><br> 修改 application.yml 激活 native profile，并指定配置文件目录</p> 
<ul><li>必须配置 <code>spring.profiles.active=native</code> 来激活本地文件系统</li><li>本地路径默认：[<code>classpath:/, classpath:/config, file:./, file:./config</code>]</li></ul> 
<pre><code class="prism language-yaml">
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>server
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> native

  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">native</span><span class="token punctuation">:</span>
          <span class="token key atrule">search-locations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>/config
<span class="token comment">#  cloud:</span>
<span class="token comment">#    config:</span>
<span class="token comment">#      server:</span>
<span class="token comment">#        git:</span>
<span class="token comment">#          uri: https://github.com/lmy1965673628/sp-config</span>
<span class="token comment">#          searchPaths: config</span>
<span class="token comment">#          username: lmy1965673628</span>
<span class="token comment">#          password: yang1965673628</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.180.161
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">password</span><span class="token punctuation">:</span> admin
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6001</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka1<span class="token punctuation">:</span>2001/eureka<span class="token punctuation">,</span> http<span class="token punctuation">:</span>//eureka2<span class="token punctuation">:</span>2002/eureka

<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> bus<span class="token punctuation">-</span>refresh
</code></pre> 
<p>先重启sp-config服务，再重启user-service 服务。<br> 去检验一下本地文系统是否好使</p> 
<p>先看目前的user信息<br> <a href="http://localhost:8101/99" rel="nofollow">http://localhost:8101/99</a><br> <img src="https://images2.imgbox.com/cd/1f/YrTF96wo_o.png" alt="在这里插入图片描述"><br> 去修改一下密码为6666</p> 
<p>去发送消息<br> <img src="https://images2.imgbox.com/a3/49/zC6eiYU7_o.png" alt="在这里插入图片描述"></p> 
<p>刷新页面<br> <img src="https://images2.imgbox.com/6f/fd/XwJPhzHa_o.png" alt="在这里插入图片描述"><br> <strong>大功告成！！！！</strong></p> 
<h2><a id="10sleuth__4146"></a>10.sleuth 链路跟踪</h2> 
<p>随着系统规模越来越大，微服务之间调用关系变得错综复杂，一条调用链路中可能调用多个微服务，任何一个微服务不可用都可能造整个调用过程失败</p> 
<p><strong>spring cloud sleuth</strong> 可以跟踪调用链路，分析链路中每个节点的执行情况</p> 
<p><strong>微服务中添加 spring cloud sleuth 依赖</strong><br> 修改以下微服务的 pom.xml，添加 sleuth 依赖</p> 
<ul><li>item-service</li><li>user-service</li><li>order-service</li><li>zuul</li></ul> 
<pre><code class="prism language-powershell">&lt;dependency&gt;
	&lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
	&lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>sleuth&lt;<span class="token operator">/</span>artifactId&gt;
	&lt;version&gt;2<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>RELEASE&lt;<span class="token operator">/</span>version&gt;
&lt;<span class="token operator">/</span>dependency&gt;
</code></pre> 
<p><strong>在控制台查看链路跟踪日志</strong><br> 启动服务，config服务要先启动<br> <img src="https://images2.imgbox.com/68/84/cCWhhoSx_o.png" alt="在这里插入图片描述"><br> <strong>通过 zuul 网关，访问 order-service</strong><br> <a href="http://localhost:3001/order-service/112233" rel="nofollow">http://localhost:3001/order-service/112233</a></p> 
<p>四个微服务的控制台日志中，可以看到以下信息：<br> <mark>[服务id,请求id,span id,是否发送到zipkin]</mark></p> 
<ul><li>请求id：请求到达第一个微服务时生成一个请求id，该id在调用链路中会一直向后面的微服务传递</li><li>span id：链路中每一步微服务调用，都生成一个新的id</li></ul> 
<p><img src="https://images2.imgbox.com/ae/02/a0GHLR1I_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="11sleuth__zipkin__4179"></a>11.sleuth + zipkin 链路分析</h2> 
<p>zipkin 可以收集链路跟踪数据，提供可视化的链路分析</p> 
<p><strong>链路数据抽样比例</strong></p> 
<p>默认 10% 的链路数据会被发送到 zipkin 服务。可以配置修改抽样比例</p> 
<p><strong>修改user-service,order-service,item-service的配置文件</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">zipkin</span><span class="token punctuation">:</span>
    <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>9411/
    <span class="token key atrule">sender</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> web
<span class="token comment"># 可以指定监控数据的采样率</span>
  <span class="token key atrule">sleuth</span><span class="token punctuation">:</span>
    <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
      <span class="token key atrule">probability</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre> 
<p><strong>zipkin 服务下载</strong></p> 
<ol><li>GitHub ： <a href="https://github.com/openzipkin/zipkin">https://github.com/openzipkin/zipkin</a></li><li>直接下载jar包：<a href="https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/" rel="nofollow">https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/</a></li><li>docker ：</li></ol> 
<pre><code class="prism language-shell">docker run -d -p <span class="token number">9411</span>:9411 openzipkin/zipkin
</code></pre> 
<ol start="4"><li>linux : <code>curl -sSL https://zipkin.io/quickstart.sh | bash -s</code></li></ol> 
<p>我采用了第二种方式，直接在本地使用 ，直接使用<code>java -jar</code> 命令运行即可<br> <img src="https://images2.imgbox.com/fb/2e/4Y8TzxQk_o.png" alt="在这里插入图片描述"><a href="http://localhost:9411/zipkin" rel="nofollow">http://localhost:9411/zipkin</a><br> <img src="https://images2.imgbox.com/b3/e1/eCeO2Tqo_o.png" alt="在这里插入图片描述"><strong>微服务添加 zipkin 起步依赖</strong></p> 
<p>修改以下微服务</p> 
<ul><li>item-service</li><li>user-service</li><li>order-service</li><li>zuul</li></ul> 
<pre><code class="prism language-powershell">&lt;dependency&gt;
   &lt;groupId&gt;org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud&lt;<span class="token operator">/</span>groupId&gt;
   &lt;artifactId&gt;spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>zipkin&lt;<span class="token operator">/</span>artifactId&gt;
   &lt;version&gt;2<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>RELEASE&lt;<span class="token operator">/</span>version&gt;
&lt;<span class="token operator">/</span>dependency&gt;
</code></pre> 
<p><mark>如果没有配置过 spring cloud bus，需要再添加 spring-cloud-starter-stream-rabbit 依赖和 rabbitmq 连接信息</mark></p> 
<p><strong>启动并访问服务，访问 zipkin 查看链路分析</strong></p> 
<ol><li><a href="http://localhost:3001/order-service/112233" rel="nofollow">http://localhost:3001/order-service/112233</a><br> 刷新访问多次，链路跟踪数据中，默认只有 10% 会被收集到zipkin，但上面我修改了成100%</li></ol> 
<p>当访问成功的时候，看一下控制台，可以看到最后一个参数是<code>true</code>，则表示<strong>发送到zipkin</strong></p> 
<p><img src="https://images2.imgbox.com/f9/e9/id3Z7e04_o.png" alt="在这里插入图片描述"></p> 
<ol start="2"><li>访问 zipkin<br> <a href="http://localhost:9411/zipkin" rel="nofollow">http://localhost:9411/zipkin</a><br> 点击查找<br> <img src="https://images2.imgbox.com/cd/3a/LUnvpTzy_o.png" alt="在这里插入图片描述"></li></ol> 
<p>点击其中一个，查看详情<br> <img src="https://images2.imgbox.com/4c/21/GS5P3E1g_o.png" alt="在这里插入图片描述">可以看到每一个链路的整个过程都被记录，再点击其中一个还可以具体的详情内容，包含时间，接口的相关数据等信息<br> <img src="https://images2.imgbox.com/81/9d/ISapr5SW_o.png" alt="在这里插入图片描述">我们点击导航栏可以看到整个链路的依赖<br> <img src="https://images2.imgbox.com/17/1d/ueUNzdGK_o.png" alt="在这里插入图片描述"><br> 说明一下：zipkin的数据存储有很多种方式，但我只是用于测试，所以没采用存储方式，一旦服务关闭，数据就会丢失。关于更多zipkin的相关信息可自行查阅相关资料。我后期也会逐渐加入相关案例</p> 
<h2><a id="_4249"></a>总结</h2> 
<p>至此，springcloud的10个组件已全部介绍完，相关demo也已上传我的GitHub仓库，各位可以进行下载进行参考</p> 
<p>总结一下：<br> <strong>spring cloud 技术组成</strong></p> 
<ul><li> <p>eureka<br> 微服务治理，服务注册和发现</p> </li><li> <p>ribbon<br> 负载均衡、请求重试</p> </li><li> <p>hystrix<br> 断路器，服务降级、熔断</p> </li><li> <p>feign<br> ribbon + hystrix 集成，并提供生命式客户端</p> </li><li> <p>hystrix dashboard 和 turbine<br> hystrix 微服务监控</p> </li><li> <p>zuul<br> API 网关，提供微服务的统一入口，并提供统一的权限验证</p> </li><li> <p>config<br> 配置中心</p> </li><li> <p>bus<br> 消息总线, 配置刷新</p> </li><li> <p>sleuth+zipkin<br> 链路跟踪</p> </li></ul> 
<h2><a id="githubhttpsgithubcomlmy1965673628spdemogithttpsgithubcomlmy1965673628spdemogit_4283"></a>github地址：<a href="https://github.com/lmy1965673628/sp-demo.git">https://github.com/lmy1965673628/sp-demo.git</a></h2> 
<h2><a id="cenos7httpspanbaiducoms1ioduPYTecZXH143S_5wUzAhttpspanbaiducoms1ioduPYTecZXH143S_5wUzA__qhhd_4284"></a>cenos7镜像，链接：<a href="https://pan.baidu.com/s/1ioduPYTecZXH143S_5wUzA" rel="nofollow">https://pan.baidu.com/s/1ioduPYTecZXH143S_5wUzA</a> 提取码：qhhd</h2>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/93eb745d5319089869c641e25b5421bb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">windows 启动jupyter 提示 cannot import name AsyncGenerator</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3654f1a17492fa12923fe51939bf1694/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Recoil - Facebook 官方 React 状态管理器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>