<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Django入门教程 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Django入门教程" />
<meta property="og:description" content="1.简介 Django是一个免费、开源的Python web框架，解决了web开发的许多麻烦，使开发者可以专注于编写应用而无需重复造轮子。
网站：https://www.djangoproject.com/官方文档：https://docs.djangoproject.com/源代码：https://docs.djangoproject.com/ 2.安装 使用pip安装最新版本的Django：
pip install django 也可以手动指定版本：
pip install django==3.2 Django支持的Python版本见What Python version can I use with Django?
安装完成后，可以在命令行使用django-admin辅助工具：
$ django-admin --version 3.2.11 3.入门教程 官方教程介绍了如何创建一个简单的投票应用：Writing your first Django app
该应用由两部分组成：
一个公共站点，用户可以查看问题并投票。一个管理站点，管理员可以添加、修改和删除问题。 完整代码：https://github.com/ZZy979/DjangoTutorial
3.1 第1部分：创建项目和应用 3.1.1 创建项目 在命令行中执行以下命令：
django-admin startproject mysite 该命令创建了一个名为mysite的项目(project)，目录结构如下：
mysite/ manage.py mysite/ __init__.py settings.py urls.py asgi.py wsgi.py 外层mysite目录：项目根目录，可以放在任何位置，也可以任意重命名。manage.py：Django命令行工具，详见django-admin and manage.py。内层mysite目录：项目的Python包，用于导入模块（例如mysite.urls）。mysite/__init__.py：空文件，告诉Python该目录是一个Python包。mysite/settings.py：设置/配置，详见Django settings。mysite/urls.py：URL声明，相当于网站的“目录”，详见URL dispatcher。mysite/asgi.py：ASGI web服务器的入口，详见How to deploy with ASGI。mysite/wsgi.py：WSGI web服务器的入口，详见How to deploy with WSGI。 在项目根目录下执行以下命令：
python manage." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/dae2455ed02293e54dcfa0e5689c3d45/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-04T17:56:20+08:00" />
<meta property="article:modified_time" content="2023-03-04T17:56:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Django入门教程</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_0"></a>1.简介</h2> 
<p>Django是一个免费、开源的Python web框架，解决了web开发的许多麻烦，使开发者可以专注于编写应用而无需重复造轮子。</p> 
<ul><li>网站：<a href="https://www.djangoproject.com/" rel="nofollow">https://www.djangoproject.com/</a></li><li>官方文档：<a href="https://docs.djangoproject.com/" rel="nofollow">https://docs.djangoproject.com/</a></li><li>源代码：<a href="https://docs.djangoproject.com/" rel="nofollow">https://docs.djangoproject.com/</a></li></ul> 
<h2><a id="2_7"></a>2.安装</h2> 
<p>使用pip安装最新版本的Django：</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> django
</code></pre> 
<p>也可以手动指定版本：</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> <span class="token assign-left variable">django</span><span class="token operator">==</span><span class="token number">3.2</span>
</code></pre> 
<p>Django支持的Python版本见<a href="https://docs.djangoproject.com/en/stable/faq/install/#faq-python-version-support" rel="nofollow">What Python version can I use with Django?</a></p> 
<p>安装完成后，可以在命令行使用<code>django-admin</code>辅助工具：</p> 
<pre><code class="prism language-cpp">$ django<span class="token operator">-</span>admin <span class="token operator">--</span>version
<span class="token number">3.2</span><span class="token punctuation">.</span><span class="token number">11</span>
</code></pre> 
<h2><a id="3_29"></a>3.入门教程</h2> 
<p>官方教程介绍了如何创建一个简单的投票应用：<a href="https://docs.djangoproject.com/en/stable/intro/tutorial01/" rel="nofollow">Writing your first Django app</a></p> 
<p>该应用由两部分组成：</p> 
<ul><li>一个公共站点，用户可以查看问题并投票。</li><li>一个管理站点，管理员可以添加、修改和删除问题。</li></ul> 
<p>完整代码：<a href="https://github.com/ZZy979/DjangoTutorial">https://github.com/ZZy979/DjangoTutorial</a></p> 
<h3><a id="31_1_38"></a>3.1 第1部分：创建项目和应用</h3> 
<h4><a id="311__39"></a>3.1.1 创建项目</h4> 
<p>在命令行中执行以下命令：</p> 
<pre><code class="prism language-bash">django-admin startproject mysite
</code></pre> 
<p>该命令创建了一个名为mysite的<strong>项目</strong>(project)，目录结构如下：</p> 
<pre><code>mysite/
    manage.py
    mysite/
        __init__.py
        settings.py
        urls.py
        asgi.py
        wsgi.py
</code></pre> 
<ul><li>外层mysite目录：项目根目录，可以放在任何位置，也可以任意重命名。</li><li>manage.py：Django命令行工具，详见<a href="https://docs.djangoproject.com/en/stable/ref/django-admin/" rel="nofollow">django-admin and manage.py</a>。</li><li>内层mysite目录：项目的Python包，用于导入模块（例如<code>mysite.urls</code>）。</li><li>mysite/__init__.py：空文件，告诉Python该目录是一个Python包。</li><li>mysite/settings.py：设置/配置，详见<a href="https://docs.djangoproject.com/en/stable/topics/settings/" rel="nofollow">Django settings</a>。</li><li>mysite/urls.py：URL声明，相当于网站的“目录”，详见<a href="https://docs.djangoproject.com/en/stable/topics/http/urls/" rel="nofollow">URL dispatcher</a>。</li><li>mysite/asgi.py：ASGI web服务器的入口，详见<a href="https://docs.djangoproject.com/en/stable/howto/deployment/asgi/" rel="nofollow">How to deploy with ASGI</a>。</li><li>mysite/wsgi.py：WSGI web服务器的入口，详见<a href="https://docs.djangoproject.com/en/stable/howto/deployment/wsgi/" rel="nofollow">How to deploy with WSGI</a>。</li></ul> 
<p>在项目根目录下执行以下命令：</p> 
<pre><code class="prism language-bash">python manage.py runserver
</code></pre> 
<p>该命令启动了Django内置的web服务器（开发服务器）。在浏览器中访问 <a href="http://127.0.0.1:8000/" rel="nofollow">http://127.0.0.1:8000/</a>，将会看到Congratulations页面：</p> 
<p><img src="https://images2.imgbox.com/2a/d8/P2Yr5mpc_o.png" alt="Congratulations"></p> 
<p>默认情况下，<code>runserver</code>命令在内部IP地址127.0.0.1、8000端口号启动web服务器。要改变端口号，可以通过命令行参数指定：</p> 
<pre><code class="prism language-cpp">python manage<span class="token punctuation">.</span>py runserver <span class="token number">8080</span>
</code></pre> 
<p>要监听所有公共IP，则执行</p> 
<pre><code class="prism language-bash">python manage.py runserver <span class="token number">0.0</span>.0.0:8000
</code></pre> 
<p>Django的开发服务器会自动重新加载Python代码，因此修改代码后无需重启服务器。</p> 
<h4><a id="312__92"></a>3.1.2 创建投票应用</h4> 
<p>有了项目之后就可以开始编写应用了。<strong>应用</strong>(application/app)就是一个遵循特定约定的Python包。</p> 
<p>注：Django项目和应用的区别：应用是一个具体的web应用，例如博客应用、投票应用等。项目是一个特定网站的配置和应用的集合。一个项目可以包含多个应用，一个应用也可以属于多个项目。</p> 
<p>应用可以位于<a href="https://docs.python.org/3/tutorial/modules.html#tut-searchpath" rel="nofollow">Python path</a>的任何路径。在本教程中，将投票应用创建在项目根目录下。在项目根目录下执行以下命令：</p> 
<pre><code class="prism language-bash">python manage.py startapp polls
</code></pre> 
<p>该命令创建了一个名为polls的应用，目录结构如下：</p> 
<pre><code>polls/
    __init__.py
    admin.py
    apps.py
    migrations/
        __init__.py
    models.py
    tests.py
    views.py
</code></pre> 
<h4><a id="313__117"></a>3.1.3 编写第一个视图</h4> 
<p>打开文件polls/views.py，编写以下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse


<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"Hello, world. You're at the polls index."</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里创建了一个名为<code>index</code>的<strong>视图</strong>(view)。为了调用该视图，需要一个映射到它的URL，即<strong>URL配置</strong>(URLconf)。</p> 
<p>为了创建URLconf，在polls目录下创建一个文件urls.py，内容如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path

<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>之后在项目根目录下的urls.py中的<code>urlpatterns</code>增加一个<code>include()</code>：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> include

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'polls/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'polls.urls'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>其中，<a href="https://docs.djangoproject.com/en/stable/ref/urls/#django.urls.include" rel="nofollow">include()</a>函数引用另一个URLConf，表示所有以 “polls/” 开头的URL都由<code>polls.urls</code>（即polls/urls.py）处理。</p> 
<p>现在已经将<code>index()</code>视图关联到了URLconf。下面使用<code>runserver</code>命令启动服务器，并在浏览器中访问 <a href="http://localhost:8000/polls/" rel="nofollow">http://localhost:8000/polls/</a>，将会看到<code>index</code>视图返回的文本 “Hello, world. You’re at the polls index.”，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/42/77/o87tDu9d_o.png" alt="index视图"></p> 
<h4><a id="314_path_160"></a>3.1.4 path()函数</h4> 
<p><a href="https://docs.djangoproject.com/en/stable/ref/urls/#django.urls.path" rel="nofollow">path()</a>函数用于指定URL模式到视图的映射，接受4个参数：</p> 
<ul><li><code>route</code>：指定URL模式，不包括域名、GET和POST参数，可使用<code>&lt;type:name&gt;</code>定义路径参数，没有必要在结尾加 “.html” 
  <ul><li>注意：若URL模式中最后有 “/” 而请求的URL最后没有 “/” 则会返回301（浏览器会自动在最后添加 “/”）；若URL模式中最后没有 “/” 而请求的URL最后有 “/” 则会返回404</li></ul> </li><li><code>view</code>：匹配到URL模式时调用的视图，调用时以一个<code>HttpRequest</code>对象作为第一个参数，捕获的路径参数作为关键字参数</li><li><code>kwargs</code>：任意关键字参数，用于传递给视图函数</li><li><code>name</code>：URL模式的名称</li></ul> 
<h3><a id="32_2admin_168"></a>3.2 第2部分：模型和admin应用</h3> 
<h4><a id="321__169"></a>3.2.1 数据库配置</h4> 
<p>settings.py中的<code>DATABASES</code>是数据库配置，默认的数据库引擎是SQLite。这里使用自动生成的默认配置即可：</p> 
<pre><code class="prism language-python">DATABASES <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'ENGINE'</span><span class="token punctuation">:</span> <span class="token string">'django.db.backends.sqlite3'</span><span class="token punctuation">,</span>
        <span class="token string">'NAME'</span><span class="token punctuation">:</span> BASE_DIR <span class="token operator">/</span> <span class="token string">'db.sqlite3'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>另外，将<code>TIME_ZONE</code>修改为合适的时区（例如 “Asia/Shanghai”）。</p> 
<h4><a id="322__183"></a>3.2.2 创建模型</h4> 
<p>接下来要定义模型。<strong>模型</strong>(model)是应用中的数据源，对应数据库表。每个模型由若干<strong>字段</strong>(field)组成，对应数据库字段。</p> 
<p>在投票应用中需要创建两个模型：<code>Question</code>和<code>Choice</code>。<code>Question</code>有两个字段：问题文本和发布日期；<code>Choice</code>也有两个字段：选项文本和票数。每个<code>Choice</code>关联到一个<code>Question</code>。</p> 
<p>在polls/models.py中创建模型类：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> datetime

<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models
<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone


<span class="token keyword">class</span> <span class="token class-name">Question</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    question_text <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>
    pub_date <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span><span class="token string">'date published'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>question_text

    <span class="token keyword">def</span> <span class="token function">was_published_recently</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        now <span class="token operator">=</span> timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>pub_date <span class="token operator">&gt;=</span> now <span class="token operator">-</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Choice</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    question <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>Question<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span>
    choice_text <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>
    votes <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>choice_text
</code></pre> 
<p>注：<code>__str__()</code>方法用于以人类可读的方式展示对象，模型也可以有自定义方法（例如<code>was_published_recently()</code>）。</p> 
<p>每个模型由<code>django.db.models.Model</code>的一个子类表示。每个模型有若干类变量，表示数据库字段。</p> 
<p>每个字段由<code>Field</code>类的子类实例表示，例如<code>CharField</code>表示文本字段，<code>DateTimeField</code>表示日期时间字段。数据库将使用字段名称（例如<code>question_text</code>和<code>pub_date</code>）作为列名。</p> 
<p>可以使用<code>Field</code>的第一个位置参数指定一个人类可读的名字。例如，<code>Question.pub_date</code>字段指定了人类可读的名字<code>date published</code>。</p> 
<p><code>CharField</code>必须用<code>max_length</code>参数指定最大长度。另外，<code>Field</code>还有很多可选参数，例如<code>default</code>指定默认值。</p> 
<p>注：如果没有指定主键(<code>PrimaryKey</code>)，则Django会自动生成一个名为<code>id</code>的自增主键字段。</p> 
<p><code>ForeignKey</code>用于定义外键。<code>Choice.question</code>字段告诉Django：<code>Choice</code>与<code>Question</code>是多对一的关系。Django支持所有常见的数据库关系：多对一、多对多和一对一。</p> 
<h4><a id="323__232"></a>3.2.3 激活模型</h4> 
<p>根据模型的定义，Django能够使用<code>CREATE TABLE</code>语句创建数据库表，以及创建数据库查询API。</p> 
<p>首先，需要先将polls应用安装到mysite项目。在settings.py的<code>INSTALLED_APPS</code>中添加<code>'polls.apps.PollsConfig'</code>或者<code>'polls'</code>：</p> 
<pre><code class="prism language-python">INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.contrib.admin'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.contenttypes'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.staticfiles'</span><span class="token punctuation">,</span>
    <span class="token string">'polls.apps.PollsConfig'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>之后执行以下命令：</p> 
<pre><code class="prism language-bash">python manage.py makemigrations polls
</code></pre> 
<p><code>makemigrations</code>命令根据模型定义的变化（新增、删除、修改字段等）创建<strong>migration</strong>，生成在polls/migrations目录下。</p> 
<p>可以使用<code>sqlmigrate</code>命令查看migration对应的SQL语句：</p> 
<pre><code class="prism language-bash">$ python manage.py sqlmigrate polls 0001
BEGIN<span class="token punctuation">;</span>
--
-- Create model Question
--
CREATE TABLE <span class="token string">"polls_question"</span> <span class="token punctuation">(</span><span class="token string">"id"</span> integer NOT NULL PRIMARY KEY AUTOINCREMENT, <span class="token string">"question_text"</span> varchar<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> NOT NULL, <span class="token string">"pub_date"</span> datetime NOT NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">..</span>.
COMMIT<span class="token punctuation">;</span>
</code></pre> 
<p>接下来执行<code>migrate</code>命令，将更改应用到数据库：</p> 
<pre><code class="prism language-bash">python manage.py migrate
</code></pre> 
<p>Django将自动记录已经执行过的migration编号。</p> 
<p><strong>修改模型的三个步骤</strong>：</p> 
<ul><li>修改models.py中的模型定义</li><li>运行<code>python manage.py makemigrations</code>，为更改创建migration</li><li>运行<code>python manage.py migrate</code>，将更改应用到数据库</li></ul> 
<h4><a id="324_API_283"></a>3.2.4 查询API</h4> 
<p>现在可以在Python交互式窗口中尝试Django提供的数据库查询API。使用<code>shell</code>命令打开Python shell：</p> 
<pre><code class="prism language-bash">python manage.py shell
</code></pre> 
<p>该命令与直接执行<code>python</code>命令的区别是manage.py会读取settings.py，从而能够访问配置的数据库。</p> 
<p>现在可以使用数据库查询API进行增删改查：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> polls<span class="token punctuation">.</span>models <span class="token keyword">import</span> Choice<span class="token punctuation">,</span> Question

<span class="token comment"># No questions are in the system yet.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>

<span class="token comment"># Create a new Question.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q <span class="token operator">=</span> Question<span class="token punctuation">(</span>question_text<span class="token operator">=</span><span class="token string">"What's new?"</span><span class="token punctuation">,</span> pub_date<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Save the object into the database. You have to call save() explicitly.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Now it has an ID.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token number">1</span>

<span class="token comment"># Access model field values via Python attributes.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span>question_text
<span class="token string">"What's new?"</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span>pub_date
datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2012</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">775217</span><span class="token punctuation">,</span> tzinfo<span class="token operator">=</span>datetime<span class="token punctuation">.</span>timezone<span class="token punctuation">.</span>utc<span class="token punctuation">)</span>

<span class="token comment"># Change values by changing the attributes, then calling save().</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span>question_text <span class="token operator">=</span> <span class="token string">"What's up?"</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># objects.all() displays all the questions in the database.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token operator">&lt;</span>Question<span class="token punctuation">:</span> What's up?<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>

<span class="token comment"># Django provides a rich database lookup API that's entirely driven by</span>
<span class="token comment"># keyword arguments.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token operator">&lt;</span>Question<span class="token punctuation">:</span> What's up?<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>question_text__startswith<span class="token operator">=</span><span class="token string">'What'</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token operator">&lt;</span>Question<span class="token punctuation">:</span> What's up?<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>

<span class="token comment"># Get the question that was published this year.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> current_year <span class="token operator">=</span> timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>year
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pub_date__year<span class="token operator">=</span>current_year<span class="token punctuation">)</span>
<span class="token operator">&lt;</span>Question<span class="token punctuation">:</span> What's up?<span class="token operator">&gt;</span>

<span class="token comment"># Request an ID that doesn't exist, this will raise an exception.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
DoesNotExist<span class="token punctuation">:</span> Question matching query does <span class="token keyword">not</span> exist<span class="token punctuation">.</span>

<span class="token comment"># Lookup by a primary key is the most common case, so Django provides a</span>
<span class="token comment"># shortcut for primary-key exact lookups.</span>
<span class="token comment"># The following is identical to Question.objects.get(id=1).</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>Question<span class="token punctuation">:</span> What's up?<span class="token operator">&gt;</span>

<span class="token comment"># Make sure our custom method worked.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q <span class="token operator">=</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span>was_published_recently<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token boolean">True</span>

<span class="token comment"># Display any choices from the related object set -- none so far.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span>choice_set<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>

<span class="token comment"># Create three choices.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span>choice_set<span class="token punctuation">.</span>create<span class="token punctuation">(</span>choice_text<span class="token operator">=</span><span class="token string">'Not much'</span><span class="token punctuation">,</span> votes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>Choice<span class="token punctuation">:</span> Not much<span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span>choice_set<span class="token punctuation">.</span>create<span class="token punctuation">(</span>choice_text<span class="token operator">=</span><span class="token string">'The sky'</span><span class="token punctuation">,</span> votes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>Choice<span class="token punctuation">:</span> The sky<span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> c <span class="token operator">=</span> q<span class="token punctuation">.</span>choice_set<span class="token punctuation">.</span>create<span class="token punctuation">(</span>choice_text<span class="token operator">=</span><span class="token string">'Just hacking again'</span><span class="token punctuation">,</span> votes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment"># Choice objects have API access to their related Question objects.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> c<span class="token punctuation">.</span>question
<span class="token operator">&lt;</span>Question<span class="token punctuation">:</span> What's up?<span class="token operator">&gt;</span>

<span class="token comment"># And vice versa: Question objects get access to Choice objects.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span>choice_set<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token operator">&lt;</span>Choice<span class="token punctuation">:</span> Not much<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Choice<span class="token punctuation">:</span> The sky<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Choice<span class="token punctuation">:</span> Just hacking again<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> q<span class="token punctuation">.</span>choice_set<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">3</span>

<span class="token comment"># Find all Choices for any question whose pub_date is in this year</span>
<span class="token comment"># (reusing the 'current_year' variable we created above).</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Choice<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>question__pub_date__year<span class="token operator">=</span>current_year<span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token operator">&lt;</span>Choice<span class="token punctuation">:</span> Not much<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Choice<span class="token punctuation">:</span> The sky<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Choice<span class="token punctuation">:</span> Just hacking again<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>

<span class="token comment"># Let's delete one of the choices. Use delete() for that.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> c <span class="token operator">=</span> q<span class="token punctuation">.</span>choice_set<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>choice_text__startswith<span class="token operator">=</span><span class="token string">'Just hacking'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> c<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>数据库查询API的完整细节参考文档<a href="https://docs.djangoproject.com/en/stable/topics/db/queries/" rel="nofollow">Making queries</a>和<a href="https://docs.djangoproject.com/en/stable/ref/models/relations/" rel="nofollow">Related objects reference</a>。</p> 
<h4><a id="325_Django_admin_389"></a>3.2.5 Django admin应用简介</h4> 
<p>Django自带的admin应用为模型的增删改查提供了一个方便的界面。该应用是为网站管理者而不是用户提供的。</p> 
<p>首先创建一个可以登录到admin应用的用户。执行以下命令：</p> 
<pre><code class="prism language-bash">python manage.py createsuperuser
</code></pre> 
<p>输入用户名、邮箱和密码。</p> 
<p>之后使用<code>runserver</code>命令启动服务器，在浏览器中访问 <a href="http://127.0.0.1:8000/admin/" rel="nofollow">http://127.0.0.1:8000/admin/</a>，将会看到admin应用的登录界面：</p> 
<p><img src="https://images2.imgbox.com/a6/6e/Uus4wYp9_o.png" alt="admin应用登录界面"></p> 
<p>登录后即可看到admin首页：</p> 
<p><img src="https://images2.imgbox.com/ff/8e/eU06TeTj_o.png" alt="admin首页"></p> 
<p>可以看到目前只有两个可编辑的模型：用户<code>User</code>和用户组<code>Group</code>，它们是由用户认证应用<code>django.contrib.auth</code>提供的。</p> 
<p>为了使polls应用定义的模型展示在admin应用中，需要修改polls/admin.py，内容如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin

<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Question<span class="token punctuation">,</span> Choice

admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Question<span class="token punctuation">)</span>
admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Choice<span class="token punctuation">)</span>
</code></pre> 
<p>刷新页面，即可看到<code>Question</code>和<code>Choice</code>两个模型：</p> 
<p><img src="https://images2.imgbox.com/1a/ae/ZeRacfHq_o.png" alt="admin应用首页2"></p> 
<p>点击 “Questions”，即可展示该模型在数据库中的所有数据：</p> 
<p><img src="https://images2.imgbox.com/05/0b/almkfxPw_o.png" alt="列表界面"></p> 
<p>其中 “What’s up?” 就是<code>__str__()</code>方法返回的字符串。</p> 
<p>点击 “What’s up?”，即可打开编辑界面：</p> 
<p><img src="https://images2.imgbox.com/37/f1/BczGSf8o_o.png" alt="编辑界面"></p> 
<p>其中的表单是根据模型定义自动生成的，不同的模型字段类型对应适当的HTML输入组件。</p> 
<h3><a id="33_3_437"></a>3.3 第3部分：编写视图和模板</h3> 
<h4><a id="331__438"></a>3.3.1 概述</h4> 
<p><strong>视图</strong>(view)是Django应用中处理请求并返回特定web页面的函数或类。</p> 
<p>投票应用有以下视图：</p> 
<ul><li>问题列表视图<code>index</code>：展示最新的几个问题。</li><li>问题详情视图<code>detail</code>：展示问题文本、选项和投票表单。</li><li>投票结果视图<code>results</code>：展示特定问题的投票结果。</li><li>投票视图<code>vote</code>：处理一个特定问题、特定选项的投票动作。</li></ul> 
<p>Django会根据请求的URL路径（域名之后的部分）查找URLconf，并选择匹配的视图。</p> 
<h4><a id="332__449"></a>3.3.2 编写更多视图</h4> 
<p>在polls/view.py中增加几个视图。与<code>index()</code>不同的是，这几个视图接受一个参数。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> question_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"You're looking at question {}."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>question_id<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">results</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> question_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"You're looking at the results of question {}."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>question_id<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">vote</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> question_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"You're voting on question {}."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>question_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>之后在polls/urls.py中添加这些视图的URLconf：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path

<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># ex: /polls/</span>
    path<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># ex: /polls/5/</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:question_id&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>detail<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'detail'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># ex: /polls/5/results/</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:question_id&gt;/results/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>results<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'results'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># ex: /polls/5/vote/</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:question_id&gt;/vote/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>vote<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'vote'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>例如，在浏览器中访问 <a href="http://localhost:8000/polls/34/" rel="nofollow">http://localhost:8000/polls/34/</a> 时，请求的URL路径是 “/polls/34/”。Django首先会读取项目的根URLconf <code>mysite.urls</code>，匹配到 “polls/”，并将剩余部分 “34/” 交给<code>polls.urls</code>处理。之后匹配到URL模式<code>'&lt;int:question_id&gt;/'</code>，因此调用视图<code>detail(request, question_id=34)</code>，关键字参数<code>question_id=34</code>来自URL模式捕获的路径参数<code>&lt;int:question_id&gt;</code>，其中<code>int</code>表示参数类型，<code>question_id</code>对应参数名。</p> 
<h4><a id="333__486"></a>3.3.3 编写实际执行操作的视图</h4> 
<p>每个视图负责做两件事：返回一个<code>HttpResponse</code>对象，其中包含请求的页面内容（例如HTML页面）；或者产生一个异常（例如<code>Http404</code>）。其余是业务逻辑，例如访问数据库。</p> 
<p>下面修改<code>index()</code>视图，使其展示发布日期最新的5个问题。可以像这样查询最新的5个问题：</p> 
<pre><code class="prism language-python">Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-pub_date'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
</code></pre> 
<p>为了在HTML页面上展示查询结果，需要使用Django的<strong>模板系统</strong>(template system)。<strong>模板</strong>(template)是一种包含特殊占位符的HTML页面，用于根据视图返回的数据动态生成HTML页面。</p> 
<p>首先，在polls目录下创建一个templates目录，并在其中再创建一个polls目录。之后，在内层polls目录下创建一个名为index.html的文件，即polls/templates/polls/index.html。在代码中可以用<code>'polls/index.html'</code>引用该模板。</p> 
<p>注：在templates目录下再创建一个与应用同名的目录是为了避免不同应用中有相同名字的模板，相当于一种“命名空间”。</p> 
<p>模板文件的内容如下：</p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>polls index<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
{% if latest_question_list %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    {% for question in latest_question_list %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/polls/{<!-- -->{ question.id }}/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{ question.question_text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    {% endfor %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
{% else %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>No polls are available.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
{% endif %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>现在更新<code>index()</code>视图，使其使用该模板：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse
<span class="token keyword">from</span> django<span class="token punctuation">.</span>template <span class="token keyword">import</span> loader

<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Question


<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    latest_question_list <span class="token operator">=</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-pub_date'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
    template <span class="token operator">=</span> loader<span class="token punctuation">.</span>get_template<span class="token punctuation">(</span><span class="token string">'polls/index.html'</span><span class="token punctuation">)</span>
    context <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'latest_question_list'</span><span class="token punctuation">:</span> latest_question_list<span class="token punctuation">}</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span>template<span class="token punctuation">.</span>render<span class="token punctuation">(</span>context<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>注：<code>template.render()</code>返回一个字符串，内容是使用context渲染模板生成的HTML页面。</p> 
<p>该视图加载了名为polls/index.html的模板，并传递了一个context，即将模板变量映射到Python对象的字典。</p> 
<p>启动服务器，并在浏览器中访问 <a href="http://127.0.0.1:8000/polls/" rel="nofollow">http://127.0.0.1:8000/polls/</a>，将会看到一个包含之前创建的 “What’s up?” 问题的列表，点击标题将会跳转到详情页。</p> 
<p><img src="https://images2.imgbox.com/3e/ac/RuTE3Qyl_o.png" alt="问题列表"></p> 
<p><img src="https://images2.imgbox.com/5a/93/GUdseaJl_o.png" alt="问题详情页"></p> 
<h5><a id="3331_render_550"></a>3.3.3.1 捷径：render()</h5> 
<p>加载一个模板、填充context，并返回一个包含渲染结果的<code>HttpResponse</code>是一种非常常见的用法。因此Django提供了一个捷径：<code>render()</code>。下面是重写后的<code>index()</code>视图：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render

<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Question


<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    latest_question_list <span class="token operator">=</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-pub_date'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
    context <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'latest_question_list'</span><span class="token punctuation">:</span> latest_question_list<span class="token punctuation">}</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'polls/index.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
</code></pre> 
<p>其中，<code>render(request, template_name, context)</code>等价于<code>HttpResponse(loader.get_template(template_name).render(context, request))</code>。</p> 
<h4><a id="334_404_567"></a>3.3.4 抛出404错误</h4> 
<p>下面处理<code>detail()</code>视图，该页面展示问题文本和选项：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> Http404
<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render

<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Question


<span class="token keyword">def</span> <span class="token function">detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> question_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        question <span class="token operator">=</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span>question_id<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Question<span class="token punctuation">.</span>DoesNotExist<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> Http404<span class="token punctuation">(</span><span class="token string">"Question does not exist"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'polls/detail.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'question'</span><span class="token punctuation">:</span> question<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>当请求的问题id不存在时，该视图将抛出<code>Http404</code>，Django将返回HTTP状态码404。</p> 
<p>模板polls/detail.html的内容将在下一节介绍。</p> 
<h5><a id="3341_get_object_or_404_589"></a>3.3.4.1 捷径：get_object_or_404()</h5> 
<p>使用<code>get()</code>查询对象，当不存在时抛出<code>Http404</code>是一种非常常见的用法。Django提供了一个捷径：<code>get_object_or_404()</code>。下面是重写后的<code>detail()</code>视图：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> get_object_or_404<span class="token punctuation">,</span> render

<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Question


<span class="token keyword">def</span> <span class="token function">detail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> question_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    question <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>Question<span class="token punctuation">,</span> pk<span class="token operator">=</span>question_id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'polls/detail.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'question'</span><span class="token punctuation">:</span> question<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>函数<code>get_object_or_404()</code>的第一个参数是要查询的模型类，之后的任意关键字参数作为查询条件将被传递给模型的<code>get()</code>函数，如果不存在则抛出<code>Http404</code>。</p> 
<p>另外，还有一个类似的函数<code>get_list_or_404()</code>，区别是使用<code>filter()</code>而不是<code>get()</code>，如果查询结果是空列表则抛出<code>Http404</code>。</p> 
<h4><a id="335__607"></a>3.3.5 使用模板系统</h4> 
<p>模板polls/detail.html的内容如下：</p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>question detail<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ question.question_text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
{% for choice in question.choice_set.all %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ choice.choice_text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
{% endfor %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>模板系统使用<code>.</code>语法来访问变量属性，例如<code>{<!-- -->{ question.question_text }}</code>（其中<code>question</code>是<code>detail()</code>视图通过context传递到模板的变量，是一个<code>Question</code>对象）。</p> 
<p><code>{% for %}</code>循环中的<code>question.choice_set.all</code>被解释为Python代码<code>question.choice_set.all()</code>，返回一个<code>Choice</code>的可迭代对象。</p> 
<p>在浏览器中访问 <a href="http://127.0.0.1:8000/polls/1/" rel="nofollow">http://127.0.0.1:8000/polls/1/</a> 会进入问题 “What’s up?” 的详情页：</p> 
<p><img src="https://images2.imgbox.com/00/5c/AbIwesak_o.png" alt="问题详情页"></p> 
<p>如果请求的问题id不存在，例如 <a href="http://127.0.0.1:8000/polls/2/" rel="nofollow">http://127.0.0.1:8000/polls/2/</a>，会返回404页面：</p> 
<p><img src="https://images2.imgbox.com/1d/3d/fxmA9GnY_o.png" alt="404页面"></p> 
<h4><a id="336_URL_640"></a>3.3.6 删除模板中硬编码的URL</h4> 
<p>在polls/index.html模板中的链接是硬编码的：</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/polls/{<!-- -->{ question.id }}/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{ question.question_text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>这种方法的问题在于，当修改URL时需要修改所有使用该URL的模板。为了解决这一问题，可以使用<code>{% url %}</code>标签，通过urls.py中<code>path()</code>函数指定的名字来引用URL。例如：</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'detail' question.id %}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{ question.question_text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="337_URL_653"></a>3.3.7 URL命名空间</h4> 
<p>为了避免不同应用中有相同名字的URL，可以在urls.py中添加一个变量<code>app_name</code>，作为URL的命名空间。在polls/urls.py中的<code>urlpatterns</code>之前增加</p> 
<pre><code class="prism language-python">app_name <span class="token operator">=</span> <span class="token string">'polls'</span>
</code></pre> 
<p>则polls/index.html模板中的链接可以改为</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'polls:detail' question.id %}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{ question.question_text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="34_4_666"></a>3.4 第4部分：表单和通用视图</h3> 
<h4><a id="341__667"></a>3.4.1 编写表单</h4> 
<p>目前的模板polls/detail.html只展示了问题和选项，无法投票。修改该模板：</p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>question detail<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'polls:vote' question.id %}<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    {% csrf_token %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fieldset</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>legend</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ question.question_text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>legend</span><span class="token punctuation">&gt;</span></span>
        {% if error_message %}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ error_message }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>{% endif %}
        {% for choice in question.choice_set.all %}
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>choice{<!-- -->{ forloop.counter }}<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>radio<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>choice<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{ choice.id }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>choice{<!-- -->{ forloop.counter }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{ choice.choice_text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
        {% endfor %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fieldset</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Vote<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>效果如下图所示：</p> 
<p><img src="https://images2.imgbox.com/3d/3a/zTswQXyk_o.png" alt="问题详情页"></p> 
<p>注意：</p> 
<ul><li>每个选项前有一个单选按钮，其<code>value</code>属性为选项id，<code>name</code>属性为<code>"choice"</code>。这意味着提交表单后，将会发送POST数据<code>choice=#</code>，其中<code>#</code>是选择的选项id。这是HTML表单的基本概念。</li><li>表单的<code>method</code>属性设置为<code>"post"</code>，因为提交该表单会修改服务端的数据。<strong>任何修改服务端数据的表单都应该使用POST方法。</strong> 这是web开发的最佳做法，并不限于Django。</li><li><code>forloop.counter</code>是<code>{% for %}</code>循环的计数器，从1开始。</li><li>POST表单需要考虑<strong>跨站点请求伪造</strong>(Cross Site Request Forgeries, CSRF)攻击。为此，Django提供了<code>{% csrf_token %}</code>标签。</li></ul> 
<p>在3.3.2节中增加了<code>vote()</code>视图，该视图用于处理表单提交的数据——将指定选项的投票计数加1。下面是该视图的实现：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse<span class="token punctuation">,</span> HttpResponseRedirect
<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> get_object_or_404<span class="token punctuation">,</span> render
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse

<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Choice<span class="token punctuation">,</span> Question


<span class="token keyword">def</span> <span class="token function">vote</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> question_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    question <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>Question<span class="token punctuation">,</span> pk<span class="token operator">=</span>question_id<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        selected_choice <span class="token operator">=</span> question<span class="token punctuation">.</span>choice_set<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">[</span><span class="token string">'choice'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> <span class="token punctuation">(</span>KeyError<span class="token punctuation">,</span> Choice<span class="token punctuation">.</span>DoesNotExist<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Redisplay the question voting form.</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'polls/detail.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'question'</span><span class="token punctuation">:</span> question<span class="token punctuation">,</span>
            <span class="token string">'error_message'</span><span class="token punctuation">:</span> <span class="token string">"You didn't select a choice."</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        selected_choice<span class="token punctuation">.</span>votes <span class="token operator">+=</span> <span class="token number">1</span>
        selected_choice<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># Always return an HttpResponseRedirect after successfully dealing with POST data.</span>
        <span class="token comment"># This prevents data from being posted twice if a user hits the Back button.</span>
        <span class="token keyword">return</span> HttpResponseRedirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'polls:results'</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>question<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><code>request.POST</code>是一个类似于字典的对象，用于访问表单提交的POST数据，值都是字符串。在这里<code>request.POST['choice']</code>返回用户选择的选项id（即单选按钮的值）。Django还提供了<code>request.GET</code>来访问GET数据。</li><li>如果POST数据中没有<code>choice</code>，<code>request.POST['choice']</code>将抛出<code>KeyError</code>，此时将重新展示问题表单并显示一个错误信息。</li><li>增加投票计数后，该视图返回<code>HttpResponseRedirect</code>而不是<code>HttpResponse</code>，<code>HttpResponseRedirect</code>用于重定向到给定的URL。<strong>成功处理POST请求后都应该重定向</strong>，以避免用户点击后退按钮时表单被重复提交。这也是web开发的最佳做法，不限于Django。</li><li><code>reverse()</code>函数用于根据URL的名字和路径参数（如果有）构造URL，从而避免视图函数中硬编码URL（类似于模板中的<code>{% url %}</code>标签）。例如，<code>reverse('polls:results', args=(3,))</code>将返回<code>'/polls/3/results/'</code>。</li></ul> 
<p>用户投票后，<code>vote()</code>视图将重定向到问题结果页面。<code>results()</code>视图与<code>detail()</code>几乎完全一样，唯一的区别的模板名称（下一节将解决这一冗余问题）：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">results</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> question_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    question <span class="token operator">=</span> get_object_or_404<span class="token punctuation">(</span>Question<span class="token punctuation">,</span> pk<span class="token operator">=</span>question_id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'polls/results.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'question'</span><span class="token punctuation">:</span> question<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>模板polls/results.html如下：</p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>vote results<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ question.question_text }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
{% for choice in question.choice_set.all %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ choice.choice_text }} -- {<!-- -->{ choice.votes }} vote{<!-- -->{ choice.votes|pluralize }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
{% endfor %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'polls:detail' question.id %}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Vote again?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8b/8c/iQGJFkzb_o.png" alt="结果页面"></p> 
<p>注：<code>vote()</code>视图没有处理竞争条件，即两个用户同时投票可能导致错误的数据。</p> 
<h4><a id="342__772"></a>3.4.2 通用视图</h4> 
<p>投票应用的<code>detail()</code>、<code>results()</code>和<code>index()</code>视图都很短，也很冗余。这些视图代表了web开发的常见模式：根据URL参数从数据库中获取数据，渲染并返回模板。为此，Django提供了一种捷径——<strong>通用视图</strong>(generic view)。通用视图抽象了公共模式，可以节省很多重复代码。</p> 
<p>注：在实际编写Django应用时应首先考虑使用通用视图。本教程为了介绍基本概念而有意地先使用普通方式编写视图。</p> 
<h5><a id="3421_URLconf_777"></a>3.4.2.1 修改URLconf</h5> 
<p>首先修改polls/urls.py：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path

<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views

app_name <span class="token operator">=</span> <span class="token string">'polls'</span>
urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>IndexView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:pk&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>DetailView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'detail'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:pk&gt;/results/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>ResultsView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'results'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'&lt;int:question_id&gt;/vote/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>vote<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'vote'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>注意<code>detail</code>和<code>results</code>视图的路径参数名由<code>question_id</code>改为了<code>pk</code>。</p> 
<h5><a id="3422__796"></a>3.4.2.2 修改视图</h5> 
<p>删除polls/views.py中旧的<code>index</code>、<code>detail</code>和<code>results</code>视图，改为：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponseRedirect
<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> get_object_or_404<span class="token punctuation">,</span> render
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views <span class="token keyword">import</span> generic

<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Choice<span class="token punctuation">,</span> Question


<span class="token keyword">class</span> <span class="token class-name">IndexView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>ListView<span class="token punctuation">)</span><span class="token punctuation">:</span>
    template_name <span class="token operator">=</span> <span class="token string">'polls/index.html'</span>
    context_object_name <span class="token operator">=</span> <span class="token string">'latest_question_list'</span>

    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Return the last five published questions."""</span>
        <span class="token keyword">return</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-pub_date'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">DetailView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>DetailView<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model <span class="token operator">=</span> Question
    template_name <span class="token operator">=</span> <span class="token string">'polls/detail.html'</span>


<span class="token keyword">class</span> <span class="token class-name">ResultsView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>DetailView<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model <span class="token operator">=</span> Question
    template_name <span class="token operator">=</span> <span class="token string">'polls/results.html'</span>


<span class="token keyword">def</span> <span class="token function">vote</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> question_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment"># same as above, no changes needed.</span>
</code></pre> 
<p>这里使用了两个通用视图：<code>ListView</code>和<code>DetailView</code>。这两个视图分别抽象了“展示一个对象列表”和“展示一个特定对象的详情页”的概念。</p> 
<ul><li>每个通用视图需要通过<code>model</code>属性指定要操作的模型。</li><li><code>DetailView</code>通过名为<code>pk</code>的URL路径参数指定主键的值。</li></ul> 
<p>默认情况下，<code>DetailView</code>使用名为<code>&lt;app_name&gt;/&lt;model_name&gt;_detail.html</code>的模板，对于投票应用则是polls/question_detail.html。可以通过<code>template_name</code>属性指定模板名称。</p> 
<p>类似地，<code>ListView</code>使用的默认模板名为<code>&lt;app_name&gt;/&lt;model_name&gt;_list.html</code>，也可以通过<code>template_name</code>属性指定。</p> 
<p><code>DetailView</code>使用的默认context变量名为<code>&lt;model_name&gt;</code>（例如<code>question</code>），<code>ListView</code>默认使用<code>&lt;model_name&gt;_list</code>（例如<code>question_list</code>），也可以通过<code>context_object_name</code>属性指定。例如，<code>IndexView</code>仍然使用之前的变量名<code>latest_question_list</code>。</p> 
<p><code>ListView</code>的<code>get_queryset()</code>方法返回查询结果。</p> 
<h3><a id="35_5_843"></a>3.5 第5部分：测试</h3> 
<h4><a id="351__844"></a>3.5.1 自动化测试</h4> 
<p><strong>测试</strong>(test)是检查代码行为的例程。</p> 
<p>测试运行在不同的层次，可以验证小的细节（例如一个方法的返回值是否符合预期），也可以验证软件的整体行为（例如用户在网站上的一系列输入是否产生预期的结果）。</p> 
<p>自动化测试可以在你修改代码时检查代码是否仍然按预期的方式工作，而无需手动执行测试。</p> 
<h4><a id="352__851"></a>3.5.2 编写第一个测试</h4> 
<h5><a id="3521_bug_852"></a>3.5.2.1 发现bug</h5> 
<p>投票应用有一个bug：<code>Question.was_published_recently()</code>对于发布日期在将来的<code>Question</code>也会返回<code>True</code>，这显然是错误的。</p> 
<p>可以使用<code>shell</code>命令来验证：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> datetime
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> polls<span class="token punctuation">.</span>models <span class="token keyword">import</span> Question
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> future_question <span class="token operator">=</span> Question<span class="token punctuation">(</span>pub_date<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> future_question<span class="token punctuation">.</span>was_published_recently<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token boolean">True</span>
</code></pre> 
<h5><a id="3522_bug_866"></a>3.5.2.2 编写测试来暴露bug</h5> 
<p>下面将刚刚在<code>shell</code>中测试问题的过程转换为自动化测试。</p> 
<p>测试代码通常放在应用目录下的tests.py中。在polls/tests.py中编写以下代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> datetime

<span class="token keyword">from</span> django<span class="token punctuation">.</span>test <span class="token keyword">import</span> TestCase
<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone

<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Question


<span class="token keyword">class</span> <span class="token class-name">QuestionModelTests</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">test_was_published_recently_with_future_question</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        was_published_recently() returns False for questions whose pub_date
        is in the future.
        """</span>
        time <span class="token operator">=</span> timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
        future_question <span class="token operator">=</span> Question<span class="token punctuation">(</span>pub_date<span class="token operator">=</span>time<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertFalse<span class="token punctuation">(</span>future_question<span class="token punctuation">.</span>was_published_recently<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里创建了一个<code>django.test.TestCase</code>的子类和一个测试方法。</p> 
<h5><a id="3523__894"></a>3.5.2.3 运行测试</h5> 
<p>执行以下命令：</p> 
<pre><code class="prism language-bash">python manage.py <span class="token builtin class-name">test</span> polls
</code></pre> 
<p>该命令查找并运行polls应用的测试。将会看到测试失败的错误信息：</p> 
<pre><code>Creating test database for alias 'default'...
System check identified no issues (0 silenced).
F
======================================================================
FAIL: test_was_published_recently_with_future_question (polls.tests.QuestionModelTests)
was_published_recently() returns False for questions whose pub_date
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/path/to/mysite/polls/tests.py", line 18, in test_was_published_recently_with_future_question
    self.assertFalse(future_question.was_published_recently())
AssertionError: True is not false

----------------------------------------------------------------------
Ran 1 test in 0.002s

FAILED (failures=1)
Destroying test database for alias 'default'...
</code></pre> 
<p>从错误信息中可以知道失败的测试和所在行数。</p> 
<h5><a id="3524_bug_925"></a>3.5.2.4 修复bug</h5> 
<p>下面修复<code>Question.was_published_recently()</code>方法的bug，只有当<code>pub_date</code>介于昨天和今天之间时才返回<code>True</code>：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">was_published_recently</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        now <span class="token operator">=</span> timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> now <span class="token operator">-</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>pub_date <span class="token operator">&lt;=</span> now
</code></pre> 
<p>再次运行测试：</p> 
<pre><code>Creating test database for alias 'default'...
System check identified no issues (0 silenced).
.
----------------------------------------------------------------------
Ran 1 test in 0.001s

OK
Destroying test database for alias 'default'...
</code></pre> 
<p>发现bug之后，我们编写了一个测试来暴露它，并修复了bug使测试通过。</p> 
<p>在将来，我们的应用可能还会有其他的bug，但通过测试我们可以确保不会再无意地重新引入这个bug。</p> 
<h5><a id="3525__951"></a>3.5.2.5 更全面的测试</h5> 
<p>为了更全面地测试<code>was_published_recently()</code>方法，在<code>QuestionModelTests</code>中增加两个测试方法，分别使用过去和最近的问题来测试：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">test_was_published_recently_with_old_question</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    was_published_recently() returns False for questions whose pub_date
    is older than 1 day.
    """</span>
    time <span class="token operator">=</span> timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> seconds<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    old_question <span class="token operator">=</span> Question<span class="token punctuation">(</span>pub_date<span class="token operator">=</span>time<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>assertFalse<span class="token punctuation">(</span>old_question<span class="token punctuation">.</span>was_published_recently<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">test_was_published_recently_with_recent_question</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    was_published_recently() returns True for questions whose pub_date
    is within the last day.
    """</span>
    time <span class="token operator">=</span> timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">23</span><span class="token punctuation">,</span> minutes<span class="token operator">=</span><span class="token number">59</span><span class="token punctuation">,</span> seconds<span class="token operator">=</span><span class="token number">59</span><span class="token punctuation">)</span>
    recent_question <span class="token operator">=</span> Question<span class="token punctuation">(</span>pub_date<span class="token operator">=</span>time<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>assertTrue<span class="token punctuation">(</span>recent_question<span class="token punctuation">.</span>was_published_recently<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="353__974"></a>3.5.3 测试视图</h4> 
<p>投票应用的<code>index</code>视图也存在一个问题：它会展示发布日期在将来的问题，这是不合理的。</p> 
<h5><a id="3531__977"></a>3.5.3.1 视图的测试</h5> 
<p><strong>测试驱动开发</strong>(test-driven development)主张先写测试后写代码（“让测试通过之前先让测试失败”）。但实际上写代码和测试的顺序不重要。</p> 
<p>上一节中的测试主要关注代码的内部行为，而这一个测试将检查用户通过浏览器体验到的行为。</p> 
<h5><a id="3532_Django_982"></a>3.5.3.2 Django测试客户端</h5> 
<p>Django提供了一个测试客户端<code>django.test.Client</code>来模拟用户在视图层面的交互行为，可以在tests.py或者<code>shell</code>中使用。例如：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>test<span class="token punctuation">.</span>utils <span class="token keyword">import</span> setup_test_environment
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> setup_test_environment<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>test <span class="token keyword">import</span> Client
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> client <span class="token operator">=</span> Client<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
Not Found<span class="token punctuation">:</span> <span class="token operator">/</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>status_code
<span class="token number">404</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'polls:index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>status_code
<span class="token number">200</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>content
<span class="token string">b'&lt;!DOCTYPE html&gt;\n&lt;html lang="en"&gt;\n&lt;head&gt;\n    &lt;meta charset="UTF-8"&gt;\n    &lt;title&gt;polls index&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n\n    &lt;ul&gt;\n    \n        &lt;li&gt;&lt;a href="/polls/1/"&gt;What&amp;#x27;s up?&lt;/a&gt;&lt;/li&gt;\n    \n    &lt;/ul&gt;\n\n&lt;/body&gt;\n&lt;/html&gt;\n'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> response<span class="token punctuation">.</span>context<span class="token punctuation">[</span><span class="token string">'latest_question_list'</span><span class="token punctuation">]</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token operator">&lt;</span>Question<span class="token punctuation">:</span> What's up?<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
</code></pre> 
<h5><a id="3533__1004"></a>3.5.3.3 改进视图</h5> 
<p>为了不展示发布日期在将来的问题，修改<code>IndexView.get_queryset()</code>方法：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Return the last five published questions
    (not including those set to be published in the future).
    """</span>
    <span class="token keyword">return</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>pub_date__lte<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-pub_date'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
</code></pre> 
<p>这里增加了一个条件：<code>pub_date</code>小于等于当前时间。</p> 
<h5><a id="3534__1017"></a>3.5.3.4 测试新视图</h5> 
<p>为了验证以上修改是否符合预期，可以使用<code>runserver</code>启动服务器，创建几个发布日期分别在过去和将来的<code>Question</code>，并在浏览器中访问<code>index</code>视图，检查是否只展示了已发布的问题。然而，每次修改代码都重复这一过程无疑是很麻烦的，因此创建一个自动化测试。</p> 
<p>在polls/tests.py中增加一个创建问题的辅助函数和几个新的测试类：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">create_question</span><span class="token punctuation">(</span>question_text<span class="token punctuation">,</span> days<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Create a question with the given `question_text` and published the
    given number of `days` offset to now (negative for questions published
    in the past, positive for questions that have yet to be published).
    """</span>
    time <span class="token operator">=</span> timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span>days<span class="token punctuation">)</span>
    <span class="token keyword">return</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>question_text<span class="token operator">=</span>question_text<span class="token punctuation">,</span> pub_date<span class="token operator">=</span>time<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">QuestionIndexViewTests</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">test_no_questions</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""If no questions exist, an appropriate message is displayed."""</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'polls:index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertContains<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"No polls are available."</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertQuerysetEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>context<span class="token punctuation">[</span><span class="token string">'latest_question_list'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_past_question</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Questions with a pub_date in the past are displayed on the index page."""</span>
        question <span class="token operator">=</span> create_question<span class="token punctuation">(</span>question_text<span class="token operator">=</span><span class="token string">"Past question."</span><span class="token punctuation">,</span> days<span class="token operator">=</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'polls:index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertQuerysetEqual<span class="token punctuation">(</span>
            response<span class="token punctuation">.</span>context<span class="token punctuation">[</span><span class="token string">'latest_question_list'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span>question<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_future_question</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Questions with a pub_date in the future aren't displayed on the index page."""</span>
        create_question<span class="token punctuation">(</span>question_text<span class="token operator">=</span><span class="token string">"Future question."</span><span class="token punctuation">,</span> days<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'polls:index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertContains<span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"No polls are available."</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertQuerysetEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>context<span class="token punctuation">[</span><span class="token string">'latest_question_list'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_future_question_and_past_question</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Even if both past and future questions exist, only past questions
        are displayed.
        """</span>
        question <span class="token operator">=</span> create_question<span class="token punctuation">(</span>question_text<span class="token operator">=</span><span class="token string">"Past question."</span><span class="token punctuation">,</span> days<span class="token operator">=</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>
        create_question<span class="token punctuation">(</span>question_text<span class="token operator">=</span><span class="token string">"Future question."</span><span class="token punctuation">,</span> days<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'polls:index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertQuerysetEqual<span class="token punctuation">(</span>
            response<span class="token punctuation">.</span>context<span class="token punctuation">[</span><span class="token string">'latest_question_list'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span>question<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_two_past_questions</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""The questions index page may display multiple questions."""</span>
        question1 <span class="token operator">=</span> create_question<span class="token punctuation">(</span>question_text<span class="token operator">=</span><span class="token string">"Past question 1."</span><span class="token punctuation">,</span> days<span class="token operator">=</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">)</span>
        question2 <span class="token operator">=</span> create_question<span class="token punctuation">(</span>question_text<span class="token operator">=</span><span class="token string">"Past question 2."</span><span class="token punctuation">,</span> days<span class="token operator">=</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'polls:index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertQuerysetEqual<span class="token punctuation">(</span>
            response<span class="token punctuation">.</span>context<span class="token punctuation">[</span><span class="token string">'latest_question_list'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span>question2<span class="token punctuation">,</span> question1<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
</code></pre> 
<p>其中：</p> 
<ul><li><code>assertContains()</code>和<code>assertQuerysetEqual</code>是<code>django.test.TestCase</code>提供的额外的断言方法，<code>assertEqual()</code>是继承自Python标准库<code>unittest.TestCase</code>类的方法。</li><li><code>django.test.TestCase</code>自带了一个测试客户端<code>self.client</code>，不需要手动创建。</li></ul> 
<p>实际上，我们是在使用测试从用户体验的角度来保证发布的是符合预期的结果。</p> 
<h5><a id="3535_DetailView_1087"></a>3.5.3.5 测试DetailView</h5> 
<p>修复了上面的问题后，虽然未发布的问题不会出现在<code>index</code>页面，但如果用户猜到了URL，仍然可以访问这些问题的详情页。因此需要给<code>DetailView</code>增加一个类似的限制：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">DetailView</span><span class="token punctuation">(</span>generic<span class="token punctuation">.</span>DetailView<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>
    <span class="token keyword">def</span> <span class="token function">get_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Excludes any questions that aren't published yet."""</span>
        <span class="token keyword">return</span> Question<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>pub_date__lte<span class="token operator">=</span>timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>DetailView.get_queryset()</code>用于限定对象的查询范围，之后在这个范围内查询指定的id。如果不在这个范围内，即使请求的id在数据库中存在，<code>DetailView</code>也会返回404。</p> 
<p>下面增加一些测试，分别验证发布日期在过去和将来的问题详情页是否会被展示：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">QuestionDetailViewTests</span><span class="token punctuation">(</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">test_future_question</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""The detail view of a question with a pub_date in the future
        returns a 404 not found.
        """</span>
        future_question <span class="token operator">=</span> create_question<span class="token punctuation">(</span>question_text<span class="token operator">=</span><span class="token string">'Future question.'</span><span class="token punctuation">,</span> days<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
        url <span class="token operator">=</span> reverse<span class="token punctuation">(</span><span class="token string">'polls:detail'</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>future_question<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> <span class="token number">404</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_past_question</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""The detail view of a question with a pub_date in the past
        displays the question's text.
        """</span>
        past_question <span class="token operator">=</span> create_question<span class="token punctuation">(</span>question_text<span class="token operator">=</span><span class="token string">'Past Question.'</span><span class="token punctuation">,</span> days<span class="token operator">=</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span>
        url <span class="token operator">=</span> reverse<span class="token punctuation">(</span><span class="token string">'polls:detail'</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>past_question<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertContains<span class="token punctuation">(</span>response<span class="token punctuation">,</span> past_question<span class="token punctuation">.</span>question_text<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="3536__1124"></a>3.5.3.6 更多测试</h5> 
<p>我们的应用还可以继续改进，同时增加测试：</p> 
<ul><li><code>ResultsView</code>也可以增加一个类似的<code>get_queryset()</code>。</li><li>没有选项的问题不应该被展示。</li><li>管理员可以查看未发布的问题，而普通用户不能。</li></ul> 
<p>总之，<strong>给软件增加的每一个功能都应伴随一个测试，无论先写测试后编码，还是先编码后测试。</strong></p> 
<h4><a id="354__1132"></a>3.5.4 越多越好</h4> 
<ul><li>不必担心测试代码会越来越多。</li><li>当软件功能变化时可能需要更新测试。</li><li>随着开发的进行，有些测试可能变得冗余，但这也没有问题——在测试中冗余是好事。</li><li>良好的组织测试的规则： 
  <ul><li>为每个模型或视图编写一个测试类</li><li>为每一组想要测试的条件编写一个测试方法（测试用例）</li><li>测试方法名描述其功能</li></ul> </li></ul> 
<p>关于测试的完整细节参考<a href="https://docs.djangoproject.com/en/stable/topics/testing/" rel="nofollow">Testing in Django</a>。</p> 
<h3><a id="36_6_1143"></a>3.6 第6部分：样式</h3> 
<p>除了web服务器生成的HTML，web应用通常需要提供额外的文件，例如图片、JavaScript或CSS，用于渲染完整的web页面。Django将这些文件统称为<strong>静态文件</strong>(static files)。</p> 
<p><code>django.contrib.staticfiles</code>应用用于将所有应用的静态文件收集到一个线上环境容易访问的地方。</p> 
<h4><a id="361__1148"></a>3.6.1 自定义样式</h4> 
<p>首先，在polls目录下创建一个static目录，并在其中再创建一个polls目录。之后，在内层polls目录下创建一个名为style.css的文件，即polls/static/polls/style.css。</p> 
<p>注：和模板类似，内层polls目录是为了作为“命名空间”，避免不同应用中有相同名字的静态文件。</p> 
<p>样式表style.css的内容如下：</p> 
<pre><code class="prism language-css"><span class="token selector">li a</span> <span class="token punctuation">{<!-- --></span>
    <span class="token property">color</span><span class="token punctuation">:</span> green<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接下来，在模板polls/index.html的<code>&lt;head&gt;</code>部分添加以下内容：</p> 
<pre><code class="prism language-html">{% load static %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% static 'polls/style.css' %}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><code>{% static %}</code>模板标签生成静态文件的绝对URL。</p> 
<p>重新加载 <a href="http://localhost:8000/polls/" rel="nofollow">http://localhost:8000/polls/</a>，将会看到问题链接变为绿色（Django风格）：</p> 
<p><img src="https://images2.imgbox.com/06/07/IFRgxzNc_o.png" alt="样式表生效"></p> 
<h4><a id="362__1174"></a>3.6.2 添加背景图片</h4> 
<p>在polls/static/polls/目录下创建一个子目录images，在该目录下任意添加一张背景图片，名为background.png。</p> 
<p>之后在style.css中添加对图片的引用：</p> 
<pre><code class="prism language-css"><span class="token selector">body</span> <span class="token punctuation">{<!-- --></span>
    <span class="token property">background</span><span class="token punctuation">:</span> white <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">"images/background.png"</span><span class="token punctuation">)</span></span> no-repeat<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>重新加载页面，将会看到背景图片出现在屏幕左上角：</p> 
<p><img src="https://images2.imgbox.com/ec/ed/Ocg5iyzj_o.png" alt="添加背景图片"></p> 
<p>关于静态文件的更多细节参考<a href="https://docs.djangoproject.com/en/stable/howto/static-files/" rel="nofollow">How to manage static files</a>。</p> 
<h3><a id="37_7admin_1191"></a>3.7 第7部分：自定义admin应用</h3> 
<h4><a id="371__1192"></a>3.7.1 自定义表单</h4> 
<p>在3.2.5节中，通过<code>admin.site.register(Question)</code>将<code>Question</code>模型注册到admin应用，Django能够为模型创建默认表单。另外也可以对表单进行自定义。</p> 
<p>将polls.admin.py中的<code>admin.site.register(Question)</code>替换为以下内容：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin

<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Question


<span class="token keyword">class</span> <span class="token class-name">QuestionAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'pub_date'</span><span class="token punctuation">,</span> <span class="token string">'question_text'</span><span class="token punctuation">]</span>

admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Question<span class="token punctuation">,</span> QuestionAdmin<span class="token punctuation">)</span>
</code></pre> 
<p>创建一个<code>ModelAdmin</code>的子类，并将其传递给<code>admin.site.register()</code>的第二个参数，即可改变该模型的admin选项。这里通过<code>fields</code>属性改变了<code>Question</code>表单的字段顺序，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/3f/73/plboMeNs_o.png" alt="自定义表单字段顺序"></p> 
<p>对于有很多字段的表单，可以通过<code>fieldsets</code>属性将表单划分为字段组：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">QuestionAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fieldsets <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fields'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'question_text'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Date information'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fields'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'pub_date'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/42/11/ICgFfLgt_o.png" alt="自定义表单字段组"></p> 
<h4><a id="372__1225"></a>3.7.2 添加关联对象</h4> 
<p>目前的<code>Question</code>表单还未展示选项。有两种方式来解决这一问题。</p> 
<p>第一种方式是像<code>Question</code>一样注册<code>Choice</code>模型：</p> 
<pre><code class="prism language-python">admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Choice<span class="token punctuation">)</span>
</code></pre> 
<p>增加<code>Choice</code>的表单如下：</p> 
<p><img src="https://images2.imgbox.com/4a/f5/KgpHK9mT_o.png" alt="Choice表单"></p> 
<p>其中，“Question” 字段表示为下拉列表<code>&lt;select&gt;</code>，因为<code>Choice.question</code>是一个引用<code>Question</code>的外键。</p> 
<p>注意 “Question” 字段后面的 “+” 按钮，点击后会弹出一个包含<code>Question</code>表单的窗口，从而无需退出当前表单即可直接新增<code>Question</code>。点击保存后，Django会将其保存到数据库，并添加到<code>Choice</code>表单的下拉列表中。</p> 
<p>另一种更好的方式是在创建<code>Question</code>对象时直接添加选项。首先删除<code>admin.site.register(Choice)</code>，之后修改polls/admin.py：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin

<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Question<span class="token punctuation">,</span> Choice


<span class="token keyword">class</span> <span class="token class-name">ChoiceInline</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>StackedInline<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model <span class="token operator">=</span> Choice
    extra <span class="token operator">=</span> <span class="token number">3</span>


<span class="token keyword">class</span> <span class="token class-name">QuestionAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fieldsets <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fields'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'question_text'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'Date information'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'fields'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'pub_date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'classes'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'collapse'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    inlines <span class="token operator">=</span> <span class="token punctuation">[</span>ChoiceInline<span class="token punctuation">]</span>


admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Question<span class="token punctuation">,</span> QuestionAdmin<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/21/2a/AwAETa4D_o.png" alt="自定义表单关联对象"></p> 
<p>可以看到，表单默认提供了3个选项输入框。</p> 
<p>有一个小问题：这种方式占用了太多屏幕空间。Django还提供了一种表格式的展示方式，将<code>ChoiceInline</code>的声明修改为</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ChoiceInline</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>TabularInline<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>
</code></pre> 
<p>则选项输入框会以更紧凑的方式展示：</p> 
<p><img src="https://images2.imgbox.com/78/97/hYnbOYrk_o.png" alt="自定义表单关联对象2"></p> 
<h4><a id="373__1282"></a>3.7.3 自定义列表</h4> 
<p>目前的问题列表只有标题这一列：</p> 
<p><img src="https://images2.imgbox.com/a2/b6/yHyPwEv2_o.png" alt="问题列表"></p> 
<p>可以通过<code>list_display</code>属性自定义该列表展示的列：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">QuestionAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>
    list_display <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'question_text'</span><span class="token punctuation">,</span> <span class="token string">'pub_date'</span><span class="token punctuation">,</span> <span class="token string">'was_published_recently'</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/11/f7/pDoBlRJX_o.png" alt="自定义问题列表"></p> 
<p>点击标题或日期列即可按该字段排序，第3列是<code>was_published_recently ()</code>方法的返回值，不支持排序。可以在<code>was_published_recently()</code>方法上使用<code>display()</code>装饰器来改进这一点：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Question</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>
    <span class="token decorator annotation punctuation">@admin<span class="token punctuation">.</span>display</span><span class="token punctuation">(</span>
        boolean<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        ordering<span class="token operator">=</span><span class="token string">'pub_date'</span><span class="token punctuation">,</span>
        description<span class="token operator">=</span><span class="token string">'Published recently?'</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">was_published_recently</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        now <span class="token operator">=</span> timezone<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> now <span class="token operator">-</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>pub_date <span class="token operator">&lt;=</span> now
</code></pre> 
<p>另外，可以在<code>QuestionAdmin</code>中使用<code>list_filter</code>属性支持按字段过滤，<code>search_fields </code>属性将在顶部显示搜索框：</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">QuestionAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>
    list_filter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'pub_date'</span><span class="token punctuation">]</span>
    search_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'question_text'</span><span class="token punctuation">]</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9e/45/vWo5JVuz_o.png" alt="自定义问题列表2"></p> 
<h4><a id="374__1323"></a>3.7.4 自定义外观</h4> 
<p>Admin应用使用了Django自己的模板系统，可以使用模板来改变其外观。</p> 
<p>修改mysite/settings.py，在<code>TEMPLATES</code>中增加一个<code>DIRS</code>选项：</p> 
<pre><code class="prism language-python">TEMPLATES <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.template.backends.django.DjangoTemplates'</span><span class="token punctuation">,</span>
        <span class="token string">'DIRS'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>BASE_DIR <span class="token operator">/</span> <span class="token string">'templates'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'APP_DIRS'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">'OPTIONS'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'context_processors'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">'django.template.context_processors.debug'</span><span class="token punctuation">,</span>
                <span class="token string">'django.template.context_processors.request'</span><span class="token punctuation">,</span>
                <span class="token string">'django.contrib.auth.context_processors.auth'</span><span class="token punctuation">,</span>
                <span class="token string">'django.contrib.messages.context_processors.messages'</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<p><code>DIRS</code>是Django加载模板时的搜索路径列表。</p> 
<p>在项目根目录下创建一个templates目录，并在其中创建一个admin目录，之后从Django源代码目录中的默认admin模板目录(django/contrib/admin/templates)将模板admin/base_site.html拷贝到该目录下。</p> 
<p>注：Django源代码目录可以在Python shell中查看：</p> 
<pre><code class="prism language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> django
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>django<span class="token punctuation">.</span>__path__<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token string">'D:\\miniconda3\\envs\\django\\lib\\site-packages\\django'</span><span class="token punctuation">]</span>
</code></pre> 
<p>之后，将<code>{<!-- -->{ site_header|default:_('Django administration') }}</code>替换为自定义的名称，例如 “Polls Administration”：</p> 
<pre><code class="prism language-html">{% block branding %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>site-name<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'admin:index' %}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Polls Administration<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre> 
<p><img src="https://images2.imgbox.com/3b/10/nzRpnmbS_o.png" alt="自定义admin站点标题"></p> 
<p>通过这种方式即可覆盖默认的admin模板。</p> 
<h4><a id="375__1370"></a>3.7.5 自定义首页</h4> 
<p>如果想自定义admin首页的外观，按照上一节的方式自定义admin/index.html模板即可。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/97456874e3c2de95c81197fd46700eba/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SpringBoot父类下的所有子类</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a8abfbe9e9a6bd64faae77a8662411bb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Xshell连接不上虚拟机的解决办法汇总</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>