<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Unity基础框架】YooAsset 学习（一） - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Unity基础框架】YooAsset 学习（一）" />
<meta property="og:description" content="YooAsset 学习记录 跟着b站视频&#43;文档学习的
地址：https://github.com/tuyoogame/YooAsset
b站视频：https://space.bilibili.com/328590743文档看它项目里的就行 YooAsset 基于的原理也是来源于Unity的 AssetBundle 和 Addressable
AssetBundle的原理及最佳实践
YooAsset简介 具体的简介项目里都有，就简单截一些了
1.Editor 1.1导入YooAsset 直接看文档。
总共三种，用的是这种
1.2 全局配置 在Resources下新建 YooAsset 配置文件
1.3 资源配置 配置直接看文档
1.3.1 AutoCollectShaders 新版已经没有这个选项了。
ShaderVariant Collector 仍在
旧版：
搜集所有Group内的材质球，把它们的shader打入一个包内
这里设置好后打开
为了防止Shader资源荣誉，点击搜集变种生成
点击完毕后，会跳到它给我们的一个所有Shader的材质球展示界面。以及生成了 ShaderVariants 的搜集结果文件
然后在热更资源目录新建一个文件夹，放入这个配置文件
然后在YooAsset打包配置里新建一个它的收集器
专门为它自定义一个打包规则
这里返回的名称和Shader Bundle Name一致
最后给搜集器换成自定义的打包规则类即可
1.4 资源打包 记录一些配（详细配置请看文档，只记录了部分）
Build Pipeline 构建管线
BuiltinBuildPipeline: 传统的内置构建管线。ScriptableBuildPipeline: 可编程构建管线。 Build Mode 构建模式
强制构建模式：会删除指定构建平台下的所有构建记录，重新构建所有资源包。增量构建模式：以上一次构建结果为基础，对于发生变化的资源进行增量构建。演练构建模式：在不生成AssetBundle文件的前提下，进行演练构建并快速生成构建报告和补丁清单。模拟构建模式：在编辑器下配合EditorSimulateMode运行模式，来模拟真实运行的环境。 Output Name Style 输出的资源包文件名称样式
HashName：哈希值HashName_Extension：哈希值&#43;后缀名HashName_BundleName_Extension：资源包名&#43;哈希值&#43;后缀名 Copy Buildin File Option 首包资源文件的拷贝方式
None：不拷贝任何文件ClearAndCopyAll：先清空已有文件，然后拷贝所有文件ClearAndCopyByTags：先清空已有文件，然后按照资源标签拷贝文件OnlyCopyAll：不清空已有文件，直接拷贝所有文件OnlyCopyByTags：不清空已有文件，直接按照资源标签拷贝文件 重要概念" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/e29afff6f9a6b72474a17a7f2bb9d457/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-25T21:52:10+08:00" />
<meta property="article:modified_time" content="2023-02-25T21:52:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Unity基础框架】YooAsset 学习（一）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="YooAsset__0"></a>YooAsset 学习记录</h2> 
<p>跟着b站视频+文档学习的</p> 
<p>地址：<a href="https://github.com/tuyoogame/YooAsset">https://github.com/tuyoogame/YooAsset</a></p> 
<ul><li>b站视频：<a href="https://space.bilibili.com/328590743" rel="nofollow">https://space.bilibili.com/328590743</a></li><li>文档看它项目里的就行</li></ul> 
<p>YooAsset 基于的原理也是来源于Unity的 <strong>AssetBundle</strong> 和 <strong>Addressable</strong><br> <a href="https://blog.uwa4d.com/archives/USparkle_Addressable3.html" rel="nofollow">AssetBundle的原理及最佳实践</a></p> 
<h2><a id="YooAsset_11"></a>YooAsset简介</h2> 
<p>具体的简介项目里都有，就简单截一些了<br> <img src="https://images2.imgbox.com/fd/c8/BMsTkfj2_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="1Editor_14"></a>1.Editor</h2> 
<h3><a id="11YooAsset_15"></a>1.1导入YooAsset</h3> 
<p>直接看文档。</p> 
<p>总共三种，用的是这种<br> <img src="https://images2.imgbox.com/e0/34/MgrGZgHn_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/99/8f/wVSaseDL_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12__21"></a>1.2 全局配置</h3> 
<p><img src="https://images2.imgbox.com/ad/a6/24VquwMt_o.png" alt="在这里插入图片描述"><br> 在<strong>Resources</strong>下新建 YooAsset 配置文件<br> <img src="https://images2.imgbox.com/16/22/9VmWWr9I_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="13__25"></a>1.3 资源配置</h3> 
<p><a href="https://github.com/tuyoogame/YooAsset/blob/main/Docs/AssetBundleCollector.md">配置直接看文档</a><br> <img src="https://images2.imgbox.com/f2/98/aWzjj7SO_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="131_AutoCollectShaders_28"></a>1.3.1 AutoCollectShaders</h4> 
<p>新版已经没有这个选项了。<br> <img src="https://images2.imgbox.com/39/89/J5Xb11Io_o.png" alt="在这里插入图片描述"><br> ShaderVariant Collector 仍在<br> <img src="https://images2.imgbox.com/13/a0/Jeso09dl_o.png" alt="在这里插入图片描述"></p> 
<p>旧版：</p> 
<p>搜集所有Group内的材质球，把它们的shader打入一个包内<br> <img src="https://images2.imgbox.com/a3/c0/uVhiPANV_o.png" alt="在这里插入图片描述"><br> 这里设置好后打开<br> <img src="https://images2.imgbox.com/10/f5/3zNC0YJI_o.png" alt="在这里插入图片描述"><br> 为了防止Shader资源荣誉，点击搜集变种生成<br> <img src="https://images2.imgbox.com/5c/cc/Dt37k9UX_o.png" alt="在这里插入图片描述"><br> 点击完毕后，会跳到它给我们的一个所有Shader的材质球展示界面。以及生成了 ShaderVariants 的搜集结果文件<br> <img src="https://images2.imgbox.com/86/93/KmVNczht_o.png" alt="在这里插入图片描述"><br> 然后在热更资源目录新建一个文件夹，放入这个配置文件<br> <img src="https://images2.imgbox.com/0c/7a/Y0Qo413t_o.png" alt="在这里插入图片描述"><br> 然后在YooAsset打包配置里新建一个它的收集器<br> <img src="https://images2.imgbox.com/2b/d3/DvAhJzBh_o.png" alt="在这里插入图片描述"><br> 专门为它自定义一个打包规则<br> <img src="https://images2.imgbox.com/aa/d6/OLf8Et2d_o.png" alt="在这里插入图片描述"><br> 这里返回的名称和Shader Bundle Name一致<br> <img src="https://images2.imgbox.com/af/2b/4sb7CJZY_o.png" alt="在这里插入图片描述"><br> 最后给搜集器换成自定义的打包规则类即可<br> <img src="https://images2.imgbox.com/19/a3/zDD79brR_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="14__54"></a>1.4 资源打包</h3> 
<p><img src="https://images2.imgbox.com/51/3d/oTaoINoz_o.png" alt="在这里插入图片描述"><br> <em>记录一些配（详细配置请看文档，只记录了部分）</em></p> 
<ul><li> <p><strong>Build Pipeline 构建管线</strong></p> 
  <ol><li>BuiltinBuildPipeline: 传统的内置构建管线。</li><li>ScriptableBuildPipeline: 可编程构建管线。</li></ol> </li><li> <p><strong>Build Mode 构建模式</strong></p> 
  <ol><li>强制构建模式：会删除指定构建平台下的所有构建记录，重新构建所有资源包。</li><li>增量构建模式：以上一次构建结果为基础，对于发生变化的资源进行增量构建。</li><li>演练构建模式：在不生成AssetBundle文件的前提下，进行演练构建并快速生成构建报告和补丁清单。</li><li>模拟构建模式：在编辑器下配合EditorSimulateMode运行模式，来模拟真实运行的环境。</li></ol> </li><li> <p><strong>Output Name Style 输出的资源包文件名称样式</strong></p> 
  <ol><li>HashName：哈希值</li><li>HashName_Extension：哈希值+后缀名</li><li>HashName_BundleName_Extension：资源包名+哈希值+后缀名</li></ol> </li><li> <p><strong>Copy Buildin File Option 首包资源文件的拷贝方式</strong></p> 
  <ol><li>None：不拷贝任何文件</li><li>ClearAndCopyAll：先清空已有文件，然后拷贝所有文件</li><li>ClearAndCopyByTags：先清空已有文件，然后按照资源标签拷贝文件</li><li>OnlyCopyAll：不清空已有文件，直接拷贝所有文件</li><li>OnlyCopyByTags：不清空已有文件，直接按照资源标签拷贝文件</li></ol> </li></ul> 
<p><strong>重要概念</strong></p> 
<ul><li><strong>增量构建</strong><br> 增量构建是在Unity的帮助下实现的一种快速打包机制。主要是利用资源构建相关的缓存文件来避免二次构建，以此来提高打包效率。</li><li><strong>强制构建</strong><br> 强制构建是每次构建之前，都会清空之前构建的所有缓存文件，以此来重新构建资源包。</li><li><strong>首包资源</strong><br> 在构建应用程序的时候，我们希望将某些资源打进首包里，**首包资源拷贝至StreamingAssets/BuildinFiles/目录下。**首包资源如果发生变化，也可以通过热更新来更新资源。</li><li><strong>补丁包</strong><br> 无论是通过增量构建还是强制构建，在构建完成后都会生成一个以包裹版本（PackageVersion）命名的文件夹，我们把这个文件夹统称为补丁包。补丁包里包含了游戏运行需要的所有资源，我们可以无脑的将补丁包内容覆盖到CDN目录下，也可以通过编写差异分析工具，来筛选出和线上最新版本之间的差异文件，然后将差异文件上传到CDN目录里。<br> <img src="https://images2.imgbox.com/d2/0f/QcJKqXM3_o.png" alt="在这里插入图片描述"><br> 不勾就是增量，勾选就是重出包了。</li></ul> 
<h4><a id="141__92"></a>1.4.1 自定义加密</h4> 
<p><img src="https://images2.imgbox.com/66/03/8XYJygjk_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/48/29/zvKnPAFZ_o.png" alt="在这里插入图片描述"></p> 
<ul><li>Check 检查哪些文件要加密，比如配置表。路径是相对应于Assets下的(“Assets/xxx/xxx”)<br> <img src="https://images2.imgbox.com/88/2c/G87wumTu_o.png" alt="在这里插入图片描述"></li><li>Encrypt 就是具体的加密算法了。demo里提供了一个简单的数据偏移算法。<br> <img src="https://images2.imgbox.com/8d/28/wK4gWYFX_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="142_Buildin_Tags_99"></a>1.4.2 Buildin Tags</h4> 
<p><img src="https://images2.imgbox.com/01/0a/WrHgCXe6_o.png" alt="在这里插入图片描述"><br> Buildin Tags 里填的是Group 的 Grouper Asset Tags。就是表示你这次想把哪些 Group 打包。</p> 
<pre><code>多个 Tag 用 ; 隔开。 
buildin;level;other
</code></pre> 
<h4><a id="143__106"></a>1.4.3 补丁清单</h4> 
<p><img src="https://images2.imgbox.com/21/8b/uPaT49j2_o.png" alt="在这里插入图片描述"></p> 
<ol><li> <p><strong>AssetList</strong><br> 所有通过Grouper搜集器搜到的通过代码加载的资源。<br> <img src="https://images2.imgbox.com/da/b0/nCp3HG4U_o.png" alt="在这里插入图片描述"></p> 
  <ul><li>AssetPath Asset下的相对路径</li><li>BundleID 主BundleID</li><li>DependIDs 以来的BundleID们</li></ul> </li><li> <p><strong>BundleList</strong><br> 根据YooAsset配置生成的所有Bundle了</p> <p>上面的BundleID指的就是这个列表下的Bundle<br> <img src="https://images2.imgbox.com/3e/dd/5AbNl9q0_o.png" alt="在这里插入图片描述"></p> 
  <ul><li>Hash 它的hash值</li><li>CRC 验证完整性</li><li>SizeBytes 大小</li><li>Tags 包含了Grouper Asset Tags 和 搜集器上填的 tag</li><li>Flag 一些附加数据全部存在这里（= =没搞懂）</li></ul> </li><li> <p><strong>YooAsset的不同之处</strong></p> 
  <ol><li>记录<strong>AssetPath对应的资源对象</strong>依赖了哪些Bundle。</li><li>记录 <strong>AssetPath对应的资源对象的Bundle</strong> 依赖了哪些 Bundle</li></ol> </li></ol> 
<p>而大部分其他的框架是用 2. 的方式。</p> 
<p>而 2. 的方式有个问题。比如有 A、B、C、D 三个 Bundle，对象 X 在 A 、C Bundle 里</p> 
<pre><code>X in A Depend A、C
A depend B
B depend C、D

方法 2.
会导入 ABCD
X -&gt; A -&gt; B -&gt; C、D  result ABCD

方法 1. 
直接导入A、C即可。
因为经过计算，这里的依赖是展开的，不是树形，不需要再查每个Bundle下层的依赖了
X in A Depend A、C
X -&gt; A ，X -&gt; C	result A、C
</code></pre> 
<h3><a id="15__149"></a>1.5 资源部署</h3> 
<p><img src="https://images2.imgbox.com/aa/2a/5sBUlmEb_o.png" alt="在这里插入图片描述"><br> 增量更新直接替换就可以了。记得用类似Beyonce Compare比对一线，不用上传没改变的文件。</p> 
<h3><a id="16__153"></a>1.6 构建报告</h3> 
<p><img src="https://images2.imgbox.com/02/97/oaMp2GwR_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/44/06/YVBavI9b_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/af/62/PXUdsGyL_o.png" alt="在这里插入图片描述"><br> 这个构建报告，在生成的文件下面都有。导入的就是这个东西。</p> 
<h5><a id="AssetView_159"></a>AssetView</h5> 
<p><img src="https://images2.imgbox.com/4a/c9/qhfFHHa1_o.png" alt="在这里插入图片描述"><br> Grouper里搜集的，所有通过代码加载的资源对象。</p> 
<ul><li>Size 大小</li><li>Main Bundle 位于哪个Bundle里</li></ul> 
<p><img src="https://images2.imgbox.com/c8/5a/sYKPjtfR_o.png" alt="在这里插入图片描述"><br> 原生数据其实不是AB包的格式。并且每份都有一个资源包。</p> 
<h5><a id="BundleView_169"></a>BundleView</h5> 
<p><img src="https://images2.imgbox.com/62/99/CZrS2LNw_o.png" alt="在这里插入图片描述"><br> 以Bundle视角的视图。下面可以看到这个Bundle里可以用代码加载的资源列表。</p> 
<h2><a id="2_173"></a>2.代码部分</h2> 
<p>这部分代码具体请看文档。仅会贴出部分</p> 
<h3><a id="21__175"></a>2.1 初始化</h3> 
<h4><a id="211_176"></a>2.1.1初始化资源系统</h4> 
<pre><code>// 初始化资源系统
YooAssets.Initialize();

// 创建默认的资源包
var package = YooAssets.CreateAssetsPackage("DefaultPackage");

// 设置该资源包为默认的资源包，可以使用YooAssets相关加载接口加载该资源包内容。
YooAssets.SetDefaultAssetsPackage(package);
资源系统的运行模式支持三种：编辑器模拟模式，单机运行模式，联机运行模式。
</code></pre> 
<h5><a id="_188"></a>编辑器模拟模式</h5> 
<pre><code>	在编辑器下，不需要构建资源包，来模拟运行游戏。
	
	注意：该模式只在编辑器下起效
	
	private IEnumerator InitializeYooAsset()
	{
	    var initParameters = new EditorSimulateModeParameters();
	    initParameters.SimulatePatchManifestPath = EditorSimulateModeHelper.SimulateBuild("DefaultPackage");
	    yield return defaultPackage.InitializeAsync(initParameters);
	}
</code></pre> 
<h5><a id="_201"></a>联机运行模式</h5> 
<p>对于需要热更新资源的游戏，可以使用联机运行模式，该模式下初始化参数会很多。</p> 
<p><em>注意：该模式需要构建资源包</em></p> 
<ul><li>DecryptionServices : 如果资源包在构建的时候有加密，需要提供实现IDecryptionServices接口的实例类。</li><li>QueryServices：内置资源查询服务接口。</li><li>DefaultHostServer : 默认的资源服务器IP地址。</li><li>FallbackHostServer : 备用的资源服务器IP地址。</li></ul> 
<p>如果只有一个CDN地址那就都填一样的</p> 
<pre><code>	private IEnumerator InitializeYooAsset()
	{
	    var initParameters = new HostPlayModeParameters();
	    initParameters.QueryServices = new QueryStreamingAssetsFileServices();
	    initParameters.DefaultHostServer = "http://127.0.0.1/CDN1/Android/v1.0";
	    initParameters.FallbackHostServer = "http://127.0.0.1/CDN2/Android/v1.0";
	    yield return defaultPackage.InitializeAsync(initParameters);
	}
	
	// 内置文件查询服务类
	private class QueryStreamingAssetsFileServices : IQueryServices
	{
	    public bool QueryStreamingAssets(string fileName)
	    {
	        // 注意：使用了BetterStreamingAssets插件，使用前需要初始化该插件！
	        string buildinFolderName = YooAssets.GetStreamingAssetBuildinFolderName();
	        return BetterStreamingAssets.FileExists($"{buildinFolderName}/{fileName}");
	    }
	}
</code></pre> 
<p><strong>老版本和新版本差异有点大啊</strong><img src="https://images2.imgbox.com/b1/6d/dl0n2zm1_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_234"></a>源代码解析</h5> 
<h6><a id="_235"></a>编辑器模拟模式</h6> 
<p><strong>每次启动调用EditorSimulateModeHelper.SimulateBuild()方法，都会在底层执行一次模拟构建（Simulate Build）。</strong></p> 
<p>如果参与构建的资源对象数量级很大的话则会有卡顿现象，可以通过直接指定已有的清单路径来避免每次都重复执行模拟构建。</p> 
<h6><a id="_240"></a>单机运行模式</h6> 
<p><strong>在初始化的时候，会直接读取内置清单文件（StreamingAssets文件夹里的文件）</strong>，最后根据加载的清单去验证沙盒里缓存的文件。</p> 
<h6><a id="_243"></a>联机运行模式</h6> 
<p>在初始化的时候，<strong>会优先从沙盒里加载清单</strong>，如果沙盒里不存在，则会尝试加载内置清单并将其拷贝到沙盒里。最后根据加载的清单去验证沙盒里缓存的文件。</p> 
<p><em>注意：如果沙盒清单和内置清单都不存在，初始化也会被判定为成功！</em></p> 
<h3><a id="22__248"></a>2.2 资源更新</h3> 
<p><img src="https://images2.imgbox.com/02/38/ugv7FGyM_o.png" alt="在这里插入图片描述"><br> demo里实现了一个状态机，咱们可以直接拿来用。</p> 
<p><strong>文档和视频内容有差异，这里只好直接用视频的文档截图了</strong></p> 
<p><img src="https://images2.imgbox.com/94/60/KoiUD6ai_o.png" alt="在这里插入图片描述"><br> 也可以自己写HTTP逻辑来访问。<br> <img src="https://images2.imgbox.com/9b/ec/nnnPwOMo_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/f3/02/xEevR7mt_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/15/15/3rOLRAu2_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ec/4f/WSF1b94Y_o.png" alt="在这里插入图片描述"><br> 这里的 tags 就是对于的 Grouper Asset Tags ，表示你想下载那个 Grouper。</p> 
<p>不太理解这么做的原因= =。</p> 
<h4><a id="221__263"></a>2.2.1 路径</h4> 
<h5><a id="_264"></a>内置文件</h5> 
<p><img src="https://images2.imgbox.com/b7/ec/4YClKOlV_o.png" alt="在这里插入图片描述"><br> 重新强制出包的时候，把生成的内容放到如图目录下。</p> 
<h5><a id="_268"></a>沙盒</h5> 
<p><img src="https://images2.imgbox.com/99/ee/OQzPMzwg_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/5e/b9/BeoVQVsl_o.png" alt="在这里插入图片描述"></p> 
<p>在PC上的地址和Asset同级，应该就是可写目录了。也就是热更新文件的存放位置。</p> 
<h4><a id="222__273"></a>2.2.2 下载器</h4> 
<p><img src="https://images2.imgbox.com/b4/58/Kds7N2Zo_o.png" alt="在这里插入图片描述"><br> 补丁下载目前只有两种，传入单/多 个Grouper Asset Tag 。</p> 
<p>这样可以实现按需下载，比如我可以在进入关卡的时候再下载这个关卡的资源（进入关卡Loading的时候下载）。</p> 
<h2><a id="3_279"></a>3.补充部分</h2> 
<h3><a id="31_Sample__280"></a>3.1 Sample 改造</h3> 
<p>我直接拿Sample里的<strong>Sapce Shooter</strong>的热更流程来改了<br> <img src="https://images2.imgbox.com/d2/03/5O62i84O_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ad/fd/gP51SnQA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/eb/8b/8BJohizT_o.png" alt="在这里插入图片描述"><br> 大致保留这些就行了。</p> 
<p>还有提供的<strong>UniFramework</strong>系类的挺好用的，要是不想自己写事件系统之类的，可以直接拿来用。<br> <img src="https://images2.imgbox.com/db/06/0D016lgk_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32_UniTask_289"></a>3.2 UniTask接入</h3> 
<h2><a id="4AssetBundle__290"></a>4.AssetBundle 学习笔记（简略）</h2> 
<p><a href="https://warl.top/posts/Unity-AssetBundle/" rel="nofollow">Unity学习—AssetBundle</a></p> 
<p><em>以下内容为此博客的笔记。</em></p> 
<p><em>详细介绍请看博客，这里只记简略。</em></p> 
<h3><a id="41_AssetBundle__297"></a>4.1 AssetBundle 作用</h3> 
<ul><li>AssetBundle 是外部资产的集合，可独立于 Unity 构建过程外，是 Unity 更新非代码内容的主要工具；</li><li>AssetBundle 使开发者可以提交更小的应用包，最小化运行时内存压力，使终端可以选择性加载优化内容</li></ul> 
<h3><a id="42AssetBundle__301"></a>4.2AssetBundle 组成</h3> 
<p><strong>AssetBundle 主要由两部分组成：文件头和数据段</strong></p> 
<p>文件头包含了<strong>id、压缩类型、索引清单</strong>，该索引清单是与 Resources 相同的记录了<strong>序列化文件中的字节偏移量的查找表</strong>。对于大部分平台该表为平衡搜索树，对 Windows 和 OSX 系列（包括 iOS）则为红黑树，随着 AssetBundle 中对象的增加，构造清单所需时间的增长速度将<strong>超过线形增长速度</strong>。</p> 
<p>数据段包含了 Asset 经过<strong>序列化的原始数据</strong>，数据还可选择是否压缩，</p> 
<ul><li>若使用 LZMA 压缩，则将所有 Asset 的字节数组整体压缩；</li><li>若使用 LZ4 压缩，则将每个 Asset 单独压缩；</li><li>若不压缩，则数据保持原始字节流</li></ul> 
<h3><a id="43AssetBundle__312"></a>4.3AssetBundle 加载</h3> 
<p>有四种不同的 API 用于加载 AssetBundle，但每个 API 的行为随压缩算法和平台而不同</p> 
<ul><li>AssetBundle.LoadFromMemoryAsync</li><li>AssetBundle.LoadFromFile<br> 该方法可高效地从硬盘加载未压缩或 LZ4 压缩的 Assetbundle，加载 LZMA 压缩包时会先解压再加载到内存</li><li>WWW.LoadfromCacheOrDownload（5.6 及以前版本）旧方法，已抛弃</li><li>UnityWebRequestAssetBundle （5.3 及以后版本）</li></ul> 
<p>官方推荐尽量使用 <strong>AssetBundle.LoadFromFile</strong>，该 API 在速度、磁盘使用和运行时内存使用方面都最高效；需要下载则使用 UnityWebRequest</p> 
<p>注：Web平台都用 <strong>UnityWebRequest</strong> 来加载，web平台没有本地存储数据</p> 
<h3><a id="44_AssetBundle_Asset__325"></a>4.4 AssetBundle Asset 加载</h3> 
<p>同步异步加载 Asset 一共有六种 API 可使用</p> 
<ul><li> <p>LoadAssets (LoadAssetsAsync)</p> </li><li> <p>LoadAssetWithSubAssets (LoadAssetWithSubAssetsAsync)<br> 适合需要加载的对象内嵌了其他对象的情况，若加载对象均来自于一个 Asset 且包中有许多其他无关对象，则使用该 API</p> </li><li> <p>LoadAllAsset (LoadAllAssetAsync)<br> 其他情况均用LoadAsset (LoadAssetAsync)</p> </li></ul> 
<h3><a id="45_AssetBundle__335"></a>4.5 AssetBundle 依赖</h3> 
<p>当一个对象所在的 AssetBundle 被加载时，该对象就被分配了一个唯一的有效实例 ID。Unity 不会自动加载子 AssetBundle。就是不会加载你的依赖，咱们必须自己处理加载依赖的AssetBundle。</p> 
<p>在构建 AssetBundle 时，Unity 创建一个<strong>包含每一个 AssetBundle 依赖信息的类型为 AssetBundleManifest 的序列化对象</strong>，该文件存在一个与其他 AssetBundle 在同一打包路径下的<strong>单独的 AssetBundle 中，且与父层文件夹名相同。</strong></p> 
<p>有两种 API 查询依赖</p> 
<ul><li>AssetBundleManifest.GetAllDependencies 获取 AssetBundle 的所有依赖层级</li><li>AssetBundleManifest.GetDirectDependencies 获取 AssetBundle 直接依赖</li></ul> 
<p>因该 API 会生成字符串数组，所以应尽量少用，且避免性能高峰时使用</p> 
<p><strong>官方建议</strong>：<br> 大部分场合下，在进入性能需求高的场景前，尽可能多地加载对象，尤其对于移动平台这种，访问本地存储慢，加载卸载对象引起内存流失会触发垃圾回收的平台</p> 
<h3><a id="46_AssetBundle__350"></a>4.6 AssetBundle 使用</h3> 
<p>这个问题和资源卸载有关。</p> 
<p>不适当地卸载 AssetBundle 会导致对象缺失或者在内存中重复。</p> 
<p>调用<strong>AssetBundle.Unload</strong>可卸载 <strong>AssetBundle 的头信息</strong>，传入参数 true 或 false 决定是否同时卸载该包下所有已加载对象。</p> 
<ol><li> <p>由此诞生一个问题，当卸载了 AssetBundle 未卸载已加载对象时，此时这些对象与 AssetBundle 便失去关联了，<strong>重新加载 AssetBundle 并重新加载同一对象时，只会产生一个新的关联对象</strong>，而旧对象则无法使用AssetBundle.Unload卸载了，这就导致了内存中同时存在两个一样的对象。<br> <img src="https://images2.imgbox.com/d6/29/VqsGaFIQ_o.png" alt="在这里插入图片描述"></p> </li><li> <p>另外还可能出现的问题是，在 AssetBundle 卸载之后加载 AssetBundle 中的对象时，会出现对象缺失的问题。出现该问题大部分原因为 Unity 丢失又重新获得对图形上下文的控制，如移动设备 App 挂起，PC 锁定等场景</p> </li></ol> 
<h3><a id="47_AssetBundle__362"></a>4.7 AssetBundle 发布</h3> 
<p><img src="https://images2.imgbox.com/52/3a/6mdWELaK_o.png" alt="在这里插入图片描述"><br> 也就是说，<strong>AssetBundle.LoadFromFile</strong>只能在无压缩的apk获取AssetBundle???</p> 
<h3><a id="48__366"></a>4.8 自定义下载器</h3> 
<p>这部分看博客</p> 
<h3><a id="49_Asset__368"></a>4.9 Asset 分包策略</h3> 
<ul><li>逻辑实体分包</li><li>对象类型分包</li><li>并发内容分包<br> <img src="https://images2.imgbox.com/e6/39/eJ14ehDu_o.png" alt="在这里插入图片描述"><br> AssetBundle变体是什么意思？</li></ul> 
<h3><a id="410__375"></a>4.10 常见问题</h3> 
<p><em>只贴出原因，解决方案请看博客。或者这部分直接到博客里看</em></p> 
<h4><a id="4101__377"></a>4.10.1 资产重复</h4> 
<p>若有一个未分配资产被多个不同 AssetBundle 中的已分配资产引用，则在构建 AssetBundle 时，<strong>该引用对象会被拷贝到每个 AssetBundle 中</strong>，造成空间和内存浪费</p> 
<h4><a id="4102__380"></a>4.10.2 精灵图集重复</h4> 
<p><strong>任何自动生成的图集会被分配到其包含精灵所在的 AssetBundle，若精灵对象被分配到多个包，则图集会被复制，因此需确保同一图集的精灵对象被分配到同一 AssetBundle 中</strong></p> 
<h4><a id="4103_Android__383"></a>4.10.3 Android 纹理</h4> 
<p>由于 Android 生态的碎片化，经常需要使用不同格式压缩纹理。</p> 
<p>为了适配支持不同纹理格式的android机器。使用AssetBundle变体</p> 
<h3><a id="5AssetBundle__388"></a>5.AssetBundle 变体</h3> 
<p>AssetBundle Variants 的主要作用在于使 AssetBundle 随运行时环境调整其内容配置。</p> 
<p>AssetBundle Variants 使不同 AssetBundle 中的不同对对象在加载时公用一个实例 ID，使其看起来为同一个对象。</p> 
<p>个人觉得多渠道多语言也可以用这个。</p> 
<h3><a id="6_394"></a>6.其他</h3> 
<p><img src="https://images2.imgbox.com/28/bd/6KaZf10O_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="5_398"></a>5.问题&amp;解答</h2> 
<h3><a id="QNo_AssetBundle_has_been_set_for_this_build_399"></a>Q:自己使用的时候，收集器里只有原生类型的文件，然后报错“No AssetBundle has been set for this build.”</h3> 
<p><strong>A:</strong><br> 意思就是你的AssetBundle根本没东西啊，没东西用什么AssetBundle。<br> 然后添加了一个Scene到收集器里，就不报错了<br> 。。。服了，原生类型不配算资源呗？</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c35699974b91a5f53cd187d21d593c15/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">k8s查看日志命令—2023.02</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3d36a74ee1da6dcf416feb36f6ff30cc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何将CAJ文件转换成PDF格式？分享两种实用的方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>