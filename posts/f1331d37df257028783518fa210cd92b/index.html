<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>The Flask Mega-Tutorial 之 Chapter 8: Followers - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="The Flask Mega-Tutorial 之 Chapter 8: Followers" />
<meta property="og:description" content="小引 社交网往往有相互关注的特性，本节即添加“Followers”特性。 重点是调整 db，使之能够追踪 who is following whom。
Database Relationships Revisited 理想的情况是，对每个 user 都能维护一个 list，里面包括它的两类 users （即 followers 和 followed），但 Relational Database 没有这种 list 类型。Database 只储存 users 的表，所以须找到一种 relationship 类型，能够表征（model） User 的 followers / followed 之间的 link。 Representing Followers Relationship Many-to-Many： followers - followed Self-referential： followers &amp; followed belong to the same class User. Association Table: followers followers 表中，只存储了两类 ForeignKey，都指向 User 。 Database Model Representation 1、创建辅助表 followers
app / models." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/f1331d37df257028783518fa210cd92b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-06-13T11:12:02+08:00" />
<meta property="article:modified_time" content="2018-06-13T11:12:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">The Flask Mega-Tutorial 之 Chapter 8: Followers</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3 id="小引">小引</h3> 
<p>社交网往往有相互关注的特性，本节即添加“Followers”特性。 <br> 重点是调整 db，使之能够追踪 who is following whom。</p> 
<p><br></p> 
<hr> 
<h3 id="database-relationships-revisited">Database Relationships Revisited</h3> 
<ul><li>理想的情况是，对每个 user 都能维护一个 <strong>list</strong>，里面包括它的两类 users （即 <strong>followers</strong> 和 <strong>followed</strong>），但 <strong><code>Relational Database</code></strong> 没有这种 <strong>list</strong> 类型。</li><li><strong>Database</strong> 只储存 <strong>users</strong> 的表，所以须找到一种 <strong>relationship</strong> 类型，能够表征（model） <strong>User</strong> 的 <code>followers / followed</code> 之间的 <strong>link</strong>。 <br> <br></li></ul> 
<hr> 
<h3 id="representing-followers">Representing Followers</h3> 
<h5 id="relationship">Relationship</h5> 
<ul><li><strong>Many-to-Many</strong>： followers - followed </li><li><strong>Self-referential</strong>： followers &amp; followed belong to the same class <strong>User</strong>. <br> <br></li></ul> 
<h5 id="association-table-followers">Association Table: followers</h5> 
<ul><li><strong>followers</strong> 表中，只存储了两类 <strong>ForeignKey</strong>，都指向 <strong>User</strong> 。</li></ul> 
<p><img src="https://images2.imgbox.com/2c/2f/Wa5onwoy_o.png" alt="这里写图片描述" title=""></p> 
<p><br></p> 
<hr> 
<h3 id="database-model-representation">Database Model Representation</h3> 
<p>1、创建辅助表 <strong>followers</strong></p> 
<p><code>app / models.py:</code> <em>association table</em></p> 
<pre class="prettyprint"><code class=" hljs mathematica">followers = db.<span class="hljs-keyword">Table</span>(<span class="hljs-string">'followers'</span>,
    db.<span class="hljs-keyword">Column</span>(<span class="hljs-string">'follower_id'</span>, db.<span class="hljs-keyword">Integer</span>, db.ForeignKey(<span class="hljs-string">'user.id'</span>)),
    db.<span class="hljs-keyword">Column</span>(<span class="hljs-string">'followed_id'</span>, db.<span class="hljs-keyword">Integer</span>, db.ForeignKey(<span class="hljs-string">'user.id'</span>))
)</code></pre> 
<p>注：由于作为辅助表的 <strong>followers</strong> 中，除了外键，没有其他数据，所以没有使用 <strong>model class</strong> 的方式定义，而是之间采用 <strong><code>db.Table()</code></strong> 的方式定义。</p> 
<blockquote> 
 <p>Since this is an auxiliary table that has no data other than the foreign keys, I created it without an associated model class.</p> 
</blockquote> 
<p>2、创建 <strong>Many-to-Many</strong> 的 <strong>relationship</strong></p> 
<p><code>app / models.py</code>: <em>many-to-many followers relationship</em></p> 
<pre class="prettyprint"><code class=" hljs haskell"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">User</span><span class="hljs-container">(<span class="hljs-type">UserMixin</span>, <span class="hljs-title">db</span>.<span class="hljs-type">Model</span>)</span>:
    # ...
    followed = db.relationship<span class="hljs-container">(
        '<span class="hljs-type">User</span>', 
        <span class="hljs-title">secondary</span>=<span class="hljs-title">followers</span>,
        <span class="hljs-title">primaryjoin</span>=(<span class="hljs-title">followers</span>.<span class="hljs-title">c</span>.<span class="hljs-title">follower_id</span> == <span class="hljs-title">id</span>)</span>,
        secondaryjoin=<span class="hljs-container">(<span class="hljs-title">followers</span>.<span class="hljs-title">c</span>.<span class="hljs-title">followed_id</span> == <span class="hljs-title">id</span>)</span>,
        backref=db.backref<span class="hljs-container">('<span class="hljs-title">followers'</span>, <span class="hljs-title">lazy</span>='<span class="hljs-title">dynamic'</span>)</span>, 
        lazy='dynamic')</span></code></pre> 
<ul><li><code>User</code>： 因为是 self-referential 关系，故关系的另一边也是 ‘User’（relationship 名字用 Class 名，而非 table 名）</li><li><code>secondary</code>： configures the association table for this relationship</li><li><p><code>primaryjoin</code>： indicates the condition that links the left side entity (the follower user) with the association table。 其中 followers.c.follower_id 指的是 association table 的 follower_id 列。</p></li><li><p><code>secondaryjoin</code>： indicates the condition that links the right side entity (the followed user) with the association table.</p></li><li><code>backref</code>： 定义逆向关系（defines how this relationship will be accessed from the right side entity）。从左侧看，其追踪的 users 属于 <strong><code>followed</code></strong>；从被追踪的 users来看，则追踪者属于 <strong><code>followers</code></strong>。</li><li><code>lazy</code>： sets up the query to not run until specifically requested, 同于 posts 中设置的 dynamic(one-to-many)。</li></ul> 
<p><br> 注： SQLAlchemy tables 如果未定义成 models，则符号 “c” 是这类表的一种属性。 对这类表，其所有的字段或列，均视为属性 “c” 的子属性（sub-attributes）。</p> 
<blockquote> 
 <p>The “c” is an attribute of SQLAlchemy tables that are not defined as models. For these tables, the table columns are all exposed as sub-attributes of this “c” attribute.</p> 
</blockquote> 
<p>3、迁移数据库并升级</p> 
<pre class="prettyprint"><code class=" hljs r">(venv) $ flask db migrate -m <span class="hljs-string">"followers"</span>
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'followers'</span>
  Generating /home/miguel/microblog/migrations/versions/ae346256b650_followers.py <span class="hljs-keyword">...</span> done

(venv) $ flask db upgrade
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade 37f06a334dbf -&gt; ae346256b650, followers</code></pre> 
<p><br></p> 
<hr> 
<h3 id="adding-and-removing-follows">Adding and Removing “follows”</h3> 
<ul><li>依赖<strong>SQLAlchemy ORM</strong>，以及定义的 User 的 <strong><code>followed relationship</code></strong>，则在 user之间（前提是已在db存储）可以像 <strong>list</strong> 一样实现操作：</li></ul> 
<pre class="prettyprint"><code class=" hljs avrasm">user1<span class="hljs-preprocessor">.followed</span><span class="hljs-preprocessor">.append</span>(user2)
user1<span class="hljs-preprocessor">.followed</span><span class="hljs-preprocessor">.remove</span>(user2)</code></pre> 
<ul><li>为提高复用性，封装成 <strong>User</strong> 的 <strong>methods</strong></li></ul> 
<p><code>app / models.py</code>: <em>add and remove followers</em></p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span><span class="hljs-params">(UserMixin, db.Model)</span>:</span>
    <span class="hljs-comment">#...</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">follow</span><span class="hljs-params">(self, user)</span>:</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.is_following(user):
            self.followed.append(user)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unfollow</span><span class="hljs-params">(self, user)</span>:</span>
        <span class="hljs-keyword">if</span> self.is_following(user):
            self.followed.remove(user)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_following</span><span class="hljs-params">(self, user)</span>:</span>
        <span class="hljs-keyword">return</span> self.followed.filter(
            followers.c.followed_id == user.id).count() &gt; <span class="hljs-number">0</span></code></pre> 
<ol><li>相较于 filter_by()，其中 filter() 更加底层，可以包含任意的 filtering 条件语句； <br> 格式上，filter() 的条件语句更完整严格，须指明 table1.field1== table2.field2，并为”==”。</li><li>filter_by()，can only check for equality to a constant value，并且条件语句更简单。</li></ol> 
<p><br> 注：尽可能将app的逻辑从路由函数分离出来，放到 models 或其他辅助classes及模块中，因为这样便于后续的 unit testing。</p> 
<blockquote> 
 <p>It is always best to move the application logic away from view functions and into models or other auxiliary classes or modules, because as you will see later in this chapter, that makes unit testing much easier.</p> 
</blockquote> 
<p><br></p> 
<hr> 
<h3 id="obtaining-the-posts-from-followed-users">Obtaining the Posts from Followed Users</h3> 
<p>因为最终我们希望在 <code>/index</code> 页展示出 followed 的 users 的 posts。 <br> 所以写好 followed &amp; followers 的relationship（即 db 支持已完成设置）后，考虑如何获取 followed 的 users 的 posts。</p> 
<ul><li><strong>方法一</strong>：最容易想到的方法是，首先利用<code>user.followed.all()</code> 来获取 a list of followed users，然后查询每一个 user 的 posts，最终将获取到的所有 posts 并入（merg）到 单个 list 中并按日期排序。</li><li>弊端一：如果某个 user 追踪的人数 n 过大（followed is very large），则须先执行 n 次 单个 followed user 的 posts 查询，之后须将返回的 n 个 list of posts 进行merge 和 sorting。</li><li>弊端二：因为最终 Home 页会进行页码编订（pagination），首页只会显示最新的若干条 posts，设置显示更多内容的链接。这种情形下，除非我们先获取所有 posts 并按日期进行排序，否则无法知晓追踪的 users 的最新消息。 <br> 
  <blockquote> 
   <p>As a secondary problem, consider that the application’s home page will eventually have pagination implemented, so it will not display all the available posts but just the first few, with a link to get more if desired. If I’m going to display posts sorted by their date, how can I know which posts are the most recent of all followed users combined, unless I get all the posts and sort them first? This is actually an awful solution that does not scale well.</p> 
  </blockquote></li></ul> 
<br> 
<br> 
<ul><li><strong>方法二</strong>：因为 Relational Database 擅长 merging &amp; sorting，所以不将 query 放到 app 中，而是交给 db 来执行。db 通过索引（index），可以更高效地进行 query &amp; sorting。语句如下：</li></ul> 
<p><code>app / models.py</code>: <em>followed posts query</em></p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span><span class="hljs-params">(db.Model)</span>:</span>
    <span class="hljs-comment">#...</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">followed_posts</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> Post.query.join(
            followers, (followers.c.followed_id == Post.user_id)).filter(
                followers.c.follower_id == self.id).order_by(
                    Post.timestamp.desc())</code></pre> 
<p>对 Post 进行 query，结构为 <code>Post.query.join(...).filter(...).order_by(...)</code>。思路为：将 post 表中的 user_id 视为 followers 表中 followed_id 一方，先将所有匹配情况拿到（得到所有被追踪的 users 发布的所有 posts），然后筛选被某个特定 user 追踪的 users 发布的posts，最后按 post 的日期排序。 <br> <br> 1、首先，将 post 表与 followers 表进行 join，条件是<code>followers.c.followed_id == Post.user_id</code>（待查询 posts 属于 followed，所以 followed_id；如果待查询 posts 属于 follower，则 follower_id）。</p> 
<ul><li>若 followed_id 存在，但 user_id 不存在，则此 user 未发布 post。</li><li>若 followed_id 不存在，但 user_id 存在，则此 user 未被 追踪。</li><li>若多条 followed_id 匹配，则多人追踪此 user。</li><li>若多条 user_id 匹配，则此 user 发布多条 posts。 <br> <br></li></ul> 
<p>2、然后，进行 filtering。上步获得的是 followers 表中记录的所有 users 追踪的所有 followed 的 users 的 posts，为得到某个 user 的所有 followed 的users 的 posts， 则筛选条件为<code>followers.c.follower_id == self.id</code>。</p> 
<p>3、按 Post 的 timestamp 进行 倒序排布，即最新的在最上方。</p> 
<hr> 
<h3 id="combining-own-and-followed-posts">Combining Own and Followed Posts</h3> 
<p><code>app / models.py</code> : <em>followed posts + user’s own posts.</em></p> 
<pre class="prettyprint"><code class=" hljs avrasm">    def followed_posts(self):
        followed = Post<span class="hljs-preprocessor">.query</span><span class="hljs-preprocessor">.join</span>(
        followers, (followers<span class="hljs-preprocessor">.c</span><span class="hljs-preprocessor">.followed</span>_id == Post<span class="hljs-preprocessor">.user</span>_id))<span class="hljs-preprocessor">.filter</span>(
                followers<span class="hljs-preprocessor">.c</span><span class="hljs-preprocessor">.follower</span>_id == self<span class="hljs-preprocessor">.id</span>)
        own = Post<span class="hljs-preprocessor">.query</span><span class="hljs-preprocessor">.filter</span>_by(user_id=self<span class="hljs-preprocessor">.id</span>)
        return followed<span class="hljs-preprocessor">.union</span>(own)<span class="hljs-preprocessor">.order</span>_by(Post<span class="hljs-preprocessor">.timestamp</span><span class="hljs-preprocessor">.desc</span>())</code></pre> 
<hr> 
<h3 id="unit-testing-the-user-model">Unit Testing the User Model</h3> 
<p>为保证以后改变 app 的其他部分后，某些复杂的功能模块仍能正常工作，最好的方式就是写一组自动的测试 case，以后每次有改动，则 re-run 这组 case，看看是否正常工作。</p> 
<p><code>microblog / tests.py:</code> user model unit tests.</p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta
<span class="hljs-keyword">import</span> unittest
<span class="hljs-keyword">from</span> app <span class="hljs-keyword">import</span> app, db
<span class="hljs-keyword">from</span> app.models <span class="hljs-keyword">import</span> User, Post

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserModelCase</span><span class="hljs-params">(unittest.TestCase)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span><span class="hljs-params">(self)</span>:</span>
        app.config[<span class="hljs-string">'SQLALCHEMY_DATABASE_URI'</span>] = <span class="hljs-string">'sqlite://'</span>
        db.create_all()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDown</span><span class="hljs-params">(self)</span>:</span>
        db.session.remove()
        db.drop_all()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_password_hashing</span><span class="hljs-params">(self)</span>:</span>
        u = User(username=<span class="hljs-string">'susan'</span>)
        u.set_password(<span class="hljs-string">'cat'</span>)
        self.assertFalse(u.check_password(<span class="hljs-string">'dog'</span>))
        self.assertTrue(u.check_password(<span class="hljs-string">'cat'</span>))

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_avatar</span><span class="hljs-params">(self)</span>:</span>
        u = User(username=<span class="hljs-string">'john'</span>, email=<span class="hljs-string">'john@example.com'</span>)
        self.assertEqual(u.avatar(<span class="hljs-number">128</span>), (<span class="hljs-string">'https://www.gravatar.com/avatar/'</span>
                                         <span class="hljs-string">'d4c74594d841139328695756648b6bd6'</span>
                                         <span class="hljs-string">'?d=identicon&amp;s=128'</span>))

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_follow</span><span class="hljs-params">(self)</span>:</span>
        u1 = User(username=<span class="hljs-string">'john'</span>, email=<span class="hljs-string">'john@example.com'</span>)
        u2 = User(username=<span class="hljs-string">'susan'</span>, email=<span class="hljs-string">'susan@example.com'</span>)
        db.session.add(u1)
        db.session.add(u2)
        db.session.commit()
        self.assertEqual(u1.followed.all(), [])
        self.assertEqual(u1.followers.all(), [])

        u1.follow(u2)
        db.session.commit()
        self.assertTrue(u1.is_following(u2))
        self.assertEqual(u1.followed.count(), <span class="hljs-number">1</span>)
        self.assertEqual(u1.followed.first().username, <span class="hljs-string">'susan'</span>)
        self.assertEqual(u2.followers.count(), <span class="hljs-number">1</span>)
        self.assertEqual(u2.followers.first().username, <span class="hljs-string">'john'</span>)

        u1.unfollow(u2)
        db.session.commit()
        self.assertFalse(u1.is_following(u2))
        self.assertEqual(u1.followed.count(), <span class="hljs-number">0</span>)
        self.assertEqual(u2.followers.count(), <span class="hljs-number">0</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_follow_posts</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># create four users</span>
        u1 = User(username=<span class="hljs-string">'john'</span>, email=<span class="hljs-string">'john@example.com'</span>)
        u2 = User(username=<span class="hljs-string">'susan'</span>, email=<span class="hljs-string">'susan@example.com'</span>)
        u3 = User(username=<span class="hljs-string">'mary'</span>, email=<span class="hljs-string">'mary@example.com'</span>)
        u4 = User(username=<span class="hljs-string">'david'</span>, email=<span class="hljs-string">'david@example.com'</span>)
        db.session.add_all([u1, u2, u3, u4])

        <span class="hljs-comment"># create four posts</span>
        now = datetime.utcnow()
        p1 = Post(body=<span class="hljs-string">"post from john"</span>, author=u1,
                  timestamp=now + timedelta(seconds=<span class="hljs-number">1</span>))
        p2 = Post(body=<span class="hljs-string">"post from susan"</span>, author=u2,
                  timestamp=now + timedelta(seconds=<span class="hljs-number">4</span>))
        p3 = Post(body=<span class="hljs-string">"post from mary"</span>, author=u3,
                  timestamp=now + timedelta(seconds=<span class="hljs-number">3</span>))
        p4 = Post(body=<span class="hljs-string">"post from david"</span>, author=u4,
                  timestamp=now + timedelta(seconds=<span class="hljs-number">2</span>))
        db.session.add_all([p1, p2, p3, p4])
        db.session.commit()

        <span class="hljs-comment"># setup the followers</span>
        u1.follow(u2)  <span class="hljs-comment"># john follows susan</span>
        u1.follow(u4)  <span class="hljs-comment"># john follows david</span>
        u2.follow(u3)  <span class="hljs-comment"># susan follows mary</span>
        u3.follow(u4)  <span class="hljs-comment"># mary follows david</span>
        db.session.commit()

        <span class="hljs-comment"># check the followed posts of each user</span>
        f1 = u1.followed_posts().all()
        f2 = u2.followed_posts().all()
        f3 = u3.followed_posts().all()
        f4 = u4.followed_posts().all()
        self.assertEqual(f1, [p2, p4, p1])
        self.assertEqual(f2, [p2, p3])
        self.assertEqual(f3, [p3, p4])
        self.assertEqual(f4, [p4])

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    unittest.main(verbosity=<span class="hljs-number">2</span>)</code></pre> 
<ul><li>引入<strong>unittest</strong>，作为 <strong>class UserModelCase</strong> 的 基类（<strong>unittest.TestCase</strong>）</li><li><strong><code>setUp()</code></strong> 和 <strong><code>tearDown()</code></strong> ，是 <strong>unit testing framework</strong> 的两类特殊方法，分别在每个 test 开始之前/结束之后执行。</li><li>setUp()里面，<code>app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite://'</code>，使SQLAlchemy 在测试中使用 <strong>in-memory SQLite database</strong>.</li><li>写了四个测试：<code>test_password_hashing(), test_avatar(), test_follow(), test_follow_posts()</code></li><li><strong>db</strong> 完成操作后，记得 <code>db.session.commit()</code></li></ul> 
<pre class="prettyprint"><code class=" hljs r">(venv)~/Flask_microblog $ python tests.py 
[<span class="hljs-number">2018</span>-<span class="hljs-number">06</span>-<span class="hljs-number">13</span> <span class="hljs-number">10</span>:<span class="hljs-number">31</span>:<span class="hljs-number">14</span>,<span class="hljs-number">328</span>] INFO <span class="hljs-keyword">in</span> __init__: Microblog startup
test_avatar (__main__.UserModelCase) <span class="hljs-keyword">...</span> ok
test_follow (__main__.UserModelCase) <span class="hljs-keyword">...</span> ok
test_follow_posts (__main__.UserModelCase) <span class="hljs-keyword">...</span> ok
test_password_hashing (__main__.UserModelCase) <span class="hljs-keyword">...</span> ok

----------------------------------------------------------------------
Ran <span class="hljs-number">4</span> tests <span class="hljs-keyword">in</span> <span class="hljs-number">0.</span>245s

OK
</code></pre> 
<hr> 
<h3 id="integrating-followers-with-the-application">Integrating Followers with the Application</h3> 
<p>1、写路由函数</p> 
<p><code>app / routes.py:</code> follow and unfollow routes.</p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-decorator">@app.route('/follow/&lt;username&gt;')</span>
<span class="hljs-decorator">@login_required</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">follow</span><span class="hljs-params">(username)</span>:</span>
    user = User.query.filter_by(username=username).first()
    <span class="hljs-keyword">if</span> user <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
        flash(<span class="hljs-string">'User {} not found.'</span>.format(username))
        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">'index'</span>))
    <span class="hljs-keyword">if</span> user == current_user:
        flash(<span class="hljs-string">'You cannot follow yourself!'</span>)
        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">'user'</span>, username=username))
    current_user.follow(user)
    db.session.commit()
    flash(<span class="hljs-string">'You are following {}!'</span>.format(username))
    <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">'user'</span>, username=username))

<span class="hljs-decorator">@app.route('/unfollow/&lt;username&gt;')</span>
<span class="hljs-decorator">@login_required</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">unfollow</span><span class="hljs-params">(username)</span>:</span>
    user = User.query.filter_by(username=username).first()
    <span class="hljs-keyword">if</span> user <span class="hljs-keyword">is</span> <span class="hljs-keyword">None</span>:
        flash(<span class="hljs-string">'User {} not found.'</span>.format(username))
        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">'index'</span>))
    <span class="hljs-keyword">if</span> user == current_user:
        flash(<span class="hljs-string">'You cannot unfollow yourself!'</span>)
        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">'user'</span>, username=username))
    current_user.unfollow(user)
    db.session.commit()
    flash(<span class="hljs-string">'You are not following {}.'</span>.format(username))
    <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">'user'</span>, username=username))</code></pre> 
<ul><li>均为 <code>@login_required</code> </li><li>首先判断，是否存在 <code>user = User.query.filter_by(username=username).first()</code> </li><li>若 <strong>user</strong> 不存在，则 flash 提示， 并定向至 <code>‘index’</code></li><li>若 <strong>user</strong> 存在，且为 <strong>current_user</strong> （即当前登录用户，通过 <code>@login.user_loader</code> 导入），则无法执行 follow 或 unfollow，flash 提示后，定向至 ‘user’（即个人界面，<code>url_for('user', username=username)</code>）</li><li>若 <strong>user</strong> 存在，且<strong>不为</strong> curent_user，则可以执行 follow 或者 unfollow （注：均对 <code>user</code> 执行，而不是 <code>username</code>）；执行后，均需 <code>db.session.commit()</code> <br> <br></li></ul> 
<p>2、更新模板 <strong>user.html</strong> </p> 
<p><code>app / templates / user.html</code>: <em>在 <strong>user profile</strong> 页面 添加 <strong>follow 、 unfollow</strong> 链接</em></p> 
<pre class="prettyprint"><code class=" hljs handlebars"><span class="xml">        ...
        <span class="hljs-tag">&lt;<span class="hljs-title">h1</span>&gt;</span>User: </span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">user.username</span> }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">h1</span>&gt;</span>
        {% if user.about_me %}<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span></span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">user.about</span>_<span class="hljs-variable">me</span> }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>{% endif %}
        {% if user.last_seen %}<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>Last seen on: </span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">user.last</span>_<span class="hljs-variable">seen</span> }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>{% endif %}

        <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span></span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">user.followers.count</span>() }}</span><span class="xml"> followers, </span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">user.followed.count</span>() }}</span><span class="xml"> following.<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>

        {% if user == current_user %}
        <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"</span></span></span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">url</span>_<span class="hljs-variable">for</span>('<span class="hljs-variable">edit</span>_<span class="hljs-variable">profile</span>') }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-value">"</span>&gt;</span>Edit your profile<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>

        {% elif not current_user.is_following(user) %}
        <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"</span></span></span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">url</span>_<span class="hljs-variable">for</span>('<span class="hljs-variable">follow</span>', <span class="hljs-variable">username</span>=<span class="hljs-variable">user.username</span>) }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-value">"</span>&gt;</span>Follow<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>

        {% else %}
        <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"</span></span></span><span class="hljs-expression">{<!-- -->{ <span class="hljs-variable">url</span>_<span class="hljs-variable">for</span>('<span class="hljs-variable">unfollow</span>', <span class="hljs-variable">username</span>=<span class="hljs-variable">user.username</span>) }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-value">"</span>&gt;</span>Unfollow<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>

        {% endif %}
        ...</span></code></pre> 
<ul><li>在 <code>last_seen</code> 下面添加 数量标定 </li></ul> 
<p><code>&lt;p&gt;{<!-- -->{ user.followers.count() }} followers, {<!-- -->{ user.followed.count() }} following.&lt;/p&gt;</code></p> 
<ul><li>如果 logged-in user 浏览自己的网页，则 仍旧显示“Edit”链接。</li><li>如果 logged-in user 浏览尚未 follow 的 user 的 ‘user’ （profile），则显示 “Follow” 链接。</li><li>如果 logged-in user 浏览已经 follow 的 user 的 ‘user’ （profile），则显示 “Unfollow” 链接。</li></ul> 
<p><br></p> 
<p>示例： 拿两个已注册的用户 Kungreye 和 Susan （注意大小写），来测试 follow 及 unfollow 。</p> 
<ol><li><p>登录 Kungreye （‘/index’） <br> <img src="https://images2.imgbox.com/13/55/pNpI46od_o.png" alt="这里写图片描述" title=""></p></li><li><p>进入 Profile 页面 （‘/user/Kungreye’），可以看到是 <strong>o followers, 0 following</strong>。 <br> <img src="https://images2.imgbox.com/1c/44/gHL552Hs_o.png" alt="这里写图片描述" title=""></p></li><li><p>更改 addr bar 为 “~/user/Susan”，则进入 Susan 的 Profile。 <br> 同样显示 <strong>o followers, 0 following</strong>，但对于current_user （即Kungreye）来讲，此 user （即 Susan）尚未被 followed，所以显示 “Follow” 链接。 <br> <img src="https://images2.imgbox.com/49/02/prEhXayn_o.png" alt="这里写图片描述" title=""></p></li><li><p>追踪 Susan （点击 <code>Follow</code> 后）后，Susan 显示有 <strong>1 follower, 0 following</strong>. <br> <img src="https://images2.imgbox.com/fb/a4/WCZlaXJ7_o.png" alt="这里写图片描述" title=""></p></li><li><p>返回 Kungreye （点击导航条 <strong>Profile</strong>，链接至 <code>current_user</code> （即 <code>logged-in</code> 的 Kungreye）的 Profile 页面）。 可以发现 <strong>0 follower, 1 following</strong></p> 
  <blockquote> 
   <p>参照 base.html 中 Profile 的源码 <code>&lt;a href="{<!-- -->{ url_for('user', username=current_user.username) }}"&gt;Profile&lt;/a&gt;</code></p> 
  </blockquote></li></ol> 
<p><img src="https://images2.imgbox.com/b5/c3/78dbgTQq_o.png" alt="这里写图片描述" title=""></p> 
<p>以上。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a61683e178f8cef5af054c2fbfcb3ef4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CentOS7.5更改grub2菜单背景&amp;开机动态画面</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4ff96aa1848ac9b558c8068a769431a3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">go 同一个package下不同文件中函数调用报未定义问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>