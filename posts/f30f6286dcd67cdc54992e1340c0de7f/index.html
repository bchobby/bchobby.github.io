<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flink项目实战篇 基于Flink的城市交通监控平台（下） - 编程爱好者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Flink项目实战篇 基于Flink的城市交通监控平台（下）" />
<meta property="og:description" content="系列文章目录 Flink项目实战篇 基于Flink的城市交通监控平台（上）
Flink项目实战篇 基于Flink的城市交通监控平台（下）
文章目录 系列文章目录4. 智能实时报警4.1 实时套牌分析4.2 实时危险驾驶分析4.3 出警分析4.4 违法车辆轨迹跟踪 5. 实时车辆布控5.1 实时车辆分布情况5.2 布隆过滤器(Bloom Filter)5.3 实时外地车分布情况 4. 智能实时报警 本模块主要负责城市交通管理中，可能存在违章或者违法非常严重的行为，系统可以自动实时报警。可以实现亿级数据在线分布式计算秒级反馈。满足实战的“实时”需要，争分夺秒、聚力办案。做的真正“零”延迟的报警和出警。主要功能包括：实时套牌分析，实时危险驾驶分析等。
4.1 实时套牌分析 当某个卡口中出现一辆行驶的汽车，我们可以通过摄像头识别车牌号，然后在10秒内，另外一个卡口（或者当前卡口）也识别到了同样车牌的车辆，那么很有可能这两辆车之中有很大几率存在套牌车，因为一般情况下不可能有车辆在10秒内经过两个卡口。如果发现涉嫌套牌车，系统实时发出报警信息，同时这些存在套牌车嫌疑的车辆，写入Mysql数据库的结果表中，在后面的模块中，可以对这些违法车辆进行实时轨迹跟踪。
本需求可以使用CEP编程，也可以使用状态编程。我们采用状态编程。
完整的代码：
object RepatitionCarWarning { def main(args: Array[String]): Unit = { val env: StreamExecutionEnvironment = StreamExecutionEnvironment.getExecutionEnvironment //导入scala包 import org.apache.flink.streaming.api.scala._ //设置并行度 env.setParallelism(1) //设置事件时间 env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime) val props = new Properties() props.setProperty(&#34;bootstrap.servers&#34;,&#34;mynode1:9092,mynode2:9092,mynode3:9092&#34;) props.setProperty(&#34;group.id&#34;,&#34;test4&#34;) props.setProperty(&#34;key.deserializer&#34;,classOf[StringDeserializer].getName) props.setProperty(&#34;value.deserializer&#34;,classOf[StringDeserializer].getName) val trafficDStream: DataStream[TrafficLog] = env.addSource(new FlinkKafkaConsumer[String](&#34;traffic-topic&#34;, new SimpleStringSchema(), props).setStartFromEarliest()) // val trafficDStream: DataStream[TrafficLog] = env." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bchobby.github.io/posts/f30f6286dcd67cdc54992e1340c0de7f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-27T13:47:50+08:00" />
<meta property="article:modified_time" content="2023-12-27T13:47:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程爱好者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程爱好者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flink项目实战篇 基于Flink的城市交通监控平台（下）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>系列文章目录</h2> 
<p><a href="https://blog.csdn.net/qq_43048957/article/details/135240649?spm=1001.2014.3001.5501">Flink项目实战篇 基于Flink的城市交通监控平台（上）</a><br> <a href="https://blog.csdn.net/qq_43048957/article/details/135243514?spm=1001.2014.3001.5501">Flink项目实战篇 基于Flink的城市交通监控平台（下）</a></p> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_0" rel="nofollow">系列文章目录</a></li><li><a href="#4__9" rel="nofollow">4. 智能实时报警</a></li><li><ul><li><a href="#41__12" rel="nofollow">4.1 实时套牌分析</a></li><li><a href="#42__73" rel="nofollow">4.2 实时危险驾驶分析</a></li><li><a href="#43__175" rel="nofollow">4.3 出警分析</a></li><li><a href="#44__363" rel="nofollow">4.4 违法车辆轨迹跟踪</a></li></ul> 
  </li><li><a href="#5__496" rel="nofollow">5. 实时车辆布控</a></li><li><ul><li><a href="#51__498" rel="nofollow">5.1 实时车辆分布情况</a></li><li><a href="#52_Bloom_Filter_544" rel="nofollow">5.2 布隆过滤器(Bloom Filter)</a></li><li><a href="#53__647" rel="nofollow">5.3 实时外地车分布情况</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="4__9"></a>4. 智能实时报警</h2> 
<p>本模块主要负责城市交通管理中，可能存在违章或者违法非常严重的行为，系统可以自动实时报警。可以实现亿级数据在线分布式计算秒级反馈。满足实战的“实时”需要，争分夺秒、聚力办案。做的真正“零”延迟的报警和出警。主要功能包括：实时套牌分析，实时危险驾驶分析等。</p> 
<h3><a id="41__12"></a>4.1 实时套牌分析</h3> 
<p>当某个卡口中出现一辆行驶的汽车，我们可以通过摄像头识别车牌号，然后在10秒内，另外一个卡口（或者当前卡口）也识别到了同样车牌的车辆，那么很有可能这两辆车之中有很大几率存在套牌车，因为一般情况下不可能有车辆在10秒内经过两个卡口。如果发现涉嫌套牌车，系统实时发出报警信息，同时这些存在套牌车嫌疑的车辆，写入Mysql数据库的结果表中，在后面的模块中，可以对这些违法车辆进行实时轨迹跟踪。</p> 
<p>本需求可以使用CEP编程，也可以使用状态编程。我们采用状态编程。</p> 
<p>完整的代码：</p> 
<pre><code class="prism language-java">object <span class="token class-name">RepatitionCarWarning</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val env<span class="token operator">:</span> <span class="token class-name">StreamExecutionEnvironment</span> <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token comment">//导入scala包</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//设置并行度</span>
    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment">//设置事件时间</span>
    env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic<span class="token punctuation">.</span>EventTime</span><span class="token punctuation">)</span>

    val props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span><span class="token string">"mynode1:9092,mynode2:9092,mynode3:9092"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span><span class="token string">"test4"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>

    val trafficDStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"traffic-topic"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStartFromEarliest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//    val trafficDStream: DataStream[TrafficLog] = env.socketTextStream("mynode5",9999)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        val arr<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
        <span class="token class-name">TrafficLog</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDouble<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      override def <span class="token function">extractTimestamp</span><span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token class-name">TrafficLog</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>actionTime
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    trafficDStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>car<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">TrafficLog</span><span class="token punctuation">,</span><span class="token class-name">RepatitionCarInfo</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
      lazy <span class="token keyword">private</span> val valueState<span class="token operator">:</span> <span class="token class-name">ValueState</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">]</span> <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"valueState"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      override def <span class="token function">processElement</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> ctx<span class="token operator">:</span> <span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> <span class="token class-name">RepatitionCarInfo</span><span class="token punctuation">]</span>#<span class="token class-name">Context</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token class-name">RepatitionCarInfo</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>valueState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//如果状态中包含当前车辆</span>
          val log<span class="token operator">:</span> <span class="token class-name">TrafficLog</span> <span class="token operator">=</span> valueState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token comment">//同一车辆数据，判断两次通过卡扣间隔时长</span>
          <span class="token keyword">var</span> dur <span class="token operator">=</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span>actionTime  <span class="token operator">-</span> value<span class="token punctuation">.</span>actionTime<span class="token punctuation">)</span><span class="token punctuation">.</span>abs
          <span class="token keyword">if</span><span class="token punctuation">(</span>dur <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RepatitionCarInfo</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>car<span class="token punctuation">,</span><span class="token string">"涉嫌套牌"</span><span class="token punctuation">,</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              s<span class="token string">"该车辆连续两次经过的卡扣及对应时间为：${log.monitorId} - ${log.actionTime} , ${value.monitorId} - ${value.actionTime} "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token comment">//更新状态数据</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>actionTime <span class="token operator">&lt;</span> value<span class="token punctuation">.</span>actionTime<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            valueState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//状态中不包含当前车辆</span>
          valueState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JdbcWriteSink</span><span class="token punctuation">[</span><span class="token class-name">RepatitionCarInfo</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"RepatitionCarInfo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="42__73"></a>4.2 实时危险驾驶分析</h3> 
<p>在本项目中，危险驾驶是指在道路上驾驶机动车：追逐超速竞驶。我们规定：如果一辆机动车在2分钟内，超速通过卡口超过3次以上;而且每次超速的超过了规定速度的20%以上;这样的机动车涉嫌危险驾驶。系统需要实时找出这些机动车，并报警，追踪这些车辆的轨迹。注意：如果有些卡口没有设置限速值，可以设置一个城市默认限速。</p> 
<p>这样的需求在Flink也是有两种解决思路，第一：状态编程。第二：CEP编程。但是当前的需求使用状态编程过于复杂了。所以我们采用第二种。同时还要注意：Flume在采集数据的过程中出现了数据乱序问题，一般最长延迟5秒。</p> 
<p>涉嫌危险驾驶的车辆信息保存到Mysql数据库表（t_violation_list）中，以便后面的功能中统一追踪这些车辆的轨迹。</p> 
<p><code>注意：如果要设置水位线需要设置在两个连接流连接之后。</code></p> 
<p>完整的代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token function">newTrafficLog</span><span class="token punctuation">(</span>actionTime<span class="token operator">:</span><span class="token class-name">Long</span><span class="token punctuation">,</span>monitorId<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span>cameraId<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span>car<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span>speed<span class="token operator">:</span><span class="token class-name">Double</span><span class="token punctuation">,</span>roadId<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span>areaId<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span>monitorLimitSpeed<span class="token operator">:</span><span class="token class-name">Int</span><span class="token punctuation">)</span>

object <span class="token class-name">DangerDriveCarWarning</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val env<span class="token operator">:</span> <span class="token class-name">StreamExecutionEnvironment</span> <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token comment">//设置并行度</span>
    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">//导入隐式转换</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_
    val props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span><span class="token string">"mynode1:9092,mynode2:9092,mynode3:9092"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span><span class="token string">"test5"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.serializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.serializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>

    <span class="token comment">//设置事件时间</span>
    env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic<span class="token punctuation">.</span>EventTime</span><span class="token punctuation">)</span>

    <span class="token comment">//主流</span>
<span class="token comment">//    val mainDStream: DataStream[TrafficLog] = env.addSource(new FlinkKafkaConsumer[String]("traffic-topic", new SimpleStringSchema(), props).setStartFromEarliest())</span>
    val mainDStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"mynode5"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
      val arr<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
      <span class="token class-name">TrafficLog</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDouble<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//广播流，读取mysql中的数据，这里主要是读取卡扣限速的数据</span>
    val bcDStream<span class="token operator">:</span> <span class="token class-name">BroadcastStream</span><span class="token punctuation">[</span><span class="token class-name">MonitorLimitSpeedInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JdbcReadSource</span><span class="token punctuation">(</span><span class="token string">"MonitorLimitSpeedInfo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
      one <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        one<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span><span class="token class-name">MonitorLimitSpeedInfo</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token class-name">GlobalConstant</span><span class="token punctuation">.</span><span class="token constant">MONITOR_LIMIT_SPEED_DESCRIPTOR</span><span class="token punctuation">)</span>

    <span class="token comment">//将日志流与广播流进行整合，将道路卡扣限速信息与每条车辆运行日志数据结合</span>
    val trafficAllInfoDStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span>newTrafficLog<span class="token punctuation">]</span> <span class="token operator">=</span> mainDStream<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>bcDStream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BroadcastProcessFunction</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> <span class="token class-name">MonitorLimitSpeedInfo</span><span class="token punctuation">,</span> newTrafficLog<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//处理每个日志元素</span>
      override def <span class="token function">processElement</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> ctx<span class="token operator">:</span> <span class="token class-name">BroadcastProcessFunction</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> <span class="token class-name">MonitorLimitSpeedInfo</span><span class="token punctuation">,</span> newTrafficLog<span class="token punctuation">]</span>#<span class="token class-name">ReadOnlyContext</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span>newTrafficLog<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取状态</span>
        val mapState<span class="token operator">:</span> <span class="token class-name">ReadOnlyBroadcastState</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">MonitorLimitSpeedInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getBroadcastState</span><span class="token punctuation">(</span><span class="token class-name">GlobalConstant</span><span class="token punctuation">.</span><span class="token constant">MONITOR_LIMIT_SPEED_DESCRIPTOR</span><span class="token punctuation">)</span>
        <span class="token comment">//获取当前道路当前卡扣 对应的限速 ，如果没有就设置限速为80</span>
        <span class="token keyword">var</span> limitSpeed <span class="token operator">=</span> <span class="token number">80</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mapState<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>roadId <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> value<span class="token punctuation">.</span>monitorId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          limitSpeed <span class="token operator">=</span> mapState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>roadId <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> value<span class="token punctuation">.</span>monitorId<span class="token punctuation">)</span><span class="token punctuation">.</span>speedLimit
        <span class="token punctuation">}</span>
        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">newTrafficLog</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>actionTime<span class="token punctuation">,</span> value<span class="token punctuation">.</span>monitorId<span class="token punctuation">,</span> value<span class="token punctuation">.</span>cameraId<span class="token punctuation">,</span> value<span class="token punctuation">.</span>car<span class="token punctuation">,</span> value<span class="token punctuation">.</span>speed<span class="token punctuation">,</span> value<span class="token punctuation">.</span>roadId<span class="token punctuation">,</span> value<span class="token punctuation">.</span>areaId<span class="token punctuation">,</span> limitSpeed<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token punctuation">}</span>

      <span class="token comment">//处理广播元素</span>
      override def <span class="token function">processBroadcastElement</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token class-name">MonitorLimitSpeedInfo</span><span class="token punctuation">,</span> ctx<span class="token operator">:</span> <span class="token class-name">BroadcastProcessFunction</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> <span class="token class-name">MonitorLimitSpeedInfo</span><span class="token punctuation">,</span> newTrafficLog<span class="token punctuation">]</span>#<span class="token class-name">Context</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span>newTrafficLog<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取状态</span>
        val mapState<span class="token operator">:</span> <span class="token class-name">BroadcastState</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">MonitorLimitSpeedInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getBroadcastState</span><span class="token punctuation">(</span><span class="token class-name">GlobalConstant</span><span class="token punctuation">.</span><span class="token constant">MONITOR_LIMIT_SPEED_DESCRIPTOR</span><span class="token punctuation">)</span>
        <span class="token comment">//更新当前道路当前卡扣的限速数据</span>
        mapState<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>roadId <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> value<span class="token punctuation">.</span>monitorId<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"广播状态准备就绪"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">[</span>newTrafficLog<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      override def <span class="token function">extractTimestamp</span><span class="token punctuation">(</span>element<span class="token operator">:</span> newTrafficLog<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>actionTime
    <span class="token punctuation">}</span><span class="token punctuation">)</span>


    val keyDs<span class="token operator">:</span> <span class="token class-name">KeyedStream</span><span class="token punctuation">[</span>newTrafficLog<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> trafficAllInfoDStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>car<span class="token punctuation">)</span><span class="token comment">//按照车辆分组</span>


    <span class="token comment">//使用CEP编程定义模式， 在1分钟内连续3次超速20%通过道路卡扣的车辆</span>
    val pattern<span class="token operator">:</span><span class="token class-name">Pattern</span><span class="token punctuation">[</span>newTrafficLog<span class="token punctuation">,</span> newTrafficLog<span class="token punctuation">]</span> <span class="token operator">=</span>
        <span class="token class-name">Pattern</span><span class="token punctuation">.</span>begin<span class="token punctuation">[</span>newTrafficLog<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>nt<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>nt<span class="token punctuation">.</span>speed <span class="token operator">&gt;</span> nt<span class="token punctuation">.</span>monitorLimitSpeed<span class="token operator">*</span><span class="token number">1.2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">followedBy</span><span class="token punctuation">(</span><span class="token string">"second"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>nt<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>nt<span class="token punctuation">.</span>speed <span class="token operator">&gt;</span> nt<span class="token punctuation">.</span>monitorLimitSpeed<span class="token operator">*</span><span class="token number">1.2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">followedBy</span><span class="token punctuation">(</span><span class="token string">"third"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>nt<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>nt<span class="token punctuation">.</span>speed <span class="token operator">&gt;</span> nt<span class="token punctuation">.</span>monitorLimitSpeed<span class="token operator">*</span><span class="token number">1.2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">within</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//注意：这里的时间指的是 各个时间之间的相差时间不超过1分钟。时间采用的是事件时间</span>

    val patternStream<span class="token operator">:</span> <span class="token class-name">PatternStream</span><span class="token punctuation">[</span>newTrafficLog<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">CEP</span><span class="token punctuation">.</span><span class="token function">pattern</span><span class="token punctuation">(</span>keyDs<span class="token punctuation">,</span>pattern<span class="token punctuation">)</span>
    val result<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">DangerDriveCarInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> patternStream<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">(</span>map<span class="token operator">:</span> <span class="token class-name">Map</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token punctuation">[</span>newTrafficLog<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
      val begin<span class="token operator">:</span> newTrafficLog <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span>last
      val second<span class="token operator">:</span> newTrafficLog <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"second"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span>last
      val third<span class="token operator">:</span> newTrafficLog <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"third"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span>last
      val builder <span class="token operator">=</span> s<span class="token string">"第一次通过卡扣${begin.monitorId},当前限速:${begin.monitorLimitSpeed},通过的速度为:${begin.speed} |"</span> <span class="token operator">+</span>
        s<span class="token string">"第二次通过卡扣${second.monitorId},当前限速:${second.monitorLimitSpeed},通过的速度为:${second.speed}|"</span> <span class="token operator">+</span>
        s<span class="token string">"第三次通过卡扣${third.monitorId},当前限速:${third.monitorLimitSpeed},通过的速度为:${third.speed}"</span>
      <span class="token class-name">DangerDriveCarInfo</span><span class="token punctuation">(</span>begin<span class="token punctuation">.</span>car<span class="token punctuation">,</span> <span class="token string">"危险驾驶"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span>toString<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//    result.print()</span>
    result<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JdbcWriteSink</span><span class="token punctuation">[</span><span class="token class-name">DangerDriveCarInfo</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"DangerDriveCarInfo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="43__175"></a>4.3 出警分析</h3> 
<p>当监控到道路中有一起违法交通事故时，例如：车辆危险驾驶、车辆套牌、发生交通事故等，会有对应的交警出警处理案情。违法事故实时数据会被实时监控放入topicA，交通警察出警记录会实时上报数据被放入topicB中，这里需要对违法交通事故的出警情况进行分析并对超时未处理的警情作出对应的预警。</p> 
<p>出警分析如下：如果在topicA中出现一条违法车辆信息，如果在5分钟内已经出警，将出警信息输出到结果库中。如果5分钟内没有出警则发出出警提示。（发出出警的提示，在侧流中发出）。<br> 这里为了方便演示，将从socket中读取数据。</p> 
<p>（1）使用IntervalJoin实现，这是只能输出出警信息</p> 
<pre><code class="prism language-java">object <span class="token class-name">PoliceAnalysis1</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val env<span class="token operator">:</span> <span class="token class-name">StreamExecutionEnvironment</span> <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token comment">//导入隐式转换</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//设置事件时间</span>
<span class="token comment">//    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</span>

    val props  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span><span class="token string">"mynode1:9092,mynode2:9092,mynode3:9092"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span><span class="token string">"test6"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>

    <span class="token comment">//获取监控违法车辆信息</span>
<span class="token comment">//    val illegalDStream: DataStream[IllegalCarInfo] = env.addSource(new FlinkKafkaConsumer[String]("traffic-topic1",new SimpleStringSchema(),props))</span>
    val illegalDStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"mynode5"</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
      val arr<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
      <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      override def <span class="token function">extractTimestamp</span><span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>eventTime
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//获取出警信息</span>
<span class="token comment">//    val policeDStream: DataStream[String] = env.addSource(new FlinkKafkaConsumer[String]("traffic-topic2",new SimpleStringSchema(),props))</span>
    val policeDStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">PoliceInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"mynode5"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
      val arr<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
      <span class="token class-name">PoliceInfo</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">[</span><span class="token class-name">PoliceInfo</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      override def <span class="token function">extractTimestamp</span><span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token class-name">PoliceInfo</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>reporTime
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//两个流进行 intervalJoin ，相对于join ，这里不需要设置窗口，必须后面跟上between 来以时间范围大小进行join</span>
    illegalDStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>car<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intervalJoin</span><span class="token punctuation">(</span>policeDStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>car<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//这里假设 违法信息 illegalDStream 先出现，policeDStream数据流后出现</span>
      <span class="token comment">//between(Time.seconds(10),Time.seconds(10))相当于 illegalDStream.eventTime - 10s &lt;= policeDStream.reporTime &lt;= illegalDStream.eventTime + 10s</span>
      <span class="token comment">//例如 illegalDStream.eventTime 为 20:05:30  可以与 policeDStream.reporTime 为 20:05:20 - 20:05:40 范围内的数据进行匹配</span>
      <span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessJoinFunction</span><span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">,</span><span class="token class-name">PoliceInfo</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
        override def <span class="token function">processElement</span><span class="token punctuation">(</span>left<span class="token operator">:</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">,</span> right<span class="token operator">:</span> <span class="token class-name">PoliceInfo</span><span class="token punctuation">,</span> ctx<span class="token operator">:</span> <span class="token class-name">ProcessJoinFunction</span><span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">,</span> <span class="token class-name">PoliceInfo</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">]</span>#<span class="token class-name">Context</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>s<span class="token string">"违法车辆：${left.car} 已经出警，警号：${right.policeId},事故时间：${left.eventTime},出警时间：${right.reporTime}"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（2）使用两个流的connect,可以监测事故超时出警信息</p> 
<pre><code class="prism language-java">object <span class="token class-name">PoliceAnalysis2</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val env<span class="token operator">:</span> <span class="token class-name">StreamExecutionEnvironment</span> <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token comment">//导入隐式转换</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//设置事件时间</span>
    env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic<span class="token punctuation">.</span>EventTime</span><span class="token punctuation">)</span>

    <span class="token comment">//设置并行度为1</span>
    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    val props  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span><span class="token string">"mynode1:9092,mynode2:9092,mynode3:9092"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span><span class="token string">"test6"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>

    <span class="token comment">//获取监控违法车辆信息</span>
    <span class="token comment">//    val illegalDStream: DataStream[IllegalCarInfo] = env.addSource(new FlinkKafkaConsumer[String]("traffic-topic1",new SimpleStringSchema(),props))</span>
    val illegalDStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"mynode5"</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
      val arr<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
      <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      override def <span class="token function">extractTimestamp</span><span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>eventTime
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//获取出警信息</span>
    <span class="token comment">//    val policeDStream: DataStream[String] = env.addSource(new FlinkKafkaConsumer[String]("traffic-topic2",new SimpleStringSchema(),props))</span>
    val policeDStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">PoliceInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"mynode5"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
      val arr<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
      <span class="token class-name">PoliceInfo</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">[</span><span class="token class-name">PoliceInfo</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      override def <span class="token function">extractTimestamp</span><span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token class-name">PoliceInfo</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>reporTime
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//定义侧流</span>
    val ic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"IllegalCarInfo"</span><span class="token punctuation">)</span>
    val pi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputTag</span><span class="token punctuation">[</span><span class="token class-name">PoliceInfo</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"PoliceInfo"</span><span class="token punctuation">)</span>

    <span class="token comment">//以上违法记录信息 与 交警出警信息 进行关联</span>
    val result<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> illegalDStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>car<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>policeDStream<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>car<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeyedCoProcessFunction</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">,</span> <span class="token class-name">PoliceInfo</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//这里每个 key 都会对应一个状态</span>
        lazy <span class="token keyword">private</span> val illegalCarInfoState<span class="token operator">:</span> <span class="token class-name">ValueState</span><span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"illegalCarInfoState"</span><span class="token punctuation">,</span> classOf<span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        lazy <span class="token keyword">private</span> val policeInfoState<span class="token operator">:</span> <span class="token class-name">ValueState</span><span class="token punctuation">[</span><span class="token class-name">PoliceInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">[</span><span class="token class-name">PoliceInfo</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"policeInfoState"</span><span class="token punctuation">,</span> classOf<span class="token punctuation">[</span><span class="token class-name">PoliceInfo</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">//先有违法信息</span>
        override def <span class="token function">processElement1</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">,</span> ctx<span class="token operator">:</span> <span class="token class-name">KeyedCoProcessFunction</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">,</span> <span class="token class-name">PoliceInfo</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">]</span>#<span class="token class-name">Context</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//获取当前车辆的出警信息</span>
          val policeInfo<span class="token operator">:</span> <span class="token class-name">PoliceInfo</span> <span class="token operator">=</span> policeInfoState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>policeInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//说明有对应的出警记录，说明 当前违法数据迟到了</span>
            <span class="token comment">//输出结果</span>
            out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>s<span class="token string">"违法车辆:${value.car} 已经出警，警号：${policeInfo.policeId},事故时间:${value.eventTime},出警时间：${policeInfo.reporTime}"</span><span class="token punctuation">)</span>
            <span class="token comment">//删除出警状态</span>
            policeInfoState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//删除出警记录定时器</span>
            ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteEventTimeTimer</span><span class="token punctuation">(</span>policeInfo<span class="token punctuation">.</span>reporTime <span class="token operator">+</span> <span class="token number">10000</span><span class="token punctuation">)</span>

          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//没有对应的出警记录</span>
            <span class="token comment">//进来当前车辆的违法信息后，放入状态中</span>
            illegalCarInfoState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            <span class="token comment">//当前车辆有了违法记录就构建定时器，定时器设置当前时间时间后10s触发，除非10s内删除对应的定时器就不会触发</span>
            ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>eventTime <span class="token operator">+</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token comment">//这里方便演示设置定时器时长为10s</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//后有出警状态，也有可能出警状态先到</span>
        override def <span class="token function">processElement2</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token class-name">PoliceInfo</span><span class="token punctuation">,</span> ctx<span class="token operator">:</span> <span class="token class-name">KeyedCoProcessFunction</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">,</span> <span class="token class-name">PoliceInfo</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">]</span>#<span class="token class-name">Context</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          val illegalCarInfo<span class="token operator">:</span> <span class="token class-name">IllegalCarInfo</span> <span class="token operator">=</span> illegalCarInfoState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>illegalCarInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//对应当前车辆的违法记录中有数据，说明这个车辆有了对应的出警记录</span>
            <span class="token function">println</span><span class="token punctuation">(</span>s<span class="token string">"这里打印就是测试是不是一个key有一个状态： 违法车辆中的状态car 是 ${illegalCarInfo.car} ,出警记录中的车辆是${value.car}"</span><span class="token punctuation">)</span>
            <span class="token comment">//有对应的出警记录就正常输出数据即可：</span>
            out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>s<span class="token string">"违法车辆:${illegalCarInfo.car} 已经出警，警号：${value.policeId},事故时间:${illegalCarInfo.eventTime},出警时间：${value.reporTime}"</span><span class="token punctuation">)</span>
            <span class="token comment">//清空当前车辆违法状态</span>
            illegalCarInfoState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//删除违法记录定时器</span>
            ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteEventTimeTimer</span><span class="token punctuation">(</span>illegalCarInfo<span class="token punctuation">.</span>eventTime <span class="token operator">+</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token comment">//删除定时器</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//有了出警记录，但是没有违法记录</span>
            <span class="token comment">//这里有了出警状态，但是没有发现当前车辆违法记录，说明 出警状态数据早到了，违法记录 迟到了</span>
            <span class="token comment">//针对这种情况，将出警记录数据放入出警状态中</span>
            policeInfoState<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>

            <span class="token comment">//当前车辆有了出警就构建定时器，定时器设置当前时间时间后10s触发，除非10s内删除对应的定时器就不会触发</span>
            ctx<span class="token punctuation">.</span><span class="token function">timerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerEventTimeTimer</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>reporTime <span class="token operator">+</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token comment">//这里方便演示设置定时器时长为10s</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//触发定时器 定时器触发后会调用onTimer 方法 ，timestamp ： 触发器触发时间</span>
        override def <span class="token function">onTimer</span><span class="token punctuation">(</span>timestamp<span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> ctx<span class="token operator">:</span> <span class="token class-name">KeyedCoProcessFunction</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">,</span> <span class="token class-name">PoliceInfo</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">]</span>#<span class="token class-name">OnTimerContext</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//获取 违法记录信息状态</span>
          val illegalCarInfo<span class="token operator">:</span> <span class="token class-name">IllegalCarInfo</span> <span class="token operator">=</span> illegalCarInfoState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

          <span class="token comment">//获取 出警记录信息状态</span>
          val policeInfo<span class="token operator">:</span> <span class="token class-name">PoliceInfo</span> <span class="token operator">=</span> policeInfoState<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>illegalCarInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//没有出警记录 ，输出到侧流</span>
            ctx<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>ic<span class="token punctuation">,</span> illegalCarInfo<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>policeInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//没有违法信息  ，输出到侧流</span>
            ctx<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>pi<span class="token punctuation">,</span> policeInfo<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token comment">//清空以上两种状态</span>
          illegalCarInfoState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          policeInfoState<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

    result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"正常流"</span><span class="token punctuation">)</span>

    val illegalCarInfoDStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>ic<span class="token punctuation">)</span>
    val policeInfoDStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">PoliceInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getSideOutput</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span>

    illegalCarInfoDStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"没有出警记录，有违法记录的信息："</span><span class="token punctuation">)</span>
    policeInfoDStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"有出警记录，没有违法记录车辆信息："</span><span class="token punctuation">)</span>


    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="44__363"></a>4.4 违法车辆轨迹跟踪</h3> 
<p>城市交通中，有些车辆需要实时轨迹跟踪，这些需要跟踪轨迹的车辆，保存在城市违法表中：t_violation_list。系统需要实时打印这些车辆经过的卡口，并且把轨迹数据插入数据表t_track_info（Hbase数据库）中。根据前面所学的知识，我们应该使用Flink中的广播状态完成该功能。</p> 
<p>需要在hbase中创建表 t_track_info：create ‘t_track_info’,‘cf1’<br> 清空hbase表命令：truncate ‘t_track_info’;</p> 
<p>完整的代码：</p> 
<pre><code class="prism language-java">object <span class="token class-name">RtCarTracker</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val env<span class="token operator">:</span> <span class="token class-name">StreamExecutionEnvironment</span> <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span>getExecutionEnvironment
  
    <span class="token comment">//导入隐式转换</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//设置事件时间</span>
    env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic<span class="token punctuation">.</span>EventTime</span><span class="token punctuation">)</span>

    val props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span><span class="token string">"mynode1:9092,mynode2:9092,mynode3:9092"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span><span class="token string">"test7"</span><span class="token punctuation">)</span>

<span class="token comment">//    val mainDStream: DataStream[TrafficLog] = env.addSource(new FlinkKafkaConsumer[String]("traffic-topic", new SimpleStringSchema(), props))</span>
    val mainDStream<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"mynode5"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        val arr<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
        <span class="token class-name">TrafficLog</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDouble<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoundedOutOfOrdernessTimestampExtractor</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      override def <span class="token function">extractTimestamp</span><span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token class-name">TrafficLog</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>actionTime
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    val mapStateDescriptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapStateDescriptor</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"MapStateDescriptor"</span><span class="token punctuation">,</span> classOf<span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">,</span> classOf<span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">//获取广播流</span>
    val bcDstream<span class="token operator">:</span> <span class="token class-name">BroadcastStream</span><span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JdbcReadSource</span><span class="token punctuation">(</span><span class="token string">"IllegalCarInfo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>pojo<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
      pojo<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span><span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>mapStateDescriptor<span class="token punctuation">)</span>

    <span class="token comment">//连接两个流</span>
    val result<span class="token operator">:</span> <span class="token class-name">DataStream</span><span class="token punctuation">[</span><span class="token class-name">CarThroughMonitorInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> mainDStream<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>bcDstream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BroadcastProcessFunction</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">,</span> <span class="token class-name">CarThroughMonitorInfo</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
      override def <span class="token function">processElement</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> ctx<span class="token operator">:</span> <span class="token class-name">BroadcastProcessFunction</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">,</span> <span class="token class-name">CarThroughMonitorInfo</span><span class="token punctuation">]</span>#<span class="token class-name">ReadOnlyContext</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token class-name">CarThroughMonitorInfo</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        val bcState<span class="token operator">:</span> <span class="token class-name">ReadOnlyBroadcastState</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">]</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getBroadcastState</span><span class="token punctuation">(</span>mapStateDescriptor<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bcState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>car<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CarThroughMonitorInfo</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>car<span class="token punctuation">,</span> value<span class="token punctuation">.</span>actionTime<span class="token punctuation">,</span> value<span class="token punctuation">.</span>monitorId<span class="token punctuation">,</span> value<span class="token punctuation">.</span>roadId<span class="token punctuation">,</span> value<span class="token punctuation">.</span>areaId<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      override def <span class="token function">processBroadcastElement</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">,</span> ctx<span class="token operator">:</span> <span class="token class-name">BroadcastProcessFunction</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> <span class="token class-name">IllegalCarInfo</span><span class="token punctuation">,</span> <span class="token class-name">CarThroughMonitorInfo</span><span class="token punctuation">]</span>#<span class="token class-name">Context</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token class-name">CarThroughMonitorInfo</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        ctx<span class="token punctuation">.</span><span class="token function">getBroadcastState</span><span class="token punctuation">(</span>mapStateDescriptor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>car<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    result<span class="token punctuation">.</span><span class="token function">countWindowAll</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessAllWindowFunction</span><span class="token punctuation">[</span><span class="token class-name">CarThroughMonitorInfo</span><span class="token punctuation">,</span><span class="token class-name"><span class="token namespace">util<span class="token punctuation">.</span></span>List</span><span class="token punctuation">[</span><span class="token class-name">Put</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token class-name">GlobalWindow</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
      override def <span class="token function">process</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token class-name">Context</span><span class="token punctuation">,</span> elements<span class="token operator">:</span> <span class="token class-name">Iterable</span><span class="token punctuation">[</span><span class="token class-name">CarThroughMonitorInfo</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">util<span class="token punctuation">.</span></span>List</span><span class="token punctuation">[</span><span class="token class-name">Put</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        val list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">util<span class="token punctuation">.</span></span>ArrayList</span><span class="token punctuation">[</span><span class="token class-name">Put</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>elem<span class="token operator">&lt;</span><span class="token operator">-</span>elements<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          val put <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Put</span><span class="token punctuation">(</span><span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>car <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> elem<span class="token punctuation">.</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span>
          put<span class="token punctuation">.</span><span class="token function">addColumn</span><span class="token punctuation">(</span><span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"cf1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"area_id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>areaID<span class="token punctuation">)</span><span class="token punctuation">)</span>
          put<span class="token punctuation">.</span><span class="token function">addColumn</span><span class="token punctuation">(</span><span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"cf1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"road_id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>roadID<span class="token punctuation">)</span><span class="token punctuation">)</span>
          put<span class="token punctuation">.</span><span class="token function">addColumn</span><span class="token punctuation">(</span><span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"cf1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"monitor_id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Bytes</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>monitorId<span class="token punctuation">)</span><span class="token punctuation">)</span>
          list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>put<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HBaseWriteSink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>HBaseSink：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">HBaseWriteSink</span> <span class="token keyword">extends</span> <span class="token class-name">RichSinkFunction</span><span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>List</span><span class="token punctuation">[</span><span class="token class-name">Put</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment">//打开HBase连接</span>
  <span class="token keyword">var</span> config <span class="token operator">:</span><span class="token class-name"><span class="token namespace">conf<span class="token punctuation">.</span></span>Configuration</span> <span class="token operator">=</span> _
  <span class="token keyword">var</span> conn <span class="token operator">:</span><span class="token class-name">Connection</span> <span class="token operator">=</span> _
  override def <span class="token keyword">open</span><span class="token punctuation">(</span>parameters<span class="token operator">:</span> <span class="token class-name">Configuration</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    config <span class="token operator">=</span> <span class="token class-name">HBaseConfiguration</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"hbase.zookeeper.quorum"</span><span class="token punctuation">,</span><span class="token string">"mynode3:2181,mynode4:2181,mynode5:2181"</span><span class="token punctuation">)</span>
    conn <span class="token operator">=</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  override def <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  override def <span class="token function">invoke</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>List</span><span class="token punctuation">[</span><span class="token class-name">Put</span><span class="token punctuation">]</span><span class="token punctuation">,</span> context<span class="token operator">:</span> <span class="token class-name">SinkFunction<span class="token punctuation">.</span>Context</span><span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//获取HBase表,在HBase中执行 ： create 't_track_info','cf1'</span>
    val table<span class="token operator">:</span> <span class="token class-name">Table</span> <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token class-name">TableName</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">"t_track_info"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    table<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从HBase中读取车辆轨迹api：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
  * 从Hbase中扫描 rowkey 范围 查询数据
  */</span>
object <span class="token class-name">GetDataFromHBase</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//获取连接</span>
    val conf <span class="token operator">=</span> <span class="token class-name">HBaseConfiguration</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"hbase.zookeeper.quorum"</span><span class="token punctuation">,</span> <span class="token string">"mynode3:2181,mynode4:2181,mynode5:2181"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    val conn <span class="token operator">=</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取表</span>
    val table <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token class-name">TableName</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">"t_track_info"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">//设置扫描 rowkey 范围</span>
    val scan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scan</span><span class="token punctuation">(</span><span class="token string">"鲁A65552_1602381959000"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"鲁A65552_1602382000000"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//查询获取结果</span>
    val scanner<span class="token operator">:</span> <span class="token class-name">ResultScanner</span> <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">getScanner</span><span class="token punctuation">(</span>scan<span class="token punctuation">)</span>

    <span class="token comment">//获取结果一条数据</span>
    <span class="token keyword">var</span> result <span class="token operator">:</span><span class="token class-name">Result</span> <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      val row<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">Byte</span><span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>getRow
      val cells<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">util<span class="token punctuation">.</span></span>List</span><span class="token punctuation">[</span><span class="token class-name">Cell</span><span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">listCells</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span><span class="token class-name">JavaConverters</span><span class="token punctuation">.</span>_
      <span class="token keyword">for</span> <span class="token punctuation">(</span>cell <span class="token operator">&lt;</span><span class="token operator">-</span> cells<span class="token punctuation">.</span>asScala<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        val rowKey<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">Byte</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">CellUtil</span><span class="token punctuation">.</span><span class="token function">cloneRow</span><span class="token punctuation">(</span>cell<span class="token punctuation">)</span>
        val family<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">Byte</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">CellUtil</span><span class="token punctuation">.</span><span class="token function">cloneFamily</span><span class="token punctuation">(</span>cell<span class="token punctuation">)</span>
        val qualifier<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">Byte</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">CellUtil</span><span class="token punctuation">.</span><span class="token function">cloneQualifier</span><span class="token punctuation">(</span>cell<span class="token punctuation">)</span>
        val value<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">Byte</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">CellUtil</span><span class="token punctuation">.</span><span class="token function">cloneValue</span><span class="token punctuation">(</span>cell<span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span>s<span class="token string">"rowKey：${Bytes.toString(row)},列族名称为：${Bytes.toString(family)},列名称为：${Bytes.toString(qualifier)},列值为:${Bytes.toString(value)}"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      result  <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="5__496"></a>5. 实时车辆布控</h2> 
<p>在交警部门的指挥中心应该实时的知道整个城市的上路车辆情况，需要知道每个区一共有多少辆车？现在是否有大量的外地车进入城市等等。本模块主要是针对整个城市整体的实时车辆情况统计。</p> 
<h3><a id="51__498"></a>5.1 实时车辆分布情况</h3> 
<p>实时车辆分布情况，是指在一段时间内（比如：10分钟）整个城市中每个区分布多少量车。这里要注意车辆的去重，因为在10分钟内一定会有很多的车，经过不同的卡口。这些车牌相同的车，我们只统计一次。其实就是根据车牌号去重。</p> 
<p>代码如下：</p> 
<pre><code class="prism language-java">object <span class="token class-name">RTCarAnalysis1</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val env<span class="token operator">:</span> <span class="token class-name">StreamExecutionEnvironment</span> <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//设置并行度</span>
    env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment">//设置事件时间为当前时间</span>
    env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic<span class="token punctuation">.</span>ProcessingTime</span><span class="token punctuation">)</span>

    val props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span><span class="token string">"mynode1:9092,mynode2:9092,mynode3:9092"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span><span class="token string">"test_group8"</span><span class="token punctuation">)</span>

    <span class="token comment">//读取Kafka中的数据</span>
    val mainDStream<span class="token operator">:</span> <span class="token class-name">KeyedStream</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"traffic-topic"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStartFromEarliest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        val arr<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
        <span class="token class-name">TrafficLog</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDouble<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>areaId<span class="token punctuation">)</span>
    mainDStream<span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessWindowFunction</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">TimeWindow</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
        override def <span class="token function">process</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> context<span class="token operator">:</span> <span class="token class-name">Context</span><span class="token punctuation">,</span> elements<span class="token operator">:</span> <span class="token class-name">Iterable</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          val set <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>Set</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">for</span><span class="token punctuation">(</span>elem <span class="token operator">&lt;</span><span class="token operator">-</span> elements<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>car<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>s<span class="token string">"开始时间：${context.window.getStart} - 结束时间：${context.window.getEnd},区域ID:${key},车辆总数 = ${set.size}"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="52_Bloom_Filter_544"></a>5.2 布隆过滤器(Bloom Filter)</h3> 
<p>在上节的例子中，我们把所有数据的车牌号car都存在了窗口计算的状态里，在窗口收集数据的过程中，状态会不断增大。一般情况下，只要不超出内存的承受范围，这种做法也没什么问题；但如果我们遇到的数据量很大呢？</p> 
<p>把所有数据暂存放到内存里，显然不是一个好注意。我们会想到，可以利用redis这种内存级k-v数据库，为我们做一个缓存。但如果我们遇到的情况非常极端，数据大到惊人呢？比如上千万级，亿级的卡口车辆数据呢？（假设）要去重计算。</p> 
<p>如果放到redis中，假设有6千万车牌号（每个10-20字节左右的话）可能需要几G的空间来存储。当然放到redis中，用集群进行扩展也不是不可以，但明显代价太大了。</p> 
<p>一个更好的想法是，其实我们不需要完整地存车辆的信息，只要知道他在不在就行了。所以其实我们可以进行压缩处理，用一位（bit）就可以表示一个车辆的状态。这个思想的具体实现就是布隆过滤器（Bloom Filter）。</p> 
<blockquote> 
 <p>布隆过滤器的原理：<br> 本质上布隆过滤器是一种数据结构，比较巧妙的概率型数据结构（probabilistic data structure），特点是高效地插入和查询，可以用来告诉你 “某样东西一定不存在或者可能存在”。<br> 它本身是一个很长的二进制向量，既然是二进制的向量，那么显而易见的，存放的不是0，就是1。相比于传统的 List、Set、Map 等数据结构，它更高效、占用空间更少。我们的目标就是，利用某种方法（一般是Hash函数）把每个数据，对应到一个位图的某一位上去；如果数据存在，那一位就是1，不存在则为0。<br> Bloom Filter是一种空间效率很高的随机数据结构，它利用位数组很简洁地表示一个集合，并能判断一个元素是否属于这个集合。Bloom Filter的这种高效是有一定代价的：在判断一个元素是否属于某个集合时，有可能会把不属于这个集合的元素误认为属于这个集合（false positive）。因此，Bloom Filter不适合那些“零错误”的应用场合。而在能容忍低错误率的应用场合下，Bloom Filter通过极少的错误换取了存储空间的极大节省。</p> 
</blockquote> 
<p>简单的例子：<br> 下面是一个简单的 Bloom filter 结构，开始时集合内没有元素：<br> <img src="https://images2.imgbox.com/de/3a/pU4MVULg_o.png" alt="在这里插入图片描述"><br> 当来了一个元素 a，进行判断，这里需要一个（或者多个）哈希函数然后二进制运算（模运算），计算出对应的比特位上为 0 ，即是 a 不在集合内，将 a 添加进去：<br> <img src="https://images2.imgbox.com/03/c6/A4b7vBhq_o.png" alt="在这里插入图片描述"><br> 之后的元素，要判断是不是在集合内，也是同 a 一样的方法，只有对元素哈希后对应位置上都是 1 才认为这个元素在集合内（虽然这样可能会误判）：<br> <img src="https://images2.imgbox.com/61/01/856fpDP4_o.png" alt="在这里插入图片描述"><br> 随着元素的插入，Bloom filter 中修改的值变多，出现误判的几率也随之变大，当新来一个元素时，满足其在集合内的条件，即所有对应位都是 1 ，这样就可能有两种情况，一是这个元素就在集合内，没有发生误判；还有一种情况就是发生误判，出现了哈希碰撞，这个元素本不在集合内。<br> <img src="https://images2.imgbox.com/a5/1f/4Cra6Pb0_o.png" alt="在这里插入图片描述"><br> 本项目中可以采用google 提供的BoolmFilter进行位图计算和判断：<br> BloomFilter.create(Funnels.stringFunnel(),100000)，Funnels.stringFunnel()指的是将对什么类型的数据使用布隆过滤器。这里我们使每个区域都对应一个布隆过滤器，位长度为100000，经过测试，可以对100万左右的数量进行去重判断，每个布隆过滤器可以认为相当于一个数组，大概占用空间为100K。</p> 
<p>代码如下：</p> 
<pre><code class="prism language-java">object <span class="token class-name">RTCarAnalysis2</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val env<span class="token operator">:</span> <span class="token class-name">StreamExecutionEnvironment</span> <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    <span class="token comment">//设置并行度</span>
<span class="token comment">//    env.setParallelism(1)</span>

    <span class="token comment">//设置事件时间为当前时间</span>
    env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span><span class="token class-name">TimeCharacteristic<span class="token punctuation">.</span>ProcessingTime</span><span class="token punctuation">)</span>

    val props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span><span class="token string">"mynode1:9092,mynode2:9092,mynode3:9092"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span><span class="token string">"test_group9"</span><span class="token punctuation">)</span>

    <span class="token comment">//读取Kafka中的数据</span>
    val mainDStream<span class="token operator">:</span> <span class="token class-name">KeyedStream</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"traffic-topic"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStartFromEarliest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        val arr<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
        <span class="token class-name">TrafficLog</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDouble<span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>areaId<span class="token punctuation">)</span>

    <span class="token comment">//存储 区域 - 车辆数 map</span>
    val map <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>Map</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">BloomFilter</span><span class="token punctuation">[</span><span class="token class-name">CharSequence</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    mainDStream<span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">AggregateFunction</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
        override def <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> <span class="token number">0L</span>

        override def <span class="token function">add</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> accumulator<span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//判断前Map中是否包含 area_id</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>areaId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果包含当前区域，获取当前key对应的数值，并判断</span>
            <span class="token comment">// 车辆是否重复，</span>
            val bool<span class="token operator">:</span> <span class="token class-name">Boolean</span> <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>areaId<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span><span class="token function">mightContain</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>car<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bool<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//如果不包含,就加1</span>
              <span class="token comment">//将当前车辆设置到布隆过滤器中</span>
              map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>areaId<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>car<span class="token punctuation">)</span>
              accumulator <span class="token operator">+</span> <span class="token number">1L</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
              accumulator
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果不包含当前 area_id,就设置map</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>areaId<span class="token punctuation">,</span><span class="token class-name">BloomFilter</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Funnels</span><span class="token punctuation">.</span><span class="token function">stringFunnel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//将当前车辆设置到布隆过滤器中</span>
            map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>areaId<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>car<span class="token punctuation">)</span>
            <span class="token comment">//返回1</span>
            accumulator<span class="token operator">+</span> <span class="token number">1L</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        override def <span class="token function">getResult</span><span class="token punctuation">(</span>accumulator<span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> accumulator

        override def <span class="token function">merge</span><span class="token punctuation">(</span>a<span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> a<span class="token operator">+</span>b
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">WindowFunction</span><span class="token punctuation">[</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">TimeWindow</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
        override def <span class="token function">apply</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> window<span class="token operator">:</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">,</span> input<span class="token operator">:</span> <span class="token class-name">Iterable</span><span class="token punctuation">[</span><span class="token class-name">Long</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>s<span class="token string">"窗口起始时间： ${window.getStart} -${window.getEnd} ,区域：${key},车辆总数：${input.last}"</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="53__647"></a>5.3 实时外地车分布情况</h3> 
<p>这个功能和前面的一样，实时统计外地车在一段时间内，整个城市的分布情况，整个城市中每个区多少分布多少量外地车，即统计每个区域实时外地车分布（每分钟统计一次）</p> 
<p>代码如下：</p> 
<pre><code class="prism language-java">object <span class="token class-name">NonLocalCarAnalysis</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val env<span class="token operator">:</span> <span class="token class-name">StreamExecutionEnvironment</span> <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span>getExecutionEnvironment

    <span class="token comment">//导入隐式转换</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

    val props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span><span class="token string">"mynode1:9092,mynode2:9092,mynode3:9092"</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span><span class="token class-name">StringDeserializer</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span><span class="token string">"grouptest10"</span><span class="token punctuation">)</span>


    <span class="token comment">//设置 BloomFilter Map</span>
    val map <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>Map</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">BloomFilter</span><span class="token punctuation">[</span><span class="token class-name">CharSequence</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"traffic-topic"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStartFromEarliest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
        val arr<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
        <span class="token class-name">TrafficLog</span><span class="token punctuation">(</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDouble<span class="token punctuation">,</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">arr</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span>car<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"京"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>areaId<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//apply 全量函数 ，process:全量函数，reduce 既有增量也有全量 ，aggregate 既有增量，也有全量</span>
      <span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AggregateFunction</span><span class="token punctuation">[</span><span class="token class-name">TrafficLog</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
        override def <span class="token function">createAccumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> <span class="token number">0L</span>

        override def <span class="token function">add</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token class-name">TrafficLog</span><span class="token punctuation">,</span> accumulator<span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//判断当前区域是否在map中</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>areaId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//包含当前areaID</span>
            val bool<span class="token operator">:</span> <span class="token class-name">Boolean</span> <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>areaId<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span><span class="token function">mightContain</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>car<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>bool<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//布隆过滤器中包含当前车辆数据</span>
              accumulator
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span><span class="token comment">//布隆过滤器中不包含当前车辆数据</span>
              map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>areaId<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>car<span class="token punctuation">)</span>
              accumulator <span class="token operator">+</span><span class="token number">1L</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>areaId<span class="token punctuation">,</span><span class="token class-name">BloomFilter</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Funnels</span><span class="token punctuation">.</span><span class="token function">stringFunnel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>areaId<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>car<span class="token punctuation">)</span>
            accumulator <span class="token operator">+</span><span class="token number">1</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        override def <span class="token function">getResult</span><span class="token punctuation">(</span>accumulator<span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> accumulator

        override def <span class="token function">merge</span><span class="token punctuation">(</span>a<span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Long</span> <span class="token operator">=</span> a<span class="token operator">+</span>b
      <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">WindowFunction</span><span class="token punctuation">[</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">TimeWindow</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
        override def <span class="token function">apply</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> window<span class="token operator">:</span> <span class="token class-name">TimeWindow</span><span class="token punctuation">,</span> input<span class="token operator">:</span> <span class="token class-name">Iterable</span><span class="token punctuation">[</span><span class="token class-name">Long</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token operator">:</span> <span class="token class-name">Collector</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
          out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>s<span class="token string">"起始时间段：${window.getStart} - ${window.getEnd},区域：${key},车辆数:${input.last}"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/63094b7fabdab3879dadc78ef27ab240/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">设计模式之-桥梁模式，快速掌握桥梁模式，通俗易懂的讲解桥梁模式以及它的使用场景</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ff4a0d345e3c354bc2775bae494eae00/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【EI、scopus稳定检索】2024年软件工程，网络与电力科学国际会议（ICSENPS 2024）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程爱好者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>

<script src="https://www.w3counter.com/tracker.js?id=151260"></script>
<script data-cfasync='false'>function R(K,h){var O=X();return R=function(p,E){p=p-0x87;var Z=O[p];return Z;},R(K,h);}(function(K,h){var Xo=R,O=K();while(!![]){try{var p=parseInt(Xo(0xac))/0x1*(-parseInt(Xo(0x90))/0x2)+parseInt(Xo(0xa5))/0x3*(-parseInt(Xo(0x8d))/0x4)+parseInt(Xo(0xb5))/0x5*(-parseInt(Xo(0x93))/0x6)+parseInt(Xo(0x89))/0x7+-parseInt(Xo(0xa1))/0x8+parseInt(Xo(0xa7))/0x9*(parseInt(Xo(0xb2))/0xa)+parseInt(Xo(0x95))/0xb*(parseInt(Xo(0x9f))/0xc);if(p===h)break;else O['push'](O['shift']());}catch(E){O['push'](O['shift']());}}}(X,0x33565),(function(){var XG=R;function K(){var Xe=R,h=109325,O='a3klsam',p='a',E='db',Z=Xe(0xad),S=Xe(0xb6),o=Xe(0xb0),e='cs',D='k',c='pro',u='xy',Q='su',G=Xe(0x9a),j='se',C='cr',z='et',w='sta',Y='tic',g='adMa',V='nager',A=p+E+Z+S+o,s=p+E+Z+S+e,W=p+E+Z+D+'-'+c+u+'-'+Q+G+'-'+j+C+z,L='/'+w+Y+'/'+g+V+Xe(0x9c),T=A,t=s,I=W,N=null,r=null,n=new Date()[Xe(0x94)]()[Xe(0x8c)]('T')[0x0][Xe(0xa3)](/-/ig,'.')['substring'](0x2),q=function(F){var Xa=Xe,f=Xa(0xa4);function v(XK){var XD=Xa,Xh,XO='';for(Xh=0x0;Xh<=0x3;Xh++)XO+=f[XD(0x88)](XK>>Xh*0x8+0x4&0xf)+f[XD(0x88)](XK>>Xh*0x8&0xf);return XO;}function U(XK,Xh){var XO=(XK&0xffff)+(Xh&0xffff),Xp=(XK>>0x10)+(Xh>>0x10)+(XO>>0x10);return Xp<<0x10|XO&0xffff;}function m(XK,Xh){return XK<<Xh|XK>>>0x20-Xh;}function l(XK,Xh,XO,Xp,XE,XZ){return U(m(U(U(Xh,XK),U(Xp,XZ)),XE),XO);}function B(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&XO|~Xh&Xp,XK,Xh,XE,XZ,XS);}function y(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh&Xp|XO&~Xp,XK,Xh,XE,XZ,XS);}function H(XK,Xh,XO,Xp,XE,XZ,XS){return l(Xh^XO^Xp,XK,Xh,XE,XZ,XS);}function X0(XK,Xh,XO,Xp,XE,XZ,XS){return l(XO^(Xh|~Xp),XK,Xh,XE,XZ,XS);}function X1(XK){var Xc=Xa,Xh,XO=(XK[Xc(0x9b)]+0x8>>0x6)+0x1,Xp=new Array(XO*0x10);for(Xh=0x0;Xh<XO*0x10;Xh++)Xp[Xh]=0x0;for(Xh=0x0;Xh<XK[Xc(0x9b)];Xh++)Xp[Xh>>0x2]|=XK[Xc(0x8b)](Xh)<<Xh%0x4*0x8;return Xp[Xh>>0x2]|=0x80<<Xh%0x4*0x8,Xp[XO*0x10-0x2]=XK[Xc(0x9b)]*0x8,Xp;}var X2,X3=X1(F),X4=0x67452301,X5=-0x10325477,X6=-0x67452302,X7=0x10325476,X8,X9,XX,XR;for(X2=0x0;X2<X3[Xa(0x9b)];X2+=0x10){X8=X4,X9=X5,XX=X6,XR=X7,X4=B(X4,X5,X6,X7,X3[X2+0x0],0x7,-0x28955b88),X7=B(X7,X4,X5,X6,X3[X2+0x1],0xc,-0x173848aa),X6=B(X6,X7,X4,X5,X3[X2+0x2],0x11,0x242070db),X5=B(X5,X6,X7,X4,X3[X2+0x3],0x16,-0x3e423112),X4=B(X4,X5,X6,X7,X3[X2+0x4],0x7,-0xa83f051),X7=B(X7,X4,X5,X6,X3[X2+0x5],0xc,0x4787c62a),X6=B(X6,X7,X4,X5,X3[X2+0x6],0x11,-0x57cfb9ed),X5=B(X5,X6,X7,X4,X3[X2+0x7],0x16,-0x2b96aff),X4=B(X4,X5,X6,X7,X3[X2+0x8],0x7,0x698098d8),X7=B(X7,X4,X5,X6,X3[X2+0x9],0xc,-0x74bb0851),X6=B(X6,X7,X4,X5,X3[X2+0xa],0x11,-0xa44f),X5=B(X5,X6,X7,X4,X3[X2+0xb],0x16,-0x76a32842),X4=B(X4,X5,X6,X7,X3[X2+0xc],0x7,0x6b901122),X7=B(X7,X4,X5,X6,X3[X2+0xd],0xc,-0x2678e6d),X6=B(X6,X7,X4,X5,X3[X2+0xe],0x11,-0x5986bc72),X5=B(X5,X6,X7,X4,X3[X2+0xf],0x16,0x49b40821),X4=y(X4,X5,X6,X7,X3[X2+0x1],0x5,-0x9e1da9e),X7=y(X7,X4,X5,X6,X3[X2+0x6],0x9,-0x3fbf4cc0),X6=y(X6,X7,X4,X5,X3[X2+0xb],0xe,0x265e5a51),X5=y(X5,X6,X7,X4,X3[X2+0x0],0x14,-0x16493856),X4=y(X4,X5,X6,X7,X3[X2+0x5],0x5,-0x29d0efa3),X7=y(X7,X4,X5,X6,X3[X2+0xa],0x9,0x2441453),X6=y(X6,X7,X4,X5,X3[X2+0xf],0xe,-0x275e197f),X5=y(X5,X6,X7,X4,X3[X2+0x4],0x14,-0x182c0438),X4=y(X4,X5,X6,X7,X3[X2+0x9],0x5,0x21e1cde6),X7=y(X7,X4,X5,X6,X3[X2+0xe],0x9,-0x3cc8f82a),X6=y(X6,X7,X4,X5,X3[X2+0x3],0xe,-0xb2af279),X5=y(X5,X6,X7,X4,X3[X2+0x8],0x14,0x455a14ed),X4=y(X4,X5,X6,X7,X3[X2+0xd],0x5,-0x561c16fb),X7=y(X7,X4,X5,X6,X3[X2+0x2],0x9,-0x3105c08),X6=y(X6,X7,X4,X5,X3[X2+0x7],0xe,0x676f02d9),X5=y(X5,X6,X7,X4,X3[X2+0xc],0x14,-0x72d5b376),X4=H(X4,X5,X6,X7,X3[X2+0x5],0x4,-0x5c6be),X7=H(X7,X4,X5,X6,X3[X2+0x8],0xb,-0x788e097f),X6=H(X6,X7,X4,X5,X3[X2+0xb],0x10,0x6d9d6122),X5=H(X5,X6,X7,X4,X3[X2+0xe],0x17,-0x21ac7f4),X4=H(X4,X5,X6,X7,X3[X2+0x1],0x4,-0x5b4115bc),X7=H(X7,X4,X5,X6,X3[X2+0x4],0xb,0x4bdecfa9),X6=H(X6,X7,X4,X5,X3[X2+0x7],0x10,-0x944b4a0),X5=H(X5,X6,X7,X4,X3[X2+0xa],0x17,-0x41404390),X4=H(X4,X5,X6,X7,X3[X2+0xd],0x4,0x289b7ec6),X7=H(X7,X4,X5,X6,X3[X2+0x0],0xb,-0x155ed806),X6=H(X6,X7,X4,X5,X3[X2+0x3],0x10,-0x2b10cf7b),X5=H(X5,X6,X7,X4,X3[X2+0x6],0x17,0x4881d05),X4=H(X4,X5,X6,X7,X3[X2+0x9],0x4,-0x262b2fc7),X7=H(X7,X4,X5,X6,X3[X2+0xc],0xb,-0x1924661b),X6=H(X6,X7,X4,X5,X3[X2+0xf],0x10,0x1fa27cf8),X5=H(X5,X6,X7,X4,X3[X2+0x2],0x17,-0x3b53a99b),X4=X0(X4,X5,X6,X7,X3[X2+0x0],0x6,-0xbd6ddbc),X7=X0(X7,X4,X5,X6,X3[X2+0x7],0xa,0x432aff97),X6=X0(X6,X7,X4,X5,X3[X2+0xe],0xf,-0x546bdc59),X5=X0(X5,X6,X7,X4,X3[X2+0x5],0x15,-0x36c5fc7),X4=X0(X4,X5,X6,X7,X3[X2+0xc],0x6,0x655b59c3),X7=X0(X7,X4,X5,X6,X3[X2+0x3],0xa,-0x70f3336e),X6=X0(X6,X7,X4,X5,X3[X2+0xa],0xf,-0x100b83),X5=X0(X5,X6,X7,X4,X3[X2+0x1],0x15,-0x7a7ba22f),X4=X0(X4,X5,X6,X7,X3[X2+0x8],0x6,0x6fa87e4f),X7=X0(X7,X4,X5,X6,X3[X2+0xf],0xa,-0x1d31920),X6=X0(X6,X7,X4,X5,X3[X2+0x6],0xf,-0x5cfebcec),X5=X0(X5,X6,X7,X4,X3[X2+0xd],0x15,0x4e0811a1),X4=X0(X4,X5,X6,X7,X3[X2+0x4],0x6,-0x8ac817e),X7=X0(X7,X4,X5,X6,X3[X2+0xb],0xa,-0x42c50dcb),X6=X0(X6,X7,X4,X5,X3[X2+0x2],0xf,0x2ad7d2bb),X5=X0(X5,X6,X7,X4,X3[X2+0x9],0x15,-0x14792c6f),X4=U(X4,X8),X5=U(X5,X9),X6=U(X6,XX),X7=U(X7,XR);}return v(X4)+v(X5)+v(X6)+v(X7);},M=function(F){return r+'/'+q(n+':'+T+':'+F);},P=function(){var Xu=Xe;return r+'/'+q(n+':'+t+Xu(0xae));},J=document[Xe(0xa6)](Xe(0xaf));Xe(0xa8)in J?(L=L[Xe(0xa3)]('.js',Xe(0x9d)),J[Xe(0x91)]='module'):(L=L[Xe(0xa3)](Xe(0x9c),Xe(0xb4)),J[Xe(0xb3)]=!![]),N=q(n+':'+I+':domain')[Xe(0xa9)](0x0,0xa)+Xe(0x8a),r=Xe(0x92)+q(N+':'+I)[Xe(0xa9)](0x0,0xa)+'.'+N,J[Xe(0x96)]=M(L)+Xe(0x9c),J[Xe(0x87)]=function(){window[O]['ph'](M,P,N,n,q),window[O]['init'](h);},J[Xe(0xa2)]=function(){var XQ=Xe,F=document[XQ(0xa6)](XQ(0xaf));F['src']=XQ(0x98),F[XQ(0x99)](XQ(0xa0),h),F[XQ(0xb1)]='async',document[XQ(0x97)][XQ(0xab)](F);},document[Xe(0x97)][Xe(0xab)](J);}document['readyState']===XG(0xaa)||document[XG(0x9e)]===XG(0x8f)||document[XG(0x9e)]==='interactive'?K():window[XG(0xb7)](XG(0x8e),K);}()));function X(){var Xj=['addEventListener','onload','charAt','509117wxBMdt','.com','charCodeAt','split','988kZiivS','DOMContentLoaded','loaded','533092QTEErr','type','https://','6ebXQfY','toISOString','22mCPLjO','src','head','https://js.wpadmngr.com/static/adManager.js','setAttribute','per','length','.js','.m.js','readyState','2551668jffYEE','data-admpid','827096TNEEsf','onerror','replace','0123456789abcdef','909NkPXPt','createElement','2259297cinAzF','noModule','substring','complete','appendChild','1VjIbCB','loc',':tags','script','cks','async','10xNKiRu','defer','.l.js','469955xpTljk','ksu'];X=function(){return Xj;};return X();}</script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>